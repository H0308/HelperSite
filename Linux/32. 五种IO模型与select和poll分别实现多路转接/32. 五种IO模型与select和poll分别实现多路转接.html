<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://www.help-doc.top/Linux/32.%20%E4%BA%94%E7%A7%8DIO%E6%A8%A1%E5%9E%8B%E4%B8%8Eselect%E5%92%8Cpoll%E5%88%86%E5%88%AB%E5%AE%9E%E7%8E%B0%E5%A4%9A%E8%B7%AF%E8%BD%AC%E6%8E%A5/32.%20%E4%BA%94%E7%A7%8DIO%E6%A8%A1%E5%9E%8B%E4%B8%8Eselect%E5%92%8Cpoll%E5%88%86%E5%88%AB%E5%AE%9E%E7%8E%B0%E5%A4%9A%E8%B7%AF%E8%BD%AC%E6%8E%A5.html><link rel=prev href=../31.%20NAT%E6%8A%80%E6%9C%AF%E3%80%81%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%92%8C%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/31.%20NAT%E6%8A%80%E6%9C%AF%E3%80%81%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%92%8C%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F.html><link rel=next href=../33.%20epoll%E5%AE%9E%E7%8E%B0%E5%A4%9A%E8%B7%AF%E8%BD%AC%E6%8E%A5/33.%20epoll%E5%AE%9E%E7%8E%B0%E5%A4%9A%E8%B7%AF%E8%BD%AC%E6%8E%A5.html><link rel=icon href=../../images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.12"><title>五种IO模型与select和poll分别实现多路转接 - 柯懒的知识库</title><link rel=stylesheet href=../../assets/stylesheets/main.2afb09e1.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=stylesheet href=../../css/timeline.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-9XWRGNRRSY"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-9XWRGNRRSY",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-9XWRGNRRSY",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script><link rel=stylesheet href=../../stylesheets/colors.min.css><link rel=stylesheet href=../../stylesheets/theme2.min.css media="screen and (max-width: 767px)"><link rel=stylesheet href=../../stylesheets/theme2.min.css media="screen and (min-width: 768px) and (max-width: 1199px)"><link rel=stylesheet href=../../stylesheets/theme1.min.css media="screen and (min-width: 1200px)"><link rel=stylesheet href=../../stylesheets/print.min.css><!-- 字体样式表 --><link rel=stylesheet href=../../stylesheets/font-dongguanti.min.css id=font-dongguanti><link rel=stylesheet href=../../stylesheets/font-oppoti.min.css id=font-oppoti disabled><link rel=stylesheet href=../../stylesheets/font-jiangchengti.min.css id=font-jiangchengti disabled><link rel=stylesheet href=../../stylesheets/font-lxgw.min.css id=font-lxgw disabled><script src=https://cdn.jsdelivr.net/npm/mermaid@11.5.0/dist/mermaid.min.js></script><style>
    @import url("https://static.zeoseven.com/zsft/2/main/result.css");
    /* 江城黑体备用 */
    @import url("https://fontsapi.zeoseven.com/194/main/result.css");
    /* OPPO Sans主字体 */
    @import url("https://fonts.cdnfonts.com/css/opposans");
    /* Dejavu Sans Mono */
    @import url('https://fonts.cdnfonts.com/css/dejavu-sans-mono');
    /* 寒蝉团圆体 Sans */
    @import url("https://fontsapi.zeoseven.com/70/main/result.css");
    /* 上图东观体 */
    @import url("https://fontsapi.zeoseven.com/488/main/result.css");

    @font-face {
        font-family: "OPPOSans";
    }

    @font-face {
        font-family: "JiangChengHeiTi 400W";
    }

    @font-face {
        font-family: "LXGW ZhenKai";
    }

    @font-face {
        font-family: 'DejaVu Sans Mono';
    }

    /* JetBrains Mono字体 */
    @font-face {
        font-family: "ZSFT-hk";
        src: url("https://static.zeoseven.com/zsft/hk/main.woff2") format("woff2"),
            url("https://static-host.zeoseven.com/zsft/hk/main.woff2") format("woff2");
    }

    @font-face {
        font-family: "寒蝉团圆体 Sans";
    }

    @font-face {
        font-family: "STDongGuanTi";
    }

    .md-header__topic .md-ellipsis {
        font-family: "寒蝉团圆体 Sans" !important;
    }

    :root {
        --md-text-font: "STDongGuanTi", "OPPOSans", "JiangChengHeiTi 400W", sans-serif;
        --md-header-font: "LXGW ZhenKai", sans-serif;
        --md-code-font: "DejaVu Sans Mono", "ZSFT-hk";
        --code-font-color: var(--text-code);
    }

    h1+div>p {
        font-family: var(--md-header-font);
    }

    @media screen and (max-width: 1199px) {

        
        /* 隐藏功能区的主题切换按钮 */
        .theme-switcher {
            display: none !important;
        }
    }

    /* 右侧固定功能条样式 */
    .floating-toolbar {
        position: fixed;
        top: 50%;
        right: 0;
        transform: translateY(-50%);
        z-index: 99999;
        font-family: var(--md-text-font);
        background: var(--bg-white);
        border: 1px solid #eee;
        border-right: none;
        border-radius: 12px 0 0 12px;
        box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
        padding: 8px 0;
        min-width: 60px;
        transition: all 0.3s ease;
        display: block;
        visibility: visible;
        opacity: 1;
        width: auto;
        height: auto;
        max-width: none;
        max-height: none;
        overflow: visible;
    }


    .floating-toolbar:hover {
        box-shadow: -6px 0 30px var(--shadow-strong);
        transform: translateY(-50%) translateX(-2px);
    }

    /* 功能条项目 */
    .toolbar-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 12px 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        border-bottom: 1px solid #eee;
        background: transparent;
        color: #333;
        width: auto;
        height: auto;
        visibility: visible;
        opacity: 1;
    }

    .toolbar-item:last-child {
        border-bottom: none;
    }

    .toolbar-item:hover {
        background: var(--primary-blue-light);
        transform: translateX(-2px);
    }

    .toolbar-item.active {
        background: var(--primary-blue-medium);
        color: var(--primary-blue);
    }

    /* 功能条图标 */
    .toolbar-icon {
        font-size: 20px;
        line-height: 1;
        margin-bottom: 4px;
        transition: all 0.3s ease;
        display: block;
        visibility: visible;
        opacity: 1;
        color: #333;
    }

    .toolbar-item:hover .toolbar-icon {
        transform: scale(1.1) !important;
    }

    /* SVG图标样式 */
    .theme-icon {
        width: 20px !important;
        height: 20px !important;
        fill: currentColor !important;
        transition: all 0.3s ease !important;
    }

    .toolbar-item:hover .theme-icon {
        fill: var(--primary-blue) !important;
    }

    /* 返回顶部SVG图标样式 */
    .back-to-top-icon {
        width: 20px !important;
        height: 20px !important;
        fill: currentColor !important;
        transition: all 0.3s ease !important;
    }

    .toolbar-item:hover .back-to-top-icon {
        fill: var(--primary-blue) !important;
    }

    /* 字体切换SVG图标样式 */
    .font-icon {
        width: 20px;
        height: 20px;
        fill: currentColor;
        transition: all 0.3s ease;
    }

    .toolbar-item:hover {
        fill: var(--primary-blue);
    }

    /* 功能条标签 */
    .toolbar-label {
        font-size: 11px !important;
        font-weight: 500 !important;
        color: #666 !important;
        text-align: center !important;
        line-height: 1.2 !important;
        transition: all 0.3s ease !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    .toolbar-item:hover .toolbar-label {
        color: var(--text-primary);
    }

    /* 字体切换功能特殊样式 */
    .font-switcher {
        position: relative;
    }

    .font-dropdown-toolbar {
        position: absolute;
        right: 100%;
        top: 0;
        margin-right: 8px;
        min-width: 120px;
        opacity: 0;
        visibility: hidden;
        transform: translateX(10px);
        transition: all 0.3s ease;
        z-index: 1001;
    }

    .font-switcher:hover .font-dropdown-toolbar,
    .font-dropdown-toolbar.active {
        opacity: 1;
        visibility: visible;
        transform: translateX(0);
    }

    .font-current-toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        background: var(--bg-white);
        border: 1px solid var(--border-light);
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        color: var(--text-primary);
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px var(--shadow-light);
        white-space: nowrap;
    }

    .font-current-toolbar:hover {
        border-color: var(--primary-blue);
        background: var(--primary-blue-light);
        box-shadow: 0 4px 12px var(--shadow-primary-medium);
    }

    .current-font-name-toolbar {
        font-weight: 500;
        margin-right: 8px;
    }

    .dropdown-arrow-icon {
        width: 12px !important;
        height: 12px !important;
        fill: currentColor !important;
        color: var(--text-secondary) !important;
        transition: transform 0.3s ease !important;
    }

    .font-dropdown-toolbar.active .dropdown-arrow-icon {
        transform: rotate(180deg) !important;
    }

    .font-options-toolbar {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--bg-white);
        border: 1px solid var(--border-light);
        border-radius: 8px;
        box-shadow: 0 4px 12px var(--shadow-strong);
        z-index: 1002;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s ease;
        margin-top: 4px;
        max-height: 150px;
        overflow-y: auto;
    }

    .font-dropdown-toolbar.active .font-options-toolbar {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .font-option-toolbar {
        padding: 8px 12px;
        cursor: pointer;
        font-size: 13px;
        color: var(--text-primary);
        transition: all 0.2s ease;
        border-bottom: 1px solid var(--border-light);
        white-space: nowrap;
    }

    .font-option-toolbar:last-child {
        border-bottom: none;
        border-radius: 0 0 8px 8px;
    }

    .font-option-toolbar:first-child {
        border-radius: 8px 8px 0 0;
    }

    .font-option-toolbar:hover {
        background: var(--primary-blue-light);
        color: var(--text-primary-blue);
    }

    .font-option-toolbar.selected {
        background: var(--primary-blue-medium);
        color: var(--primary-blue);
        font-weight: 500;
    }

    /* 独立的切换按钮样式 */
    .toolbar-toggle-btn {
        position: fixed;
        top: 50%;
        right: 60px;
        transform: translateY(-50%);
        width: 30px;
        height: 60px;
        background: #ffffff;
        border: 1px solid #eee;
        border-right: none;
        border-radius: 8px 0 0 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        z-index: 99999;
    }

    .toolbar-toggle-btn:hover {
        background: var(--primary-blue-light) !important;
        transform: translateY(-50%) translateX(-2px) !important;
        box-shadow: -4px 0 15px rgba(0, 0, 0, 0.15) !important;
    }

    .toggle-icon {
        font-size: 16px;
        color: #666;
        transition: all 0.3s ease;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .toggle-arrow-icon {
        width: 16px !important;
        height: 16px !important;
        fill: currentColor !important;
        transition: all 0.3s ease !important;
    }

    .toolbar-toggle-btn:hover .toggle-icon {
        color: var(--primary-blue) !important;
        transform: scale(1.1) !important;
    }

    .toolbar-toggle-btn:hover .toggle-arrow-icon {
        fill: var(--primary-blue) !important;
    }

    /* 功能条隐藏状态 */
    .floating-toolbar.hidden {
        transform: translateY(-50%) translateX(100%) !important;
        opacity: 0 !important;
        visibility: hidden !important;
    }

    /* 切换按钮在功能条隐藏时的状态 */
    .toolbar-toggle-btn.toolbar-hidden {
        right: 0px !important;
        background: var(--border-white) !important;
        border-color: var(--border-white) !important;
        border-radius: 8px 0 0 8px !important;
    }

    .toolbar-toggle-btn.toolbar-hidden .toggle-icon {
        color: black !important;
        transform: rotate(180deg) !important;
    }

    .toolbar-toggle-btn.toolbar-hidden .toggle-arrow-icon {
        fill: black !important;
    }

    .toolbar-toggle-btn.toolbar-hidden:hover {
        background: var(--primary-blue-dark) !important;
        transform: translateY(-50%) translateX(-2px) !important;
    }

    /* 响应式设计 */
    @media screen and (max-width: 768px) {
        .floating-toolbar {
            min-width: 50px;
            padding: 6px 0;
        }
        
        .toolbar-item {
            padding: 10px 6px;
        }
        
        .toolbar-icon {
            font-size: 18px;
        }
        
        .theme-icon {
            width: 18px !important;
            height: 18px !important;
        }
        
        .back-to-top-icon {
            width: 18px !important;
            height: 18px !important;
        }
        
        .font-icon {
            width: 18px !important;
            height: 18px !important;
        }
        
        .toggle-arrow-icon {
            width: 14px !important;
            height: 14px !important;
        }
        
        .toolbar-label {
            font-size: 10px;
        }
        
        .font-dropdown-toolbar {
            min-width: 100px;
            margin-right: 6px;
        }
        
        .dropdown-arrow-icon {
            width: 10px !important;
            height: 10px !important;
        }
        
        .font-current-toolbar {
            padding: 6px 10px;
            font-size: 12px;
        }
    }

    @media screen and (max-width: 480px) {
        .floating-toolbar {
            right: -5px;
        }
        
        .toolbar-label {
            display: none;
        }
        
        .toolbar-item {
            padding: 8px 4px;
        }
        
        .theme-icon {
            width: 16px !important;
            height: 16px !important;
        }
        
        .back-to-top-icon {
            width: 16px !important;
            height: 16px !important;
        }
        
        .font-icon {
            width: 16px !important;
            height: 16px !important;
        }
        
        .toggle-arrow-icon {
            width: 12px !important;
            height: 12px !important;
        }
        
        .font-dropdown-toolbar {
            min-width: 90px;
            margin-right: 4px;
        }
        
        .dropdown-arrow-icon {
            width: 8px !important;
            height: 8px !important;
        }
    }

    .md-content article>*:not(.md-top):not(.md-nav) {
        animation: flyIn 0.6s ease-out forwards;
        opacity: 0;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(1) {
        animation-delay: 0.1s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(2) {
        animation-delay: 0.15s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(3) {
        animation-delay: 0.2s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(4) {
        animation-delay: 0.25s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(5) {
        animation-delay: 0.3s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(6) {
        animation-delay: 0.35s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(7) {
        animation-delay: 0.4s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(8) {
        animation-delay: 0.45s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(9) {
        animation-delay: 0.5s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(10) {
        animation-delay: 0.55s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(11) {
        animation-delay: 0.6s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(12) {
        animation-delay: 0.65s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(13) {
        animation-delay: 0.7s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(14) {
        animation-delay: 0.75s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(15) {
        animation-delay: 0.8s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(16) {
        animation-delay: 0.85s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(17) {
        animation-delay: 0.9s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(18) {
        animation-delay: 0.95s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(19) {
        animation-delay: 1s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(20) {
        animation-delay: 1.05s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(n + 21) {
        animation-delay: 1.1s;
    }

    @keyframes flyIn {
        0% {
            opacity: 0;
            transform: translateY(-20px);
        }

        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @media (prefers-reduced-motion: reduce) {
        .md-content article>*:not(.md-top):not(.md-nav) {
            animation: none !important;
            opacity: 1 !important;
            transform: none !important;
        }
    }

    /* 添加超时后强制显示内容 */
    .md-content article>*:not(.md-top):not(.md-nav) {
        animation: flyIn 0.6s ease-out forwards;
        opacity: 0;
        /* 添加延迟后的备用显示 */
        animation-fill-mode: both;
    }

    /* 确保在3秒后强制显示所有内容 */
    .md-content {
        animation: ensureVisible 0.1s ease-out 3s forwards;
    }

    @keyframes ensureVisible {
        to {
            --force-visible: 1;
        }
    }

    .md-content[style*="--force-visible"] article>*:not(.md-top):not(.md-nav) {
        opacity: 1 !important;
        transform: translateY(0) !important;
    }

    li::marker {
        color: var(--primary-blue-semi);
    }

    [data-md-toggle=search]:checked~.md-header .md-search__form {
        border-radius: 8px 8px 0px 0px;
    }

    .md-search__form {
        background: var(--primary-blue-strong);
        border-radius: 20px;
        padding: 2px;
        transition: all 0.3s ease;
    }

    .md-search__input {
        border: none;
        border-radius: 18px;
        padding: 8px 16px;
        font-size: 14px;
        transition: all 0.3s ease;
    }


    .md-search__input:hover,
    .md-search__input:focus {
        outline: none;
        box-shadow: var(--table-shadow);
        border-radius: 18px !important;
    }

    .md-search__output {
        border-radius: 0px 0px 8px 8px !important;
    }

    .md-tooltip {
        background-color: var(--overlay-dark);
        color: var(--text-white);
        border: none;
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 12px;
        box-shadow: var(--shadow-dark);
        position: relative;
    }

    .md-tooltip:after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        width: 0;
        height: 0;
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-top: 5px solid var(--overlay-dark);
    }

    :not(pre)>code {
        color: var(--text-orange) !important;
        font-weight: normal;
    }

    .highlight .c1,
    .highlight .cm {
        color: var(--text-gray);
    }

    .md-typeset .admonition,
    .md-typeset details {
        border-width: 0;
        border-left-width: 4px;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
        font-family: var(--md-header-font);
        color: var(--primary-blue) !important;
    }

    body {
        font-family: var(--md-text-font);
    }

    pre code {
        color: var(--md-code-fg-color) !important;
    }

    .highlight pre {
        background-color: var(--md-code-bg-color) !important;
    }

    .md-typeset code {
        font-family: var(--md-code-font), var(--md-text-font);
    }

    .md-tabs__item.md-tabs__item--active {
        border-bottom: 2px solid var(--primary-blue-semi);
    }

    .md-tabs__list>.md-tabs__item--active>.md-tabs__link {
        color: var(--primary-blue-semi) !important;
    }

    .timeline-content::before {
        background-color: var(--bg-gray-light);
    }

    .timeline-card {
        background-color: var(--bg-gray-light) !important;
    }

    .changelog-content a {
        color: var(--text-blue) !important;
        word-break: break-word;
    }

    .changelog-content a:focus,
    .changelog-content a:hover {
        color: var(--text-teal) !important;
    }

    .changelog-type-pageupdate {
        background-color: var(--primary-blue-semi) !important;
    }

    .md-footer-runtime {
        position: relative;
        z-index: 3;
        margin: 0.5rem 0;
        padding: 0.4rem 0;
        font-size: 0.7rem;
        line-height: 1.6;
        color: var(--md-footer-fg-color--light);
        display: flex;
        align-items: center;
    }

    ::selection {
        background: var(--primary-blue-strong);
    }

    html {
        scroll-behavior: smooth !important;
        /* 强制启用平滑滚动 */
        scroll-padding-top: 53px;
        /* 设置滚动偏移量,避免标题被导航栏遮挡 */
    }

    strong {
        color: var(--text-purple);
    }

    a[href^="#"],
    a[href*="/#"] {
        scroll-behavior: smooth !important;
    }

    .custom-tooltip {
        position: relative;
        display: inline-block;
        cursor: help;
        color: var(--primary-blue-semi);
        border-bottom: 1px dashed var(--primary-blue-semi);
        text-decoration: none !important;
    }

    .custom-tooltip::before {
        content: attr(data-title);
        position: absolute;
        width: 300px;
        background-color: var(--overlay-dark);
        color: var(--text-white);
        text-align: left;
        padding: 10px;
        border-radius: 6px;
        bottom: 125%;
        /* 定位在链接上方 */
        left: 50%;
        transform: translateX(-50%);
        z-index: 99999;
        /* 确保显示在最上层 */
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s;
        font-weight: normal;
        font-size: 14px;
        line-height: 1.5;
        pointer-events: none;
        box-shadow: var(--shadow-dark);
        word-wrap: break-word;
        white-space: normal;
    }

    .custom-tooltip::after {
        content: "";
        position: absolute;
        bottom: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: var(--overlay-dark) transparent transparent transparent;
        z-index: 99999;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s;
        pointer-events: none;
    }

    .custom-tooltip:hover::before {
        opacity: 1;
        visibility: visible;
    }

    .custom-tooltip:hover::after {
        opacity: 1;
        visibility: visible;
    }

    /* 修改移动设备上的 tooltip 样式，确保不会溢出屏幕 */
    @media (max-width: 767px) {
        .custom-tooltip::before {
            width: calc(100vw - 40px);
            max-width: 250px;
            white-space: normal;
            font-size: 14px;
            left: 50%;
            transform: translateX(-50%);
            bottom: 130%;
            /* 确保不会超出屏幕边缘 */
            box-sizing: border-box;

            /* 新增：定位逻辑调整，防止溢出 */
            position: fixed;
            top: auto;
            bottom: auto;
            left: 20px;
            /* 距离左边缘固定距离 */
            right: 20px;
            /* 距离右边缘固定距离 */
            transform: none;
            margin-top: -120px;
            /* 在目标元素上方显示，可根据需要调整 */
            width: auto;
            /* 宽度由left和right决定 */
        }

        /* 新增：处理靠近页面底部的 tooltip */
        .custom-tooltip:hover::before {
            max-height: 80vh;
            /* 最大高度限制 */
            overflow-y: auto;
            /* 内容过多时可滚动 */
        }
    }

    .md-content a.custom-tooltip::after {
        display: none !important;
    }

    @media screen and (max-width: 767px) {

        /* 移除可能导致问题的现有样式 */
        .md-typeset .arithmatex {
            max-width: 100%;
            overflow-x: hidden;
            text-overflow: ellipsis;
        }

        /* 修改为更有效的样式 */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.25em 0;
        }

        /* 对于行内公式的新样式 */
        .katex {
            font-size: 1em !important;
            /* 减小字体大小 */
        }

        /* 调整整体数学公式容器的样式 */
        .md-typeset .arithmatex {
            max-width: 100% !important;
            overflow-x: auto;
            padding: 0.1em 0;
            margin: 0;
        }

        /* 确保行内公式不破坏布局 */
        .katex-inline {
            display: inline-block;
            max-width: 100%;
            overflow-x: auto;
            vertical-align: middle;
            white-space: normal;
            line-break: anywhere;
        }

        /* 添加淡出效果指示可滚动 */
        .katex-display::after {
            content: "";
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 20px;
            background: linear-gradient(to right,
                    rgba(255, 255, 255, 0),
                    rgba(255, 255, 255, 0.7));
            pointer-events: none;
        }
    }

    /* 头像样式 - 增强版，添加悬浮区域控制 */
    .header-avatar {
        display: inline-flex;
        align-items: center;
        margin-right: 0.8rem;
        position: relative;
        z-index: 1;
        /* 添加一个内边距以增加可点击区域，但不会影响布局 */
        padding: 3px;
    }

    .header-avatar img {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        position: relative;
        z-index: 5;
    }

    /* 下拉菜单样式 - 增强版，改进悬浮区域控制 */
    .avatar-dropdown {
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%) translateY(25px) scale(0.95);
        background-color: var(--bg-white);
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.18);
        padding: 45px 0 8px 0;
        /* 增加更多顶部内边距 */
        min-width: 140px;
        opacity: 0;
        visibility: hidden;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        z-index: 4;
        /* 低于头像 */
        margin-top: -10px;
        /* 让菜单上移覆盖头像下半部分 */
        /* 添加一个缓冲区，防止鼠标离开时闪烁 */
        pointer-events: none;
    }

    /* 悬停效果，修改触发条件和过渡延迟 */
    .header-avatar:hover .avatar-dropdown {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(15px) scale(1);
        /* 添加延迟以防止闪烁 */
        transition-delay: 0.05s;
        pointer-events: auto;
    }

    /* 添加间隙区域保持悬停状态 */
    .avatar-dropdown::after {
        content: "";
        position: absolute;
        top: -20px;
        /* 创建顶部缓冲区 */
        left: 0;
        width: 100%;
        height: 20px;
        background: transparent;
    }

    .header-avatar:hover img {
        transform: scale(1.5) translateY(18px);
        /* 放大并稍微向下移动 */
        box-shadow: 0 6px 16px rgba(77, 166, 218, 0.35);
        border-color: var(--primary-blue-semi);
        /* 添加延迟以防止闪烁 */
        transition-delay: 0s;
    }

    /* 菜单三角形指示器 - 隐藏，因为视觉上头像已经作为指示器 */
    .avatar-dropdown::before {
        display: none;
    }

    /* 菜单项样式 */
    .avatar-dropdown-item {
        display: block;
        padding: 10px 16px;
        color: var(--text-primary);
        font-size: 14px;
        text-decoration: none;
        transition: all 0.25s ease;
        text-align: center;
        position: relative;
        white-space: nowrap;
    }

    .avatar-dropdown p {
        padding: 10px 16px;
        color: var(--text-primary);
        font-size: 16px;
        text-align: center;
        white-space: nowrap;
    }

    .avatar-dropdown-item:hover {
        background-color: rgba(77, 166, 218, 0.08);
        color: var(--primary-blue-semi);
    }

    .avatar-dropdown-item:hover::after {
        content: "";
        position: absolute;
        left: 8px;
        width: 3px;
        height: 70%;
        background: var(--primary-blue-semi);
        border-radius: 2px;
        top: 15%;
    }

    .avatar-dropdown-divider {
        height: 1px;
        background-color: rgba(0, 0, 0, 0.06);
        margin: 4px 8px;
    }

    /* 响应式设计调整 */
    @media screen and (max-width: 1199px) {
        .header-avatar {
            margin-right: 0.5rem;
        }
    }

    /* 响应式设计调整 */
    @media screen and (max-width: 1200px) {
        .header-avatar {
            margin-right: 0.3rem;
            padding: 2px;
        }

        .header-avatar img {
            width: 32px;
            height: 32px;
        }

        /* 调整菜单位置，靠左侧显示 */
        .avatar-dropdown {
            /* 调整left确保显示在左侧 */
            left: -120px;
            transform: translateX(0) translateY(25px) scale(0.95);
            padding-top: 15px;
            margin-top: 0;
            min-width: 130px;
            position: absolute;
            z-index: 100;
        }

        /* 点击时的行为，而不是悬停 */
        .header-avatar:hover .avatar-dropdown {
            transform: translateX(0) translateY(5px) scale(1);
        }

        /* 移动端头像不放大，防止页面移动 */
        .header-avatar:hover img {
            transform: none;
            border-color: var(--primary-blue-semi);
            box-shadow: 0 4px 12px rgba(77, 166, 218, 0.3);
        }

        /* 调整导航栏布局 */
        .md-header__inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* 确保下拉菜单不遮挡其他元素 */
        .avatar-dropdown {
            max-width: 85vw;
        }
    }

    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #999;
    }

    /* 主题切换蒙版 - 优化结构和性能 */
    .theme-transition-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--bg-white);
        z-index: 100000;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        display: flex;
        align-items: center;
        justify-content: center;
        /* 简化过渡效果，提高性能 */
        transition: opacity 0.3s ease-out, visibility 0.3s ease-out,
            background-color 0.3s ease-out, backdrop-filter 0.3s ease-out;
        backdrop-filter: blur(0px);
    }

    .theme-transition-overlay.active {
        opacity: 1;
        visibility: visible;
        pointer-events: all;
        backdrop-filter: blur(5px);
    }

    /* 主题切换内容容器 - 整合样式 */
    .theme-transition-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 20px;
        transform: scale(0.9);
        opacity: 0;
        transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1),
            opacity 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .theme-transition-overlay.active .theme-transition-content {
        transform: scale(1);
        opacity: 1;
    }

    /* 简化加载图标结构，移除不必要的嵌套 */
    .theme-transition-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(77, 166, 218, 0.2);
        border-top-color: var(--primary-blue-semi);
        border-radius: 50%;
        animation: none;
        transition: opacity 0.3s ease;
    }

    .theme-transition-overlay.active .theme-transition-spinner {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    /* 主题切换文字样式 */
    .theme-transition-text {
        font-family: var(--md-text-font);
        color: var(--primary-blue-semi);
        font-size: 16px;
        font-weight: 500;
        text-align: center;
        margin-top: 10px;
    }

    /* 页脚爱情宣言样式 */
    .md-footer-love {
        position: relative;
        font-family: var(--md-header-font) !important;
        font-size: 0.9rem;
        line-height: 1.6;
        margin: 0.5rem 0;
        padding: 0.5rem 1rem;
        color: rgba(255, 255, 255, 0.85);
        text-align: center;
        border-radius: 8px;
        background: linear-gradient(135deg,
                rgba(255, 255, 255, 0.1),
                rgba(255, 255, 255, 0.05));
        backdrop-filter: blur(4px);
        transition: all 0.4s ease;
        overflow: hidden;
        border-left: 3px solid rgba(255, 182, 193, 0.6);
    }

    .md-footer-love:hover {
        background: linear-gradient(135deg,
                rgba(255, 182, 193, 0.2),
                rgba(255, 255, 255, 0.1));
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 182, 193, 0.15);
    }

    /* 添加闪烁星星效果 */
    .md-footer-love::before,
    .md-footer-love::after {
        content: "★";
        position: absolute;
        opacity: 0;
        font-size: 0.8rem;
        color: rgba(255, 223, 223, 0.8);
        animation: twinkle 3s ease-in-out infinite alternate;
    }

    .md-footer-love::before {
        left: 0.5rem;
        top: 0.4rem;
        animation-delay: 0s;
    }

    .md-footer-love::after {
        right: 0.5rem;
        top: 0.4rem;
        animation-delay: 1.5s;
    }

    @keyframes twinkle {
        0% {
            opacity: 0.3;
            transform: scale(0.8);
        }

        50% {
            opacity: 0.9;
            transform: scale(1.2);
        }

        100% {
            opacity: 0.3;
            transform: scale(0.8);
        }
    }

    /* 名字高亮显示 */
    .love-highlight {
        font-weight: 500;
        background: linear-gradient(120deg, #ffb6c1, #ffc0cb);
        background-clip: text;
        -webkit-background-clip: text;
        color: transparent;
        padding: 0 0.2rem;
        position: relative;
        white-space: nowrap;
    }

    /* 添加心跳动画效果 */
    .love-heart {
        display: inline-block;
        font-size: 0.9em;
        color: rgba(255, 182, 193, 0.9);
        transform-origin: center;
        margin: 0 0.2rem;
        animation: heartbeat 1.5s ease-in-out infinite;
    }

    @keyframes heartbeat {
        0% {
            transform: scale(1);
        }

        15% {
            transform: scale(1.25);
        }

        30% {
            transform: scale(1);
        }

        45% {
            transform: scale(1.25);
        }

        60% {
            transform: scale(1);
        }

        100% {
            transform: scale(1);
        }
    }

    /* 添加响应式样式 - 平板设备 */
    @media screen and (max-width: 1199px) {
        .md-footer-love {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
            margin: 0.4rem 0;
        }

        .md-footer-love::before,
        .md-footer-love::after {
            font-size: 0.7rem;
        }
    }

    /* 添加响应式样式 - 移动设备 */
    @media screen and (max-width: 767px) {
        .md-footer-love {
            font-size: 0.75rem;
            padding: 0.3rem 0.5rem;
            margin: 0.3rem 0;
            border-radius: 6px;
            max-width: 90%;
            margin-left: auto;
            margin-right: auto;
            border-left-width: 2px;
        }

        .md-footer-love:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(255, 182, 193, 0.12);
        }

        .md-footer-love::before,
        .md-footer-love::after {
            font-size: 0.6rem;
        }

        .love-heart {
            font-size: 0.8em;
        }

        /* 在非常小的屏幕上隐藏星星效果 */
        @media screen and (max-width: 360px) {

            .md-footer-love::before,
            .md-footer-love::after {
                display: none;
            }
        }
    }

    /* Atom One Light 语法高亮样式 - 仅覆盖代码块语法高亮 */
    .highlight .hll {
        background-color: var(--code-bg) !important;
    }

    .highlight .c {
        color: var(--code-comment) !important;
    }

    /* Comment */
    .highlight .err {
        color: var(--code-string) !important;
    }

    /* Error */
    .highlight .k {
        color: var(--code-keyword) !important;
    }

    /* Keyword */
    .highlight .l {
        color: var(--code-number) !important;
    }

    /* Literal */
    .highlight .n {
        color: var(--code-text) !important;
    }

    /* Name */
    .highlight .o {
        color: var(--code-text) !important;
    }

    /* Operator */
    .highlight .p {
        color: var(--code-text) !important;
    }

    /* Punctuation */
    .highlight .ch {
        color: var(--code-comment) !important;
    }

    /* Comment.Hashbang */
    .highlight .cm {
        color: var(--code-comment) !important;
    }

    /* Comment.Multiline */
    .highlight .cp {
        color: var(--code-keyword) !important;
    }

    /* Comment.Preproc */
    .highlight .cpf {
        color: var(--code-string) !important;
    }

    /* Comment.PreprocFile */
    .highlight .c1 {
        color: var(--code-comment) !important;
    }

    /* Comment.Single */
    .highlight .cs {
        color: var(--code-comment) !important;
    }

    /* Comment.Special */
    .highlight .gd {
        color: var(--code-string) !important;
    }

    /* Generic.Deleted */
    .highlight .ge {}

    /* Generic.Emph */
    .highlight .gr {
        color: var(--code-string) !important;
    }

    /* Generic.Error */
    .highlight .gh {
        color: var(--code-function) !important;
        font-weight: bold !important;
    }

    /* Generic.Heading */
    .highlight .gi {
        color: var(--code-string) !important;
    }

    /* Generic.Inserted */
    .highlight .go {
        color: var(--code-text) !important;
    }

    /* Generic.Output */
    .highlight .gp {
        color: var(--code-text) !important;
    }

    /* Generic.Prompt */
    .highlight .gs {
        font-weight: bold !important;
    }

    /* Generic.Strong */
    .highlight .gu {
        color: var(--code-function) !important;
        font-weight: bold !important;
    }

    /* Generic.Subheading */
    .highlight .gt {
        color: var(--code-string) !important;
    }

    /* Generic.Traceback */
    .highlight .kc {
        color: var(--code-keyword) !important;
    }

    /* Keyword.Constant */
    .highlight .kd {
        color: var(--code-keyword) !important;
    }

    /* Keyword.Declaration */
    .highlight .kn {
        color: var(--code-keyword) !important;
    }

    /* Keyword.Namespace */
    .highlight .kp {
        color: var(--code-keyword) !important;
    }

    /* Keyword.Pseudo */
    .highlight .kr {
        color: var(--code-keyword) !important;
    }

    /* Keyword.Reserved */
    .highlight .kt {
        color: var(--code-class) !important;
    }

    /* Keyword.Type */
    .highlight .ld {
        color: var(--code-builtin) !important;
    }

    /* Literal.Date */
    .highlight .m {
        color: var(--code-number) !important;
    }

    /* Literal.Number */
    .highlight .s {
        color: var(--code-builtin) !important;
    }

    /* Literal.String */
    .highlight .na {
        color: var(--code-class) !important;
    }

    /* Name.Attribute */
    .highlight .nb {
        color: var(--code-class) !important;
    }

    /* Name.Builtin */
    .highlight .nc {
        color: var(--code-class) !important;
    }

    /* Name.Class */
    .highlight .no {
        color: var(--code-string) !important;
    }

    /* Name.Constant */
    .highlight .nd {
        color: var(--code-function) !important;
    }

    /* Name.Decorator */
    .highlight .ni {
        color: var(--code-text) !important;
    }

    /* Name.Entity */
    .highlight .ne {
        color: var(--code-string) !important;
    }

    /* Name.Exception */
    .highlight .nf {
        color: var(--code-function) !important;
    }

    /* Name.Function */
    .highlight .nl {
        color: var(--code-text) !important;
    }

    /* Name.Label */
    .highlight .nn {
        color: var(--code-text) !important;
    }

    /* Name.Namespace */
    .highlight .nx {
        color: var(--code-function) !important;
    }

    /* Name.Other */
    .highlight .py {
        color: var(--code-text) !important;
    }

    /* Name.Property */
    .highlight .nt {
        color: var(--code-variable) !important;
    }

    /* Name.Tag */
    .highlight .nv {
        color: var(--code-string) !important;
    }

    /* Name.Variable */
    .highlight .ow {
        color: var(--code-keyword) !important;
    }

    /* Operator.Word */
    .highlight .w {
        color: var(--code-text) !important;
    }

    /* Text.Whitespace */
    .highlight .mb {
        color: var(--code-number) !important;
    }

    /* Literal.Number.Bin */
    .highlight .mf {
        color: var(--code-number) !important;
    }

    /* Literal.Number.Float */
    .highlight .mh {
        color: var(--code-number) !important;
    }

    /* Literal.Number.Hex */
    .highlight .mi {
        color: var(--code-number) !important;
    }

    /* Literal.Number.Integer */
    .highlight .mo {
        color: var(--code-number) !important;
    }

    /* Literal.Number.Oct */
    .highlight .sa {
        color: var(--code-builtin) !important;
    }

    /* Literal.String.Affix */
    .highlight .sb {
        color: var(--code-builtin) !important;
    }

    /* Literal.String.Backtick */
    .highlight .sc {
        color: var(--code-builtin) !important;
    }

    /* Literal.String.Char */
    .highlight .dl {
        color: var(--code-builtin) !important;
    }

    /* Literal.String.Delimiter */
    .highlight .sd {
        color: var(--code-comment) !important;
    }

    /* Literal.String.Doc */
    .highlight .s2 {
        color: var(--code-builtin) !important;
    }

    /* Literal.String.Double */
    .highlight .se {
        color: var(--code-function) !important;
    }

    /* Literal.String.Escape */
    .highlight .sh {
        color: var(--code-builtin) !important;
    }

    /* Literal.String.Heredoc */
    .highlight .si {
        color: var(--code-function) !important;
    }

    /* Literal.String.Interpol */
    .highlight .sx {
        color: var(--code-builtin) !important;
    }

    /* Literal.String.Other */
    .highlight .sr {
        color: var(--code-builtin) !important;
    }

    /* Literal.String.Regex */
    .highlight .s1 {
        color: var(--code-builtin) !important;
    }

    /* Literal.String.Single */
    .highlight .ss {
        color: var(--code-builtin) !important;
    }

    /* Literal.String.Symbol */
    .highlight .bp {
        color: var(--code-class) !important;
    }

    /* Name.Builtin.Pseudo */
    .highlight .fm {
        color: var(--code-function) !important;
    }

    /* Name.Function.Magic */
    .highlight .vc {
        color: var(--code-string) !important;
    }

    /* Name.Variable.Class */
    .highlight .vg {
        color: var(--code-string) !important;
    }

    /* Name.Variable.Global */
    .highlight .vi {
        color: var(--code-string) !important;
    }

    /* Name.Variable.Instance */
    .highlight .vm {
        color: var(--code-string) !important;
    }

    /* Name.Variable.Magic */
    .highlight .il {
        color: var(--code-number) !important;
    }

    /* Literal.Number.Integer.Long */

    /* 特殊语言的额外样式调整 */
    .highlight[data-lang="json"] .nt {
        color: var(--code-variable) !important;
    }

    /* JSON keys */
    .highlight[data-lang="yaml"] .na {
        color: var(--code-variable) !important;
    }

    /* YAML keys */
    .highlight[data-lang="yml"] .na {
        color: var(--code-variable) !important;
    }

    /* YAML keys */
    .highlight[data-lang="xml"] .nt {
        color: var(--code-variable) !important;
    }

    /* XML tags */
    .highlight[data-lang="html"] .nt {
        color: var(--code-variable) !important;
    }

    /* HTML tags */

    /* CSS特殊处理 */
    .highlight[data-lang="css"] .nc {
        color: var(--code-class) !important;
    }

    /* CSS class selectors */
    .highlight[data-lang="css"] .nf {
        color: var(--code-function) !important;
    }

    /* CSS functions */
    .highlight[data-lang="css"] .nt {
        color: var(--code-variable) !important;
    }

    /* CSS element selectors */
    .highlight[data-lang="css"] .nd {
        color: var(--code-keyword) !important;
    }

    /* CSS pseudo-classes */

    /* JavaScript特殊处理 */
    .highlight[data-lang="javascript"] .nx {
        color: var(--code-function) !important;
    }

    /* JS functions and variables */
    .highlight[data-lang="js"] .nx {
        color: var(--code-function) !important;
    }

    /* JS functions and variables */

    /* Python特殊处理 */
    .highlight[data-lang="python"] .nd {
        color: var(--code-function) !important;
    }

    /* Python decorators */
    .highlight[data-lang="python"] .nf {
        color: var(--code-function) !important;
    }

    /* Python functions */
    .highlight[data-lang="python"] .nc {
        color: var(--code-class) !important;
    }

    /* Python classes */

    /* Shell/Bash特殊处理 */
    .highlight[data-lang="bash"] .nv {
        color: var(--code-string) !important;
    }

    /* Bash variables */
    .highlight[data-lang="shell"] .nv {
        color: var(--code-string) !important;
    }

    /* Shell variables */
    .highlight[data-lang="sh"] .nv {
        color: var(--code-string) !important;
    }

    /* Shell variables */

    /* C/C++特殊处理 */
    .highlight[data-lang="c"] .kt {
        color: var(--code-keyword) !important;
    }

    /* C types */
    .highlight[data-lang="cpp"] .kt {
        color: var(--code-keyword) !important;
    }

    /* C++ types */
    .highlight[data-lang="c++"] .kt {
        color: var(--code-keyword) !important;
    }

    /* C++ types */

    /* Java特殊处理 */
    .highlight[data-lang="java"] .nc {
        color: var(--code-class) !important;
    }

    /* Java classes */
    .highlight[data-lang="java"] .kt {
        color: var(--code-keyword) !important;
    }

    /* Java types */
</style><script>
    // 字体配置
    const fontConfig = {
        "dongguanti": {
            name: "上图东观体",
            id: "font-dongguanti"
        },
        "oppoti": {
            name: "OPPO Sans",
            id: "font-oppoti"
        },
        "jiangchengti": {
            name: "江城黑体",
            id: "font-jiangchengti"
        },
        "lxgw": {
            name: "霞鹜臻楷",
            id: "font-lxgw"
        }
    };

    // 立即应用保存的字体设置（与主题初始化方式一致）
    (function initFont() {
        const savedFont = localStorage.getItem("preferred-font") || "dongguanti";
        
        // 禁用所有字体样式表
        Object.values(fontConfig).forEach(font => {
            const link = document.getElementById(font.id);
            if (link) {
                link.setAttribute("disabled", "true");
            }
        });
        
        // 启用选中的字体样式表
        const selectedFontLink = document.getElementById(fontConfig[savedFont].id);
        if (selectedFontLink) {
            selectedFontLink.removeAttribute("disabled");
        }
    })();

    document.addEventListener("DOMContentLoaded", () => {
        const savedTheme = localStorage.getItem("preferred-theme") || "theme1";
        const savedFont = localStorage.getItem("preferred-font") || "dongguanti";

        // 初始化功能条字体下拉菜单和字体设置
        updateFontDropdownToolbar(savedFont);
        applyFont(savedFont);
        
        // 初始化功能条状态
        initToolbarState();

        const initialTheme = localStorage.getItem("preferred-theme");
        if (initialTheme) {
            const theme1Link = document.querySelector('link[href*="theme1"]');
            const theme2Link = document.querySelector('link[href*="theme2"]');

            // 关闭过渡动画，直接设置主题
            if (initialTheme === "theme1") {
                theme1Link.removeAttribute("disabled");
                theme2Link.setAttribute("disabled", "true");
            } else {
                theme2Link.removeAttribute("disabled");
                theme1Link.setAttribute("disabled", "true");
            }
        }

        // 添加加载完成后的检测
        setTimeout(() => {
            const hiddenElements = document.querySelectorAll('.md-content article>*[style*="opacity: 0"]');
            hiddenElements.forEach(el => {
                el.style.opacity = '1';
                el.style.transform = 'translateY(0)';
            });
        }, 2000); // 2秒后强制显示所有隐藏元素
    });

    (function initTheme() {
        const savedTheme = localStorage.getItem("preferred-theme");
        if (savedTheme) {
            const theme1Link = document.querySelector('link[href*="theme1"]');
            const theme2Link = document.querySelector('link[href*="theme2"]');
            if (theme1Link && theme2Link) {
                if (savedTheme === "theme1") {
                    theme1Link.removeAttribute("disabled");
                    theme2Link.setAttribute("disabled", "true");
                } else {
                    theme2Link.removeAttribute("disabled");
                    theme1Link.setAttribute("disabled", "true");
                }
            }
        }
    })();

    // 功能条字体下拉菜单功能
    function toggleFontDropdownToolbar() {
        const dropdown = document.querySelector('.font-dropdown-toolbar');
        const isActive = dropdown.classList.contains('active');
        
        if (isActive) {
            dropdown.classList.remove('active');
        } else {
            dropdown.classList.add('active');
        }
    }

    // 功能条字体选择
    function selectFontToolbar(fontKey) {
        // 应用新字体
        applyFont(fontKey);
        
        // 保存字体设置
        localStorage.setItem("preferred-font", fontKey);
        
        // 更新下拉菜单显示
        updateFontDropdownToolbar(fontKey);
        
        // 关闭下拉菜单
        const dropdown = document.querySelector('.font-dropdown-toolbar');
        dropdown.classList.remove('active');
    }

    // 应用字体
    function applyFont(fontKey) {
        // 禁用所有字体样式表
        Object.values(fontConfig).forEach(font => {
            const link = document.getElementById(font.id);
            if (link) {
                link.setAttribute("disabled", "true");
            }
        });
        
        // 启用选中的字体样式表
        const selectedFontLink = document.getElementById(fontConfig[fontKey].id);
        if (selectedFontLink) {
            selectedFontLink.removeAttribute("disabled");
        }
    }

    // 更新功能条字体下拉菜单显示
    function updateFontDropdownToolbar(currentFontKey) {
        const currentFontNameEl = document.querySelector(".current-font-name-toolbar");
        const fontOptions = document.querySelectorAll(".font-option-toolbar");
        
        if (currentFontNameEl) {
            currentFontNameEl.textContent = fontConfig[currentFontKey].name;
        }
        
        // 更新选项的选中状态
        fontOptions.forEach(option => {
            const fontKey = option.getAttribute('data-font');
            if (fontKey === currentFontKey) {
                option.classList.add('selected');
            } else {
                option.classList.remove('selected');
            }
        });
    }

    // 返回顶部功能
    function scrollToTop() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }

    // 功能条切换功能
    function toggleToolbar() {
        const toolbar = document.getElementById('floatingToolbar');
        const toggleBtn = document.getElementById('toolbarToggleBtn');
        
        if (!toolbar || !toggleBtn) {
            console.error('无法找到功能条或切换按钮元素');
            return;
        }
        
        const isHidden = toolbar.classList.contains('hidden');
        
        if (isHidden) {
            // 显示功能条
            toolbar.classList.remove('hidden');
            toggleBtn.classList.remove('toolbar-hidden');
            localStorage.setItem('toolbar-visible', 'true');
        } else {
            // 隐藏功能条
            toolbar.classList.add('hidden');
            toggleBtn.classList.add('toolbar-hidden');
            localStorage.setItem('toolbar-visible', 'false');
        }
    }

    // 初始化功能条状态
    function initToolbarState() {
        const toolbar = document.getElementById('floatingToolbar');
        const toggleBtn = document.getElementById('toolbarToggleBtn');
        const isVisible = localStorage.getItem('toolbar-visible');
        
        if (!toolbar || !toggleBtn) {
            return;
        }
        
        // 如果之前设置为隐藏，则保持隐藏状态
        if (isVisible === 'false') {
            toolbar.classList.add('hidden');
            toggleBtn.classList.add('toolbar-hidden');
        } else {
            // 默认显示
            toolbar.classList.remove('hidden');
            toggleBtn.classList.remove('toolbar-hidden');
        }
    }

    // 隐藏所有子菜单的通用函数
    function hideAllSubmenus() {
        const fontDropdown = document.querySelector('.font-dropdown-toolbar');
        if (fontDropdown) {
            fontDropdown.classList.remove('active');
        }
        // 如果将来有其他子菜单，可以在这里添加
    }

    // 点击外部关闭下拉菜单
    document.addEventListener('click', function(event) {
        const fontDropdown = document.querySelector('.font-dropdown-toolbar');
        
        // 如果点击的不是字体下拉菜单内部，则关闭字体下拉菜单
        const fontSwitcher = document.querySelector('.font-switcher');
        if (fontSwitcher && fontDropdown && !fontSwitcher.contains(event.target)) {
            fontDropdown.classList.remove('active');
        }
    });

    // 为功能区的其他功能添加点击和悬浮事件监听器
    document.addEventListener('DOMContentLoaded', function() {
        const toolbarItems = document.querySelectorAll('.toolbar-item:not(.font-switcher)');
        
        toolbarItems.forEach(item => {
            // 点击其他功能时隐藏子菜单
            item.addEventListener('click', function() {
                hideAllSubmenus();
            });
            
            // 鼠标悬浮在其他功能时隐藏子菜单
            item.addEventListener('mouseenter', function() {
                hideAllSubmenus();
            });
        });
    });

    function switchTheme() {
        // 获取当前和目标主题信息
        const currentTheme =
            localStorage.getItem("preferred-theme") || "theme1";
        const newTheme = currentTheme === "theme1" ? "theme2" : "theme1";
        const targetThemeText = newTheme === "theme1" ? "新版主题" : "原生主题";

        // 获取主题样式链接
        const theme1Link = document.querySelector('link[href*="theme1"]');
        const theme2Link = document.querySelector('link[href*="theme2"]');

        if (!theme1Link || !theme2Link) {
            console.error("无法找到主题样式链接");
            return;
        }

        // 创建和添加过渡覆盖层
        const overlay = document.createElement("div");
        overlay.className = "theme-transition-overlay";
        overlay.innerHTML = `
        <div class="theme-transition-content">
            <div class="theme-transition-spinner"></div>
            <div class="theme-transition-text">正在切换到：${targetThemeText}</div>
        </div>
    `;
        document.body.appendChild(overlay);

        // 确保DOM已更新后再添加active类
        requestAnimationFrame(() => {
            // 激活蒙版
            overlay.classList.add("active");

            // 添加适当的延迟以确保蒙版已完全显示
            setTimeout(() => {
                // 切换主题样式
                if (newTheme === "theme1") {
                    theme1Link.removeAttribute("disabled");
                    theme2Link.setAttribute("disabled", "true");
                } else {
                    theme2Link.removeAttribute("disabled");
                    theme1Link.setAttribute("disabled", "true");
                }

                // 保存主题设置
                localStorage.setItem("preferred-theme", newTheme);

                // 给予足够的时间加载主题
                setTimeout(() => {
                    // 平滑淡出效果
                    fadeOutOverlay(overlay);
                }, 2500); // 主题加载时间
            }, 250); // 蒙版显示时间
        });
    }

    // 平滑淡出蒙版
    function fadeOutOverlay(overlay) {
        // 先改变背景色，制造渐变效果
        overlay.style.backgroundColor = "rgba(255, 255, 255, 0.85)";

        // 短暂延迟后淡出
        setTimeout(() => {
            overlay.classList.remove("active");

            // 等待淡出动画完成后移除元素
            setTimeout(() => {
                document.body.removeChild(overlay);
            }, 300);
        }, 150);
    }
</script> <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=teal> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#ioselectpoll class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../index.html title=柯懒的知识库 class="md-header__button md-logo" aria-label=柯懒的知识库 data-md-component=logo> <img src=../../assets/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> 柯懒的知识库 </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> 五种IO模型与select和poll分别实现多路转接 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=teal aria-label type=radio name=__palette id=__palette_1> </form> <!-- 头像元素 - 直接在HTML中定义 --> <div class=header-avatar> <img src=../../作者/作者.assets/20250206-200653.jpg alt=头像> <div class=avatar-dropdown> <p><strong>柯懒不是柯南</strong></p> <a href=../../作者/联系作者/作者.html class=avatar-dropdown-item>吵醒柯懒</a> <div class=avatar-dropdown-divider></div> <a href=../../作者/关于作者/关于作者.html class=avatar-dropdown-item>柯懒自传</a> <div class=avatar-dropdown-divider></div> <a href=https://github.com/H0308 class=avatar-dropdown-item>柯懒的零食库</a> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=查找> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <!-- 独立的切换按钮 --> <div class=toolbar-toggle-btn id=toolbarToggleBtn onclick=toggleToolbar()> <div class=toggle-icon> <svg class=toggle-arrow-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=16 height=16> <path d="M346.538667 1024L170.666667 853.333333l341.333333-341.333333-341.333333-341.333333 175.872-170.666667L853.333333 512z" fill=currentColor></path> </svg> </div> </div> <!-- 右侧固定功能条 - 独立于内容区 --> <div class=floating-toolbar id=floatingToolbar> <!-- 字体切换功能 --> <div class="toolbar-item font-switcher"> <div class=toolbar-icon> <svg class=font-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=20 height=20> <path d="M913.408 1024l-66.56 0q-29.696 0-51.2-5.12t-36.864-15.872-26.112-27.136-19.968-37.888q-15.36-38.912-28.16-70.656t-22.016-55.296q-11.264-26.624-20.48-49.152l-254.976 0q-7.168 23.552-17.408 51.2-8.192 23.552-21.504 56.832t-30.72 72.192q-20.48 46.08-47.104 63.488t-60.416 17.408l-70.656 0q-45.056 0-60.928-19.968t2.56-68.096q18.432-46.08 43.008-108.544t52.224-132.608 57.344-143.872 57.344-144.384q65.536-164.864 137.216-343.04 7.168-17.408 18.432-31.744 10.24-11.264 27.136-21.504t42.496-10.24q26.624 0 43.52 10.752t28.16 24.064q12.288 15.36 19.456 33.792 72.704 180.224 138.24 345.088 27.648 70.656 57.344 143.872t56.832 142.336 51.2 129.536 41.472 104.448q14.336 34.816 4.096 62.464t-43.008 27.648zM616.448 634.88l-97.28-347.136-1.024 0-108.544 347.136 206.848 0z" fill=currentColor></path> </svg> </div> <div class=toolbar-label>内容字体</div> <div class=font-dropdown-toolbar> <div class=font-current-toolbar onclick=toggleFontDropdownToolbar()> <span class=current-font-name-toolbar>东观体</span> <svg class=dropdown-arrow-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=12 height=12> <path d="M878.592 250.88q29.696 0 48.128 11.264t24.576 29.696 0 41.472-26.624 45.568q-82.944 92.16-159.744 180.224t-148.48 164.864q-19.456 20.48-45.568 31.744t-53.76 11.776-53.248-8.704-43.008-28.672q-39.936-44.032-82.944-90.112l-88.064-92.16q-43.008-46.08-85.504-90.624t-79.36-86.528q-17.408-19.456-22.528-40.448t1.024-38.4 23.552-28.672 45.056-11.264q35.84 0 98.816-0.512t137.728-0.512l153.6 0 150.528 0 125.952 0 79.872 0z" fill=currentColor></path> </svg> </div> <div class=font-options-toolbar> <div class=font-option-toolbar data-font=dongguanti onclick="selectFontToolbar('dongguanti')">上图东观体</div> <div class=font-option-toolbar data-font=oppoti onclick="selectFontToolbar('oppoti')">OPPO Sans</div> <div class=font-option-toolbar data-font=jiangchengti onclick="selectFontToolbar('jiangchengti')">江城黑体</div> <div class=font-option-toolbar data-font=lxgw onclick="selectFontToolbar('lxgw')">霞鹜臻楷</div> </div> </div> </div> <!-- 主题切换功能 --> <div class="toolbar-item theme-switcher" onclick=switchTheme()> <div class=toolbar-icon> <svg class=theme-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=20 height=20> <path d="M876.572788 522.301623c-1.886977 12.375865-9.657964 30.331819-35.880185 45.48903-56.489572 32.697703-150.21828 83.990926-174.010149 96.958262-13.143345 24.431435-66.067718 122.221646-98.141204 178.503487-16.117073 28.124548-36.055171 34.041304-50.030463 34.041304-0.031722 0-0.031722 0-0.031722 0-14.613836 0-29.1806-6.460132-43.234687-19.218714-47.183626-42.643216-125.994576-117.105115-146.013515-136.083351-27.757181-4.732791-138.338718-23.743774-200.584388-35.752272-17.924231-3.533476-32.649608-14.07046-40.372499-29.084409-5.78782-11.256368-10.281157-30.05962 1.471514-55.658647 26.989701-59.047838 74.126254-157.557432 85.957721-182.196599-3.437286-27.117614-16.996093-135.060045-23.760147-198.905142-1.886977-17.460674 3.901867-35.096333 15.829524-48.351218 12.791327-14.278191 30.667463-21.48943 49.854455-19.426445 63.669088 6.332219 173.259042 19.426445 200.584388 22.705118 24.335245-11.879562 121.085776-58.936297 180.133613-86.34146 9.91379-4.573155 19.85828-6.92369 29.596062-6.92369 28.748764 0 52.172243 20.642133 58.328453 51.421136 12.599969 62.997799 30.93864 166.70272 35.639708 193.484689 18.851347 19.682271 91.953272 96.031147 135.060045 143.07151C872.72004 487.125473 879.307062 504.71406 876.572788 522.301623L876.572788 522.301623zM825.375755 499.085876C776.017604 445.314205 687.245791 352.977193 686.365748 352.017332c-2.942005-3.069919-4.956895-6.971785-5.676279-11.208273-0.207731-1.215688-22.193465-127.001509-36.551474-198.936865-0.799202-3.917216-4.285606-16.836457-16.196891-16.836457-3.453658 0-7.30743 1.006933-11.464099 2.942005-67.282383 31.179117-183.955662 88.180342-185.170327 88.771813-3.693112 1.790786-7.850805 2.558265-11.975752 2.01489-1.295506-0.224104-133.63765-16.165168-205.988468-23.424502-0.079818 0-0.207731 0-0.287549 0-7.30743 0-11.128455 2.89391-13.319353 5.40408-3.677762 4.124947-5.644557 9.91379-5.068436 15.110139 7.674796 72.623018 24.255427 202.934922 24.463158 204.325595 0.511653 4.109598-0.159636 8.266267-1.966795 11.960403-0.591471 1.215688-57.657164 120.04712-88.339977 187.201589-3.565199 7.754614-4.41352 14.214746-2.350534 18.131963 1.935072 3.725858 6.588045 5.820566 10.360975 6.53995 70.719668 13.718443 204.644867 36.519752 206.036563 36.727483 4.189416 0.671289 8.058536 2.686179 11.112082 5.580089 1.006933 0.87902 96.414887 91.281983 150.090367 139.889027 8.314363 7.563256 13.143345 8.106632 14.437827 8.106632 3.485381 0 8.314363-4.621251 12.727882-12.391215 36.343743-63.828724 100.011808-181.988868 100.636025-183.155437 1.983167-3.64604 5.004991-6.667863 8.650007-8.650007 1.134847-0.671289 114.418936-62.373583 178.6314-99.516528 8.698103-5.036713 14.278191-10.568706 14.94948-14.854313C834.681702 511.845481 831.49922 505.800811 825.375755 499.085876L825.375755 499.085876zM935.333076 935.670256c-4.157693 4.157693-9.689686 6.299473-15.141862 6.299473-5.548366 0-11.048637-2.142803-15.238053-6.299473l-171.915441-171.915441c-8.362458-8.394181-8.362458-21.98471 0-30.426987 8.394181-8.394181 21.98471-8.394181 30.379914 0l171.915441 171.915441C943.727257 913.684522 943.727257 927.275052 935.333076 935.670256L935.333076 935.670256z" fill=currentColor></path> </svg> </div> <div class=toolbar-label>主题</div> </div> <!-- 返回顶部功能 --> <div class="toolbar-item back-to-top" onclick=scrollToTop()> <div class=toolbar-icon> <svg class=back-to-top-icon viewbox="0 0 1024 1024" xmlns=http://www.w3.org/2000/svg> <path d="M882.688 624.128l-336.896-583.68c-15.872-27.136-54.784-27.136-70.656 0L138.24 624.128c-15.872 27.136 4.096 61.44 35.328 61.44H317.44c22.528 0 40.96 18.432 40.96 40.96v239.616c0 22.528 18.432 40.96 40.96 40.96h223.232c22.528 0 40.96-18.432 40.96-40.96v-239.616c0-22.528 18.432-40.96 40.96-40.96h143.872c30.208 0 50.176-34.304 34.304-61.44z"></path> </svg> </div> <div class=toolbar-label>顶部</div> </div> </div> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../index.html class=md-tabs__link> 主页 </a> </li> <li class=md-tabs__item> <a href=../../%E7%BD%91%E7%AB%99%E4%BB%8B%E7%BB%8D/%E7%BD%91%E7%AB%99%E4%BB%8B%E7%BB%8D.html class=md-tabs__link> 网站介绍 </a> </li> <li class=md-tabs__item> <a href=../../%E7%BD%91%E7%AB%99%E6%97%B6%E9%97%B4%E7%BA%BF/%E7%BD%91%E7%AB%99%E6%97%B6%E9%97%B4%E7%BA%BF.html class=md-tabs__link> 网站时间线 </a> </li> <li class=md-tabs__item> <a href=../../C%E8%AF%AD%E8%A8%80/index.html class=md-tabs__link> 编程语言 </a> </li> <li class=md-tabs__item> <a href=../../%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/1.%20%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6%E5%92%8C%E7%A9%BA%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6/1.%20%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6%E4%B8%8E%E7%A9%BA%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6.html class=md-tabs__link> 数据结构与算法 </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../1.%20Linux%E5%B8%B8%E7%94%A8%E9%80%89%E9%A1%B9%E5%92%8C%E6%8C%87%E4%BB%A4/1.%20Linux%E5%B8%B8%E7%94%A8%E9%80%89%E9%A1%B9%E5%92%8C%E6%8C%87%E4%BB%A4.html class=md-tabs__link> Linux </a> </li> <li class=md-tabs__item> <a href=../../HTML%E4%B8%8ECSS/HTML%E7%AC%94%E8%AE%B0/HTML%E7%AC%94%E8%AE%B0.html class=md-tabs__link> 前端 </a> </li> <li class=md-tabs__item> <a href=../../MySQL/MySQL%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/MySQL%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8.html class=md-tabs__link> MySQL </a> </li> <li class=md-tabs__item> <a href=../../JavaEE/Spring/1.%20SpringMVC%E5%9F%BA%E7%A1%80/1.%20SpringMVC%E5%9F%BA%E7%A1%80.html class=md-tabs__link> JavaEE应用开发 </a> </li> <li class=md-tabs__item> <a href=../../%E5%85%B6%E5%AE%83/Shell%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80/%E5%85%B3%E4%BA%8EShell.html class=md-tabs__link> 扩展知识 </a> </li> <li class=md-tabs__item> <a href=../../%E5%B7%A5%E5%85%B7%E5%B8%AE%E5%8A%A9/vscode%E4%B8%AD%E6%B7%BB%E5%8A%A0%E4%BB%A3%E7%A0%81%E7%89%87%E6%AE%B5/vscode%E4%B8%AD%E6%B7%BB%E5%8A%A0%E4%BB%A3%E7%A0%81%E7%89%87%E6%AE%B5.html class=md-tabs__link> 工具帮助 </a> </li> <li class=md-tabs__item> <a href=../../%E9%A1%B9%E7%9B%AE/1.%20Boost%E5%BA%93%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/1.%20Boost%E5%BA%93%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E.html class=md-tabs__link> 项目 </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../index.html title=柯懒的知识库 class="md-nav__button md-logo" aria-label=柯懒的知识库 data-md-component=logo> <img src=../../assets/logo.png alt=logo> </a> 柯懒的知识库 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../index.html class=md-nav__link> <span class=md-ellipsis> 主页 </span> </a> </li> <li class=md-nav__item> <a href=../../%E7%BD%91%E7%AB%99%E4%BB%8B%E7%BB%8D/%E7%BD%91%E7%AB%99%E4%BB%8B%E7%BB%8D.html class=md-nav__link> <span class=md-ellipsis> 网站介绍 </span> </a> </li> <li class=md-nav__item> <a href=../../%E7%BD%91%E7%AB%99%E6%97%B6%E9%97%B4%E7%BA%BF/%E7%BD%91%E7%AB%99%E6%97%B6%E9%97%B4%E7%BA%BF.html class=md-nav__link> <span class=md-ellipsis> 网站时间线 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../C%E8%AF%AD%E8%A8%80/index.html class=md-nav__link> <span class=md-ellipsis> 编程语言 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/1.%20%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6%E5%92%8C%E7%A9%BA%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6/1.%20%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6%E4%B8%8E%E7%A9%BA%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6.html class=md-nav__link> <span class=md-ellipsis> 数据结构与算法 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6 checked> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex> <span class=md-ellipsis> Linux </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=true> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../1.%20Linux%E5%B8%B8%E7%94%A8%E9%80%89%E9%A1%B9%E5%92%8C%E6%8C%87%E4%BB%A4/1.%20Linux%E5%B8%B8%E7%94%A8%E9%80%89%E9%A1%B9%E5%92%8C%E6%8C%87%E4%BB%A4.html class=md-nav__link> <span class=md-ellipsis> Linux常用选项和指令 </span> </a> </li> <li class=md-nav__item> <a href=../2.%20Linux%E6%9D%83%E9%99%90%E7%9B%B8%E5%85%B3/2.%20Linux%E6%9D%83%E9%99%90%E7%9B%B8%E5%85%B3.html class=md-nav__link> <span class=md-ellipsis> Linux权限相关 </span> </a> </li> <li class=md-nav__item> <a href=../3.%20CentOS%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85/3.%20CentOS%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85.html class=md-nav__link> <span class=md-ellipsis> CentOS软件安装 </span> </a> </li> <li class=md-nav__item> <a href=../4.%20Linux%E4%B8%8B%E7%9A%84gcc%E4%B8%8Egdb/4.%20Linux%E4%B8%8B%E7%9A%84gcc%E4%B8%8Egdb.html class=md-nav__link> <span class=md-ellipsis> Linux下的gcc与gdb </span> </a> </li> <li class=md-nav__item> <a href=../5.%20Linux%E4%B8%8B%E7%9A%84Makefile%E4%B8%8E%E8%BF%9B%E5%BA%A6%E6%9D%A1%E7%A8%8B%E5%BA%8F/5.%20Linux%E4%B8%8B%E7%9A%84Makefile%E4%B8%8E%E8%BF%9B%E5%BA%A6%E6%9D%A1%E7%A8%8B%E5%BA%8F.html class=md-nav__link> <span class=md-ellipsis> Linux下的Makefile与进度条程序 </span> </a> </li> <li class=md-nav__item> <a href=../6.%20%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/6.%20%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86.html class=md-nav__link> <span class=md-ellipsis> 操作系统基础知识 </span> </a> </li> <li class=md-nav__item> <a href=../7.%20Linux%E8%BF%9B%E7%A8%8B/7.%20Linux%E8%BF%9B%E7%A8%8B.html class=md-nav__link> <span class=md-ellipsis> Linux进程基础 </span> </a> </li> <li class=md-nav__item> <a href=../8.%20Linux%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81%E4%B8%8E%E8%BF%9B%E7%A8%8B%E4%BC%98%E5%85%88%E7%BA%A7/8.%20Linux%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81%E4%B8%8E%E8%BF%9B%E7%A8%8B%E4%BC%98%E5%85%88%E7%BA%A7.html class=md-nav__link> <span class=md-ellipsis> Linux进程状态与进程优先级 </span> </a> </li> <li class=md-nav__item> <a href=../9.%20Linux%E8%BF%9B%E7%A8%8B%E5%88%87%E6%8D%A2%E4%BB%A5%E5%8F%8A%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95/9.%20Linux%E8%BF%9B%E7%A8%8B%E5%88%87%E6%8D%A2%E4%BB%A5%E5%8F%8A%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95.html class=md-nav__link> <span class=md-ellipsis> Linux进程切换以及调度算法 </span> </a> </li> <li class=md-nav__item> <a href=../10.%20Linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%B8%8E%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/10.%20Linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%B8%8E%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F.html class=md-nav__link> <span class=md-ellipsis> Linux命令行与环境变量 </span> </a> </li> <li class=md-nav__item> <a href=../11.%20Linux%E8%BF%9B%E7%A8%8B%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/11.%20%E8%BF%9B%E7%A8%8B%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4.html class=md-nav__link> <span class=md-ellipsis> Linux进程地址空间 </span> </a> </li> <li class=md-nav__item> <a href=../12.%20Linux%E8%BF%9B%E7%A8%8B%E6%8E%A7%E5%88%B6/12.%20Linux%E8%BF%9B%E7%A8%8B%E6%8E%A7%E5%88%B6.html class=md-nav__link> <span class=md-ellipsis> Linux进程控制 </span> </a> </li> <li class=md-nav__item> <a href=../13.%20Linux%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E5%9F%BA%E7%A1%80/13.%20Linux%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E5%9F%BA%E7%A1%80.html class=md-nav__link> <span class=md-ellipsis> Linux文件操作基础 </span> </a> </li> <li class=md-nav__item> <a href=../14.%20Linux%E4%B8%AD%E8%BE%93%E5%85%A5%E5%92%8C%E8%BE%93%E5%87%BA%E5%9F%BA%E6%9C%AC%E8%BF%87%E7%A8%8B/14.%20Linux%E4%B8%AD%E8%BE%93%E5%85%A5%E5%92%8C%E8%BE%93%E5%87%BA%E5%9F%BA%E6%9C%AC%E8%BF%87%E7%A8%8B.html class=md-nav__link> <span class=md-ellipsis> Linux中输入和输出基本过程 </span> </a> </li> <li class=md-nav__item> <a href=../15.%20Linux%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/15.%20Linux%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F.html class=md-nav__link> <span class=md-ellipsis> Linux文件系统 </span> </a> </li> <li class=md-nav__item> <a href=../16.%20Linux%E8%BD%AF%E9%93%BE%E6%8E%A5%E5%92%8C%E7%A1%AC%E9%93%BE%E6%8E%A5/16.%20Linux%E8%BD%AF%E9%93%BE%E6%8E%A5%E5%92%8C%E7%A1%AC%E9%93%BE%E6%8E%A5.html class=md-nav__link> <span class=md-ellipsis> Linux软链接和硬链接 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../17.%20Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/1.%20%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%E4%BB%8B%E7%BB%8D%E4%B8%8E%E5%8C%BF%E5%90%8D%E7%AE%A1%E9%81%93/1.%20%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%E4%BB%8B%E7%BB%8D%E4%B8%8E%E5%8C%BF%E5%90%8D%E7%AE%A1%E9%81%93.html class=md-nav__link> <span class=md-ellipsis> Linux进程间通信 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../18.%20Linux%E4%BF%A1%E5%8F%B7%E4%B8%8E%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/18.%20Linux%E4%BF%A1%E5%8F%B7%E4%B8%8E%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86.html class=md-nav__link> <span class=md-ellipsis> Linux信号与操作系统原理 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../19.%20Linux%E7%BA%BF%E7%A8%8B/1.%20Linux%E7%BA%BF%E7%A8%8B%E6%A6%82%E5%BF%B5%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%93%8D%E4%BD%9C/1.%20Linux%E7%BA%BF%E7%A8%8B%E6%A6%82%E5%BF%B5%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%93%8D%E4%BD%9C.html class=md-nav__link> <span class=md-ellipsis> Linux线程 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../20.%20%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/20.%20%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86.html class=md-nav__link> <span class=md-ellipsis> 网络基础知识 </span> </a> </li> <li class=md-nav__item> <a href=../21.%20Socket%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/21.%20Socket%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80.html class=md-nav__link> <span class=md-ellipsis> Socket编程基础 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../22.%20UDP%E7%BC%96%E7%A8%8B/1.%20UDP%E7%BC%96%E7%A8%8B%E6%8E%A5%E5%8F%A3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/1.%20UDP%E7%BC%96%E7%A8%8B%E6%8E%A5%E5%8F%A3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8.html class=md-nav__link> <span class=md-ellipsis> UDP编程 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../23.%20TCP%E7%BC%96%E7%A8%8B%E6%8E%A5%E5%8F%A3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/23.%20TCP%E7%BC%96%E7%A8%8B%E6%8E%A5%E5%8F%A3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8.html class=md-nav__link> <span class=md-ellipsis> TCP编程接口基本使用 </span> </a> </li> <li class=md-nav__item> <a href=../24.%20%E5%BA%8F%E5%88%97%E5%8C%96%E9%97%AE%E9%A2%98%E4%B8%8E%E7%BD%91%E7%BB%9C%E8%AE%A1%E7%AE%97%E5%99%A8/24.%20%E5%BA%8F%E5%88%97%E5%8C%96%E9%97%AE%E9%A2%98%E4%B8%8E%E7%BD%91%E7%BB%9C%E8%AE%A1%E7%AE%97%E5%99%A8.html class=md-nav__link> <span class=md-ellipsis> 序列化和反序列化与网络计算器 </span> </a> </li> <li class=md-nav__item> <a href=../25.%20%E8%BF%9B%E7%A8%8B%E9%97%B4%E5%85%B3%E7%B3%BB%E5%92%8C%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B/25.%20%E8%BF%9B%E7%A8%8B%E9%97%B4%E5%85%B3%E7%B3%BB%E5%92%8C%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B.html class=md-nav__link> <span class=md-ellipsis> 进程间关系和守护进程 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../26.%20%E5%BA%94%E7%94%A8%E5%B1%82%E5%8D%8F%E8%AE%AEHTTP/1.%20%E4%BB%8B%E7%BB%8DHTTP%E5%8D%8F%E8%AE%AE%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84%E4%B8%8E%E5%9F%BA%E6%9C%AC%E5%AE%9E%E7%8E%B0HTTPServer/1.%20%E4%BB%8B%E7%BB%8DHTTP%E5%8D%8F%E8%AE%AE%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84%E4%B8%8E%E5%9F%BA%E6%9C%AC%E5%AE%9E%E7%8E%B0HTTPServer.html class=md-nav__link> <span class=md-ellipsis> 应用层协议HTTP </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../27.%20UDP%E5%8D%8F%E8%AE%AE%E5%8E%9F%E7%90%86/27.%20UDP%E5%8D%8F%E8%AE%AE%E5%8E%9F%E7%90%86.html class=md-nav__link> <span class=md-ellipsis> UDP协议原理 </span> </a> </li> <li class=md-nav__item> <a href=../28.%20TCP%E5%8D%8F%E8%AE%AE%E5%8E%9F%E7%90%86/28.%20TCP%E5%8D%8F%E8%AE%AE%E5%8E%9F%E7%90%86.html class=md-nav__link> <span class=md-ellipsis> TCP协议原理 </span> </a> </li> <li class=md-nav__item> <a href=../35.%20%E7%90%86%E8%A7%A3Linux%E5%A6%82%E4%BD%95%E7%9C%8B%E5%BE%85%E8%BF%9E%E6%8E%A5%E4%BB%A5%E5%8F%8ATCP%E5%85%A8%E8%BF%9E%E6%8E%A5%E9%98%9F%E5%88%97/35.%20%E7%90%86%E8%A7%A3Linux%E5%A6%82%E4%BD%95%E7%9C%8B%E5%BE%85%E8%BF%9E%E6%8E%A5%E4%BB%A5%E5%8F%8ATCP%E5%85%A8%E8%BF%9E%E6%8E%A5%E9%98%9F%E5%88%97.html class=md-nav__link> <span class=md-ellipsis> 理解Linux如何看待连接以及TCP全连接队列 </span> </a> </li> <li class=md-nav__item> <a href=../29.%20%E7%BD%91%E7%BB%9C%E5%B1%82IP%E5%8D%8F%E8%AE%AE/29.%20%E7%BD%91%E7%BB%9C%E5%B1%82IP%E5%8D%8F%E8%AE%AE.html class=md-nav__link> <span class=md-ellipsis> 网络层IP协议 </span> </a> </li> <li class=md-nav__item> <a href=../30.%20%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82%E5%8D%8F%E8%AE%AE/30.%20%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82%E5%8D%8F%E8%AE%AE.html class=md-nav__link> <span class=md-ellipsis> 数据链路层协议 </span> </a> </li> <li class=md-nav__item> <a href=../36.%20DNS%E4%B8%8EICMP/36.%20DNS%E4%B8%8EICMP.html class=md-nav__link> <span class=md-ellipsis> DNS与ICMP </span> </a> </li> <li class=md-nav__item> <a href=../31.%20NAT%E6%8A%80%E6%9C%AF%E3%80%81%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%92%8C%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/31.%20NAT%E6%8A%80%E6%9C%AF%E3%80%81%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%92%8C%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F.html class=md-nav__link> <span class=md-ellipsis> NAT技术、代理服务器和内网穿透 </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> 五种IO模型与select和poll分别实现多路转接 </span> <span class="md-nav__icon md-icon"></span> </label> <a href=32.%20%E4%BA%94%E7%A7%8DIO%E6%A8%A1%E5%9E%8B%E4%B8%8Eselect%E5%92%8Cpoll%E5%88%86%E5%88%AB%E5%AE%9E%E7%8E%B0%E5%A4%9A%E8%B7%AF%E8%BD%AC%E6%8E%A5.html class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> 五种IO模型与select和poll分别实现多路转接 </span> </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#io class=md-nav__link> <span class=md-ellipsis> 何为IO </span> </a> </li> <li class=md-nav__item> <a href=#io_1 class=md-nav__link> <span class=md-ellipsis> 何为高效IO </span> </a> </li> <li class=md-nav__item> <a href=#io_2 class=md-nav__link> <span class=md-ellipsis> 五种IO模型与对比 </span> </a> </li> <li class=md-nav__item> <a href=#io_3 class=md-nav__link> <span class=md-ellipsis> 非阻塞式IO </span> </a> </li> <li class=md-nav__item> <a href=#select class=md-nav__link> <span class=md-ellipsis> select实现多路转接 </span> </a> </li> <li class=md-nav__item> <a href=#select_1 class=md-nav__link> <span class=md-ellipsis> select的缺陷 </span> </a> </li> <li class=md-nav__item> <a href=#select_2 class=md-nav__link> <span class=md-ellipsis> Select多路转接的优缺点 </span> </a> </li> <li class=md-nav__item> <a href=#poll class=md-nav__link> <span class=md-ellipsis> poll实现多路转接 </span> </a> </li> <li class=md-nav__item> <a href=#poll_1 class=md-nav__link> <span class=md-ellipsis> poll的缺陷 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../33.%20epoll%E5%AE%9E%E7%8E%B0%E5%A4%9A%E8%B7%AF%E8%BD%AC%E6%8E%A5/33.%20epoll%E5%AE%9E%E7%8E%B0%E5%A4%9A%E8%B7%AF%E8%BD%AC%E6%8E%A5.html class=md-nav__link> <span class=md-ellipsis> epoll实现多路转接 </span> </a> </li> <li class=md-nav__item> <a href=../34.%20Reactor%E6%A8%A1%E5%BC%8F%E4%B8%8E%E5%AE%8C%E5%96%84%E5%9F%BA%E4%BA%8E%E8%BE%B9%E7%BC%98%E8%A7%A6%E5%8F%91%E6%A8%A1%E5%BC%8Fepoll%E5%AE%9E%E7%8E%B0TCP%E6%9C%8D%E5%8A%A1%E5%99%A8/34.%20Reactor%E6%A8%A1%E5%BC%8F%E4%B8%8E%E5%AE%8C%E5%96%84%E5%9F%BA%E4%BA%8E%E8%BE%B9%E7%BC%98%E8%A7%A6%E5%8F%91%E6%A8%A1%E5%BC%8Fepoll%E5%AE%9E%E7%8E%B0TCP%E6%9C%8D%E5%8A%A1%E5%99%A8.html class=md-nav__link> <span class=md-ellipsis> Reactor模式与完善基于边缘触发模式epoll实现TCP服务器 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../HTML%E4%B8%8ECSS/HTML%E7%AC%94%E8%AE%B0/HTML%E7%AC%94%E8%AE%B0.html class=md-nav__link> <span class=md-ellipsis> 前端 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../MySQL/MySQL%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/MySQL%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8.html class=md-nav__link> <span class=md-ellipsis> MySQL </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../JavaEE/Spring/1.%20SpringMVC%E5%9F%BA%E7%A1%80/1.%20SpringMVC%E5%9F%BA%E7%A1%80.html class=md-nav__link> <span class=md-ellipsis> JavaEE应用开发 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../%E5%85%B6%E5%AE%83/Shell%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80/%E5%85%B3%E4%BA%8EShell.html class=md-nav__link> <span class=md-ellipsis> 扩展知识 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../%E5%B7%A5%E5%85%B7%E5%B8%AE%E5%8A%A9/vscode%E4%B8%AD%E6%B7%BB%E5%8A%A0%E4%BB%A3%E7%A0%81%E7%89%87%E6%AE%B5/vscode%E4%B8%AD%E6%B7%BB%E5%8A%A0%E4%BB%A3%E7%A0%81%E7%89%87%E6%AE%B5.html class=md-nav__link> <span class=md-ellipsis> 工具帮助 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../%E9%A1%B9%E7%9B%AE/1.%20Boost%E5%BA%93%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/1.%20Boost%E5%BA%93%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E.html class=md-nav__link> <span class=md-ellipsis> 项目 </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#io class=md-nav__link> <span class=md-ellipsis> 何为IO </span> </a> </li> <li class=md-nav__item> <a href=#io_1 class=md-nav__link> <span class=md-ellipsis> 何为高效IO </span> </a> </li> <li class=md-nav__item> <a href=#io_2 class=md-nav__link> <span class=md-ellipsis> 五种IO模型与对比 </span> </a> </li> <li class=md-nav__item> <a href=#io_3 class=md-nav__link> <span class=md-ellipsis> 非阻塞式IO </span> </a> </li> <li class=md-nav__item> <a href=#select class=md-nav__link> <span class=md-ellipsis> select实现多路转接 </span> </a> </li> <li class=md-nav__item> <a href=#select_1 class=md-nav__link> <span class=md-ellipsis> select的缺陷 </span> </a> </li> <li class=md-nav__item> <a href=#select_2 class=md-nav__link> <span class=md-ellipsis> Select多路转接的优缺点 </span> </a> </li> <li class=md-nav__item> <a href=#poll class=md-nav__link> <span class=md-ellipsis> poll实现多路转接 </span> </a> </li> <li class=md-nav__item> <a href=#poll_1 class=md-nav__link> <span class=md-ellipsis> poll的缺陷 </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=ioselectpoll>五种IO模型与<code>select</code>和<code>poll</code>分别实现多路转接<a class=headerlink href=#ioselectpoll title="Permanent link">&para;</a></h1> <div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;"> <p><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 8593 个字 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 603 行代码 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 5 张图片 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 36 分钟</p> </div> <h2 id=io>何为IO<a class=headerlink href=#io title="Permanent link">&para;</a></h2> <p>不论是在前面文件部分，还是后面的网络部分，IO都是非常常见的。但是当时只是简单对IO进行提及，并没有对IO的本质进行介绍。那么到底何为IO？IO全称为输入和输出，而任何一个IO过程都需要涉及到两个过程：</p> <ol> <li>等待</li> <li>拷贝</li> </ol> <p>所以，此处就可以得出一个关于IO的简单结论：IO实际上是由等待+拷贝两个行为构成的</p> <p>通过前面对<code>read</code>、<code>write</code>等接口的学习可以知道一个非常直观的现象：如果写方并没有写入内容，那么读方会进入阻塞；反过来，如果当前写方的缓冲区已满，那么写方也会阻塞。这里的两个阻塞本质上就是等待。对于这种存在一种等待条件的称为<strong>阻塞式IO</strong>，而从等待到不等待或者从不等待到等待本质都属于一种条件的变化，在IO部分，称这一现象为<strong>IO事件</strong>，而一旦条件发生改变（例如从等待变为不等待），那么就称为<strong>IO事件就绪</strong></p> <h2 id=io_1>何为高效IO<a class=headerlink href=#io_1 title="Permanent link">&para;</a></h2> <p>从前面学习到的IO可以看到，IO实际上大部分的时间都是在等待而并非拷贝。例如在<a href=https://www.help-doc.top/Linux/17.%20Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/1.%20%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%E4%BB%8B%E7%BB%8D%E4%B8%8E%E5%8C%BF%E5%90%8D%E7%AE%A1%E9%81%93/1.%20%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%E4%BB%8B%E7%BB%8D%E4%B8%8E%E5%8C%BF%E5%90%8D%E7%AE%A1%E9%81%93.html#linux>Linux进程间通信</a>一节可以看到只有写方写入，读方才可以开始读，而读只是一瞬间的事情，又比如在<a href=https://www.help-doc.top/Linux/22.%20UDP%E7%BC%96%E7%A8%8B/1.%20UDP%E7%BC%96%E7%A8%8B%E6%8E%A5%E5%8F%A3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/1.%20UDP%E7%BC%96%E7%A8%8B%E6%8E%A5%E5%8F%A3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8.html#udp>UDP编程接口基本使用</a>一节可以看到只有客户端写入，服务端才会读取到信息，而其中的读取也是一瞬间的事情，这两个例子最明显的共同点就是读取都必须等待，而拷贝消耗的时间相比于等待消耗的时间非常少。所以，所谓的高效IO<strong>实际上解决的主要矛盾就是减少IO中等待的时间以提高整机的资源利用率</strong></p> <p>既然如此，那么有没有可以让等待的时间尽可能减少从而减少IO整体的时间消耗的方式呢？<strong>答案是有</strong>，具体是什么方式在接下来会介绍</p> <h2 id=io_2>五种IO模型与对比<a class=headerlink href=#io_2 title="Permanent link">&para;</a></h2> <p>在介绍高效的IO方式之前，先了解常见的五种IO模型：</p> <ol> <li> <p>阻塞式IO：在内核将数据准备好之前，系统调用会一直等待。所有的套接字，默认都是阻塞方式。这是比较常见的IO方式。以<code>read</code>接口为例，示意图如下：</p> <p><a class=glightbox href="32. 五种IO模型与select和poll分别实现多路转接.assets\1.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="32. 五种IO模型与select和poll分别实现多路转接.assets\1.png"></a></p> </li> <li> <p>非阻塞式IO：如果内核已经将数据准备好，直接返回数据；如果内核还未将数据准备好，系统调用仍然会直接返回，并且返回<code>EWOULDBLOCK</code>错误码或者<code>EAGAIN</code>错误码。但是非阻塞IO往往需要程序员循环的方式反复尝试读写文件描述符，这个过程称为<strong>轮询</strong>，这个过程对于CPU来说是较大的浪费，一般只有特定场景下才使用。示意图如下：</p> <p><a class=glightbox href="32. 五种IO模型与select和poll分别实现多路转接.assets\2.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="32. 五种IO模型与select和poll分别实现多路转接.assets\2.png"></a></p> </li> <li> <p>信号驱动式IO：内核将数据准备好的时候，使用<code>SIGIO</code>信号通知应用程序进行IO操作</p> <p><a class=glightbox href="32. 五种IO模型与select和poll分别实现多路转接.assets\3.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="32. 五种IO模型与select和poll分别实现多路转接.assets\3.png"></a></p> </li> <li> <p>多路转接（也称为多路复用）：进程同时管理多个文件描述符，只要有一个文件描述符有数据就立即通知给进程进行数据读取。以<code>select</code>为例，示意图如下：</p> <p><a class=glightbox href="32. 五种IO模型与select和poll分别实现多路转接.assets\4.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="32. 五种IO模型与select和poll分别实现多路转接.assets\4.png"></a></p> </li> <li> <p>异步IO：当前一方向另外一放发起IO处理，当前一方不再参与IO行为，当数据准备完毕时，由通知到的一方处理完成（等待+拷贝），再交给发起IO的一方，示意图如下：</p> <p><a class=glightbox href="32. 五种IO模型与select和poll分别实现多路转接.assets\5.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="32. 五种IO模型与select和poll分别实现多路转接.assets\5.png"></a></p> </li> </ol> <p>下面依次探讨上面的五种IO模型：</p> <p>首先考虑阻塞式IO和非阻塞式IO，阻塞式IO在进程读取到数据之前会一直阻塞而不会去做其他的事情，非阻塞式IO不会阻塞在IO的过程之中，这个阶段会在做其他事情与检测是否有数据中轮询执行，二者最本质的区别就是一个在卡主等待，另外一个并不会卡主。从这个角度来看，非阻塞式IO的效率的确会比较高，因为进程可以去完成其他的事情，但是实际上，阻塞式IO和非阻塞式IO从当前IO单一过程来看，并没有实际上的效率区别，本质都是需要等待。换句话说，二者的等待时间占比是基本一致的。所以，从IO层面来看，非阻塞式IO并没有比阻塞式IO有很大的IO效率提升，所以理解所谓的「非阻塞式IO效率高」这句话并不是单纯看IO效率，而是看整机效率</p> <p>接着看第三种方式：信号驱动式IO。这种方式可以理解为是非阻塞式IO的一种升级，非阻塞式IO需要一直轮询检测数据是否就绪，也就是说是否有数据需要自己判断，而信号驱动式IO数据是否就绪由操作系统判断，一旦操作系统发现数据就绪就通过信号通知进程，所以本质信号驱动式IO是<strong>逆转了判断数据就绪的方式，从而减少IO过程中等待的占比时间</strong>，因为等待的一方是操作系统而不是当前进程，所有从当前进程来看IO过程中等待占比时间减少</p> <p>接着看第四种方式：多路转接。这种方式最大的特点就是一个进程可以持有多个文件描述符，因为在Linux下，一切皆文件，所以拥有多个文件描述符也就意味着可以读取到多个文件描述符中的内容，如果此时当前进程告知发送方只要有数据就向这些文件描述符中的任意一个写入数据，那么整体来看当前进程的等待时间就会减少，因为只要有一个文件描述符有数据，当前进程就会进入数据拷贝，所以多路转接方式中进程更多的时间在做拷贝而不是等待从而效率变高</p> <p>最后看第五种方式：异步IO。了解异步IO之前，首先区分<strong>同步IO</strong>与<strong>异步IO</strong>，区分二者的方式很简单：判断是否是发起IO行为的进程本身参与IO的任意一个过程（等待或者拷贝），只要参与了任意一种行为，就属于同步IO，否则属于异步IO。很明显，异步IO的核心特点是IO操作和程序逻辑可以并行执行。异步IO特别适合密集型任务和高并发场景</p> <p>既然有五种IO模型，那么效率最高的是哪一种呢？<strong>第四种：多路转接</strong>。因为异步IO虽然效率高，但是实现起来非常复杂，这就导致实现出的异步IO代码难度高且可维护性并没有多路转接好，另外现在的服务器大部分都是基于Linux，而Linux下的多路转接技术相对容易实现，所以相对多的情况下还是使用多路转接。而其余三种IO方式，与多路转接最大的不同就是<strong>只有一个文件描述符</strong>，能否及时数据的概率始终是取决于对方，而多路转接因为存在多个文件描述符，增加了收到数据的概率，所以此时能否及时处理数据就取决于自己，但是取决于自己就可以保证最大程度上利用CPU资源，所以还是<strong>更推荐多路转接</strong></p> <h2 id=io_3>非阻塞式IO<a class=headerlink href=#io_3 title="Permanent link">&para;</a></h2> <p>为了后面更好得理解多路转接，先了解一下阻塞式IO的特点，以下面的代码为例：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-0-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;string&gt;</span>
</span><span id=__span-0-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;unistd.h&gt;</span>
</span><span id=__span-0-4>
</span><span id=__span-0-5><span class=k>using</span><span class=w> </span><span class=k>namespace</span><span class=w> </span><span class=nn>std</span><span class=p>;</span>
</span><span id=__span-0-6>
</span><span id=__span-0-7><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-0-8><span class=p>{</span>
</span><span id=__span-0-9><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;请输入信息：&quot;</span><span class=p>;</span>
</span><span id=__span-0-10><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-0-11><span class=w>    </span><span class=p>{</span>
</span><span id=__span-0-12><span class=w>        </span><span class=c1>// 先向标准输出中写入数据</span>
</span><span id=__span-0-13><span class=w>        </span><span class=n>write</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>.</span><span class=n>c_str</span><span class=p>(),</span><span class=w> </span><span class=n>message</span><span class=p>.</span><span class=n>size</span><span class=p>());</span>
</span><span id=__span-0-14><span class=w>        </span><span class=kt>char</span><span class=w> </span><span class=n>buffer</span><span class=p>[</span><span class=mi>1024</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span><span id=__span-0-15><span class=w>        </span><span class=c1>// 再从标准输入中读取数据</span>
</span><span id=__span-0-16><span class=w>        </span><span class=kt>ssize_t</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>buffer</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-0-17>
</span><span id=__span-0-18><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-0-19><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>buffer</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-0-20><span class=w>    </span><span class=p>}</span>
</span><span id=__span-0-21>
</span><span id=__span-0-22><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-0-23><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>上面的代码是阻塞式IO，实际的效果就是如果用户没有输入，那么控制台就会一直卡在下面的位置：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-1-1>请输入信息：
</span></code></pre></div></td></tr></table></div> <p>一旦用户输入一条信息，控制台就会打印出对应的信息，之后继续卡在同样的位置</p> <p>如果需要将上面的阻塞式IO修改为非阻塞式IO可以使用<code>fcntl</code>接口，这个接口可以针对特定文件描述符进行操作，就不用再针对某一个接口设置非阻塞，其原型如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-2-1><span class=kt>int</span><span class=w> </span><span class=nf>fcntl</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>op</span><span class=p>,</span><span class=w> </span><span class=p>...</span><span class=w> </span><span class=cm>/* arg */</span><span class=w> </span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>该函数有三个参数，第一个参数表示要指定的文件描述符，第二个参数为操作标记，有下面几种值：</p> <ul> <li>复制一个现有的描述符（<code>F_DUPFD</code>）</li> <li>获得/设置文件描述符标记（<code>F_GETFD</code>或<code>F_SETFD</code>）</li> <li>获得/设置文件状态标记（<code>F_GETFL</code>或<code>F_SETFL</code>）</li> <li>获得/设置异步IO所有权（<code>F_GETOWN</code>或<code>F_SETOWN</code>）</li> <li>获得/设置记录锁（<code>F_GETLK</code>、<code>F_SETLK</code>或<code>F_SETLKW</code>）</li> </ul> <p>第三个参数表示根据对应操作标记需要设置的值</p> <p>本次因为需要更改是否为阻塞，就需要使用到<code>F_GETFL</code>和<code>F_SETFL</code>，如果是<code>F_GETFL</code>，那么<code>fcntl</code>函数对应的文件描述符的状态，表示获取，并且不需要设置第三个参数；如果是<code>F_SETFL</code>，则没有返回值，表示设置，如果要设置为非阻塞IO，那么对应的第三个参数设置为<code>O_NONBLOCK</code></p> <p>基于上面的理论，可以设计出下面的函数：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-3-1><span class=kt>void</span><span class=w> </span><span class=nf>setNonBlock</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>fd</span><span class=p>)</span>
</span><span id=__span-3-2><span class=p>{</span>
</span><span id=__span-3-3><span class=w>    </span><span class=c1>// 获取当前文件描述符状态</span>
</span><span id=__span-3-4><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>stat</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fcntl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>F_GETFL</span><span class=p>);</span>
</span><span id=__span-3-5><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>stat</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-3-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-3-7><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cerr</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;状态错误&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-3-8><span class=w>        </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-3-9><span class=w>    </span><span class=p>}</span>
</span><span id=__span-3-10><span class=w>    </span><span class=c1>// 设置为非阻塞</span>
</span><span id=__span-3-11><span class=w>    </span><span class=n>fcntl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>F_SETFL</span><span class=p>,</span><span class=w> </span><span class=n>stat</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>O_NONBLOCK</span><span class=p>);</span>
</span><span id=__span-3-12><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>接着，设置标准输入为非阻塞：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-4-1><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-4-2><span class=p>{</span>
</span><span id=__span-4-3><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-4-4><span class=w>    </span><span class=n>setNonBlock</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-4-5><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-4-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-4-7>
</span><span id=__span-4-8><span class=w>    </span><span class=p>}</span>
</span><span id=__span-4-9><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-4-10><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>此时，如果直接运行就会看到控制台一直在打印<code>请输入信息：</code>。为了减慢打印速度，可以在循环内部考虑加一个<code>sleep(1);</code>：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-5-1><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-5-2><span class=p>{</span>
</span><span id=__span-5-3><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;请输入信息：&quot;</span><span class=p>;</span>
</span><span id=__span-5-4><span class=w>    </span><span class=n>setNonBlock</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-5-5><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-5-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-5-7><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-5-8>
</span><span id=__span-5-9><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-5-10><span class=w>    </span><span class=p>}</span>
</span><span id=__span-5-11>
</span><span id=__span-5-12><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-5-13><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>这就已经完成了阻塞IO到非阻塞IO的转变。但是了解这个内容还不够，下面需要再进一步了解读写接口，以<code>read</code>为例，<code>read</code>接口的返回值如果为正数，那么此时就代表正常读取到的字符个数，如果返回值为0，那么此时就代表写端关闭，但是如果返回值为负数，那么存在两种情况：</p> <ol> <li>内核数据未准备好</li> <li>读取失败</li> </ol> <p>基于上面的三种返回值，可以修改上面的代码：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-6-1><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-6-2><span class=p>{</span>
</span><span id=__span-6-3><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;请输入信息：&quot;</span><span class=p>;</span>
</span><span id=__span-6-4><span class=w>    </span><span class=n>setNonBlock</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-6-5><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-6-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-6-7><span class=w>        </span><span class=c1>// 先向标准输出中写入数据</span>
</span><span id=__span-6-8><span class=w>        </span><span class=n>write</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>.</span><span class=n>c_str</span><span class=p>(),</span><span class=w> </span><span class=n>message</span><span class=p>.</span><span class=n>size</span><span class=p>());</span>
</span><span id=__span-6-9><span class=w>        </span><span class=kt>char</span><span class=w> </span><span class=n>buffer</span><span class=p>[</span><span class=mi>1024</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span><span id=__span-6-10><span class=w>        </span><span class=c1>// 再从标准输入中读取数据</span>
</span><span id=__span-6-11><span class=w>        </span><span class=kt>ssize_t</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>buffer</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-6-12>
</span><span id=__span-6-13><span class=w>        </span><span class=c1>// 针对三种返回值考虑三种情况</span>
</span><span id=__span-6-14><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-6-15><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>buffer</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-6-16><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-6-17><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;写端关闭&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-6-18><span class=w>        </span><span class=k>else</span>
</span><span id=__span-6-19><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;错误&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-6-20>
</span><span id=__span-6-21><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-6-22><span class=w>    </span><span class=p>}</span>
</span><span id=__span-6-23>
</span><span id=__span-6-24><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-6-25><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>因为此时是非阻塞IO，运行且不输入任何数据就会看到下面的结果：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-7-1>请输入信息：错误
</span><span id=__span-7-2>请输入信息：错误
</span><span id=__span-7-3>请输入信息：错误
</span><span id=__span-7-4>请输入信息：错误
</span><span id=__span-7-5>请输入信息：错误
</span><span id=__span-7-6>请输入信息：错误
</span><span id=__span-7-7>...
</span></code></pre></div></td></tr></table></div> <p>这一结果也印证了如果底层数据还没有准备好，那么<code>read</code>接口会直接返回为-1</p> <p>但是，上面提到了<code>read</code>接口返回-1有两种情况，现在就面临着一个问题：既然-1不但代表失败，还代表底层数据没有准备好，而对于数据还没有准备好一般处理逻辑和失败的处理逻辑是不一样的，那么这种情况下如何做出写出不同的处理逻辑？<strong>答案是通过错误码</strong>，在<a href=https://www.help-doc.top/Linux/12.%20Linux%E8%BF%9B%E7%A8%8B%E6%8E%A7%E5%88%B6/12.%20Linux%E8%BF%9B%E7%A8%8B%E6%8E%A7%E5%88%B6.html#_2>Linux进程控制</a>部分提到过库函数如果出错会设置对应的错误码，实际上，除了库函数以外，系统调用出错也会设置对应的错误码，而这个错误码一般记录着最近一次出错的系统调用或者库函数调用的出错信息编号</p> <p>对于<code>read</code>函数来说，如果底层数据还没有准备好，那么错误码会被设置为11，表示<code>EAGAIN</code>或者<code>EWOULDBLOCK</code>，而不是这两个错误码就说明当前-1代表读取失败，所以进一步修改上面的代码：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-8-1><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-8-2><span class=p>{</span>
</span><span id=__span-8-3><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-8-4><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-8-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-8-6><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-8-7>
</span><span id=__span-8-8><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-8-9><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>buffer</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-8-10><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-8-11><span class=w>        </span><span class=p>{</span>
</span><span id=__span-8-12><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;写端关闭&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-8-13><span class=w>            </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-8-14><span class=w>        </span><span class=p>}</span>
</span><span id=__span-8-15><span class=w>        </span><span class=k>else</span>
</span><span id=__span-8-16><span class=w>        </span><span class=p>{</span>
</span><span id=__span-8-17><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>errno</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>EAGAIN</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>errno</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>EWOULDBLOCK</span><span class=p>)</span>
</span><span id=__span-8-18><span class=w>            </span><span class=p>{</span>
</span><span id=__span-8-19><span class=w>                </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;底层数据还没有准备好&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-8-20><span class=w>                </span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-8-21><span class=w>                </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-8-22><span class=w>            </span><span class=p>}</span>
</span><span id=__span-8-23><span class=w>            </span><span class=k>else</span>
</span><span id=__span-8-24><span class=w>            </span><span class=p>{</span>
</span><span id=__span-8-25><span class=w>                </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;错误&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-8-26><span class=w>                </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-8-27><span class=w>            </span><span class=p>}</span>
</span><span id=__span-8-28><span class=w>        </span><span class=p>}</span>
</span><span id=__span-8-29>
</span><span id=__span-8-30><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-8-31><span class=w>    </span><span class=p>}</span>
</span><span id=__span-8-32>
</span><span id=__span-8-33><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-8-34><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>此时再次编译运行上面的代码就可以看到打印的消息变为：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-9-1>请输入信息：底层数据还没有准备好
</span><span id=__span-9-2>请输入信息：底层数据还没有准备好
</span><span id=__span-9-3>请输入信息：底层数据还没有准备好
</span><span id=__span-9-4>请输入信息：底层数据还没有准备好
</span><span id=__span-9-5>请输入信息：底层数据还没有准备好
</span><span id=__span-9-6>请输入信息：底层数据还没有准备好
</span><span id=__span-9-7>...
</span></code></pre></div></td></tr></table></div> <p>对于阻塞IO来说，如果当前陷入内核后被调度，那么调度完成后再次回到上一次的位置依旧会保持阻塞状态，因为对于大部分的IO类系统调用本身就包含了IO事件的判断以及对进程进行挂起的逻辑，但是如果是非阻塞IO，其阻塞状态几乎不存在，但是很有可能处于数据拷贝的状态，如果此时被切换，错误码就会被设置为<code>EINTR</code>，一旦收到错误码为<code>EINTR</code>，那么就说明此时正常行为被打断，例如拷贝过程，需要上层自行处理这种情况</p> <p>所以，再次修改上面的代码如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-10-1><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-10-2><span class=p>{</span>
</span><span id=__span-10-3><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-10-4><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-10-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-10-6><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-10-7>
</span><span id=__span-10-8><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-10-9><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>buffer</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-10-10><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-10-11><span class=w>        </span><span class=p>{</span>
</span><span id=__span-10-12><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;写端关闭&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-10-13><span class=w>            </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-10-14><span class=w>        </span><span class=p>}</span>
</span><span id=__span-10-15><span class=w>        </span><span class=k>else</span>
</span><span id=__span-10-16><span class=w>        </span><span class=p>{</span>
</span><span id=__span-10-17><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>errno</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>EAGAIN</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>errno</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>EWOULDBLOCK</span><span class=p>)</span>
</span><span id=__span-10-18><span class=w>            </span><span class=p>{</span>
</span><span id=__span-10-19><span class=w>                </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;底层数据还没有准备好&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-10-20><span class=w>                </span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-10-21><span class=w>                </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-10-22><span class=w>            </span><span class=p>}</span>
</span><span id=__span-10-23><span class=w>            </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=p>(</span><span class=n>errno</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>EINTR</span><span class=p>)</span>
</span><span id=__span-10-24><span class=w>            </span><span class=p>{</span>
</span><span id=__span-10-25><span class=w>                </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;进程中断，请重试&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-10-26><span class=w>                </span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-10-27><span class=w>                </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-10-28><span class=w>            </span><span class=p>}</span>
</span><span id=__span-10-29><span class=w>            </span><span class=k>else</span>
</span><span id=__span-10-30><span class=w>            </span><span class=p>{</span>
</span><span id=__span-10-31><span class=w>                </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;错误&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-10-32><span class=w>                </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-10-33><span class=w>            </span><span class=p>}</span>
</span><span id=__span-10-34><span class=w>        </span><span class=p>}</span>
</span><span id=__span-10-35>
</span><span id=__span-10-36><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-10-37><span class=w>    </span><span class=p>}</span>
</span><span id=__span-10-38>
</span><span id=__span-10-39><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-10-40><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>基于对非阻塞IO的介绍，思考：对于<code>read</code>等IO接口来说，什么错误是可接受（可以在运行程序时直接处理）的？<strong>即错误码被设置为<code>EAGAIN</code>、<code>EWOULDBLOCK</code>或者<code>EINTR</code>时</strong>（腾讯C++后端一面）</p> <p>如果在当前情况下想看第二个分支结果，可以按下键盘的<span class=keys><kbd class=key-control>Ctrl</kbd><span>+</span><kbd class=key-d>D</kbd></span>，这个快捷键表示终止键盘输入，此时就会看到下面的结果：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-11-1>写端关闭
</span></code></pre></div></td></tr></table></div> <h2 id=select><code>select</code>实现多路转接<a class=headerlink href=#select title="Permanent link">&para;</a></h2> <p>在上面已经基本介绍了多路转接的基本原理，基于这个原理，可以推出多路转接的作用：</p> <ol> <li>等待：等待多个文件描述符中的任意一个就绪</li> <li>通知：一旦某个文件描述符就绪，就通知进程可以开始进行数据拷贝</li> </ol> <p>所以多路转接本质就是IO事件就绪的通知机制</p> <p>下面结合代码来理解多路转接，在Linux下，实现多路转接可以使用<code>select</code>接口，其原型如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-12-1><span class=kt>int</span><span class=w> </span><span class=nf>select</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>nfds</span><span class=p>,</span><span class=w> </span><span class=n>fd_set</span><span class=w> </span><span class=o>*</span><span class=n>readfds</span><span class=p>,</span><span class=w> </span><span class=n>fd_set</span><span class=w> </span><span class=o>*</span><span class=n>writefds</span><span class=p>,</span>
</span><span id=__span-12-2><span class=w>           </span><span class=n>fd_set</span><span class=w> </span><span class=o>*</span><span class=n>exceptfds</span><span class=p>,</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>timeval</span><span class=w> </span><span class=o>*</span><span class=n>timeout</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>该接口一共有五个参数，首先介绍第一个参数和最后一个参数：</p> <p>对于第一个参数来说，其表示文件描述符的个数，根据官方手册的描述，<a href=javascript:; class=custom-tooltip data-title="This  argument  should  be  set to the highest-numbered file descriptor in any of the three sets, plus 1">这个参数的值为三个文件描述符集中最大文件描述符+1</a>，所以想要确定这个值，就必须要遍历三个文件描述符集</p> <p>对于最后一个参数来说，这是一个输入、输出型参数，其表示等待时间，有三种情况：</p> <ol> <li>阻塞等待：将其设置为<code>nullptr</code>，如果有一个文件描述符就绪，<code>select</code>就会立即返回</li> <li>非阻塞等待：将<code>timeval</code>结构体中所有字段初始化为0，不论是否有数据就绪，<code>select</code>都会立即返回</li> <li>等待指定时间：分别设置结构体<code>timeval</code>中的两个字段值，操作系统会以当前系统时间为起点设置超时时间。此时如果在等待时间内没有数据就绪或者到达指定的之间，那么<code>select</code>就会立即返回并将该结构体中的两个字段值设置为0；如果在等待时间内有数据就绪或者到达指定的时间，那么<code>select</code>会将该结构体中的两个字段值设置为实际剩余的时间</li> </ol> <p><code>timeval</code>结构体的定义如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-13-1><span class=k>struct</span><span class=w> </span><span class=nc>timeval</span><span class=w> </span>
</span><span id=__span-13-2><span class=p>{</span>
</span><span id=__span-13-3><span class=w>    </span><span class=kt>time_t</span><span class=w>      </span><span class=n>tv_sec</span><span class=p>;</span><span class=w>     </span><span class=cm>/* seconds */</span>
</span><span id=__span-13-4><span class=w>    </span><span class=n>suseconds_t</span><span class=w> </span><span class=n>tv_usec</span><span class=p>;</span><span class=w>    </span><span class=cm>/* microseconds */</span>
</span><span id=__span-13-5><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>接下来看剩余的三个参数，但是在具体介绍三个参数的作用之前，先了解一下<code>fd_set</code>这个数据类型。<code>fd_set</code>表示文件描述符集，其本质是一个位图，但是位图的元素值只能是0或者1，所以<code>fd_set</code>要想表示具体的文件描述符就需要借助下标，所以这个位图每一个比特位和对应的位置含义如下：</p> <ol> <li>当前比特位位置表示文件描述符</li> <li>当前比特位的值表示需要关心当前文件描述符的IO事件</li> </ol> <p>但是，在Linux中<code>fd_set</code>底层本质上就是一个数组，其每一个元素类型为<code>unsigned long</code>，其原型如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-14-1><span class=cp>#define __FDSET_LONGS   (__FD_SETSIZE/__NFDBITS)</span>
</span><span id=__span-14-2>
</span><span id=__span-14-3><span class=k>typedef</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-4><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>fds_bits</span><span class=w> </span><span class=p>[</span><span class=n>__FDSET_LONGS</span><span class=p>];</span>
</span><span id=__span-14-5><span class=p>}</span><span class=w> </span><span class=n>__kernel_fd_set</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> <p>这就意味着在Linux中，每个文件描述符集能管理的文件描述符都是有限的，这就是<code>select</code>接口的局限性，所以一般使用<code>select</code>接口都是在比较小型的项目中使用。如果要判断当前Linux系统中的<code>fd_set</code>位图大小，可以使用下面的代码：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-15-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-15-2>
</span><span id=__span-15-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;sys/select.h&gt;</span>
</span><span id=__span-15-4>
</span><span id=__span-15-5><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-15-6><span class=p>{</span>
</span><span id=__span-15-7><span class=w>    </span><span class=n>fd_set</span><span class=w> </span><span class=n>fds</span><span class=p>;</span>
</span><span id=__span-15-8><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>fds</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>8</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-15-9>
</span><span id=__span-15-10><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-15-11><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>例如，下面的结果：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-16-1>1024
</span></code></pre></div></td></tr></table></div> <p>在上面的代码中，之所以要乘以8，是因为<code>fd_set</code>本质是对一个数组进行的封装，这个数组中每一个元素是<code>unsigned long</code>类型，所以为了计算出每一个比特位，需要将元素个数乘以8</p> <p>接下来再看<code>select</code>的三个参数：</p> <ol> <li><code>readfds</code>：表示关心指定文件描述符的读事件，对应的就是关心对应的读缓冲区是否有数据</li> <li><code>writefds</code>：表示关心指定文件描述符的写事件，对应的就是关心对应的写缓冲区是否有空间</li> <li><code>exceptfds</code>：表示关心指定文件描述符的异常事件，对应的就是关心对应的文件描述符是否发生异常</li> </ol> <p>既然这三个参数都是位图，那么必然需要借助位图的相关操作来对这三个参数进行操作，在Linux中提供了下面的接口来对这三个参数进行操作：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-17-1><span class=kt>void</span><span class=w> </span><span class=nf>FD_CLR</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>fd_set</span><span class=w> </span><span class=o>*</span><span class=n>set</span><span class=p>);</span><span class=w> </span><span class=c1>// 移除指定位图中的指定文件描述符</span>
</span><span id=__span-17-2><span class=kt>int</span><span class=w>  </span><span class=nf>FD_ISSET</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>fd_set</span><span class=w> </span><span class=o>*</span><span class=n>set</span><span class=p>);</span><span class=w> </span><span class=c1>// 判断指定位图中是否存在指定文件描述符</span>
</span><span id=__span-17-3><span class=kt>void</span><span class=w> </span><span class=nf>FD_SET</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>fd_set</span><span class=w> </span><span class=o>*</span><span class=n>set</span><span class=p>);</span><span class=w> </span><span class=c1>// 添加指定位图中的指定文件描述符</span>
</span><span id=__span-17-4><span class=kt>void</span><span class=w> </span><span class=nf>FD_ZERO</span><span class=p>(</span><span class=n>fd_set</span><span class=w> </span><span class=o>*</span><span class=n>set</span><span class=p>);</span><span class=w> </span><span class=c1>// 清空指定位图</span>
</span></code></pre></div></td></tr></table></div> <p>与<code>select</code>最后一个参数相同，<code>select</code>的前三个参数也是输入、输出型参数，所以在调用<code>select</code>接口时，需要先将这三个参数设置为需要关心的文件描述符，在<code>select</code>接口中会判断关心的文件描述符是否就绪，如果就绪对应的描述符（下标）对应的比特位就会被置为1，而其他没有就绪的文件描述符对应的比特位就会被置为0，所以在调用<code>select</code>接口之后，判断哪些文件描述符就绪，进而进行数据拷贝。例如，以<code>readfds</code>为例，在调用<code>select</code>接口之前，需要先设置需要关心读的文件描述符，调用完<code>select</code>接口之后，如果关心的文件描述符对应的比特位被置为1，就说明当前文件描述符有数据可读</p> <p>了解完所有参数后，接下来考虑<code>select</code>接口的返回值，<code>select</code>接口的返回值也有三种情况：</p> <ol> <li>存在文件描述符就绪：返回大于0的值，表示就绪的文件描述符个数</li> <li>等待失败：返回-1</li> <li>底层没有文件描述符的数据就绪：返回0</li> </ol> <p>下面创建基于<code>select</code>的TCP服务器为例，演示使用<code>select</code>接口实现多路转接：</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>本次利用到了在<a href=https://www.help-doc.top/Linux/26.%20%E5%BA%94%E7%94%A8%E5%B1%82%E5%8D%8F%E8%AE%AEHTTP/1.%20%E4%BB%8B%E7%BB%8DHTTP%E5%8D%8F%E8%AE%AE%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84%E4%B8%8E%E5%9F%BA%E6%9C%AC%E5%AE%9E%E7%8E%B0HTTPServer/1.%20%E4%BB%8B%E7%BB%8DHTTP%E5%8D%8F%E8%AE%AE%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84%E4%B8%8E%E5%9F%BA%E6%9C%AC%E5%AE%9E%E7%8E%B0HTTPServer.html#_6>介绍HTTP协议基本结构与基本实现HTTPServer</a>时封装的<code>TcpSocket</code></p> </div> <p>首先创建一个<code>selectServer</code>类，这个类表示基于<code>select</code>的TCP服务器，所以少不了需要用到<code>TcpSocket</code>类对象，所以首先考虑<code>selectServer</code>中创建一个基类指针成员，并在构造函数的初始化列表中进行初始化，并在构造函数体中调用父类的<code>BaseSocket</code>中的<code>initSocket</code>接口执行创建、绑定和监听：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-18-1><span class=k>class</span><span class=w> </span><span class=nc>SelectServer</span>
</span><span id=__span-18-2><span class=p>{</span>
</span><span id=__span-18-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-18-4><span class=w>    </span><span class=n>SelectServer</span><span class=p>(</span><span class=kt>uint16_t</span><span class=w> </span><span class=n>port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>default_port</span><span class=p>)</span>
</span><span id=__span-18-5><span class=w>        </span><span class=o>:</span><span class=n>bs_</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>TcpSocket</span><span class=o>&gt;</span><span class=p>())</span>
</span><span id=__span-18-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-18-7><span class=w>        </span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>initSocket</span><span class=p>();</span>
</span><span id=__span-18-8><span class=w>    </span><span class=p>}</span>
</span><span id=__span-18-9><span class=k>private</span><span class=o>:</span>
</span><span id=__span-18-10><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>BaseSocket</span><span class=o>&gt;</span><span class=w> </span><span class=n>bs_</span><span class=p>;</span>
</span><span id=__span-18-11><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>接着，创建一个函数用于启动服务器。同样，为了更好得表示启动状态一个服务器对象防止重复启动，考虑加上一个成员变量<code>isRunning_</code>用于判断当前服务器是否正在运行：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-19-1><span class=k>class</span><span class=w> </span><span class=nc>SelectServer</span>
</span><span id=__span-19-2><span class=p>{</span>
</span><span id=__span-19-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-19-4><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-19-5>
</span><span id=__span-19-6><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>startServer</span><span class=p>()</span>
</span><span id=__span-19-7><span class=w>    </span><span class=p>{</span>
</span><span id=__span-19-8><span class=w>        </span><span class=n>isRunning_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-19-9><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>isRunning_</span><span class=p>)</span>
</span><span id=__span-19-10><span class=w>        </span><span class=p>{</span>
</span><span id=__span-19-11>
</span><span id=__span-19-12><span class=w>        </span><span class=p>}</span>
</span><span id=__span-19-13><span class=w>        </span><span class=n>isRunning_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-19-14><span class=w>    </span><span class=p>}</span>
</span><span id=__span-19-15><span class=k>private</span><span class=o>:</span>
</span><span id=__span-19-16><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-19-17><span class=w>    </span><span class=kt>bool</span><span class=w> </span><span class=n>isRunning_</span><span class=p>;</span>
</span><span id=__span-19-18><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>按照之前的逻辑，下一步就需要开始接收客户端连接，即调用<code>TcpSocket</code>中的<code>toAccept</code>接口，通过<code>toAccept</code>接口的返回值判断是否可以开始读取客户端发送的内容。但是，<code>toAccept</code>接口中的<code>accept</code>默认是阻塞式等待，这就导致当前进程只能处理一个客户端的请求，所以在之前使用的就是多线程（或者子进程）的方式来解决这个问题</p> <p>但是，不需要创建多线程或者子进程，只需要使用<code>select</code>接口即可完成。具体思路如下：</p> <p>因为在TCP中，服务端和客户端想要建立连接必须进行三次握手，也就是说，客户端肯定会给服务端发送建立连接的请求，此时的服务端就需要读取对应的请求信息，所以对于监听套接字描述符<code>_listen_socketfd</code>来说，需要关注的就是这个套接字上的读事件，所以在<code>select</code>接口中需要将<code>_listen_socketfd</code>添加到<code>readfds</code>中，并且在<code>select</code>接口返回时，判断<code>_listen_socketfd</code>对应的比特位是否为1，如果为1，就说明有客户端连接请求</p> <p>根据上面的思路，首先需要再<code>TcpSocket</code>中提供一个获取<code>_listen_socketfd</code>的方法，同样，为了保证模版的灵活性，这个方法需要先在父类<code>BaseSocket</code>中进行声明，再在子类<code>TcpSocket</code>中进行定义：</p> <div class="tabbed-set tabbed-alternate" data-tabs=1:2><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><input id=__tabbed_1_2 name=__tabbed_1 type=radio><div class=tabbed-labels><label for=__tabbed_1_1><code>BaseSocket</code>类</label><label for=__tabbed_1_2><code>TcpSocket</code>类</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-20-1><span class=k>class</span><span class=w> </span><span class=nc>BaseSocket</span>
</span><span id=__span-20-2><span class=p>{</span>
</span><span id=__span-20-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-20-4><span class=w>    </span><span class=c1>//...</span>
</span><span id=__span-20-5>
</span><span id=__span-20-6><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>getListenSocketFd</span><span class=p>()</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-20-7><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-21-1><span class=k>class</span><span class=w> </span><span class=nc>TcpSocket</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>BaseSocket</span>
</span><span id=__span-21-2><span class=p>{</span>
</span><span id=__span-21-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-21-4><span class=w>    </span><span class=c1>//...</span>
</span><span id=__span-21-5>
</span><span id=__span-21-6><span class=w>    </span><span class=c1>// 获取监听套接字</span>
</span><span id=__span-21-7><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>getListenSocketFd</span><span class=p>()</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-21-8><span class=w>    </span><span class=p>{</span>
</span><span id=__span-21-9><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>_listen_socketfd</span><span class=p>;</span>
</span><span id=__span-21-10><span class=w>    </span><span class=p>}</span><span class=w>   </span>
</span><span id=__span-21-11><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>接着，在<code>selectServer</code>中实现<code>startServer</code>函数，先以阻塞版本的<code>select</code>为例：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-22-1><span class=kt>void</span><span class=w> </span><span class=nf>startServer</span><span class=p>()</span>
</span><span id=__span-22-2><span class=p>{</span>
</span><span id=__span-22-3><span class=w>    </span><span class=n>isRunning_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-22-4><span class=w>    </span><span class=n>fd_set</span><span class=w> </span><span class=n>rfds</span><span class=p>;</span>
</span><span id=__span-22-5><span class=w>    </span><span class=c1>// 清空读文件描述符集</span>
</span><span id=__span-22-6><span class=w>    </span><span class=n>FD_ZERO</span><span class=p>(</span><span class=o>&amp;</span><span class=n>rfds</span><span class=p>);</span>
</span><span id=__span-22-7><span class=w>    </span><span class=c1>// 设置监听套接字到读文件描述符集中</span>
</span><span id=__span-22-8><span class=w>    </span><span class=n>FD_SET</span><span class=p>(</span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>getListenSocketFd</span><span class=p>(),</span><span class=w> </span><span class=o>&amp;</span><span class=n>rfds</span><span class=p>);</span>
</span><span id=__span-22-9><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>isRunning_</span><span class=p>)</span>
</span><span id=__span-22-10><span class=w>    </span><span class=p>{</span>
</span><span id=__span-22-11><span class=w>        </span><span class=c1>// 交给select等待</span>
</span><span id=__span-22-12><span class=w>        </span><span class=c1>// 当前只有一个监听套接字，所以nfds即为监听套接字+1</span>
</span><span id=__span-22-13><span class=w>        </span><span class=c1>// 只关心读事件的文件描述符集</span>
</span><span id=__span-22-14><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>select</span><span class=p>(</span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>getListenSocketFd</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>rfds</span><span class=p>,</span><span class=w> </span><span class=k>nullptr</span><span class=p>,</span><span class=w> </span><span class=k>nullptr</span><span class=p>,</span><span class=w> </span><span class=k>nullptr</span><span class=p>);</span>
</span><span id=__span-22-15><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-22-16><span class=w>        </span><span class=p>{</span>
</span><span id=__span-22-17><span class=w>            </span><span class=c1>// 监听套接字文件描述符准备完毕</span>
</span><span id=__span-22-18><span class=w>        </span><span class=p>}</span>
</span><span id=__span-22-19><span class=w>    </span><span class=p>}</span>
</span><span id=__span-22-20><span class=w>    </span><span class=n>isRunning_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-22-21><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>一旦进入<code>n &gt; 0</code>的逻辑，此时就可以启动<code>toAccept</code>接口进行客户端连接了，封装为一个函数处理这段逻辑：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-23-1><span class=kt>void</span><span class=w> </span><span class=nf>handler</span><span class=p>(</span><span class=n>fd_set</span><span class=o>&amp;</span><span class=w> </span><span class=n>rfds</span><span class=p>)</span>
</span><span id=__span-23-2><span class=p>{</span>
</span><span id=__span-23-3><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>FD_ISSET</span><span class=p>(</span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>getListenSocketFd</span><span class=p>(),</span><span class=w> </span><span class=o>&amp;</span><span class=n>rfds</span><span class=p>))</span>
</span><span id=__span-23-4><span class=w>    </span><span class=p>{</span>
</span><span id=__span-23-5><span class=w>        </span><span class=c1>// 存在即可开始获取</span>
</span><span id=__span-23-6><span class=w>        </span><span class=n>SockAddrIn</span><span class=w> </span><span class=n>client</span><span class=p>;</span>
</span><span id=__span-23-7><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>ac_socketfd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>toAccept</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>addressof</span><span class=p>(</span><span class=n>client</span><span class=p>));</span>
</span><span id=__span-23-8><span class=w>    </span><span class=p>}</span>
</span><span id=__span-23-9><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>为了验证是否可以获取到客户端，可以在<code>handler</code>函数中打印客户端的IP和端口：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-24-1><span class=kt>void</span><span class=w> </span><span class=nf>handler</span><span class=p>(</span><span class=n>fd_set</span><span class=o>&amp;</span><span class=w> </span><span class=n>rfds</span><span class=p>)</span>
</span><span id=__span-24-2><span class=p>{</span>
</span><span id=__span-24-3><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>FD_ISSET</span><span class=p>(</span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>getListenSocketFd</span><span class=p>(),</span><span class=w> </span><span class=o>&amp;</span><span class=n>rfds</span><span class=p>))</span>
</span><span id=__span-24-4><span class=w>    </span><span class=p>{</span>
</span><span id=__span-24-5><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-24-6>
</span><span id=__span-24-7><span class=w>        </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>DEBUG</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;当前接收到了客户端：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>client</span><span class=p>.</span><span class=n>getIp</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;:&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>client</span><span class=p>.</span><span class=n>getPort</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;文件描述符为：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>ac_socketfd</span><span class=p>;</span>
</span><span id=__span-24-8><span class=w>    </span><span class=p>}</span>
</span><span id=__span-24-9><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>编译运行上面的代码，就可以看到不论是多个客户端还是一个客户端，都可以正常获取到每一个客户端建立连接时的IP和端口</p> <p>但是，如果此时将<code>select</code>改为非阻塞版本，就会发现没有客户端可以正常连接上服务器：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-25-1><span class=kt>void</span><span class=w> </span><span class=nf>startServer</span><span class=p>()</span>
</span><span id=__span-25-2><span class=p>{</span>
</span><span id=__span-25-3><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-25-4><span class=w>    </span><span class=c1>// 非阻塞</span>
</span><span id=__span-25-5><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>timeval</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>};</span>
</span><span id=__span-25-6><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>isRunning_</span><span class=p>)</span>
</span><span id=__span-25-7><span class=w>    </span><span class=p>{</span>
</span><span id=__span-25-8><span class=w>        </span><span class=c1>// 交给select等待</span>
</span><span id=__span-25-9><span class=w>        </span><span class=c1>// 当前只有一个监听套接字，所以nfds即为监听套接字+1</span>
</span><span id=__span-25-10><span class=w>        </span><span class=c1>// 只关心读事件的文件描述符集</span>
</span><span id=__span-25-11><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>select</span><span class=p>(</span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>getListenSocketFd</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>rfds</span><span class=p>,</span><span class=w> </span><span class=k>nullptr</span><span class=p>,</span><span class=w> </span><span class=k>nullptr</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>t</span><span class=p>);</span>
</span><span id=__span-25-12><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-25-13><span class=w>    </span><span class=p>}</span>
</span><span id=__span-25-14><span class=w>    </span><span class=n>isRunning_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-25-15><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>根据前面的对<code>select</code>返回值的分析，如果返回值为0，就说明没有一个文件描述符有数据就绪，基于这个原理，修改代码如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-26-1><span class=kt>void</span><span class=w> </span><span class=nf>startServer</span><span class=p>()</span>
</span><span id=__span-26-2><span class=p>{</span>
</span><span id=__span-26-3><span class=w>    </span><span class=c1>//...</span>
</span><span id=__span-26-4><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>isRunning_</span><span class=p>)</span>
</span><span id=__span-26-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-26-6><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-26-7><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-26-8><span class=w>        </span><span class=p>{</span>
</span><span id=__span-26-9><span class=w>            </span><span class=c1>// 监听套接字文件描述符准备完毕</span>
</span><span id=__span-26-10><span class=w>            </span><span class=n>handler</span><span class=p>(</span><span class=n>rfds</span><span class=p>);</span>
</span><span id=__span-26-11><span class=w>        </span><span class=p>}</span>
</span><span id=__span-26-12><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-26-13><span class=w>        </span><span class=p>{</span>
</span><span id=__span-26-14><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;没有客户端连接&quot;</span><span class=p>;</span>
</span><span id=__span-26-15><span class=w>        </span><span class=p>}</span>
</span><span id=__span-26-16><span class=w>    </span><span class=p>}</span>
</span><span id=__span-26-17><span class=w>    </span><span class=n>isRunning_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-26-18><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>再次运行上面的代码，会发现控制台持续在打印<code>没有客户端连接</code>，出现这个问题的本质原因就是<code>select</code>是非阻塞的。但是为什么会出现有客户端发起连接，但是<code>select</code>却没有进入数据就绪的逻辑？下面具体分析上面代码存在的问题：</p> <p>在<code>startServer</code>中，首先设置了对应的<code>_listen_socketfd</code>，这符合前面提到的逻辑。但是在<code>while</code>循环中，因为<code>select</code>的第二个参数是输入、输出型参数，所以在执行<code>select</code>时首先是将设置好<code>_listen_socketfd</code>交给<code>select</code>让其知道需要关心这个文件描述符。因为是非阻塞版本，所以一旦进入<code>select</code>，该函数会发现一开始并没有任何客户端连接，从而会立即返回并且<strong>修改提供给<code>select</code>的关心读的文件描述符集<code>rfds</code></strong>，这也就意味着，一旦启动服务器，<code>select</code>就会将已有的<code>rfds</code>修改为全0并且返回0，这就导致两种情况：</p> <ol> <li>返回值为0，一直进入<code>n == 0</code>的逻辑</li> <li><code>rfds</code>被修改为全0，之后的循环中交给<code>select</code>的<code>rfds</code>一直都是全0，导致始终返回0</li> </ol> <p>最后，尽管有客户端连接，但是因为<code>select</code>不再监听任何文件描述符，所以永远不会执行<code>handler</code>函数，也就无法获取到客户端的连接信息</p> <p>解决这个问题的方法就是将清空关心读的文件描述符逻辑和设置<code>_listen_socketfd</code>到关心读的文件描述符集逻辑全都放到<code>while</code>循环中，这样就可以保证每次<code>select</code>都能监听到<code>_listen_socketfd</code>对应的文件描述符，从而保证可以获取到客户端的连接信息。修改代码如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-27-1><span class=kt>void</span><span class=w> </span><span class=nf>startServer</span><span class=p>()</span>
</span><span id=__span-27-2><span class=p>{</span>
</span><span id=__span-27-3><span class=w>    </span><span class=n>isRunning_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-27-4><span class=w>    </span><span class=n>fd_set</span><span class=w> </span><span class=n>rfds</span><span class=p>;</span>
</span><span id=__span-27-5><span class=w>    </span><span class=c1>// 非阻塞</span>
</span><span id=__span-27-6><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>timeval</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>};</span>
</span><span id=__span-27-7><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>isRunning_</span><span class=p>)</span>
</span><span id=__span-27-8><span class=w>    </span><span class=p>{</span>
</span><span id=__span-27-9><span class=w>        </span><span class=c1>// 清空读文件描述符集</span>
</span><span id=__span-27-10><span class=w>        </span><span class=n>FD_ZERO</span><span class=p>(</span><span class=o>&amp;</span><span class=n>rfds</span><span class=p>);</span>
</span><span id=__span-27-11><span class=w>        </span><span class=c1>// 设置监听套接字到读文件描述符集中</span>
</span><span id=__span-27-12><span class=w>        </span><span class=n>FD_SET</span><span class=p>(</span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>getListenSocketFd</span><span class=p>(),</span><span class=w> </span><span class=o>&amp;</span><span class=n>rfds</span><span class=p>);</span>
</span><span id=__span-27-13><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-27-14><span class=w>    </span><span class=p>}</span>
</span><span id=__span-27-15><span class=w>    </span><span class=n>isRunning_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-27-16><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>但是现在还有一个问题，在当前代码中，除了<code>select</code>的第二个参数是输入、输出型参数外，最后一个参数也是输入、输出型参数，那么是否也需要将设置<code>timeval</code>的逻辑放到<code>while</code>循环中呢？<strong>理论上是需要的</strong>，但是此处可以不需要，因为根据<code>select</code>处理<code>timeval</code>的逻辑，进入<code>select</code>后，如果在设定的超时时间内关心的文件描述符集中没有文件描述符就绪，就会返回将<code>timeval</code>中每个字段设置为0的结构体对象，此时下一次设置时<code>t</code>对象中的值依旧是<code>{0, 0}</code>。但是，尽管如此，还是更建议将设置超时时间的逻辑放到<code>while</code>循环中。修改代码如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-28-1><span class=kt>void</span><span class=w> </span><span class=nf>startServer</span><span class=p>()</span>
</span><span id=__span-28-2><span class=p>{</span>
</span><span id=__span-28-3><span class=w>    </span><span class=n>isRunning_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-28-4><span class=w>    </span><span class=n>fd_set</span><span class=w> </span><span class=n>rfds</span><span class=p>;</span>
</span><span id=__span-28-5><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>isRunning_</span><span class=p>)</span>
</span><span id=__span-28-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-28-7><span class=w>        </span><span class=c1>// 清空读文件描述符集</span>
</span><span id=__span-28-8><span class=w>        </span><span class=n>FD_ZERO</span><span class=p>(</span><span class=o>&amp;</span><span class=n>rfds</span><span class=p>);</span>
</span><span id=__span-28-9><span class=w>        </span><span class=c1>// 设置监听套接字到读文件描述符集中</span>
</span><span id=__span-28-10><span class=w>        </span><span class=n>FD_SET</span><span class=p>(</span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>getListenSocketFd</span><span class=p>(),</span><span class=w> </span><span class=o>&amp;</span><span class=n>rfds</span><span class=p>);</span>
</span><span id=__span-28-11><span class=w>        </span><span class=c1>// 非阻塞</span>
</span><span id=__span-28-12><span class=w>        </span><span class=k>struct</span><span class=w> </span><span class=nc>timeval</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>};</span>
</span><span id=__span-28-13><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-28-14><span class=w>    </span><span class=p>}</span>
</span><span id=__span-28-15><span class=w>    </span><span class=n>isRunning_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-28-16><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>为了更好得显示出打印信息，考虑在<code>n == 0</code>的逻辑添加一个<code>sleep(1)</code>减少打印的频率，再次运行代码，就可以看到客户端连接成功，并且服务器会打印出客户端的IP和端口信息</p> <p>既然完成了客户端和服务端的连接，接下来是否可以考虑在<code>toAccept</code>的逻辑之后直接接收信息呢？<strong>不可以</strong>，因为<code>recvData</code>函数中的<code>recv</code>接口默认也是阻塞式的，如果直接接收信息，依旧会出现服务端卡在接收的位置。解决这个问题的方法同样需要借助<code>select</code>，下面思考具体的思路：</p> <p>因为客户端读取本质还是访问对应的文件描述符，所以让<code>select</code>除了关心<code>_listen_socketfd</code>以外，还需要关心获取到的<code>ac_socketfd</code>。但是现在出现了第二个问题，如何将<code>ac_socketfd</code>添加到<code>select</code>中呢？<strong>借助一个辅助数组</strong>，这个辅助数组的作用就是存储有效的且同类的所有文件描述符，例如以关心读为例，当前辅助数组中就需要存储所有关心读的文件描述符。基于这个思路，首先需要在<code>SelectServer</code>类中添加一个成员变量<code>fds_</code>，这个成员变量就是辅助数组。此处考虑使用定长数组，这个数组的长度就设置为<code>fd_set</code>可以表示的所有文件描述符个数，并且在构造函数中将该数组全部初始化为-1：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-29-1><span class=c1>// 定长数组大小</span>
</span><span id=__span-29-2><span class=k>constexpr</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>g_fd_array_num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>fd_set</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>8</span><span class=p>;</span>
</span><span id=__span-29-3>
</span><span id=__span-29-4><span class=k>class</span><span class=w> </span><span class=nc>SelectServer</span>
</span><span id=__span-29-5><span class=p>{</span>
</span><span id=__span-29-6><span class=k>public</span><span class=o>:</span>
</span><span id=__span-29-7><span class=w>    </span><span class=n>SelectServer</span><span class=p>(</span><span class=kt>uint16_t</span><span class=w> </span><span class=n>port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>default_port</span><span class=p>)</span>
</span><span id=__span-29-8><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=cm>/* ... */</span>
</span><span id=__span-29-9><span class=w>        </span><span class=p>,</span><span class=w> </span><span class=n>fd_array_</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=kt>int</span><span class=p>,</span><span class=w> </span><span class=n>g_fd_array_num</span><span class=o>&gt;&gt;</span><span class=p>())</span>
</span><span id=__span-29-10><span class=w>    </span><span class=p>{</span>
</span><span id=__span-29-11><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-29-12><span class=w>        </span><span class=c1>// 数组元素全部初始化为-1</span>
</span><span id=__span-29-13><span class=w>        </span><span class=n>fd_array_</span><span class=o>-&gt;</span><span class=n>fill</span><span class=p>(</span><span class=mi>-1</span><span class=p>);</span>
</span><span id=__span-29-14><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-15>
</span><span id=__span-29-16><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-29-17>
</span><span id=__span-29-18><span class=k>private</span><span class=o>:</span>
</span><span id=__span-29-19><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-29-20><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=kt>int</span><span class=p>,</span><span class=w> </span><span class=n>g_fd_array_num</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>fd_array_</span><span class=p>;</span>
</span><span id=__span-29-21><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-29-22><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>接着，因为要确保<code>_listen_socketfd</code>可以成功添加到<code>select</code>中，所以在构造中单独设定第一个元素为<code>_listen_socketfd</code>：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-30-1><span class=n>SelectServer</span><span class=p>(</span><span class=kt>uint16_t</span><span class=w> </span><span class=n>port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>default_port</span><span class=p>)</span>
</span><span id=__span-30-2><span class=w>    </span><span class=o>:</span><span class=w> </span><span class=cm>/* ... */</span>
</span><span id=__span-30-3><span class=w>    </span><span class=p>,</span><span class=w> </span><span class=n>fd_array_</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=kt>int</span><span class=p>,</span><span class=w> </span><span class=n>g_fd_array_num</span><span class=o>&gt;&gt;</span><span class=p>())</span>
</span><span id=__span-30-4><span class=p>{</span>
</span><span id=__span-30-5><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-30-6>
</span><span id=__span-30-7><span class=w>    </span><span class=c1>// 固定第一个元素为监听套接字</span>
</span><span id=__span-30-8><span class=w>    </span><span class=p>(</span><span class=o>*</span><span class=n>fd_array_</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>getListenSocketFd</span><span class=p>();</span>
</span><span id=__span-30-9><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>接着，为了将<code>fd_array_</code>中的文件描述符添加到<code>select</code>中，在每一次<code>select</code>之前，都需要遍历<code>fd_array_</code>，将其中不为-1的文件描述符添加到<code>select</code>中，并且为了设置<code>select</code>的第一个参数，需要获取到当前数组的最大值，修改<code>startServer</code>函数如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-31-1><span class=kt>void</span><span class=w> </span><span class=nf>startServer</span><span class=p>()</span>
</span><span id=__span-31-2><span class=p>{</span>
</span><span id=__span-31-3><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-31-4><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>isRunning_</span><span class=p>)</span>
</span><span id=__span-31-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-31-6><span class=w>        </span><span class=c1>// 清空读文件描述符集</span>
</span><span id=__span-31-7><span class=w>        </span><span class=n>FD_ZERO</span><span class=p>(</span><span class=o>&amp;</span><span class=n>rfds</span><span class=p>);</span>
</span><span id=__span-31-8><span class=w>        </span><span class=c1>// 设置监听套接字到读文件描述符集中</span>
</span><span id=__span-31-9><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>fd</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=o>*</span><span class=n>fd_array_</span><span class=p>)</span>
</span><span id=__span-31-10><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>fd</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>-1</span><span class=p>)</span>
</span><span id=__span-31-11><span class=w>                </span><span class=n>FD_SET</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>rfds</span><span class=p>);</span>
</span><span id=__span-31-12>
</span><span id=__span-31-13><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>maxVal</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-31-14><span class=w>        </span><span class=k>auto</span><span class=w> </span><span class=n>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>max_element</span><span class=p>(</span><span class=n>fd_array_</span><span class=o>-&gt;</span><span class=n>begin</span><span class=p>(),</span><span class=w> </span><span class=n>fd_array_</span><span class=o>-&gt;</span><span class=n>end</span><span class=p>());</span>
</span><span id=__span-31-15><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>pos</span><span class=p>)</span>
</span><span id=__span-31-16><span class=w>            </span><span class=n>maxVal</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>*</span><span class=n>pos</span><span class=p>;</span>
</span><span id=__span-31-17>
</span><span id=__span-31-18><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-31-19>
</span><span id=__span-31-20><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>select</span><span class=p>(</span><span class=n>maxVal</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>rfds</span><span class=p>,</span><span class=w> </span><span class=k>nullptr</span><span class=p>,</span><span class=w> </span><span class=k>nullptr</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>t</span><span class=p>);</span>
</span><span id=__span-31-21><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-31-22><span class=w>    </span><span class=p>}</span>
</span><span id=__span-31-23><span class=w>    </span><span class=n>isRunning_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-31-24><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>接着，为了保证<code>select</code>可以正常接收到后续的<code>ac_socketfd</code>，需要在<code>handler</code>函数中判断监听套接字存在于<code>rfds</code>的分支中将获取到的<code>ac_socketfd</code>添加到辅助数组中，对应的代码如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-32-1><span class=kt>void</span><span class=w> </span><span class=nf>handler</span><span class=p>(</span><span class=n>fd_set</span><span class=o>&amp;</span><span class=w> </span><span class=n>rfds</span><span class=p>)</span>
</span><span id=__span-32-2><span class=p>{</span>
</span><span id=__span-32-3><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>FD_ISSET</span><span class=p>(</span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>getListenSocketFd</span><span class=p>(),</span><span class=w> </span><span class=o>&amp;</span><span class=n>rfds</span><span class=p>))</span>
</span><span id=__span-32-4><span class=w>    </span><span class=p>{</span>
</span><span id=__span-32-5><span class=w>        </span><span class=c1>// 存在即可开始获取</span>
</span><span id=__span-32-6><span class=w>        </span><span class=n>SockAddrIn</span><span class=w> </span><span class=n>client</span><span class=p>;</span>
</span><span id=__span-32-7><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>ac_socketfd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>toAccept</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>addressof</span><span class=p>(</span><span class=n>client</span><span class=p>));</span>
</span><span id=__span-32-8>
</span><span id=__span-32-9><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-32-10>
</span><span id=__span-32-11><span class=w>        </span><span class=c1>// 将获取到的新ac_socketfd添加到辅助数组</span>
</span><span id=__span-32-12><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>f</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=o>*</span><span class=n>fd_array_</span><span class=p>)</span>
</span><span id=__span-32-13><span class=w>        </span><span class=p>{</span>
</span><span id=__span-32-14><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>f</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>-1</span><span class=p>)</span>
</span><span id=__span-32-15><span class=w>            </span><span class=p>{</span>
</span><span id=__span-32-16><span class=w>                </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ac_socketfd</span><span class=p>;</span>
</span><span id=__span-32-17><span class=w>                </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-32-18><span class=w>            </span><span class=p>}</span>
</span><span id=__span-32-19><span class=w>        </span><span class=p>}</span>
</span><span id=__span-32-20><span class=w>    </span><span class=p>}</span>
</span><span id=__span-32-21><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>添加完之后，下一次<code>startServer</code>的<code>while</code>循环逻辑中就会添加新的<code>ac_socketfd</code>到关心读的文件描述符表中从而被<code>select</code>关心</p> <p>完成上面的逻辑后，服务器就可以考虑处理读取客户端发送的信息。此时在<code>handler</code>函数中因为当前<code>rfds</code>中不只有监听套接字<code>_listen_socketfd</code>，所以需要接着判断：如果当前辅助数组中的元素为不为-1，说明当前获取到一个有效的文件描述符，此时需要判断是否是监听套接字，如果是就执行连接客户端的逻辑，否则就是读写的逻辑。但是只获取到辅助数组中的文件描述符还不够，因为还需要判断当前文件描述符是的确准备好数据的，即判断指定套接字在<code>rfds</code>中标记位是否为1。修改代码如下：</p> <div class="tabbed-set tabbed-alternate" data-tabs=2:2><input checked=checked id=__tabbed_2_1 name=__tabbed_2 type=radio><input id=__tabbed_2_2 name=__tabbed_2 type=radio><div class=tabbed-labels><label for=__tabbed_2_1><code>handler</code>函数</label><label for=__tabbed_2_2><code>recvData</code>函数</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-33-1><span class=kt>void</span><span class=w> </span><span class=nf>handler</span><span class=p>(</span><span class=n>fd_set</span><span class=w> </span><span class=o>&amp;</span><span class=n>rfds</span><span class=p>)</span>
</span><span id=__span-33-2><span class=p>{</span>
</span><span id=__span-33-3><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>fd</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=o>*</span><span class=n>fd_array_</span><span class=p>)</span>
</span><span id=__span-33-4><span class=w>    </span><span class=p>{</span>
</span><span id=__span-33-5><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>fd</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>-1</span><span class=p>)</span>
</span><span id=__span-33-6><span class=w>        </span><span class=p>{</span>
</span><span id=__span-33-7><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>fd</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>getListenSocketFd</span><span class=p>())</span>
</span><span id=__span-33-8><span class=w>            </span><span class=p>{</span>
</span><span id=__span-33-9><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>FD_ISSET</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>rfds</span><span class=p>))</span>
</span><span id=__span-33-10><span class=w>                </span><span class=p>{</span>
</span><span id=__span-33-11><span class=w>                    </span><span class=c1>// 存在即可开始获取</span>
</span><span id=__span-33-12><span class=w>                    </span><span class=n>SockAddrIn</span><span class=w> </span><span class=n>client</span><span class=p>;</span>
</span><span id=__span-33-13><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>ac_socketfd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>toAccept</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>addressof</span><span class=p>(</span><span class=n>client</span><span class=p>));</span>
</span><span id=__span-33-14>
</span><span id=__span-33-15><span class=w>                    </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>DEBUG</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;当前接收到了客户端：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>client</span><span class=p>.</span><span class=n>getIp</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;:&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>client</span><span class=p>.</span><span class=n>getPort</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;文件描述符为：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>ac_socketfd</span><span class=p>;</span>
</span><span id=__span-33-16>
</span><span id=__span-33-17><span class=w>                    </span><span class=c1>// 将获取到的新ac_socketfd添加到辅助数组</span>
</span><span id=__span-33-18><span class=w>                    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>f</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=o>*</span><span class=n>fd_array_</span><span class=p>)</span>
</span><span id=__span-33-19><span class=w>                    </span><span class=p>{</span>
</span><span id=__span-33-20><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>f</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>-1</span><span class=p>)</span>
</span><span id=__span-33-21><span class=w>                        </span><span class=p>{</span>
</span><span id=__span-33-22><span class=w>                            </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ac_socketfd</span><span class=p>;</span>
</span><span id=__span-33-23><span class=w>                            </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-33-24><span class=w>                        </span><span class=p>}</span>
</span><span id=__span-33-25><span class=w>                    </span><span class=p>}</span>
</span><span id=__span-33-26><span class=w>                </span><span class=p>}</span>
</span><span id=__span-33-27><span class=w>            </span><span class=p>}</span>
</span><span id=__span-33-28><span class=w>            </span><span class=k>else</span><span class=w> </span>
</span><span id=__span-33-29><span class=w>            </span><span class=p>{</span>
</span><span id=__span-33-30><span class=w>                </span><span class=k>if</span><span class=p>(</span><span class=n>FD_ISSET</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>rfds</span><span class=p>))</span>
</span><span id=__span-33-31><span class=w>                </span><span class=p>{</span>
</span><span id=__span-33-32><span class=w>                    </span><span class=c1>// 说明是用于读取的套接字</span>
</span><span id=__span-33-33><span class=w>                    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>buffer</span><span class=p>;</span>
</span><span id=__span-33-34><span class=w>                    </span><span class=kt>ssize_t</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>recvData</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=n>fd</span><span class=p>);</span>
</span><span id=__span-33-35>
</span><span id=__span-33-36><span class=w>                    </span><span class=k>if</span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-33-37><span class=w>                        </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;客户端发送了：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>buffer</span><span class=p>;</span>
</span><span id=__span-33-38><span class=w>                    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-33-39><span class=w>                    </span><span class=p>{</span>
</span><span id=__span-33-40><span class=w>                        </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;客户端退出&quot;</span><span class=p>;</span>
</span><span id=__span-33-41><span class=w>                        </span><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-33-42><span class=w>                    </span><span class=p>}</span>
</span><span id=__span-33-43><span class=w>                    </span><span class=k>else</span>
</span><span id=__span-33-44><span class=w>                    </span><span class=p>{</span>
</span><span id=__span-33-45><span class=w>                        </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;错误&quot;</span><span class=p>;</span>
</span><span id=__span-33-46><span class=w>                        </span><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-33-47><span class=w>                    </span><span class=p>}</span>
</span><span id=__span-33-48><span class=w>                </span><span class=p>}</span>
</span><span id=__span-33-49><span class=w>            </span><span class=p>}</span>
</span><span id=__span-33-50><span class=w>        </span><span class=p>}</span>
</span><span id=__span-33-51><span class=w>    </span><span class=p>}</span>
</span><span id=__span-33-52><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-34-1><span class=c1>// 接收数据</span>
</span><span id=__span-34-2><span class=kt>ssize_t</span><span class=w> </span><span class=nf>recvData</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>out_data</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>ac_socketfd</span><span class=p>)</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-34-3><span class=p>{</span>
</span><span id=__span-34-4><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>buffer</span><span class=p>[</span><span class=mi>4096</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span><span id=__span-34-5><span class=w>    </span><span class=kt>ssize_t</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>recv</span><span class=p>(</span><span class=n>ac_socketfd</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>buffer</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-34-6><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-34-7><span class=w>        </span><span class=n>out_data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buffer</span><span class=p>;</span>
</span><span id=__span-34-8><span class=w>    </span><span class=k>else</span>
</span><span id=__span-34-9><span class=w>        </span><span class=n>close</span><span class=p>(</span><span class=n>ac_socketfd</span><span class=p>);</span>
</span><span id=__span-34-10>
</span><span id=__span-34-11><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>ret</span><span class=p>;</span>
</span><span id=__span-34-12><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>此时的<code>recvData</code>接口一定不会阻塞，因为只有内核准备好了数据，<code>select</code>才会返回大于0的值，此时要么是<code>_listen_socketfd</code>，要么就是<code>ac_socketfd</code>，同样<code>toAccept</code>接口也不会被阻塞</p> <p>编译运行上面的代码即可发现服务端可以正常收到多个客户端发送的消息</p> <p>至此就完成了使用<code>select</code>的多路转接模式</p> <h2 id=select_1><code>select</code>的缺陷<a class=headerlink href=#select_1 title="Permanent link">&para;</a></h2> <h2 id=select_2>Select多路转接的优缺点<a class=headerlink href=#select_2 title="Permanent link">&para;</a></h2> <p>通过上面的实现，可以看出<code>select</code>多路转接的优点：</p> <ol> <li>跨平台：<code>select</code>接口在各种操作系统上都有实现，包括Windows、Linux、macOS等</li> <li>简单易用：相比于其他IO模型，<code>select</code>的使用相对简单</li> <li>可以同时监听多个文件描述符，提高了IO效率</li> </ol> <p>但是<code>select</code>也存在一些缺点：</p> <ol> <li>文件描述符数量限制：<code>select</code>能够监听的文件描述符数量有限，无法处理大量文件描述符的情况</li> <li>性能问题：每次调用<code>select</code>都需要将文件描述符集从用户态拷贝到内核态，当文件描述符数量较多时，这个开销会比较大</li> <li>遍历开销：<code>select</code>返回后，需要遍历所有文件描述符来找出就绪的文件描述符，时间复杂度为<span class=arithmatex>\(O(N)\)</span></li> </ol> <h2 id=poll><code>poll</code>实现多路转接<a class=headerlink href=#poll title="Permanent link">&para;</a></h2> <p>上面已经详细介绍了如何使用<code>select</code>实现多路转接从而保证只有一个进程的TCP服务器可以接收来自多个客户端的请求。但是从上面的缺点来看<code>select</code>还是非常明显的，尤其是下面的两个问题：</p> <ol> <li><code>select</code>中设置需要关心的文件描述符集的参数以及时间都是输入输出参数，导致需要在每一次循环中都要重复设置</li> <li><code>select</code>可以关心的文件描述符集的大小是有限的，而且大小无法由程序员在代码中指定</li> </ol> <p>基于这两个问题，下面讨论<code>poll</code>的解决方案</p> <p>在Linux中，除了可以使用<code>select</code>实现多路转接外，还可以通过<code>poll</code>接口实现多路转接，其原型如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-35-1><span class=kt>int</span><span class=w> </span><span class=nf>poll</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>pollfd</span><span class=w> </span><span class=o>*</span><span class=n>fds</span><span class=p>,</span><span class=w> </span><span class=kt>nfds_t</span><span class=w> </span><span class=n>nfds</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>timeout</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>这个接口一共三个参数。首先介绍最后一个参数，与<code>select</code>类似，<code>poll</code>也可以决定是否需要时阻塞式等待，但是<code>timeout</code>此时并不是<code>struct timeval</code>结构体类型，所以其表示方式有所不同：</p> <ol> <li><code>timeout</code>值大于0，代表最大超时时间，单位为毫秒</li> <li><code>timeout</code>值等于0，代表非阻塞式</li> <li><code>timeout</code>值小于0，代表阻塞式等待</li> </ol> <p>接着看剩下的两个参数，其中第一个参数表示元素为<code>struct pollfd</code>类型的数组，因为在C语言里，数组并不会以完整拷贝的方式传递给函数，而是只传递数组首元素的地址，这也被称为<strong>数组退化（或衰减）为指针</strong>。基于这个原因，为了保证可以访问到元素为<code>struct pollfd</code>的数组，还需要第二个参数，表示当前数组中元素的个数。通过这两个参数，<code>poll</code>接口就可以实现关心多个文件描述符，而因为数组长度是由程序员自己指定的，所以就可以解决<code>select</code>的第二个问题</p> <p>既然<code>poll</code>可以关心多个文件描述符，那么如何关心每一个文件描述符的事件呢？这里就需要了解一下<code>struct pollfd</code>结构体的底层设计，其定义如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-36-1><span class=k>struct</span><span class=w> </span><span class=nc>pollfd</span><span class=w> </span>
</span><span id=__span-36-2><span class=p>{</span>
</span><span id=__span-36-3><span class=w>    </span><span class=kt>int</span><span class=w>   </span><span class=n>fd</span><span class=p>;</span><span class=w>         </span><span class=cm>/* file descriptor */</span>
</span><span id=__span-36-4><span class=w>    </span><span class=kt>short</span><span class=w> </span><span class=n>events</span><span class=p>;</span><span class=w>     </span><span class=cm>/* requested events */</span>
</span><span id=__span-36-5><span class=w>    </span><span class=kt>short</span><span class=w> </span><span class=n>revents</span><span class=p>;</span><span class=w>    </span><span class=cm>/* returned events */</span>
</span><span id=__span-36-6><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>其中，第一个字段表示需要关心的文件描述符，第二个字段表示对应文件描述符需要关心的事件类型，第三个字段表示关心的事件是否就绪。对于前两个字段来说，需要由程序员自己指定，而对于最后一个字段来说，由<code>poll</code>接口执行时填写，这就实现了关心事件和结果分离，即输入和输出分离，这一点就解决了<code>select</code>的第一个问题。那么如何表示具体要关心的事件呢？<code>events</code>和<code>revents</code>可以填写下面的值：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-37-1><span class=cp>#define POLLIN     0x001    </span><span class=cm>/* 有数据可读 */</span>
</span><span id=__span-37-2><span class=cp>#define POLLPRI    0x002    </span><span class=cm>/* 有紧急数据可读 */</span>
</span><span id=__span-37-3><span class=cp>#define POLLOUT    0x004    </span><span class=cm>/* 写数据不会导致阻塞 */</span>
</span><span id=__span-37-4><span class=cp>#define POLLERR    0x008    </span><span class=cm>/* 发生错误 */</span>
</span><span id=__span-37-5><span class=cp>#define POLLHUP    0x010    </span><span class=cm>/* 连接挂起 */</span>
</span><span id=__span-37-6><span class=cp>#define POLLNVAL   0x020    </span><span class=cm>/* 无效请求: fd未打开 */</span>
</span><span id=__span-37-7><span class=cp>#define POLLRDNORM 0x040    </span><span class=cm>/* 有普通数据可读 */</span>
</span><span id=__span-37-8><span class=cp>#define POLLRDBAND 0x080    </span><span class=cm>/* 有优先数据可读 */</span>
</span><span id=__span-37-9><span class=cp>#define POLLWRNORM 0x100    </span><span class=cm>/* 可写普通数据 */</span>
</span><span id=__span-37-10><span class=cp>#define POLLWRBAND 0x200    </span><span class=cm>/* 可写优先数据 */</span>
</span></code></pre></div></td></tr></table></div> <p>可以看到每一种事件类型都是一个宏值，这也就意味着，如果要设置对应的事件到<code>events</code>中，就需要通过位操作。所以实际上，<code>events</code>和<code>revents</code>也是位图。但是，与<code>select</code>不同的是，如果要设置<code>events</code>值需要程序员自己通过位操作来设置。对应的，要检测<code>revents</code>中的事件同样需要程序员自己来检测。虽然这两步都需要程序员自己做，但是实际上这两个步骤很简单：</p> <ol> <li>设置时，将<code>events</code>和需要设置的事件进行按位或<code>|</code>操作，可以进行多个按位或绑定多个事件</li> <li>检测时，将<code>revents</code>和需要检测的事件进行按位与<code>&amp;</code>操作，判断结果是否大于0</li> </ol> <p>介绍完<code>poll</code>接口的参数后，剩下的就是<code>poll</code>的返回值，<code>poll</code>的返回值和<code>select</code>基本一致：</p> <ol> <li>返回值大于0，代表有对应值个文件描述符就绪</li> <li>返回值等于0，代表没有任何一个文件描述符就绪，等待超时</li> <li>返回值小于0（-1），代表等待失败</li> </ol> <p>了解完<code>poll</code>接口后，下面基于<code>poll</code>接口改造前面的基于<code>select</code>的TCP服务器，因为改造思路相对简单，所以此处不过多介绍。本次为了演示，直接使用定长数组，实际上可以使用动态开辟数组空间实现，此处不具体实现该方案。代码修改如下：</p> <div class="tabbed-set tabbed-alternate" data-tabs=3:3><input checked=checked id=__tabbed_3_1 name=__tabbed_3 type=radio><input id=__tabbed_3_2 name=__tabbed_3 type=radio><input id=__tabbed_3_3 name=__tabbed_3 type=radio><div class=tabbed-labels><label for=__tabbed_3_1><code>pollServer</code>类和构造函数</label><label for=__tabbed_3_2><code>startServer</code>函数</label><label for=__tabbed_3_3><code>handler</code>函数</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-38-1><span class=c1>// struct pollfd数组大小</span>
</span><span id=__span-38-2><span class=k>const</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>g_fd_array_num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1024</span><span class=p>;</span>
</span><span id=__span-38-3>
</span><span id=__span-38-4><span class=k>class</span><span class=w> </span><span class=nc>pollServer</span>
</span><span id=__span-38-5><span class=p>{</span>
</span><span id=__span-38-6><span class=k>public</span><span class=o>:</span>
</span><span id=__span-38-7><span class=w>    </span><span class=n>pollServer</span><span class=p>(</span><span class=kt>uint16_t</span><span class=w> </span><span class=n>port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>default_port</span><span class=p>)</span>
</span><span id=__span-38-8><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=n>bs_</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>TcpSocket</span><span class=o>&gt;</span><span class=p>()),</span><span class=w> </span><span class=n>isRunning_</span><span class=p>(</span><span class=nb>false</span><span class=p>),</span><span class=w> </span><span class=n>fd_array_</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=k>struct</span><span class=w> </span><span class=nc>pollfd</span><span class=p>,</span><span class=w> </span><span class=n>g_fd_array_num</span><span class=o>&gt;&gt;</span><span class=p>())</span>
</span><span id=__span-38-9><span class=w>    </span><span class=p>{</span>
</span><span id=__span-38-10><span class=w>        </span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>initSocket</span><span class=p>();</span>
</span><span id=__span-38-11><span class=w>        </span><span class=c1>// fd全部初始化为-1</span>
</span><span id=__span-38-12><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>fd_array_</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>();</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-38-13><span class=w>        </span><span class=p>{</span>
</span><span id=__span-38-14><span class=w>            </span><span class=p>(</span><span class=o>*</span><span class=n>fd_array_</span><span class=p>)[</span><span class=n>i</span><span class=p>].</span><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-38-15><span class=w>            </span><span class=p>(</span><span class=o>*</span><span class=n>fd_array_</span><span class=p>)[</span><span class=n>i</span><span class=p>].</span><span class=n>events</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-38-16><span class=w>            </span><span class=p>(</span><span class=o>*</span><span class=n>fd_array_</span><span class=p>)[</span><span class=n>i</span><span class=p>].</span><span class=n>revents</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-38-17><span class=w>        </span><span class=p>}</span>
</span><span id=__span-38-18>
</span><span id=__span-38-19><span class=w>        </span><span class=c1>// 单独处理_listen_socketfd</span>
</span><span id=__span-38-20><span class=w>        </span><span class=p>(</span><span class=o>*</span><span class=n>fd_array_</span><span class=p>)[</span><span class=mi>0</span><span class=p>].</span><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>getListenSocketFd</span><span class=p>();</span>
</span><span id=__span-38-21><span class=w>        </span><span class=c1>// 监听读事件</span>
</span><span id=__span-38-22><span class=w>        </span><span class=p>(</span><span class=o>*</span><span class=n>fd_array_</span><span class=p>)[</span><span class=mi>0</span><span class=p>].</span><span class=n>events</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>POLLIN</span><span class=p>;</span>
</span><span id=__span-38-23><span class=w>    </span><span class=p>}</span>
</span><span id=__span-38-24>
</span><span id=__span-38-25><span class=k>private</span><span class=o>:</span>
</span><span id=__span-38-26><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>BaseSocket</span><span class=o>&gt;</span><span class=w> </span><span class=n>bs_</span><span class=p>;</span>
</span><span id=__span-38-27><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=k>struct</span><span class=w> </span><span class=nc>pollfd</span><span class=p>,</span><span class=w> </span><span class=n>g_fd_array_num</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>fd_array_</span><span class=p>;</span>
</span><span id=__span-38-28><span class=w>    </span><span class=kt>bool</span><span class=w> </span><span class=n>isRunning_</span><span class=p>;</span>
</span><span id=__span-38-29><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-39-1><span class=kt>void</span><span class=w> </span><span class=nf>startServer</span><span class=p>()</span>
</span><span id=__span-39-2><span class=p>{</span>
</span><span id=__span-39-3><span class=w>    </span><span class=n>isRunning_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-39-4><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>isRunning_</span><span class=p>)</span>
</span><span id=__span-39-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-39-6><span class=w>        </span><span class=c1>// 不再需要在循环中多次设置监听套接字到读文件描述符集中</span>
</span><span id=__span-39-7><span class=w>        </span><span class=c1>// 等待1秒</span>
</span><span id=__span-39-8><span class=w>        </span><span class=k>const</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>timeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1000</span><span class=p>;</span>
</span><span id=__span-39-9><span class=w>        </span><span class=c1>// 只关心读事件的文件描述符集</span>
</span><span id=__span-39-10><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>poll</span><span class=p>(</span><span class=n>fd_array_</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>(),</span><span class=w> </span><span class=n>g_fd_array_num</span><span class=p>,</span><span class=w> </span><span class=n>timeout</span><span class=p>);</span>
</span><span id=__span-39-11><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-39-12><span class=w>        </span><span class=p>{</span>
</span><span id=__span-39-13><span class=w>            </span><span class=c1>// 监听套接字文件描述符准备完毕</span>
</span><span id=__span-39-14><span class=w>            </span><span class=n>handler</span><span class=p>();</span>
</span><span id=__span-39-15><span class=w>        </span><span class=p>}</span>
</span><span id=__span-39-16><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-39-17><span class=w>        </span><span class=p>{</span>
</span><span id=__span-39-18><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;没有客户端连接&quot;</span><span class=p>;</span>
</span><span id=__span-39-19><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-39-20><span class=w>        </span><span class=p>}</span>
</span><span id=__span-39-21><span class=w>    </span><span class=p>}</span>
</span><span id=__span-39-22><span class=w>    </span><span class=n>isRunning_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-39-23><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-40-1><span class=kt>void</span><span class=w> </span><span class=nf>handler</span><span class=p>()</span>
</span><span id=__span-40-2><span class=p>{</span>
</span><span id=__span-40-3><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>pfd</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=o>*</span><span class=n>fd_array_</span><span class=p>)</span>
</span><span id=__span-40-4><span class=w>    </span><span class=p>{</span>
</span><span id=__span-40-5><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pfd</span><span class=p>.</span><span class=n>fd</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>-1</span><span class=p>)</span>
</span><span id=__span-40-6><span class=w>        </span><span class=p>{</span>
</span><span id=__span-40-7><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>pfd</span><span class=p>.</span><span class=n>fd</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>getListenSocketFd</span><span class=p>())</span>
</span><span id=__span-40-8><span class=w>            </span><span class=p>{</span>
</span><span id=__span-40-9><span class=w>                </span><span class=c1>// 检测监听套接字是否就绪</span>
</span><span id=__span-40-10><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pfd</span><span class=p>.</span><span class=n>revents</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>POLLIN</span><span class=p>)</span>
</span><span id=__span-40-11><span class=w>                </span><span class=p>{</span>
</span><span id=__span-40-12><span class=w>                    </span><span class=c1>// 存在即可开始获取</span>
</span><span id=__span-40-13><span class=w>                    </span><span class=n>SockAddrIn</span><span class=w> </span><span class=n>client</span><span class=p>;</span>
</span><span id=__span-40-14><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>ac_socketfd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>toAccept</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>addressof</span><span class=p>(</span><span class=n>client</span><span class=p>));</span>
</span><span id=__span-40-15>
</span><span id=__span-40-16><span class=w>                    </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>DEBUG</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;当前接收到了客户端：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>client</span><span class=p>.</span><span class=n>getIp</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;:&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>client</span><span class=p>.</span><span class=n>getPort</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;文件描述符为：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>ac_socketfd</span><span class=p>;</span>
</span><span id=__span-40-17>
</span><span id=__span-40-18><span class=w>                    </span><span class=c1>// 将获取到的新ac_socketfd添加到辅助数组</span>
</span><span id=__span-40-19><span class=w>                    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>f</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=o>*</span><span class=n>fd_array_</span><span class=p>)</span>
</span><span id=__span-40-20><span class=w>                    </span><span class=p>{</span>
</span><span id=__span-40-21><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>f</span><span class=p>.</span><span class=n>fd</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>-1</span><span class=p>)</span>
</span><span id=__span-40-22><span class=w>                        </span><span class=p>{</span>
</span><span id=__span-40-23><span class=w>                            </span><span class=n>f</span><span class=p>.</span><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ac_socketfd</span><span class=p>;</span>
</span><span id=__span-40-24><span class=w>                            </span><span class=n>f</span><span class=p>.</span><span class=n>events</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>POLLIN</span><span class=p>;</span>
</span><span id=__span-40-25><span class=w>                            </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-40-26><span class=w>                        </span><span class=p>}</span>
</span><span id=__span-40-27><span class=w>                    </span><span class=p>}</span>
</span><span id=__span-40-28><span class=w>                </span><span class=p>}</span>
</span><span id=__span-40-29><span class=w>            </span><span class=p>}</span>
</span><span id=__span-40-30><span class=w>            </span><span class=k>else</span><span class=w> </span>
</span><span id=__span-40-31><span class=w>            </span><span class=p>{</span>
</span><span id=__span-40-32><span class=w>                </span><span class=c1>// 检测其他套接字是否就绪</span>
</span><span id=__span-40-33><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pfd</span><span class=p>.</span><span class=n>revents</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>POLLIN</span><span class=p>)</span>
</span><span id=__span-40-34><span class=w>                </span><span class=p>{</span>
</span><span id=__span-40-35><span class=w>                    </span><span class=c1>// 说明是用于读取的套接字</span>
</span><span id=__span-40-36><span class=w>                    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>buffer</span><span class=p>;</span>
</span><span id=__span-40-37><span class=w>                    </span><span class=kt>ssize_t</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>recvData</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=n>pfd</span><span class=p>.</span><span class=n>fd</span><span class=p>);</span>
</span><span id=__span-40-38>
</span><span id=__span-40-39><span class=w>                    </span><span class=k>if</span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-40-40><span class=w>                        </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;客户端发送了：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>buffer</span><span class=p>;</span>
</span><span id=__span-40-41><span class=w>                    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-40-42><span class=w>                    </span><span class=p>{</span>
</span><span id=__span-40-43><span class=w>                        </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;客户端退出&quot;</span><span class=p>;</span>
</span><span id=__span-40-44><span class=w>                        </span><span class=n>pfd</span><span class=p>.</span><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-40-45><span class=w>                        </span><span class=n>pfd</span><span class=p>.</span><span class=n>events</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pfd</span><span class=p>.</span><span class=n>revents</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-40-46>
</span><span id=__span-40-47><span class=w>                    </span><span class=p>}</span>
</span><span id=__span-40-48><span class=w>                    </span><span class=k>else</span>
</span><span id=__span-40-49><span class=w>                    </span><span class=p>{</span>
</span><span id=__span-40-50><span class=w>                        </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;错误&quot;</span><span class=p>;</span>
</span><span id=__span-40-51><span class=w>                        </span><span class=n>pfd</span><span class=p>.</span><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-40-52><span class=w>                        </span><span class=n>pfd</span><span class=p>.</span><span class=n>events</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pfd</span><span class=p>.</span><span class=n>revents</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-40-53><span class=w>                    </span><span class=p>}</span>
</span><span id=__span-40-54><span class=w>                </span><span class=p>}</span>
</span><span id=__span-40-55><span class=w>            </span><span class=p>}</span>
</span><span id=__span-40-56><span class=w>        </span><span class=p>}</span>
</span><span id=__span-40-57><span class=w>    </span><span class=p>}</span>
</span><span id=__span-40-58><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <h2 id=poll_1><code>poll</code>的缺陷<a class=headerlink href=#poll_1 title="Permanent link">&para;</a></h2> <p>虽然<code>epoll</code>的确解决了<code>select</code>存在的问题，但是<code>epoll</code>底层还是需要大量的遍历，例如遍历<code>struct pollfd</code>数组</p> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title=最后更新> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2025年4月9日</span> </span> <span class=md-source-file__fact> <span class=md-icon title=创建日期> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2025年4月5日</span> </span> </aside> <form class=md-feedback name=feedback hidden> <fieldset> <legend class=md-feedback__title> 页面有帮助吗？ </legend> <div class=md-feedback__inner> <div class=md-feedback__list> <button class="md-feedback__icon md-icon" type=submit title=页面对我有帮助 data-md-value=1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 9v12H1V9zm4 12a2 2 0 0 1-2-2V9c0-.55.22-1.05.59-1.41L14.17 1l1.06 1.06c.27.27.44.64.44 1.05l-.03.32L14.69 8H21a2 2 0 0 1 2 2v2c0 .26-.05.5-.14.73l-3.02 7.05C19.54 20.5 18.83 21 18 21zm0-2h9.03L21 12v-2h-8.79l1.13-5.32L9 9.03z"/></svg> </button> <button class="md-feedback__icon md-icon" type=submit title=页面没有帮助到我 data-md-value=0> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 15V3h4v12zM15 3a2 2 0 0 1 2 2v10c0 .55-.22 1.05-.59 1.41L9.83 23l-1.06-1.06c-.27-.27-.44-.64-.44-1.06l.03-.31.95-4.57H3a2 2 0 0 1-2-2v-2c0-.26.05-.5.14-.73l3.02-7.05C4.46 3.5 5.17 3 6 3zm0 2H5.97L3 12v2h8.78l-1.13 5.32L15 14.97z"/></svg> </button> </div> <div class=md-feedback__note> <div data-md-value=1 hidden> 谢谢你的反馈！ </div> <div data-md-value=0 hidden> 谢谢你的反馈！联系<a href=https://www.help-doc.top/%E4%BD%9C%E8%80%85/%E4%BD%9C%E8%80%85.html>作者</a>提供更详细的信息 </div> </div> </div> </fieldset> </form> <!-- 阅读进度条 - 直接在HTML中定义 --> <div class=reading-progress></div> <!-- 滚动指示器 - 直接在HTML中定义 --> <div class=scroll-indicator></div> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <!--
  Copyright (c) 2016-2024 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!-- Footer --> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2024-2025 柯懒不是柯南 </div> </div> <!-- "一闪一闪亮晶晶"元素 - 插入在copyright和social之间 --> <div class="md-footer-love md-typeset"> 一闪一闪亮晶晶，不及<span class=love-highlight>小亮</span><span class=love-heart>♥</span>照我心。To Li Liang </div> <div class=md-social> <a href=https://github.com/H0308 target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://www.help-doc.top/%E4%BD%9C%E8%80%85/%E4%BD%9C%E8%80%85.html target=_blank rel=noopener title=www.help-doc.top class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M433.754 420.445c-11.526 1.393-44.86-52.741-44.86-52.741 0 31.345-16.136 72.247-51.051 101.786 16.842 5.192 54.843 19.167 45.803 34.421-7.316 12.343-125.51 7.881-159.632 4.037-34.122 3.844-152.316 8.306-159.632-4.037-9.045-15.25 28.918-29.214 45.783-34.415-34.92-29.539-51.059-70.445-51.059-101.792 0 0-33.334 54.134-44.859 52.741-5.37-.65-12.424-29.644 9.347-99.704 10.261-33.024 21.995-60.478 40.144-105.779C60.683 98.063 108.982.006 224 0c113.737.006 163.156 96.133 160.264 214.963 18.118 45.223 29.912 72.85 40.144 105.778 21.768 70.06 14.716 99.053 9.346 99.704"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.indexes", "navigation.prune", "navigation.tabs", "search.highlight", "content.code.copy"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script> <script src=../../assets/javascripts/bundle.c8b220af.min.js></script> <script src=../../javascripts/katex.min.js></script> <script src=../../javascripts/other.min.js></script> <script src=../../javascripts/copyright.min.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/contrib/auto-render.min.js></script> <script src=../../assets/javascripts/toggle-sidebar.js async></script> <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body> </html>