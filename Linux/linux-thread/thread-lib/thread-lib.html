<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://www.help-doc.top/Linux/linux-thread/thread-lib/thread-lib.html><link rel=prev href=../thread-concept-op/thread-concept-op.html><link rel=next href=../thread-sync/thread-sync.html><link rel=icon href=../../../images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.12"><title>Linux线程库与线程库封装 - 柯懒的知识库</title><link rel=stylesheet href=../../../assets/stylesheets/main.2afb09e1.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.06af60db.min.css><link rel=stylesheet href=../../../css/timeline.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-9XWRGNRRSY"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-9XWRGNRRSY",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-9XWRGNRRSY",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script><link rel=stylesheet href=../../../stylesheets/colors.min.css><link rel=stylesheet href=../../../stylesheets/theme2.min.css media="screen and (max-width: 1199px)"><link rel=stylesheet href=../../../stylesheets/theme2.min.css media="screen and (min-width: 1200px)" id=theme2-desktop><link rel=stylesheet href=../../../stylesheets/theme1.min.css media="screen and (min-width: 1200px)" id=theme1-desktop><link rel=stylesheet href=../../../stylesheets/print.min.css><link rel=stylesheet href=../../../stylesheets/font-dongguanti.min.css id=font-dongguanti><link rel=stylesheet href=../../../stylesheets/font-oppoti.min.css id=font-oppoti disabled><link rel=stylesheet href=../../../stylesheets/font-jiangchengti.min.css id=font-jiangchengti disabled><link rel=stylesheet href=../../../stylesheets/font-lxgw.min.css id=font-lxgw disabled><link rel=stylesheet href=../../../stylesheets/code-font-dejavu-sans-mono.min.css id=code-font-dejavu-sans-mono><link rel=stylesheet href=../../../stylesheets/code-font-zsft-hk.min.css id=code-font-zsft-hk disabled><link rel=stylesheet href=../../../stylesheets/code-font-google-sans-code.min.css id=code-font-google-sans-code disabled><link rel=stylesheet href=https://unpkg.com/@waline/client@v3/dist/waline.css><link rel=stylesheet href=../../../stylesheets/waline.min.css><script src=../../../javascripts/start.min.js></script> <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../assets/javascripts/glightbox.min.js"></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=cyan> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#linux class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../../index.html title=柯懒的知识库 class="md-header__button md-logo" aria-label=柯懒的知识库 data-md-component=logo> <img src=../../../assets/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> 柯懒的知识库 </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Linux线程库与线程库封装 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=cyan aria-label type=radio name=__palette id=__palette_1> </form> <!-- 头像元素 - 直接在HTML中定义 --> <div class=header-avatar> <img src=../../../author/作者.assets/20250206-200653.jpg alt=头像> <div class=avatar-dropdown> <p><strong>柯懒不是柯南</strong></p> <a href=../../../author/contact/contact.html class=avatar-dropdown-item>吵醒柯懒</a> <div class=avatar-dropdown-divider></div> <a href=../../../author/about/about.html class=avatar-dropdown-item>柯懒自传</a> <div class=avatar-dropdown-divider></div> <a href=https://github.com/H0308 class=avatar-dropdown-item>柯懒的零食库</a> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=查找> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <!-- 独立的切换按钮 --> <div class=toolbar-toggle-btn id=toolbarToggleBtn onclick=toggleToolbar()> <div class=toggle-icon> <svg class=toggle-arrow-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=16 height=16> <path d="M346.538667 1024L170.666667 853.333333l341.333333-341.333333-341.333333-341.333333 175.872-170.666667L853.333333 512z" fill=currentColor></path> </svg> </div> </div> <!-- 右侧固定功能条 - 独立于内容区 --> <div class=floating-toolbar id=floatingToolbar> <!-- 字体切换功能 --> <div class="toolbar-item font-switcher"> <div class=toolbar-icon> <svg class=font-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=20 height=20> <path d="M913.408 1024l-66.56 0q-29.696 0-51.2-5.12t-36.864-15.872-26.112-27.136-19.968-37.888q-15.36-38.912-28.16-70.656t-22.016-55.296q-11.264-26.624-20.48-49.152l-254.976 0q-7.168 23.552-17.408 51.2-8.192 23.552-21.504 56.832t-30.72 72.192q-20.48 46.08-47.104 63.488t-60.416 17.408l-70.656 0q-45.056 0-60.928-19.968t2.56-68.096q18.432-46.08 43.008-108.544t52.224-132.608 57.344-143.872 57.344-144.384q65.536-164.864 137.216-343.04 7.168-17.408 18.432-31.744 10.24-11.264 27.136-21.504t42.496-10.24q26.624 0 43.52 10.752t28.16 24.064q12.288 15.36 19.456 33.792 72.704 180.224 138.24 345.088 27.648 70.656 57.344 143.872t56.832 142.336 51.2 129.536 41.472 104.448q14.336 34.816 4.096 62.464t-43.008 27.648zM616.448 634.88l-97.28-347.136-1.024 0-108.544 347.136 206.848 0z" fill=currentColor></path> </svg> </div> <div class=toolbar-label>内容字体</div> <div class=font-dropdown-toolbar> <div class=font-current-toolbar onclick=toggleFontDropdownToolbar()> <span class=current-font-name-toolbar>东观体</span> <svg class=dropdown-arrow-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=12 height=12> <path d="M878.592 250.88q29.696 0 48.128 11.264t24.576 29.696 0 41.472-26.624 45.568q-82.944 92.16-159.744 180.224t-148.48 164.864q-19.456 20.48-45.568 31.744t-53.76 11.776-53.248-8.704-43.008-28.672q-39.936-44.032-82.944-90.112l-88.064-92.16q-43.008-46.08-85.504-90.624t-79.36-86.528q-17.408-19.456-22.528-40.448t1.024-38.4 23.552-28.672 45.056-11.264q35.84 0 98.816-0.512t137.728-0.512l153.6 0 150.528 0 125.952 0 79.872 0z" fill=currentColor></path> </svg> </div> <div class=font-options-toolbar> <div class=font-option-toolbar data-font=dongguanti onclick="selectFontToolbar('dongguanti')">上图东观体 </div> <div class=font-option-toolbar data-font=oppoti onclick="selectFontToolbar('oppoti')">OPPO Sans </div> <div class=font-option-toolbar data-font=jiangchengti onclick="selectFontToolbar('jiangchengti')"> 江城黑体</div> <div class=font-option-toolbar data-font=lxgw onclick="selectFontToolbar('lxgw')">霞鹜臻楷</div> </div> </div> </div> <!-- 代码字体切换功能 --> <div class="toolbar-item code-font-switcher"> <div class=toolbar-icon> <svg t=1753672111433 class="icon code-font-icon" viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg p-id=5148 width=20 height=20> <path d="M941.709938 0H82.290062A82.290062 82.290062 0 0 0 0 82.290062v859.419876A82.290062 82.290062 0 0 0 82.290062 1022.53923h859.419876A82.290062 82.290062 0 0 0 1022.53923 941.709938V82.290062A82.290062 82.290062 0 0 0 941.709938 0zM188.439372 553.631954a40.901569 40.901569 0 0 1-29.215406-70.116975L292.154066 351.558726 159.223966 218.628626a40.901569 40.901569 0 0 1 58.430813-57.94389l160.197813 162.145507a40.901569 40.901569 0 0 1 0 57.943889l-160.197813 160.684736a40.901569 40.901569 0 0 1-29.215407 12.173086z m443.587257 0H405.120304a40.901569 40.901569 0 0 1 0-82.290061H633.000476a40.901569 40.901569 0 0 1 0 82.290061z" fill=currentColor p-id=5149></path> </svg> </div> <div class=toolbar-label>代码字体</div> <div class=code-font-dropdown-toolbar> <div class=code-font-current-toolbar onclick=toggleCodeFontDropdownToolbar()> <span class=current-code-font-name-toolbar>DejaVu Sans Mono</span> <svg class=dropdown-arrow-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=12 height=12> <path d="M878.592 250.88q29.696 0 48.128 11.264t24.576 29.696 0 41.472-26.624 45.568q-82.944 92.16-159.744 180.224t-148.48 164.864q-19.456 20.48-45.568 31.744t-53.76 11.776-53.248-8.704-43.008-28.672q-39.936-44.032-82.944-90.112l-88.064-92.16q-43.008-46.08-85.504-90.624t-79.36-86.528q-17.408-19.456-22.528-40.448t1.024-38.4 23.552-28.672 45.056-11.264q35.84 0 98.816-0.512t137.728-0.512l153.6 0 150.528 0 125.952 0 79.872 0z" fill=currentColor></path> </svg> </div> <div class=code-font-options-toolbar> <div class=code-font-option-toolbar data-code-font=dejavu onclick="selectCodeFontToolbar('dejavu')"> DejaVu Sans Mono</div> <div class=code-font-option-toolbar data-code-font=google-sans-code onclick="selectCodeFontToolbar('google-sans-code')"> Google Sans Code</div> <div class=code-font-option-toolbar data-code-font=zsft onclick="selectCodeFontToolbar('zsft')"> JetBrains Mono</div> </div> </div> </div> <!-- 主题切换功能 --> <div class="toolbar-item theme-switcher" onclick=switchTheme()> <div class=toolbar-icon> <svg class=theme-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=20 height=20> <path d="M876.572788 522.301623c-1.886977 12.375865-9.657964 30.331819-35.880185 45.48903-56.489572 32.697703-150.21828 83.990926-174.010149 96.958262-13.143345 24.431435-66.067718 122.221646-98.141204 178.503487-16.117073 28.124548-36.055171 34.041304-50.030463 34.041304-0.031722 0-0.031722 0-0.031722 0-14.613836 0-29.1806-6.460132-43.234687-19.218714-47.183626-42.643216-125.994576-117.105115-146.013515-136.083351-27.757181-4.732791-138.338718-23.743774-200.584388-35.752272-17.924231-3.533476-32.649608-14.07046-40.372499-29.084409-5.78782-11.256368-10.281157-30.05962 1.471514-55.658647 26.989701-59.047838 74.126254-157.557432 85.957721-182.196599-3.437286-27.117614-16.996093-135.060045-23.760147-198.905142-1.886977-17.460674 3.901867-35.096333 15.829524-48.351218 12.791327-14.278191 30.667463-21.48943 49.854455-19.426445 63.669088 6.332219 173.259042 19.426445 200.584388 22.705118 24.335245-11.879562 121.085776-58.936297 180.133613-86.34146 9.91379-4.573155 19.85828-6.92369 29.596062-6.92369 28.748764 0 52.172243 20.642133 58.328453 51.421136 12.599969 62.997799 30.93864 166.70272 35.639708 193.484689 18.851347 19.682271 91.953272 96.031147 135.060045 143.07151C872.72004 487.125473 879.307062 504.71406 876.572788 522.301623L876.572788 522.301623zM825.375755 499.085876C776.017604 445.314205 687.245791 352.977193 686.365748 352.017332c-2.942005-3.069919-4.956895-6.971785-5.676279-11.208273-0.207731-1.215688-22.193465-127.001509-36.551474-198.936865-0.799202-3.917216-4.285606-16.836457-16.196891-16.836457-3.453658 0-7.30743 1.006933-11.464099 2.942005-67.282383 31.179117-183.955662 88.180342-185.170327 88.771813-3.693112 1.790786-7.850805 2.558265-11.975752 2.01489-1.295506-0.224104-133.63765-16.165168-205.988468-23.424502-0.079818 0-0.207731 0-0.287549 0-7.30743 0-11.128455 2.89391-13.319353 5.40408-3.677762 4.124947-5.644557 9.91379-5.068436 15.110139 7.674796 72.623018 24.255427 202.934922 24.463158 204.325595 0.511653 4.109598-0.159636 8.266267-1.966795 11.960403-0.591471 1.215688-57.657164 120.04712-88.339977 187.201589-3.565199 7.754614-4.41352 14.214746-2.350534 18.131963 1.935072 3.725858 6.588045 5.820566 10.360975 6.53995 70.719668 13.718443 204.644867 36.519752 206.036563 36.727483 4.189416 0.671289 8.058536 2.686179 11.112082 5.580089 1.006933 0.87902 96.414887 91.281983 150.090367 139.889027 8.314363 7.563256 13.143345 8.106632 14.437827 8.106632 3.485381 0 8.314363-4.621251 12.727882-12.391215 36.343743-63.828724 100.011808-181.988868 100.636025-183.155437 1.983167-3.64604 5.004991-6.667863 8.650007-8.650007 1.134847-0.671289 114.418936-62.373583 178.6314-99.516528 8.698103-5.036713 14.278191-10.568706 14.94948-14.854313C834.681702 511.845481 831.49922 505.800811 825.375755 499.085876L825.375755 499.085876zM935.333076 935.670256c-4.157693 4.157693-9.689686 6.299473-15.141862 6.299473-5.548366 0-11.048637-2.142803-15.238053-6.299473l-171.915441-171.915441c-8.362458-8.394181-8.362458-21.98471 0-30.426987 8.394181-8.394181 21.98471-8.394181 30.379914 0l171.915441 171.915441C943.727257 913.684522 943.727257 927.275052 935.333076 935.670256L935.333076 935.670256z" fill=currentColor></path> </svg> </div> <div class=toolbar-label>主题切换</div> </div> <!-- 历史记录功能 --> <div class="toolbar-item history-viewer"> <div class=toolbar-icon> <svg t=1755171414807 class=icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg p-id=4979 width=20 height=20> <path d="M798.5152 707.9936v-77.0048c0-12.288-9.8304-22.7328-22.1184-22.7328-13.9264 0-24.1664 11.4688-24.1664 25.3952V739.328c0 8.192 6.7584 14.9504 14.9504 14.9504h83.5584c13.1072 0 24.1664-10.6496 23.7568-23.7568-0.4096-13.7216-11.6736-22.528-25.3952-22.528h-50.5856z m-502.3744-119.1936c-16.384 0-29.2864 13.9264-27.8528 30.5152 1.2288 14.5408 13.9264 25.3952 28.672 25.3952h142.9504c14.5408 0 27.2384-10.8544 28.672-25.3952 1.4336-16.5888-11.4688-30.5152-27.8528-30.5152h-144.5888z m0-231.6288h309.4528c15.7696 0 28.4672-12.9024 28.0576-28.8768-0.4096-14.9504-13.7216-27.2384-28.672-27.2384H296.7552c-14.7456 0-27.8528 11.8784-28.672 26.624-0.4096 7.9872 2.6624 15.5648 8.192 21.2992 5.3248 5.12 12.288 8.192 19.8656 8.192z m241.4592 113.0496c0-15.36-12.4928-28.0576-28.0576-28.0576H296.7552c-14.5408 0-27.2384 10.8544-28.4672 25.3952-1.4336 16.5888 11.6736 30.5152 28.0576 30.5152h213.4016c15.36 0.4096 27.8528-12.288 27.8528-27.8528z m0 0" p-id=4980 fill=currentColor></path> <path d="M568.5248 846.4384H248.0128c-24.1664 0-44.032-19.8656-44.032-44.032V212.1728c0-24.1664 19.8656-44.032 44.032-44.032h461.0048c24.1664 0 44.032 19.8656 44.032 44.032v223.0272c0 15.5648 11.6736 28.8768 27.0336 30.3104 17.6128 1.6384 32.3584-12.288 32.3584-29.696V212.1728c0-57.1392-46.4896-103.6288-103.424-103.6288H248.0128c-55.296 0-100.5568 43.008-103.424 98.0992v601.4976c2.8672 54.8864 48.3328 97.8944 103.424 97.8944h319.8976c14.9504 0 28.0576-10.6496 30.1056-25.3952 2.6624-18.432-11.6736-34.2016-29.4912-34.2016z m0 0" p-id=4981 fill=currentColor></path> <path d="M782.7456 502.1696c-111.8208 0-202.752 91.3408-201.9328 203.5712 0.8192 109.7728 90.5216 199.4752 200.4992 200.4992 112.0256 0.8192 203.5712-90.112 203.5712-201.9328-0.2048-111.616-90.7264-202.1376-202.1376-202.1376z m146.432 201.9328c0 81.5104-66.7648 147.456-148.48 146.432-78.848-1.024-143.1552-65.3312-144.384-143.9744-1.2288-81.92 64.9216-148.8896 146.432-148.8896 80.6912 0 146.432 65.536 146.432 146.432z m0 0" p-id=4982 fill=currentColor></path> </svg> </div> <div class=toolbar-label>历史记录</div> <div class=history-dropdown-toolbar> <div class=history-header-toolbar> <span>浏览历史</span> <button class=history-clear-btn onclick=clearHistory() title=清空历史记录> <svg viewbox="0 0 1024 1024" width=12 height=12> <path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm165.4 618.2l-66-.3L512 563.4l-99.3 118.4-66.1.3c-4.4 0-8-3.5-8-8 0-1.9.7-3.7 1.9-5.2l130.1-155L340.5 359a8.32 8.32 0 0 1-1.9-5.2c0-4.4 3.6-8 8-8l66.1.3L512 464.6l99.3-118.4 66-.3c4.4 0 8 3.5 8 8 0 1.9-.7 3.7-1.9 5.2L553.5 514l130 155c1.2 1.5 1.9 3.3 1.9 5.2 0 4.4-3.6 8-8 8z" fill=currentColor></path> </svg> </button> </div> <div class=history-list-toolbar id=historyList> <div class=history-empty-toolbar>暂无浏览记录</div> </div> </div> </div> <!-- 返回顶部功能 --> <div class="toolbar-item back-to-top" onclick=scrollToTop()> <div class=toolbar-icon> <svg class=back-to-top-icon viewbox="0 0 1024 1024" xmlns=http://www.w3.org/2000/svg> <path d="M882.688 624.128l-336.896-583.68c-15.872-27.136-54.784-27.136-70.656 0L138.24 624.128c-15.872 27.136 4.096 61.44 35.328 61.44H317.44c22.528 0 40.96 18.432 40.96 40.96v239.616c0 22.528 18.432 40.96 40.96 40.96h223.232c22.528 0 40.96-18.432 40.96-40.96v-239.616c0-22.528 18.432-40.96 40.96-40.96h143.872c30.208 0 50.176-34.304 34.304-61.44z"> </path> </svg> </div> <div class=toolbar-label>返回顶部</div> </div> </div> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../index.html class=md-tabs__link> 主页 </a> </li> <li class=md-tabs__item> <a href=../../../intro/intro.html class=md-tabs__link> 网站介绍 </a> </li> <li class=md-tabs__item> <a href=../../../timeline/timeline.html class=md-tabs__link> 网站时间线 </a> </li> <li class=md-tabs__item> <a href=../../../languages/index.html class=md-tabs__link> 编程语言 </a> </li> <li class=md-tabs__item> <a href=../../../data-structure-algo/index.html class=md-tabs__link> 数据结构与算法 </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../index.html class=md-tabs__link> Linux </a> </li> <li class=md-tabs__item> <a href=../../../front-end/index.html class=md-tabs__link> 前端 </a> </li> <li class=md-tabs__item> <a href=../../../MySQL/index.html class=md-tabs__link> MySQL </a> </li> <li class=md-tabs__item> <a href=../../../JavaEE/index.html class=md-tabs__link> JavaEE应用开发 </a> </li> <li class=md-tabs__item> <a href=../../../other/index.html class=md-tabs__link> 扩展知识 </a> </li> <li class=md-tabs__item> <a href=../../../tooltips/index.html class=md-tabs__link> 工具帮助 </a> </li> <li class=md-tabs__item> <a href=../../../test-encrypt/test-encrypt.html class=md-tabs__link> 测试加密功能 </a> </li> <li class=md-tabs__item> <a href=../../../projects/index.html class=md-tabs__link> 项目 </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../index.html title=柯懒的知识库 class="md-nav__button md-logo" aria-label=柯懒的知识库 data-md-component=logo> <img src=../../../assets/logo.png alt=logo> </a> 柯懒的知识库 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../index.html class=md-nav__link> <span class=md-ellipsis> 主页 </span> </a> </li> <li class=md-nav__item> <a href=../../../intro/intro.html class=md-nav__link> <span class=md-ellipsis> 网站介绍 </span> </a> </li> <li class=md-nav__item> <a href=../../../timeline/timeline.html class=md-nav__link> <span class=md-ellipsis> 网站时间线 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../languages/index.html class=md-nav__link> <span class=md-ellipsis> 编程语言 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../data-structure-algo/index.html class=md-nav__link> <span class=md-ellipsis> 数据结构与算法 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6 checked> <div class="md-nav__link md-nav__container"> <a href=../../index.html class="md-nav__link "> <span class=md-ellipsis> Linux </span> </a> <label class="md-nav__link " for=__nav_6 id=__nav_6_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=true> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../options-commands/options-commands.html class=md-nav__link> <span class=md-ellipsis> Linux常用选项和指令 </span> </a> </li> <li class=md-nav__item> <a href=../../permission/permission.html class=md-nav__link> <span class=md-ellipsis> Linux权限相关 </span> </a> </li> <li class=md-nav__item> <a href=../../software-installation/software-installation.html class=md-nav__link> <span class=md-ellipsis> CentOS软件安装 </span> </a> </li> <li class=md-nav__item> <a href=../../gcc-gdb/gcc-gdb.html class=md-nav__link> <span class=md-ellipsis> Linux下的gcc与gdb </span> </a> </li> <li class=md-nav__item> <a href=../../makefile-progress-bar/makefile-progress-bar.html class=md-nav__link> <span class=md-ellipsis> Linux下的Makefile与进度条程序 </span> </a> </li> <li class=md-nav__item> <a href=../../os-basic/os-basic.html class=md-nav__link> <span class=md-ellipsis> 操作系统基础知识 </span> </a> </li> <li class=md-nav__item> <a href=../../process-basic/process-basic.html class=md-nav__link> <span class=md-ellipsis> Linux进程基础 </span> </a> </li> <li class=md-nav__item> <a href=../../process-state-priority/process-state-priority.html class=md-nav__link> <span class=md-ellipsis> Linux进程状态与进程优先级 </span> </a> </li> <li class=md-nav__item> <a href=../../process-switch-scheduling/process-switch-scheduling.html class=md-nav__link> <span class=md-ellipsis> Linux进程切换以及调度算法 </span> </a> </li> <li class=md-nav__item> <a href=../../command-line-env/command-line-env.html class=md-nav__link> <span class=md-ellipsis> Linux命令行与环境变量 </span> </a> </li> <li class=md-nav__item> <a href=../../process-address-space/process-address-space.html class=md-nav__link> <span class=md-ellipsis> Linux进程地址空间 </span> </a> </li> <li class=md-nav__item> <a href=../../process-control/process-control.html class=md-nav__link> <span class=md-ellipsis> Linux进程控制 </span> </a> </li> <li class=md-nav__item> <a href=../../linux-fileop/linux-fileop.html class=md-nav__link> <span class=md-ellipsis> Linux文件操作基础 </span> </a> </li> <li class=md-nav__item> <a href=../../io-process/io-process.html class=md-nav__link> <span class=md-ellipsis> Linux中输入和输出基本过程 </span> </a> </li> <li class=md-nav__item> <a href=../../file-system/file-system.html class=md-nav__link> <span class=md-ellipsis> Linux文件系统 </span> </a> </li> <li class=md-nav__item> <a href=../../soft-hard-link/soft-hard-link.html class=md-nav__link> <span class=md-ellipsis> Linux软链接和硬链接 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../com-process/com-anonymous-pipe/com-anonymous-pipe.html class=md-nav__link> <span class=md-ellipsis> Linux进程间通信 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../../signals-os-principles/signals-os-principles.html class=md-nav__link> <span class=md-ellipsis> Linux信号与操作系统原理 </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_20 checked> <label class=md-nav__link for=__nav_6_20 id=__nav_6_20_label tabindex=0> <span class=md-ellipsis> Linux线程 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_20_label aria-expanded=true> <label class=md-nav__title for=__nav_6_20> <span class="md-nav__icon md-icon"></span> Linux线程 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../thread-concept-op/thread-concept-op.html class=md-nav__link> <span class=md-ellipsis> Linux线程概念与线程操作 </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Linux线程库与线程库封装 </span> <span class="md-nav__icon md-icon"></span> </label> <a href=thread-lib.html class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Linux线程库与线程库封装 </span> </a> <nav class="md-nav md-nav--secondary" aria-label=本节目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 本节目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#id class=md-nav__link> <span class=md-ellipsis> 何为线程id </span> </a> </li> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 线程库 </span> </a> <nav class=md-nav aria-label=线程库> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 前置知识 </span> </a> </li> <li class=md-nav__item> <a href=#pthread class=md-nav__link> <span class=md-ellipsis> 线程结构体pthread </span> </a> </li> <li class=md-nav__item> <a href=#pthread_create class=md-nav__link> <span class=md-ellipsis> 线程创建函数pthread_create </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 使用指令查看创建线程时使用的系统调用 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 线程库封装 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../thread-sync/thread-sync.html class=md-nav__link> <span class=md-ellipsis> Linux线程互斥与同步 </span> </a> </li> <li class=md-nav__item> <a href=../thread-semaphore/thread-semaphore.html class=md-nav__link> <span class=md-ellipsis> Linux线程与信号量 </span> </a> </li> <li class=md-nav__item> <a href=../thread-pc/thread-pc.html class=md-nav__link> <span class=md-ellipsis> 生产者消费者模型（Producer-Consumer Model） </span> </a> </li> <li class=md-nav__item> <a href=../log/log.html class=md-nav__link> <span class=md-ellipsis> 日志系统 </span> </a> </li> <li class=md-nav__item> <a href=../thread-safe-deadlock/thread-safe-deadlock.html class=md-nav__link> <span class=md-ellipsis> Linux线程安全与死锁 </span> </a> </li> <li class=md-nav__item> <a href=../thread-pool/thread-pool.html class=md-nav__link> <span class=md-ellipsis> Linux线程池 </span> </a> </li> <li class=md-nav__item> <a href=../thread-rw/thread-rw.html class=md-nav__link> <span class=md-ellipsis> 读者写者问题与读写锁 </span> </a> </li> <li class=md-nav__item> <a href=../thread-spin/thread-spin.html class=md-nav__link> <span class=md-ellipsis> 自旋锁 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../net-basic/net-basic.html class=md-nav__link> <span class=md-ellipsis> 网络基础知识 </span> </a> </li> <li class=md-nav__item> <a href=../../socket-basic/socket-basic.html class=md-nav__link> <span class=md-ellipsis> Socket编程基础 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../udp/udp-basic/udp-basic.html class=md-nav__link> <span class=md-ellipsis> UDP编程 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../../tcp-basic/tcp-basic.html class=md-nav__link> <span class=md-ellipsis> TCP编程接口基本使用 </span> </a> </li> <li class=md-nav__item> <a href=../../serialization-net-cal/serialization-net-cal.html class=md-nav__link> <span class=md-ellipsis> 序列化和反序列化与网络计算器 </span> </a> </li> <li class=md-nav__item> <a href=../../process-relationship-daemon/process-relationship-daemon.html class=md-nav__link> <span class=md-ellipsis> 进程间关系和守护进程 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../http/http-basic-httpserver/http-basic-httpserver.html class=md-nav__link> <span class=md-ellipsis> 应用层协议HTTP </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../../udp-principles/udp-principles.html class=md-nav__link> <span class=md-ellipsis> UDP协议原理 </span> </a> </li> <li class=md-nav__item> <a href=../../tcp-principles/tcp-principles.html class=md-nav__link> <span class=md-ellipsis> TCP协议原理 </span> </a> </li> <li class=md-nav__item> <a href=../../tcp-connection-backlog/tcp-connection-backlog.html class=md-nav__link> <span class=md-ellipsis> 理解Linux如何看待连接以及TCP全连接队列 </span> </a> </li> <li class=md-nav__item> <a href=../../ip/ip.html class=md-nav__link> <span class=md-ellipsis> 网络层IP协议 </span> </a> </li> <li class=md-nav__item> <a href=../../datalink/datalink.html class=md-nav__link> <span class=md-ellipsis> 数据链路层协议 </span> </a> </li> <li class=md-nav__item> <a href=../../dns-icmp/dns-icmp.html class=md-nav__link> <span class=md-ellipsis> DNS与ICMP </span> </a> </li> <li class=md-nav__item> <a href=../../nat-proxy/nat-proxy.html class=md-nav__link> <span class=md-ellipsis> NAT技术、代理服务器和内网穿透 </span> </a> </li> <li class=md-nav__item> <a href=../../io-model-select-poll/io-model-select-poll.html class=md-nav__link> <span class=md-ellipsis> 五种IO模型与select和poll分别实现多路转接 </span> </a> </li> <li class=md-nav__item> <a href=../../epoll/epoll.html class=md-nav__link> <span class=md-ellipsis> epoll实现多路转接 </span> </a> </li> <li class=md-nav__item> <a href=../../reactor-et/reactor-et.html class=md-nav__link> <span class=md-ellipsis> Reactor模式与完善基于边缘触发模式epoll实现TCP服务器 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../front-end/index.html class=md-nav__link> <span class=md-ellipsis> 前端 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../MySQL/index.html class=md-nav__link> <span class=md-ellipsis> MySQL </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../JavaEE/index.html class=md-nav__link> <span class=md-ellipsis> JavaEE应用开发 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../other/index.html class=md-nav__link> <span class=md-ellipsis> 扩展知识 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../tooltips/index.html class=md-nav__link> <span class=md-ellipsis> 工具帮助 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../test-encrypt/test-encrypt.html class=md-nav__link> <span class=md-ellipsis> 测试加密功能 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../projects/index.html class=md-nav__link> <span class=md-ellipsis> 项目 </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=本节目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 本节目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#id class=md-nav__link> <span class=md-ellipsis> 何为线程id </span> </a> </li> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 线程库 </span> </a> <nav class=md-nav aria-label=线程库> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 前置知识 </span> </a> </li> <li class=md-nav__item> <a href=#pthread class=md-nav__link> <span class=md-ellipsis> 线程结构体pthread </span> </a> </li> <li class=md-nav__item> <a href=#pthread_create class=md-nav__link> <span class=md-ellipsis> 线程创建函数pthread_create </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 使用指令查看创建线程时使用的系统调用 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 线程库封装 </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=linux>Linux线程库与线程库封装<a class=headerlink href=#linux title="Permanent link">&para;</a></h1> <div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;"> <p><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 2491 个字 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 473 行代码 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 2 张图片 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 14 分钟</p> </div> <h2 id=id>何为线程<code>id</code><a class=headerlink href=#id title="Permanent link">&para;</a></h2> <p>在线程操作部分提到了使用<code>pthread_self()</code>接口获取到当前线程的<code>id</code>，例如下面的代码：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-0-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;cstring&gt;</span>
</span><span id=__span-0-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;unistd.h&gt;</span>
</span><span id=__span-0-4><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;pthread.h&gt;</span>
</span><span id=__span-0-5>
</span><span id=__span-0-6><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=nf>routine</span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>arg</span><span class=p>)</span>
</span><span id=__span-0-7><span class=p>{</span>
</span><span id=__span-0-8><span class=w>    </span><span class=n>printf</span><span class=p>(</span><span class=s>&quot;%ld</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>,</span><span class=w> </span><span class=n>pthread_self</span><span class=p>());</span>
</span><span id=__span-0-9>
</span><span id=__span-0-10><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>NULL</span><span class=p>;</span>
</span><span id=__span-0-11><span class=p>}</span>
</span><span id=__span-0-12>
</span><span id=__span-0-13><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-0-14><span class=p>{</span>
</span><span id=__span-0-15><span class=w>    </span><span class=n>pthread_t</span><span class=w> </span><span class=n>thid</span><span class=p>;</span>
</span><span id=__span-0-16>
</span><span id=__span-0-17><span class=w>    </span><span class=c1>// 创建线程</span>
</span><span id=__span-0-18><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pthread_create</span><span class=p>(</span><span class=o>&amp;</span><span class=n>thid</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>,</span><span class=w> </span><span class=n>routine</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=s>&quot;thread-1&quot;</span><span class=p>);</span>
</span><span id=__span-0-19>
</span><span id=__span-0-20><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pthread_join</span><span class=p>(</span><span class=n>thid</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span>
</span><span id=__span-0-21>
</span><span id=__span-0-22><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-0-23><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>运行后结果如下：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-1-1>123897116624576
</span></code></pre></div></td></tr></table></div> <p>这个结果不够直观，使用下面的代码将该数值转换为16进制输出：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-2-1><span class=c1>// ...</span>
</span><span id=__span-2-2><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=nf>toHex</span><span class=p>(</span><span class=n>pthread_t</span><span class=w> </span><span class=n>num</span><span class=p>)</span>
</span><span id=__span-2-3><span class=p>{</span>
</span><span id=__span-2-4><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>buffer</span><span class=p>[</span><span class=mi>1024</span><span class=p>];</span>
</span><span id=__span-2-5><span class=w>    </span><span class=n>snprintf</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>buffer</span><span class=p>),</span><span class=w> </span><span class=s>&quot;0x%lx&quot;</span><span class=p>,</span><span class=w> </span><span class=n>num</span><span class=p>);</span>
</span><span id=__span-2-6>
</span><span id=__span-2-7><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>buffer</span><span class=p>;</span>
</span><span id=__span-2-8><span class=p>}</span>
</span><span id=__span-2-9>
</span><span id=__span-2-10><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=nf>routine</span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>arg</span><span class=p>)</span>
</span><span id=__span-2-11><span class=p>{</span>
</span><span id=__span-2-12><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>toHex</span><span class=p>(</span><span class=n>pthread_self</span><span class=p>())</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-2-13>
</span><span id=__span-2-14><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>NULL</span><span class=p>;</span>
</span><span id=__span-2-15><span class=p>}</span>
</span><span id=__span-2-16><span class=c1>// ...</span>
</span></code></pre></div></td></tr></table></div> <p>此时再运行上面的代码即可看到下面的结果：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-3-1>0x7df688c006c0
</span></code></pre></div></td></tr></table></div> <p>这个结果实际上就是一个地址值，所以所谓的线程<code>id</code>实际上就是一个地址值而并不是LWP值，具体原因在接下来介绍线程库时即可解释</p> <h2 id=_1>线程库<a class=headerlink href=#_1 title="Permanent link">&para;</a></h2> <h3 id=_2>前置知识<a class=headerlink href=#_2 title="Permanent link">&para;</a></h3> <p>在前面提到，因为Linux本身只有轻量级进程的概念，所以只有操作轻量级进程的接口，为了用户更加方便创建操作系统概念层面的线程，存在着一个用户级线程库<code>libpthread.so</code>，而因为是动态库，所以在编译链接时需要加上<code>-lpthread</code>，使用<code>ldd</code>命令查看对应的运行程序可以看到链接的动态库</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>某些版本的操作系统使用<code>ldd</code>命令不会显示动态链接的<code>libpthread.so</code>，如果线程运行是正常的，就不需要再考虑</p> </div> <p>当程序运行时，加载动态库到内存，建立虚拟地址和物理地址的映射，此时当前进程中的所有线程就都可以看到链接的<code>pthread</code>动态库并使用该动态库</p> <p>既然线程可以被用户创建，线程在Linux下又是轻量级进程，那么一定也有其对应的属性，如果用户想要获取一些线程属性，而不是轻量级进程的属性，那么用户级线程库依旧需要对这些属性进行封装，所以实际上，线程库除了封装操作线程的接口外，还需要封装一些线程的属性，此时就需要一个结构体来维护这些属性。在glibc中，这个结构叫<code>struct pthread</code>，其中一些属性，例如线程<code>id</code>，线程栈大小，线程局部存储</p> <div class="admonition abstract"> <p class=admonition-title>回顾</p> <p>在前面文件部分也提到过语言库对系统底层的文件属性进行封装，即<code>struct FILE</code></p> </div> <p>在创建线程时，操作系统会创建对应的物理内存空间用于动态库，并将该空间通过<code>mmap</code>接口映射到当前进程的虚拟地址空间，接着就会在这个动态库所在的空间开辟对应的线程结构以及线程需要的空间，例如线程栈和线程局部存储，此时线程就拥有了自己独立的线程栈，如下图所示：</p> <p><a class=glightbox href="2. Linux线程库与线程库封装.assets/image-20250208182626614.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="2. Linux线程库与线程库封装.assets/image-20250208182626614.png"></a></p> <p>整体示意图如下：</p> <p><a class=glightbox href="2. Linux线程库与线程库封装.assets\download.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="2. Linux线程库与线程库封装.assets\download.png"></a></p> <p>而所谓的线程id就是在动态库空间中的<code>struct pthread</code>结构的起始地址，即：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-4-1><span class=k>struct</span><span class=w> </span><span class=nc>pthread</span><span class=o>*</span><span class=w> </span><span class=n>pd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>...;</span>
</span><span id=__span-4-2><span class=n>pthread_t</span><span class=w> </span><span class=n>tid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>pthread_t</span><span class=p>)</span><span class=n>pd</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> <p>此时，在进程地址空间中，从逻辑上看，存在两种栈：一种是进程启动时创建的，用于支持<code>main</code>函数执行的栈，可以称之为主线程栈。另一种是在<code>libpthread.so</code>动态库加载后，由线程库为每个新创建的线程分配的栈，这些栈位于动态库管理的内存区域内，可以称之为线程栈</p> <p>有了上面的理解，下面就可以进入用户级线程库源代码理解创建线程所经历的过程</p> <h3 id=pthread>线程结构体<code>pthread</code><a class=headerlink href=#pthread title="Permanent link">&para;</a></h3> <p>在glibc源代码中，下面是对应的线程结构：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-5-1><span class=cm>/* Thread descriptor data structure.  */</span>
</span><span id=__span-5-2><span class=k>struct</span><span class=w> </span><span class=nc>pthread</span>
</span><span id=__span-5-3><span class=p>{</span>
</span><span id=__span-5-4><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-5-5><span class=w>    </span><span class=cm>/* This descriptor&#39;s link on the `stack_used&#39; or `__stack_user&#39; list.  */</span>
</span><span id=__span-5-6><span class=w>    </span><span class=n>list_t</span><span class=w> </span><span class=n>list</span><span class=p>;</span>
</span><span id=__span-5-7>
</span><span id=__span-5-8><span class=w>    </span><span class=c1>// 线程id</span>
</span><span id=__span-5-9><span class=w>    </span><span class=kt>pid_t</span><span class=w> </span><span class=n>tid</span><span class=p>;</span>
</span><span id=__span-5-10>
</span><span id=__span-5-11><span class=w>    </span><span class=c1>// 当前进程pid</span>
</span><span id=__span-5-12><span class=w>    </span><span class=kt>pid_t</span><span class=w> </span><span class=n>pid</span><span class=p>;</span>
</span><span id=__span-5-13>
</span><span id=__span-5-14><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-5-15>
</span><span id=__span-5-16><span class=w>    </span><span class=c1>// 判断用户是否传入自定义栈</span>
</span><span id=__span-5-17><span class=w>    </span><span class=kt>bool</span><span class=w> </span><span class=n>user_stack</span><span class=p>;</span>
</span><span id=__span-5-18>
</span><span id=__span-5-19><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-5-20>
</span><span id=__span-5-21><span class=w>    </span><span class=c1>// 存储线程执行函数的返回值</span>
</span><span id=__span-5-22><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>result</span><span class=p>;</span>
</span><span id=__span-5-23>
</span><span id=__span-5-24><span class=w>    </span><span class=c1>// 线程执行函数和参数</span>
</span><span id=__span-5-25><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=n>start_routine</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=p>);</span>
</span><span id=__span-5-26><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>arg</span><span class=p>;</span>
</span><span id=__span-5-27>
</span><span id=__span-5-28><span class=w>    </span><span class=c1>// 线程栈指针</span>
</span><span id=__span-5-29><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>stackblock</span><span class=p>;</span>
</span><span id=__span-5-30><span class=w>    </span><span class=c1>// 线程栈大小</span>
</span><span id=__span-5-31><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>stackblock_size</span><span class=p>;</span>
</span><span id=__span-5-32>
</span><span id=__span-5-33><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-5-34><span class=p>}</span><span class=w> </span><span class=n>__attribute</span><span class=w> </span><span class=p>((</span><span class=n>aligned</span><span class=w> </span><span class=p>(</span><span class=n>TCB_ALIGNMENT</span><span class=p>)));</span>
</span></code></pre></div></td></tr></table></div> <p>其中的<code>result</code>就是用于一些需要获取到线程执行函数返回值的位置，例如前面提到的<code>pthread_join</code>获取到函数返回值就是通过这个<code>result</code>变量，另外前面提到过<code>clone</code>函数，这个函数的原型如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-6-1><span class=kt>int</span><span class=w> </span><span class=n>clone</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>fn</span><span class=p>)(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=p>),</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>stack</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>flags</span><span class=p>,</span>
</span><span id=__span-6-2><span class=w>            </span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>arg</span><span class=p>,</span><span class=w> </span><span class=p>...</span><span class=w>  </span><span class=cm>/* pid_t * parent_tid, void * tls,</span>
</span><span id=__span-6-3><span class=cm>                                pid_t * child_tid */</span><span class=w> </span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>其中，第一个参数就是需要执行的函数，第二个参数表示创建的栈空间，第三个参数表示标记位，用于标记是创建子进程还是轻量级进程，第四个参数就是需要执行的函数的指针，后面的参数可以不用考虑，但是其中的<code>void* tls</code>就是表示线程局部存储的空间</p> <p>在上面的<code>pthread</code>的结构中，一些属性就是传递到<code>clone</code>接口中，例如线程栈指针<code>stackblock</code></p> <h3 id=pthread_create>线程创建函数<code>pthread_create</code><a class=headerlink href=#pthread_create title="Permanent link">&para;</a></h3> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-7-1><span class=kt>int</span><span class=w> </span><span class=nf>__pthread_create_2_1</span><span class=w> </span><span class=p>(</span><span class=n>pthread_t</span><span class=w> </span><span class=o>*</span><span class=n>newthread</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>pthread_attr_t</span><span class=w> </span><span class=o>*</span><span class=n>attr</span><span class=p>,</span>
</span><span id=__span-7-2><span class=w>              </span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=n>start_routine</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=p>),</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>arg</span><span class=p>)</span>
</span><span id=__span-7-3><span class=p>{</span>
</span><span id=__span-7-4><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-7-5>
</span><span id=__span-7-6><span class=w>    </span><span class=c1>// 线程属性，就是pthread_create函数的第二个参数，默认情况下传递NULL</span>
</span><span id=__span-7-7><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>pthread_attr</span><span class=w> </span><span class=o>*</span><span class=n>iattr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>pthread_attr</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=n>attr</span><span class=p>;</span>
</span><span id=__span-7-8><span class=w>    </span><span class=c1>// 创建默认属性</span>
</span><span id=__span-7-9><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>pthread_attr</span><span class=w> </span><span class=n>default_attr</span><span class=p>;</span>
</span><span id=__span-7-10>
</span><span id=__span-7-11><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-7-12>
</span><span id=__span-7-13><span class=w>    </span><span class=c1>// 如果iattr为NULL，就使用默认属性</span>
</span><span id=__span-7-14><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>iattr</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span>
</span><span id=__span-7-15><span class=w>    </span><span class=p>{</span>
</span><span id=__span-7-16><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-7-17>
</span><span id=__span-7-18><span class=w>        </span><span class=c1>// 使用默认属性</span>
</span><span id=__span-7-19><span class=w>        </span><span class=n>iattr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>default_attr</span><span class=p>;</span>
</span><span id=__span-7-20><span class=w>    </span><span class=p>}</span>
</span><span id=__span-7-21>
</span><span id=__span-7-22><span class=w>    </span><span class=c1>// 创建线程结构体</span>
</span><span id=__span-7-23><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>pthread</span><span class=w> </span><span class=o>*</span><span class=n>pd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>NULL</span><span class=p>;</span>
</span><span id=__span-7-24>
</span><span id=__span-7-25><span class=w>    </span><span class=c1>// 调用ALLOCATE_STACK申请struct pthread对象</span>
</span><span id=__span-7-26><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ALLOCATE_STACK</span><span class=p>(</span><span class=n>iattr</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>pd</span><span class=p>);</span>
</span><span id=__span-7-27>
</span><span id=__span-7-28><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-7-29>
</span><span id=__span-7-30><span class=w>    </span><span class=c1>// 设置线程执行函数和对应的参数到线程结构体对象中</span>
</span><span id=__span-7-31><span class=w>    </span><span class=n>pd</span><span class=o>-&gt;</span><span class=n>start_routine</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>start_routine</span><span class=p>;</span>
</span><span id=__span-7-32><span class=w>    </span><span class=n>pd</span><span class=o>-&gt;</span><span class=n>arg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>arg</span><span class=p>;</span>
</span><span id=__span-7-33>
</span><span id=__span-7-34><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-7-35>
</span><span id=__span-7-36><span class=w>    </span><span class=c1>// 设置参数pthread* newthread为线程结构体对象的地址，即设置线程id为结构体对象的地址</span>
</span><span id=__span-7-37><span class=w>    </span><span class=o>*</span><span class=n>newthread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>pthread_t</span><span class=p>)</span><span class=w> </span><span class=n>pd</span><span class=p>;</span>
</span><span id=__span-7-38>
</span><span id=__span-7-39><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-7-40>
</span><span id=__span-7-41><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>__glibc_unlikely</span><span class=w> </span><span class=p>(</span><span class=n>report_thread_creation</span><span class=w> </span><span class=p>(</span><span class=n>pd</span><span class=p>)))</span>
</span><span id=__span-7-42><span class=w>    </span><span class=p>{</span>
</span><span id=__span-7-43><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-7-44>
</span><span id=__span-7-45><span class=w>        </span><span class=c1>// 创建线程</span>
</span><span id=__span-7-46><span class=w>        </span><span class=n>retval</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>create_thread</span><span class=p>(</span><span class=n>pd</span><span class=p>,</span><span class=w> </span><span class=n>iattr</span><span class=p>,</span><span class=w> </span><span class=n>STACK_VARIABLES_ARGS</span><span class=p>);</span>
</span><span id=__span-7-47>
</span><span id=__span-7-48><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-7-49><span class=w>    </span><span class=p>}</span>
</span><span id=__span-7-50>
</span><span id=__span-7-51><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-7-52><span class=p>}</span>
</span><span id=__span-7-53><span class=c1>// 版本确认信息，如果用的库是GLIBC_2_1，则使用__pthread_create_2_1</span>
</span><span id=__span-7-54><span class=n>versioned_symbol</span><span class=w> </span><span class=p>(</span><span class=n>libpthread</span><span class=p>,</span><span class=w> </span><span class=n>__pthread_create_2_1</span><span class=p>,</span><span class=w> </span><span class=n>pthread_create</span><span class=p>,</span><span class=w> </span><span class=n>GLIBC_2_1</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>在上面的函数中，首先该函数会接收四个参数，分别表示新线程的<code>id</code>值、新线程的属性、新线程的执行函数和执行函数的参数</p> <p>在函数内部，首先会判断用户是否传递了自定义的线程属性，如果没有就使用默认的线程属性，所以对于<code>pthread_create</code>函数来说，第二个参数设置为<code>NULL</code>就可以保证线程使用默认属性，线程属性结构体如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-8-1><span class=k>struct</span><span class=w> </span><span class=nc>pthread_attr</span>
</span><span id=__span-8-2><span class=p>{</span>
</span><span id=__span-8-3><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-8-4>
</span><span id=__span-8-5><span class=w>    </span><span class=c1>// 线程栈空间指针</span>
</span><span id=__span-8-6><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>stackaddr</span><span class=p>;</span>
</span><span id=__span-8-7><span class=w>    </span><span class=c1>// 线程栈大小</span>
</span><span id=__span-8-8><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>stacksize</span><span class=p>;</span>
</span><span id=__span-8-9>
</span><span id=__span-8-10><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-8-11><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>接着就是描述线程，创建线程结构体指针，调用相关的函数为结构体指针创建对象，对应的<code>ALLOCATE_STACK</code>函数如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-9-1><span class=c1>// 创建一个宏，通过属性和struct pthread指针调用allocate_stack函数</span>
</span><span id=__span-9-2><span class=cp># define ALLOCATE_STACK(attr, pd) allocate_stack (attr, pd, &amp;stackaddr)</span>
</span><span id=__span-9-3>
</span><span id=__span-9-4><span class=k>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>allocate_stack</span><span class=w> </span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>pthread_attr</span><span class=w> </span><span class=o>*</span><span class=n>attr</span><span class=p>,</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>pthread</span><span class=w> </span><span class=o>**</span><span class=n>pdp</span><span class=p>,</span>
</span><span id=__span-9-5><span class=w>        </span><span class=n>ALLOCATE_STACK_PARMS</span><span class=p>)</span>
</span><span id=__span-9-6><span class=p>{</span>
</span><span id=__span-9-7><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>pthread</span><span class=w> </span><span class=o>*</span><span class=n>pd</span><span class=p>;</span>
</span><span id=__span-9-8><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>size</span><span class=p>;</span>
</span><span id=__span-9-9>
</span><span id=__span-9-10><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-9-11>
</span><span id=__span-9-12><span class=w>    </span><span class=c1>// 设置线程栈大小，如果用户已经指定，则使用用户指定的大小，否则使用默认大小</span>
</span><span id=__span-9-13><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>attr</span><span class=o>-&gt;</span><span class=n>stacksize</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-9-14><span class=w>        </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>attr</span><span class=o>-&gt;</span><span class=n>stacksize</span><span class=p>;</span>
</span><span id=__span-9-15><span class=w>    </span><span class=k>else</span>
</span><span id=__span-9-16><span class=w>    </span><span class=p>{</span>
</span><span id=__span-9-17><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-9-18><span class=w>        </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>__default_pthread_attr</span><span class=p>.</span><span class=n>stacksize</span><span class=p>;</span>
</span><span id=__span-9-19><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-9-20><span class=w>    </span><span class=p>}</span>
</span><span id=__span-9-21>
</span><span id=__span-9-22><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>__glibc_unlikely</span><span class=w> </span><span class=p>(</span><span class=n>attr</span><span class=o>-&gt;</span><span class=n>flags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>ATTR_FLAG_STACKADDR</span><span class=p>))</span>
</span><span id=__span-9-23><span class=w>    </span><span class=p>{</span>
</span><span id=__span-9-24><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-9-25><span class=w>    </span><span class=p>}</span>
</span><span id=__span-9-26><span class=w>    </span><span class=k>else</span>
</span><span id=__span-9-27><span class=w>    </span><span class=p>{</span>
</span><span id=__span-9-28><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-9-29>
</span><span id=__span-9-30><span class=w>        </span><span class=c1>// 先从pthread缓存中申请空间</span>
</span><span id=__span-9-31><span class=w>        </span><span class=n>reqsize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>size</span><span class=p>;</span>
</span><span id=__span-9-32><span class=w>        </span><span class=n>pd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>get_cached_stack</span><span class=w> </span><span class=p>(</span><span class=o>&amp;</span><span class=n>size</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>mem</span><span class=p>);</span>
</span><span id=__span-9-33><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pd</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span>
</span><span id=__span-9-34><span class=w>        </span><span class=p>{</span>
</span><span id=__span-9-35><span class=w>            </span><span class=c1>// ...</span>
</span><span id=__span-9-36>
</span><span id=__span-9-37><span class=w>            </span><span class=c1>// 缓存申请失败，就到堆空间中申请私有的匿名内存空间</span>
</span><span id=__span-9-38><span class=w>            </span><span class=n>mem</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>__mmap</span><span class=w> </span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span><span class=w> </span><span class=n>size</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>guardsize</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>prot</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>PROT_NONE</span><span class=p>,</span>
</span><span id=__span-9-39><span class=w>                    </span><span class=n>MAP_PRIVATE</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>MAP_ANONYMOUS</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>MAP_STACK</span><span class=p>,</span><span class=w> </span><span class=mi>-1</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-9-40>
</span><span id=__span-9-41><span class=w>            </span><span class=c1>// ...</span>
</span><span id=__span-9-42>
</span><span id=__span-9-43><span class=w>            </span><span class=cm>/* Remember the stack-related values.  */</span>
</span><span id=__span-9-44><span class=w>            </span><span class=c1>// 使用线程对象记录创建的空间和大小</span>
</span><span id=__span-9-45><span class=w>            </span><span class=n>pd</span><span class=o>-&gt;</span><span class=n>stackblock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mem</span><span class=p>;</span>
</span><span id=__span-9-46><span class=w>            </span><span class=n>pd</span><span class=o>-&gt;</span><span class=n>stackblock_size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>size</span><span class=p>;</span>
</span><span id=__span-9-47>
</span><span id=__span-9-48><span class=w>            </span><span class=c1>// ...</span>
</span><span id=__span-9-49><span class=w>        </span><span class=p>}</span>
</span><span id=__span-9-50><span class=w>    </span><span class=p>}</span>
</span><span id=__span-9-51>
</span><span id=__span-9-52><span class=w>    </span><span class=c1>// 二级指针，用于返回struct pthread的地址</span>
</span><span id=__span-9-53><span class=w>    </span><span class=o>*</span><span class=n>pdp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pd</span><span class=p>;</span>
</span><span id=__span-9-54>
</span><span id=__span-9-55><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-9-56>
</span><span id=__span-9-57><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-9-58><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>从这个函数中可以看出，线程栈虽然是动态申请的，但是其大小在申请的那一刻就已经固定好了，所以对于新线程来说，其栈大小是不会改变的，一旦用完就不会再扩容</p> <p>回到<code>__pthread_create_2_1</code>，申请完线程栈后，就开始设置线程执行函数和对应的参数到线程结构体对象中，便于后续读取和调用，接着设置线程<code>id</code>为线程结构体对象的地址，这也就解释了为什么线程<code>id</code>是地址值</p> <p>当所有属性设置完毕后，开始创建线程，调用<code>create_thread</code>接口，代码如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-10-1><span class=k>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>create_thread</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>pthread</span><span class=w> </span><span class=o>*</span><span class=n>pd</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>pthread_attr</span><span class=w> </span><span class=o>*</span><span class=n>attr</span><span class=p>,</span>
</span><span id=__span-10-2><span class=n>STACK_VARIABLES_PARMS</span><span class=p>)</span>
</span><span id=__span-10-3><span class=p>{</span>
</span><span id=__span-10-4><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>clone_flags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>CLONE_VM</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>CLONE_FS</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>CLONE_FILES</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>CLONE_SIGNAL</span><span class=w> </span><span class=o>|</span>
</span><span id=__span-10-5><span class=w>        </span><span class=n>CLONE_SETTLS</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>CLONE_PARENT_SETTID</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>CLONE_CHILD_CLEARTID</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>CLONE_SYSVSEM</span>
</span><span id=__span-10-6>
</span><span id=__span-10-7><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-10-8>
</span><span id=__span-10-9><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>__builtin_expect</span><span class=p>(</span><span class=n>THREAD_GETMEM</span><span class=p>(</span><span class=n>THREAD_SELF</span><span class=p>,</span><span class=w> </span><span class=n>report_events</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>))</span>
</span><span id=__span-10-10><span class=w>    </span><span class=p>{</span>
</span><span id=__span-10-11><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-10-12><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>do_clone</span><span class=p>(</span><span class=n>pd</span><span class=p>,</span><span class=w> </span><span class=n>attr</span><span class=p>,</span><span class=w> </span><span class=n>clone_flags</span><span class=p>,</span><span class=w> </span><span class=n>start_thread</span><span class=p>,</span><span class=w> </span><span class=n>STACK_VARIABLES_ARGS</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-10-13>
</span><span id=__span-10-14><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-10-15><span class=w>    </span><span class=p>}</span>
</span><span id=__span-10-16>
</span><span id=__span-10-17><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-10-18><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>res</span><span class=p>;</span>
</span><span id=__span-10-19><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>在<code>create_thread</code>接口中，调用<code>do_clone</code>接口创建线程：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-11-1><span class=k>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>do_clone</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>pthread</span><span class=w> </span><span class=o>*</span><span class=n>pd</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>pthread_attr</span><span class=w> </span><span class=o>*</span><span class=n>attr</span><span class=p>,</span>
</span><span id=__span-11-2><span class=kt>int</span><span class=w> </span><span class=n>clone_flags</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>fct</span><span class=p>)(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=p>),</span><span class=w> </span><span class=n>STACK_VARIABLES_PARMS</span><span class=p>,</span><span class=kt>int</span><span class=w> </span><span class=n>stopped</span><span class=p>)</span>
</span><span id=__span-11-3><span class=p>{</span>
</span><span id=__span-11-4><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-11-5>
</span><span id=__span-11-6><span class=w>    </span><span class=c1>// 调用当前操作系统下的`clone`函数</span>
</span><span id=__span-11-7><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ARCH_CLONE</span><span class=p>(</span><span class=n>fct</span><span class=p>,</span><span class=w> </span><span class=n>STACK_VARIABLES_ARGS</span><span class=p>,</span><span class=w> </span><span class=n>clone_flags</span><span class=p>,</span><span class=w> </span><span class=n>pd</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>pd</span><span class=o>-&gt;</span><span class=n>tid</span><span class=p>,</span><span class=w> </span><span class=n>TLS_VALUE</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>pd</span><span class=o>-&gt;</span><span class=n>tid</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>-1</span><span class=p>)</span>
</span><span id=__span-11-8><span class=w>    </span><span class=p>{</span>
</span><span id=__span-11-9><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-11-10><span class=w>    </span><span class=p>}</span>
</span><span id=__span-11-11>
</span><span id=__span-11-12><span class=w>    </span><span class=c1>//...</span>
</span><span id=__span-11-13>
</span><span id=__span-11-14><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-11-15><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>对应的<code>ARCH_CLONE</code>也是一个宏，代表当前操作系统的<code>clone</code>，在glibc中对应的是一段汇编封装的调用clone系统调用的函数：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-12-1>/* Sanity check arguments. */
</span><span id=__span-12-2>movq    $-EINVAL,%rax
</span><span id=__span-12-3>testq   %rdi,%rdi   /* no NULL function pointers */
</span><span id=__span-12-4>jz      SYSCALL_ERROR_LABEL
</span><span id=__span-12-5>testq   %rsi,%rsi   /* no NULL stack pointers */
</span><span id=__span-12-6>jz      SYSCALL_ERROR_LABEL
</span><span id=__span-12-7>
</span><span id=__span-12-8>
</span><span id=__span-12-9>/* Insert the argument onto the new stack. */
</span><span id=__span-12-10>subq    $16,%rsi
</span><span id=__span-12-11>movq    %rcx,8(%rsi)
</span><span id=__span-12-12>
</span><span id=__span-12-13>
</span><span id=__span-12-14>/* Save the function pointer. It will be popped off in thechild in the ebx frobbing below. */
</span><span id=__span-12-15>movq    %rdi,0(%rsi)
</span><span id=__span-12-16>
</span><span id=__span-12-17>
</span><span id=__span-12-18>/* Do the system call. */
</span><span id=__span-12-19>movq    %rdx, %rdi
</span><span id=__span-12-20>movq    %r8, %rdx
</span><span id=__span-12-21>movq    %r9, %r8
</span><span id=__span-12-22>movq    8(%rsp), %r10
</span><span id=__span-12-23>movl    $SYS_ify(clone),%eax // 获取系统调⽤号
</span><span id=__span-12-24>
</span><span id=__span-12-25>
</span><span id=__span-12-26>/* End FDE now, because in the child the unwind info will bewrong. */
</span><span id=__span-12-27>cfi_endproc;
</span><span id=__span-12-28>syscall // 陷⼊内核(x86_32是int 80)，要求内核创建轻量级进程
</span><span id=__span-12-29>testq   %rax,%rax
</span><span id=__span-12-30>jl      SYSCALL_ERROR_LABEL
</span><span id=__span-12-31>jz      L(thread_start)
</span></code></pre></div></td></tr></table></div> <p>在上面的汇编中<code>$SYS_ify(clone)</code>就是调用系统调用<code>clone</code></p> <p>至此，创建线程的整个过程就已经基本结束了，所以本质<code>pthread_create</code>函数就是在做空间分配、属性填充和调用<code>clone</code>系统调用创建线程</p> <h3 id=_3>使用指令查看创建线程时使用的系统调用<a class=headerlink href=#_3 title="Permanent link">&para;</a></h3> <p>阅读源码之后可以知道<code>pthread_create</code>底层调用了<code>clone</code>接口，除了这种方式以外，还可以使用指令的方式查看一个程序中调用的系统接口，以下面的代码为例：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-13-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-13-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;cstring&gt;</span>
</span><span id=__span-13-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;unistd.h&gt;</span>
</span><span id=__span-13-4><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;pthread.h&gt;</span>
</span><span id=__span-13-5>
</span><span id=__span-13-6><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=nf>routine</span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>arg</span><span class=p>)</span>
</span><span id=__span-13-7><span class=p>{</span>
</span><span id=__span-13-8><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>NULL</span><span class=p>;</span>
</span><span id=__span-13-9><span class=p>}</span>
</span><span id=__span-13-10>
</span><span id=__span-13-11><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-13-12><span class=p>{</span>
</span><span id=__span-13-13><span class=w>    </span><span class=n>pthread_t</span><span class=w> </span><span class=n>thid</span><span class=p>;</span>
</span><span id=__span-13-14>
</span><span id=__span-13-15><span class=w>    </span><span class=c1>// 创建线程</span>
</span><span id=__span-13-16><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pthread_create</span><span class=p>(</span><span class=o>&amp;</span><span class=n>thid</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>,</span><span class=w> </span><span class=n>routine</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=s>&quot;thread-1&quot;</span><span class=p>);</span>
</span><span id=__span-13-17>
</span><span id=__span-13-18><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-13-19><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>使用<code>strace</code>命令查看当前程序使用的系统调用可以看到：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-14-1><span class=c1>// ...</span>
</span><span id=__span-14-2>
</span><span id=__span-14-3><span class=n>clone3</span><span class=p>({</span><span class=n>flags</span><span class=o>=</span><span class=n>CLONE_VM</span><span class=o>|</span><span class=n>CLONE_FS</span><span class=o>|</span><span class=n>CLONE_FILES</span><span class=o>|</span><span class=n>CLONE_SIGHAND</span><span class=o>|</span><span class=n>CLONE_THREAD</span><span class=o>|</span><span class=n>CLONE_SYSVSEM</span><span class=o>|</span><span class=n>CLONE_SETTLS</span><span class=o>|</span><span class=n>CLONE_PARENT_SETTID</span><span class=o>|</span><span class=n>CLONE_CHILD_CLEARTID</span><span class=p>,</span><span class=w> </span><span class=n>child_tid</span><span class=o>=</span><span class=mh>0x7627b1200990</span><span class=p>,</span><span class=w> </span><span class=n>parent_tid</span><span class=o>=</span><span class=mh>0x7627b1200990</span><span class=p>,</span><span class=w> </span><span class=n>exit_signal</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>stack</span><span class=o>=</span><span class=mh>0x7627b0a00000</span><span class=p>,</span><span class=w> </span><span class=n>stack_size</span><span class=o>=</span><span class=mh>0x7fff80</span><span class=p>,</span><span class=w> </span><span class=n>tls</span><span class=o>=</span><span class=mh>0x7627b12006c0</span><span class=p>}</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=n>parent_tid</span><span class=o>=</span><span class=p>[</span><span class=mi>6010</span><span class=p>]},</span><span class=w> </span><span class=mi>88</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>6010</span>
</span><span id=__span-14-4>
</span><span id=__span-14-5><span class=c1>// ...</span>
</span></code></pre></div></td></tr></table></div> <p>从上面的结果可以看到调用了系统调用<code>clone3</code>（<code>clone</code>的升级版），在参数上可以传递一个结构体代替原来<code>clone</code>分别传递参数的形式，并且支持传递更多的属性，函数的作用一致</p> <div class="admonition info"> <p class=admonition-title>关于<code>strace</code>命令</p> <p><code>strace</code> 是一个 Linux 下的命令行工具，用于跟踪进程执行过程中的系统调用和信号。 简单来说，它可以让你看到程序在运行时都做了哪些“事情”，例如：</p> <ul> <li>打开了哪些文件</li> <li>读取了哪些数据</li> <li>发送了哪些网络请求</li> <li>使用了哪些内存</li> <li>调用了哪些系统函数</li> </ul> <p>这对于调试程序、理解程序行为、以及排查性能问题非常有帮助。</p> <p>例如，如果想知道程序<code>thread</code>在运行时都调用了哪些系统调用，你可以在终端中运行 <code>strace ./thread</code>。 <code>strace</code> 会输出大量的文本，每一行都代表一个系统调用，以及它的参数和返回值。</p> <p>一些常用的 <code>strace</code> 选项包括：</p> <ul> <li><code>-p &lt;pid&gt;</code>: 跟踪指定的进程 ID。</li> <li><code>-o &lt;file&gt;</code>: 将 <code>strace</code> 的输出写入到指定的文件中。</li> <li><code>-f</code>: 跟踪由 <code>fork</code> 或 <code>clone</code> 创建的子进程。</li> <li><code>-c</code>: 统计每个系统调用的耗时和调用次数。</li> </ul> <p>在线程的上下文中，<code>strace -f ./thread</code> 可以用来观察线程的创建 (通常通过 <code>clone</code> 系统调用) 和线程相关的操作。</p> </div> <h2 id=_4>线程库封装<a class=headerlink href=#_4 title="Permanent link">&para;</a></h2> <p>直接使用glibc的线程操作接口会略显麻烦，所以考虑使用C++面向对象的方式封装自己的线程库，本质就是对一些操作进行封装</p> <p>首先考虑线程对象需要有哪些属性，本次设计主要考虑下面的属性：</p> <ol> <li>线程的名称（string类型）</li> <li>线程的<code>id</code>（<code>pthread_t</code>类型）</li> <li>线程的执行函数（无参函数）</li> <li>线程的状态（枚举类类型）</li> <li>线程是否是分离的，默认不是分离（布尔类型）</li> </ol> <p>接着考虑本次设计的线程库需要包括的操作：</p> <ol> <li>创建线程操作（使用<code>pthread_create</code>函数）</li> <li>等待线程操作（使用<code>pthread_join</code>函数）</li> <li>分离线程操作（使用<code>pthread_detach</code>函数）</li> <li>终止线程操作（使用<code>pthread_cancel</code>函数）</li> <li>获取线程名称</li> </ol> <p>另外，考虑使用一个枚举类来表示当前线程的运行状态：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-15-1><span class=c1>// 线程状态</span>
</span><span id=__span-15-2><span class=k>enum</span><span class=w> </span><span class=k>class</span><span class=w> </span><span class=nc>ThreadStatus</span>
</span><span id=__span-15-3><span class=p>{</span>
</span><span id=__span-15-4><span class=w>    </span><span class=n>isNew</span><span class=p>,</span>
</span><span id=__span-15-5><span class=w>    </span><span class=n>isRunning</span><span class=p>,</span>
</span><span id=__span-15-6><span class=w>    </span><span class=n>isStopped</span><span class=p>,</span>
</span><span id=__span-15-7><span class=w>    </span><span class=n>isDetached</span><span class=p>,</span>
</span><span id=__span-15-8><span class=w>    </span><span class=n>isJoinable</span>
</span><span id=__span-15-9><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>基本实现如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>  1</span>
<span class=normal>  2</span>
<span class=normal>  3</span>
<span class=normal>  4</span>
<span class=normal>  5</span>
<span class=normal>  6</span>
<span class=normal>  7</span>
<span class=normal>  8</span>
<span class=normal>  9</span>
<span class=normal> 10</span>
<span class=normal> 11</span>
<span class=normal> 12</span>
<span class=normal> 13</span>
<span class=normal> 14</span>
<span class=normal> 15</span>
<span class=normal> 16</span>
<span class=normal> 17</span>
<span class=normal> 18</span>
<span class=normal> 19</span>
<span class=normal> 20</span>
<span class=normal> 21</span>
<span class=normal> 22</span>
<span class=normal> 23</span>
<span class=normal> 24</span>
<span class=normal> 25</span>
<span class=normal> 26</span>
<span class=normal> 27</span>
<span class=normal> 28</span>
<span class=normal> 29</span>
<span class=normal> 30</span>
<span class=normal> 31</span>
<span class=normal> 32</span>
<span class=normal> 33</span>
<span class=normal> 34</span>
<span class=normal> 35</span>
<span class=normal> 36</span>
<span class=normal> 37</span>
<span class=normal> 38</span>
<span class=normal> 39</span>
<span class=normal> 40</span>
<span class=normal> 41</span>
<span class=normal> 42</span>
<span class=normal> 43</span>
<span class=normal> 44</span>
<span class=normal> 45</span>
<span class=normal> 46</span>
<span class=normal> 47</span>
<span class=normal> 48</span>
<span class=normal> 49</span>
<span class=normal> 50</span>
<span class=normal> 51</span>
<span class=normal> 52</span>
<span class=normal> 53</span>
<span class=normal> 54</span>
<span class=normal> 55</span>
<span class=normal> 56</span>
<span class=normal> 57</span>
<span class=normal> 58</span>
<span class=normal> 59</span>
<span class=normal> 60</span>
<span class=normal> 61</span>
<span class=normal> 62</span>
<span class=normal> 63</span>
<span class=normal> 64</span>
<span class=normal> 65</span>
<span class=normal> 66</span>
<span class=normal> 67</span>
<span class=normal> 68</span>
<span class=normal> 69</span>
<span class=normal> 70</span>
<span class=normal> 71</span>
<span class=normal> 72</span>
<span class=normal> 73</span>
<span class=normal> 74</span>
<span class=normal> 75</span>
<span class=normal> 76</span>
<span class=normal> 77</span>
<span class=normal> 78</span>
<span class=normal> 79</span>
<span class=normal> 80</span>
<span class=normal> 81</span>
<span class=normal> 82</span>
<span class=normal> 83</span>
<span class=normal> 84</span>
<span class=normal> 85</span>
<span class=normal> 86</span>
<span class=normal> 87</span>
<span class=normal> 88</span>
<span class=normal> 89</span>
<span class=normal> 90</span>
<span class=normal> 91</span>
<span class=normal> 92</span>
<span class=normal> 93</span>
<span class=normal> 94</span>
<span class=normal> 95</span>
<span class=normal> 96</span>
<span class=normal> 97</span>
<span class=normal> 98</span>
<span class=normal> 99</span>
<span class=normal>100</span>
<span class=normal>101</span>
<span class=normal>102</span>
<span class=normal>103</span>
<span class=normal>104</span>
<span class=normal>105</span>
<span class=normal>106</span>
<span class=normal>107</span>
<span class=normal>108</span>
<span class=normal>109</span>
<span class=normal>110</span>
<span class=normal>111</span>
<span class=normal>112</span>
<span class=normal>113</span>
<span class=normal>114</span>
<span class=normal>115</span>
<span class=normal>116</span>
<span class=normal>117</span>
<span class=normal>118</span>
<span class=normal>119</span>
<span class=normal>120</span>
<span class=normal>121</span>
<span class=normal>122</span>
<span class=normal>123</span>
<span class=normal>124</span>
<span class=normal>125</span>
<span class=normal>126</span>
<span class=normal>127</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-16-1><span class=cp>#pragma once</span>
</span><span id=__span-16-2>
</span><span id=__span-16-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-16-4><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;unistd.h&gt;</span>
</span><span id=__span-16-5><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;sys/types.h&gt;</span>
</span><span id=__span-16-6><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;pthread.h&gt;</span>
</span><span id=__span-16-7><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;functional&gt;</span>
</span><span id=__span-16-8>
</span><span id=__span-16-9><span class=k>namespace</span><span class=w> </span><span class=nn>ThreadModule</span>
</span><span id=__span-16-10><span class=p>{</span>
</span><span id=__span-16-11><span class=w>    </span><span class=c1>// 线程执行的任务类型</span>
</span><span id=__span-16-12><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>func_t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>function</span><span class=o>&lt;</span><span class=kt>void</span><span class=p>()</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-16-13><span class=w>    </span><span class=c1>// 计数器</span>
</span><span id=__span-16-14><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-16-15>
</span><span id=__span-16-16><span class=w>    </span><span class=c1>// 线程状态</span>
</span><span id=__span-16-17><span class=w>    </span><span class=k>enum</span><span class=w> </span><span class=k>class</span><span class=w> </span><span class=nc>ThreadStatus</span>
</span><span id=__span-16-18><span class=w>    </span><span class=p>{</span>
</span><span id=__span-16-19><span class=w>        </span><span class=n>isNew</span><span class=p>,</span>
</span><span id=__span-16-20><span class=w>        </span><span class=n>isRunning</span><span class=p>,</span>
</span><span id=__span-16-21><span class=w>        </span><span class=n>isStopped</span><span class=p>,</span>
</span><span id=__span-16-22><span class=w>        </span><span class=n>isDetached</span><span class=p>,</span>
</span><span id=__span-16-23><span class=w>        </span><span class=n>isJoinable</span>
</span><span id=__span-16-24><span class=w>    </span><span class=p>};</span>
</span><span id=__span-16-25>
</span><span id=__span-16-26><span class=w>    </span><span class=k>class</span><span class=w> </span><span class=nc>Thread</span>
</span><span id=__span-16-27><span class=w>    </span><span class=p>{</span>
</span><span id=__span-16-28><span class=w>    </span><span class=k>private</span><span class=o>:</span>
</span><span id=__span-16-29><span class=w>        </span><span class=k>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>routine</span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=c1>// 线程执行函数</span>
</span><span id=__span-16-30><span class=w>        </span><span class=p>{</span>
</span><span id=__span-16-31><span class=w>            </span><span class=c1>// 获取到this指针</span>
</span><span id=__span-16-32><span class=w>            </span><span class=n>Thread</span><span class=w> </span><span class=o>*</span><span class=n>_t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>static_cast</span><span class=o>&lt;</span><span class=n>Thread</span><span class=w> </span><span class=o>*&gt;</span><span class=p>(</span><span class=n>arg</span><span class=p>);</span>
</span><span id=__span-16-33><span class=w>            </span><span class=c1>// 更改线程状态为运行状态</span>
</span><span id=__span-16-34><span class=w>            </span><span class=n>_t</span><span class=o>-&gt;</span><span class=n>_thStatus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ThreadStatus</span><span class=o>::</span><span class=n>isRunning</span><span class=p>;</span>
</span><span id=__span-16-35><span class=w>            </span><span class=c1>// 执行任务函数</span>
</span><span id=__span-16-36><span class=w>            </span><span class=n>_t</span><span class=o>-&gt;</span><span class=n>_func</span><span class=p>();</span>
</span><span id=__span-16-37>
</span><span id=__span-16-38><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>NULL</span><span class=p>;</span>
</span><span id=__span-16-39><span class=w>        </span><span class=p>}</span>
</span><span id=__span-16-40>
</span><span id=__span-16-41><span class=w>    </span><span class=k>public</span><span class=o>:</span>
</span><span id=__span-16-42><span class=w>        </span><span class=n>Thread</span><span class=p>(</span><span class=n>func_t</span><span class=w> </span><span class=n>func</span><span class=p>)</span>
</span><span id=__span-16-43><span class=w>            </span><span class=o>:</span><span class=w> </span><span class=n>_func</span><span class=p>(</span><span class=n>func</span><span class=p>),</span><span class=w> </span><span class=n>_thStatus</span><span class=p>(</span><span class=n>ThreadStatus</span><span class=o>::</span><span class=n>isNew</span><span class=p>),</span><span class=w> </span><span class=n>_joinable</span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-16-44><span class=w>        </span><span class=p>{</span>
</span><span id=__span-16-45><span class=w>            </span><span class=n>_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;Thread&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>count</span><span class=o>++</span><span class=p>);</span>
</span><span id=__span-16-46><span class=w>        </span><span class=p>}</span>
</span><span id=__span-16-47>
</span><span id=__span-16-48><span class=w>        </span><span class=c1>// 创建线程</span>
</span><span id=__span-16-49><span class=w>        </span><span class=kt>bool</span><span class=w> </span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-16-50><span class=w>        </span><span class=p>{</span>
</span><span id=__span-16-51><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_thStatus</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>ThreadStatus</span><span class=o>::</span><span class=n>isRunning</span><span class=p>)</span>
</span><span id=__span-16-52><span class=w>            </span><span class=p>{</span>
</span><span id=__span-16-53><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pthread_create</span><span class=p>(</span><span class=o>&amp;</span><span class=n>_tid</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>,</span><span class=w> </span><span class=n>routine</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=k>this</span><span class=p>);</span>
</span><span id=__span-16-54>
</span><span id=__span-16-55><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>ret</span><span class=p>)</span>
</span><span id=__span-16-56><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-16-57>
</span><span id=__span-16-58><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-16-59><span class=w>            </span><span class=p>}</span>
</span><span id=__span-16-60>
</span><span id=__span-16-61><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-16-62><span class=w>        </span><span class=p>}</span>
</span><span id=__span-16-63>
</span><span id=__span-16-64><span class=w>        </span><span class=c1>// 终止线程</span>
</span><span id=__span-16-65><span class=w>        </span><span class=kt>bool</span><span class=w> </span><span class=n>cancel</span><span class=p>()</span>
</span><span id=__span-16-66><span class=w>        </span><span class=p>{</span>
</span><span id=__span-16-67><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_thStatus</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>ThreadStatus</span><span class=o>::</span><span class=n>isRunning</span><span class=p>)</span>
</span><span id=__span-16-68><span class=w>            </span><span class=p>{</span>
</span><span id=__span-16-69><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pthread_cancel</span><span class=p>(</span><span class=n>_tid</span><span class=p>);</span>
</span><span id=__span-16-70><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>ret</span><span class=p>)</span>
</span><span id=__span-16-71><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-16-72>
</span><span id=__span-16-73><span class=w>                </span><span class=n>_thStatus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ThreadStatus</span><span class=o>::</span><span class=n>isStopped</span><span class=p>;</span>
</span><span id=__span-16-74>
</span><span id=__span-16-75><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-16-76><span class=w>            </span><span class=p>}</span>
</span><span id=__span-16-77>
</span><span id=__span-16-78><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-16-79><span class=w>        </span><span class=p>}</span>
</span><span id=__span-16-80>
</span><span id=__span-16-81><span class=w>        </span><span class=c1>// 等待线程</span>
</span><span id=__span-16-82><span class=w>        </span><span class=kt>bool</span><span class=w> </span><span class=n>join</span><span class=p>()</span>
</span><span id=__span-16-83><span class=w>        </span><span class=p>{</span>
</span><span id=__span-16-84><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_thStatus</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>ThreadStatus</span><span class=o>::</span><span class=n>isDetached</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>_joinable</span><span class=p>)</span>
</span><span id=__span-16-85><span class=w>            </span><span class=p>{</span>
</span><span id=__span-16-86><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pthread_join</span><span class=p>(</span><span class=n>_tid</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span>
</span><span id=__span-16-87><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=p>)</span>
</span><span id=__span-16-88><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-16-89>
</span><span id=__span-16-90><span class=w>                </span><span class=n>_thStatus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ThreadStatus</span><span class=o>::</span><span class=n>isStopped</span><span class=p>;</span>
</span><span id=__span-16-91>
</span><span id=__span-16-92><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-16-93><span class=w>            </span><span class=p>}</span>
</span><span id=__span-16-94><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-16-95><span class=w>        </span><span class=p>}</span>
</span><span id=__span-16-96>
</span><span id=__span-16-97><span class=w>        </span><span class=c1>// 分离线程</span>
</span><span id=__span-16-98><span class=w>        </span><span class=kt>bool</span><span class=w> </span><span class=n>detach</span><span class=p>()</span>
</span><span id=__span-16-99><span class=w>        </span><span class=p>{</span>
</span><span id=__span-16-100><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_joinable</span><span class=p>)</span>
</span><span id=__span-16-101><span class=w>            </span><span class=p>{</span>
</span><span id=__span-16-102><span class=w>                </span><span class=n>pthread_detach</span><span class=p>(</span><span class=n>_tid</span><span class=p>);</span>
</span><span id=__span-16-103><span class=w>                </span><span class=n>_joinable</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-16-104><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-16-105><span class=w>            </span><span class=p>}</span>
</span><span id=__span-16-106>
</span><span id=__span-16-107><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-16-108><span class=w>        </span><span class=p>}</span>
</span><span id=__span-16-109>
</span><span id=__span-16-110><span class=w>        </span><span class=c1>// 获取线程名称</span>
</span><span id=__span-16-111><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>getName</span><span class=p>()</span>
</span><span id=__span-16-112><span class=w>        </span><span class=p>{</span>
</span><span id=__span-16-113><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>_name</span><span class=p>;</span>
</span><span id=__span-16-114><span class=w>        </span><span class=p>}</span>
</span><span id=__span-16-115>
</span><span id=__span-16-116><span class=w>        </span><span class=o>~</span><span class=n>Thread</span><span class=p>()</span>
</span><span id=__span-16-117><span class=w>        </span><span class=p>{</span>
</span><span id=__span-16-118><span class=w>        </span><span class=p>}</span>
</span><span id=__span-16-119>
</span><span id=__span-16-120><span class=w>    </span><span class=k>private</span><span class=o>:</span>
</span><span id=__span-16-121><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>_name</span><span class=p>;</span>
</span><span id=__span-16-122><span class=w>        </span><span class=n>pthread_t</span><span class=w> </span><span class=n>_tid</span><span class=p>;</span>
</span><span id=__span-16-123><span class=w>        </span><span class=n>ThreadStatus</span><span class=w> </span><span class=n>_thStatus</span><span class=p>;</span>
</span><span id=__span-16-124><span class=w>        </span><span class=kt>bool</span><span class=w> </span><span class=n>_joinable</span><span class=p>;</span>
</span><span id=__span-16-125><span class=w>        </span><span class=n>func_t</span><span class=w> </span><span class=n>_func</span><span class=p>;</span>
</span><span id=__span-16-126><span class=w>    </span><span class=p>};</span>
</span><span id=__span-16-127><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>上面的代码需要注意，<code>routine</code>函数如果放在类内部，需要考虑到隐藏的<code>this</code>，可以考虑放置在类外，也可以考虑使用静态方法，但是为了能够调用任务函数，还是考虑放在类内，并且传递参数时显式传递<code>this</code></p> </div> <p>测试运行代码如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-17-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;thread.hpp&quot;</span>
</span><span id=__span-17-2>
</span><span id=__span-17-3><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-17-4><span class=p>{</span>
</span><span id=__span-17-5><span class=w>    </span><span class=n>ThreadModule</span><span class=o>::</span><span class=n>Thread</span><span class=w> </span><span class=n>t</span><span class=p>([</span><span class=o>&amp;</span><span class=p>]()</span>
</span><span id=__span-17-6><span class=w>                           </span><span class=p>{</span>
</span><span id=__span-17-7><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-17-8><span class=w>        </span><span class=p>{</span>
</span><span id=__span-17-9><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;我是新线程：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>getName</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;，我的线程id为：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>pthread_self</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-17-10><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-17-11><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-17-12>
</span><span id=__span-17-13><span class=w>    </span><span class=n>t</span><span class=p>.</span><span class=n>start</span><span class=p>();</span>
</span><span id=__span-17-14>
</span><span id=__span-17-15><span class=w>    </span><span class=n>t</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-17-16><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-17-17><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>输出结果如下：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-18-1>我是新线程：Thread0，我的线程id为：128731471414976
</span><span id=__span-18-2>我是新线程：Thread0，我的线程id为：128731471414976
</span><span id=__span-18-3>我是新线程：Thread0，我的线程id为：128731471414976
</span><span id=__span-18-4>我是新线程：Thread0，我的线程id为：128731471414976
</span><span id=__span-18-5>我是新线程：Thread0，我的线程id为：128731471414976
</span><span id=__span-18-6>我是新线程：Thread0，我的线程id为：128731471414976
</span><span id=__span-18-7>我是新线程：Thread0，我的线程id为：128731471414976
</span><span id=__span-18-8>...
</span></code></pre></div></td></tr></table></div> <p>如果需要创建多线程，此时就会非常方便：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-19-1><span class=cp>#define NUM 10</span>
</span><span id=__span-19-2>
</span><span id=__span-19-3><span class=n>using</span><span class=w> </span><span class=n>thread_ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>ThreadModule</span><span class=o>::</span><span class=n>Thread</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-19-4>
</span><span id=__span-19-5><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-19-6><span class=p>{</span>
</span><span id=__span-19-7><span class=w>    </span><span class=c1>// 使用哈希表建立线程名称和线程对象的映射</span>
</span><span id=__span-19-8><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unordered_map</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=p>,</span><span class=w> </span><span class=n>thread_ptr</span><span class=o>&gt;</span><span class=w> </span><span class=n>threads</span><span class=p>;</span>
</span><span id=__span-19-9>
</span><span id=__span-19-10><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-19-11><span class=w>    </span><span class=p>{</span>
</span><span id=__span-19-12><span class=w>        </span><span class=n>thread_ptr</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>ThreadModule</span><span class=o>::</span><span class=n>Thread</span><span class=o>&gt;</span><span class=p>([]()</span>
</span><span id=__span-19-13><span class=w>                                                              </span><span class=p>{</span>
</span><span id=__span-19-14><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-19-15><span class=w>        </span><span class=p>{</span>
</span><span id=__span-19-16><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;我是新线程&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;，我的线程id为：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>pthread_self</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-19-17><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-19-18><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-19-19>
</span><span id=__span-19-20><span class=w>        </span><span class=n>threads</span><span class=p>[</span><span class=n>t</span><span class=o>-&gt;</span><span class=n>getName</span><span class=p>()]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>t</span><span class=p>;</span>
</span><span id=__span-19-21><span class=w>    </span><span class=p>}</span>
</span><span id=__span-19-22>
</span><span id=__span-19-23><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=n>pair</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>threads</span><span class=p>)</span>
</span><span id=__span-19-24><span class=w>        </span><span class=n>pair</span><span class=p>.</span><span class=n>second</span><span class=o>-&gt;</span><span class=n>start</span><span class=p>();</span>
</span><span id=__span-19-25>
</span><span id=__span-19-26><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=n>pair</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>threads</span><span class=p>)</span>
</span><span id=__span-19-27><span class=w>        </span><span class=n>pair</span><span class=p>.</span><span class=n>second</span><span class=o>-&gt;</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-19-28>
</span><span id=__span-19-29><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-19-30><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title=最后更新> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2025年2月17日</span> </span> </aside> <form class=md-feedback name=feedback hidden> <fieldset> <legend class=md-feedback__title> 页面有帮助吗？ </legend> <div class=md-feedback__inner> <div class=md-feedback__list> <button class="md-feedback__icon md-icon" type=submit title=页面对我有帮助 data-md-value=1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 9v12H1V9zm4 12a2 2 0 0 1-2-2V9c0-.55.22-1.05.59-1.41L14.17 1l1.06 1.06c.27.27.44.64.44 1.05l-.03.32L14.69 8H21a2 2 0 0 1 2 2v2c0 .26-.05.5-.14.73l-3.02 7.05C19.54 20.5 18.83 21 18 21zm0-2h9.03L21 12v-2h-8.79l1.13-5.32L9 9.03z"/></svg> </button> <button class="md-feedback__icon md-icon" type=submit title=页面没有帮助到我 data-md-value=0> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 15V3h4v12zM15 3a2 2 0 0 1 2 2v10c0 .55-.22 1.05-.59 1.41L9.83 23l-1.06-1.06c-.27-.27-.44-.64-.44-1.06l.03-.31.95-4.57H3a2 2 0 0 1-2-2v-2c0-.26.05-.5.14-.73l3.02-7.05C4.46 3.5 5.17 3 6 3zm0 2H5.97L3 12v2h8.78l-1.13 5.32L15 14.97z"/></svg> </button> </div> <div class=md-feedback__note> <div data-md-value=1 hidden> 谢谢你的反馈！ </div> <div data-md-value=0 hidden> 谢谢你的反馈！联系<a href=https://www.help-doc.top/author/contact/contact.html>作者</a>提供更详细的信息 </div> </div> </div> </fieldset> </form> <!-- Waline 评论系统 --> <div id=waline></div> <!-- 阅读进度条 - 直接在HTML中定义 --> <div class=reading-progress></div> <!-- 滚动指示器 - 直接在HTML中定义 --> <div class=scroll-indicator></div> <!-- 评论系统 --> <!-- Waline 评论系统 --> <div id=waline></div> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <!--
  Copyright (c) 2016-2024 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!-- Footer --> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2024-2025 柯懒不是柯南 </div> </div> <div class="md-footer-love md-typeset"> 一闪一闪亮晶晶，不及<span class=love-highlight>小亮</span><span class=love-heart>♥</span>照我心。To Li Liang </div> <div class=md-social> <a href=https://github.com/H0308 target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://www.help-doc.top/author/contact/contact.html target=_blank rel=noopener title=www.help-doc.top class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M433.754 420.445c-11.526 1.393-44.86-52.741-44.86-52.741 0 31.345-16.136 72.247-51.051 101.786 16.842 5.192 54.843 19.167 45.803 34.421-7.316 12.343-125.51 7.881-159.632 4.037-34.122 3.844-152.316 8.306-159.632-4.037-9.045-15.25 28.918-29.214 45.783-34.415-34.92-29.539-51.059-70.445-51.059-101.792 0 0-33.334 54.134-44.859 52.741-5.37-.65-12.424-29.644 9.347-99.704 10.261-33.024 21.995-60.478 40.144-105.779C60.683 98.063 108.982.006 224 0c113.737.006 163.156 96.133 160.264 214.963 18.118 45.223 29.912 72.85 40.144 105.778 21.768 70.06 14.716 99.053 9.346 99.704"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["navigation.indexes", "navigation.prune", "navigation.tabs", "search.highlight", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script> <script src=../../../assets/javascripts/bundle.c8b220af.min.js></script> <script src=../../../javascripts/katex.min.js></script> <script src=../../../javascripts/other.min.js></script> <script src=../../../javascripts/copyright.min.js></script> <script src=../../../javascripts/waline.min.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/contrib/auto-render.min.js></script> <script src=https://cdn.jsdelivr.net/npm/mermaid@11.5.0/dist/mermaid.min.js></script> <script src=../../../assets/javascripts/toggle-sidebar.js async></script> <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body> </html>