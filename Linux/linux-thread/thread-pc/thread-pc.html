<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://www.help-doc.top/Linux/linux-thread/thread-pc/thread-pc.html><link rel=prev href=../thread-semaphore/thread-semaphore.html><link rel=next href=../log/log.html><link rel=icon href=../../../images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.12"><title>生产者消费者模型（Producer-Consumer Model） - 柯懒的知识库</title><link rel=stylesheet href=../../../assets/stylesheets/main.2afb09e1.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.06af60db.min.css><link rel=stylesheet href=../../../css/timeline.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-9XWRGNRRSY"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-9XWRGNRRSY",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-9XWRGNRRSY",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script><link rel=stylesheet href=../../../stylesheets/colors.min.css><link rel=stylesheet href=../../../stylesheets/theme2.min.css media="screen and (max-width: 1199px)"><link rel=stylesheet href=../../../stylesheets/theme2.min.css media="screen and (min-width: 1200px)" id=theme2-desktop><link rel=stylesheet href=../../../stylesheets/theme1.min.css media="screen and (min-width: 1200px)" id=theme1-desktop><link rel=stylesheet href=../../../stylesheets/print.min.css><link rel=stylesheet href=../../../stylesheets/font-dongguanti.min.css id=font-dongguanti><link rel=stylesheet href=../../../stylesheets/font-oppoti.min.css id=font-oppoti disabled><link rel=stylesheet href=../../../stylesheets/font-jiangchengti.min.css id=font-jiangchengti disabled><link rel=stylesheet href=../../../stylesheets/font-lxgw.min.css id=font-lxgw disabled><link rel=stylesheet href=../../../stylesheets/code-font-dejavu-sans-mono.min.css id=code-font-dejavu-sans-mono><link rel=stylesheet href=../../../stylesheets/code-font-zsft-hk.min.css id=code-font-zsft-hk disabled><link rel=stylesheet href=https://unpkg.com/@waline/client@v3/dist/waline.css><link rel=stylesheet href=../../../stylesheets/waline.min.css><script src=https://cdn.jsdelivr.net/npm/mermaid@11.5.0/dist/mermaid.min.js></script><script src=../../../javascripts/start.min.js></script><script type=module src=../../../javascripts/waline.min.js></script> <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../assets/javascripts/glightbox.min.js"></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=cyan> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#producer-consumer-model class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../../index.html title=柯懒的知识库 class="md-header__button md-logo" aria-label=柯懒的知识库 data-md-component=logo> <img src=../../../assets/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> 柯懒的知识库 </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> 生产者消费者模型（Producer-Consumer Model） </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=cyan aria-label type=radio name=__palette id=__palette_1> </form> <!-- 头像元素 - 直接在HTML中定义 --> <div class=header-avatar> <img src=../../../author/作者.assets/20250206-200653.jpg alt=头像> <div class=avatar-dropdown> <p><strong>柯懒不是柯南</strong></p> <a href=../../../author/contact/contact.html class=avatar-dropdown-item>吵醒柯懒</a> <div class=avatar-dropdown-divider></div> <a href=../../../author/about/about.html class=avatar-dropdown-item>柯懒自传</a> <div class=avatar-dropdown-divider></div> <a href=https://github.com/H0308 class=avatar-dropdown-item>柯懒的零食库</a> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=查找> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <!-- 独立的切换按钮 --> <div class=toolbar-toggle-btn id=toolbarToggleBtn onclick=toggleToolbar()> <div class=toggle-icon> <svg class=toggle-arrow-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=16 height=16> <path d="M346.538667 1024L170.666667 853.333333l341.333333-341.333333-341.333333-341.333333 175.872-170.666667L853.333333 512z" fill=currentColor></path> </svg> </div> </div> <!-- 右侧固定功能条 - 独立于内容区 --> <div class=floating-toolbar id=floatingToolbar> <!-- 字体切换功能 --> <div class="toolbar-item font-switcher"> <div class=toolbar-icon> <svg class=font-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=20 height=20> <path d="M913.408 1024l-66.56 0q-29.696 0-51.2-5.12t-36.864-15.872-26.112-27.136-19.968-37.888q-15.36-38.912-28.16-70.656t-22.016-55.296q-11.264-26.624-20.48-49.152l-254.976 0q-7.168 23.552-17.408 51.2-8.192 23.552-21.504 56.832t-30.72 72.192q-20.48 46.08-47.104 63.488t-60.416 17.408l-70.656 0q-45.056 0-60.928-19.968t2.56-68.096q18.432-46.08 43.008-108.544t52.224-132.608 57.344-143.872 57.344-144.384q65.536-164.864 137.216-343.04 7.168-17.408 18.432-31.744 10.24-11.264 27.136-21.504t42.496-10.24q26.624 0 43.52 10.752t28.16 24.064q12.288 15.36 19.456 33.792 72.704 180.224 138.24 345.088 27.648 70.656 57.344 143.872t56.832 142.336 51.2 129.536 41.472 104.448q14.336 34.816 4.096 62.464t-43.008 27.648zM616.448 634.88l-97.28-347.136-1.024 0-108.544 347.136 206.848 0z" fill=currentColor></path> </svg> </div> <div class=toolbar-label>内容字体</div> <div class=font-dropdown-toolbar> <div class=font-current-toolbar onclick=toggleFontDropdownToolbar()> <span class=current-font-name-toolbar>东观体</span> <svg class=dropdown-arrow-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=12 height=12> <path d="M878.592 250.88q29.696 0 48.128 11.264t24.576 29.696 0 41.472-26.624 45.568q-82.944 92.16-159.744 180.224t-148.48 164.864q-19.456 20.48-45.568 31.744t-53.76 11.776-53.248-8.704-43.008-28.672q-39.936-44.032-82.944-90.112l-88.064-92.16q-43.008-46.08-85.504-90.624t-79.36-86.528q-17.408-19.456-22.528-40.448t1.024-38.4 23.552-28.672 45.056-11.264q35.84 0 98.816-0.512t137.728-0.512l153.6 0 150.528 0 125.952 0 79.872 0z" fill=currentColor></path> </svg> </div> <div class=font-options-toolbar> <div class=font-option-toolbar data-font=dongguanti onclick="selectFontToolbar('dongguanti')">上图东观体 </div> <div class=font-option-toolbar data-font=oppoti onclick="selectFontToolbar('oppoti')">OPPO Sans </div> <div class=font-option-toolbar data-font=jiangchengti onclick="selectFontToolbar('jiangchengti')"> 江城黑体</div> <div class=font-option-toolbar data-font=lxgw onclick="selectFontToolbar('lxgw')">霞鹜臻楷</div> </div> </div> </div> <!-- 代码字体切换功能 --> <div class="toolbar-item code-font-switcher"> <div class=toolbar-icon> <svg t=1753672111433 class="icon code-font-icon" viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg p-id=5148 width=20 height=20> <path d="M941.709938 0H82.290062A82.290062 82.290062 0 0 0 0 82.290062v859.419876A82.290062 82.290062 0 0 0 82.290062 1022.53923h859.419876A82.290062 82.290062 0 0 0 1022.53923 941.709938V82.290062A82.290062 82.290062 0 0 0 941.709938 0zM188.439372 553.631954a40.901569 40.901569 0 0 1-29.215406-70.116975L292.154066 351.558726 159.223966 218.628626a40.901569 40.901569 0 0 1 58.430813-57.94389l160.197813 162.145507a40.901569 40.901569 0 0 1 0 57.943889l-160.197813 160.684736a40.901569 40.901569 0 0 1-29.215407 12.173086z m443.587257 0H405.120304a40.901569 40.901569 0 0 1 0-82.290061H633.000476a40.901569 40.901569 0 0 1 0 82.290061z" fill=currentColor p-id=5149></path> </svg> </div> <div class=toolbar-label>代码字体</div> <div class=code-font-dropdown-toolbar> <div class=code-font-current-toolbar onclick=toggleCodeFontDropdownToolbar()> <span class=current-code-font-name-toolbar>DejaVu Sans Mono</span> <svg class=dropdown-arrow-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=12 height=12> <path d="M878.592 250.88q29.696 0 48.128 11.264t24.576 29.696 0 41.472-26.624 45.568q-82.944 92.16-159.744 180.224t-148.48 164.864q-19.456 20.48-45.568 31.744t-53.76 11.776-53.248-8.704-43.008-28.672q-39.936-44.032-82.944-90.112l-88.064-92.16q-43.008-46.08-85.504-90.624t-79.36-86.528q-17.408-19.456-22.528-40.448t1.024-38.4 23.552-28.672 45.056-11.264q35.84 0 98.816-0.512t137.728-0.512l153.6 0 150.528 0 125.952 0 79.872 0z" fill=currentColor></path> </svg> </div> <div class=code-font-options-toolbar> <div class=code-font-option-toolbar data-code-font=dejavu onclick="selectCodeFontToolbar('dejavu')"> DejaVu Sans Mono</div> <div class=code-font-option-toolbar data-code-font=zsft onclick="selectCodeFontToolbar('zsft')"> JetBrains Mono</div> </div> </div> </div> <!-- 主题切换功能 --> <div class="toolbar-item theme-switcher" onclick=switchTheme()> <div class=toolbar-icon> <svg class=theme-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=20 height=20> <path d="M876.572788 522.301623c-1.886977 12.375865-9.657964 30.331819-35.880185 45.48903-56.489572 32.697703-150.21828 83.990926-174.010149 96.958262-13.143345 24.431435-66.067718 122.221646-98.141204 178.503487-16.117073 28.124548-36.055171 34.041304-50.030463 34.041304-0.031722 0-0.031722 0-0.031722 0-14.613836 0-29.1806-6.460132-43.234687-19.218714-47.183626-42.643216-125.994576-117.105115-146.013515-136.083351-27.757181-4.732791-138.338718-23.743774-200.584388-35.752272-17.924231-3.533476-32.649608-14.07046-40.372499-29.084409-5.78782-11.256368-10.281157-30.05962 1.471514-55.658647 26.989701-59.047838 74.126254-157.557432 85.957721-182.196599-3.437286-27.117614-16.996093-135.060045-23.760147-198.905142-1.886977-17.460674 3.901867-35.096333 15.829524-48.351218 12.791327-14.278191 30.667463-21.48943 49.854455-19.426445 63.669088 6.332219 173.259042 19.426445 200.584388 22.705118 24.335245-11.879562 121.085776-58.936297 180.133613-86.34146 9.91379-4.573155 19.85828-6.92369 29.596062-6.92369 28.748764 0 52.172243 20.642133 58.328453 51.421136 12.599969 62.997799 30.93864 166.70272 35.639708 193.484689 18.851347 19.682271 91.953272 96.031147 135.060045 143.07151C872.72004 487.125473 879.307062 504.71406 876.572788 522.301623L876.572788 522.301623zM825.375755 499.085876C776.017604 445.314205 687.245791 352.977193 686.365748 352.017332c-2.942005-3.069919-4.956895-6.971785-5.676279-11.208273-0.207731-1.215688-22.193465-127.001509-36.551474-198.936865-0.799202-3.917216-4.285606-16.836457-16.196891-16.836457-3.453658 0-7.30743 1.006933-11.464099 2.942005-67.282383 31.179117-183.955662 88.180342-185.170327 88.771813-3.693112 1.790786-7.850805 2.558265-11.975752 2.01489-1.295506-0.224104-133.63765-16.165168-205.988468-23.424502-0.079818 0-0.207731 0-0.287549 0-7.30743 0-11.128455 2.89391-13.319353 5.40408-3.677762 4.124947-5.644557 9.91379-5.068436 15.110139 7.674796 72.623018 24.255427 202.934922 24.463158 204.325595 0.511653 4.109598-0.159636 8.266267-1.966795 11.960403-0.591471 1.215688-57.657164 120.04712-88.339977 187.201589-3.565199 7.754614-4.41352 14.214746-2.350534 18.131963 1.935072 3.725858 6.588045 5.820566 10.360975 6.53995 70.719668 13.718443 204.644867 36.519752 206.036563 36.727483 4.189416 0.671289 8.058536 2.686179 11.112082 5.580089 1.006933 0.87902 96.414887 91.281983 150.090367 139.889027 8.314363 7.563256 13.143345 8.106632 14.437827 8.106632 3.485381 0 8.314363-4.621251 12.727882-12.391215 36.343743-63.828724 100.011808-181.988868 100.636025-183.155437 1.983167-3.64604 5.004991-6.667863 8.650007-8.650007 1.134847-0.671289 114.418936-62.373583 178.6314-99.516528 8.698103-5.036713 14.278191-10.568706 14.94948-14.854313C834.681702 511.845481 831.49922 505.800811 825.375755 499.085876L825.375755 499.085876zM935.333076 935.670256c-4.157693 4.157693-9.689686 6.299473-15.141862 6.299473-5.548366 0-11.048637-2.142803-15.238053-6.299473l-171.915441-171.915441c-8.362458-8.394181-8.362458-21.98471 0-30.426987 8.394181-8.394181 21.98471-8.394181 30.379914 0l171.915441 171.915441C943.727257 913.684522 943.727257 927.275052 935.333076 935.670256L935.333076 935.670256z" fill=currentColor></path> </svg> </div> <div class=toolbar-label>主题切换</div> </div> <!-- 返回顶部功能 --> <div class="toolbar-item back-to-top" onclick=scrollToTop()> <div class=toolbar-icon> <svg class=back-to-top-icon viewbox="0 0 1024 1024" xmlns=http://www.w3.org/2000/svg> <path d="M882.688 624.128l-336.896-583.68c-15.872-27.136-54.784-27.136-70.656 0L138.24 624.128c-15.872 27.136 4.096 61.44 35.328 61.44H317.44c22.528 0 40.96 18.432 40.96 40.96v239.616c0 22.528 18.432 40.96 40.96 40.96h223.232c22.528 0 40.96-18.432 40.96-40.96v-239.616c0-22.528 18.432-40.96 40.96-40.96h143.872c30.208 0 50.176-34.304 34.304-61.44z"> </path> </svg> </div> <div class=toolbar-label>返回顶部</div> </div> </div> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../index.html class=md-tabs__link> 主页 </a> </li> <li class=md-tabs__item> <a href=../../../intro/intro.html class=md-tabs__link> 网站介绍 </a> </li> <li class=md-tabs__item> <a href=../../../timeline/timeline.html class=md-tabs__link> 网站时间线 </a> </li> <li class=md-tabs__item> <a href=../../../c-lang/index.html class=md-tabs__link> 编程语言 </a> </li> <li class=md-tabs__item> <a href=../../../data-structure/time-space-complexity/time-space-complexity.html class=md-tabs__link> 数据结构与算法 </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../options-commands/options-commands.html class=md-tabs__link> Linux </a> </li> <li class=md-tabs__item> <a href=../../../html-css/html/html.html class=md-tabs__link> 前端 </a> </li> <li class=md-tabs__item> <a href=../../../MySQL/JDBC/JDBC-basic/JDBC-basic.html class=md-tabs__link> MySQL </a> </li> <li class=md-tabs__item> <a href=../../../JavaEE/Spring/springmvc-basic/springmvc-basic.html class=md-tabs__link> JavaEE应用开发 </a> </li> <li class=md-tabs__item> <a href=../../../other/shell/shell.html class=md-tabs__link> 扩展知识 </a> </li> <li class=md-tabs__item> <a href=../../../tooltips/vscode-snippets/vscode-snippets.html class=md-tabs__link> 工具帮助 </a> </li> <li class=md-tabs__item> <a href=../../../projects/boost-searching-engine/boost-searching-engine.html class=md-tabs__link> 项目 </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../index.html title=柯懒的知识库 class="md-nav__button md-logo" aria-label=柯懒的知识库 data-md-component=logo> <img src=../../../assets/logo.png alt=logo> </a> 柯懒的知识库 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../index.html class=md-nav__link> <span class=md-ellipsis> 主页 </span> </a> </li> <li class=md-nav__item> <a href=../../../intro/intro.html class=md-nav__link> <span class=md-ellipsis> 网站介绍 </span> </a> </li> <li class=md-nav__item> <a href=../../../timeline/timeline.html class=md-nav__link> <span class=md-ellipsis> 网站时间线 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../c-lang/index.html class=md-nav__link> <span class=md-ellipsis> 编程语言 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../data-structure/time-space-complexity/time-space-complexity.html class=md-nav__link> <span class=md-ellipsis> 数据结构与算法 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6 checked> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex> <span class=md-ellipsis> Linux </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=true> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../options-commands/options-commands.html class=md-nav__link> <span class=md-ellipsis> Linux常用选项和指令 </span> </a> </li> <li class=md-nav__item> <a href=../../permission/permission.html class=md-nav__link> <span class=md-ellipsis> Linux权限相关 </span> </a> </li> <li class=md-nav__item> <a href=../../software-installation/software-installation.html class=md-nav__link> <span class=md-ellipsis> CentOS软件安装 </span> </a> </li> <li class=md-nav__item> <a href=../../gcc-gdb/gcc-gdb.html class=md-nav__link> <span class=md-ellipsis> Linux下的gcc与gdb </span> </a> </li> <li class=md-nav__item> <a href=../../makefile-progress-bar/makefile-progress-bar.html class=md-nav__link> <span class=md-ellipsis> Linux下的Makefile与进度条程序 </span> </a> </li> <li class=md-nav__item> <a href=../../os-basic/os-basic.html class=md-nav__link> <span class=md-ellipsis> 操作系统基础知识 </span> </a> </li> <li class=md-nav__item> <a href=../../process-basic/process-basic.html class=md-nav__link> <span class=md-ellipsis> Linux进程基础 </span> </a> </li> <li class=md-nav__item> <a href=../../process-state-priority/process-state-priority.html class=md-nav__link> <span class=md-ellipsis> Linux进程状态与进程优先级 </span> </a> </li> <li class=md-nav__item> <a href=../../process-switch-scheduling/process-switch-scheduling.html class=md-nav__link> <span class=md-ellipsis> Linux进程切换以及调度算法 </span> </a> </li> <li class=md-nav__item> <a href=../../command-line-env/command-line-env.html class=md-nav__link> <span class=md-ellipsis> Linux命令行与环境变量 </span> </a> </li> <li class=md-nav__item> <a href=../../process-address-space/process-address-space.html class=md-nav__link> <span class=md-ellipsis> Linux进程地址空间 </span> </a> </li> <li class=md-nav__item> <a href=../../process-control/process-control.html class=md-nav__link> <span class=md-ellipsis> Linux进程控制 </span> </a> </li> <li class=md-nav__item> <a href=../../linux-fileop/linux-fileop.html class=md-nav__link> <span class=md-ellipsis> Linux文件操作基础 </span> </a> </li> <li class=md-nav__item> <a href=../../io-process/io-process.html class=md-nav__link> <span class=md-ellipsis> Linux中输入和输出基本过程 </span> </a> </li> <li class=md-nav__item> <a href=../../file-system/file-system.html class=md-nav__link> <span class=md-ellipsis> Linux文件系统 </span> </a> </li> <li class=md-nav__item> <a href=../../soft-hard-link/soft-hard-link.html class=md-nav__link> <span class=md-ellipsis> Linux软链接和硬链接 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../com-process/com-anonymous-pipe/com-anonymous-pipe.html class=md-nav__link> <span class=md-ellipsis> Linux进程间通信 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../../signals-os-principles/signals-os-principles.html class=md-nav__link> <span class=md-ellipsis> Linux信号与操作系统原理 </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_19 checked> <label class=md-nav__link for=__nav_6_19 id=__nav_6_19_label tabindex=0> <span class=md-ellipsis> Linux线程 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_19_label aria-expanded=true> <label class=md-nav__title for=__nav_6_19> <span class="md-nav__icon md-icon"></span> Linux线程 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../thread-concept-op/thread-concept-op.html class=md-nav__link> <span class=md-ellipsis> Linux线程概念与线程操作 </span> </a> </li> <li class=md-nav__item> <a href=../thread-lib/thread-lib.html class=md-nav__link> <span class=md-ellipsis> Linux线程库与线程库封装 </span> </a> </li> <li class=md-nav__item> <a href=../thread-sync/thread-sync.html class=md-nav__link> <span class=md-ellipsis> Linux线程互斥与同步 </span> </a> </li> <li class=md-nav__item> <a href=../thread-semaphore/thread-semaphore.html class=md-nav__link> <span class=md-ellipsis> Linux线程与信号量 </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> 生产者消费者模型（Producer-Consumer Model） </span> <span class="md-nav__icon md-icon"></span> </label> <a href=thread-pc.html class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> 生产者消费者模型（Producer-Consumer Model） </span> </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 基本介绍 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 阻塞队列版本介绍 </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> （阻塞队列）基于线程同步与互斥实现基于单生产者单消费者的生产消费模型 </span> </a> <nav class=md-nav aria-label=（阻塞队列）基于线程同步与互斥实现基于单生产者单消费者的生产消费模型> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 设计阻塞队列 </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 设计主逻辑 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> （阻塞队列）基于线程同步与互斥实现基于多生产者多消费者的生产消费模型 </span> </a> <nav class=md-nav aria-label=（阻塞队列）基于线程同步与互斥实现基于多生产者多消费者的生产消费模型> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 简易版多生产者多消费者模型+潜在问题解决 </span> </a> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> 解决多个线程访问同一个数据的问题 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_9 class=md-nav__link> <span class=md-ellipsis> 循环队列版本介绍 </span> </a> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> <span class=md-ellipsis> （循环队列）基于信号量实现基于单生产者单消费者的生产消费模型 </span> </a> <nav class=md-nav aria-label=（循环队列）基于信号量实现基于单生产者单消费者的生产消费模型> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_11 class=md-nav__link> <span class=md-ellipsis> 设计循环队列 </span> </a> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> <span class=md-ellipsis> 设计主逻辑 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_13 class=md-nav__link> <span class=md-ellipsis> （循环队列）基于信号量实现基于多生产者多消费者的生产消费模型 </span> </a> </li> <li class=md-nav__item> <a href=#_14 class=md-nav__link> <span class=md-ellipsis> （循环队列+泛型）基于信号量实现基于多生产者多消费者的生产消费模型 </span> </a> </li> <li class=md-nav__item> <a href=#_15 class=md-nav__link> <span class=md-ellipsis> 阻塞队列版本与循环队列版本比较 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../log/log.html class=md-nav__link> <span class=md-ellipsis> 日志系统 </span> </a> </li> <li class=md-nav__item> <a href=../thread-safe-deadlock/thread-safe-deadlock.html class=md-nav__link> <span class=md-ellipsis> Linux线程安全与死锁 </span> </a> </li> <li class=md-nav__item> <a href=../thread-pool/thread-pool.html class=md-nav__link> <span class=md-ellipsis> Linux线程池 </span> </a> </li> <li class=md-nav__item> <a href=../thread-rw/thread-rw.html class=md-nav__link> <span class=md-ellipsis> 读者写者问题与读写锁 </span> </a> </li> <li class=md-nav__item> <a href=../thread-spin/thread-spin.html class=md-nav__link> <span class=md-ellipsis> 自旋锁 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../net-basic/net-basic.html class=md-nav__link> <span class=md-ellipsis> 网络基础知识 </span> </a> </li> <li class=md-nav__item> <a href=../../socket-basic/socket-basic.html class=md-nav__link> <span class=md-ellipsis> Socket编程基础 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../udp/udp-basic/udp-basic.html class=md-nav__link> <span class=md-ellipsis> UDP编程 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../../tcp-basic/tcp-basic.html class=md-nav__link> <span class=md-ellipsis> TCP编程接口基本使用 </span> </a> </li> <li class=md-nav__item> <a href=../../serialization-net-cal/serialization-net-cal.html class=md-nav__link> <span class=md-ellipsis> 序列化和反序列化与网络计算器 </span> </a> </li> <li class=md-nav__item> <a href=../../process-relationship-daemon/process-relationship-daemon.html class=md-nav__link> <span class=md-ellipsis> 进程间关系和守护进程 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../http/http-basic-httpserver/http-basic-httpserver.html class=md-nav__link> <span class=md-ellipsis> 应用层协议HTTP </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../../udp-principles/udp-principles.html class=md-nav__link> <span class=md-ellipsis> UDP协议原理 </span> </a> </li> <li class=md-nav__item> <a href=../../tcp-principles/tcp-principles.html class=md-nav__link> <span class=md-ellipsis> TCP协议原理 </span> </a> </li> <li class=md-nav__item> <a href=../../tcp-connection-backlog/tcp-connection-backlog.html class=md-nav__link> <span class=md-ellipsis> 理解Linux如何看待连接以及TCP全连接队列 </span> </a> </li> <li class=md-nav__item> <a href=../../ip/ip.html class=md-nav__link> <span class=md-ellipsis> 网络层IP协议 </span> </a> </li> <li class=md-nav__item> <a href=../../datalink/datalink.html class=md-nav__link> <span class=md-ellipsis> 数据链路层协议 </span> </a> </li> <li class=md-nav__item> <a href=../../dns-icmp/dns-icmp.html class=md-nav__link> <span class=md-ellipsis> DNS与ICMP </span> </a> </li> <li class=md-nav__item> <a href=../../nat-proxy/nat-proxy.html class=md-nav__link> <span class=md-ellipsis> NAT技术、代理服务器和内网穿透 </span> </a> </li> <li class=md-nav__item> <a href=../../io-model-select-poll/io-model-select-poll.html class=md-nav__link> <span class=md-ellipsis> 五种IO模型与select和poll分别实现多路转接 </span> </a> </li> <li class=md-nav__item> <a href=../../epoll/epoll.html class=md-nav__link> <span class=md-ellipsis> epoll实现多路转接 </span> </a> </li> <li class=md-nav__item> <a href=../../reactor-et/reactor-et.html class=md-nav__link> <span class=md-ellipsis> Reactor模式与完善基于边缘触发模式epoll实现TCP服务器 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../html-css/html/html.html class=md-nav__link> <span class=md-ellipsis> 前端 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../MySQL/JDBC/JDBC-basic/JDBC-basic.html class=md-nav__link> <span class=md-ellipsis> MySQL </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../JavaEE/Spring/springmvc-basic/springmvc-basic.html class=md-nav__link> <span class=md-ellipsis> JavaEE应用开发 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../other/shell/shell.html class=md-nav__link> <span class=md-ellipsis> 扩展知识 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../tooltips/vscode-snippets/vscode-snippets.html class=md-nav__link> <span class=md-ellipsis> 工具帮助 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../projects/boost-searching-engine/boost-searching-engine.html class=md-nav__link> <span class=md-ellipsis> 项目 </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 基本介绍 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 阻塞队列版本介绍 </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> （阻塞队列）基于线程同步与互斥实现基于单生产者单消费者的生产消费模型 </span> </a> <nav class=md-nav aria-label=（阻塞队列）基于线程同步与互斥实现基于单生产者单消费者的生产消费模型> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 设计阻塞队列 </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 设计主逻辑 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> （阻塞队列）基于线程同步与互斥实现基于多生产者多消费者的生产消费模型 </span> </a> <nav class=md-nav aria-label=（阻塞队列）基于线程同步与互斥实现基于多生产者多消费者的生产消费模型> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 简易版多生产者多消费者模型+潜在问题解决 </span> </a> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> 解决多个线程访问同一个数据的问题 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_9 class=md-nav__link> <span class=md-ellipsis> 循环队列版本介绍 </span> </a> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> <span class=md-ellipsis> （循环队列）基于信号量实现基于单生产者单消费者的生产消费模型 </span> </a> <nav class=md-nav aria-label=（循环队列）基于信号量实现基于单生产者单消费者的生产消费模型> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_11 class=md-nav__link> <span class=md-ellipsis> 设计循环队列 </span> </a> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> <span class=md-ellipsis> 设计主逻辑 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_13 class=md-nav__link> <span class=md-ellipsis> （循环队列）基于信号量实现基于多生产者多消费者的生产消费模型 </span> </a> </li> <li class=md-nav__item> <a href=#_14 class=md-nav__link> <span class=md-ellipsis> （循环队列+泛型）基于信号量实现基于多生产者多消费者的生产消费模型 </span> </a> </li> <li class=md-nav__item> <a href=#_15 class=md-nav__link> <span class=md-ellipsis> 阻塞队列版本与循环队列版本比较 </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=producer-consumer-model>生产者消费者模型（Producer-Consumer Model）<a class=headerlink href=#producer-consumer-model title="Permanent link">&para;</a></h1> <div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;"> <p><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 5201 个字 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 530 行代码 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 3 张图片 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 24 分钟</p> </div> <h2 id=_1>基本介绍<a class=headerlink href=#_1 title="Permanent link">&para;</a></h2> <p>生产者消费者模型（或称生产消费模型）是一种常见的多线程并发控制模型，用于解决共享资源冲突问题。在这个模型中，存在着两种角色：</p> <ol> <li>生产者：表示数据的提供方或者数据的来源</li> <li>消费者：表示数据的接收方或者数据的处理</li> </ol> <p>基本过程是在一个程序中生产和消费产品，两个行为分别对应着两个线程，一个线程负责生产，一个线程负责消费，并且消费模式为：生产一个产品紧接着消费一个产品，不可以产生同时生产和同时消费，基本示意图如下：</p> <p><a class=glightbox href="5. 生产者消费者模型（Producer-Consumer Model）.assets/image-20250213202112977.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="5. 生产者消费者模型（Producer-Consumer Model）.assets/image-20250213202112977.png"></a></p> <p>因为存在着两个角色，所以本质上存在着3种关系：</p> <ol> <li>生产者与生产者：即同一任务的多个线程，因为彼此都执行着同一个任务（将数据放置到仓库中），所以彼此是互斥的</li> <li>消费者与消费者：即同一任务的多个线程，因为彼此都执行着同一个任务（从仓库中取出数据），所以彼此是互斥的</li> <li>生产者和消费者：执行不同任务的两个线程，当任意一个线程正在访问仓库时，另外一个线程不可以访问仓库，此时是互斥的。另外，为了保证消费者和生产者交替工作，还需要保证二者是同步的</li> </ol> <p>综上，生产消费模型本质遵循着「321」原则：</p> <ol> <li>3种角色关系</li> <li>2个角色</li> <li>1个交易场所</li> </ol> <p>在下面的实现中，先实现阻塞队列版本，再实现循环队列版本</p> <h2 id=_2>阻塞队列版本介绍<a class=headerlink href=#_2 title="Permanent link">&para;</a></h2> <p>生产消费模型就是通过一个容器来解决生产者和消费者的强耦合问题。具体来说就是生产者和消费者彼此之间不直接通讯，而通过阻塞队列（即交易场所）来进行通讯，所以生产者生产完数据之后不用等待消费者处理，直接扔进阻塞队列，消费者不找生产者要数据，而是直接从阻塞队列里取，阻塞队列就相当于一个缓冲区，平衡了生产者和消费者的处理能力。这个阻塞队列就是用来给生产者和消费者解耦的</p> <p>在本次实现中，首先考虑实现只有一个生产者和只有一个消费者的模式（单生产者单消费者），再进一步扩展到多生产者和多消费者的模式</p> <h2 id=_3>（阻塞队列）基于线程同步与互斥实现基于单生产者单消费者的生产消费模型<a class=headerlink href=#_3 title="Permanent link">&para;</a></h2> <h3 id=_4>设计阻塞队列<a class=headerlink href=#_4 title="Permanent link">&para;</a></h3> <p>首先设计生产者和消费者的交易场所，对于这个阻塞队列来说，其要实现的功能实际上主要就只有两个，一个是生产者放入数据，另外一个是消费者读取数据。本次考虑底层使用到C++的队列结构作为阻塞队列的底层结构，所以基本代码结构如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-1><span class=k>class</span><span class=w> </span><span class=nc>BlockQueue</span>
</span><span id=__span-0-2><span class=p>{</span>
</span><span id=__span-0-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-0-4><span class=w>    </span><span class=n>BlockQueue</span><span class=p>()</span>
</span><span id=__span-0-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-0-6><span class=w>    </span><span class=p>}</span>
</span><span id=__span-0-7>
</span><span id=__span-0-8><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>pushData</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>data</span><span class=p>)</span>
</span><span id=__span-0-9><span class=w>    </span><span class=p>{</span>
</span><span id=__span-0-10><span class=w>        </span><span class=n>_bq</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
</span><span id=__span-0-11><span class=w>    </span><span class=p>}</span>
</span><span id=__span-0-12>
</span><span id=__span-0-13><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>popData</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=o>*</span><span class=n>out</span><span class=p>)</span>
</span><span id=__span-0-14><span class=w>    </span><span class=p>{</span>
</span><span id=__span-0-15><span class=w>        </span><span class=o>*</span><span class=n>out</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_bq</span><span class=p>.</span><span class=n>front</span><span class=p>();</span>
</span><span id=__span-0-16><span class=w>        </span><span class=n>_bq</span><span class=p>.</span><span class=n>pop</span><span class=p>();</span>
</span><span id=__span-0-17><span class=w>    </span><span class=p>}</span>
</span><span id=__span-0-18>
</span><span id=__span-0-19><span class=w>    </span><span class=o>~</span><span class=n>BlockQueue</span><span class=p>()</span>
</span><span id=__span-0-20><span class=w>    </span><span class=p>{</span>
</span><span id=__span-0-21><span class=w>    </span><span class=p>}</span>
</span><span id=__span-0-22>
</span><span id=__span-0-23><span class=k>private</span><span class=o>:</span>
</span><span id=__span-0-24><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>queue</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>_bq</span><span class=p>;</span>
</span><span id=__span-0-25><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>接着，既然是交易场所，那么肯定有大小限制，所以阻塞队列一定有最大容量，但是在C++中，队列结构会自动扩容，所以需要一个成员<code>_maxSize</code>表示当前阻塞队列的最大容量，至于这个容量为多少，可以设计为两种：</p> <ol> <li>给定缺省值，并且支持用户自行设定</li> <li>直接写死</li> </ol> <p>本次考虑使用第一种方式。既然有了最大容量和最小容量（即没有任何数据），那么在插入和获取数据时一定要保证插入时阻塞队列不为满以及获取时阻塞队列不为空，所以还需要提供两个接口分别判断当前阻塞队列是否是满状态或者空状态，因为这两个接口只需要类内使用，所以可以考虑直接作为类内成员函数：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-1-1><span class=k>private</span><span class=o>:</span>
</span><span id=__span-1-2><span class=w>    </span><span class=kt>bool</span><span class=w> </span><span class=n>isFull</span><span class=p>()</span>
</span><span id=__span-1-3><span class=w>    </span><span class=p>{</span>
</span><span id=__span-1-4><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>_bq</span><span class=p>.</span><span class=n>size</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>_maxSize</span><span class=p>;</span>
</span><span id=__span-1-5><span class=w>    </span><span class=p>}</span>
</span><span id=__span-1-6>
</span><span id=__span-1-7><span class=w>    </span><span class=kt>bool</span><span class=w> </span><span class=n>isEmpty</span><span class=p>()</span>
</span><span id=__span-1-8><span class=w>    </span><span class=p>{</span>
</span><span id=__span-1-9><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>_bq</span><span class=p>.</span><span class=n>empty</span><span class=p>();</span>
</span><span id=__span-1-10><span class=w>    </span><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>对应地需要修改插入和获取函数。对于这两个函数，考虑下面的思路：</p> <ol> <li>插入数据函数：如果阻塞队列为满，说明此时不允许插入，那么一旦有线程调用插入函数判断当前阻塞队列已满就可以考虑进入等待，直到下一次阻塞队列为空时再唤醒其中一个生产线程。这种思路的好处是，一旦插入线程被唤醒，那么此时阻塞队列一定是至少有一个空位置插入数据的，而因为只唤醒了一个生产线程，所以也只会插入一个数据，空间是完全足够的，此时当前线程离开判满的分支后直接插入数据即可</li> <li>获取数据函数：如果阻塞队列为空，说明此时不允许获取数据，那么一旦有线程调用获取函数判断当前阻塞队列已经为空就可以考虑进入等待，直到下一次阻塞队列至少有一个数据时再唤醒其中一个消费线程。这种思路的好处是，一旦获取线程被唤醒，那么此时阻塞队列一定是至少有一个数据，而因为只唤醒了一个插入线程，所以也只会获取到一个数据，所以不会出现为空时获取的情况</li> </ol> <p>根据上面的思路可以看出，需要一把锁和两个条件变量：</p> <ol> <li>一把锁：控制3种关系都实现互斥，保证阻塞队列同一时刻一定只有一个线程在访问</li> <li>两个条件变量：控制生产者和消费者。当生产者插入数据时发现阻塞队列已满，进入等待，一旦消费者获取数据，消费者根据生产者的条件变量唤醒生产者，代表生产者此时可以生产数据；当消费者读取数据时发现阻塞队列为空，进入等待，一旦生产者生产数据，生产者根据消费者的条件变量唤醒消费者，代表消费者此时可以获取数据</li> </ol> <p>另外，为了确保代码的健壮性，可以考虑唤醒前先确定是否对应条件变量下有线程正在等待，可以通过设置两个计数器分别表示当前正在等待的生产者线程个数和消费者线程个数</p> <p>所以修改后的代码如下：</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>下面的代码使用到前面对<a href=https://www.help-doc.top/Linux/linux-thread/thread-sync/thread-sync.html#_6>互斥锁</a>、<a href=https://www.help-doc.top/Linux/linux-thread/thread-sync/thread-sync.html#_10>条件变量</a>的封装</p> </div> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span>
<span class=normal>59</span>
<span class=normal>60</span>
<span class=normal>61</span>
<span class=normal>62</span>
<span class=normal>63</span>
<span class=normal>64</span>
<span class=normal>65</span>
<span class=normal>66</span>
<span class=normal>67</span>
<span class=normal>68</span>
<span class=normal>69</span>
<span class=normal>70</span>
<span class=normal>71</span>
<span class=normal>72</span>
<span class=normal>73</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-2-1><span class=k>class</span><span class=w> </span><span class=nc>BlockQueue</span>
</span><span id=__span-2-2><span class=p>{</span>
</span><span id=__span-2-3><span class=k>private</span><span class=o>:</span>
</span><span id=__span-2-4><span class=w>    </span><span class=kt>bool</span><span class=w> </span><span class=n>isFull</span><span class=p>()</span>
</span><span id=__span-2-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-2-6><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>_bq</span><span class=p>.</span><span class=n>size</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>_maxSize</span><span class=p>;</span>
</span><span id=__span-2-7><span class=w>    </span><span class=p>}</span>
</span><span id=__span-2-8>
</span><span id=__span-2-9><span class=w>    </span><span class=kt>bool</span><span class=w> </span><span class=n>isEmpty</span><span class=p>()</span>
</span><span id=__span-2-10><span class=w>    </span><span class=p>{</span>
</span><span id=__span-2-11><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>_bq</span><span class=p>.</span><span class=n>empty</span><span class=p>();</span>
</span><span id=__span-2-12><span class=w>    </span><span class=p>}</span>
</span><span id=__span-2-13>
</span><span id=__span-2-14><span class=k>public</span><span class=o>:</span>
</span><span id=__span-2-15><span class=w>    </span><span class=n>BlockQueue</span><span class=p>(</span><span class=kt>size_t</span><span class=w> </span><span class=n>maxSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>5</span><span class=p>)</span>
</span><span id=__span-2-16><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=n>_maxSize</span><span class=p>(</span><span class=n>maxSize</span><span class=p>),</span><span class=w> </span><span class=n>_p_wait_num</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span><span class=w> </span><span class=n>_c_wait_num</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-2-17><span class=w>    </span><span class=p>{</span>
</span><span id=__span-2-18><span class=w>    </span><span class=p>}</span>
</span><span id=__span-2-19>
</span><span id=__span-2-20><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>pushData</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>data</span><span class=p>)</span>
</span><span id=__span-2-21><span class=w>    </span><span class=p>{</span>
</span><span id=__span-2-22><span class=w>        </span><span class=c1>// 插入数据前抢锁</span>
</span><span id=__span-2-23><span class=w>        </span><span class=n>MutexGuard</span><span class=w> </span><span class=nf>mutex</span><span class=p>(</span><span class=n>_lock</span><span class=p>);</span>
</span><span id=__span-2-24><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isFull</span><span class=p>())</span>
</span><span id=__span-2-25><span class=w>        </span><span class=p>{</span>
</span><span id=__span-2-26><span class=w>            </span><span class=n>_p_wait_num</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-2-27><span class=w>            </span><span class=c1>// 满时生产者等待</span>
</span><span id=__span-2-28><span class=w>            </span><span class=n>_p_cond</span><span class=p>.</span><span class=n>wait</span><span class=p>(</span><span class=n>_lock</span><span class=p>);</span>
</span><span id=__span-2-29><span class=w>            </span><span class=n>_p_wait_num</span><span class=o>--</span><span class=p>;</span>
</span><span id=__span-2-30><span class=w>        </span><span class=p>}</span>
</span><span id=__span-2-31>
</span><span id=__span-2-32><span class=w>        </span><span class=c1>// 此时一定有空位置</span>
</span><span id=__span-2-33><span class=w>        </span><span class=n>_bq</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
</span><span id=__span-2-34>
</span><span id=__span-2-35><span class=w>        </span><span class=c1>// 通知消费者可以获取数据</span>
</span><span id=__span-2-36><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_c_wait_num</span><span class=p>)</span>
</span><span id=__span-2-37><span class=w>            </span><span class=n>_c_cond</span><span class=p>.</span><span class=n>notify</span><span class=p>();</span>
</span><span id=__span-2-38><span class=w>    </span><span class=p>}</span>
</span><span id=__span-2-39>
</span><span id=__span-2-40><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>popData</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=o>*</span><span class=n>out</span><span class=p>)</span>
</span><span id=__span-2-41><span class=w>    </span><span class=p>{</span>
</span><span id=__span-2-42><span class=w>        </span><span class=c1>// 获取数据前抢锁</span>
</span><span id=__span-2-43><span class=w>        </span><span class=n>MutexGuard</span><span class=w> </span><span class=nf>mutex</span><span class=p>(</span><span class=n>_lock</span><span class=p>);</span>
</span><span id=__span-2-44><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isEmpty</span><span class=p>())</span>
</span><span id=__span-2-45><span class=w>        </span><span class=p>{</span>
</span><span id=__span-2-46><span class=w>            </span><span class=n>_c_wait_num</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-2-47><span class=w>            </span><span class=c1>// 空则等待</span>
</span><span id=__span-2-48><span class=w>            </span><span class=n>_c_cond</span><span class=p>.</span><span class=n>wait</span><span class=p>(</span><span class=n>_lock</span><span class=p>);</span>
</span><span id=__span-2-49><span class=w>            </span><span class=n>_c_wait_num</span><span class=o>--</span><span class=p>;</span>
</span><span id=__span-2-50><span class=w>        </span><span class=p>}</span>
</span><span id=__span-2-51>
</span><span id=__span-2-52><span class=w>        </span><span class=c1>// 此时一定有数据</span>
</span><span id=__span-2-53><span class=w>        </span><span class=o>*</span><span class=n>out</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_bq</span><span class=p>.</span><span class=n>front</span><span class=p>();</span>
</span><span id=__span-2-54><span class=w>        </span><span class=n>_bq</span><span class=p>.</span><span class=n>pop</span><span class=p>();</span>
</span><span id=__span-2-55>
</span><span id=__span-2-56><span class=w>        </span><span class=c1>// 通知生产者可以生成数据</span>
</span><span id=__span-2-57><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_p_wait_num</span><span class=p>)</span>
</span><span id=__span-2-58><span class=w>            </span><span class=n>_p_cond</span><span class=p>.</span><span class=n>notify</span><span class=p>();</span>
</span><span id=__span-2-59><span class=w>    </span><span class=p>}</span>
</span><span id=__span-2-60>
</span><span id=__span-2-61><span class=w>    </span><span class=o>~</span><span class=n>BlockQueue</span><span class=p>()</span>
</span><span id=__span-2-62><span class=w>    </span><span class=p>{</span>
</span><span id=__span-2-63><span class=w>    </span><span class=p>}</span>
</span><span id=__span-2-64>
</span><span id=__span-2-65><span class=k>private</span><span class=o>:</span>
</span><span id=__span-2-66><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>queue</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>_bq</span><span class=p>;</span>
</span><span id=__span-2-67><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>_maxSize</span><span class=p>;</span><span class=w>    </span><span class=c1>// 最大容量</span>
</span><span id=__span-2-68><span class=w>    </span><span class=n>Mutex</span><span class=w> </span><span class=n>_lock</span><span class=p>;</span><span class=w>        </span><span class=c1>// 一把锁</span>
</span><span id=__span-2-69><span class=w>    </span><span class=n>Condition</span><span class=w> </span><span class=n>_p_cond</span><span class=p>;</span><span class=w>  </span><span class=c1>// 生产者条件变量</span>
</span><span id=__span-2-70><span class=w>    </span><span class=n>Condition</span><span class=w> </span><span class=n>_c_cond</span><span class=p>;</span><span class=w>  </span><span class=c1>// 消费者条件变量</span>
</span><span id=__span-2-71><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>_p_wait_num</span><span class=p>;</span><span class=w> </span><span class=c1>// 生产者等待数量</span>
</span><span id=__span-2-72><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>_c_wait_num</span><span class=p>;</span><span class=w> </span><span class=c1>// 消费者等待数量</span>
</span><span id=__span-2-73><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <h3 id=_5>设计主逻辑<a class=headerlink href=#_5 title="Permanent link">&para;</a></h3> <p>在主逻辑中，首先需要让两个线程看到阻塞队列，所以可以考虑将阻塞队列定义为全局变量，如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-3-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;BlockQueue.hpp&quot;</span>
</span><span id=__span-3-2>
</span><span id=__span-3-3><span class=k>using</span><span class=w> </span><span class=k>namespace</span><span class=w> </span><span class=nn>BlockQueueModule</span><span class=p>;</span>
</span><span id=__span-3-4>
</span><span id=__span-3-5><span class=c1>// 阻塞队列</span>
</span><span id=__span-3-6><span class=n>BlockQueue</span><span class=w> </span><span class=n>bq</span><span class=p>;</span>
</span><span id=__span-3-7>
</span><span id=__span-3-8><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-3-9><span class=p>{</span>
</span><span id=__span-3-10>
</span><span id=__span-3-11><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-3-12><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>接着，在主函数中创建一个生产者线程和一个消费者线程，这两个线程分别执行自己的生成函数和消费函数，再启动线程和等待线程：</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>下面的代码使用到前面封装的<a href=https://www.help-doc.top/Linux/linux-thread/thread-lib/thread-lib.html#_4>线程库</a></p> </div> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-4-1><span class=kt>void</span><span class=w> </span><span class=nf>producer</span><span class=p>()</span>
</span><span id=__span-4-2><span class=p>{</span>
</span><span id=__span-4-3><span class=p>}</span>
</span><span id=__span-4-4>
</span><span id=__span-4-5><span class=kt>void</span><span class=w> </span><span class=nf>consumer</span><span class=p>()</span>
</span><span id=__span-4-6><span class=p>{</span>
</span><span id=__span-4-7><span class=p>}</span>
</span><span id=__span-4-8>
</span><span id=__span-4-9><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-4-10><span class=p>{</span>
</span><span id=__span-4-11><span class=w>    </span><span class=c1>// 创建生产者线程</span>
</span><span id=__span-4-12><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>pro</span><span class=p>(</span><span class=n>producer</span><span class=p>);</span>
</span><span id=__span-4-13>
</span><span id=__span-4-14><span class=w>    </span><span class=c1>// 创建消费者线程</span>
</span><span id=__span-4-15><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>con</span><span class=p>(</span><span class=n>consumer</span><span class=p>);</span>
</span><span id=__span-4-16>
</span><span id=__span-4-17><span class=w>    </span><span class=c1>// 启动两个线程</span>
</span><span id=__span-4-18><span class=w>    </span><span class=n>pro</span><span class=p>.</span><span class=n>start</span><span class=p>();</span>
</span><span id=__span-4-19><span class=w>    </span><span class=n>con</span><span class=p>.</span><span class=n>start</span><span class=p>();</span>
</span><span id=__span-4-20>
</span><span id=__span-4-21><span class=w>    </span><span class=c1>// 等待两个线程</span>
</span><span id=__span-4-22><span class=w>    </span><span class=n>pro</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-4-23><span class=w>    </span><span class=n>con</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-4-24>
</span><span id=__span-4-25><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-4-26><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>在生产者的执行函数<code>producer</code>中，考虑让生产者持续生产数据，并且为了能看到生成的数据差异，可以考虑每一次生产完数据后改变该数据；在消费者的执行函数<code>consumer</code>中，考虑让消费者持续读取数据，代码如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-5-1><span class=kt>void</span><span class=w> </span><span class=nf>producer</span><span class=p>()</span>
</span><span id=__span-5-2><span class=p>{</span>
</span><span id=__span-5-3><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span>
</span><span id=__span-5-4><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-5-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-5-6><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-5-7>
</span><span id=__span-5-8><span class=w>        </span><span class=n>bq</span><span class=p>.</span><span class=n>pushData</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
</span><span id=__span-5-9><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;生产者：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>pthread_self</span><span class=p>()</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>1000</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;生产了一个数据：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-5-10>
</span><span id=__span-5-11><span class=w>        </span><span class=n>data</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span>
</span><span id=__span-5-12><span class=w>    </span><span class=p>}</span>
</span><span id=__span-5-13><span class=p>}</span>
</span><span id=__span-5-14>
</span><span id=__span-5-15><span class=kt>void</span><span class=w> </span><span class=nf>consumer</span><span class=p>()</span>
</span><span id=__span-5-16><span class=p>{</span>
</span><span id=__span-5-17><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-5-18><span class=w>    </span><span class=p>{</span>
</span><span id=__span-5-19><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-5-20>
</span><span id=__span-5-21><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-5-22><span class=w>        </span><span class=n>bq</span><span class=p>.</span><span class=n>popData</span><span class=p>(</span><span class=o>&amp;</span><span class=n>data</span><span class=p>);</span>
</span><span id=__span-5-23>
</span><span id=__span-5-24><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;消费者：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>pthread_self</span><span class=p>()</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>1000</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;获取到一个数据：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-5-25><span class=w>    </span><span class=p>}</span>
</span><span id=__span-5-26><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>编译运行上面的代码即可看到生产者先生产数据，消费者再拿数据，二者有序进行：</p> <p><a class=glightbox href="5. 生产者消费者模型（Producer-Consumer Model）.assets\Snipaste_2025-02-13_21-52-54.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="5. 生产者消费者模型（Producer-Consumer Model）.assets\Snipaste_2025-02-13_21-52-54.png"></a></p> <h2 id=_6>（阻塞队列）基于线程同步与互斥实现基于多生产者多消费者的生产消费模型<a class=headerlink href=#_6 title="Permanent link">&para;</a></h2> <h3 id=_7>简易版多生产者多消费者模型+潜在问题解决<a class=headerlink href=#_7 title="Permanent link">&para;</a></h3> <p>完成单生产单消费的生产消费模型后，推广到多生产多消费模型最容易考虑到的思路就是直接添加线程个数，并且在唤醒线程时不是唤醒其中一个线程而是唤醒所有生产或者消费线程进行生产或者消费，在这种情况下实现多生产多消费下的生产消费模型对应的代码如下：</p> <div class="tabbed-set tabbed-alternate" data-tabs=1:3><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><input id=__tabbed_1_2 name=__tabbed_1 type=radio><input id=__tabbed_1_3 name=__tabbed_1 type=radio><div class=tabbed-labels><label for=__tabbed_1_1>主函数</label><label for=__tabbed_1_2>阻塞队列插入函数</label><label for=__tabbed_1_3>阻塞队列获取函数</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-6-1><span class=c1>// ...</span>
</span><span id=__span-6-2><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-6-3><span class=p>{</span>
</span><span id=__span-6-4><span class=w>    </span><span class=c1>// 创建生产者线程</span>
</span><span id=__span-6-5><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>pro1</span><span class=p>(</span><span class=n>producer</span><span class=p>);</span>
</span><span id=__span-6-6><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>pro2</span><span class=p>(</span><span class=n>producer</span><span class=p>);</span>
</span><span id=__span-6-7><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>pro3</span><span class=p>(</span><span class=n>producer</span><span class=p>);</span>
</span><span id=__span-6-8>
</span><span id=__span-6-9><span class=w>    </span><span class=c1>// 创建消费者线程</span>
</span><span id=__span-6-10><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>con1</span><span class=p>(</span><span class=n>consumer</span><span class=p>);</span>
</span><span id=__span-6-11><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>con2</span><span class=p>(</span><span class=n>consumer</span><span class=p>);</span>
</span><span id=__span-6-12><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>con3</span><span class=p>(</span><span class=n>consumer</span><span class=p>);</span>
</span><span id=__span-6-13>
</span><span id=__span-6-14><span class=w>    </span><span class=c1>// 启动多个线程</span>
</span><span id=__span-6-15><span class=w>    </span><span class=n>pro1</span><span class=p>.</span><span class=n>start</span><span class=p>();</span>
</span><span id=__span-6-16><span class=w>    </span><span class=n>pro2</span><span class=p>.</span><span class=n>start</span><span class=p>();</span>
</span><span id=__span-6-17><span class=w>    </span><span class=n>pro3</span><span class=p>.</span><span class=n>start</span><span class=p>();</span>
</span><span id=__span-6-18><span class=w>    </span><span class=n>con1</span><span class=p>.</span><span class=n>start</span><span class=p>();</span>
</span><span id=__span-6-19><span class=w>    </span><span class=n>con2</span><span class=p>.</span><span class=n>start</span><span class=p>();</span>
</span><span id=__span-6-20><span class=w>    </span><span class=n>con3</span><span class=p>.</span><span class=n>start</span><span class=p>();</span>
</span><span id=__span-6-21>
</span><span id=__span-6-22><span class=w>    </span><span class=c1>// 等待多个线程</span>
</span><span id=__span-6-23><span class=w>    </span><span class=n>pro1</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-6-24><span class=w>    </span><span class=n>pro2</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-6-25><span class=w>    </span><span class=n>pro3</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-6-26><span class=w>    </span><span class=n>con1</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-6-27><span class=w>    </span><span class=n>con2</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-6-28><span class=w>    </span><span class=n>con3</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-6-29>
</span><span id=__span-6-30><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-6-31><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-7-1><span class=kt>void</span><span class=w> </span><span class=nf>pushData</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>data</span><span class=p>)</span>
</span><span id=__span-7-2><span class=p>{</span>
</span><span id=__span-7-3><span class=w>    </span><span class=c1>// 插入数据前抢锁</span>
</span><span id=__span-7-4><span class=w>    </span><span class=n>MutexGuard</span><span class=w> </span><span class=n>mutex</span><span class=p>(</span><span class=n>_lock</span><span class=p>);</span>
</span><span id=__span-7-5><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isFull</span><span class=p>())</span>
</span><span id=__span-7-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-7-7><span class=w>        </span><span class=n>_p_wait_num</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-7-8><span class=w>        </span><span class=c1>// 满时生产者等待</span>
</span><span id=__span-7-9><span class=w>        </span><span class=n>_p_cond</span><span class=p>.</span><span class=n>wait</span><span class=p>(</span><span class=n>_lock</span><span class=p>);</span>
</span><span id=__span-7-10><span class=w>        </span><span class=n>_p_wait_num</span><span class=o>--</span><span class=p>;</span>
</span><span id=__span-7-11><span class=w>    </span><span class=p>}</span>
</span><span id=__span-7-12>
</span><span id=__span-7-13><span class=w>    </span><span class=c1>// 此时一定有空位置</span>
</span><span id=__span-7-14><span class=w>    </span><span class=n>_bq</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
</span><span id=__span-7-15>
</span><span id=__span-7-16><span class=w>    </span><span class=c1>// 通知消费者可以获取数据</span>
</span><span id=__span-7-17><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_c_wait_num</span><span class=p>)</span>
</span><span id=__span-7-18><span class=w>        </span><span class=n>_c_cond</span><span class=p>.</span><span class=n>notify</span><span class=p>();</span>
</span><span id=__span-7-19><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-8-1><span class=kt>void</span><span class=w> </span><span class=nf>popData</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=o>*</span><span class=n>out</span><span class=p>)</span>
</span><span id=__span-8-2><span class=p>{</span>
</span><span id=__span-8-3><span class=w>    </span><span class=c1>// 获取数据前抢锁</span>
</span><span id=__span-8-4><span class=w>    </span><span class=n>MutexGuard</span><span class=w> </span><span class=n>mutex</span><span class=p>(</span><span class=n>_lock</span><span class=p>);</span>
</span><span id=__span-8-5><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isEmpty</span><span class=p>())</span>
</span><span id=__span-8-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-8-7><span class=w>        </span><span class=n>_c_wait_num</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-8-8><span class=w>        </span><span class=c1>// 空则等待</span>
</span><span id=__span-8-9><span class=w>        </span><span class=n>_c_cond</span><span class=p>.</span><span class=n>wait</span><span class=p>(</span><span class=n>_lock</span><span class=p>);</span>
</span><span id=__span-8-10><span class=w>        </span><span class=n>_c_wait_num</span><span class=o>--</span><span class=p>;</span>
</span><span id=__span-8-11><span class=w>    </span><span class=p>}</span>
</span><span id=__span-8-12>
</span><span id=__span-8-13><span class=w>    </span><span class=c1>// 此时一定有数据</span>
</span><span id=__span-8-14><span class=w>    </span><span class=o>*</span><span class=n>out</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_bq</span><span class=p>.</span><span class=n>front</span><span class=p>();</span>
</span><span id=__span-8-15><span class=w>    </span><span class=n>_bq</span><span class=p>.</span><span class=n>pop</span><span class=p>();</span>
</span><span id=__span-8-16>
</span><span id=__span-8-17><span class=w>    </span><span class=c1>// 通知生产者可以生成数据</span>
</span><span id=__span-8-18><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_p_wait_num</span><span class=p>)</span>
</span><span id=__span-8-19><span class=w>        </span><span class=n>_p_cond</span><span class=p>.</span><span class=n>notify</span><span class=p>();</span>
</span><span id=__span-8-20><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>运行上面的代码会发现貌似没有什么问题，生产者生产一个数据，消费者消费一个数据，但是其实上面的代码还潜藏着一个问题：如果插入函数或者获取函数的<code>wait</code>函数并没有成功让线程进行等待，但是又释放了线程的锁。此时就会出现一种伪唤醒的状态，即本应该等待的线程却被唤醒了，并且这个线程因为没有锁继续向后执行，此时如果已经有一个线程被正常唤醒并且阻塞队列又刚好只有一个空间就会出现问题</p> <p>为了解决上面提到的问题，可以考虑将<code>if</code>改成<code>while</code>，此时尽管会存在等待问题，因为下一次还是会进行条件判断，如果条件成立依旧会进入等待逻辑。修改后的代码如下：</p> <div class="tabbed-set tabbed-alternate" data-tabs=2:2><input checked=checked id=__tabbed_2_1 name=__tabbed_2 type=radio><input id=__tabbed_2_2 name=__tabbed_2 type=radio><div class=tabbed-labels><label for=__tabbed_2_1>阻塞队列插入函数</label><label for=__tabbed_2_2>阻塞队列获取函数</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-9-1><span class=kt>void</span><span class=w> </span><span class=nf>pushData</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>data</span><span class=p>)</span>
</span><span id=__span-9-2><span class=p>{</span>
</span><span id=__span-9-3><span class=w>    </span><span class=c1>// 插入数据前抢锁</span>
</span><span id=__span-9-4><span class=w>    </span><span class=n>MutexGuard</span><span class=w> </span><span class=n>mutex</span><span class=p>(</span><span class=n>_lock</span><span class=p>);</span>
</span><span id=__span-9-5><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>isFull</span><span class=p>())</span>
</span><span id=__span-9-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-9-7><span class=w>        </span><span class=n>_p_wait_num</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-9-8><span class=w>        </span><span class=c1>// 满时生产者等待</span>
</span><span id=__span-9-9><span class=w>        </span><span class=n>_p_cond</span><span class=p>.</span><span class=n>wait</span><span class=p>(</span><span class=n>_lock</span><span class=p>);</span>
</span><span id=__span-9-10><span class=w>        </span><span class=n>_p_wait_num</span><span class=o>--</span><span class=p>;</span>
</span><span id=__span-9-11><span class=w>    </span><span class=p>}</span>
</span><span id=__span-9-12>
</span><span id=__span-9-13><span class=w>    </span><span class=c1>// 此时一定有空位置</span>
</span><span id=__span-9-14><span class=w>    </span><span class=n>_bq</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
</span><span id=__span-9-15>
</span><span id=__span-9-16><span class=w>    </span><span class=c1>// 通知消费者可以获取数据</span>
</span><span id=__span-9-17><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_c_wait_num</span><span class=p>)</span>
</span><span id=__span-9-18><span class=w>        </span><span class=n>_c_cond</span><span class=p>.</span><span class=n>notify</span><span class=p>();</span>
</span><span id=__span-9-19><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-10-1><span class=kt>void</span><span class=w> </span><span class=nf>popData</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=o>*</span><span class=n>out</span><span class=p>)</span>
</span><span id=__span-10-2><span class=p>{</span>
</span><span id=__span-10-3><span class=w>    </span><span class=c1>// 获取数据前抢锁</span>
</span><span id=__span-10-4><span class=w>    </span><span class=n>MutexGuard</span><span class=w> </span><span class=n>mutex</span><span class=p>(</span><span class=n>_lock</span><span class=p>);</span>
</span><span id=__span-10-5><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>isEmpty</span><span class=p>())</span>
</span><span id=__span-10-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-10-7><span class=w>        </span><span class=n>_c_wait_num</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-10-8><span class=w>        </span><span class=c1>// 空则等待</span>
</span><span id=__span-10-9><span class=w>        </span><span class=n>_c_cond</span><span class=p>.</span><span class=n>wait</span><span class=p>(</span><span class=n>_lock</span><span class=p>);</span>
</span><span id=__span-10-10><span class=w>        </span><span class=n>_c_wait_num</span><span class=o>--</span><span class=p>;</span>
</span><span id=__span-10-11><span class=w>    </span><span class=p>}</span>
</span><span id=__span-10-12>
</span><span id=__span-10-13><span class=w>    </span><span class=c1>// 此时一定有数据</span>
</span><span id=__span-10-14><span class=w>    </span><span class=o>*</span><span class=n>out</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_bq</span><span class=p>.</span><span class=n>front</span><span class=p>();</span>
</span><span id=__span-10-15><span class=w>    </span><span class=n>_bq</span><span class=p>.</span><span class=n>pop</span><span class=p>();</span>
</span><span id=__span-10-16>
</span><span id=__span-10-17><span class=w>    </span><span class=c1>// 通知生产者可以生成数据</span>
</span><span id=__span-10-18><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_p_wait_num</span><span class=p>)</span>
</span><span id=__span-10-19><span class=w>        </span><span class=n>_p_cond</span><span class=p>.</span><span class=n>notify</span><span class=p>();</span>
</span><span id=__span-10-20><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <h3 id=_8>解决多个线程访问同一个数据的问题<a class=headerlink href=#_8 title="Permanent link">&para;</a></h3> <p>在上面的多生产多消费的生产消费模型中，存在的一个问题就是「多个生产者生产同一个数据或者多个消费者消费同一个数据」，这个问题本质就是因为生产线程的执行函数中<code>data</code>是一个局部变量，因为每个线程都会有自己的栈帧空间，所以<code>data</code>本质在多个线程中是独立的，所以起始时都会从10开始，导致每一次都是同一个值</p> <p>解决这个问题也很简单，只需要将<code>data</code>变量作为全局变量即可：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-11-1><span class=kt>int</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-11-2>
</span><span id=__span-11-3><span class=kt>void</span><span class=w> </span><span class=nf>producer</span><span class=p>()</span>
</span><span id=__span-11-4><span class=p>{</span>
</span><span id=__span-11-5><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-11-6><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h2 id=_9>循环队列版本介绍<a class=headerlink href=#_9 title="Permanent link">&para;</a></h2> <p>循环队列版本的生产消费模型本质就是利用了信号量实现并发处理，在前面的阻塞队列版本，不论是单生产、消费线程版本还是多生产、消费线程版本，都无法做到生产的同时消费，但是实际上如果可以支持边生产边消费且生产一定在消费之前就可以一定程度上提高整个模型的并发性，从而提高效率，而循环队列版本的生产消费模型就可以解决这个问题</p> <p>所谓的循环队列就是一种首尾相连的队列结构，在<a href=https://www.help-doc.top/algorithm/stack-queue/stack-queue-basic/stack-queue-basic.html#622>算法：栈和队列基础练习</a>中提到过循环队列的设计，其中最主要关注的问题就是为空和为满如何区别以及如何处理环形。实际上，在本次实现中，只需要考虑如何处理环形即可，对于为空和为满只需要通过信号量进行控制，下面是具体分析：</p> <p>因为生产消费模型中存在两个对象，为了使二者可以同时进行就必须要两个指针，定义为<code>produce</code>和<code>consume</code>，刚开始时，<code>produce</code>和<code>consume</code>指针指向同一个位置，如果是在设计循环队列中，此时需要考虑<code>produce</code>和<code>consume</code>能否指向同一位置，如果指向同一个位置如何区分为空和为满，而在有信号量之后，假设信号量的值表示当前循环队列还剩余的空间个数，考虑一种思路：</p> <ol> <li>生产者执行生产操作，此时就申请生产者信号量，代表<code>P</code>操作。如果循环队列没有满（生产者信号量不为0），那么就可以正常生产数据并更新<code>produce</code>指针向后移动，否则就可以唤醒消费者进行消费，而唤醒消费者的行为就是<code>V</code>操作，因为要增加消费者的信号量</li> <li>消费者执行消费操作，此时就申请消费者信号量，代表<code>P</code>操作。如果循环队列不为空（消费者信号量不为0），那么就可以正常消费数据并更新<code>consume</code>指针向后移动，否则就需要唤醒生产者进行生产，而唤醒生产者的行为就是<code>V</code>操作，因为要增加生产者的信号量</li> </ol> <p>这样，生产者和消费者就是交替执行，并且初始化时，只要保证生产者的信号量不为0，消费者的信号量为0，就可以保证不需要进行判断空和判断满的操作，因为如果生产者先运行，那么循环队列为空时，生产者一定可以生产数据，如果循环队列为满，只有消费者先消费了才会唤醒生产者生产，并且因为是消费者唤醒生产者，让生产者信号量+1，所以一定会有一个空间。在这整个过程中，消费者和生产者的位置情况一定只有两种：</p> <ol> <li>二者处于同一个位置：为空或者为满</li> <li>二者不处于同一个位置：生产者一定在消费者之前，并且二者之间的距离绝对不会形成一个新循环队列（即已经更新数据的位置不会在没被消费之前覆盖）</li> </ol> <p>根据上面的思路，可以抽象出生产者和消费者的逻辑如下：</p> <div class="tabbed-set tabbed-alternate" data-tabs=3:2><input checked=checked id=__tabbed_3_1 name=__tabbed_3 type=radio><input id=__tabbed_3_2 name=__tabbed_3 type=radio><div class=tabbed-labels><label for=__tabbed_3_1>生产者</label><label for=__tabbed_3_2>消费者</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-12-1>P(生产者信号量)
</span><span id=__span-12-2>
</span><span id=__span-12-3>向循环队列插入数据
</span><span id=__span-12-4>更新下标
</span><span id=__span-12-5>
</span><span id=__span-12-6>V(消费者信号量)
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-13-1>P(消费者信号量)
</span><span id=__span-13-2>
</span><span id=__span-13-3>向循环队列插入数据
</span><span id=__span-13-4>更新下标
</span><span id=__span-13-5>
</span><span id=__span-13-6>V(生产者信号量)
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <h2 id=_10>（循环队列）基于信号量实现基于单生产者单消费者的生产消费模型<a class=headerlink href=#_10 title="Permanent link">&para;</a></h2> <h3 id=_11>设计循环队列<a class=headerlink href=#_11 title="Permanent link">&para;</a></h3> <p>本次考虑循环队列底层使用数组实现，所以可以考虑使用vector容器，但是同样因为vector会自动扩容，所以需要一个表示最大容量的成员，并且循环队列需要提供插入数据和获取数据的接口，所以循环队列基本结构如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-14-1><span class=k>class</span><span class=w> </span><span class=nc>CycleQueue</span>
</span><span id=__span-14-2><span class=p>{</span>
</span><span id=__span-14-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-14-4><span class=w>    </span><span class=n>CycleQueue</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>val</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>5</span><span class=p>)</span>
</span><span id=__span-14-5><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=n>_maxSize</span><span class=p>(</span><span class=n>val</span><span class=p>),</span><span class=w> </span><span class=n>_cq</span><span class=p>(</span><span class=n>val</span><span class=p>)</span>
</span><span id=__span-14-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-14-7><span class=w>    </span><span class=p>}</span>
</span><span id=__span-14-8>
</span><span id=__span-14-9><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>pushData</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=o>&amp;</span><span class=n>data</span><span class=p>)</span>
</span><span id=__span-14-10><span class=w>    </span><span class=p>{</span>
</span><span id=__span-14-11><span class=w>    </span><span class=p>}</span>
</span><span id=__span-14-12>
</span><span id=__span-14-13><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>popData</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=o>*</span><span class=n>data</span><span class=p>)</span>
</span><span id=__span-14-14><span class=w>    </span><span class=p>{</span>
</span><span id=__span-14-15><span class=w>    </span><span class=p>}</span>
</span><span id=__span-14-16>
</span><span id=__span-14-17><span class=w>    </span><span class=o>~</span><span class=n>CycleQueue</span><span class=p>()</span>
</span><span id=__span-14-18><span class=w>    </span><span class=p>{</span>
</span><span id=__span-14-19><span class=w>    </span><span class=p>}</span>
</span><span id=__span-14-20>
</span><span id=__span-14-21><span class=k>private</span><span class=o>:</span>
</span><span id=__span-14-22><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>_cq</span><span class=p>;</span>
</span><span id=__span-14-23><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>_maxSize</span><span class=p>;</span>
</span><span id=__span-14-24><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>需要注意，在上面的构造函数中，一定要对数组大小进行初始化，否则数组当前是未开辟空间的状态，直接使用下标会报越界错误</p> </div> <p>接着，根据上面的分析，需要一个生产者指针<code>produce</code>和一个消费者指针<code>consume</code>，二者均初始化为0：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-15-1><span class=n>CycleQueue</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>val</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>5</span><span class=p>)</span>
</span><span id=__span-15-2><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-15-3><span class=w>    </span><span class=p>,</span><span class=w> </span><span class=n>_produce</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-15-4><span class=w>    </span><span class=p>,</span><span class=w> </span><span class=n>_consume</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-15-5><span class=p>{</span>
</span><span id=__span-15-6><span class=p>}</span>
</span><span id=__span-15-7><span class=c1>// ...</span>
</span><span id=__span-15-8><span class=k>private</span><span class=o>:</span>
</span><span id=__span-15-9><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-15-10><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>_produce</span><span class=p>;</span><span class=w>    </span><span class=c1>// 生产者指针</span>
</span><span id=__span-15-11><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>_consume</span><span class=p>;</span><span class=w>    </span><span class=c1>// 消费者指针</span>
</span></code></pre></div></td></tr></table></div> <p>因为需要通过信号量控制生产者和消费者交替运行，所以需要两个信号量，并且生产者一定要先于消费者运行，而生产者信号量表示当前循环队列的空间个数，消费者信号量表示是否存在有效数据，所以生产者信号量初始化为循环队列的容量，表示初始时生产者可以生产数据，消费者信号量初始化为0，表示初始时消费者不可以获取数据。代码如下：</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>需要注意，下面的代码使用到上一节<a href=https://www.help-doc.top/Linux/linux-thread/thread-semaphore/thread-semaphore.html#_10>封装的信号量</a></p> </div> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-16-1><span class=n>CycleQueue</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>val</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>5</span><span class=p>)</span>
</span><span id=__span-16-2><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-16-3><span class=w>    </span><span class=p>,</span><span class=n>_p_sem</span><span class=p>(</span><span class=n>val</span><span class=p>)</span>
</span><span id=__span-16-4><span class=w>    </span><span class=p>,</span><span class=w> </span><span class=n>_c_sem</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-16-5><span class=p>{</span>
</span><span id=__span-16-6><span class=p>}</span>
</span><span id=__span-16-7><span class=c1>// ...</span>
</span><span id=__span-16-8><span class=k>private</span><span class=o>:</span>
</span><span id=__span-16-9><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-16-10><span class=w>    </span><span class=n>Sem</span><span class=w> </span><span class=n>_c_sem</span><span class=p>;</span><span class=w>      </span><span class=c1>// 消费者信号量</span>
</span><span id=__span-16-11><span class=w>    </span><span class=n>Sem</span><span class=w> </span><span class=n>_p_sem</span><span class=p>;</span><span class=w>      </span><span class=c1>// 生产者信号量</span>
</span></code></pre></div></td></tr></table></div> <p>接下来考虑设计插入数据的函数和获取数据的函数</p> <p>对于插入数据的函数来说，当生产者调用该函数时，首先需要申请信号量，接着一旦申请成功，就可以考虑插入数据并更新下标，一系列操作完成之后就可以更新生产者的信号量，对于获取数据的函数也是同理：</p> <div class="tabbed-set tabbed-alternate" data-tabs=4:2><input checked=checked id=__tabbed_4_1 name=__tabbed_4 type=radio><input id=__tabbed_4_2 name=__tabbed_4 type=radio><div class=tabbed-labels><label for=__tabbed_4_1>插入数据</label><label for=__tabbed_4_2>获取数据</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-17-1><span class=kt>void</span><span class=w> </span><span class=nf>pushData</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=o>&amp;</span><span class=n>data</span><span class=p>)</span>
</span><span id=__span-17-2><span class=p>{</span>
</span><span id=__span-17-3><span class=w>    </span><span class=c1>// 申请信号量</span>
</span><span id=__span-17-4><span class=w>    </span><span class=n>_p_sem</span><span class=p>.</span><span class=n>wait</span><span class=p>();</span>
</span><span id=__span-17-5>
</span><span id=__span-17-6><span class=w>    </span><span class=c1>// 申请成功后插入数据</span>
</span><span id=__span-17-7><span class=w>    </span><span class=n>_cq</span><span class=p>[</span><span class=n>_produce</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data</span><span class=p>;</span>
</span><span id=__span-17-8>
</span><span id=__span-17-9><span class=w>    </span><span class=c1>// 更新下标</span>
</span><span id=__span-17-10><span class=w>    </span><span class=n>_produce</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-17-11><span class=w>    </span><span class=n>_produce</span><span class=w> </span><span class=o>%=</span><span class=w> </span><span class=n>_maxSize</span><span class=p>;</span>
</span><span id=__span-17-12>
</span><span id=__span-17-13><span class=w>    </span><span class=c1>// 更新消费者信号量</span>
</span><span id=__span-17-14><span class=w>    </span><span class=n>_c_sem</span><span class=p>.</span><span class=n>signal</span><span class=p>();</span>
</span><span id=__span-17-15><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-18-1><span class=kt>void</span><span class=w> </span><span class=nf>popData</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=o>*</span><span class=n>data</span><span class=p>)</span>
</span><span id=__span-18-2><span class=p>{</span>
</span><span id=__span-18-3><span class=w>    </span><span class=c1>// 申请信号量</span>
</span><span id=__span-18-4><span class=w>    </span><span class=n>_c_sem</span><span class=p>.</span><span class=n>wait</span><span class=p>();</span>
</span><span id=__span-18-5>
</span><span id=__span-18-6><span class=w>    </span><span class=c1>// 申请成功后获取数据</span>
</span><span id=__span-18-7><span class=w>    </span><span class=o>*</span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_cq</span><span class=p>[</span><span class=n>_consume</span><span class=p>];</span>
</span><span id=__span-18-8>
</span><span id=__span-18-9><span class=w>    </span><span class=c1>// 更新下标</span>
</span><span id=__span-18-10><span class=w>    </span><span class=n>_consume</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-18-11><span class=w>    </span><span class=n>_consume</span><span class=w> </span><span class=o>%=</span><span class=w> </span><span class=n>_maxSize</span><span class=p>;</span>
</span><span id=__span-18-12>
</span><span id=__span-18-13><span class=w>    </span><span class=c1>// 更新生产者信号量</span>
</span><span id=__span-18-14><span class=w>    </span><span class=n>_p_sem</span><span class=p>.</span><span class=n>signal</span><span class=p>();</span>
</span><span id=__span-18-15><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <h3 id=_12>设计主逻辑<a class=headerlink href=#_12 title="Permanent link">&para;</a></h3> <p>为了让两个线程看到同一个循环队列，考虑将循环队列对象定义为全局对象：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-19-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;CycleQueue.hpp&quot;</span>
</span><span id=__span-19-2>
</span><span id=__span-19-3><span class=k>using</span><span class=w> </span><span class=k>namespace</span><span class=w> </span><span class=nn>CycleQueueModule</span><span class=p>;</span>
</span><span id=__span-19-4>
</span><span id=__span-19-5><span class=c1>// 循环队列</span>
</span><span id=__span-19-6><span class=n>CycleQueue</span><span class=w> </span><span class=n>cq</span><span class=p>;</span>
</span><span id=__span-19-7>
</span><span id=__span-19-8><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-19-9><span class=p>{</span>
</span><span id=__span-19-10>
</span><span id=__span-19-11><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-19-12><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>分别创建一个生产者线程和一个消费者线程：</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>下面的代码使用到前面封装的<a href=https://www.help-doc.top/Linux/linux-thread/thread-lib/thread-lib.html#_4>线程库</a></p> </div> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-20-1><span class=c1>// #include &quot;BlockQueue.hpp&quot;</span>
</span><span id=__span-20-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;CycleQueue.hpp&quot;</span>
</span><span id=__span-20-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;thread.hpp&quot;</span>
</span><span id=__span-20-4>
</span><span id=__span-20-5><span class=k>using</span><span class=w> </span><span class=k>namespace</span><span class=w> </span><span class=nn>ThreadModule</span><span class=p>;</span>
</span><span id=__span-20-6><span class=k>using</span><span class=w> </span><span class=k>namespace</span><span class=w> </span><span class=nn>CycleQueueModule</span><span class=p>;</span>
</span><span id=__span-20-7>
</span><span id=__span-20-8><span class=c1>// 循环队列</span>
</span><span id=__span-20-9><span class=n>CycleQueue</span><span class=w> </span><span class=n>cq</span><span class=p>;</span>
</span><span id=__span-20-10>
</span><span id=__span-20-11><span class=kt>void</span><span class=w> </span><span class=nf>producer</span><span class=p>()</span>
</span><span id=__span-20-12><span class=p>{</span>
</span><span id=__span-20-13><span class=p>}</span>
</span><span id=__span-20-14>
</span><span id=__span-20-15><span class=kt>void</span><span class=w> </span><span class=nf>consumer</span><span class=p>()</span>
</span><span id=__span-20-16><span class=p>{</span>
</span><span id=__span-20-17><span class=p>}</span>
</span><span id=__span-20-18>
</span><span id=__span-20-19><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-20-20><span class=p>{</span>
</span><span id=__span-20-21><span class=w>    </span><span class=c1>// 创建生产者线程</span>
</span><span id=__span-20-22><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>pro1</span><span class=p>(</span><span class=n>producer</span><span class=p>);</span>
</span><span id=__span-20-23>
</span><span id=__span-20-24><span class=w>    </span><span class=c1>// 创建消费者线程</span>
</span><span id=__span-20-25><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>con1</span><span class=p>(</span><span class=n>consumer</span><span class=p>);</span>
</span><span id=__span-20-26>
</span><span id=__span-20-27><span class=w>    </span><span class=c1>// 启动线程</span>
</span><span id=__span-20-28><span class=w>    </span><span class=n>pro1</span><span class=p>.</span><span class=n>start</span><span class=p>();</span>
</span><span id=__span-20-29><span class=w>    </span><span class=n>con1</span><span class=p>.</span><span class=n>start</span><span class=p>();</span>
</span><span id=__span-20-30>
</span><span id=__span-20-31><span class=w>    </span><span class=c1>// 等待线程结束</span>
</span><span id=__span-20-32><span class=w>    </span><span class=n>pro1</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-20-33><span class=w>    </span><span class=n>con1</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-20-34>
</span><span id=__span-20-35><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-20-36><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>最后，设计生产者线程的执行函数和消费者线程的执行函数，设计思路与阻塞队列部分一致，此处不再赘述：</p> <div class="tabbed-set tabbed-alternate" data-tabs=5:2><input checked=checked id=__tabbed_5_1 name=__tabbed_5 type=radio><input id=__tabbed_5_2 name=__tabbed_5 type=radio><div class=tabbed-labels><label for=__tabbed_5_1>生产者线程的执行函数</label><label for=__tabbed_5_2>消费者线程的执行函数</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-21-1><span class=kt>void</span><span class=w> </span><span class=nf>producer</span><span class=p>()</span>
</span><span id=__span-21-2><span class=p>{</span>
</span><span id=__span-21-3><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-21-4><span class=w>    </span><span class=p>{</span>
</span><span id=__span-21-5><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-21-6>
</span><span id=__span-21-7><span class=w>        </span><span class=n>cq</span><span class=p>.</span><span class=n>pushData</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
</span><span id=__span-21-8><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;生产者放入一个数据：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-21-9><span class=w>        </span><span class=n>data</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span>
</span><span id=__span-21-10><span class=w>    </span><span class=p>}</span>
</span><span id=__span-21-11><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-22-1><span class=kt>void</span><span class=w> </span><span class=nf>consumer</span><span class=p>()</span>
</span><span id=__span-22-2><span class=p>{</span>
</span><span id=__span-22-3><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-22-4><span class=w>    </span><span class=p>{</span>
</span><span id=__span-22-5><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-22-6>
</span><span id=__span-22-7><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>temp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-22-8>
</span><span id=__span-22-9><span class=w>        </span><span class=n>cq</span><span class=p>.</span><span class=n>popData</span><span class=p>(</span><span class=o>&amp;</span><span class=n>temp</span><span class=p>);</span>
</span><span id=__span-22-10>
</span><span id=__span-22-11><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;消费者获取一个数据：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>temp</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-22-12><span class=w>    </span><span class=p>}</span>
</span><span id=__span-22-13><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>编译运行上面的代码就可以看到运行效果为生产者先生产，随后生产者生产一个数据，消费者拿取一个数据：</p> <p><a class=glightbox href="5. 生产者消费者模型（Producer-Consumer Model）.assets\Snipaste_2025-02-17_19-14-49.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="5. 生产者消费者模型（Producer-Consumer Model）.assets\Snipaste_2025-02-17_19-14-49.png"></a></p> <h2 id=_13>（循环队列）基于信号量实现基于多生产者多消费者的生产消费模型<a class=headerlink href=#_13 title="Permanent link">&para;</a></h2> <p>在上一节中已经完成了基于单生产者单消费者的生产消费模型，下面就可以考虑如何将其修改为多生产者多消费者</p> <p>单生产者和单消费者以及多生产者多消费者的共性就是生产者和消费者之间是互斥与同步的关系，从这一方面来看单生产者单消费者的代码也适用于多生产者多消费者，但是在单生产者单消费者的生产消费模型中，如果只有一个生产者，因为在初始化生产者信号量时使用的是循环队列的大小作为资源数量，所以当一个生产者申请了生产者信号量，那么此时生产者信号量就是<code>_maxSize-1</code>，在申请信号量时因为只会有一个生产者而不会有其他生产者申请这个信号量，所以此时不会出现任何问题，但是如果是多个生产者，那么此时一旦生产者信号量足够就会导致多个生产者进入临界区，从而导致数据出现问题。同样，对于多个消费者线程也是如此</p> <p>所以本质问题就是多生产者多消费者的生产模型中还没有处理同种线程之间的互斥关系</p> <p>清楚了单生产者单消费者的生产模型存在的问题后，下面针对这个问题提出一种解决方案：在插入数据以及获取数据函数中的申请信号量之后加锁，在更新另外一种线程的信号量之前解锁：</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>下面的代码使用到前面对<a href=https://www.help-doc.top/Linux/linux-thread/thread-sync/thread-sync.html#_6>互斥锁</a></p> </div> <div class="tabbed-set tabbed-alternate" data-tabs=6:2><input checked=checked id=__tabbed_6_1 name=__tabbed_6 type=radio><input id=__tabbed_6_2 name=__tabbed_6 type=radio><div class=tabbed-labels><label for=__tabbed_6_1>插入数据</label><label for=__tabbed_6_2>获取数据</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-23-1><span class=kt>void</span><span class=w> </span><span class=nf>pushData</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=o>&amp;</span><span class=n>data</span><span class=p>)</span>
</span><span id=__span-23-2><span class=p>{</span>
</span><span id=__span-23-3><span class=w>    </span><span class=c1>// 申请信号量</span>
</span><span id=__span-23-4><span class=w>    </span><span class=n>_p_sem</span><span class=p>.</span><span class=n>wait</span><span class=p>();</span>
</span><span id=__span-23-5>
</span><span id=__span-23-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-23-7><span class=w>        </span><span class=n>MutexGuard</span><span class=w> </span><span class=n>guard</span><span class=p>(</span><span class=n>_p_lock</span><span class=p>);</span>
</span><span id=__span-23-8><span class=w>        </span><span class=c1>// 申请成功后插入数据</span>
</span><span id=__span-23-9><span class=w>        </span><span class=n>_cq</span><span class=p>[</span><span class=n>_produce</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data</span><span class=p>;</span>
</span><span id=__span-23-10>
</span><span id=__span-23-11><span class=w>        </span><span class=c1>// 更新下标</span>
</span><span id=__span-23-12><span class=w>        </span><span class=n>_produce</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-23-13><span class=w>        </span><span class=n>_produce</span><span class=w> </span><span class=o>%=</span><span class=w> </span><span class=n>_maxSize</span><span class=p>;</span>
</span><span id=__span-23-14><span class=w>    </span><span class=p>}</span>
</span><span id=__span-23-15><span class=w>    </span><span class=c1>// 更新消费者信号量</span>
</span><span id=__span-23-16><span class=w>    </span><span class=n>_c_sem</span><span class=p>.</span><span class=n>signal</span><span class=p>();</span>
</span><span id=__span-23-17><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-24-1><span class=kt>void</span><span class=w> </span><span class=nf>popData</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=o>*</span><span class=n>data</span><span class=p>)</span>
</span><span id=__span-24-2><span class=p>{</span>
</span><span id=__span-24-3><span class=w>    </span><span class=c1>// 申请信号量</span>
</span><span id=__span-24-4><span class=w>    </span><span class=n>_c_sem</span><span class=p>.</span><span class=n>wait</span><span class=p>();</span>
</span><span id=__span-24-5>
</span><span id=__span-24-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-24-7><span class=w>        </span><span class=n>MutexGuard</span><span class=w> </span><span class=n>guard</span><span class=p>(</span><span class=n>_c_lock</span><span class=p>);</span>
</span><span id=__span-24-8><span class=w>        </span><span class=c1>// 申请成功后获取数据</span>
</span><span id=__span-24-9><span class=w>        </span><span class=o>*</span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_cq</span><span class=p>[</span><span class=n>_consume</span><span class=p>];</span>
</span><span id=__span-24-10>
</span><span id=__span-24-11><span class=w>        </span><span class=c1>// 更新下标</span>
</span><span id=__span-24-12><span class=w>        </span><span class=n>_consume</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-24-13><span class=w>        </span><span class=n>_consume</span><span class=w> </span><span class=o>%=</span><span class=w> </span><span class=n>_maxSize</span><span class=p>;</span>
</span><span id=__span-24-14><span class=w>    </span><span class=p>}</span>
</span><span id=__span-24-15>
</span><span id=__span-24-16><span class=w>    </span><span class=c1>// 更新生产者信号量</span>
</span><span id=__span-24-17><span class=w>    </span><span class=n>_p_sem</span><span class=p>.</span><span class=n>signal</span><span class=p>();</span>
</span><span id=__span-24-18><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>下面还有一个问题：为什么加锁要在申请信号量之后而不是申请信号量之前</p> <p>这里涉及到一个效率问题，如果是在申请信号量之前加锁，那么就会出现多个生产者或者多个消费者进入对应的执行函数后需要先抢锁，如果抢到锁的就会紧接着申请信号量，但是没有抢到锁的就需要继续等待锁，此时这些没有抢到锁的既没有锁也没有信号量，所以下一次就算抢到锁了还要申请信号量。但若是先获取信号量，那么可以保证多个线程只要信号量足够就可以准备进入临界区，下一次只要有锁就可以直接访问临界区，这样在一定程度上保证了多个线程情况下的并发性</p> <h2 id=_14>（循环队列+泛型）基于信号量实现基于多生产者多消费者的生产消费模型<a class=headerlink href=#_14 title="Permanent link">&para;</a></h2> <p>前面的生产消费模型只是针对数据为<code>int</code>，如果数据为其他类型就会存在类型不匹配的问题，所以为了支持不同的类型，可以考虑使用泛型，以循环队列最终版本为例，将其修改为泛型版本后的整体代码如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span>
<span class=normal>59</span>
<span class=normal>60</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-25-1><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>class</span><span class=w> </span><span class=nc>T</span><span class=o>&gt;</span>
</span><span id=__span-25-2><span class=k>class</span><span class=w> </span><span class=nc>CycleQueue</span>
</span><span id=__span-25-3><span class=p>{</span>
</span><span id=__span-25-4><span class=k>public</span><span class=o>:</span>
</span><span id=__span-25-5><span class=w>    </span><span class=n>CycleQueue</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>val</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>5</span><span class=p>)</span>
</span><span id=__span-25-6><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=n>_maxSize</span><span class=p>(</span><span class=n>val</span><span class=p>),</span><span class=w> </span><span class=n>_cq</span><span class=p>(</span><span class=n>val</span><span class=p>),</span><span class=w> </span><span class=n>_p_sem</span><span class=p>(</span><span class=n>val</span><span class=p>),</span><span class=w> </span><span class=n>_c_sem</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span><span class=w> </span><span class=n>_produce</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span><span class=w> </span><span class=n>_consume</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-25-7><span class=w>    </span><span class=p>{</span>
</span><span id=__span-25-8><span class=w>    </span><span class=p>}</span>
</span><span id=__span-25-9>
</span><span id=__span-25-10><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>pushData</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=o>&amp;</span><span class=n>data</span><span class=p>)</span>
</span><span id=__span-25-11><span class=w>    </span><span class=p>{</span>
</span><span id=__span-25-12><span class=w>        </span><span class=c1>// 申请信号量</span>
</span><span id=__span-25-13><span class=w>        </span><span class=n>_p_sem</span><span class=p>.</span><span class=n>wait</span><span class=p>();</span>
</span><span id=__span-25-14>
</span><span id=__span-25-15><span class=w>        </span><span class=p>{</span>
</span><span id=__span-25-16><span class=w>            </span><span class=n>MutexGuard</span><span class=w> </span><span class=nf>guard</span><span class=p>(</span><span class=n>_p_lock</span><span class=p>);</span>
</span><span id=__span-25-17><span class=w>            </span><span class=c1>// 申请成功后插入数据</span>
</span><span id=__span-25-18><span class=w>            </span><span class=n>_cq</span><span class=p>[</span><span class=n>_produce</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data</span><span class=p>;</span>
</span><span id=__span-25-19>
</span><span id=__span-25-20><span class=w>            </span><span class=c1>// 更新下标</span>
</span><span id=__span-25-21><span class=w>            </span><span class=n>_produce</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-25-22><span class=w>            </span><span class=n>_produce</span><span class=w> </span><span class=o>%=</span><span class=w> </span><span class=n>_maxSize</span><span class=p>;</span>
</span><span id=__span-25-23><span class=w>        </span><span class=p>}</span>
</span><span id=__span-25-24><span class=w>        </span><span class=c1>// 更新消费者信号量</span>
</span><span id=__span-25-25><span class=w>        </span><span class=n>_c_sem</span><span class=p>.</span><span class=n>signal</span><span class=p>();</span>
</span><span id=__span-25-26><span class=w>    </span><span class=p>}</span>
</span><span id=__span-25-27>
</span><span id=__span-25-28><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>popData</span><span class=p>(</span><span class=n>T</span><span class=w> </span><span class=o>*</span><span class=n>data</span><span class=p>)</span>
</span><span id=__span-25-29><span class=w>    </span><span class=p>{</span>
</span><span id=__span-25-30><span class=w>        </span><span class=c1>// 申请信号量</span>
</span><span id=__span-25-31><span class=w>        </span><span class=n>_c_sem</span><span class=p>.</span><span class=n>wait</span><span class=p>();</span>
</span><span id=__span-25-32>
</span><span id=__span-25-33><span class=w>        </span><span class=p>{</span>
</span><span id=__span-25-34><span class=w>            </span><span class=n>MutexGuard</span><span class=w> </span><span class=nf>guard</span><span class=p>(</span><span class=n>_c_lock</span><span class=p>);</span>
</span><span id=__span-25-35><span class=w>            </span><span class=c1>// 申请成功后获取数据</span>
</span><span id=__span-25-36><span class=w>            </span><span class=o>*</span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_cq</span><span class=p>[</span><span class=n>_consume</span><span class=p>];</span>
</span><span id=__span-25-37>
</span><span id=__span-25-38><span class=w>            </span><span class=c1>// 更新下标</span>
</span><span id=__span-25-39><span class=w>            </span><span class=n>_consume</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-25-40><span class=w>            </span><span class=n>_consume</span><span class=w> </span><span class=o>%=</span><span class=w> </span><span class=n>_maxSize</span><span class=p>;</span>
</span><span id=__span-25-41><span class=w>        </span><span class=p>}</span>
</span><span id=__span-25-42>
</span><span id=__span-25-43><span class=w>        </span><span class=c1>// 更新生产者信号量</span>
</span><span id=__span-25-44><span class=w>        </span><span class=n>_p_sem</span><span class=p>.</span><span class=n>signal</span><span class=p>();</span>
</span><span id=__span-25-45><span class=w>    </span><span class=p>}</span>
</span><span id=__span-25-46>
</span><span id=__span-25-47><span class=w>    </span><span class=o>~</span><span class=n>CycleQueue</span><span class=p>()</span>
</span><span id=__span-25-48><span class=w>    </span><span class=p>{</span>
</span><span id=__span-25-49><span class=w>    </span><span class=p>}</span>
</span><span id=__span-25-50>
</span><span id=__span-25-51><span class=k>private</span><span class=o>:</span>
</span><span id=__span-25-52><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>_cq</span><span class=p>;</span>
</span><span id=__span-25-53><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>_maxSize</span><span class=p>;</span><span class=w> </span><span class=c1>// 循环队列最大容量</span>
</span><span id=__span-25-54><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>_produce</span><span class=p>;</span><span class=w>    </span><span class=c1>// 生产者指针</span>
</span><span id=__span-25-55><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>_consume</span><span class=p>;</span><span class=w>    </span><span class=c1>// 消费者指针</span>
</span><span id=__span-25-56><span class=w>    </span><span class=n>Sem</span><span class=w> </span><span class=n>_c_sem</span><span class=p>;</span><span class=w>      </span><span class=c1>// 消费者信号量</span>
</span><span id=__span-25-57><span class=w>    </span><span class=n>Sem</span><span class=w> </span><span class=n>_p_sem</span><span class=p>;</span><span class=w>      </span><span class=c1>// 生产者信号量</span>
</span><span id=__span-25-58><span class=w>    </span><span class=n>Mutex</span><span class=w> </span><span class=n>_c_lock</span><span class=p>;</span><span class=w>   </span><span class=c1>// 消费者锁</span>
</span><span id=__span-25-59><span class=w>    </span><span class=n>Mutex</span><span class=w> </span><span class=n>_p_lock</span><span class=p>;</span><span class=w>   </span><span class=c1>// 生产者锁</span>
</span><span id=__span-25-60><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>使用泛型后就可以使用任意类型包括自定义类型作为数据</p> <h2 id=_15>阻塞队列版本与循环队列版本比较<a class=headerlink href=#_15 title="Permanent link">&para;</a></h2> <p>在阻塞队列版本中，插入数据函数和获取数据函数共用一把互斥锁，此时就导致一次只能一种线程进入阻塞队列，所以结果就是要么生产不消费，要么消费不生产，这在效率上会比较低下，但是在循环队列版本中，因为生产线程和消费线程各自使用各自的锁，所以就保证生产的同时也可以进行消费</p> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title=最后更新> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2025年7月30日</span> </span> <span class=md-source-file__fact> <span class=md-icon title=创建日期> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2025年2月13日</span> </span> </aside> <form class=md-feedback name=feedback hidden> <fieldset> <legend class=md-feedback__title> 页面有帮助吗？ </legend> <div class=md-feedback__inner> <div class=md-feedback__list> <button class="md-feedback__icon md-icon" type=submit title=页面对我有帮助 data-md-value=1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 9v12H1V9zm4 12a2 2 0 0 1-2-2V9c0-.55.22-1.05.59-1.41L14.17 1l1.06 1.06c.27.27.44.64.44 1.05l-.03.32L14.69 8H21a2 2 0 0 1 2 2v2c0 .26-.05.5-.14.73l-3.02 7.05C19.54 20.5 18.83 21 18 21zm0-2h9.03L21 12v-2h-8.79l1.13-5.32L9 9.03z"/></svg> </button> <button class="md-feedback__icon md-icon" type=submit title=页面没有帮助到我 data-md-value=0> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 15V3h4v12zM15 3a2 2 0 0 1 2 2v10c0 .55-.22 1.05-.59 1.41L9.83 23l-1.06-1.06c-.27-.27-.44-.64-.44-1.06l.03-.31.95-4.57H3a2 2 0 0 1-2-2v-2c0-.26.05-.5.14-.73l3.02-7.05C4.46 3.5 5.17 3 6 3zm0 2H5.97L3 12v2h8.78l-1.13 5.32L15 14.97z"/></svg> </button> </div> <div class=md-feedback__note> <div data-md-value=1 hidden> 谢谢你的反馈！ </div> <div data-md-value=0 hidden> 谢谢你的反馈！联系<a href=https://www.help-doc.top/%E4%BD%9C%E8%80%85/%E4%BD%9C%E8%80%85.html>作者</a>提供更详细的信息 </div> </div> </div> </fieldset> </form> <!-- Waline 评论系统 --> <div id=waline></div> <!-- 阅读进度条 - 直接在HTML中定义 --> <div class=reading-progress></div> <!-- 滚动指示器 - 直接在HTML中定义 --> <div class=scroll-indicator></div> <!-- 评论系统 --> <!-- Waline 评论系统 --> <div id=waline></div> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <!--
  Copyright (c) 2016-2024 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!-- Footer --> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2024-2025 柯懒不是柯南 </div> </div> <div class="md-footer-love md-typeset"> 一闪一闪亮晶晶，不及<span class=love-highlight>小亮</span><span class=love-heart>♥</span>照我心。To Li Liang </div> <div class=md-social> <a href=https://github.com/H0308 target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://www.help-doc.top/%E4%BD%9C%E8%80%85/%E4%BD%9C%E8%80%85.html target=_blank rel=noopener title=www.help-doc.top class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M433.754 420.445c-11.526 1.393-44.86-52.741-44.86-52.741 0 31.345-16.136 72.247-51.051 101.786 16.842 5.192 54.843 19.167 45.803 34.421-7.316 12.343-125.51 7.881-159.632 4.037-34.122 3.844-152.316 8.306-159.632-4.037-9.045-15.25 28.918-29.214 45.783-34.415-34.92-29.539-51.059-70.445-51.059-101.792 0 0-33.334 54.134-44.859 52.741-5.37-.65-12.424-29.644 9.347-99.704 10.261-33.024 21.995-60.478 40.144-105.779C60.683 98.063 108.982.006 224 0c113.737.006 163.156 96.133 160.264 214.963 18.118 45.223 29.912 72.85 40.144 105.778 21.768 70.06 14.716 99.053 9.346 99.704"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["navigation.indexes", "navigation.prune", "navigation.tabs", "search.highlight", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script> <script src=../../../assets/javascripts/bundle.c8b220af.min.js></script> <script src=../../../javascripts/katex.min.js></script> <script src=../../../javascripts/other.min.js></script> <script src=../../../javascripts/copyright.min.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/contrib/auto-render.min.js></script> <script src=../../../assets/javascripts/toggle-sidebar.js async></script> <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body> </html>