<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://www.help-doc.top/Linux/tcp-basic/tcp-basic.html><link rel=prev href=../udp/udp-app2/udp-app2.html><link rel=next href=../serialization-net-cal/serialization-net-cal.html><link rel=icon href=../../images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.12"><title>TCP编程接口基本使用 - 柯懒的知识库</title><link rel=stylesheet href=../../assets/stylesheets/main.2afb09e1.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=stylesheet href=../../css/timeline.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-9XWRGNRRSY"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-9XWRGNRRSY",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-9XWRGNRRSY",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script><link rel=stylesheet href=../../stylesheets/colors.min.css><link rel=stylesheet href=../../stylesheets/theme2.min.css media="screen and (max-width: 1199px)"><link rel=stylesheet href=../../stylesheets/theme2.min.css media="screen and (min-width: 1200px)" id=theme2-desktop><link rel=stylesheet href=../../stylesheets/theme1.min.css media="screen and (min-width: 1200px)" id=theme1-desktop><link rel=stylesheet href=../../stylesheets/print.min.css><link rel=stylesheet href=../../stylesheets/font-dongguanti.min.css id=font-dongguanti><link rel=stylesheet href=../../stylesheets/font-oppoti.min.css id=font-oppoti disabled><link rel=stylesheet href=../../stylesheets/font-jiangchengti.min.css id=font-jiangchengti disabled><link rel=stylesheet href=../../stylesheets/font-lxgw.min.css id=font-lxgw disabled><link rel=stylesheet href=../../stylesheets/code-font-dejavu-sans-mono.min.css id=code-font-dejavu-sans-mono><link rel=stylesheet href=../../stylesheets/code-font-zsft-hk.min.css id=code-font-zsft-hk disabled><link rel=stylesheet href=../../stylesheets/code-font-google-sans-code.min.css id=code-font-google-sans-code disabled><link rel=stylesheet href=https://unpkg.com/@waline/client@v3/dist/waline.css><link rel=stylesheet href=../../stylesheets/waline.min.css><script src=../../javascripts/start.min.js></script><link rel=preload href=../../stylesheets/colors.min.css as=style><link rel=preload href=../../stylesheets/theme2.min.css as=style><link rel=preload href=../../javascripts/start.min.js as=script><link rel=preload href=../../assets/logo.png as=image><link rel=preload href=../../images/favicon.png as=image><link rel=preload href=../../author/作者.assets/20250206-200653.jpg as=image><link rel=dns-prefetch href=//unpkg.com><link rel=dns-prefetch href=//cloud.umami.is><script defer src=https://cloud.umami.is/script.js data-website-id=02f9b8b7-93d4-4026-bdd8-221f2fcea2cf></script> <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=cyan> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#tcp class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../index.html title=柯懒的知识库 class="md-header__button md-logo" aria-label=柯懒的知识库 data-md-component=logo> <img src=../../assets/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> 柯懒的知识库 </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> TCP编程接口基本使用 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=cyan aria-label type=radio name=__palette id=__palette_1> </form> <div class=header-avatar> <img src=../../author/作者.assets/20250206-200653.jpg alt=头像> <div class=avatar-dropdown> <p><strong>柯懒不是柯南</strong></p> <a href=../../author/contact/contact.html class=avatar-dropdown-item>联系作者</a> <div class=avatar-dropdown-divider></div> <a href=../../author/about/about.html class=avatar-dropdown-item>关于作者</a> <div class=avatar-dropdown-divider></div> <a href=https://github.com/H0308 class=avatar-dropdown-item>Github仓库</a> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=查找> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=toolbar-toggle-btn id=toolbarToggleBtn onclick=toggleToolbar()> <div class=toggle-icon> <svg class=toggle-arrow-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=16 height=16> <path d="M346.538667 1024L170.666667 853.333333l341.333333-341.333333-341.333333-341.333333 175.872-170.666667L853.333333 512z" fill=currentColor></path> </svg> </div> </div> <div class=floating-toolbar id=floatingToolbar> <div class="toolbar-item font-switcher"> <div class=toolbar-icon> <svg class=font-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=20 height=20> <path d="M913.408 1024l-66.56 0q-29.696 0-51.2-5.12t-36.864-15.872-26.112-27.136-19.968-37.888q-15.36-38.912-28.16-70.656t-22.016-55.296q-11.264-26.624-20.48-49.152l-254.976 0q-7.168 23.552-17.408 51.2-8.192 23.552-21.504 56.832t-30.72 72.192q-20.48 46.08-47.104 63.488t-60.416 17.408l-70.656 0q-45.056 0-60.928-19.968t2.56-68.096q18.432-46.08 43.008-108.544t52.224-132.608 57.344-143.872 57.344-144.384q65.536-164.864 137.216-343.04 7.168-17.408 18.432-31.744 10.24-11.264 27.136-21.504t42.496-10.24q26.624 0 43.52 10.752t28.16 24.064q12.288 15.36 19.456 33.792 72.704 180.224 138.24 345.088 27.648 70.656 57.344 143.872t56.832 142.336 51.2 129.536 41.472 104.448q14.336 34.816 4.096 62.464t-43.008 27.648zM616.448 634.88l-97.28-347.136-1.024 0-108.544 347.136 206.848 0z" fill=currentColor></path> </svg> </div> <div class=toolbar-label>内容字体</div> <div class=font-dropdown-toolbar> <div class=font-current-toolbar onclick=toggleFontDropdownToolbar()> <span class=current-font-name-toolbar>东观体</span> <svg class=dropdown-arrow-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=12 height=12> <path d="M878.592 250.88q29.696 0 48.128 11.264t24.576 29.696 0 41.472-26.624 45.568q-82.944 92.16-159.744 180.224t-148.48 164.864q-19.456 20.48-45.568 31.744t-53.76 11.776-53.248-8.704-43.008-28.672q-39.936-44.032-82.944-90.112l-88.064-92.16q-43.008-46.08-85.504-90.624t-79.36-86.528q-17.408-19.456-22.528-40.448t1.024-38.4 23.552-28.672 45.056-11.264q35.84 0 98.816-0.512t137.728-0.512l153.6 0 150.528 0 125.952 0 79.872 0z" fill=currentColor></path> </svg> </div> <div class=font-options-toolbar> <div class=font-option-toolbar data-font=dongguanti onclick="selectFontToolbar('dongguanti')">上图东观体 </div> <div class=font-option-toolbar data-font=oppoti onclick="selectFontToolbar('oppoti')">OPPO Sans </div> <div class=font-option-toolbar data-font=jiangchengti onclick="selectFontToolbar('jiangchengti')"> 江城黑体</div> <div class=font-option-toolbar data-font=lxgw onclick="selectFontToolbar('lxgw')">霞鹜臻楷</div> </div> </div> </div> <div class="toolbar-item code-font-switcher"> <div class=toolbar-icon> <svg t=1753672111433 class="icon code-font-icon" viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg p-id=5148 width=20 height=20> <path d="M941.709938 0H82.290062A82.290062 82.290062 0 0 0 0 82.290062v859.419876A82.290062 82.290062 0 0 0 82.290062 1022.53923h859.419876A82.290062 82.290062 0 0 0 1022.53923 941.709938V82.290062A82.290062 82.290062 0 0 0 941.709938 0zM188.439372 553.631954a40.901569 40.901569 0 0 1-29.215406-70.116975L292.154066 351.558726 159.223966 218.628626a40.901569 40.901569 0 0 1 58.430813-57.94389l160.197813 162.145507a40.901569 40.901569 0 0 1 0 57.943889l-160.197813 160.684736a40.901569 40.901569 0 0 1-29.215407 12.173086z m443.587257 0H405.120304a40.901569 40.901569 0 0 1 0-82.290061H633.000476a40.901569 40.901569 0 0 1 0 82.290061z" fill=currentColor p-id=5149></path> </svg> </div> <div class=toolbar-label>代码字体</div> <div class=code-font-dropdown-toolbar> <div class=code-font-current-toolbar onclick=toggleCodeFontDropdownToolbar()> <span class=current-code-font-name-toolbar>DejaVu Sans Mono</span> <svg class=dropdown-arrow-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=12 height=12> <path d="M878.592 250.88q29.696 0 48.128 11.264t24.576 29.696 0 41.472-26.624 45.568q-82.944 92.16-159.744 180.224t-148.48 164.864q-19.456 20.48-45.568 31.744t-53.76 11.776-53.248-8.704-43.008-28.672q-39.936-44.032-82.944-90.112l-88.064-92.16q-43.008-46.08-85.504-90.624t-79.36-86.528q-17.408-19.456-22.528-40.448t1.024-38.4 23.552-28.672 45.056-11.264q35.84 0 98.816-0.512t137.728-0.512l153.6 0 150.528 0 125.952 0 79.872 0z" fill=currentColor></path> </svg> </div> <div class=code-font-options-toolbar> <div class=code-font-option-toolbar data-code-font=dejavu onclick="selectCodeFontToolbar('dejavu')"> DejaVu Sans Mono</div> <div class=code-font-option-toolbar data-code-font=google-sans-code onclick="selectCodeFontToolbar('google-sans-code')"> Google Sans Code</div> <div class=code-font-option-toolbar data-code-font=zsft onclick="selectCodeFontToolbar('zsft')"> JetBrains Mono</div> </div> </div> </div> <div class="toolbar-item theme-switcher" onclick=switchTheme()> <div class=toolbar-icon> <svg class=theme-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=20 height=20> <path d="M876.572788 522.301623c-1.886977 12.375865-9.657964 30.331819-35.880185 45.48903-56.489572 32.697703-150.21828 83.990926-174.010149 96.958262-13.143345 24.431435-66.067718 122.221646-98.141204 178.503487-16.117073 28.124548-36.055171 34.041304-50.030463 34.041304-0.031722 0-0.031722 0-0.031722 0-14.613836 0-29.1806-6.460132-43.234687-19.218714-47.183626-42.643216-125.994576-117.105115-146.013515-136.083351-27.757181-4.732791-138.338718-23.743774-200.584388-35.752272-17.924231-3.533476-32.649608-14.07046-40.372499-29.084409-5.78782-11.256368-10.281157-30.05962 1.471514-55.658647 26.989701-59.047838 74.126254-157.557432 85.957721-182.196599-3.437286-27.117614-16.996093-135.060045-23.760147-198.905142-1.886977-17.460674 3.901867-35.096333 15.829524-48.351218 12.791327-14.278191 30.667463-21.48943 49.854455-19.426445 63.669088 6.332219 173.259042 19.426445 200.584388 22.705118 24.335245-11.879562 121.085776-58.936297 180.133613-86.34146 9.91379-4.573155 19.85828-6.92369 29.596062-6.92369 28.748764 0 52.172243 20.642133 58.328453 51.421136 12.599969 62.997799 30.93864 166.70272 35.639708 193.484689 18.851347 19.682271 91.953272 96.031147 135.060045 143.07151C872.72004 487.125473 879.307062 504.71406 876.572788 522.301623L876.572788 522.301623zM825.375755 499.085876C776.017604 445.314205 687.245791 352.977193 686.365748 352.017332c-2.942005-3.069919-4.956895-6.971785-5.676279-11.208273-0.207731-1.215688-22.193465-127.001509-36.551474-198.936865-0.799202-3.917216-4.285606-16.836457-16.196891-16.836457-3.453658 0-7.30743 1.006933-11.464099 2.942005-67.282383 31.179117-183.955662 88.180342-185.170327 88.771813-3.693112 1.790786-7.850805 2.558265-11.975752 2.01489-1.295506-0.224104-133.63765-16.165168-205.988468-23.424502-0.079818 0-0.207731 0-0.287549 0-7.30743 0-11.128455 2.89391-13.319353 5.40408-3.677762 4.124947-5.644557 9.91379-5.068436 15.110139 7.674796 72.623018 24.255427 202.934922 24.463158 204.325595 0.511653 4.109598-0.159636 8.266267-1.966795 11.960403-0.591471 1.215688-57.657164 120.04712-88.339977 187.201589-3.565199 7.754614-4.41352 14.214746-2.350534 18.131963 1.935072 3.725858 6.588045 5.820566 10.360975 6.53995 70.719668 13.718443 204.644867 36.519752 206.036563 36.727483 4.189416 0.671289 8.058536 2.686179 11.112082 5.580089 1.006933 0.87902 96.414887 91.281983 150.090367 139.889027 8.314363 7.563256 13.143345 8.106632 14.437827 8.106632 3.485381 0 8.314363-4.621251 12.727882-12.391215 36.343743-63.828724 100.011808-181.988868 100.636025-183.155437 1.983167-3.64604 5.004991-6.667863 8.650007-8.650007 1.134847-0.671289 114.418936-62.373583 178.6314-99.516528 8.698103-5.036713 14.278191-10.568706 14.94948-14.854313C834.681702 511.845481 831.49922 505.800811 825.375755 499.085876L825.375755 499.085876zM935.333076 935.670256c-4.157693 4.157693-9.689686 6.299473-15.141862 6.299473-5.548366 0-11.048637-2.142803-15.238053-6.299473l-171.915441-171.915441c-8.362458-8.394181-8.362458-21.98471 0-30.426987 8.394181-8.394181 21.98471-8.394181 30.379914 0l171.915441 171.915441C943.727257 913.684522 943.727257 927.275052 935.333076 935.670256L935.333076 935.670256z" fill=currentColor></path> </svg> </div> <div class=toolbar-label>主题切换</div> </div> <div class="toolbar-item back-to-top" onclick=scrollToTop()> <div class=toolbar-icon> <svg class=back-to-top-icon viewbox="0 0 1024 1024" xmlns=http://www.w3.org/2000/svg> <path d="M882.688 624.128l-336.896-583.68c-15.872-27.136-54.784-27.136-70.656 0L138.24 624.128c-15.872 27.136 4.096 61.44 35.328 61.44H317.44c22.528 0 40.96 18.432 40.96 40.96v239.616c0 22.528 18.432 40.96 40.96 40.96h223.232c22.528 0 40.96-18.432 40.96-40.96v-239.616c0-22.528 18.432-40.96 40.96-40.96h143.872c30.208 0 50.176-34.304 34.304-61.44z"> </path> </svg> </div> <div class=toolbar-label>返回顶部</div> </div> </div> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../index.html class=md-tabs__link> 主页 </a> </li> <li class=md-tabs__item> <a href=../../timeline/timeline.html class=md-tabs__link> 网站时间线 </a> </li> <li class=md-tabs__item> <a href=../../languages/index.html class=md-tabs__link> 编程语言 </a> </li> <li class=md-tabs__item> <a href=../../data-structure-algo/index.html class=md-tabs__link> 数据结构与算法 </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../index.html class=md-tabs__link> Linux </a> </li> <li class=md-tabs__item> <a href=../../front-end/index.html class=md-tabs__link> 前端 </a> </li> <li class=md-tabs__item> <a href=../../MySQL/index.html class=md-tabs__link> MySQL </a> </li> <li class=md-tabs__item> <a href=../../JavaEE/index.html class=md-tabs__link> JavaEE应用开发 </a> </li> <li class=md-tabs__item> <a href=../../software-test/index.html class=md-tabs__link> 软件测试 </a> </li> <li class=md-tabs__item> <a href=../../other/index.html class=md-tabs__link> 扩展知识 </a> </li> <li class=md-tabs__item> <a href=../../tooltips/index.html class=md-tabs__link> 工具帮助 </a> </li> <li class=md-tabs__item> <a href=../../test-encrypt/test-encrypt.html class=md-tabs__link> 测试加密功能 </a> </li> <li class=md-tabs__item> <a href=../../projects/index.html class=md-tabs__link> 项目 </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../index.html title=柯懒的知识库 class="md-nav__button md-logo" aria-label=柯懒的知识库 data-md-component=logo> <img src=../../assets/logo.png alt=logo> </a> 柯懒的知识库 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../index.html class=md-nav__link> <span class=md-ellipsis> 主页 </span> </a> </li> <li class=md-nav__item> <a href=../../timeline/timeline.html class=md-nav__link> <span class=md-ellipsis> 网站时间线 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../languages/index.html class=md-nav__link> <span class=md-ellipsis> 编程语言 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../data-structure-algo/index.html class=md-nav__link> <span class=md-ellipsis> 数据结构与算法 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5 checked> <div class="md-nav__link md-nav__container"> <a href=../index.html class="md-nav__link "> <span class=md-ellipsis> Linux </span> </a> <label class="md-nav__link " for=__nav_5 id=__nav_5_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=true> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../options-commands/options-commands.html class=md-nav__link> <span class=md-ellipsis> Linux常用选项和指令 </span> </a> </li> <li class=md-nav__item> <a href=../permission/permission.html class=md-nav__link> <span class=md-ellipsis> Linux权限相关 </span> </a> </li> <li class=md-nav__item> <a href=../software-installation/software-installation.html class=md-nav__link> <span class=md-ellipsis> CentOS软件安装 </span> </a> </li> <li class=md-nav__item> <a href=../gcc-gdb/gcc-gdb.html class=md-nav__link> <span class=md-ellipsis> Linux下的gcc与gdb </span> </a> </li> <li class=md-nav__item> <a href=../makefile-progress-bar/makefile-progress-bar.html class=md-nav__link> <span class=md-ellipsis> Linux下的Makefile与进度条程序 </span> </a> </li> <li class=md-nav__item> <a href=../os-basic/os-basic.html class=md-nav__link> <span class=md-ellipsis> 操作系统基础知识 </span> </a> </li> <li class=md-nav__item> <a href=../process-basic/process-basic.html class=md-nav__link> <span class=md-ellipsis> Linux进程基础 </span> </a> </li> <li class=md-nav__item> <a href=../process-state-priority/process-state-priority.html class=md-nav__link> <span class=md-ellipsis> Linux进程状态与进程优先级 </span> </a> </li> <li class=md-nav__item> <a href=../process-switch-scheduling/process-switch-scheduling.html class=md-nav__link> <span class=md-ellipsis> Linux进程切换以及调度算法 </span> </a> </li> <li class=md-nav__item> <a href=../command-line-env/command-line-env.html class=md-nav__link> <span class=md-ellipsis> Linux命令行与环境变量 </span> </a> </li> <li class=md-nav__item> <a href=../process-address-space/process-address-space.html class=md-nav__link> <span class=md-ellipsis> Linux进程地址空间 </span> </a> </li> <li class=md-nav__item> <a href=../process-control/process-control.html class=md-nav__link> <span class=md-ellipsis> Linux进程控制 </span> </a> </li> <li class=md-nav__item> <a href=../linux-fileop/linux-fileop.html class=md-nav__link> <span class=md-ellipsis> Linux文件操作基础 </span> </a> </li> <li class=md-nav__item> <a href=../io-process/io-process.html class=md-nav__link> <span class=md-ellipsis> Linux中输入和输出基本过程 </span> </a> </li> <li class=md-nav__item> <a href=../file-system/file-system.html class=md-nav__link> <span class=md-ellipsis> Linux文件系统 </span> </a> </li> <li class=md-nav__item> <a href=../soft-hard-link/soft-hard-link.html class=md-nav__link> <span class=md-ellipsis> Linux软链接和硬链接 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../com-process/com-anonymous-pipe/com-anonymous-pipe.html class=md-nav__link> <span class=md-ellipsis> Linux进程间通信 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../signals-os-principles/signals-os-principles.html class=md-nav__link> <span class=md-ellipsis> Linux信号与操作系统原理 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../linux-thread/thread-concept-op/thread-concept-op.html class=md-nav__link> <span class=md-ellipsis> Linux线程 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../net-basic/net-basic.html class=md-nav__link> <span class=md-ellipsis> 网络基础知识 </span> </a> </li> <li class=md-nav__item> <a href=../socket-basic/socket-basic.html class=md-nav__link> <span class=md-ellipsis> Socket编程基础 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../udp/udp-basic/udp-basic.html class=md-nav__link> <span class=md-ellipsis> UDP编程 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> TCP编程接口基本使用 </span> <span class="md-nav__icon md-icon"></span> </label> <a href=tcp-basic.html class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> TCP编程接口基本使用 </span> </a> <nav class="md-nav md-nav--secondary" aria-label=本节目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 本节目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 本篇介绍 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 创建并封装服务端 </span> </a> <nav class=md-nav aria-label=创建并封装服务端> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 创建服务器类 </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 创建服务器套接字 </span> </a> </li> <li class=md-nav__item> <a href=#ip class=md-nav__link> <span class=md-ellipsis> 绑定服务器IP地址和端口 </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 开启服务器监听 </span> </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> 启动服务器 </span> </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 停止服务器 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> 创建并封装客户端 </span> </a> <nav class=md-nav aria-label=创建并封装客户端> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_9 class=md-nav__link> <span class=md-ellipsis> 创建客户端类 </span> </a> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> <span class=md-ellipsis> 创建客户端套接字 </span> </a> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> <span class=md-ellipsis> 启动客户端 </span> </a> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> <span class=md-ellipsis> 停止客户端 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_13 class=md-nav__link> <span class=md-ellipsis> 本地通信测试 </span> </a> </li> <li class=md-nav__item> <a href=#_14 class=md-nav__link> <span class=md-ellipsis> 客户端退出但服务端没有退出的问题 </span> </a> </li> <li class=md-nav__item> <a href=#_15 class=md-nav__link> <span class=md-ellipsis> 文件描述符泄漏问题 </span> </a> </li> <li class=md-nav__item> <a href=#_16 class=md-nav__link> <span class=md-ellipsis> 测试云服务器与本地进行通信 </span> </a> <nav class=md-nav aria-label=测试云服务器与本地进行通信> <ul class=md-nav__list> <li class=md-nav__item> <a href=#linux class=md-nav__link> <span class=md-ellipsis> 相同操作系统（客户端和服务端均为Linux） </span> </a> </li> <li class=md-nav__item> <a href=#windowslinux class=md-nav__link> <span class=md-ellipsis> 不同操作系统（客户端为Windows，服务端为Linux） </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_17 class=md-nav__link> <span class=md-ellipsis> 多个客户端同时连接服务器 </span> </a> <nav class=md-nav aria-label=多个客户端同时连接服务器> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_18 class=md-nav__link> <span class=md-ellipsis> 基本现象 </span> </a> </li> <li class=md-nav__item> <a href=#_19 class=md-nav__link> <span class=md-ellipsis> 子进程版本 </span> </a> </li> <li class=md-nav__item> <a href=#_20 class=md-nav__link> <span class=md-ellipsis> 新线程版本 </span> </a> </li> <li class=md-nav__item> <a href=#_21 class=md-nav__link> <span class=md-ellipsis> 线程池版本 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_22 class=md-nav__link> <span class=md-ellipsis> 客户端控制服务器执行相关命令的程序 </span> </a> <nav class=md-nav aria-label=客户端控制服务器执行相关命令的程序> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_23 class=md-nav__link> <span class=md-ellipsis> 思路分析 </span> </a> </li> <li class=md-nav__item> <a href=#_24 class=md-nav__link> <span class=md-ellipsis> 实现 </span> </a> </li> <li class=md-nav__item> <a href=#_25 class=md-nav__link> <span class=md-ellipsis> 测试 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../serialization-net-cal/serialization-net-cal.html class=md-nav__link> <span class=md-ellipsis> 序列化和反序列化与网络计算器 </span> </a> </li> <li class=md-nav__item> <a href=../process-relationship-daemon/process-relationship-daemon.html class=md-nav__link> <span class=md-ellipsis> 进程间关系和守护进程 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../http/http-basic-httpserver/http-basic-httpserver.html class=md-nav__link> <span class=md-ellipsis> 应用层协议HTTP </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../udp-principles/udp-principles.html class=md-nav__link> <span class=md-ellipsis> UDP协议原理 </span> </a> </li> <li class=md-nav__item> <a href=../tcp-principles/tcp-principles.html class=md-nav__link> <span class=md-ellipsis> TCP协议原理 </span> </a> </li> <li class=md-nav__item> <a href=../tcp-connection-backlog/tcp-connection-backlog.html class=md-nav__link> <span class=md-ellipsis> 理解Linux如何看待连接以及TCP全连接队列 </span> </a> </li> <li class=md-nav__item> <a href=../ip/ip.html class=md-nav__link> <span class=md-ellipsis> 网络层IP协议 </span> </a> </li> <li class=md-nav__item> <a href=../datalink/datalink.html class=md-nav__link> <span class=md-ellipsis> 数据链路层协议 </span> </a> </li> <li class=md-nav__item> <a href=../dns-icmp/dns-icmp.html class=md-nav__link> <span class=md-ellipsis> DNS与ICMP </span> </a> </li> <li class=md-nav__item> <a href=../nat-proxy/nat-proxy.html class=md-nav__link> <span class=md-ellipsis> NAT技术、代理服务器和内网穿透 </span> </a> </li> <li class=md-nav__item> <a href=../io-model-select-poll/io-model-select-poll.html class=md-nav__link> <span class=md-ellipsis> 五种IO模型与select和poll分别实现多路转接 </span> </a> </li> <li class=md-nav__item> <a href=../epoll/epoll.html class=md-nav__link> <span class=md-ellipsis> epoll实现多路转接 </span> </a> </li> <li class=md-nav__item> <a href=../reactor-et/reactor-et.html class=md-nav__link> <span class=md-ellipsis> Reactor模式与完善基于边缘触发模式epoll实现TCP服务器 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../front-end/index.html class=md-nav__link> <span class=md-ellipsis> 前端 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../MySQL/index.html class=md-nav__link> <span class=md-ellipsis> MySQL </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../JavaEE/index.html class=md-nav__link> <span class=md-ellipsis> JavaEE应用开发 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../software-test/index.html class=md-nav__link> <span class=md-ellipsis> 软件测试 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../other/index.html class=md-nav__link> <span class=md-ellipsis> 扩展知识 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../tooltips/index.html class=md-nav__link> <span class=md-ellipsis> 工具帮助 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../test-encrypt/test-encrypt.html class=md-nav__link> <span class=md-ellipsis> 测试加密功能 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../projects/index.html class=md-nav__link> <span class=md-ellipsis> 项目 </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=本节目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 本节目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 本篇介绍 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 创建并封装服务端 </span> </a> <nav class=md-nav aria-label=创建并封装服务端> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 创建服务器类 </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 创建服务器套接字 </span> </a> </li> <li class=md-nav__item> <a href=#ip class=md-nav__link> <span class=md-ellipsis> 绑定服务器IP地址和端口 </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 开启服务器监听 </span> </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> 启动服务器 </span> </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 停止服务器 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> 创建并封装客户端 </span> </a> <nav class=md-nav aria-label=创建并封装客户端> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_9 class=md-nav__link> <span class=md-ellipsis> 创建客户端类 </span> </a> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> <span class=md-ellipsis> 创建客户端套接字 </span> </a> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> <span class=md-ellipsis> 启动客户端 </span> </a> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> <span class=md-ellipsis> 停止客户端 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_13 class=md-nav__link> <span class=md-ellipsis> 本地通信测试 </span> </a> </li> <li class=md-nav__item> <a href=#_14 class=md-nav__link> <span class=md-ellipsis> 客户端退出但服务端没有退出的问题 </span> </a> </li> <li class=md-nav__item> <a href=#_15 class=md-nav__link> <span class=md-ellipsis> 文件描述符泄漏问题 </span> </a> </li> <li class=md-nav__item> <a href=#_16 class=md-nav__link> <span class=md-ellipsis> 测试云服务器与本地进行通信 </span> </a> <nav class=md-nav aria-label=测试云服务器与本地进行通信> <ul class=md-nav__list> <li class=md-nav__item> <a href=#linux class=md-nav__link> <span class=md-ellipsis> 相同操作系统（客户端和服务端均为Linux） </span> </a> </li> <li class=md-nav__item> <a href=#windowslinux class=md-nav__link> <span class=md-ellipsis> 不同操作系统（客户端为Windows，服务端为Linux） </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_17 class=md-nav__link> <span class=md-ellipsis> 多个客户端同时连接服务器 </span> </a> <nav class=md-nav aria-label=多个客户端同时连接服务器> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_18 class=md-nav__link> <span class=md-ellipsis> 基本现象 </span> </a> </li> <li class=md-nav__item> <a href=#_19 class=md-nav__link> <span class=md-ellipsis> 子进程版本 </span> </a> </li> <li class=md-nav__item> <a href=#_20 class=md-nav__link> <span class=md-ellipsis> 新线程版本 </span> </a> </li> <li class=md-nav__item> <a href=#_21 class=md-nav__link> <span class=md-ellipsis> 线程池版本 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_22 class=md-nav__link> <span class=md-ellipsis> 客户端控制服务器执行相关命令的程序 </span> </a> <nav class=md-nav aria-label=客户端控制服务器执行相关命令的程序> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_23 class=md-nav__link> <span class=md-ellipsis> 思路分析 </span> </a> </li> <li class=md-nav__item> <a href=#_24 class=md-nav__link> <span class=md-ellipsis> 实现 </span> </a> </li> <li class=md-nav__item> <a href=#_25 class=md-nav__link> <span class=md-ellipsis> 测试 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=tcp>TCP编程接口基本使用<a class=headerlink href=#tcp title="Permanent link">&para;</a></h1> <div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;"> <p><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 5126 个字 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 860 行代码 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 19 张图片 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 28 分钟</p> </div> <h2 id=_1>本篇介绍<a class=headerlink href=#_1 title="Permanent link">&para;</a></h2> <p>在<a href=https://www.help-doc.top/Linux/udp/udp-basic/udp-basic.html#udp>UDP编程接口基本使用</a>已经介绍过UDP编程相关的接口，本篇开始介绍TCP编程相关的接口。有了UDP编程的基础，理解TCP相关的接口会更加容易，下面将按照两个方向使用TCP编程接口：</p> <ol> <li>基本使用TCP编程接口实现服务端和客户端通信</li> <li>使用TCP编程实现客户端控制服务器执行相关命令的程序</li> </ol> <h2 id=_2>创建并封装服务端<a class=headerlink href=#_2 title="Permanent link">&para;</a></h2> <h3 id=_3>创建服务器类<a class=headerlink href=#_3 title="Permanent link">&para;</a></h3> <p>与UDP一样，首先创建服务器类的基本框架，本次设计的服务器一旦启动就不再关闭，除非手动关闭，所以可以提供两个接口：</p> <ol> <li><code>start</code>：启动服务器</li> <li><code>stop</code>：停止服务器</li> </ol> <p>基本结构如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-1><span class=k>class</span><span class=w> </span><span class=nc>TcpServer</span>
</span><span id=__span-0-2><span class=p>{</span>
</span><span id=__span-0-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-0-4><span class=w>    </span><span class=n>TcpServer</span><span class=p>()</span>
</span><span id=__span-0-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-0-6><span class=w>    </span><span class=p>}</span>
</span><span id=__span-0-7>
</span><span id=__span-0-8><span class=w>    </span><span class=c1>// 启动服务器</span>
</span><span id=__span-0-9><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-0-10><span class=w>    </span><span class=p>{</span>
</span><span id=__span-0-11><span class=w>    </span><span class=p>}</span>
</span><span id=__span-0-12>
</span><span id=__span-0-13><span class=w>    </span><span class=c1>// 停止服务器</span>
</span><span id=__span-0-14><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>stop</span><span class=p>()</span>
</span><span id=__span-0-15><span class=w>    </span><span class=p>{</span>
</span><span id=__span-0-16><span class=w>    </span><span class=p>}</span>
</span><span id=__span-0-17>
</span><span id=__span-0-18><span class=w>    </span><span class=o>~</span><span class=n>TcpServer</span><span class=p>()</span>
</span><span id=__span-0-19><span class=w>    </span><span class=p>{</span>
</span><span id=__span-0-20><span class=w>    </span><span class=p>}</span>
</span><span id=__span-0-21><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <h3 id=_4>创建服务器套接字<a class=headerlink href=#_4 title="Permanent link">&para;</a></h3> <p>创建方式与UDP基本一致，只是在<code>socket</code>接口的第二个参数使用<code>SOCK_STREAM</code>而不再是<code>SOCK_DGRAM</code>，代码如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-1-1><span class=k>class</span><span class=w> </span><span class=nc>TcpServer</span>
</span><span id=__span-1-2><span class=p>{</span>
</span><span id=__span-1-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-1-4><span class=w>    </span><span class=n>TcpServer</span><span class=p>()</span>
</span><span id=__span-1-5><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=n>_socketfd</span><span class=p>(</span><span class=mi>-1</span><span class=p>)</span>
</span><span id=__span-1-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-1-7><span class=w>        </span><span class=c1>// 创建服务器套接字</span>
</span><span id=__span-1-8><span class=w>        </span><span class=n>_socketfd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>socket</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span><span class=w> </span><span class=n>SOCK_STREAM</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-1-9>
</span><span id=__span-1-10><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_socketfd</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-1-11><span class=w>        </span><span class=p>{</span>
</span><span id=__span-1-12><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>FATAL</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Server initiated error: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>);</span>
</span><span id=__span-1-13><span class=w>            </span><span class=n>exit</span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>ErrorNumber</span><span class=o>::</span><span class=n>SocketFail</span><span class=p>));</span>
</span><span id=__span-1-14><span class=w>        </span><span class=p>}</span>
</span><span id=__span-1-15><span class=w>        </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Server initated: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>_socketfd</span><span class=p>;</span>
</span><span id=__span-1-16><span class=w>    </span><span class=p>}</span>
</span><span id=__span-1-17>
</span><span id=__span-1-18><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-1-19>
</span><span id=__span-1-20><span class=k>private</span><span class=o>:</span>
</span><span id=__span-1-21><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>_socketfd</span><span class=p>;</span><span class=w>  </span><span class=c1>// 服务器套接字</span>
</span><span id=__span-1-22><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <h3 id=ip>绑定服务器IP地址和端口<a class=headerlink href=#ip title="Permanent link">&para;</a></h3> <p>绑定方式与UDP基本一致，先使用原生的方式而不是直接使用封装后的<code>sockaddr_in</code>结构。在<a href=https://www.help-doc.top/Linux/udp/udp-basic/udp-basic.html#linux>UDP编程接口基本使用</a>部分已经提到过服务器不需要指定IP地址，所以本次一步到位，代码如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-2-1><span class=c1>// 默认端口</span>
</span><span id=__span-2-2><span class=k>const</span><span class=w> </span><span class=kt>uint16_t</span><span class=w> </span><span class=n>default_port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>8080</span><span class=p>;</span>
</span><span id=__span-2-3>
</span><span id=__span-2-4><span class=k>class</span><span class=w> </span><span class=nc>TcpServer</span>
</span><span id=__span-2-5><span class=p>{</span>
</span><span id=__span-2-6><span class=k>public</span><span class=o>:</span>
</span><span id=__span-2-7><span class=w>    </span><span class=n>TcpServer</span><span class=p>(</span><span class=kt>uint16_t</span><span class=w> </span><span class=n>port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>default_port</span><span class=p>)</span>
</span><span id=__span-2-8><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=c1>// ...</span>
</span><span id=__span-2-9><span class=w>        </span><span class=p>,</span><span class=w> </span><span class=n>_port</span><span class=p>(</span><span class=n>port</span><span class=p>)</span>
</span><span id=__span-2-10><span class=w>    </span><span class=p>{</span>
</span><span id=__span-2-11><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-2-12>
</span><span id=__span-2-13><span class=w>        </span><span class=k>struct</span><span class=w> </span><span class=nc>sockaddr_in</span><span class=w> </span><span class=n>server</span><span class=p>;</span>
</span><span id=__span-2-14><span class=w>        </span><span class=n>server</span><span class=p>.</span><span class=n>sin_family</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AF_INET</span><span class=p>;</span>
</span><span id=__span-2-15><span class=w>        </span><span class=n>server</span><span class=p>.</span><span class=n>sin_port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>htons</span><span class=p>(</span><span class=n>_port</span><span class=p>);</span>
</span><span id=__span-2-16><span class=w>        </span><span class=n>server</span><span class=p>.</span><span class=n>sin_addr</span><span class=p>.</span><span class=n>s_addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>INADDR_ANY</span><span class=p>;</span>
</span><span id=__span-2-17>
</span><span id=__span-2-18><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bind</span><span class=p>(</span><span class=n>_socketfd</span><span class=p>,</span><span class=w> </span><span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=k>const</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>sockaddr</span><span class=w> </span><span class=o>*&gt;</span><span class=p>(</span><span class=o>&amp;</span><span class=n>server</span><span class=p>),</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>server</span><span class=p>));</span>
</span><span id=__span-2-19><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-2-20><span class=w>        </span><span class=p>{</span>
</span><span id=__span-2-21><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>FATAL</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Bind error：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>);</span>
</span><span id=__span-2-22><span class=w>            </span><span class=n>exit</span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>ErrorNumber</span><span class=o>::</span><span class=n>BindSocketFail</span><span class=p>));</span>
</span><span id=__span-2-23><span class=w>        </span><span class=p>}</span>
</span><span id=__span-2-24><span class=w>        </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Bind Success&quot;</span><span class=p>;</span>
</span><span id=__span-2-25><span class=w>    </span><span class=p>}</span>
</span><span id=__span-2-26>
</span><span id=__span-2-27><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-2-28>
</span><span id=__span-2-29><span class=k>private</span><span class=o>:</span>
</span><span id=__span-2-30><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>_socketfd</span><span class=p>;</span><span class=w>  </span><span class=c1>// 服务器套接字</span>
</span><span id=__span-2-31><span class=w>    </span><span class=kt>uint16_t</span><span class=w> </span><span class=n>_port</span><span class=p>;</span><span class=w> </span><span class=c1>// 服务器端口</span>
</span><span id=__span-2-32><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <h3 id=_5>开启服务器监听<a class=headerlink href=#_5 title="Permanent link">&para;</a></h3> <p>在UDP部分，走完上面的步骤就已经完成了基本工作，一旦服务器启动就会等待连接。但是在TCP部分则不行，因为TCP是面向连接的，也就是说，使用客户端需要连接使用TCP的客户端必须先建立连接，只有连接建立完成了才可以开始通信。为了可以让客户端和服务端成功建立连接，首先需要让服务器处于监听状态，此时服务器只会一直等待客户端发起连接请求</p> <p>在Linux中，实现服务器监听可以使用<code>listen</code>接口，其原型如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-3-1><span class=kt>int</span><span class=w> </span><span class=nf>listen</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>sockfd</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>backlog</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>该接口的第一个参数表示当前需要作为传输的套接字，第二个参数表示等待中的客户端的最大个数。之所以会有第二个参数是因为一旦请求连接的客户端太多但是服务器又无法快速得做出响应就会导致用户一直处于等待连接状态从而造成不必要的损失，具体介绍见<a href=https://www.help-doc.top/Linux/tcp-connection-backlog/tcp-connection-backlog.html>理解Linux如何看待连接以及TCP全连接队列</a>。一般情况下第二个参数不建议设置比较大，而是因为应该根据实际情况决定，但是一定不能为0，本次大小定为8</p> <p>当监听成功，该接口会返回0，否则返回-1并设置对应的错误码</p> <p>在TCP中，服务器一旦被创建那么久意味着其需要开始进行监听，所以本次考虑将监听放在构造中：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-4-1><span class=c1>// 默认最大支持排队等待连接的客户端个数</span>
</span><span id=__span-4-2><span class=k>const</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>max_backlog</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>8</span><span class=p>;</span>
</span><span id=__span-4-3>
</span><span id=__span-4-4><span class=k>class</span><span class=w> </span><span class=nc>TcpServer</span>
</span><span id=__span-4-5><span class=p>{</span>
</span><span id=__span-4-6><span class=k>public</span><span class=o>:</span>
</span><span id=__span-4-7><span class=w>    </span><span class=n>TcpServer</span><span class=p>(</span><span class=kt>uint16_t</span><span class=w> </span><span class=n>port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>default_port</span><span class=p>)</span>
</span><span id=__span-4-8><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=n>_socketfd</span><span class=p>(</span><span class=mi>-1</span><span class=p>),</span><span class=w> </span><span class=n>_port</span><span class=p>(</span><span class=n>port</span><span class=p>)</span>
</span><span id=__span-4-9><span class=w>    </span><span class=p>{</span>
</span><span id=__span-4-10><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-4-11>
</span><span id=__span-4-12><span class=w>        </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>listen</span><span class=p>(</span><span class=n>_socketfd</span><span class=p>,</span><span class=w> </span><span class=n>max_backlog</span><span class=p>);</span>
</span><span id=__span-4-13><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-4-14><span class=w>        </span><span class=p>{</span>
</span><span id=__span-4-15><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>ERROR</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Listen error：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>);</span>
</span><span id=__span-4-16><span class=w>            </span><span class=n>exit</span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>ErrorNumber</span><span class=o>::</span><span class=n>ListenFail</span><span class=p>));</span>
</span><span id=__span-4-17><span class=w>        </span><span class=p>}</span>
</span><span id=__span-4-18><span class=w>        </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Listen Success&quot;</span><span class=p>;</span>
</span><span id=__span-4-19><span class=w>    </span><span class=p>}</span>
</span><span id=__span-4-20>
</span><span id=__span-4-21><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-4-22><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <h3 id=_6>启动服务器<a class=headerlink href=#_6 title="Permanent link">&para;</a></h3> <p>在TCP中，启动服务器的逻辑和UDP的逻辑有一点不同，因为TCP服务器在启动之前先要进行监听，所以实际上此时服务器并没有进入IO状态，所以一旦启动服务器后，首先要做的就是一旦成功建立连接就需要进入收发消息的状态</p> <p>首先判断服务器是否启动，如果服务器本身已经启动就不需要再次启动，所以还是使用一个<code>_isRunning</code>变量作为判断条件，基本逻辑如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-5-1><span class=c1>// 启动服务器</span>
</span><span id=__span-5-2><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>()</span>
</span><span id=__span-5-3><span class=p>{</span>
</span><span id=__span-5-4><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>_isRunning</span><span class=p>)</span>
</span><span id=__span-5-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-5-6><span class=w>        </span><span class=n>_isRunning</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-5-7><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-5-8><span class=w>        </span><span class=p>{</span>
</span><span id=__span-5-9><span class=w>        </span><span class=p>}</span>
</span><span id=__span-5-10><span class=w>    </span><span class=p>}</span>
</span><span id=__span-5-11><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>接着就是在监听成功的情况下进入IO状态，这里使用的接口就是<code>accept</code>，其原型如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-6-1><span class=kt>int</span><span class=w> </span><span class=nf>accept</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>sockfd</span><span class=p>,</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>sockaddr</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=kt>socklen_t</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>addrlen</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>该接口的第一个参数表示需要绑定的服务器套接字，第二个参数表示对方的套接字结构，第二个参数表示对方套接字结构的大小，其中第二个参数和第三个参数均为输出型参数</p> <p>需要注意的是该接口的返回值，当函数执行成功时，该接口会返回一个套接字，这个套接字与前面通过<code>socket</code>接口获取到的套接字不同。在UDP中，只有一个套接字，就是<code>socket</code>的返回值，但是在TCP中，因为首先需要先监听，此时需要用到的实际上是监听套接字，一旦监听成功，才会给定用于IO的套接字。所以实际上，在TCP中，<code>socket</code>接口的返回值对应的是<code>listen</code>用的套接字，而<code>accept</code>的套接字就是用于IO的套接字</p> <p>基于上面的概念，现在对前面的代码进行一定的修正：对于前面的成员<code>_socketfd</code>，应该修改为<code>_listen_socketfd</code>：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-7-1><span class=k>class</span><span class=w> </span><span class=nc>TcpServer</span>
</span><span id=__span-7-2><span class=p>{</span>
</span><span id=__span-7-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-7-4><span class=w>    </span><span class=n>TcpServer</span><span class=p>(</span><span class=kt>uint16_t</span><span class=w> </span><span class=n>port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>default_port</span><span class=p>)</span>
</span><span id=__span-7-5><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=n>_listen_socketfd</span><span class=p>(</span><span class=mi>-1</span><span class=p>),</span><span class=w> </span><span class=n>_port</span><span class=p>(</span><span class=n>port</span><span class=p>),</span><span class=w> </span><span class=n>_isRunning</span><span class=p>(</span><span class=nb>false</span><span class=p>)</span>
</span><span id=__span-7-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-7-7><span class=w>        </span><span class=c1>// 创建服务器套接字</span>
</span><span id=__span-7-8><span class=w>        </span><span class=n>_listen_socketfd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>socket</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span><span class=w> </span><span class=n>SOCK_STREAM</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-7-9>
</span><span id=__span-7-10><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_listen_socketfd</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-7-11><span class=w>        </span><span class=p>{</span>
</span><span id=__span-7-12><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>FATAL</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Server initiated error: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>);</span>
</span><span id=__span-7-13><span class=w>            </span><span class=n>exit</span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>ErrorNumber</span><span class=o>::</span><span class=n>SocketFail</span><span class=p>));</span>
</span><span id=__span-7-14><span class=w>        </span><span class=p>}</span>
</span><span id=__span-7-15><span class=w>        </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Server initated: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>_listen_socketfd</span><span class=p>;</span>
</span><span id=__span-7-16>
</span><span id=__span-7-17><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bind</span><span class=p>(</span><span class=n>_listen_socketfd</span><span class=p>,</span><span class=w> </span><span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=k>const</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>sockaddr</span><span class=w> </span><span class=o>*&gt;</span><span class=p>(</span><span class=o>&amp;</span><span class=n>server</span><span class=p>),</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>server</span><span class=p>));</span>
</span><span id=__span-7-18><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-7-19>
</span><span id=__span-7-20><span class=w>        </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>listen</span><span class=p>(</span><span class=n>_listen_socketfd</span><span class=p>,</span><span class=w> </span><span class=n>max_backlog</span><span class=p>);</span>
</span><span id=__span-7-21><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-7-22><span class=w>    </span><span class=p>}</span>
</span><span id=__span-7-23>
</span><span id=__span-7-24><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-7-25><span class=k>private</span><span class=o>:</span>
</span><span id=__span-7-26><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>_listen_socketfd</span><span class=p>;</span><span class=w> </span><span class=c1>// 服务器监听套接字</span>
</span><span id=__span-7-27><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-7-28><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>接着，对于接收成功也可以创建一个成员变量<code>_ac_socketfd</code>，并用其接收<code>accept</code>接口的返回值：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-8-1><span class=k>class</span><span class=w> </span><span class=nc>TcpServer</span>
</span><span id=__span-8-2><span class=p>{</span>
</span><span id=__span-8-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-8-4><span class=w>    </span><span class=n>TcpServer</span><span class=p>(</span><span class=kt>uint16_t</span><span class=w> </span><span class=n>port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>default_port</span><span class=p>)</span>
</span><span id=__span-8-5><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=c1>// ...</span>
</span><span id=__span-8-6><span class=w>        </span><span class=p>,</span><span class=w> </span><span class=n>_ac_socketfd</span><span class=p>(</span><span class=mi>-1</span><span class=p>)</span>
</span><span id=__span-8-7><span class=w>    </span><span class=p>{</span>
</span><span id=__span-8-8><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-8-9><span class=w>    </span><span class=p>}</span>
</span><span id=__span-8-10>
</span><span id=__span-8-11><span class=w>    </span><span class=c1>// 启动服务器</span>
</span><span id=__span-8-12><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-8-13><span class=w>    </span><span class=p>{</span>
</span><span id=__span-8-14><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>_isRunning</span><span class=p>)</span>
</span><span id=__span-8-15><span class=w>        </span><span class=p>{</span>
</span><span id=__span-8-16><span class=w>            </span><span class=n>_isRunning</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-8-17><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-8-18><span class=w>            </span><span class=p>{</span>
</span><span id=__span-8-19><span class=w>                </span><span class=k>struct</span><span class=w> </span><span class=nc>sockaddr_in</span><span class=w> </span><span class=n>peer</span><span class=p>;</span>
</span><span id=__span-8-20><span class=w>                </span><span class=kt>socklen_t</span><span class=w> </span><span class=n>length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>peer</span><span class=p>);</span>
</span><span id=__span-8-21><span class=w>                </span><span class=n>_ac_socketfd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>accept</span><span class=p>(</span><span class=n>_listen_socketfd</span><span class=p>,</span><span class=w> </span><span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=k>struct</span><span class=w> </span><span class=nc>sockaddr</span><span class=w> </span><span class=o>*&gt;</span><span class=p>(</span><span class=o>&amp;</span><span class=n>peer</span><span class=p>),</span><span class=w> </span><span class=o>&amp;</span><span class=n>length</span><span class=p>);</span>
</span><span id=__span-8-22><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_ac_socketfd</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-8-23><span class=w>                </span><span class=p>{</span>
</span><span id=__span-8-24><span class=w>                    </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Accept failed：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>);</span>
</span><span id=__span-8-25><span class=w>                    </span><span class=n>exit</span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>ErrorNumber</span><span class=o>::</span><span class=n>AcceptFail</span><span class=p>));</span>
</span><span id=__span-8-26><span class=w>                </span><span class=p>}</span>
</span><span id=__span-8-27><span class=w>                </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Accept Success: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>_ac_socketfd</span><span class=p>;</span>
</span><span id=__span-8-28><span class=w>            </span><span class=p>}</span>
</span><span id=__span-8-29><span class=w>        </span><span class=p>}</span>
</span><span id=__span-8-30><span class=w>    </span><span class=p>}</span>
</span><span id=__span-8-31>
</span><span id=__span-8-32><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-8-33>
</span><span id=__span-8-34><span class=k>private</span><span class=o>:</span>
</span><span id=__span-8-35><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-8-36><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>_ac_socketfd</span><span class=p>;</span><span class=w>     </span><span class=c1>// 服务器接收套接字</span>
</span><span id=__span-8-37><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-8-38><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>后续的代码与UDP思路类似，但是具体实现有些不同。因为UDP是面向数据包的，所以只能「整发整取」，但是TCP是面向字节流的，所以可以「按照需求读取」而不需要「一定完整读取」，而在文件部分，读取和写入文件也是面向字节流的，所以在TCP中，读取和写入就可以直接使用文件的读写接口。但是需要注意，因为读写不是一次性的，所以需要一个循环控制持续读和写：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-9-1><span class=c1>// 启动服务器</span>
</span><span id=__span-9-2><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>()</span>
</span><span id=__span-9-3><span class=p>{</span>
</span><span id=__span-9-4><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>_isRunning</span><span class=p>)</span>
</span><span id=__span-9-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-9-6><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-9-7><span class=w>        </span><span class=p>{</span>
</span><span id=__span-9-8><span class=w>            </span><span class=c1>// ...</span>
</span><span id=__span-9-9>
</span><span id=__span-9-10><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-9-11><span class=w>            </span><span class=p>{</span>
</span><span id=__span-9-12><span class=w>                </span><span class=c1>// 读取客户端消息</span>
</span><span id=__span-9-13><span class=w>                </span><span class=kt>char</span><span class=w> </span><span class=n>buffer</span><span class=p>[</span><span class=mi>4096</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span><span id=__span-9-14><span class=w>                </span><span class=kt>ssize_t</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>read</span><span class=p>(</span><span class=n>_ac_socketfd</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>buffer</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-9-15><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-9-16><span class=w>                </span><span class=p>{</span>
</span><span id=__span-9-17><span class=w>                    </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Client: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>inet_ntoa</span><span class=p>(</span><span class=n>peer</span><span class=p>.</span><span class=n>sin_addr</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;:&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>ntohs</span><span class=p>(</span><span class=n>peer</span><span class=p>.</span><span class=n>sin_port</span><span class=p>))</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; send: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>buffer</span><span class=p>;</span>
</span><span id=__span-9-18>
</span><span id=__span-9-19><span class=w>                    </span><span class=c1>// 向客户端回消息</span>
</span><span id=__span-9-20><span class=w>                    </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>write</span><span class=p>(</span><span class=n>_ac_socketfd</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>buffer</span><span class=p>));</span>
</span><span id=__span-9-21><span class=w>                </span><span class=p>}</span>
</span><span id=__span-9-22><span class=w>            </span><span class=p>}</span>
</span><span id=__span-9-23><span class=w>        </span><span class=p>}</span>
</span><span id=__span-9-24><span class=w>    </span><span class=p>}</span>
</span><span id=__span-9-25><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h3 id=_7>停止服务器<a class=headerlink href=#_7 title="Permanent link">&para;</a></h3> <p>停止服务器和UDP思路一致，但是需要注意，除了要关闭接收套接字以外还需要关闭监听套接字，此处不再赘述：</p> <div class="tabbed-set tabbed-alternate" data-tabs=1:2><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><input id=__tabbed_1_2 name=__tabbed_1 type=radio><div class=tabbed-labels><label for=__tabbed_1_1>停止服务器函数</label><label for=__tabbed_1_2>析构函数</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-10-1><span class=c1>// 停止服务器</span>
</span><span id=__span-10-2><span class=kt>void</span><span class=w> </span><span class=nf>stop</span><span class=p>()</span>
</span><span id=__span-10-3><span class=p>{</span>
</span><span id=__span-10-4><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_isRunning</span><span class=p>)</span>
</span><span id=__span-10-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-10-6><span class=w>        </span><span class=n>close</span><span class=p>(</span><span class=n>_listen_socketfd</span><span class=p>);</span>
</span><span id=__span-10-7><span class=w>        </span><span class=n>close</span><span class=p>(</span><span class=n>_ac_socketfd</span><span class=p>);</span>
</span><span id=__span-10-8><span class=w>    </span><span class=p>}</span>
</span><span id=__span-10-9><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-11-1><span class=o>~</span><span class=n>TcpServer</span><span class=p>()</span>
</span><span id=__span-11-2><span class=p>{</span>
</span><span id=__span-11-3><span class=w>    </span><span class=n>stop</span><span class=p>();</span>
</span><span id=__span-11-4><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <h2 id=_8>创建并封装客户端<a class=headerlink href=#_8 title="Permanent link">&para;</a></h2> <h3 id=_9>创建客户端类<a class=headerlink href=#_9 title="Permanent link">&para;</a></h3> <p>与UDP一致，代码如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-12-1><span class=k>class</span><span class=w> </span><span class=nc>TcpClient</span>
</span><span id=__span-12-2><span class=p>{</span>
</span><span id=__span-12-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-12-4><span class=w>    </span><span class=n>TcpClient</span><span class=p>()</span>
</span><span id=__span-12-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-12-6><span class=w>    </span><span class=p>}</span>
</span><span id=__span-12-7>
</span><span id=__span-12-8><span class=w>    </span><span class=c1>// 启动客户端</span>
</span><span id=__span-12-9><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-12-10><span class=w>    </span><span class=p>{</span>
</span><span id=__span-12-11><span class=w>    </span><span class=p>}</span>
</span><span id=__span-12-12>
</span><span id=__span-12-13><span class=w>    </span><span class=c1>// 停止客户端</span>
</span><span id=__span-12-14><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>stop</span><span class=p>()</span>
</span><span id=__span-12-15><span class=w>    </span><span class=p>{</span>
</span><span id=__span-12-16><span class=w>    </span><span class=p>}</span>
</span><span id=__span-12-17>
</span><span id=__span-12-18><span class=w>    </span><span class=o>~</span><span class=n>TcpClient</span><span class=p>()</span>
</span><span id=__span-12-19><span class=w>    </span><span class=p>{</span>
</span><span id=__span-12-20><span class=w>    </span><span class=p>}</span>
</span><span id=__span-12-21><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <h3 id=_10>创建客户端套接字<a class=headerlink href=#_10 title="Permanent link">&para;</a></h3> <p>与UDP一致，此处不再赘述：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-13-1><span class=k>class</span><span class=w> </span><span class=nc>TcpClient</span>
</span><span id=__span-13-2><span class=p>{</span>
</span><span id=__span-13-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-13-4><span class=w>    </span><span class=n>TcpClient</span><span class=p>()</span>
</span><span id=__span-13-5><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=n>_socketfd</span><span class=p>(</span><span class=mi>-1</span><span class=p>)</span>
</span><span id=__span-13-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-13-7><span class=w>        </span><span class=n>_socketfd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>socket</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span><span class=w> </span><span class=n>SOCK_STREAM</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-13-8>
</span><span id=__span-13-9><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_socketfd</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-13-10><span class=w>        </span><span class=p>{</span>
</span><span id=__span-13-11><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>FATAL</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Client initiated error：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>);</span>
</span><span id=__span-13-12><span class=w>            </span><span class=n>exit</span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>ErrorNumber</span><span class=o>::</span><span class=n>SocketFail</span><span class=p>));</span>
</span><span id=__span-13-13><span class=w>        </span><span class=p>}</span>
</span><span id=__span-13-14><span class=w>        </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Client initiated&quot;</span><span class=p>;</span>
</span><span id=__span-13-15><span class=w>    </span><span class=p>}</span>
</span><span id=__span-13-16>
</span><span id=__span-13-17><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-13-18>
</span><span id=__span-13-19><span class=k>private</span><span class=o>:</span>
</span><span id=__span-13-20><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>_socketfd</span><span class=p>;</span>
</span><span id=__span-13-21><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <h3 id=_11>启动客户端<a class=headerlink href=#_11 title="Permanent link">&para;</a></h3> <p>因为当前是TCP，所以客户端必须先与服务端建立连接才可以进行数据传输。在Linux中，让客户端连接服务端的接口是<code>connect</code>，其原型如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-14-1><span class=kt>int</span><span class=w> </span><span class=nf>connect</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>sockfd</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>sockaddr</span><span class=w> </span><span class=o>*</span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=kt>socklen_t</span><span class=w> </span><span class=n>addrlen</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>该接口的第一个参数表示传送数据需要的套接字，第二个参数表示服务器的套接字结构，第三个参数表示第二个参数的大小</p> <p>如果该接口连接成功或者绑定成功，则返回0，否则返回-1并且设置错误码</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>需要注意，该接口会在成功连接后自动绑定端口和IP地址，与UDP一样不需要用户手动设置客户端的IP地址和端口</p> </div> <p>因为需要用到服务器的端口和IP地址，所以在创建客户端对象时需要让用户传递IP地址和端口，所以基本代码如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-15-1><span class=c1>// 默认服务器端口和IP地址</span>
</span><span id=__span-15-2><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>default_ip</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;127.0.0.1&quot;</span><span class=p>;</span>
</span><span id=__span-15-3><span class=k>const</span><span class=w> </span><span class=kt>uint16_t</span><span class=w> </span><span class=n>default_port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>8080</span><span class=p>;</span>
</span><span id=__span-15-4>
</span><span id=__span-15-5><span class=k>class</span><span class=w> </span><span class=nc>TcpClient</span>
</span><span id=__span-15-6><span class=p>{</span>
</span><span id=__span-15-7><span class=k>public</span><span class=o>:</span>
</span><span id=__span-15-8><span class=w>    </span><span class=n>TcpClient</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>ip</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>default_ip</span><span class=p>,</span><span class=w> </span><span class=kt>uint16_t</span><span class=w> </span><span class=n>port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>default_port</span><span class=p>)</span>
</span><span id=__span-15-9><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=c1>// ...</span>
</span><span id=__span-15-10><span class=w>        </span><span class=p>,</span><span class=w> </span><span class=n>_isRunning</span><span class=p>(</span><span class=nb>false</span><span class=p>),</span><span class=w> </span><span class=n>_ip</span><span class=p>(</span><span class=n>ip</span><span class=p>),</span><span class=w> </span><span class=n>_port</span><span class=p>(</span><span class=n>port</span><span class=p>)</span>
</span><span id=__span-15-11><span class=w>    </span><span class=p>{</span>
</span><span id=__span-15-12><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-15-13><span class=w>    </span><span class=p>}</span>
</span><span id=__span-15-14>
</span><span id=__span-15-15><span class=w>    </span><span class=c1>// 启动客户端</span>
</span><span id=__span-15-16><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-15-17><span class=w>    </span><span class=p>{</span>
</span><span id=__span-15-18><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>_isRunning</span><span class=p>)</span>
</span><span id=__span-15-19><span class=w>        </span><span class=p>{</span>
</span><span id=__span-15-20><span class=w>            </span><span class=n>_isRunning</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-15-21><span class=w>            </span><span class=c1>// 启动后就进行connect</span>
</span><span id=__span-15-22><span class=w>            </span><span class=k>struct</span><span class=w> </span><span class=nc>sockaddr_in</span><span class=w> </span><span class=n>server</span><span class=p>;</span>
</span><span id=__span-15-23><span class=w>            </span><span class=n>server</span><span class=p>.</span><span class=n>sin_family</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AF_INET</span><span class=p>;</span>
</span><span id=__span-15-24><span class=w>            </span><span class=n>server</span><span class=p>.</span><span class=n>sin_addr</span><span class=p>.</span><span class=n>s_addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>inet_addr</span><span class=p>(</span><span class=n>_ip</span><span class=p>.</span><span class=n>c_str</span><span class=p>());</span>
</span><span id=__span-15-25><span class=w>            </span><span class=n>server</span><span class=p>.</span><span class=n>sin_port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>htons</span><span class=p>(</span><span class=n>_port</span><span class=p>);</span>
</span><span id=__span-15-26><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connect</span><span class=p>(</span><span class=n>_socketfd</span><span class=p>,</span><span class=w> </span><span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=k>const</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>sockaddr</span><span class=w> </span><span class=o>*&gt;</span><span class=p>(</span><span class=o>&amp;</span><span class=n>server</span><span class=p>),</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>server</span><span class=p>));</span>
</span><span id=__span-15-27><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-15-28><span class=w>            </span><span class=p>{</span>
</span><span id=__span-15-29><span class=w>                </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Connect failed&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>);</span>
</span><span id=__span-15-30><span class=w>                </span><span class=n>exit</span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>ErrorNumber</span><span class=o>::</span><span class=n>ConnectFail</span><span class=p>));</span>
</span><span id=__span-15-31><span class=w>            </span><span class=p>}</span>
</span><span id=__span-15-32><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Connect Success: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>_socketfd</span><span class=p>;</span>
</span><span id=__span-15-33><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-15-34><span class=w>            </span><span class=p>{</span>
</span><span id=__span-15-35><span class=w>                </span><span class=c1>// ...</span>
</span><span id=__span-15-36><span class=w>            </span><span class=p>}</span>
</span><span id=__span-15-37><span class=w>        </span><span class=p>}</span>
</span><span id=__span-15-38><span class=w>    </span><span class=p>}</span>
</span><span id=__span-15-39>
</span><span id=__span-15-40><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-15-41>
</span><span id=__span-15-42><span class=k>private</span><span class=o>:</span>
</span><span id=__span-15-43><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-15-44><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>_ip</span><span class=p>;</span><span class=w> </span><span class=c1>// 服务器IP地址</span>
</span><span id=__span-15-45><span class=w>    </span><span class=kt>uint16_t</span><span class=w> </span><span class=n>_port</span><span class=p>;</span><span class=w>  </span><span class=c1>// 服务器端口</span>
</span><span id=__span-15-46><span class=w>    </span><span class=kt>bool</span><span class=w> </span><span class=n>_isRunning</span><span class=p>;</span><span class=w> </span><span class=c1>// 判断是否正在运行</span>
</span><span id=__span-15-47><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>在上面的代码中需要注意，不要把<code>connect</code>放在循环里，因为建立连接需要一次而不需要每一次发送都建立连接</p> <p>接着就是写入和读取消息，基本思路与UDP相同，代码如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-16-1><span class=c1>// 启动客户端</span>
</span><span id=__span-16-2><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>()</span>
</span><span id=__span-16-3><span class=p>{</span>
</span><span id=__span-16-4><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>_isRunning</span><span class=p>)</span>
</span><span id=__span-16-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-16-6><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-16-7><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-16-8><span class=w>        </span><span class=p>{</span>
</span><span id=__span-16-9><span class=w>            </span><span class=c1>// 向服务器写入</span>
</span><span id=__span-16-10><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>message</span><span class=p>;</span>
</span><span id=__span-16-11><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;请输入消息：&quot;</span><span class=p>;</span>
</span><span id=__span-16-12><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>getline</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>cin</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>);</span>
</span><span id=__span-16-13><span class=w>            </span><span class=kt>ssize_t</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>write</span><span class=p>(</span><span class=n>_socketfd</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>.</span><span class=n>c_str</span><span class=p>(),</span><span class=w> </span><span class=n>message</span><span class=p>.</span><span class=n>size</span><span class=p>());</span>
</span><span id=__span-16-14>
</span><span id=__span-16-15><span class=w>            </span><span class=c1>// 收到消息</span>
</span><span id=__span-16-16><span class=w>            </span><span class=kt>char</span><span class=w> </span><span class=n>buffer</span><span class=p>[</span><span class=mi>4096</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span><span id=__span-16-17><span class=w>            </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>read</span><span class=p>(</span><span class=n>_socketfd</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>buffer</span><span class=p>));</span>
</span><span id=__span-16-18><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-16-19><span class=w>                </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;收到服务器消息：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>buffer</span><span class=p>;</span>
</span><span id=__span-16-20><span class=w>        </span><span class=p>}</span>
</span><span id=__span-16-21><span class=w>    </span><span class=p>}</span>
</span><span id=__span-16-22><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h3 id=_12>停止客户端<a class=headerlink href=#_12 title="Permanent link">&para;</a></h3> <p>停止客户端的思路与UDP一致，此处不再赘述：</p> <div class="tabbed-set tabbed-alternate" data-tabs=2:2><input checked=checked id=__tabbed_2_1 name=__tabbed_2 type=radio><input id=__tabbed_2_2 name=__tabbed_2 type=radio><div class=tabbed-labels><label for=__tabbed_2_1>停止客户端函数</label><label for=__tabbed_2_2>析构函数</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-17-1><span class=c1>// 停止客户端</span>
</span><span id=__span-17-2><span class=kt>void</span><span class=w> </span><span class=nf>stop</span><span class=p>()</span>
</span><span id=__span-17-3><span class=p>{</span>
</span><span id=__span-17-4><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_isRunning</span><span class=p>)</span>
</span><span id=__span-17-5><span class=w>        </span><span class=n>close</span><span class=p>(</span><span class=n>_socketfd</span><span class=p>);</span>
</span><span id=__span-17-6><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-18-1><span class=o>~</span><span class=n>TcpClient</span><span class=p>()</span>
</span><span id=__span-18-2><span class=p>{</span>
</span><span id=__span-18-3><span class=w>    </span><span class=n>stop</span><span class=p>();</span>
</span><span id=__span-18-4><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <h2 id=_13>本地通信测试<a class=headerlink href=#_13 title="Permanent link">&para;</a></h2> <p><strong>测试步骤：</strong></p> <ol> <li>先启动服务端，再启动客户端</li> <li>客户端向服务器端发送信息</li> </ol> <p><strong>测试目标：</strong></p> <ol> <li>客户端可以正常向服务器端发送信息</li> <li>服务端可以正常显示客户端信息并正常向客户端返回客户端发送的信息</li> <li>客户端可以正常显示服务端回复的信息</li> </ol> <p>测试代码如下：</p> <div class="tabbed-set tabbed-alternate" data-tabs=3:2><input checked=checked id=__tabbed_3_1 name=__tabbed_3 type=radio><input id=__tabbed_3_2 name=__tabbed_3 type=radio><div class=tabbed-labels><label for=__tabbed_3_1>客户端</label><label for=__tabbed_3_2>服务端</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-19-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;tcp_client.hpp&quot;</span>
</span><span id=__span-19-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;memory&gt;</span>
</span><span id=__span-19-3>
</span><span id=__span-19-4><span class=k>using</span><span class=w> </span><span class=k>namespace</span><span class=w> </span><span class=nn>TcpClientModule</span><span class=p>;</span>
</span><span id=__span-19-5>
</span><span id=__span-19-6><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span><span id=__span-19-7><span class=p>{</span>
</span><span id=__span-19-8><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>TcpClient</span><span class=o>&gt;</span><span class=w> </span><span class=n>tcp_client</span><span class=p>;</span>
</span><span id=__span-19-9><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>argc</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-19-10><span class=w>    </span><span class=p>{</span>
</span><span id=__span-19-11><span class=w>        </span><span class=c1>// 使用默认端口和IP地址</span>
</span><span id=__span-19-12><span class=w>        </span><span class=n>tcp_client</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>TcpClient</span><span class=o>&gt;</span><span class=p>();</span>
</span><span id=__span-19-13><span class=w>    </span><span class=p>}</span>
</span><span id=__span-19-14><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>argc</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>3</span><span class=p>)</span>
</span><span id=__span-19-15><span class=w>    </span><span class=p>{</span>
</span><span id=__span-19-16><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>ip</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span><span id=__span-19-17><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=kt>uint16_t</span><span class=w> </span><span class=n>port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>stoi</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
</span><span id=__span-19-18><span class=w>        </span><span class=c1>// 使用自定义端口和IP地址</span>
</span><span id=__span-19-19><span class=w>        </span><span class=n>tcp_client</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>TcpClient</span><span class=o>&gt;</span><span class=p>(</span><span class=n>ip</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>);</span>
</span><span id=__span-19-20><span class=w>    </span><span class=p>}</span>
</span><span id=__span-19-21><span class=w>    </span><span class=k>else</span>
</span><span id=__span-19-22><span class=w>    </span><span class=p>{</span>
</span><span id=__span-19-23><span class=w>        </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>ERROR</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;错误使用，正确使用为：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; IP地址 端口号（或者二者都不存在）&quot;</span><span class=p>;</span>
</span><span id=__span-19-24><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=mi>7</span><span class=p>);</span>
</span><span id=__span-19-25><span class=w>    </span><span class=p>}</span>
</span><span id=__span-19-26>
</span><span id=__span-19-27><span class=w>    </span><span class=n>tcp_client</span><span class=o>-&gt;</span><span class=n>start</span><span class=p>();</span>
</span><span id=__span-19-28>
</span><span id=__span-19-29><span class=w>    </span><span class=n>tcp_client</span><span class=o>-&gt;</span><span class=n>stop</span><span class=p>();</span>
</span><span id=__span-19-30>
</span><span id=__span-19-31><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-19-32><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-20-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;tcp_server.hpp&quot;</span>
</span><span id=__span-20-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;memory&gt;</span>
</span><span id=__span-20-3>
</span><span id=__span-20-4><span class=k>using</span><span class=w> </span><span class=k>namespace</span><span class=w> </span><span class=nn>TcpServerModule</span><span class=p>;</span>
</span><span id=__span-20-5>
</span><span id=__span-20-6><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span><span id=__span-20-7><span class=p>{</span>
</span><span id=__span-20-8><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>TcpServer</span><span class=o>&gt;</span><span class=w> </span><span class=n>tcp_server</span><span class=p>;</span>
</span><span id=__span-20-9><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>argc</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-20-10><span class=w>    </span><span class=p>{</span>
</span><span id=__span-20-11><span class=w>        </span><span class=c1>// 使用默认的端口</span>
</span><span id=__span-20-12><span class=w>        </span><span class=n>tcp_server</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>TcpServer</span><span class=o>&gt;</span><span class=p>();</span>
</span><span id=__span-20-13><span class=w>    </span><span class=p>}</span>
</span><span id=__span-20-14><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>argc</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>2</span><span class=p>)</span>
</span><span id=__span-20-15><span class=w>    </span><span class=p>{</span>
</span><span id=__span-20-16><span class=w>        </span><span class=c1>// 使用自定义端口</span>
</span><span id=__span-20-17><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span><span id=__span-20-18><span class=w>        </span><span class=n>tcp_server</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>TcpServer</span><span class=o>&gt;</span><span class=p>(</span><span class=n>port</span><span class=p>);</span>
</span><span id=__span-20-19><span class=w>    </span><span class=p>}</span>
</span><span id=__span-20-20><span class=w>    </span><span class=k>else</span>
</span><span id=__span-20-21><span class=w>    </span><span class=p>{</span>
</span><span id=__span-20-22><span class=w>        </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>ERROR</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;错误使用，正确方式：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; 端口（可以省略）&quot;</span><span class=p>;</span>
</span><span id=__span-20-23><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=mi>6</span><span class=p>);</span>
</span><span id=__span-20-24><span class=w>    </span><span class=p>}</span>
</span><span id=__span-20-25>
</span><span id=__span-20-26><span class=w>    </span><span class=n>tcp_server</span><span class=o>-&gt;</span><span class=n>start</span><span class=p>();</span>
</span><span id=__span-20-27>
</span><span id=__span-20-28><span class=w>    </span><span class=n>tcp_server</span><span class=o>-&gt;</span><span class=n>stop</span><span class=p>();</span>
</span><span id=__span-20-29>
</span><span id=__span-20-30><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-20-31><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>本次设计的客户端支持用户从命令行输入端口和IP地址，否则就直接使用默认，下面是一种结果：</p> <p><a class=glightbox href="23. TCP编程接口基本使用.assets/image-20250303212358636.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="23. TCP编程接口基本使用.assets/image-20250303212358636.png"></a></p> <h2 id=_14>客户端退出但服务端没有退出的问题<a class=headerlink href=#_14 title="Permanent link">&para;</a></h2> <p>在UDP中，如果客户端退出但服务端没有退出，下一次客户端再连接该服务端时不会出现问题。但是在TCP中就并不是这样，例如：</p> <p><a class=glightbox href="23. TCP编程接口基本使用.assets\Snipaste_2025-03-04_19-13-57.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="23. TCP编程接口基本使用.assets\Snipaste_2025-03-04_19-13-57.png"></a></p> <p>从上图可以看到，如果客户端连接后断开再连接就会出现第二次连接发送消息无法得到回应。之所以出现这个问题就是因为服务器卡在了读写死循环中，解决这个问题的方式很简单，只需要判断<code>read</code>接口返回值是否为0，如果为0，说明当前服务器并没有读取到任何内容，直接退出即可：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-21-1><span class=c1>// 启动服务器</span>
</span><span id=__span-21-2><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>()</span>
</span><span id=__span-21-3><span class=p>{</span>
</span><span id=__span-21-4><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>_isRunning</span><span class=p>)</span>
</span><span id=__span-21-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-21-6><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-21-7>
</span><span id=__span-21-8><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-21-9><span class=w>        </span><span class=p>{</span>
</span><span id=__span-21-10><span class=w>            </span><span class=c1>// ...</span>
</span><span id=__span-21-11>
</span><span id=__span-21-12><span class=w>            </span><span class=k>while</span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-21-13><span class=w>            </span><span class=p>{</span>
</span><span id=__span-21-14><span class=w>                </span><span class=c1>// 读取客户端消息</span>
</span><span id=__span-21-15><span class=w>                </span><span class=kt>char</span><span class=w> </span><span class=n>buffer</span><span class=p>[</span><span class=mi>4096</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span><span id=__span-21-16><span class=w>                </span><span class=kt>ssize_t</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>read</span><span class=p>(</span><span class=n>_ac_socketfd</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>buffer</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-21-17><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-21-18><span class=w>                </span><span class=p>{</span>
</span><span id=__span-21-19><span class=w>                    </span><span class=c1>// ...</span>
</span><span id=__span-21-20><span class=w>                </span><span class=p>}</span>
</span><span id=__span-21-21><span class=w>                </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-21-22><span class=w>                </span><span class=p>{</span>
</span><span id=__span-21-23><span class=w>                    </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Client disconnected: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>_ac_socketfd</span><span class=p>;</span>
</span><span id=__span-21-24><span class=w>                    </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-21-25><span class=w>                </span><span class=p>}</span>
</span><span id=__span-21-26><span class=w>            </span><span class=p>}</span>
</span><span id=__span-21-27><span class=w>        </span><span class=p>}</span>
</span><span id=__span-21-28><span class=w>    </span><span class=p>}</span>
</span><span id=__span-21-29><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>此时便可以解决上面的问题：</p> <p><a class=glightbox href="23. TCP编程接口基本使用.assets/image-20250304193613573.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="23. TCP编程接口基本使用.assets/image-20250304193613573.png"></a></p> <h2 id=_15>文件描述符泄漏问题<a class=headerlink href=#_15 title="Permanent link">&para;</a></h2> <p>在上面的测试结果中可以发现，当客户端退出后再重新连接服务端，此时的文件描述符由4变成了5，但是实际上文件描述符是非常有限的，对于一般的用户机来说，文件描述符最大为1024，而服务器一般为65535，使用下面的指令可以查看：</p> <div class="language-shell highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-22-1><span class=nb>ulimit</span><span class=w> </span>-a
</span></code></pre></div></td></tr></table></div> <p>在结果中的<code>open files</code>一栏即可看到值</p> <p>既然客户端已经退出了，那么对应的文件描述符就应该关闭而不是持续被占用着，此时就出现了文件描述符泄漏问题。解决这个问题很简答，只需要在判断读取结果小于0时关闭文件描述符再退出即可：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-23-1><span class=c1>// 启动服务器</span>
</span><span id=__span-23-2><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>()</span>
</span><span id=__span-23-3><span class=p>{</span>
</span><span id=__span-23-4><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>_isRunning</span><span class=p>)</span>
</span><span id=__span-23-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-23-6><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-23-7>
</span><span id=__span-23-8><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-23-9><span class=w>        </span><span class=p>{</span>
</span><span id=__span-23-10><span class=w>            </span><span class=c1>// ...</span>
</span><span id=__span-23-11>
</span><span id=__span-23-12><span class=w>            </span><span class=c1>// ...</span>
</span><span id=__span-23-13>
</span><span id=__span-23-14><span class=w>            </span><span class=n>close</span><span class=p>(</span><span class=n>_ac_socketfd</span><span class=p>);</span>
</span><span id=__span-23-15><span class=w>        </span><span class=p>}</span>
</span><span id=__span-23-16><span class=w>    </span><span class=p>}</span>
</span><span id=__span-23-17><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h2 id=_16>测试云服务器与本地进行通信<a class=headerlink href=#_16 title="Permanent link">&para;</a></h2> <h3 id=linux>相同操作系统（客户端和服务端均为Linux）<a class=headerlink href=#linux title="Permanent link">&para;</a></h3> <p>测试云服务器与本地进行通信最直接的步骤如下：</p> <ol> <li>将服务端程序拷贝到云服务器</li> <li>本地作为客户端，通过云服务器的公网IP地址连接云服务器的服务端</li> <li>客户端向云服务器发送信息</li> </ol> <p>具体操作步骤与UDP类似，下面直接展示结果：</p> <p><a class=glightbox href="23. TCP编程接口基本使用.assets\Snipaste_2025-03-04_18-27-08.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="23. TCP编程接口基本使用.assets\Snipaste_2025-03-04_18-27-08.png"></a></p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>与UDP一样需要注意安全组的问题，以阿里云为例，设置结果如下：</p> <p><a class=glightbox href="23. TCP编程接口基本使用.assets\Snipaste_2025-03-04_18-28-11.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="23. TCP编程接口基本使用.assets\Snipaste_2025-03-04_18-28-11.png"></a></p> </div> <h3 id=windowslinux>不同操作系统（客户端为Windows，服务端为Linux）<a class=headerlink href=#windowslinux title="Permanent link">&para;</a></h3> <p>因为Windows中使用接口和Linux中差不多，所以不会再详细介绍，下面直接给出Windows客户端代码：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span>
<span class=normal>59</span>
<span class=normal>60</span>
<span class=normal>61</span>
<span class=normal>62</span>
<span class=normal>63</span>
<span class=normal>64</span>
<span class=normal>65</span>
<span class=normal>66</span>
<span class=normal>67</span>
<span class=normal>68</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-24-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;winsock2.h&gt;</span>
</span><span id=__span-24-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-24-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;string&gt;</span>
</span><span id=__span-24-4>
</span><span id=__span-24-5><span class=cp>#pragma warning(disable : 4996)</span>
</span><span id=__span-24-6>
</span><span id=__span-24-7><span class=cp>#pragma comment(lib, &quot;ws2_32.lib&quot;)</span>
</span><span id=__span-24-8>
</span><span id=__span-24-9><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>serverip</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;47.113.217.80&quot;</span><span class=p>;</span><span class=w>  </span><span class=c1>// 填写云服务器IP地址</span>
</span><span id=__span-24-10><span class=kt>uint16_t</span><span class=w> </span><span class=n>serverport</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>8888</span><span class=p>;</span><span class=w> </span><span class=c1>// 填写云服务开放的端口号</span>
</span><span id=__span-24-11>
</span><span id=__span-24-12><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-24-13><span class=p>{</span>
</span><span id=__span-24-14><span class=w>    </span><span class=n>WSADATA</span><span class=w> </span><span class=n>wsaData</span><span class=p>;</span>
</span><span id=__span-24-15><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>WSAStartup</span><span class=p>(</span><span class=n>MAKEWORD</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>),</span><span class=w> </span><span class=o>&amp;</span><span class=n>wsaData</span><span class=p>);</span>
</span><span id=__span-24-16><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-24-17><span class=w>    </span><span class=p>{</span>
</span><span id=__span-24-18><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cerr</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;WSAStartup failed: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-24-19><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-24-20><span class=w>    </span><span class=p>}</span>
</span><span id=__span-24-21>
</span><span id=__span-24-22><span class=w>    </span><span class=n>SOCKET</span><span class=w> </span><span class=n>clientSocket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>socket</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span><span class=w> </span><span class=n>SOCK_STREAM</span><span class=p>,</span><span class=w> </span><span class=n>IPPROTO_TCP</span><span class=p>);</span>
</span><span id=__span-24-23><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>clientSocket</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>INVALID_SOCKET</span><span class=p>)</span>
</span><span id=__span-24-24><span class=w>    </span><span class=p>{</span>
</span><span id=__span-24-25><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cerr</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;socket failed&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-24-26><span class=w>        </span><span class=n>WSACleanup</span><span class=p>();</span>
</span><span id=__span-24-27><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-24-28><span class=w>    </span><span class=p>}</span>
</span><span id=__span-24-29>
</span><span id=__span-24-30><span class=w>    </span><span class=n>sockaddr_in</span><span class=w> </span><span class=n>serverAddr</span><span class=p>;</span>
</span><span id=__span-24-31><span class=w>    </span><span class=n>serverAddr</span><span class=p>.</span><span class=n>sin_family</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AF_INET</span><span class=p>;</span>
</span><span id=__span-24-32><span class=w>    </span><span class=n>serverAddr</span><span class=p>.</span><span class=n>sin_port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>htons</span><span class=p>(</span><span class=n>serverport</span><span class=p>);</span><span class=w>                  </span><span class=c1>// 替换为服务器端口</span>
</span><span id=__span-24-33><span class=w>    </span><span class=n>serverAddr</span><span class=p>.</span><span class=n>sin_addr</span><span class=p>.</span><span class=n>s_addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>inet_addr</span><span class=p>(</span><span class=n>serverip</span><span class=p>.</span><span class=n>c_str</span><span class=p>());</span><span class=w> </span><span class=c1>// 替换为服务器IP地址</span>
</span><span id=__span-24-34>
</span><span id=__span-24-35><span class=w>    </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connect</span><span class=p>(</span><span class=n>clientSocket</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>SOCKADDR</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>serverAddr</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>serverAddr</span><span class=p>));</span>
</span><span id=__span-24-36><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>SOCKET_ERROR</span><span class=p>)</span>
</span><span id=__span-24-37><span class=w>    </span><span class=p>{</span>
</span><span id=__span-24-38><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cerr</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;connect failed&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-24-39><span class=w>        </span><span class=n>closesocket</span><span class=p>(</span><span class=n>clientSocket</span><span class=p>);</span>
</span><span id=__span-24-40><span class=w>        </span><span class=n>WSACleanup</span><span class=p>();</span>
</span><span id=__span-24-41><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-24-42><span class=w>    </span><span class=p>}</span>
</span><span id=__span-24-43><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-24-44><span class=w>    </span><span class=p>{</span>
</span><span id=__span-24-45><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>message</span><span class=p>;</span>
</span><span id=__span-24-46><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Please Enter@ &quot;</span><span class=p>;</span>
</span><span id=__span-24-47><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>getline</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>cin</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>);</span>
</span><span id=__span-24-48><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>message</span><span class=p>.</span><span class=n>empty</span><span class=p>())</span><span class=w> </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-24-49><span class=w>        </span><span class=n>send</span><span class=p>(</span><span class=n>clientSocket</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>.</span><span class=n>c_str</span><span class=p>(),</span><span class=w> </span><span class=n>message</span><span class=p>.</span><span class=n>size</span><span class=p>(),</span><span class=w> </span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-24-50>
</span><span id=__span-24-51><span class=w>        </span><span class=kt>char</span><span class=w> </span><span class=n>buffer</span><span class=p>[</span><span class=mi>1024</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span><span id=__span-24-52><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>bytesReceived</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>recv</span><span class=p>(</span><span class=n>clientSocket</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>buffer</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-24-53><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>bytesReceived</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-24-54><span class=w>        </span><span class=p>{</span>
</span><span id=__span-24-55><span class=w>            </span><span class=n>buffer</span><span class=p>[</span><span class=n>bytesReceived</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=sc>&#39;\0&#39;</span><span class=p>;</span><span class=w> </span><span class=c1>// 确保字符串以 null 结尾</span>
</span><span id=__span-24-56><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Received from server: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>buffer</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-24-57><span class=w>        </span><span class=p>}</span>
</span><span id=__span-24-58><span class=w>        </span><span class=k>else</span>
</span><span id=__span-24-59><span class=w>        </span><span class=p>{</span>
</span><span id=__span-24-60><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cerr</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;recv failed&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-24-61><span class=w>        </span><span class=p>}</span>
</span><span id=__span-24-62><span class=w>    </span><span class=p>}</span>
</span><span id=__span-24-63>
</span><span id=__span-24-64><span class=w>    </span><span class=n>closesocket</span><span class=p>(</span><span class=n>clientSocket</span><span class=p>);</span>
</span><span id=__span-24-65><span class=w>    </span><span class=n>WSACleanup</span><span class=p>();</span>
</span><span id=__span-24-66>
</span><span id=__span-24-67><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-24-68><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>运行结果如下：</p> <p><a class=glightbox href="23. TCP编程接口基本使用.assets\Snipaste_2025-03-04_18-48-04.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="23. TCP编程接口基本使用.assets\Snipaste_2025-03-04_18-48-04.png"></a></p> <h2 id=_17>多个客户端同时连接服务器<a class=headerlink href=#_17 title="Permanent link">&para;</a></h2> <p>在上面已经测试过一个客户端连接一个服务端，接下来测试多个客户端连接服务端</p> <h3 id=_18>基本现象<a class=headerlink href=#_18 title="Permanent link">&para;</a></h3> <p>使用本地虚拟机和云服务器的客户端本地连接云服务器的服务端：</p> <p>先使用虚拟机或者云服务器的客户端连接服务端：</p> <p><a class=glightbox href="23. TCP编程接口基本使用.assets\Snipaste_2025-03-04_18-53-10.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="23. TCP编程接口基本使用.assets\Snipaste_2025-03-04_18-53-10.png"></a></p> <p>可以看到正常连接，但是此时如果云服务器本地客户端连接云服务器的服务端：</p> <p><a class=glightbox href="23. TCP编程接口基本使用.assets\Snipaste_2025-03-04_18-56-59.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="23. TCP编程接口基本使用.assets\Snipaste_2025-03-04_18-56-59.png"></a></p> <p>此时就会发现，尽管云服务器客户端提示连接成功，但是服务器却没有显示接收。如果云服务器的客户端向服务器发送消息也不回得到回应：</p> <p><a class=glightbox href="23. TCP编程接口基本使用.assets\Snipaste_2025-03-04_19-41-13.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="23. TCP编程接口基本使用.assets\Snipaste_2025-03-04_19-41-13.png"></a></p> <p>如果终断虚拟机的连接，此时服务器又会显示连接成功：</p> <p><a class=glightbox href="23. TCP编程接口基本使用.assets\Snipaste_2025-03-04_18-58-56.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="23. TCP编程接口基本使用.assets\Snipaste_2025-03-04_18-58-56.png"></a></p> <p>之所以会出现这个问题就是因为在上面的逻辑中：只有接收成功了才会发送消息，而一旦接收成功后，就在写入和读取中死循环，此时就导致<code>accept</code>不能继续接收。解决这个问题就需要考虑到使用子进程或者新线程，将接收和读写分别放在两个执行进程或者执行流中，根据这个思路下面提供三种解决方案：</p> <ol> <li>子进程版本</li> <li>新线程版本</li> <li>线程池版本</li> </ol> <h3 id=_19>子进程版本<a class=headerlink href=#_19 title="Permanent link">&para;</a></h3> <p>设计子进程版本的本质就是让子进程执行读写方法，先将读写逻辑抽离到一个函数中：</p> <div class="tabbed-set tabbed-alternate" data-tabs=4:2><input checked=checked id=__tabbed_4_1 name=__tabbed_4 type=radio><input id=__tabbed_4_2 name=__tabbed_4 type=radio><div class=tabbed-labels><label for=__tabbed_4_1>读写函数</label><label for=__tabbed_4_2>启动服务器函数</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-25-1><span class=c1>// 读写函数</span>
</span><span id=__span-25-2><span class=kt>void</span><span class=w> </span><span class=nf>read_write_msg</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>sockaddr_in</span><span class=w> </span><span class=n>peer</span><span class=p>)</span>
</span><span id=__span-25-3><span class=p>{</span>
</span><span id=__span-25-4><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-25-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-25-6><span class=w>        </span><span class=c1>// 读取客户端消息</span>
</span><span id=__span-25-7><span class=w>        </span><span class=kt>char</span><span class=w> </span><span class=n>buffer</span><span class=p>[</span><span class=mi>4096</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span><span id=__span-25-8><span class=w>        </span><span class=kt>ssize_t</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>read</span><span class=p>(</span><span class=n>_ac_socketfd</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>buffer</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-25-9><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-25-10><span class=w>        </span><span class=p>{</span>
</span><span id=__span-25-11><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Client: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>inet_ntoa</span><span class=p>(</span><span class=n>peer</span><span class=p>.</span><span class=n>sin_addr</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;:&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>ntohs</span><span class=p>(</span><span class=n>peer</span><span class=p>.</span><span class=n>sin_port</span><span class=p>))</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; send: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>buffer</span><span class=p>;</span>
</span><span id=__span-25-12>
</span><span id=__span-25-13><span class=w>            </span><span class=c1>// 向客户端回消息</span>
</span><span id=__span-25-14><span class=w>            </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>write</span><span class=p>(</span><span class=n>_ac_socketfd</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>buffer</span><span class=p>));</span>
</span><span id=__span-25-15><span class=w>        </span><span class=p>}</span>
</span><span id=__span-25-16><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-25-17><span class=w>        </span><span class=p>{</span>
</span><span id=__span-25-18><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Client disconnected: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>_ac_socketfd</span><span class=p>;</span>
</span><span id=__span-25-19><span class=w>            </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-25-20><span class=w>        </span><span class=p>}</span>
</span><span id=__span-25-21><span class=w>    </span><span class=p>}</span>
</span><span id=__span-25-22>
</span><span id=__span-25-23><span class=w>    </span><span class=n>close</span><span class=p>(</span><span class=n>_ac_socketfd</span><span class=p>);</span>
</span><span id=__span-25-24><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-26-1><span class=c1>// 启动服务器</span>
</span><span id=__span-26-2><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>()</span>
</span><span id=__span-26-3><span class=p>{</span>
</span><span id=__span-26-4><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>_isRunning</span><span class=p>)</span>
</span><span id=__span-26-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-26-6><span class=w>        </span><span class=n>_isRunning</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-26-7>
</span><span id=__span-26-8><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-26-9><span class=w>        </span><span class=p>{</span>
</span><span id=__span-26-10><span class=w>            </span><span class=k>struct</span><span class=w> </span><span class=nc>sockaddr_in</span><span class=w> </span><span class=n>peer</span><span class=p>;</span>
</span><span id=__span-26-11><span class=w>            </span><span class=kt>socklen_t</span><span class=w> </span><span class=n>length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>peer</span><span class=p>);</span>
</span><span id=__span-26-12><span class=w>            </span><span class=n>_ac_socketfd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>accept</span><span class=p>(</span><span class=n>_listen_socketfd</span><span class=p>,</span><span class=w> </span><span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=k>struct</span><span class=w> </span><span class=nc>sockaddr</span><span class=w> </span><span class=o>*&gt;</span><span class=p>(</span><span class=o>&amp;</span><span class=n>peer</span><span class=p>),</span><span class=w> </span><span class=o>&amp;</span><span class=n>length</span><span class=p>);</span>
</span><span id=__span-26-13><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_ac_socketfd</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-26-14><span class=w>            </span><span class=p>{</span>
</span><span id=__span-26-15><span class=w>                </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Accept failed：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>);</span>
</span><span id=__span-26-16><span class=w>                </span><span class=n>exit</span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>ErrorNumber</span><span class=o>::</span><span class=n>AcceptFail</span><span class=p>));</span>
</span><span id=__span-26-17><span class=w>            </span><span class=p>}</span>
</span><span id=__span-26-18><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Accept Success: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>_ac_socketfd</span><span class=p>;</span>
</span><span id=__span-26-19>
</span><span id=__span-26-20><span class=w>            </span><span class=c1>// 读写逻辑</span>
</span><span id=__span-26-21><span class=w>            </span><span class=n>read_write_msg</span><span class=p>(</span><span class=n>peer</span><span class=p>);</span>
</span><span id=__span-26-22><span class=w>        </span><span class=p>}</span>
</span><span id=__span-26-23><span class=w>    </span><span class=p>}</span>
</span><span id=__span-26-24><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>接着，为了让子进程执行对应的任务，首先就是创建一个子进程，此处直接使用原生接口：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-27-1><span class=c1>// 启动服务器</span>
</span><span id=__span-27-2><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>()</span>
</span><span id=__span-27-3><span class=p>{</span>
</span><span id=__span-27-4><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>_isRunning</span><span class=p>)</span>
</span><span id=__span-27-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-27-6><span class=w>        </span><span class=n>_isRunning</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-27-7>
</span><span id=__span-27-8><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-27-9><span class=w>        </span><span class=p>{</span>
</span><span id=__span-27-10><span class=w>            </span><span class=c1>// ...</span>
</span><span id=__span-27-11>
</span><span id=__span-27-12><span class=w>            </span><span class=c1>// 创建子进程</span>
</span><span id=__span-27-13><span class=w>            </span><span class=kt>pid_t</span><span class=w> </span><span class=n>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fork</span><span class=p>();</span>
</span><span id=__span-27-14><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pid</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-27-15><span class=w>            </span><span class=p>{</span>
</span><span id=__span-27-16><span class=w>                </span><span class=c1>// 子进程</span>
</span><span id=__span-27-17>
</span><span id=__span-27-18><span class=w>                </span><span class=c1>// 读写逻辑</span>
</span><span id=__span-27-19><span class=w>                </span><span class=n>read_write_msg</span><span class=p>(</span><span class=n>peer</span><span class=p>);</span>
</span><span id=__span-27-20>
</span><span id=__span-27-21><span class=w>                </span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-27-22><span class=w>            </span><span class=p>}</span>
</span><span id=__span-27-23><span class=w>        </span><span class=p>}</span>
</span><span id=__span-27-24><span class=w>    </span><span class=p>}</span>
</span><span id=__span-27-25><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>但是，这样写还不足以解决问题，在<a href=https://www.help-doc.top/Linux/com-process/com-anonymous-pipe/com-anonymous-pipe.html#_11>Linux进程间通信</a>提到子进程会拷贝父进程描述符表，此时同样会导致文件描述符泄漏问题，所以父进程和子进程都需要关闭自己不需要的文件描述符：对于父进程来说，其需要关闭读写用的文件描述符，因为写入和读取交给了子进程；对于子进程来说，其需要关闭监听用的文件描述符，因为继续监听其他客户端的连接由父进程进行</p> <p>基于上面的思路，代码如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-28-1><span class=c1>// 启动服务器</span>
</span><span id=__span-28-2><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>()</span>
</span><span id=__span-28-3><span class=p>{</span>
</span><span id=__span-28-4><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>_isRunning</span><span class=p>)</span>
</span><span id=__span-28-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-28-6><span class=w>        </span><span class=n>_isRunning</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-28-7>
</span><span id=__span-28-8><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-28-9><span class=w>        </span><span class=p>{</span>
</span><span id=__span-28-10><span class=w>            </span><span class=c1>// ...</span>
</span><span id=__span-28-11>
</span><span id=__span-28-12><span class=w>            </span><span class=c1>// 创建子进程</span>
</span><span id=__span-28-13><span class=w>            </span><span class=kt>pid_t</span><span class=w> </span><span class=n>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fork</span><span class=p>();</span>
</span><span id=__span-28-14><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pid</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-28-15><span class=w>            </span><span class=p>{</span>
</span><span id=__span-28-16><span class=w>                </span><span class=c1>// 子进程</span>
</span><span id=__span-28-17>
</span><span id=__span-28-18><span class=w>                </span><span class=c1>// 关闭监听文件描述符</span>
</span><span id=__span-28-19><span class=w>                </span><span class=n>close</span><span class=p>(</span><span class=n>_listen_socketfd</span><span class=p>);</span>
</span><span id=__span-28-20>
</span><span id=__span-28-21><span class=w>                </span><span class=c1>// ...</span>
</span><span id=__span-28-22><span class=w>            </span><span class=p>}</span>
</span><span id=__span-28-23>
</span><span id=__span-28-24><span class=w>            </span><span class=c1>// 父进程关闭读写描述符</span>
</span><span id=__span-28-25><span class=w>            </span><span class=n>close</span><span class=p>(</span><span class=n>_ac_socketfd</span><span class=p>);</span>
</span><span id=__span-28-26><span class=w>        </span><span class=p>}</span>
</span><span id=__span-28-27><span class=w>    </span><span class=p>}</span>
</span><span id=__span-28-28><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>一旦创建了子进程，父进程就需要对其进行等待并回收，如果不回收就会导致内存泄漏问题，回收子进程的方式目前有下面两种：</p> <ol> <li>使用<code>wait</code>和<code>waitpid</code>接口进行等待</li> <li>借助子进程退出时发送的<code>SIGCHILD</code>信号，使用<code>SIG_IGN</code>行为</li> </ol> <p>但是本次不使用上面的任意一种，而是考虑让子进程再创建一个子进程，一旦创建成功就让当前子进程退出，而让新创建的子进程（孙子进程）继续执行后续的代码，因为当前子进程已经退出并且退出前并没有回收新创建的子进程（孙子进程），所以当前孙子进程就会被操作系统托管变成孤儿进程，一旦孙子进程走到了读写逻辑下面的<code>exit(0)</code>就会退出，此时操作系统就会自动回收这个孙子进程。这个思路也被称为「双重<code>fork</code>（或者<a href=https://www.help-doc.top/Linux/process-relationship-daemon/process-relationship-daemon.html#_6>守护进程化</a>）」。所以，代码如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-29-1><span class=c1>// 启动服务器</span>
</span><span id=__span-29-2><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>()</span>
</span><span id=__span-29-3><span class=p>{</span>
</span><span id=__span-29-4><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>_isRunning</span><span class=p>)</span>
</span><span id=__span-29-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-29-6><span class=w>        </span><span class=n>_isRunning</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-29-7>
</span><span id=__span-29-8><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-29-9><span class=w>        </span><span class=p>{</span>
</span><span id=__span-29-10><span class=w>            </span><span class=c1>// ...</span>
</span><span id=__span-29-11>
</span><span id=__span-29-12><span class=w>            </span><span class=c1>// 创建子进程</span>
</span><span id=__span-29-13><span class=w>            </span><span class=kt>pid_t</span><span class=w> </span><span class=n>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fork</span><span class=p>();</span>
</span><span id=__span-29-14><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pid</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-29-15><span class=w>            </span><span class=p>{</span>
</span><span id=__span-29-16><span class=w>                </span><span class=c1>// 子进程</span>
</span><span id=__span-29-17><span class=w>                </span><span class=c1>// ...</span>
</span><span id=__span-29-18>
</span><span id=__span-29-19><span class=w>                </span><span class=c1>// 创建孙子进程</span>
</span><span id=__span-29-20><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>fork</span><span class=p>())</span>
</span><span id=__span-29-21><span class=w>                    </span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span><span class=w> </span><span class=c1>// 当前子进程执行exit(0)</span>
</span><span id=__span-29-22>
</span><span id=__span-29-23><span class=w>                </span><span class=c1>// 孙子进程从此处继续向后执行</span>
</span><span id=__span-29-24><span class=w>                </span><span class=c1>// 读写逻辑</span>
</span><span id=__span-29-25><span class=w>                </span><span class=n>read_write_msg</span><span class=p>(</span><span class=n>peer</span><span class=p>);</span>
</span><span id=__span-29-26>
</span><span id=__span-29-27><span class=w>                </span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-29-28><span class=w>            </span><span class=p>}</span>
</span><span id=__span-29-29>
</span><span id=__span-29-30><span class=w>            </span><span class=c1>// ...</span>
</span><span id=__span-29-31><span class=w>        </span><span class=p>}</span>
</span><span id=__span-29-32><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-33><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>现在，再进行上面的测试可以发现问题已经解决：</p> <p><a class=glightbox href="23. TCP编程接口基本使用.assets\Snipaste_2025-03-04_20-41-34.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="23. TCP编程接口基本使用.assets\Snipaste_2025-03-04_20-41-34.png"></a></p> <p><a class=glightbox href="23. TCP编程接口基本使用.assets\Snipaste_2025-03-04_20-41-45.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="23. TCP编程接口基本使用.assets\Snipaste_2025-03-04_20-41-45.png"></a></p> <h3 id=_20>新线程版本<a class=headerlink href=#_20 title="Permanent link">&para;</a></h3> <p>因为所有线程共享一个文件描述符表，所以不需要手动关闭一些文件描述符，下面使用<a href="https://www.help-doc.top/Linux/linux-thread/thread-lib/thread-lib.html?h=%E7%BA%BF#_4">前面封装的线程</a>进行演示：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-30-1><span class=c1>// 启动服务器</span>
</span><span id=__span-30-2><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>()</span>
</span><span id=__span-30-3><span class=p>{</span>
</span><span id=__span-30-4><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>_isRunning</span><span class=p>)</span>
</span><span id=__span-30-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-30-6><span class=w>        </span><span class=n>_isRunning</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-30-7>
</span><span id=__span-30-8><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-30-9><span class=w>        </span><span class=p>{</span>
</span><span id=__span-30-10><span class=w>            </span><span class=c1>// ...</span>
</span><span id=__span-30-11>
</span><span id=__span-30-12><span class=w>            </span><span class=c1>// // 父进程关闭读写描述符</span>
</span><span id=__span-30-13><span class=w>            </span><span class=c1>// close(_ac_socketfd);</span>
</span><span id=__span-30-14>
</span><span id=__span-30-15><span class=w>            </span><span class=c1>// 创建新线程</span>
</span><span id=__span-30-16><span class=w>            </span><span class=n>Thread</span><span class=w> </span><span class=n>t</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>bind</span><span class=p>(</span><span class=o>&amp;</span><span class=n>TcpServer</span><span class=o>::</span><span class=n>read_write_msg</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>peer</span><span class=p>));</span>
</span><span id=__span-30-17><span class=w>            </span><span class=n>t</span><span class=p>.</span><span class=n>start</span><span class=p>();</span>
</span><span id=__span-30-18><span class=w>        </span><span class=p>}</span>
</span><span id=__span-30-19><span class=w>    </span><span class=p>}</span>
</span><span id=__span-30-20><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>但是，上面创建的方式可以正常运行吗？为了知道结果，下面进行一次测试：</p> <p><a class=glightbox href="23. TCP编程接口基本使用.assets/image-20250313195237027.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="23. TCP编程接口基本使用.assets/image-20250313195237027.png"></a></p> <p>从上面的结果可以看出，如果上面的写法存在致命的问题，一旦客户端连接服务端就会出现段错误，出现这个问题的原因就在于使用的套接字是一个成员变量，而因为线程之间会共享数据，所以一旦成员变量发生了改变就会影响所有的线程。但是，如果直接看这个代码会感觉没有什么问题，并且也没有涉及到套接字创建成功之后修改套接字的行为，为什么套接字会被改变呢？这里就和操作系统底层实现<code>accept</code>有关，此处先不具体说明，只需要知道套接字创建成功，如果线程不及时使用就可能被操作系统回收，而因为线程的执行是异步的，所以可能线程还没有真正走完<code>start</code>函数，套接字就被操作系统回收了</p> <p>那么是否改变一下套接字让其称为局部变量就可以解决问题呢？这里使用一个局部变量接收<code>accept</code>的返回值：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-31-1><span class=kt>int</span><span class=w> </span><span class=n>ac_socketfd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>accept</span><span class=p>(</span><span class=n>_listen_socketfd</span><span class=p>,</span><span class=w> </span><span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=k>struct</span><span class=w> </span><span class=nc>sockaddr</span><span class=w> </span><span class=o>*&gt;</span><span class=p>(</span><span class=o>&amp;</span><span class=n>peer</span><span class=p>),</span><span class=w> </span><span class=o>&amp;</span><span class=n>length</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>对应的，为了让读写函数可以看到这个套接字，就需要传递该套接字：</p> <div class="tabbed-set tabbed-alternate" data-tabs=5:2><input checked=checked id=__tabbed_5_1 name=__tabbed_5 type=radio><input id=__tabbed_5_2 name=__tabbed_5 type=radio><div class=tabbed-labels><label for=__tabbed_5_1>读写函数</label><label for=__tabbed_5_2>创建线程</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-32-1><span class=c1>// 读写函数</span>
</span><span id=__span-32-2><span class=kt>void</span><span class=w> </span><span class=nf>read_write_msg</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>sockaddr_in</span><span class=w> </span><span class=n>peer</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>ac_socketfd</span><span class=p>)</span>
</span><span id=__span-32-3><span class=p>{</span>
</span><span id=__span-32-4><span class=w>    </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>DEBUG</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;套接字：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>ac_socketfd</span><span class=p>;</span>
</span><span id=__span-32-5><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-32-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-32-7><span class=w>        </span><span class=c1>// 读取客户端消息</span>
</span><span id=__span-32-8><span class=w>        </span><span class=kt>char</span><span class=w> </span><span class=n>buffer</span><span class=p>[</span><span class=mi>4096</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span><span id=__span-32-9><span class=w>        </span><span class=kt>ssize_t</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>read</span><span class=p>(</span><span class=n>ac_socketfd</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>buffer</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-32-10><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-32-11><span class=w>        </span><span class=p>{</span>
</span><span id=__span-32-12><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Client: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>inet_ntoa</span><span class=p>(</span><span class=n>peer</span><span class=p>.</span><span class=n>sin_addr</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;:&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>ntohs</span><span class=p>(</span><span class=n>peer</span><span class=p>.</span><span class=n>sin_port</span><span class=p>))</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; send: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>buffer</span><span class=p>;</span>
</span><span id=__span-32-13>
</span><span id=__span-32-14><span class=w>            </span><span class=c1>// 向客户端回消息</span>
</span><span id=__span-32-15><span class=w>            </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>write</span><span class=p>(</span><span class=n>ac_socketfd</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>buffer</span><span class=p>));</span>
</span><span id=__span-32-16><span class=w>        </span><span class=p>}</span>
</span><span id=__span-32-17><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-32-18><span class=w>        </span><span class=p>{</span>
</span><span id=__span-32-19><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Client disconnected: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>ac_socketfd</span><span class=p>;</span>
</span><span id=__span-32-20><span class=w>            </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-32-21><span class=w>        </span><span class=p>}</span>
</span><span id=__span-32-22><span class=w>    </span><span class=p>}</span>
</span><span id=__span-32-23>
</span><span id=__span-32-24><span class=w>    </span><span class=n>close</span><span class=p>(</span><span class=n>ac_socketfd</span><span class=p>);</span>
</span><span id=__span-32-25><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-33-1><span class=n>Thread</span><span class=w> </span><span class=nf>t</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>bind</span><span class=p>(</span><span class=o>&amp;</span><span class=n>TcpServer</span><span class=o>::</span><span class=n>read_write_msg</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>peer</span><span class=p>,</span><span class=w> </span><span class=n>ac_socketfd</span><span class=p>));</span>
</span><span id=__span-33-2><span class=n>t</span><span class=p>.</span><span class=n>start</span><span class=p>();</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>运行修改后的代码可以发现结果还是一样：</p> <p><a class=glightbox href="23. TCP编程接口基本使用.assets/image-20250313211534241.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="23. TCP编程接口基本使用.assets/image-20250313211534241.png"></a></p> <p>这是因为还需要改变创建线程的方式，因为这里使用的是前面封装的线程库：启动和创建线程对象是分离的，这就导致了上面提到的问题：因为线程的执行是异步的，所以可能线程还没有真正走完<code>start</code>函数，并且因为这里的线程对象是一个局部变量，一旦当次循环结束就会被销毁，这样可能会影响到线程的执行，所以这里需要使用到原生创建线程的接口<code>pthread_create</code>进行改写：</p> <p>首先，原生创建线程的接口需要传递一个执行函数和参数，这里无法直接使用<code>read_write_msg</code>，所以额外需要一个成员函数，此处称为<code>routine</code>，并且为了保证不需要绑定传递<code>this</code>，考虑这个函数设置为<code>static</code>：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-34-1><span class=k>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=nf>routine</span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>args</span><span class=p>)</span>
</span><span id=__span-34-2><span class=p>{</span>
</span><span id=__span-34-3><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>接下来就要思考如何在<code>routine</code>中调用<code>read_write_msg</code>函数，因为<code>read_write_msg</code>是一个成员函数，所以需要使用到<code>this</code>进行调用，但是<code>static</code>并没有<code>this</code>，所以需要额外传递<code>this</code>，另外<code>read_write_msg</code>有1个参数，因此，需要给<code>routine</code>传递两个个参数，但是其只有一个<code>args</code>，这个时候就需要用到结构体：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-35-1><span class=k>class</span><span class=w> </span><span class=nc>TcpServer</span><span class=p>;</span>
</span><span id=__span-35-2>
</span><span id=__span-35-3><span class=k>struct</span><span class=w> </span><span class=nc>data</span>
</span><span id=__span-35-4><span class=p>{</span>
</span><span id=__span-35-5><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>sockaddr_in</span><span class=w> </span><span class=n>temp</span><span class=p>;</span>
</span><span id=__span-35-6><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>ac_socketfd</span><span class=p>;</span>
</span><span id=__span-35-7><span class=w>    </span><span class=n>TcpServer</span><span class=o>*</span><span class=w> </span><span class=n>self</span><span class=p>;</span>
</span><span id=__span-35-8><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>在上面的代码中，定义了一个<code>data</code>结构体，其中<code>self</code>就是用来接收<code>this</code>，需要注意的是，如果这个结构体写在<code>TcpServer</code>类之上需要使用<code>class TcpServer;</code>作为前置声明</p> <p>接着使用<code>pthread_create</code>创建线程：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-36-1><span class=n>pthread_t</span><span class=w> </span><span class=n>pid</span><span class=p>;</span>
</span><span id=__span-36-2><span class=k>struct</span><span class=w> </span><span class=nc>data</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=n>peer</span><span class=p>,</span><span class=w> </span><span class=n>ac_socketfd</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>};</span>
</span><span id=__span-36-3><span class=n>pthread_create</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=k>nullptr</span><span class=p>,</span><span class=w> </span><span class=n>routine</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>d</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>最后实现<code>routine</code>函数：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-37-1><span class=k>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=nf>routine</span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>args</span><span class=p>)</span>
</span><span id=__span-37-2><span class=p>{</span>
</span><span id=__span-37-3><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>data</span><span class=w> </span><span class=o>*</span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=k>struct</span><span class=w> </span><span class=nc>data</span><span class=w> </span><span class=o>*&gt;</span><span class=p>(</span><span class=n>args</span><span class=p>);</span>
</span><span id=__span-37-4><span class=w>    </span><span class=n>ptr</span><span class=o>-&gt;</span><span class=n>self</span><span class=o>-&gt;</span><span class=n>read_write_msg</span><span class=p>(</span><span class=n>ptr</span><span class=o>-&gt;</span><span class=n>temp</span><span class=p>,</span><span class=w> </span><span class=n>ptr</span><span class=o>-&gt;</span><span class=n>ac_socketfd</span><span class=p>);</span>
</span><span id=__span-37-5><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>nullptr</span><span class=p>;</span>
</span><span id=__span-37-6><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>此时再次编译运行就可以看到可以正常运行：</p> <p><a class=glightbox href="23. TCP编程接口基本使用.assets/image-20250313212054763.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="23. TCP编程接口基本使用.assets/image-20250313212054763.png"></a></p> <details class=question> <summary>拓展问题</summary> <p>如果不修改套接字为局部变量，只是更改线程的创建方式，会发现好像也可以解决问题：</p> <p><a class=glightbox href="23. TCP编程接口基本使用.assets/image-20250313212450144.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="23. TCP编程接口基本使用.assets/image-20250313212450144.png"></a></p> <p>但是事实真的如此吗？如果此时再创建一个新线程作为客户端连接就会发现问题：</p> <p><a class=glightbox href="23. TCP编程接口基本使用.assets/image-20250313212732811.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="23. TCP编程接口基本使用.assets/image-20250313212732811.png" alt=image-20250313212732811></a></p> <p>出现这个问题的关键就在于套接字已经被覆盖为新连接的套接字，导致原来的套接字失效，如果此时在后启动的客户端中再次发消息，就可以看到后启动的客户端响应了先启动的客户端发送的结果：</p> <p><a class=glightbox href="23. TCP编程接口基本使用.assets/image-20250313213238644.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="23. TCP编程接口基本使用.assets/image-20250313213238644.png"></a></p> </details> <h3 id=_21>线程池版本<a class=headerlink href=#_21 title="Permanent link">&para;</a></h3> <p>线程池版本和新线程版本的思路非常类似，给出代码不再演示：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span>
<span class=normal>59</span>
<span class=normal>60</span>
<span class=normal>61</span>
<span class=normal>62</span>
<span class=normal>63</span>
<span class=normal>64</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-38-1><span class=k>using</span><span class=w> </span><span class=n>task_t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>function</span><span class=o>&lt;</span><span class=kt>void</span><span class=p>()</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-38-2>
</span><span id=__span-38-3><span class=c1>// ...</span>
</span><span id=__span-38-4>
</span><span id=__span-38-5><span class=k>class</span><span class=w> </span><span class=nc>TcpServer</span>
</span><span id=__span-38-6><span class=p>{</span>
</span><span id=__span-38-7><span class=k>public</span><span class=o>:</span>
</span><span id=__span-38-8><span class=w>    </span><span class=n>TcpServer</span><span class=p>(</span><span class=kt>uint16_t</span><span class=w> </span><span class=n>port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>default_port</span><span class=p>)</span>
</span><span id=__span-38-9><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=n>_listen_socketfd</span><span class=p>(</span><span class=mi>-1</span><span class=p>),</span><span class=w> </span><span class=n>_port</span><span class=p>(</span><span class=n>port</span><span class=p>),</span><span class=w> </span><span class=n>_isRunning</span><span class=p>(</span><span class=nb>false</span><span class=p>),</span><span class=w> </span><span class=n>_ac_socketfd</span><span class=p>(</span><span class=mi>-1</span><span class=p>)</span>
</span><span id=__span-38-10><span class=w>    </span><span class=p>{</span>
</span><span id=__span-38-11><span class=w>        </span><span class=c1>// 创建服务器套接字</span>
</span><span id=__span-38-12><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-38-13>
</span><span id=__span-38-14><span class=w>        </span><span class=c1>// 绑定</span>
</span><span id=__span-38-15><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-38-16>
</span><span id=__span-38-17><span class=w>        </span><span class=c1>// 创建线程池</span>
</span><span id=__span-38-18><span class=w>        </span><span class=n>_tp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ThreadPool</span><span class=o>&lt;</span><span class=n>task_t</span><span class=o>&gt;::</span><span class=n>getInstance</span><span class=p>();</span>
</span><span id=__span-38-19><span class=w>        </span><span class=c1>// 启动线程池</span>
</span><span id=__span-38-20><span class=w>        </span><span class=n>_tp</span><span class=o>-&gt;</span><span class=n>startThreads</span><span class=p>();</span>
</span><span id=__span-38-21>
</span><span id=__span-38-22><span class=w>        </span><span class=c1>// 监听</span>
</span><span id=__span-38-23><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-38-24><span class=w>    </span><span class=p>}</span>
</span><span id=__span-38-25>
</span><span id=__span-38-26><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-38-27>
</span><span id=__span-38-28><span class=w>    </span><span class=c1>// 启动服务器</span>
</span><span id=__span-38-29><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-38-30><span class=w>    </span><span class=p>{</span>
</span><span id=__span-38-31><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>_isRunning</span><span class=p>)</span>
</span><span id=__span-38-32><span class=w>        </span><span class=p>{</span>
</span><span id=__span-38-33><span class=w>            </span><span class=n>_isRunning</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-38-34>
</span><span id=__span-38-35><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-38-36><span class=w>            </span><span class=p>{</span>
</span><span id=__span-38-37><span class=w>                </span><span class=c1>// ...</span>
</span><span id=__span-38-38>
</span><span id=__span-38-39><span class=w>                </span><span class=c1>// version-3</span>
</span><span id=__span-38-40><span class=w>                </span><span class=n>_tp</span><span class=o>-&gt;</span><span class=n>pushTasks</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>bind</span><span class=p>(</span><span class=o>&amp;</span><span class=n>TcpServer</span><span class=o>::</span><span class=n>read_write_msg</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>peer</span><span class=p>,</span><span class=w> </span><span class=n>ac_socketfd</span><span class=p>));</span>
</span><span id=__span-38-41><span class=w>            </span><span class=p>}</span>
</span><span id=__span-38-42><span class=w>        </span><span class=p>}</span>
</span><span id=__span-38-43><span class=w>    </span><span class=p>}</span>
</span><span id=__span-38-44>
</span><span id=__span-38-45><span class=w>    </span><span class=c1>// 停止服务器</span>
</span><span id=__span-38-46><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>stop</span><span class=p>()</span>
</span><span id=__span-38-47><span class=w>    </span><span class=p>{</span>
</span><span id=__span-38-48><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_isRunning</span><span class=p>)</span>
</span><span id=__span-38-49><span class=w>        </span><span class=p>{</span>
</span><span id=__span-38-50><span class=w>            </span><span class=n>_tp</span><span class=o>-&gt;</span><span class=n>stopThreads</span><span class=p>();</span>
</span><span id=__span-38-51><span class=w>            </span><span class=c1>// ...</span>
</span><span id=__span-38-52><span class=w>        </span><span class=p>}</span>
</span><span id=__span-38-53><span class=w>    </span><span class=p>}</span>
</span><span id=__span-38-54>
</span><span id=__span-38-55><span class=w>    </span><span class=o>~</span><span class=n>TcpServer</span><span class=p>()</span>
</span><span id=__span-38-56><span class=w>    </span><span class=p>{</span>
</span><span id=__span-38-57><span class=w>        </span><span class=n>stop</span><span class=p>();</span>
</span><span id=__span-38-58><span class=w>    </span><span class=p>}</span>
</span><span id=__span-38-59>
</span><span id=__span-38-60><span class=k>private</span><span class=o>:</span>
</span><span id=__span-38-61><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-38-62><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>ThreadPool</span><span class=o>&lt;</span><span class=n>task_t</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>_tp</span><span class=p>;</span>
</span><span id=__span-38-63><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-38-64><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>此处运行结果与新线程相同，此处不再演示</p> <h2 id=_22>客户端控制服务器执行相关命令的程序<a class=headerlink href=#_22 title="Permanent link">&para;</a></h2> <h3 id=_23>思路分析<a class=headerlink href=#_23 title="Permanent link">&para;</a></h3> <p>既然需要客户端控制服务器执行命令就必须要经历下面的步骤：</p> <ol> <li>客户端将命令字符串发送给服务端</li> <li>服务端创建子进程，利用进程间通信将分析后的命令交给子进程，子进程调用<code>exec</code>家族函数将命令执行的结果通过服务器发送给客户端</li> </ol> <h3 id=_24>实现<a class=headerlink href=#_24 title="Permanent link">&para;</a></h3> <p>因为服务端本身就是进行接收和返回结果，所以考虑将命令执行单独作为一个类来描述，本次为了执行的安全，考虑只允许用户执行部分命令，并且提供判断命令是否是合法命令，所以少不了需要查询的接口，为了更快速的查询，可以使用<code>set</code>集合。另外，因为要执行命令，所以需要一个成员函数<code>executeCommand</code>执行对应的命令，所以基本结构如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-39-1><span class=k>class</span><span class=w> </span><span class=nc>Command</span>
</span><span id=__span-39-2><span class=p>{</span>
</span><span id=__span-39-3><span class=w>    </span><span class=n>Command</span><span class=p>()</span>
</span><span id=__span-39-4><span class=w>    </span><span class=p>{</span>
</span><span id=__span-39-5><span class=w>        </span><span class=c1>// 构造可以执行的一些命令</span>
</span><span id=__span-39-6><span class=w>        </span><span class=n>_commands</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=s>&quot;ls&quot;</span><span class=p>);</span>
</span><span id=__span-39-7><span class=w>        </span><span class=n>_commands</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=s>&quot;pwd&quot;</span><span class=p>);</span>
</span><span id=__span-39-8><span class=w>        </span><span class=n>_commands</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=s>&quot;ll&quot;</span><span class=p>);</span>
</span><span id=__span-39-9><span class=w>        </span><span class=n>_commands</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=s>&quot;touch&quot;</span><span class=p>);</span>
</span><span id=__span-39-10><span class=w>        </span><span class=n>_commands</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=s>&quot;who&quot;</span><span class=p>);</span>
</span><span id=__span-39-11><span class=w>        </span><span class=n>_commands</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=s>&quot;whoami&quot;</span><span class=p>);</span>
</span><span id=__span-39-12><span class=w>    </span><span class=p>}</span>
</span><span id=__span-39-13>
</span><span id=__span-39-14><span class=w>    </span><span class=c1>// 判断命令是否合法</span>
</span><span id=__span-39-15><span class=w>    </span><span class=kt>bool</span><span class=w> </span><span class=n>isValid</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>cmd</span><span class=p>)</span>
</span><span id=__span-39-16><span class=w>    </span><span class=p>{</span>
</span><span id=__span-39-17><span class=w>        </span><span class=k>auto</span><span class=w> </span><span class=n>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_commands</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>cmd</span><span class=p>);</span>
</span><span id=__span-39-18><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pos</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>_commands</span><span class=p>.</span><span class=n>end</span><span class=p>())</span>
</span><span id=__span-39-19><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-39-20><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-39-21><span class=w>    </span><span class=p>}</span>
</span><span id=__span-39-22>
</span><span id=__span-39-23><span class=w>    </span><span class=c1>// 执行命令</span>
</span><span id=__span-39-24><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>executeCommand</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>cmd</span><span class=p>)</span>
</span><span id=__span-39-25><span class=w>    </span><span class=p>{</span>
</span><span id=__span-39-26><span class=w>    </span><span class=p>}</span>
</span><span id=__span-39-27>
</span><span id=__span-39-28><span class=w>    </span><span class=o>~</span><span class=n>Command</span><span class=p>()</span>
</span><span id=__span-39-29><span class=w>    </span><span class=p>{</span>
</span><span id=__span-39-30><span class=w>    </span><span class=p>}</span>
</span><span id=__span-39-31>
</span><span id=__span-39-32><span class=k>private</span><span class=o>:</span>
</span><span id=__span-39-33><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>set</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=w> </span><span class=n>_commands</span><span class=p>;</span>
</span><span id=__span-39-34><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>接着，改变服务端的读写任务的接口，此处不再使用文件的<code>read</code>和<code>write</code>接口，而是使用<code>recv</code>和<code>send</code>接口，这两个接口只是比<code>read</code>和<code>write</code>多了<code>flags</code>，其余都一样，并且目前情况下<code>flags</code>设置为0即可：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-40-1><span class=c1>// 读写函数</span>
</span><span id=__span-40-2><span class=kt>void</span><span class=w> </span><span class=nf>read_write_msg</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>sockaddr_in</span><span class=w> </span><span class=n>peer</span><span class=p>)</span>
</span><span id=__span-40-3><span class=p>{</span>
</span><span id=__span-40-4><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-40-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-40-6><span class=w>        </span><span class=c1>// 读取客户端消息</span>
</span><span id=__span-40-7><span class=w>        </span><span class=kt>char</span><span class=w> </span><span class=n>buffer</span><span class=p>[</span><span class=mi>4096</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span><span id=__span-40-8><span class=w>        </span><span class=kt>ssize_t</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>recv</span><span class=p>(</span><span class=n>_ac_socketfd</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>buffer</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-40-9><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-40-10><span class=w>        </span><span class=p>{</span>
</span><span id=__span-40-11><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Client: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>inet_ntoa</span><span class=p>(</span><span class=n>peer</span><span class=p>.</span><span class=n>sin_addr</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;:&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>ntohs</span><span class=p>(</span><span class=n>peer</span><span class=p>.</span><span class=n>sin_port</span><span class=p>))</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; send: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>buffer</span><span class=p>;</span>
</span><span id=__span-40-12>
</span><span id=__span-40-13><span class=w>            </span><span class=c1>// 向客户端回消息</span>
</span><span id=__span-40-14><span class=w>            </span><span class=n>Command</span><span class=w> </span><span class=n>cmd</span><span class=p>;</span>
</span><span id=__span-40-15><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cmd</span><span class=p>.</span><span class=n>isValid</span><span class=p>(</span><span class=n>buffer</span><span class=p>))</span>
</span><span id=__span-40-16><span class=w>            </span><span class=p>{</span>
</span><span id=__span-40-17><span class=w>                </span><span class=c1>// 命令合法可以执行命令</span>
</span><span id=__span-40-18><span class=w>                </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cmd</span><span class=p>.</span><span class=n>executeCommand</span><span class=p>(</span><span class=n>buffer</span><span class=p>);</span>
</span><span id=__span-40-19><span class=w>                </span><span class=n>send</span><span class=p>(</span><span class=n>_ac_socketfd</span><span class=p>,</span><span class=w> </span><span class=n>ret</span><span class=p>.</span><span class=n>c_str</span><span class=p>(),</span><span class=w> </span><span class=n>ret</span><span class=p>.</span><span class=n>size</span><span class=p>(),</span><span class=w> </span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-40-20><span class=w>            </span><span class=p>}</span>
</span><span id=__span-40-21><span class=w>            </span><span class=k>else</span>
</span><span id=__span-40-22><span class=w>            </span><span class=p>{</span>
</span><span id=__span-40-23><span class=w>                </span><span class=n>send</span><span class=p>(</span><span class=n>_ac_socketfd</span><span class=p>,</span><span class=w> </span><span class=s>&quot;错误指令&quot;</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=s>&quot;错误指令&quot;</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-40-24><span class=w>            </span><span class=p>}</span>
</span><span id=__span-40-25><span class=w>        </span><span class=p>}</span>
</span><span id=__span-40-26><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-40-27><span class=w>    </span><span class=p>}</span>
</span><span id=__span-40-28>
</span><span id=__span-40-29><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-40-30><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>接下来就是实现执行命令函数，根据前面的分析需要创建子进程调用<code>exec</code>家族函数执行对应的命令，但是在标准库中有对应的接口已经实现了这个功能：<code>popen</code>，其原型如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-41-1><span class=kt>FILE</span><span class=w> </span><span class=o>*</span><span class=nf>popen</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>command</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>type</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>对应的接口就是<code>pclose</code>接口，原型如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-42-1><span class=kt>int</span><span class=w> </span><span class=nf>pclose</span><span class=p>(</span><span class=kt>FILE</span><span class=w> </span><span class=o>*</span><span class=n>stream</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>对于<code>popen</code>接口来说，其会对传入的命令进行分析并创建子进程执行，将执行结果放到返回值中，因为<code>FILE</code>是文件结构，所以只需要使用文件的读写接口即可读取到其中的内容，这个接口第二个参数表示读模式或者写模式，因为是执行命令，所以只需要填入<code>"r"</code>即可</p> <p>结合上面的接口即可完成对应的执行命令函数：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-43-1><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=nf>executeCommand</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>cmd</span><span class=p>)</span>
</span><span id=__span-43-2><span class=p>{</span>
</span><span id=__span-43-3><span class=w>    </span><span class=kt>FILE</span><span class=w> </span><span class=o>*</span><span class=n>fp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>popen</span><span class=p>(</span><span class=n>cmd</span><span class=p>.</span><span class=n>c_str</span><span class=p>(),</span><span class=w> </span><span class=s>&quot;r&quot;</span><span class=p>);</span>
</span><span id=__span-43-4><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>fp</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=k>nullptr</span><span class=p>)</span>
</span><span id=__span-43-5><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=p>();</span>
</span><span id=__span-43-6><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>buffer</span><span class=p>[</span><span class=mi>1024</span><span class=p>];</span>
</span><span id=__span-43-7><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>result</span><span class=p>;</span>
</span><span id=__span-43-8><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>fgets</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>buffer</span><span class=p>),</span><span class=w> </span><span class=n>fp</span><span class=p>))</span>
</span><span id=__span-43-9><span class=w>    </span><span class=p>{</span>
</span><span id=__span-43-10><span class=w>        </span><span class=n>result</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>buffer</span><span class=p>;</span>
</span><span id=__span-43-11><span class=w>    </span><span class=p>}</span>
</span><span id=__span-43-12><span class=w>    </span><span class=n>pclose</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span><span id=__span-43-13><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span>
</span><span id=__span-43-14><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p><code>fgets</code>会自动添加<code>\0</code>，不需要预留<code>\0</code>的位置</p> </div> <h3 id=_25>测试<a class=headerlink href=#_25 title="Permanent link">&para;</a></h3> <p>服务端主函数代码和客户端主函数代码不变，下面是测试结果：</p> <p><a class=glightbox href="23. TCP编程接口基本使用.assets\Snipaste_2025-03-04_21-48-25.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="23. TCP编程接口基本使用.assets\Snipaste_2025-03-04_21-48-25.png"></a></p> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title=最后更新> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2025年8月4日</span> </span> </aside> <form class=md-feedback name=feedback hidden> <fieldset> <legend class=md-feedback__title> 页面有帮助吗？ </legend> <div class=md-feedback__inner> <div class=md-feedback__list> <button class="md-feedback__icon md-icon" type=submit title=页面对我有帮助 data-md-value=1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 9v12H1V9zm4 12a2 2 0 0 1-2-2V9c0-.55.22-1.05.59-1.41L14.17 1l1.06 1.06c.27.27.44.64.44 1.05l-.03.32L14.69 8H21a2 2 0 0 1 2 2v2c0 .26-.05.5-.14.73l-3.02 7.05C19.54 20.5 18.83 21 18 21zm0-2h9.03L21 12v-2h-8.79l1.13-5.32L9 9.03z"/></svg> </button> <button class="md-feedback__icon md-icon" type=submit title=页面没有帮助到我 data-md-value=0> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 15V3h4v12zM15 3a2 2 0 0 1 2 2v10c0 .55-.22 1.05-.59 1.41L9.83 23l-1.06-1.06c-.27-.27-.44-.64-.44-1.06l.03-.31.95-4.57H3a2 2 0 0 1-2-2v-2c0-.26.05-.5.14-.73l3.02-7.05C4.46 3.5 5.17 3 6 3zm0 2H5.97L3 12v2h8.78l-1.13 5.32L15 14.97z"/></svg> </button> </div> <div class=md-feedback__note> <div data-md-value=1 hidden> 谢谢你的反馈！ </div> <div data-md-value=0 hidden> 谢谢你的反馈！联系<a href=https://www.help-doc.top/author/contact/contact.html>作者</a>提供更详细的信息 </div> </div> </div> </fieldset> </form> <!-- Waline 评论系统 --> <div id=waline></div> <!-- Waline 评论系统 --> <div id=waline></div> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2024-2025 柯懒不是柯南 </div> </div> <div class="md-footer-love md-typeset"> 一闪一闪亮晶晶，不及<span class=love-highlight>小亮</span><span class=love-heart>♥</span>照我心。To Li Liang </div> <div class=md-social> <a href=https://github.com/H0308 target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://www.help-doc.top/author/contact/contact.html target=_blank rel=noopener title=www.help-doc.top class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M433.754 420.445c-11.526 1.393-44.86-52.741-44.86-52.741 0 31.345-16.136 72.247-51.051 101.786 16.842 5.192 54.843 19.167 45.803 34.421-7.316 12.343-125.51 7.881-159.632 4.037-34.122 3.844-152.316 8.306-159.632-4.037-9.045-15.25 28.918-29.214 45.783-34.415-34.92-29.539-51.059-70.445-51.059-101.792 0 0-33.334 54.134-44.859 52.741-5.37-.65-12.424-29.644 9.347-99.704 10.261-33.024 21.995-60.478 40.144-105.779C60.683 98.063 108.982.006 224 0c113.737.006 163.156 96.133 160.264 214.963 18.118 45.223 29.912 72.85 40.144 105.778 21.768 70.06 14.716 99.053 9.346 99.704"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.indexes", "navigation.prune", "navigation.tabs", "search.highlight", "content.code.copy"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script> <script src=../../assets/javascripts/bundle.c8b220af.min.js></script> <script src=../../javascripts/katex.min.js></script> <script src=../../javascripts/other.min.js></script> <script src=../../javascripts/copyright.min.js></script> <script src=../../javascripts/waline.min.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/contrib/auto-render.min.js></script> <script src=https://cdn.jsdelivr.net/npm/mermaid@11.5.0/dist/mermaid.min.js></script> <script src=../../assets/javascripts/toggle-sidebar.js async></script> <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body> </html>