<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://www.help-doc.top/cpp/multi-thread/multi-thread.html><link rel=prev href=../time-rand/time-rand.html><link rel=next href=../format/format.html><link rel=icon href=../../images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.12"><title>C++并发支持库 - 柯懒的知识库</title><link rel=stylesheet href=../../assets/stylesheets/main.2afb09e1.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=stylesheet href=../../css/timeline.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-9XWRGNRRSY"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-9XWRGNRRSY",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-9XWRGNRRSY",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script><link rel=preload href=../../assets/stylesheets/main.2afb09e1.min.css as=style><link rel=preload href=../../assets/stylesheets/palette.06af60db.min.css as=style><link rel=preload href=../../stylesheets/docsearch.min.css as=style><link rel=preload href=../../stylesheets/colors.min.css as=style><link rel=preload href=../../stylesheets/theme2.min.css as=style><link rel=preload href=../../javascripts/start.min.js as=script><link rel=preload href=../../author/作者.assets/20250206-200653.jpg as=image><link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css as=style><link rel=dns-prefetch href=//unpkg.com><link rel=dns-prefetch href=//cloud.umami.is><link rel=stylesheet href=../../stylesheets/colors.min.css><link rel=stylesheet href=../../stylesheets/theme2.min.css media="screen and (max-width: 1199px)"><link rel=stylesheet href=../../stylesheets/theme1.min.css media="screen and (min-width: 1200px)"><link rel=stylesheet href=../../stylesheets/theme2.min.css media="screen and (min-width: 1200px)"><link rel=stylesheet href=../../stylesheets/print.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@docsearch/css@3><link rel=stylesheet href=../../stylesheets/docsearch.min.css><script src=../../javascripts/start.min.js></script><script defer src=https://cloud.umami.is/script.js data-website-id=02f9b8b7-93d4-4026-bdd8-221f2fcea2cf></script> <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=cyan> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#c class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../index.html title=柯懒的知识库 class="md-header__button md-logo" aria-label=柯懒的知识库 data-md-component=logo> <img src=../../assets/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> 柯懒的知识库 </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> C++并发支持库 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=cyan aria-label type=radio name=__palette id=__palette_1> </form> <div class=header-avatar> <img src=../../author/作者.assets/20250206-200653.jpg alt=头像> <div class=avatar-dropdown> <p><strong>柯懒不是柯南</strong></p> <a href=../../author/contact/contact.html class=avatar-dropdown-item>联系作者</a> <div class=avatar-dropdown-divider></div> <a href=../../author/about/about.html class=avatar-dropdown-item>关于作者</a> <div class=avatar-dropdown-divider></div> <a href=https://github.com/H0308 class=avatar-dropdown-item>Github仓库</a> </div> </div> <div id=docsearch></div> </nav> </header> <div class=back-to-top-btn id=backToTopBtn onclick="window.scrollTo({top: 0})"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg> <path fill=currentColor d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/> </svg> </div> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../index.html class=md-tabs__link> 主页 </a> </li> <li class=md-tabs__item> <a href=../../timeline/timeline.html class=md-tabs__link> 网站时间线 </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../languages/index.html class=md-tabs__link> 编程语言 </a> </li> <li class=md-tabs__item> <a href=../../data-structure-algo/index.html class=md-tabs__link> 数据结构与算法 </a> </li> <li class=md-tabs__item> <a href=../../Linux/index.html class=md-tabs__link> Linux </a> </li> <li class=md-tabs__item> <a href=../../front-end/index.html class=md-tabs__link> 前端 </a> </li> <li class=md-tabs__item> <a href=../../MySQL/index.html class=md-tabs__link> MySQL </a> </li> <li class=md-tabs__item> <a href=../../JavaEE/index.html class=md-tabs__link> JavaEE应用开发 </a> </li> <li class=md-tabs__item> <a href=../../software-test/index.html class=md-tabs__link> 软件测试 </a> </li> <li class=md-tabs__item> <a href=../../other/index.html class=md-tabs__link> 扩展知识 </a> </li> <li class=md-tabs__item> <a href=../../tooltips/index.html class=md-tabs__link> 工具帮助 </a> </li> <li class=md-tabs__item> <a href=../../test-encrypt/test-encrypt.html class=md-tabs__link> 测试加密功能 </a> </li> <li class=md-tabs__item> <a href=../../projects/index.html class=md-tabs__link> 项目 </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../index.html title=柯懒的知识库 class="md-nav__button md-logo" aria-label=柯懒的知识库 data-md-component=logo> <img src=../../assets/logo.png alt=logo> </a> 柯懒的知识库 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../index.html class=md-nav__link> <span class=md-ellipsis> 主页 </span> </a> </li> <li class=md-nav__item> <a href=../../timeline/timeline.html class=md-nav__link> <span class=md-ellipsis> 网站时间线 </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <div class="md-nav__link md-nav__container"> <a href=../../languages/index.html class="md-nav__link "> <span class=md-ellipsis> 编程语言 </span> </a> <label class="md-nav__link " for=__nav_3 id=__nav_3_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> 编程语言 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../c-lang/index.html class=md-nav__link> <span class=md-ellipsis> C语言 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_3 checked> <div class="md-nav__link md-nav__container"> <a href=../index.html class="md-nav__link "> <span class=md-ellipsis> C++ </span> </a> <label class="md-nav__link " for=__nav_3_3 id=__nav_3_3_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> C++ </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../c-to-cpp/c-to-cpp.html class=md-nav__link> <span class=md-ellipsis> C语言过渡C++基础知识 </span> </a> </li> <li class=md-nav__item> <a href=../class-obj/class-obj.html class=md-nav__link> <span class=md-ellipsis> C++类和对象 </span> </a> </li> <li class=md-nav__item> <a href=../member-func/member-func.html class=md-nav__link> <span class=md-ellipsis> C++默认成员函数 </span> </a> </li> <li class=md-nav__item> <a href=../class-obj-other/class-obj-other.html class=md-nav__link> <span class=md-ellipsis> C++类和对象相关内容 </span> </a> </li> <li class=md-nav__item> <a href=../memory/memory.html class=md-nav__link> <span class=md-ellipsis> C++内存管理 </span> </a> </li> <li class=md-nav__item> <a href=../template/template.html class=md-nav__link> <span class=md-ellipsis> C++模版 </span> </a> </li> <li class=md-nav__item> <a href=../stl-intro-string/stl-intro-string.html class=md-nav__link> <span class=md-ellipsis> C++STL简介与string类 </span> </a> </li> <li class=md-nav__item> <a href=../sim-string/sim-string.html class=md-nav__link> <span class=md-ellipsis> string类模拟实现 </span> </a> </li> <li class=md-nav__item> <a href=../vector/vector.html class=md-nav__link> <span class=md-ellipsis> vector类 </span> </a> </li> <li class=md-nav__item> <a href=../sim-vector/sim-vector.html class=md-nav__link> <span class=md-ellipsis> vector类模拟实现 </span> </a> </li> <li class=md-nav__item> <a href=../list/list.html class=md-nav__link> <span class=md-ellipsis> list类 </span> </a> </li> <li class=md-nav__item> <a href=../sim-list/sim-list.html class=md-nav__link> <span class=md-ellipsis> list类模拟实现 </span> </a> </li> <li class=md-nav__item> <a href=../stack/stack.html class=md-nav__link> <span class=md-ellipsis> stack类 </span> </a> </li> <li class=md-nav__item> <a href=../queue-priority-queue/queue-priority-queue.html class=md-nav__link> <span class=md-ellipsis> queue与priority_queue类 </span> </a> </li> <li class=md-nav__item> <a href=../sim-stack-queue/sim-stack-queue.html class=md-nav__link> <span class=md-ellipsis> stack和queue模拟实现 </span> </a> </li> <li class=md-nav__item> <a href=../sim-priority-queue/sim-priority-queue.html class=md-nav__link> <span class=md-ellipsis> priority_queue模拟实现 </span> </a> </li> <li class=md-nav__item> <a href=../reverse-iterator/reverse-iterator.html class=md-nav__link> <span class=md-ellipsis> 反向迭代器设计 </span> </a> </li> <li class=md-nav__item> <a href=../extend/extend.html class=md-nav__link> <span class=md-ellipsis> C++继承 </span> </a> </li> <li class=md-nav__item> <a href=../polymorphic/polymorphic.html class=md-nav__link> <span class=md-ellipsis> C++多态 </span> </a> </li> <li class=md-nav__item> <a href=../set/set.html class=md-nav__link> <span class=md-ellipsis> set类 </span> </a> </li> <li class=md-nav__item> <a href=../map/map.html class=md-nav__link> <span class=md-ellipsis> map类 </span> </a> </li> <li class=md-nav__item> <a href=../sim-map-set/sim-map-set.html class=md-nav__link> <span class=md-ellipsis> map和set类模拟实现 </span> </a> </li> <li class=md-nav__item> <a href=../sim-unordered-map-set/sim-unordered-map-set.html class=md-nav__link> <span class=md-ellipsis> unordered_map和unordered_set类模拟实现 </span> </a> </li> <li class=md-nav__item> <a href=../bitset/bitset.html class=md-nav__link> <span class=md-ellipsis> bitset类 </span> </a> </li> <li class=md-nav__item> <a href=../initializer-list/initializer-list.html class=md-nav__link> <span class=md-ellipsis> initializer_list类 </span> </a> </li> <li class=md-nav__item> <a href=../new-in-cpp11/new-in-cpp11.html class=md-nav__link> <span class=md-ellipsis> C++ 11相关新特性 </span> </a> </li> <li class=md-nav__item> <a href=../exception/exception.html class=md-nav__link> <span class=md-ellipsis> C++异常 </span> </a> </li> <li class=md-nav__item> <a href=../smart-ptr/smart-ptr.html class=md-nav__link> <span class=md-ellipsis> C++智能指针 </span> </a> </li> <li class=md-nav__item> <a href=../special-class-design/special-class-design.html class=md-nav__link> <span class=md-ellipsis> 特殊类设计 </span> </a> </li> <li class=md-nav__item> <a href=../type-cast/type-cast.html class=md-nav__link> <span class=md-ellipsis> C++中的类型转换 </span> </a> </li> <li class=md-nav__item> <a href=../cppio/cppio.html class=md-nav__link> <span class=md-ellipsis> C++ IO流 </span> </a> </li> <li class=md-nav__item> <a href=../new-in-cpp17/new-in-cpp17.html class=md-nav__link> <span class=md-ellipsis> C++ 17相关新特性 </span> </a> </li> <li class=md-nav__item> <a href=../time-rand/time-rand.html class=md-nav__link> <span class=md-ellipsis> C++时间和随机数相关库 </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> C++并发支持库 </span> <span class="md-nav__icon md-icon"></span> </label> <a href=multi-thread.html class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> C++并发支持库 </span> </a> <nav class="md-nav md-nav--secondary" aria-label=本节目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 本节目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#thread class=md-nav__link> <span class=md-ellipsis> 线程库&lt;thread&gt; </span> </a> <nav class=md-nav aria-label="线程库<thread>"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 构造函数 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 成员函数 </span> </a> </li> <li class=md-nav__item> <a href=#this_thread class=md-nav__link> <span class=md-ellipsis> this_thread命名空间 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#mutex class=md-nav__link> <span class=md-ellipsis> 互斥锁库&lt;mutex&gt; </span> </a> <nav class=md-nav aria-label="互斥锁库<mutex>"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 互斥锁类型 </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 互斥锁相关工具 </span> </a> </li> <li class=md-nav__item> <a href=#locktry_lock class=md-nav__link> <span class=md-ellipsis> 防止死锁的模板函数lock和try_lock </span> </a> </li> <li class=md-nav__item> <a href=#call_once class=md-nav__link> <span class=md-ellipsis> 同一个线程内只执行一次的模版函数call_once </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#atomic class=md-nav__link> <span class=md-ellipsis> 原子操作库&lt;atomic&gt; </span> </a> <nav class=md-nav aria-label="原子操作库<atomic>"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 基本介绍 </span> </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> 原子操作原理 </span> </a> </li> <li class=md-nav__item> <a href=#cas class=md-nav__link> <span class=md-ellipsis> 原子库中针对CAS操作的函数 </span> </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 原子操作函数 </span> </a> <nav class=md-nav aria-label=原子操作函数> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> 原子修改操作（带返回值） </span> </a> </li> <li class=md-nav__item> <a href=#stdatomic_flag class=md-nav__link> <span class=md-ellipsis> 原子标志（std::atomic_flag） </span> </a> </li> <li class=md-nav__item> <a href=#_9 class=md-nav__link> <span class=md-ellipsis> 其他辅助函数 </span> </a> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> <span class=md-ellipsis> 特殊操作（适用于整数和指针类型） </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#condition_variable class=md-nav__link> <span class=md-ellipsis> 条件变量库&lt;condition_variable&gt; </span> </a> <nav class=md-nav aria-label="条件变量库<condition_variable>"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_11 class=md-nav__link> <span class=md-ellipsis> 条件变量类 </span> </a> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> <span class=md-ellipsis> 核心操作 </span> </a> </li> <li class=md-nav__item> <a href=#_13 class=md-nav__link> <span class=md-ellipsis> 基本使用模式 </span> </a> </li> <li class=md-nav__item> <a href=#_14 class=md-nav__link> <span class=md-ellipsis> 案例：实现奇数偶数交替打印 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#future class=md-nav__link> <span class=md-ellipsis> 异步操作库&lt;future&gt; </span> </a> <nav class=md-nav aria-label="异步操作库<future>"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_15 class=md-nav__link> <span class=md-ellipsis> 基本概念 </span> </a> </li> <li class=md-nav__item> <a href=#_16 class=md-nav__link> <span class=md-ellipsis> 主要组件 </span> </a> </li> <li class=md-nav__item> <a href=#stdfuture class=md-nav__link> <span class=md-ellipsis> std::future的详细使用 </span> </a> <nav class=md-nav aria-label=std::future的详细使用> <ul class=md-nav__list> <li class=md-nav__item> <a href=#stdasyncstdfuture class=md-nav__link> <span class=md-ellipsis> 使用std::async创建std::future </span> </a> </li> <li class=md-nav__item> <a href=#stdfuture_1 class=md-nav__link> <span class=md-ellipsis> std::future的常用方法 </span> </a> </li> <li class=md-nav__item> <a href=#stdfuture_status class=md-nav__link> <span class=md-ellipsis> std::future_status类型 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#stdpromise class=md-nav__link> <span class=md-ellipsis> std::promise 的介绍 </span> </a> </li> <li class=md-nav__item> <a href=#stdpackaged_task class=md-nav__link> <span class=md-ellipsis> std::packaged_task的介绍 </span> </a> </li> <li class=md-nav__item> <a href=#futurepromiseasyncpackaged_task class=md-nav__link> <span class=md-ellipsis> future、promise、async和packaged_task之间的关系和区别 </span> </a> </li> <li class=md-nav__item> <a href=#stdshared_future class=md-nav__link> <span class=md-ellipsis> std::shared_future的介绍 </span> </a> <nav class=md-nav aria-label=std::shared_future的介绍> <ul class=md-nav__list> <li class=md-nav__item> <a href=#stdshared_future_1 class=md-nav__link> <span class=md-ellipsis> 创建std::shared_future </span> </a> </li> <li class=md-nav__item> <a href=#stdshared_future_2 class=md-nav__link> <span class=md-ellipsis> std::shared_future的常用方法 </span> </a> </li> <li class=md-nav__item> <a href=#_17 class=md-nav__link> <span class=md-ellipsis> 多线程共享结果示例 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_18 class=md-nav__link> <span class=md-ellipsis> 使用并发支持库实现简易的线程池 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../format/format.html class=md-nav__link> <span class=md-ellipsis> C++中的格式化字符串 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../Java/index.html class=md-nav__link> <span class=md-ellipsis> Java </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../python/index.html class=md-nav__link> <span class=md-ellipsis> Python </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../data-structure-algo/index.html class=md-nav__link> <span class=md-ellipsis> 数据结构与算法 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../Linux/index.html class=md-nav__link> <span class=md-ellipsis> Linux </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../front-end/index.html class=md-nav__link> <span class=md-ellipsis> 前端 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../MySQL/index.html class=md-nav__link> <span class=md-ellipsis> MySQL </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../JavaEE/index.html class=md-nav__link> <span class=md-ellipsis> JavaEE应用开发 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../software-test/index.html class=md-nav__link> <span class=md-ellipsis> 软件测试 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../other/index.html class=md-nav__link> <span class=md-ellipsis> 扩展知识 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../tooltips/index.html class=md-nav__link> <span class=md-ellipsis> 工具帮助 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../test-encrypt/test-encrypt.html class=md-nav__link> <span class=md-ellipsis> 测试加密功能 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../projects/index.html class=md-nav__link> <span class=md-ellipsis> 项目 </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=本节目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 本节目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#thread class=md-nav__link> <span class=md-ellipsis> 线程库&lt;thread&gt; </span> </a> <nav class=md-nav aria-label="线程库<thread>"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 构造函数 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 成员函数 </span> </a> </li> <li class=md-nav__item> <a href=#this_thread class=md-nav__link> <span class=md-ellipsis> this_thread命名空间 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#mutex class=md-nav__link> <span class=md-ellipsis> 互斥锁库&lt;mutex&gt; </span> </a> <nav class=md-nav aria-label="互斥锁库<mutex>"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 互斥锁类型 </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 互斥锁相关工具 </span> </a> </li> <li class=md-nav__item> <a href=#locktry_lock class=md-nav__link> <span class=md-ellipsis> 防止死锁的模板函数lock和try_lock </span> </a> </li> <li class=md-nav__item> <a href=#call_once class=md-nav__link> <span class=md-ellipsis> 同一个线程内只执行一次的模版函数call_once </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#atomic class=md-nav__link> <span class=md-ellipsis> 原子操作库&lt;atomic&gt; </span> </a> <nav class=md-nav aria-label="原子操作库<atomic>"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 基本介绍 </span> </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> 原子操作原理 </span> </a> </li> <li class=md-nav__item> <a href=#cas class=md-nav__link> <span class=md-ellipsis> 原子库中针对CAS操作的函数 </span> </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 原子操作函数 </span> </a> <nav class=md-nav aria-label=原子操作函数> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> 原子修改操作（带返回值） </span> </a> </li> <li class=md-nav__item> <a href=#stdatomic_flag class=md-nav__link> <span class=md-ellipsis> 原子标志（std::atomic_flag） </span> </a> </li> <li class=md-nav__item> <a href=#_9 class=md-nav__link> <span class=md-ellipsis> 其他辅助函数 </span> </a> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> <span class=md-ellipsis> 特殊操作（适用于整数和指针类型） </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#condition_variable class=md-nav__link> <span class=md-ellipsis> 条件变量库&lt;condition_variable&gt; </span> </a> <nav class=md-nav aria-label="条件变量库<condition_variable>"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_11 class=md-nav__link> <span class=md-ellipsis> 条件变量类 </span> </a> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> <span class=md-ellipsis> 核心操作 </span> </a> </li> <li class=md-nav__item> <a href=#_13 class=md-nav__link> <span class=md-ellipsis> 基本使用模式 </span> </a> </li> <li class=md-nav__item> <a href=#_14 class=md-nav__link> <span class=md-ellipsis> 案例：实现奇数偶数交替打印 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#future class=md-nav__link> <span class=md-ellipsis> 异步操作库&lt;future&gt; </span> </a> <nav class=md-nav aria-label="异步操作库<future>"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_15 class=md-nav__link> <span class=md-ellipsis> 基本概念 </span> </a> </li> <li class=md-nav__item> <a href=#_16 class=md-nav__link> <span class=md-ellipsis> 主要组件 </span> </a> </li> <li class=md-nav__item> <a href=#stdfuture class=md-nav__link> <span class=md-ellipsis> std::future的详细使用 </span> </a> <nav class=md-nav aria-label=std::future的详细使用> <ul class=md-nav__list> <li class=md-nav__item> <a href=#stdasyncstdfuture class=md-nav__link> <span class=md-ellipsis> 使用std::async创建std::future </span> </a> </li> <li class=md-nav__item> <a href=#stdfuture_1 class=md-nav__link> <span class=md-ellipsis> std::future的常用方法 </span> </a> </li> <li class=md-nav__item> <a href=#stdfuture_status class=md-nav__link> <span class=md-ellipsis> std::future_status类型 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#stdpromise class=md-nav__link> <span class=md-ellipsis> std::promise 的介绍 </span> </a> </li> <li class=md-nav__item> <a href=#stdpackaged_task class=md-nav__link> <span class=md-ellipsis> std::packaged_task的介绍 </span> </a> </li> <li class=md-nav__item> <a href=#futurepromiseasyncpackaged_task class=md-nav__link> <span class=md-ellipsis> future、promise、async和packaged_task之间的关系和区别 </span> </a> </li> <li class=md-nav__item> <a href=#stdshared_future class=md-nav__link> <span class=md-ellipsis> std::shared_future的介绍 </span> </a> <nav class=md-nav aria-label=std::shared_future的介绍> <ul class=md-nav__list> <li class=md-nav__item> <a href=#stdshared_future_1 class=md-nav__link> <span class=md-ellipsis> 创建std::shared_future </span> </a> </li> <li class=md-nav__item> <a href=#stdshared_future_2 class=md-nav__link> <span class=md-ellipsis> std::shared_future的常用方法 </span> </a> </li> <li class=md-nav__item> <a href=#_17 class=md-nav__link> <span class=md-ellipsis> 多线程共享结果示例 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_18 class=md-nav__link> <span class=md-ellipsis> 使用并发支持库实现简易的线程池 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <script defer src=/javascripts/waline.min.js></script> <p><link rel=stylesheet href=https://unpkg.com/@waline/client@v3/dist/waline.css> <link rel=stylesheet href=/stylesheets/waline.min.css></p> <h1 id=c>C++并发支持库<a class=headerlink href=#c title="Permanent link">&para;</a></h1> <div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;"> <p><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 11939 个字 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 1388 行代码 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 4 张图片 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 57 分钟</p> </div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>阅读本篇文章之前建议有一定的线程编程基础，此处可以参考<a href=https://www.help-doc.top/Linux/linux-thread/thread-concept-op/thread-concept-op.html>Linux线程部分</a></p> </div> <h2 id=thread>线程库<code>&lt;thread&gt;</code><a class=headerlink href=#thread title="Permanent link">&para;</a></h2> <p>在C++11中，引入了线程库<code>&lt;thread&gt;</code>，用于实现多线程编程。该库提供了一组类和函数，用于创建、管理和同步线程</p> <h3 id=_1>构造函数<a class=headerlink href=#_1 title="Permanent link">&para;</a></h3> <p>对于创建一个线程来说，可以使用<code>thread</code>类的构造函数，常见的构造如下：</p> <table> <thead> <tr> <th>构造函数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td><code>thread() noexcept;</code></td> <td>默认构造函数，创建一个空的线程对象，不关联任何实际线程</td> </tr> <tr> <td><code>template &lt;class Function, class... Args&gt; explicit thread(Function&amp;&amp; f, Args&amp;&amp;... args);</code></td> <td>创建一个线程并执行指定的可调用对象（函数、lambda表达式、函数对象等）及其参数。参数会被完美转发到可调用对象中</td> </tr> <tr> <td><code>thread(const thread&amp;) = delete;</code></td> <td>禁止拷贝构造函数，线程对象不可被复制</td> </tr> <tr> <td><code>thread(thread&amp;&amp; x) noexcept;</code></td> <td>移动构造函数，将另一个线程对象的所有权转移到当前线程对象中。原线程对象变为未关联任何线程的状态</td> </tr> </tbody> </table> <p><strong>默认构造函数</strong> </p> <p><div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-1><span class=c1>// 简单例子</span>
</span><span id=__span-0-2><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> 创建一个空的线程对象，此时<code>t</code>不关联任何实际线程并且没有任何交给新线程执行的函数。可以通过后续的移动操作（如<code>std::move</code>）将其与一个实际线程关联，例如下面的代码：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-1-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-1-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;thread&gt;</span>
</span><span id=__span-1-3>
</span><span id=__span-1-4><span class=kt>void</span><span class=w> </span><span class=nf>test</span><span class=p>()</span>
</span><span id=__span-1-5><span class=p>{</span>
</span><span id=__span-1-6><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;test&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-1-7><span class=p>}</span>
</span><span id=__span-1-8>
</span><span id=__span-1-9><span class=c1>// 注释</span>
</span><span id=__span-1-10><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-1-11><span class=p>{</span>
</span><span id=__span-1-12><span class=w>    </span><span class=c1>// 创建空的线程</span>
</span><span id=__span-1-13><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t</span><span class=p>;</span>
</span><span id=__span-1-14>
</span><span id=__span-1-15><span class=w>    </span><span class=c1>// 后续需要使用上面的线程需要单独再创建一个线程</span>
</span><span id=__span-1-16><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t1</span><span class=p>(</span><span class=n>test</span><span class=p>);</span>
</span><span id=__span-1-17><span class=w>    </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>t1</span><span class=p>);</span>
</span><span id=__span-1-18><span class=w>    </span><span class=c1>// 不能单独复制一个非右值对象</span>
</span><span id=__span-1-19><span class=w>    </span><span class=c1>// t = t1;</span>
</span><span id=__span-1-20>
</span><span id=__span-1-21><span class=w>    </span><span class=n>t</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-1-22>
</span><span id=__span-1-23><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-1-24><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p><strong>带可调用对象的构造函数（最常用）</strong></p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-2-1><span class=c1>// 简单例子</span>
</span><span id=__span-2-2><span class=kt>void</span><span class=w> </span><span class=nf>foo</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-2-3><span class=p>{</span><span class=w> </span>
</span><span id=__span-2-4><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span><span class=w> </span>
</span><span id=__span-2-5><span class=p>}</span>
</span><span id=__span-2-6><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=nf>t</span><span class=p>(</span><span class=n>foo</span><span class=p>,</span><span class=w> </span><span class=mi>42</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>第一个参数是一个可调用对象（如函数、lambda表达式、函数对象等），后面的参数是传递给该可调用对象的参数</p> <p><strong>默认情况下，创建一个线程对象后，该线程会立即执行</strong></p> <p>但是，需要注意的是，如果函数的参数需要接收的是引用类型，那么在传递参数时一定要确保传递给线程执行函数的参数也是一个引用才能确保引用有效。存在这个问题的本质原因是创建线程时并不是直接将参数传递给线程执行函数，而是经过了一层拷贝，此时线程执行函数接收到的参数是拷贝后的副本，而不是原始参数的引用。为了解决这个问题，可以使用<code>std::ref</code>函数将参数包装成引用类型，这样在线程执行函数中就可以接收到原始参数的引用</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-3-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-3-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;thread&gt;</span>
</span><span id=__span-3-3>
</span><span id=__span-3-4><span class=kt>void</span><span class=w> </span><span class=nf>test1</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=o>&amp;</span><span class=n>x</span><span class=p>)</span>
</span><span id=__span-3-5><span class=p>{</span>
</span><span id=__span-3-6><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;修改前：x为 &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-3-7><span class=w>    </span><span class=o>++</span><span class=n>x</span><span class=p>;</span>
</span><span id=__span-3-8><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;修改后：x为 &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-3-9><span class=p>}</span>
</span><span id=__span-3-10>
</span><span id=__span-3-11><span class=c1>// 注释</span>
</span><span id=__span-3-12><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-3-13><span class=p>{</span>
</span><span id=__span-3-14><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-3-15>
</span><span id=__span-3-16><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t</span><span class=p>(</span><span class=n>test1</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>);</span>
</span><span id=__span-3-17>
</span><span id=__span-3-18><span class=w>    </span><span class=n>t</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-3-19>
</span><span id=__span-3-20><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-3-21><span class=p>}</span>
</span><span id=__span-3-22>
</span><span id=__span-3-23><span class=c1>// 输出</span>
</span><span id=__span-3-24><span class=n>修改前</span><span class=err>：</span><span class=n>x为</span><span class=w> </span><span class=mi>1</span>
</span><span id=__span-3-25><span class=n>修改后</span><span class=err>：</span><span class=n>x为</span><span class=w> </span><span class=mi>2</span>
</span></code></pre></div></td></tr></table></div> <p><strong>禁止拷贝构造函数</strong> </p> <p><div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-4-1><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=nf>t1</span><span class=p>(</span><span class=n>foo</span><span class=p>,</span><span class=w> </span><span class=mi>42</span><span class=p>);</span>
</span><span id=__span-4-2><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>t1</span><span class=p>;</span><span class=w> </span><span class=c1>// 编译错误</span>
</span></code></pre></div></td></tr></table></div> 线程对象不可被复制，因为线程资源是独占的，不能同时由多个线程对象管理，但是可以将控制权转移，即使用<code>std::move</code>，具体例子在上面已经给出</p> <p><strong>移动构造函数</strong> </p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-5-1><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=nf>t1</span><span class=p>(</span><span class=n>foo</span><span class=p>,</span><span class=w> </span><span class=mi>42</span><span class=p>);</span>
</span><span id=__span-5-2><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=nf>t2</span><span class=p>(</span><span class=n>t1</span><span class=p>);</span><span class=w> </span><span class=c1>// t1的所有权转移给t2</span>
</span></code></pre></div></td></tr></table></div> <p>上面的例子中，<code>t1</code>的所有权被转移给<code>t2</code>，<code>t1</code>变为未关联任何线程的状态</p> <h3 id=_2>成员函数<a class=headerlink href=#_2 title="Permanent link">&para;</a></h3> <p>以下是C++11中<code>std::thread</code>类的成员函数列表：</p> <table> <thead> <tr> <th>成员函数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td><code>get_id() const noexcept;</code></td> <td>返回线程的ID（<code>std::thread::id</code>类型）。如果线程对象未关联任何线程，则返回默认构造的<code>std::thread::id</code></td> </tr> <tr> <td><code>joinable() const noexcept;</code></td> <td>检查线程是否可被<code>join</code>或<code>detach</code>。如果线程对象关联了一个有效的线程且尚未被<code>join</code>或<code>detach</code>，则返回<code>true</code>；否则返回<code>false</code></td> </tr> <tr> <td><code>join();</code></td> <td>阻塞当前线程，直到被调用的线程完成执行。调用后，线程对象变为不可<code>join</code>状态（即不再关联任何线程）。每个线程对象只能调用一次<code>join</code></td> </tr> <tr> <td><code>detach();</code></td> <td>将线程与线程对象分离，使其在后台独立运行。调用后，线程对象不再关联该线程，无法再通过该对象管理线程。每个线程对象只能调用一次<code>detach</code></td> </tr> <tr> <td><code>swap(thread&amp; other) noexcept;</code></td> <td>交换两个线程对象的内容。</td> </tr> </tbody> </table> <p>示例代码：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-6-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-6-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;thread&gt;</span>
</span><span id=__span-6-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;chrono&gt;</span>
</span><span id=__span-6-4>
</span><span id=__span-6-5><span class=kt>void</span><span class=w> </span><span class=nf>worker</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-6-6><span class=p>{</span>
</span><span id=__span-6-7><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;线程 &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>get_id</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; 开始工作，参数: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-6-8><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>seconds</span><span class=p>(</span><span class=n>n</span><span class=p>));</span>
</span><span id=__span-6-9><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;线程 &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>get_id</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; 工作完成&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-6-10><span class=p>}</span>
</span><span id=__span-6-11>
</span><span id=__span-6-12><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-6-13><span class=p>{</span>
</span><span id=__span-6-14><span class=w>    </span><span class=c1>// 默认构造函数创建空线程</span>
</span><span id=__span-6-15><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t1</span><span class=p>;</span>
</span><span id=__span-6-16><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;t1 ID: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>t1</span><span class=p>.</span><span class=n>get_id</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-6-17><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;t1 是否可join: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>boolalpha</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>t1</span><span class=p>.</span><span class=n>joinable</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-6-18>
</span><span id=__span-6-19><span class=w>    </span><span class=c1>// 创建实际工作的线程</span>
</span><span id=__span-6-20><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t2</span><span class=p>(</span><span class=n>worker</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>);</span>
</span><span id=__span-6-21><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;t2 ID: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>t2</span><span class=p>.</span><span class=n>get_id</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-6-22><span class=w>    </span><span class=c1>// std::boolalpha 是一个格式化标志，用于将布尔值输出为 &quot;true&quot; 或 &quot;false&quot;</span>
</span><span id=__span-6-23><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;t2 是否可join: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>t2</span><span class=p>.</span><span class=n>joinable</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-6-24>
</span><span id=__span-6-25><span class=w>    </span><span class=c1>// 创建另一个工作线程</span>
</span><span id=__span-6-26><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t3</span><span class=p>(</span><span class=n>worker</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=p>);</span>
</span><span id=__span-6-27>
</span><span id=__span-6-28><span class=w>    </span><span class=c1>// 使用swap交换两个线程</span>
</span><span id=__span-6-29><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;交换前 - t2 ID: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>t2</span><span class=p>.</span><span class=n>get_id</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;, t3 ID: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>t3</span><span class=p>.</span><span class=n>get_id</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-6-30><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=n>swap</span><span class=p>(</span><span class=n>t3</span><span class=p>);</span>
</span><span id=__span-6-31><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;交换后 - t2 ID: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>t2</span><span class=p>.</span><span class=n>get_id</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;, t3 ID: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>t3</span><span class=p>.</span><span class=n>get_id</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-6-32>
</span><span id=__span-6-33><span class=w>    </span><span class=c1>// 使用join等待线程完成</span>
</span><span id=__span-6-34><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>t2</span><span class=p>.</span><span class=n>joinable</span><span class=p>())</span><span class=w> </span>
</span><span id=__span-6-35><span class=w>    </span><span class=p>{</span>
</span><span id=__span-6-36><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;等待t2完成...&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-6-37><span class=w>        </span><span class=n>t2</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-6-38><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;t2已完成&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-6-39><span class=w>    </span><span class=p>}</span>
</span><span id=__span-6-40>
</span><span id=__span-6-41><span class=w>    </span><span class=c1>// 使用detach分离线程</span>
</span><span id=__span-6-42><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>t3</span><span class=p>.</span><span class=n>joinable</span><span class=p>())</span><span class=w> </span>
</span><span id=__span-6-43><span class=w>    </span><span class=p>{</span>
</span><span id=__span-6-44><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;分离t3...&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-6-45><span class=w>        </span><span class=n>t3</span><span class=p>.</span><span class=n>detach</span><span class=p>();</span>
</span><span id=__span-6-46><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;t3已分离，t3是否可join: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>t3</span><span class=p>.</span><span class=n>joinable</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-6-47><span class=w>    </span><span class=p>}</span>
</span><span id=__span-6-48>
</span><span id=__span-6-49><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-6-50><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>参考输出：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-7-1>t1 ID: 0
</span><span id=__span-7-2>t1 是否可join: false
</span><span id=__span-7-3>t2 ID: 39880
</span><span id=__span-7-4>t2 是否可join: true
</span><span id=__span-7-5>交换前 - t2 ID: 39880, t3 ID: 36264
</span><span id=__span-7-6>交换后 - t2 ID: 36264, t3 ID: 39880
</span><span id=__span-7-7>等待t2完成...
</span><span id=__span-7-8>线程 39880 开始工作，参数: 线程 36264 开始工作，参数: 23
</span><span id=__span-7-9>
</span><span id=__span-7-10>线程 39880 工作完成
</span><span id=__span-7-11>线程 36264 工作完成
</span><span id=__span-7-12>t2已完成
</span><span id=__span-7-13>分离t3...
</span><span id=__span-7-14>t3已分离，t3是否可join: false
</span></code></pre></div></td></tr></table></div> <p>需要注意的是，每个线程对象在其生命周期结束前必须明确调用<code>join</code>或<code>detach</code>，否则程序会调用<code>std::terminate</code>终止运行，例如：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-8-1><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=nf>t</span><span class=p>([]</span><span class=w> </span><span class=p>{});</span>
</span><span id=__span-8-2><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=p>.</span><span class=n>joinable</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-8-3><span class=w>    </span><span class=n>t</span><span class=p>.</span><span class=n>join</span><span class=p>();</span><span class=w> </span><span class=c1>// 或者 t.detach();</span>
</span><span id=__span-8-4><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h3 id=this_thread><code>this_thread</code>命名空间<a class=headerlink href=#this_thread title="Permanent link">&para;</a></h3> <p>在C++11中，<code>std::this_thread</code>是一个命名空间，提供了与当前线程相关的功能。它主要用于获取当前线程的信息、控制当前线程的执行（如暂停或休眠），以及设置线程的名称（在某些实现中）。以下是<code>std::this_thread</code>命名空间中的主要函数及其功能：</p> <table> <thead> <tr> <th>函数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td><code>std::this_thread::get_id()</code></td> <td>返回当前线程的ID（<code>std::thread::id</code>类型）</td> </tr> <tr> <td><code>std::this_thread::yield()</code></td> <td>提示调度器让出当前线程的时间片，允许其他线程运行</td> </tr> <tr> <td><code>std::this_thread::sleep_for(const chrono::duration&amp; rel_time)</code></td> <td>让当前线程暂停指定的持续时间</td> </tr> <tr> <td><code>std::this_thread::sleep_until(const chrono::time_point&amp; abs_time)</code></td> <td>让当前线程暂停，直到指定的时间点</td> </tr> </tbody> </table> <div class="admonition note"> <p class=admonition-title>Note</p> <p>在上面的函数中，对于<code>yield</code>函数来说，在不同的操作系统上可能会有不同的表现，具体表现取决于操作系统的调度策略和实现，并不是所有的操作系统都保证<code>yield</code>函数一定会让出时间片</p> </div> <p>示例代码：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-9-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-9-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;thread&gt;</span>
</span><span id=__span-9-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;chrono&gt;</span>
</span><span id=__span-9-4><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iomanip&gt;</span><span class=c1> // 用于格式化输出时间</span>
</span><span id=__span-9-5>
</span><span id=__span-9-6><span class=kt>void</span><span class=w> </span><span class=nf>print_time</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-9-7><span class=p>{</span>
</span><span id=__span-9-8><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>now</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>system_clock</span><span class=o>::</span><span class=n>now</span><span class=p>();</span>
</span><span id=__span-9-9><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>now_c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>system_clock</span><span class=o>::</span><span class=n>to_time_t</span><span class=p>(</span><span class=n>now</span><span class=p>);</span>
</span><span id=__span-9-10><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; - 时间: &quot;</span><span class=w> </span>
</span><span id=__span-9-11><span class=w>              </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>put_time</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>localtime</span><span class=p>(</span><span class=o>&amp;</span><span class=n>now_c</span><span class=p>),</span><span class=w> </span><span class=s>&quot;%H:%M:%S&quot;</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-9-12><span class=p>}</span>
</span><span id=__span-9-13>
</span><span id=__span-9-14><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-9-15><span class=p>{</span>
</span><span id=__span-9-16><span class=w>    </span><span class=c1>// 1. 获取当前线程ID</span>
</span><span id=__span-9-17><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;当前线程ID: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>get_id</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-9-18>
</span><span id=__span-9-19><span class=w>    </span><span class=c1>// 2. 使用yield让出时间片</span>
</span><span id=__span-9-20><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;准备让出时间片...&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-9-21><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>yield</span><span class=p>();</span>
</span><span id=__span-9-22><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;继续执行...&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-9-23>
</span><span id=__span-9-24><span class=w>    </span><span class=c1>// 3. 使用sleep_for暂停指定时间</span>
</span><span id=__span-9-25><span class=w>    </span><span class=n>print_time</span><span class=p>(</span><span class=s>&quot;准备休眠2秒&quot;</span><span class=p>);</span>
</span><span id=__span-9-26><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>seconds</span><span class=p>(</span><span class=mi>2</span><span class=p>));</span>
</span><span id=__span-9-27><span class=w>    </span><span class=n>print_time</span><span class=p>(</span><span class=s>&quot;休眠结束&quot;</span><span class=p>);</span>
</span><span id=__span-9-28>
</span><span id=__span-9-29><span class=w>    </span><span class=c1>// 4. 使用sleep_until暂停到指定时间点</span>
</span><span id=__span-9-30><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>now</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>system_clock</span><span class=o>::</span><span class=n>now</span><span class=p>();</span>
</span><span id=__span-9-31><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>wake_time</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>now</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>seconds</span><span class=p>(</span><span class=mi>3</span><span class=p>);</span>
</span><span id=__span-9-32>
</span><span id=__span-9-33><span class=w>    </span><span class=n>print_time</span><span class=p>(</span><span class=s>&quot;准备休眠到指定时间点(当前时间+3秒)&quot;</span><span class=p>);</span>
</span><span id=__span-9-34><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_until</span><span class=p>(</span><span class=n>wake_time</span><span class=p>);</span>
</span><span id=__span-9-35><span class=w>    </span><span class=n>print_time</span><span class=p>(</span><span class=s>&quot;到达指定时间点，继续执行&quot;</span><span class=p>);</span>
</span><span id=__span-9-36>
</span><span id=__span-9-37><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-9-38><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>参考输出：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-10-1>当前线程ID: 26096
</span><span id=__span-10-2>准备让出时间片...
</span><span id=__span-10-3>继续执行...
</span><span id=__span-10-4>准备休眠2秒 - 时间: 19:23:48
</span><span id=__span-10-5>休眠结束 - 时间: 19:23:50
</span><span id=__span-10-6>准备休眠到指定时间点(当前时间+3秒) - 时间: 19:23:50
</span><span id=__span-10-7>到达指定时间点，继续执行 - 时间: 19:23:53
</span></code></pre></div></td></tr></table></div> <h2 id=mutex>互斥锁库<code>&lt;mutex&gt;</code><a class=headerlink href=#mutex title="Permanent link">&para;</a></h2> <p>在C++11中，标准库提供了多种互斥锁（mutex）类型和相关工具，用于实现线程间的同步。这些互斥锁和工具位于<code>&lt;mutex&gt;</code>头文件中</p> <h3 id=_3>互斥锁类型<a class=headerlink href=#_3 title="Permanent link">&para;</a></h3> <table> <thead> <tr> <th>互斥锁类型</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td><code>std::mutex</code></td> <td>最基本的互斥锁类型，提供独占锁定功能。支持<code>lock()</code>、<code>unlock()</code>和<code>try_lock()</code>操作</td> </tr> <tr> <td><code>std::recursive_mutex</code></td> <td>递归互斥锁，允许同一线程多次锁定同一个互斥锁，但必须解锁相同次数才能释放锁。</td> </tr> <tr> <td><code>std::timed_mutex</code></td> <td>带超时功能的互斥锁，支持尝试锁定一段时间后放弃（使用<code>try_lock_for</code>和<code>try_lock_until</code>）</td> </tr> <tr> <td><code>std::recursive_timed_mutex</code></td> <td>结合了递归互斥锁和带超时功能的互斥锁特性</td> </tr> </tbody> </table> <p>对于基本的<code>mutex</code>来说，使用方式与Linux下的<code>pthread_mutex_t</code>类似，使用<code>lock()</code>加锁，使用<code>unlock()</code>解锁，使用<code>try_lock()</code>尝试加锁，加锁成功返回<code>true</code>，加锁失败返回<code>false</code>。此处不再赘述</p> <p>下面介绍递归锁和带超时的锁</p> <p>在一般场景下，直接使用普通的锁完全够用，但是在下面的情况下，如果使用普通的锁，可能会出现死锁的情况，例如：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-11-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;mutex&gt;</span>
</span><span id=__span-11-2>
</span><span id=__span-11-3><span class=c1>// 定义一个递归函数</span>
</span><span id=__span-11-4><span class=kt>void</span><span class=w> </span><span class=nf>recursion</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&amp;</span><span class=w> </span><span class=n>mtx</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=o>&amp;</span><span class=n>x</span><span class=p>)</span>
</span><span id=__span-11-5><span class=p>{</span>
</span><span id=__span-11-6><span class=w>    </span><span class=c1>// 加锁保护临界区资源</span>
</span><span id=__span-11-7><span class=w>    </span><span class=n>mtx</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span>
</span><span id=__span-11-8><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-11-9><span class=w>    </span><span class=p>{</span>
</span><span id=__span-11-10><span class=w>        </span><span class=n>mtx</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
</span><span id=__span-11-11><span class=w>        </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-11-12><span class=w>    </span><span class=p>}</span>
</span><span id=__span-11-13><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-11-14><span class=w>        </span><span class=o>++</span><span class=n>x</span><span class=p>;</span>
</span><span id=__span-11-15><span class=w>    </span><span class=n>recursion</span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>10</span><span class=p>,</span><span class=w> </span><span class=n>mtx</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>);</span>
</span><span id=__span-11-16><span class=w>    </span><span class=n>mtx</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
</span><span id=__span-11-17><span class=p>}</span>
</span><span id=__span-11-18>
</span><span id=__span-11-19><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-11-20><span class=p>{</span>
</span><span id=__span-11-21><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>100</span><span class=p>;</span>
</span><span id=__span-11-22><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-11-23><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>mtx</span><span class=p>;</span>
</span><span id=__span-11-24><span class=w>    </span><span class=c1>// 注意使用引用传递</span>
</span><span id=__span-11-25><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t</span><span class=p>(</span><span class=n>recursion</span><span class=p>,</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>ref</span><span class=p>(</span><span class=n>mtx</span><span class=p>),</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>ref</span><span class=p>(</span><span class=n>x</span><span class=p>));</span>
</span><span id=__span-11-26>
</span><span id=__span-11-27><span class=w>    </span><span class=n>t</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-11-28><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-11-29><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>在上面的代码中，第一次调用<code>recursion</code>函数时，会加锁保护临界区资源，但是在第一次递归调用时，因为调用递归的位置在释放锁之前，此时当前线程再次进入<code>recursion</code>函数就会开始尝试加锁，但是因为第一次调用并没有释放锁，这就导致当前线程会一直等待锁的释放，这就导致了死锁的情况。这也侧面说明了当前<code>recursion</code>函数是<a href=https://www.help-doc.top/Linux/signals-os-principles/signals-os-principles.html#_11>不可重入</a>的</p> <p>基于这个问题，就需要使用递归锁：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-12-1><span class=c1>// 定义一个递归函数</span>
</span><span id=__span-12-2><span class=kt>void</span><span class=w> </span><span class=nf>recursion</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>recursive_mutex</span><span class=o>&amp;</span><span class=w> </span><span class=n>mtx</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=o>&amp;</span><span class=n>x</span><span class=p>)</span>
</span><span id=__span-12-3><span class=p>{</span>
</span><span id=__span-12-4><span class=w>    </span><span class=c1>// 加锁保护临界区资源</span>
</span><span id=__span-12-5><span class=w>    </span><span class=n>mtx</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span>
</span><span id=__span-12-6><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-12-7><span class=w>    </span><span class=p>{</span>
</span><span id=__span-12-8><span class=w>        </span><span class=n>mtx</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span><span class=w> </span><span class=c1>// 确保在返回前解锁</span>
</span><span id=__span-12-9><span class=w>        </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-12-10><span class=w>    </span><span class=p>}</span>
</span><span id=__span-12-11><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-12-12><span class=w>        </span><span class=o>++</span><span class=n>x</span><span class=p>;</span>
</span><span id=__span-12-13><span class=w>    </span><span class=n>recursion</span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>10</span><span class=p>,</span><span class=w> </span><span class=n>mtx</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>);</span>
</span><span id=__span-12-14><span class=w>    </span><span class=n>mtx</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
</span><span id=__span-12-15><span class=p>}</span>
</span><span id=__span-12-16>
</span><span id=__span-12-17><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-12-18><span class=p>{</span>
</span><span id=__span-12-19><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>100</span><span class=p>;</span>
</span><span id=__span-12-20><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-12-21><span class=w>    </span><span class=c1>// 使用递归锁</span>
</span><span id=__span-12-22><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>recursive_mutex</span><span class=w> </span><span class=n>mtx</span><span class=p>;</span>
</span><span id=__span-12-23><span class=w>    </span><span class=c1>// 注意使用引用传递</span>
</span><span id=__span-12-24><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t</span><span class=p>(</span><span class=n>recursion</span><span class=p>,</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>ref</span><span class=p>(</span><span class=n>mtx</span><span class=p>),</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>ref</span><span class=p>(</span><span class=n>x</span><span class=p>));</span>
</span><span id=__span-12-25>
</span><span id=__span-12-26><span class=w>    </span><span class=n>t</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-12-27><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-12-28><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>接下来是超时锁<code>timed_mutex</code>，超时锁本质就是不让线程持续阻塞，而是在指定的时间内尝试加锁，如果加锁成功就继续执行，如果加锁失败就返回。例如下面的代码：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-13-1><span class=kt>void</span><span class=w> </span><span class=nf>test</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>timed_mutex</span><span class=w> </span><span class=o>&amp;</span><span class=n>tmtx</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=o>&amp;</span><span class=n>x</span><span class=p>)</span>
</span><span id=__span-13-2><span class=p>{</span>
</span><span id=__span-13-3><span class=w>    </span><span class=c1>// 不要直接使用lock</span>
</span><span id=__span-13-4><span class=w>    </span><span class=c1>// tmtx.lock();</span>
</span><span id=__span-13-5><span class=w>    </span><span class=c1>// 使用try_lock_for</span>
</span><span id=__span-13-6><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>tmtx</span><span class=p>.</span><span class=n>try_lock_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>milliseconds</span><span class=p>(</span><span class=mi>1000</span><span class=p>));)</span>
</span><span id=__span-13-7><span class=w>    </span><span class=p>{</span>
</span><span id=__span-13-8><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-13-9><span class=w>            </span><span class=o>++</span><span class=n>x</span><span class=p>;</span>
</span><span id=__span-13-10><span class=w>    </span><span class=p>}</span>
</span><span id=__span-13-11>
</span><span id=__span-13-12><span class=w>    </span><span class=n>tmtx</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
</span><span id=__span-13-13><span class=p>}</span>
</span><span id=__span-13-14>
</span><span id=__span-13-15><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-13-16><span class=p>{</span>
</span><span id=__span-13-17><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>timed_mutex</span><span class=w> </span><span class=n>tmtx</span><span class=p>;</span>
</span><span id=__span-13-18><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-13-19><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>100</span><span class=p>;</span>
</span><span id=__span-13-20>
</span><span id=__span-13-21><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t</span><span class=p>(</span><span class=n>test</span><span class=p>,</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>ref</span><span class=p>(</span><span class=n>tmtx</span><span class=p>),</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>ref</span><span class=p>(</span><span class=n>x</span><span class=p>));</span>
</span><span id=__span-13-22>
</span><span id=__span-13-23><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t1</span><span class=p>(</span><span class=n>test</span><span class=p>,</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>ref</span><span class=p>(</span><span class=n>tmtx</span><span class=p>),</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>ref</span><span class=p>(</span><span class=n>x</span><span class=p>));</span>
</span><span id=__span-13-24>
</span><span id=__span-13-25><span class=w>    </span><span class=n>t</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-13-26><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-13-27>
</span><span id=__span-13-28><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-13-29><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>需要注意的是，如果使用超时锁想实现防止线程阻塞在等待锁的过程，需要使用<code>try_lock_for</code>或者<code>try_lock_until</code>，如果直接使用<code>timed_mutex</code>的<code>lock</code>系列接口，那么<a href=javascript:; class=custom-tooltip data-title="参考文档对timed_mutex的lock函数的描述：The calling thread locks the timed_mutex, blocking if necessary (it behaves exactly as in mutex)"><code>timed_mutex</code>和普通的<code>mutex</code>没有任何区别</a></p> <h3 id=_4>互斥锁相关工具<a class=headerlink href=#_4 title="Permanent link">&para;</a></h3> <table> <thead> <tr> <th>工具类型</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td><code>std::lock_guard&lt;std::mutex&gt;</code></td> <td>简单的RAII风格锁管理器，自动在构造时加锁，在析构时解锁。不可手动解锁。</td> </tr> <tr> <td><code>std::unique_lock&lt;std::mutex&gt;</code></td> <td>更灵活的RAII风格锁管理器，支持延迟加锁、手动解锁以及与条件变量配合使用。</td> </tr> </tbody> </table> <p>对于<code>lock_guard</code>来说，在<a href=https://www.help-doc.top/Linux/linux-thread/thread-sync/thread-sync.html#craii>Linux线程互斥与同步</a>已经模拟实现了一份<code>MutexGuard</code>，基本原理就类似于<code>MutexGuard</code></p> <p>接下来主要看<code>unique_lock</code>。<code>unique_lock</code>可以理解为是<code>lock_guard</code>的一种升级版本，基本使用方式和<code>lock_guard</code>类似，所以这里就不再介绍基本使用方式</p> <p><code>unique_lock</code>的灵活性在于它可以由程序员控制加锁和解锁的时机，例如下面的三种构造函数：</p> <ol> <li><code>unique_lock (mutex_type&amp; m, try_to_lock_t tag);</code>：尝试加锁，如果加锁失败就不会阻塞当前线程，底层调用的是<code>try_lock</code>。但是<code>try_lock_t</code>因为是非阻塞的，不论是否获取到锁，都会返回一个<code>unique_lock</code>对象，即这个<code>unique_lock</code>是否真的已经管理到指定锁对象是未知的，所以需要判断是否加锁成功。具体如何判断在下面会具体介绍</li> <li><code>unique_lock (mutex_type&amp; m, defer_lock_t tag) noexcept;</code>：缓上锁，即<code>unique_lock</code>接收一个锁对象时不会对这个锁进行加锁，具体加锁时机由程序员决定，但是会自动释放锁对象</li> <li><code>unique_lock (mutex_type&amp; m, adopt_lock_t tag);</code>：领养锁，即此时<code>unique_lock</code>可以接受一个（假设）已经加锁的锁对象，并且会自动释放锁对象</li> </ol> <p>要使用上面的三种构造函数，需要使用三种类型：</p> <ol> <li><code>try_to_lock</code></li> <li><code>defer_lock</code></li> <li><code>adopt_lock</code></li> </ol> <p>首先看后两个<code>defer_lock</code>和<code>adopt_lock</code>，示例代码如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span>
<span class=normal>59</span>
<span class=normal>60</span>
<span class=normal>61</span>
<span class=normal>62</span>
<span class=normal>63</span>
<span class=normal>64</span>
<span class=normal>65</span>
<span class=normal>66</span>
<span class=normal>67</span>
<span class=normal>68</span>
<span class=normal>69</span>
<span class=normal>70</span>
<span class=normal>71</span>
<span class=normal>72</span>
<span class=normal>73</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-14-1><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>mtx</span><span class=p>;</span>
</span><span id=__span-14-2><span class=c1>// 1. defer_lock_t 示例：延迟加锁</span>
</span><span id=__span-14-3><span class=kt>void</span><span class=w> </span><span class=nf>defer_lock_example</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>)</span>
</span><span id=__span-14-4><span class=p>{</span>
</span><span id=__span-14-5><span class=w>    </span><span class=c1>// 创建锁但不立即加锁</span>
</span><span id=__span-14-6><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock</span><span class=p>(</span><span class=n>mtx</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>defer_lock</span><span class=p>);</span>
</span><span id=__span-14-7>
</span><span id=__span-14-8><span class=w>    </span><span class=c1>// 执行一些不需要锁的操作</span>
</span><span id=__span-14-9><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;线程 &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; 正在执行不需要锁的操作...&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-14-10><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>milliseconds</span><span class=p>(</span><span class=mi>200</span><span class=p>));</span>
</span><span id=__span-14-11>
</span><span id=__span-14-12><span class=w>    </span><span class=c1>// 在需要的时候手动加锁</span>
</span><span id=__span-14-13><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;线程 &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; 尝试获取锁...&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-14-14><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span>
</span><span id=__span-14-15><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;线程 &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; 获取到了锁&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-14-16>
</span><span id=__span-14-17><span class=w>    </span><span class=c1>// 执行需要锁保护的操作</span>
</span><span id=__span-14-18><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>milliseconds</span><span class=p>(</span><span class=mi>500</span><span class=p>));</span>
</span><span id=__span-14-19>
</span><span id=__span-14-20><span class=w>    </span><span class=c1>// 可以手动解锁</span>
</span><span id=__span-14-21><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
</span><span id=__span-14-22><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;线程 &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; 手动释放了锁&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-14-23>
</span><span id=__span-14-24><span class=w>    </span><span class=c1>// 执行更多不需要锁的操作</span>
</span><span id=__span-14-25><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>milliseconds</span><span class=p>(</span><span class=mi>200</span><span class=p>));</span>
</span><span id=__span-14-26>
</span><span id=__span-14-27><span class=w>    </span><span class=c1>// 可以再次加锁</span>
</span><span id=__span-14-28><span class=w>    </span><span class=n>lock</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span>
</span><span id=__span-14-29><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;线程 &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; 再次获取到了锁&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-14-30><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>milliseconds</span><span class=p>(</span><span class=mi>300</span><span class=p>));</span>
</span><span id=__span-14-31>
</span><span id=__span-14-32><span class=w>    </span><span class=c1>// 锁会在unique_lock析构时自动释放</span>
</span><span id=__span-14-33><span class=p>}</span>
</span><span id=__span-14-34>
</span><span id=__span-14-35><span class=c1>// 2. adopt_lock_t 示例：接管已加锁的互斥量</span>
</span><span id=__span-14-36><span class=kt>void</span><span class=w> </span><span class=nf>adopt_lock_example</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>)</span>
</span><span id=__span-14-37><span class=p>{</span>
</span><span id=__span-14-38><span class=w>    </span><span class=c1>// 先手动加锁</span>
</span><span id=__span-14-39><span class=w>    </span><span class=n>mtx</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span>
</span><span id=__span-14-40><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;线程 &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; 手动获取了锁&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-14-41>
</span><span id=__span-14-42><span class=w>    </span><span class=c1>// 创建unique_lock并接管已加锁的互斥量</span>
</span><span id=__span-14-43><span class=w>    </span><span class=p>{</span>
</span><span id=__span-14-44><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock</span><span class=p>(</span><span class=n>mtx</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>adopt_lock</span><span class=p>);</span>
</span><span id=__span-14-45><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;线程 &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; 的unique_lock接管了锁的所有权&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-14-46>
</span><span id=__span-14-47><span class=w>        </span><span class=c1>// 执行需要锁保护的操作</span>
</span><span id=__span-14-48><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>milliseconds</span><span class=p>(</span><span class=mi>800</span><span class=p>));</span>
</span><span id=__span-14-49>
</span><span id=__span-14-50><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;线程 &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; 即将退出作用域，锁将被自动释放&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-14-51><span class=w>        </span><span class=c1>// 锁会在unique_lock析构时自动释放</span>
</span><span id=__span-14-52><span class=w>    </span><span class=p>}</span>
</span><span id=__span-14-53>
</span><span id=__span-14-54><span class=w>    </span><span class=c1>// 此时锁已被释放，可以执行其他操作</span>
</span><span id=__span-14-55><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;线程 &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; 的锁已被释放&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-14-56><span class=p>}</span>
</span><span id=__span-14-57>
</span><span id=__span-14-58><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-14-59><span class=p>{</span>
</span><span id=__span-14-60><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;</span><span class=se>\n</span><span class=s>=== defer_lock 示例 ===&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-14-61><span class=w>    </span><span class=p>{</span>
</span><span id=__span-14-62><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t</span><span class=p>(</span><span class=n>defer_lock_example</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-14-63><span class=w>        </span><span class=n>t</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-14-64><span class=w>    </span><span class=p>}</span>
</span><span id=__span-14-65>
</span><span id=__span-14-66><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;</span><span class=se>\n</span><span class=s>=== adopt_lock 示例 ===&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-14-67><span class=w>    </span><span class=p>{</span>
</span><span id=__span-14-68><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t</span><span class=p>(</span><span class=n>adopt_lock_example</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-14-69><span class=w>        </span><span class=n>t</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-14-70><span class=w>    </span><span class=p>}</span>
</span><span id=__span-14-71>
</span><span id=__span-14-72><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-14-73><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>参考输出：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-15-1>=== defer_lock 示例 ===
</span><span id=__span-15-2>线程 1 正在执行不需要锁的操作...
</span><span id=__span-15-3>线程 1 尝试获取锁...
</span><span id=__span-15-4>线程 1 获取到了锁
</span><span id=__span-15-5>线程 1 手动释放了锁
</span><span id=__span-15-6>线程 1 再次获取到了锁
</span><span id=__span-15-7>
</span><span id=__span-15-8>=== adopt_lock 示例 ===
</span><span id=__span-15-9>线程 1 手动获取了锁
</span><span id=__span-15-10>线程 1 的unique_lock接管了锁的所有权
</span><span id=__span-15-11>线程 1 即将退出作用域，锁将被自动释放
</span><span id=__span-15-12>线程 1 的锁已被释放
</span></code></pre></div></td></tr></table></div> <p>接下来看<code>try_to_lock</code>，在上面提到过，<code>try_to_lock</code>会尝试加锁，需要判断是否加锁成功，这里可以通过调用<code>owns_lock</code>来判断，当然也可以直接通过<code>operator bool</code>来判断，示例代码如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-16-1><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>mtx</span><span class=p>;</span>
</span><span id=__span-16-2>
</span><span id=__span-16-3><span class=kt>void</span><span class=w> </span><span class=nf>try_lock_example</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>)</span>
</span><span id=__span-16-4><span class=p>{</span>
</span><span id=__span-16-5><span class=w>    </span><span class=c1>// 尝试获取锁，如果失败则不阻塞</span>
</span><span id=__span-16-6><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock</span><span class=p>(</span><span class=n>mtx</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>try_to_lock</span><span class=p>);</span>
</span><span id=__span-16-7>
</span><span id=__span-16-8><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lock</span><span class=p>.</span><span class=n>owns_lock</span><span class=p>())</span><span class=w> </span><span class=c1>// 可以直接使用if(lock)，调用operator bool</span>
</span><span id=__span-16-9><span class=w>    </span><span class=p>{</span>
</span><span id=__span-16-10><span class=w>        </span><span class=c1>// 成功获取到锁</span>
</span><span id=__span-16-11><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;线程 &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; 获取到了锁&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-16-12><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>milliseconds</span><span class=p>(</span><span class=mi>1000</span><span class=p>));</span>
</span><span id=__span-16-13><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;线程 &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; 完成工作并释放锁&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-16-14><span class=w>    </span><span class=p>}</span>
</span><span id=__span-16-15><span class=w>    </span><span class=k>else</span><span class=w> </span>
</span><span id=__span-16-16><span class=w>    </span><span class=p>{</span>
</span><span id=__span-16-17><span class=w>        </span><span class=c1>// 未能获取到锁</span>
</span><span id=__span-16-18><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;线程 &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; 未能获取锁，执行替代操作&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-16-19><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>milliseconds</span><span class=p>(</span><span class=mi>500</span><span class=p>));</span>
</span><span id=__span-16-20><span class=w>    </span><span class=p>}</span>
</span><span id=__span-16-21><span class=w>    </span><span class=c1>// 锁会在unique_lock析构时自动释放（如果已获取）</span>
</span><span id=__span-16-22><span class=p>}</span>
</span><span id=__span-16-23>
</span><span id=__span-16-24><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-16-25><span class=p>{</span>
</span><span id=__span-16-26><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;=== try_to_lock 示例 ===&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-16-27><span class=w>    </span><span class=p>{</span>
</span><span id=__span-16-28><span class=w>        </span><span class=c1>// 创建两个线程同时尝试获取锁</span>
</span><span id=__span-16-29><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t1</span><span class=p>(</span><span class=n>try_lock_example</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-16-30><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>milliseconds</span><span class=p>(</span><span class=mi>100</span><span class=p>));</span><span class=w> </span><span class=c1>// 确保t1先运行</span>
</span><span id=__span-16-31><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t2</span><span class=p>(</span><span class=n>try_lock_example</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>);</span>
</span><span id=__span-16-32>
</span><span id=__span-16-33><span class=w>        </span><span class=n>t1</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-16-34><span class=w>        </span><span class=n>t2</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-16-35><span class=w>    </span><span class=p>}</span>
</span><span id=__span-16-36>
</span><span id=__span-16-37><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-16-38><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>参考输出：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-17-1>=== try_to_lock 示例 ===
</span><span id=__span-17-2>线程 1 获取到了锁
</span><span id=__span-17-3>线程 2 未能获取锁，执行替代操作
</span><span id=__span-17-4>线程 1 完成工作并释放锁
</span></code></pre></div></td></tr></table></div> <p>除了上面的三种构造函数，<code>unique_lock</code>还提供了一些其他的成员函数：</p> <ol> <li><code>release()</code>：释放当前锁对象，并且返回该锁对象指针，不再管理该锁（需要程序员自己释放锁）</li> <li><code>mutex()</code>：获取<code>unique_lock</code>管理的锁对象的指针</li> </ol> <p>这两个成员函数使用相对容易，此处不过多介绍</p> <h3 id=locktry_lock>防止死锁的模板函数<code>lock</code>和<code>try_lock</code><a class=headerlink href=#locktry_lock title="Permanent link">&para;</a></h3> <p>下面是对这两个函数的介绍：</p> <ol> <li><code>lock()</code>：该函数可以接收多个锁对象（不仅限于<code>mutex</code>，还可以传递可以<code>unique_lock</code>），函数内部会对每一个锁对象依次加锁，如果有任何一个锁加锁失败，那么之前已经加锁成功的锁对象都会自动解锁并阻塞当前线程，直到所有锁都加锁成功</li> <li><code>try_lock()</code>：该函数的作用与<code>lock()</code>主要功能一致。唯独不同的是，该函数加锁失败不会阻塞当前线程，并且会返回第一个加锁失败的锁对象的编号（第一把锁编号从0开始），如果所有锁都加锁成功，那么该函数会返回<code>-1</code></li> </ol> <p>例如在下面的例子中：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-18-1><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>mtx1</span><span class=p>;</span>
</span><span id=__span-18-2><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>mtx2</span><span class=p>;</span>
</span><span id=__span-18-3>
</span><span id=__span-18-4><span class=kt>void</span><span class=w> </span><span class=nf>test1</span><span class=p>()</span>
</span><span id=__span-18-5><span class=p>{</span>
</span><span id=__span-18-6><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock1</span><span class=p>(</span><span class=n>mtx1</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>defer_lock</span><span class=p>);</span>
</span><span id=__span-18-7><span class=w>    </span><span class=n>lock1</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span>
</span><span id=__span-18-8><span class=w>    </span><span class=c1>// 当前线程休眠1s确保test2先获取到mtx2</span>
</span><span id=__span-18-9><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>seconds</span><span class=p>(</span><span class=mi>1</span><span class=p>));</span>
</span><span id=__span-18-10><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock2</span><span class=p>(</span><span class=n>mtx2</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>defer_lock</span><span class=p>);</span>
</span><span id=__span-18-11><span class=w>    </span><span class=n>lock2</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span>
</span><span id=__span-18-12>
</span><span id=__span-18-13><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-18-14><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>get_id</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;正在执行&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-18-15>
</span><span id=__span-18-16><span class=w>    </span><span class=n>lock2</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
</span><span id=__span-18-17><span class=w>    </span><span class=n>lock1</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
</span><span id=__span-18-18><span class=p>}</span>
</span><span id=__span-18-19>
</span><span id=__span-18-20><span class=kt>void</span><span class=w> </span><span class=nf>test2</span><span class=p>()</span>
</span><span id=__span-18-21><span class=p>{</span>
</span><span id=__span-18-22><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock2</span><span class=p>(</span><span class=n>mtx2</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>defer_lock</span><span class=p>);</span>
</span><span id=__span-18-23><span class=w>    </span><span class=n>lock2</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span>
</span><span id=__span-18-24><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock1</span><span class=p>(</span><span class=n>mtx1</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>defer_lock</span><span class=p>);</span>
</span><span id=__span-18-25><span class=w>    </span><span class=n>lock1</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span>
</span><span id=__span-18-26>
</span><span id=__span-18-27><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-18-28><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>get_id</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;正在执行&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-18-29>
</span><span id=__span-18-30><span class=w>    </span><span class=n>lock1</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
</span><span id=__span-18-31><span class=w>    </span><span class=n>lock2</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
</span><span id=__span-18-32><span class=p>}</span>
</span><span id=__span-18-33>
</span><span id=__span-18-34><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-18-35><span class=p>{</span>
</span><span id=__span-18-36><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t1</span><span class=p>(</span><span class=n>test1</span><span class=p>);</span>
</span><span id=__span-18-37><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t2</span><span class=p>(</span><span class=n>test2</span><span class=p>);</span>
</span><span id=__span-18-38>
</span><span id=__span-18-39><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-18-40><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-18-41>
</span><span id=__span-18-42><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-18-43><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>编译运行上面的代码会发现出现了死锁现象，即假设<code>t1</code>线程先执行，<code>t2</code>线程后执行，那么<code>t1</code>线程首先会获取到<code>lock1</code>，接着休眠1秒，此时<code>t2</code>线程获取到了<code>lock2</code>，接着，当<code>t1</code>尝试获取<code>lock2</code>时发现<code>lock2</code>已经被取走，所以<code>t1</code>线程阻塞在获取<code>lock2</code>的位置，同理，<code>t2</code>线程也会阻塞在获取<code>lock1</code>的位置</p> <p>出现死锁的本质原因就是<code>t1</code>和<code>t2</code>在等待其他锁的时候并没有释放当前锁，而是加锁阻塞，所以需要的逻辑就是当前线程一旦加锁失败就释放当前已经持有的锁对象或者不使用会引起线程阻塞的加锁方式，更推荐第一种思路，下面给出两种思路的实现：</p> <div class="tabbed-set tabbed-alternate" data-tabs=1:3><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><input id=__tabbed_1_2 name=__tabbed_1 type=radio><input id=__tabbed_1_3 name=__tabbed_1 type=radio><div class=tabbed-labels><label for=__tabbed_1_1>使用<code>lock</code>模版函数</label><label for=__tabbed_1_2>使用<code>try_lock</code>模版函数</label><label for=__tabbed_1_3>使用不引起线程阻塞的加锁方式</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-19-1><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>mtx1</span><span class=p>;</span>
</span><span id=__span-19-2><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>mtx2</span><span class=p>;</span>
</span><span id=__span-19-3>
</span><span id=__span-19-4><span class=kt>void</span><span class=w> </span><span class=nf>test1</span><span class=p>()</span>
</span><span id=__span-19-5><span class=p>{</span>
</span><span id=__span-19-6><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock1</span><span class=p>(</span><span class=n>mtx1</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>defer_lock</span><span class=p>);</span>
</span><span id=__span-19-7><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>seconds</span><span class=p>(</span><span class=mi>1</span><span class=p>));</span>
</span><span id=__span-19-8><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock2</span><span class=p>(</span><span class=n>mtx2</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>defer_lock</span><span class=p>);</span>
</span><span id=__span-19-9><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>lock</span><span class=p>(</span><span class=n>lock1</span><span class=p>,</span><span class=w> </span><span class=n>lock2</span><span class=p>);</span>
</span><span id=__span-19-10>
</span><span id=__span-19-11><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-19-12><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>get_id</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;正在执行test1&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-19-13>
</span><span id=__span-19-14><span class=w>    </span><span class=n>lock2</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
</span><span id=__span-19-15><span class=w>    </span><span class=n>lock1</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
</span><span id=__span-19-16><span class=p>}</span>
</span><span id=__span-19-17>
</span><span id=__span-19-18><span class=kt>void</span><span class=w> </span><span class=nf>test2</span><span class=p>()</span>
</span><span id=__span-19-19><span class=p>{</span>
</span><span id=__span-19-20><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock2</span><span class=p>(</span><span class=n>mtx2</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>defer_lock</span><span class=p>);</span>
</span><span id=__span-19-21><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock1</span><span class=p>(</span><span class=n>mtx1</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>defer_lock</span><span class=p>);</span>
</span><span id=__span-19-22><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>lock</span><span class=p>(</span><span class=n>lock1</span><span class=p>,</span><span class=w> </span><span class=n>lock2</span><span class=p>);</span>
</span><span id=__span-19-23>
</span><span id=__span-19-24><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-19-25><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>get_id</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;正在执行test2&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-19-26>
</span><span id=__span-19-27><span class=w>    </span><span class=n>lock1</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
</span><span id=__span-19-28><span class=w>    </span><span class=n>lock2</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
</span><span id=__span-19-29><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-20-1><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>mtx1</span><span class=p>;</span>
</span><span id=__span-20-2><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>mtx2</span><span class=p>;</span>
</span><span id=__span-20-3>
</span><span id=__span-20-4><span class=kt>void</span><span class=w> </span><span class=nf>test1</span><span class=p>()</span>
</span><span id=__span-20-5><span class=p>{</span>
</span><span id=__span-20-6><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock1</span><span class=p>(</span><span class=n>mtx1</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>defer_lock</span><span class=p>);</span>
</span><span id=__span-20-7><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>seconds</span><span class=p>(</span><span class=mi>1</span><span class=p>));</span>
</span><span id=__span-20-8><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock2</span><span class=p>(</span><span class=n>mtx2</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>defer_lock</span><span class=p>);</span>
</span><span id=__span-20-9><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>try_lock</span><span class=p>(</span><span class=n>lock1</span><span class=p>,</span><span class=w> </span><span class=n>lock2</span><span class=p>);</span>
</span><span id=__span-20-10>
</span><span id=__span-20-11><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>num</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>-1</span><span class=p>)</span>
</span><span id=__span-20-12><span class=w>    </span><span class=p>{</span>
</span><span id=__span-20-13><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-20-14><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>get_id</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;正在执行test1&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-20-15><span class=w>        </span><span class=n>lock1</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
</span><span id=__span-20-16><span class=w>        </span><span class=n>lock2</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
</span><span id=__span-20-17><span class=w>    </span><span class=p>}</span>
</span><span id=__span-20-18><span class=p>}</span>
</span><span id=__span-20-19>
</span><span id=__span-20-20><span class=kt>void</span><span class=w> </span><span class=nf>test2</span><span class=p>()</span>
</span><span id=__span-20-21><span class=p>{</span>
</span><span id=__span-20-22><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock2</span><span class=p>(</span><span class=n>mtx2</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>defer_lock</span><span class=p>);</span>
</span><span id=__span-20-23><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock1</span><span class=p>(</span><span class=n>mtx1</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>defer_lock</span><span class=p>);</span>
</span><span id=__span-20-24><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>try_lock</span><span class=p>(</span><span class=n>lock1</span><span class=p>,</span><span class=w> </span><span class=n>lock2</span><span class=p>);</span>
</span><span id=__span-20-25>
</span><span id=__span-20-26><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>num</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>-1</span><span class=p>)</span>
</span><span id=__span-20-27><span class=w>    </span><span class=p>{</span>
</span><span id=__span-20-28><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-20-29><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>get_id</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;正在执行test2&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-20-30><span class=w>        </span><span class=n>lock1</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
</span><span id=__span-20-31><span class=w>        </span><span class=n>lock2</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
</span><span id=__span-20-32><span class=w>    </span><span class=p>}</span>
</span><span id=__span-20-33><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-21-1><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>mtx1</span><span class=p>;</span>
</span><span id=__span-21-2><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>mtx2</span><span class=p>;</span>
</span><span id=__span-21-3>
</span><span id=__span-21-4><span class=kt>void</span><span class=w> </span><span class=nf>test1</span><span class=p>()</span>
</span><span id=__span-21-5><span class=p>{</span>
</span><span id=__span-21-6><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>seconds</span><span class=p>(</span><span class=mi>1</span><span class=p>));</span>
</span><span id=__span-21-7><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock1</span><span class=p>(</span><span class=n>mtx1</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>defer_lock</span><span class=p>);</span>
</span><span id=__span-21-8><span class=w>    </span><span class=c1>// 使用try_lock</span>
</span><span id=__span-21-9><span class=w>    </span><span class=n>lock1</span><span class=p>.</span><span class=n>try_lock</span><span class=p>();</span>
</span><span id=__span-21-10><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock2</span><span class=p>(</span><span class=n>mtx2</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>defer_lock</span><span class=p>);</span>
</span><span id=__span-21-11><span class=w>    </span><span class=c1>// 使用try_lock</span>
</span><span id=__span-21-12><span class=w>    </span><span class=n>lock2</span><span class=p>.</span><span class=n>try_lock</span><span class=p>();</span>
</span><span id=__span-21-13>
</span><span id=__span-21-14><span class=w>    </span><span class=c1>// 全部加锁才会执行</span>
</span><span id=__span-21-15><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lock1</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>lock2</span><span class=p>)</span>
</span><span id=__span-21-16><span class=w>    </span><span class=p>{</span>
</span><span id=__span-21-17><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-21-18><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>get_id</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;正在执行test1&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-21-19><span class=w>    </span><span class=p>}</span>
</span><span id=__span-21-20>
</span><span id=__span-21-21><span class=w>    </span><span class=c1>// 持有锁的释放</span>
</span><span id=__span-21-22><span class=w>    </span><span class=c1>// 放在上一个if的外面，确保已经获取的锁都可以被释放</span>
</span><span id=__span-21-23><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>lock2</span><span class=p>)</span>
</span><span id=__span-21-24><span class=w>        </span><span class=n>lock2</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
</span><span id=__span-21-25><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lock1</span><span class=p>)</span>
</span><span id=__span-21-26><span class=w>        </span><span class=n>lock1</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
</span><span id=__span-21-27><span class=p>}</span>
</span><span id=__span-21-28>
</span><span id=__span-21-29><span class=kt>void</span><span class=w> </span><span class=nf>test2</span><span class=p>()</span>
</span><span id=__span-21-30><span class=p>{</span>
</span><span id=__span-21-31><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock2</span><span class=p>(</span><span class=n>mtx2</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>defer_lock</span><span class=p>);</span>
</span><span id=__span-21-32><span class=w>    </span><span class=n>lock2</span><span class=p>.</span><span class=n>try_lock</span><span class=p>();</span>
</span><span id=__span-21-33><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock1</span><span class=p>(</span><span class=n>mtx1</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>defer_lock</span><span class=p>);</span>
</span><span id=__span-21-34><span class=w>    </span><span class=n>lock1</span><span class=p>.</span><span class=n>try_lock</span><span class=p>();</span>
</span><span id=__span-21-35>
</span><span id=__span-21-36><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>lock1</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>lock2</span><span class=p>)</span>
</span><span id=__span-21-37><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-21-38><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>get_id</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;正在执行正在执行test2&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-21-39>
</span><span id=__span-21-40><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lock1</span><span class=p>)</span>
</span><span id=__span-21-41><span class=w>        </span><span class=n>lock1</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
</span><span id=__span-21-42><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lock2</span><span class=p>)</span>
</span><span id=__span-21-43><span class=w>        </span><span class=n>lock2</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
</span><span id=__span-21-44><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <h3 id=call_once>同一个线程内只执行一次的模版函数<code>call_once</code><a class=headerlink href=#call_once title="Permanent link">&para;</a></h3> <p>如果想让多个线程只执行一次某个函数，那么就需要使用<code>call_once</code>，<code>call_once</code>的使用方式如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-22-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-22-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;thread&gt;</span>
</span><span id=__span-22-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;mutex&gt;</span>
</span><span id=__span-22-4>
</span><span id=__span-22-5><span class=c1>// 声明一个once_flag变量作为是否是第一次调用的标志</span>
</span><span id=__span-22-6><span class=n>std</span><span class=o>::</span><span class=n>once_flag</span><span class=w> </span><span class=n>flag</span><span class=p>;</span>
</span><span id=__span-22-7>
</span><span id=__span-22-8><span class=kt>void</span><span class=w> </span><span class=nf>initialize</span><span class=p>()</span>
</span><span id=__span-22-9><span class=p>{</span>
</span><span id=__span-22-10><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>get_id</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Initializing...&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-22-11><span class=p>}</span>
</span><span id=__span-22-12>
</span><span id=__span-22-13><span class=kt>void</span><span class=w> </span><span class=nf>thread_func</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-22-14><span class=p>{</span>
</span><span id=__span-22-15><span class=w>    </span><span class=c1>// 确保 initialize 函数只被调用一次</span>
</span><span id=__span-22-16><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>call_once</span><span class=p>(</span><span class=n>flag</span><span class=p>,</span><span class=w> </span><span class=n>initialize</span><span class=p>);</span>
</span><span id=__span-22-17><span class=p>}</span>
</span><span id=__span-22-18>
</span><span id=__span-22-19><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-22-20><span class=p>{</span>
</span><span id=__span-22-21><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t1</span><span class=p>(</span><span class=n>thread_func</span><span class=p>);</span>
</span><span id=__span-22-22><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t2</span><span class=p>(</span><span class=n>thread_func</span><span class=p>);</span>
</span><span id=__span-22-23><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t3</span><span class=p>(</span><span class=n>thread_func</span><span class=p>);</span>
</span><span id=__span-22-24>
</span><span id=__span-22-25><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-22-26><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-22-27><span class=w>    </span><span class=n>t3</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-22-28>
</span><span id=__span-22-29><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-22-30><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>在上面的代码中，在这个例子中，尽管有三个线程同时调用<code>thread_func</code>，但由于使用了<code>std::call_once</code>，<code>initialize</code>函数只会被执行一次。该函数的工作过程可以理解为：每个<code>std::once_flag</code>对象都有一个内部状态，用于记录该标志是否已经被“触发”。当多个线程同时调用<code>std::call_once</code>时，只有一个线程能够成功执行传入的函数，其他线程会等待直到该函数执行完毕。一旦某个线程成功执行了函数，后续对该<code>std::call_once</code>的调用将不再执行该函数</p> <h2 id=atomic>原子操作库<code>&lt;atomic&gt;</code><a class=headerlink href=#atomic title="Permanent link">&para;</a></h2> <h3 id=_5>基本介绍<a class=headerlink href=#_5 title="Permanent link">&para;</a></h3> <p>虽然可以通过上面的互斥锁来保证线程安全，但是加锁和释放锁本质也是资源竞争，在一定程度上会影响程序的性能，对于临界区只有一些比较简单的操作，例如变量的自增等，加锁的思路反而不是最优的，但是不加锁会存在线程安全问题（比如多个线程同时对变量自增）。为了解决这个问题，除了有互斥锁之外，还可以使用原子操作，毕竟之所以需要互斥锁，本质就是执行的代码不能保证是原子的，一旦能保证操作是原子的，那么就可以不需要使用互斥锁</p> <p>C++ 11中提供了原子操作库，在该库中关键的结构是<code>atomic</code>，这个类是一个模版类，但是并不代表所有类型的操作都可以保证是原子的。<code>atomic</code>对模版类型的要求是模板可用任何满足可复制构造（CopyConstructible）及可复制赋值（CopyAssignable）的<a href=javascript:; class=custom-tooltip data-title=即可以进行浅拷贝的>可平凡复制（TriviallyCopyable）</a>类型实例化，模板类型用以下几个函数判断时，如果任意一个返回<code>false</code>，则用于<code>atomic</code>不是原子操作：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-23-1><span class=n>std</span><span class=o>::</span><span class=n>is_trivially_copyable</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;::</span><span class=n>value</span>
</span><span id=__span-23-2><span class=n>std</span><span class=o>::</span><span class=n>is_copy_constructible</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;::</span><span class=n>value</span>
</span><span id=__span-23-3><span class=n>std</span><span class=o>::</span><span class=n>is_move_constructible</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;::</span><span class=n>value</span>
</span><span id=__span-23-4><span class=n>std</span><span class=o>::</span><span class=n>is_copy_assignable</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;::</span><span class=n>value</span>
</span><span id=__span-23-5><span class=n>std</span><span class=o>::</span><span class=n>is_move_assignable</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;::</span><span class=n>value</span>
</span><span id=__span-23-6><span class=n>std</span><span class=o>::</span><span class=n>is_same</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=k>typename</span><span class=w> </span><span class=nc>std</span><span class=o>::</span><span class=n>remove_cv</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;::</span><span class=n>type</span><span class=o>&gt;::</span><span class=n>value</span>
</span></code></pre></div></td></tr></table></div> <p>例如下面的测试代码：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-24-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;string&gt;</span>
</span><span id=__span-24-2>
</span><span id=__span-24-3><span class=k>struct</span><span class=w> </span><span class=nc>Date</span>
</span><span id=__span-24-4><span class=p>{</span>
</span><span id=__span-24-5><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>_year</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-24-6><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>_month</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-24-7><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>_day</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-24-8><span class=p>};</span>
</span><span id=__span-24-9>
</span><span id=__span-24-10><span class=k>template</span><span class=o>&lt;</span><span class=k>class</span><span class=w> </span><span class=nc>T</span><span class=o>&gt;</span>
</span><span id=__span-24-11><span class=kt>void</span><span class=w> </span><span class=n>check</span><span class=p>()</span>
</span><span id=__span-24-12><span class=p>{</span>
</span><span id=__span-24-13><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=k>typeid</span><span class=p>(</span><span class=n>T</span><span class=p>).</span><span class=n>name</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-24-14><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>boolalpha</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>is_trivially_copyable</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;::</span><span class=n>value</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span><span class=w> </span>
</span><span id=__span-24-15><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>boolalpha</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>is_copy_constructible</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;::</span><span class=n>value</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span><span class=w> </span>
</span><span id=__span-24-16><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>boolalpha</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>is_move_constructible</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;::</span><span class=n>value</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span><span class=w> </span>
</span><span id=__span-24-17><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>boolalpha</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>is_copy_assignable</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;::</span><span class=n>value</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span><span class=w> </span>
</span><span id=__span-24-18><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>boolalpha</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>is_move_assignable</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;::</span><span class=n>value</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span><span class=w> </span>
</span><span id=__span-24-19><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>boolalpha</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>is_same</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=k>typename</span><span class=w> </span><span class=nc>std</span><span class=o>::</span><span class=n>remove_cv</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;::</span><span class=n>type</span><span class=o>&gt;::</span><span class=n>value</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-24-20><span class=p>}</span>
</span><span id=__span-24-21>
</span><span id=__span-24-22><span class=kt>int</span><span class=w> </span><span class=n>main</span><span class=p>()</span>
</span><span id=__span-24-23><span class=p>{</span>
</span><span id=__span-24-24><span class=w>    </span><span class=n>check</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>();</span>
</span><span id=__span-24-25><span class=w>    </span><span class=n>check</span><span class=o>&lt;</span><span class=kt>double</span><span class=o>&gt;</span><span class=p>();</span>
</span><span id=__span-24-26><span class=w>    </span><span class=n>check</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>*&gt;</span><span class=p>();</span>
</span><span id=__span-24-27><span class=w>    </span><span class=n>check</span><span class=o>&lt;</span><span class=n>Date</span><span class=o>&gt;</span><span class=p>();</span>
</span><span id=__span-24-28><span class=w>    </span><span class=n>check</span><span class=o>&lt;</span><span class=n>Date</span><span class=o>*&gt;</span><span class=p>();</span>
</span><span id=__span-24-29><span class=w>    </span><span class=n>check</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=p>();</span>
</span><span id=__span-24-30><span class=w>    </span><span class=n>check</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>*&gt;</span><span class=p>();</span>
</span><span id=__span-24-31>
</span><span id=__span-24-32><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-24-33><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>输出如下：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-25-1>int
</span><span id=__span-25-2>true
</span><span id=__span-25-3>true
</span><span id=__span-25-4>true
</span><span id=__span-25-5>true
</span><span id=__span-25-6>true
</span><span id=__span-25-7>true
</span><span id=__span-25-8>
</span><span id=__span-25-9>double
</span><span id=__span-25-10>true
</span><span id=__span-25-11>true
</span><span id=__span-25-12>true
</span><span id=__span-25-13>true
</span><span id=__span-25-14>true
</span><span id=__span-25-15>true
</span><span id=__span-25-16>
</span><span id=__span-25-17>int * __ptr64
</span><span id=__span-25-18>true
</span><span id=__span-25-19>true
</span><span id=__span-25-20>true
</span><span id=__span-25-21>true
</span><span id=__span-25-22>true
</span><span id=__span-25-23>true
</span><span id=__span-25-24>
</span><span id=__span-25-25>struct Date
</span><span id=__span-25-26>true
</span><span id=__span-25-27>true
</span><span id=__span-25-28>true
</span><span id=__span-25-29>true
</span><span id=__span-25-30>true
</span><span id=__span-25-31>true
</span><span id=__span-25-32>
</span><span id=__span-25-33>struct Date * __ptr64
</span><span id=__span-25-34>true
</span><span id=__span-25-35>true
</span><span id=__span-25-36>true
</span><span id=__span-25-37>true
</span><span id=__span-25-38>true
</span><span id=__span-25-39>true
</span><span id=__span-25-40>
</span><span id=__span-25-41>class std::basic_string&lt;char,struct std::char_traits&lt;char&gt;,class std::allocator&lt;char&gt; &gt;
</span><span id=__span-25-42>false
</span><span id=__span-25-43>true
</span><span id=__span-25-44>true
</span><span id=__span-25-45>true
</span><span id=__span-25-46>true
</span><span id=__span-25-47>true
</span><span id=__span-25-48>
</span><span id=__span-25-49>class std::basic_string&lt;char,struct std::char_traits&lt;char&gt;,class std::allocator&lt;char&gt; &gt; * __ptr64
</span><span id=__span-25-50>true
</span><span id=__span-25-51>true
</span><span id=__span-25-52>true
</span><span id=__span-25-53>true
</span><span id=__span-25-54>true
</span><span id=__span-25-55>true
</span></code></pre></div></td></tr></table></div> <p>可以看到<code>string</code>并不满足可平凡复制，所以无法保证<code>string</code>中的操作是原子的，但是对于基本类型基本都是支持原子操作的</p> <h3 id=_6>原子操作原理<a class=headerlink href=#_6 title="Permanent link">&para;</a></h3> <p>原子操作的基本原理是基于硬件的，在现代的大多数CPU中，都提供了比较交换指令来支持CAS（Compare and Swap）操作，这一点在<a href=https://www.help-doc.top/Linux/linux-thread/thread-sync/thread-sync.html#_5>Linux线程互斥与同步</a>也有提及，在Linux系统和Windows系统下也提供了相应的CAS系统调用：</p> <div class="tabbed-set tabbed-alternate" data-tabs=2:2><input checked=checked id=__tabbed_2_1 name=__tabbed_2 type=radio><input id=__tabbed_2_2 name=__tabbed_2 type=radio><div class=tabbed-labels><label for=__tabbed_2_1>Linux</label><label for=__tabbed_2_2>Windows</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-26-1><span class=c1>// gcc⽀持的CAS接⼝</span>
</span><span id=__span-26-2><span class=kt>bool</span><span class=w> </span><span class=nf>__sync_bool_compare_and_swap</span><span class=w> </span><span class=p>(</span><span class=n>type</span><span class=w> </span><span class=o>*</span><span class=n>ptr</span><span class=p>,</span><span class=w> </span><span class=n>type</span><span class=w> </span><span class=n>oldval</span><span class=p>,</span><span class=w> </span><span class=n>type</span><span class=w> </span><span class=n>newval</span><span class=p>);</span>
</span><span id=__span-26-3><span class=n>type</span><span class=w> </span><span class=nf>__sync_val_compare_and_swap</span><span class=w> </span><span class=p>(</span><span class=n>type</span><span class=w> </span><span class=o>*</span><span class=n>ptr</span><span class=p>,</span><span class=w> </span><span class=n>type</span><span class=w> </span><span class=n>oldval</span><span class=p>,</span><span class=w> </span><span class=n>type</span><span class=w> </span><span class=n>newval</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-27-1><span class=c1>// Windows⽀持的CAS接⼝</span>
</span><span id=__span-27-2><span class=n>InterlockedCompareExchange</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>__inout</span><span class=w> </span><span class=n>LONG</span><span class=w> </span><span class=k>volatile</span><span class=w> </span><span class=o>*</span><span class=n>Target</span><span class=p>,</span><span class=w> </span><span class=n>__in</span><span class=w> </span><span class=n>LONG</span><span class=w> </span><span class=n>Exchange</span><span class=p>,</span><span class=w> </span><span class=n>__in</span><span class=w> </span><span class=n>LONG</span><span class=w> </span><span class=n>Comperand</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>不论是Linux还是Windows下的CAS系统调用，本质思路都是比较内存中取出的值（Linux下<code>*ptr</code>，Windows下<code>*Target</code>）与预期值（Linux下<code>oldval</code>，Windows下<code>Comperand</code>）是否相等，如果相等说明当前没有线程进行修改，此时就可以将内存中取出的值修改为新的值（Linux下<code>newval</code>，Windows下<code>Exchange</code>）并返回<code>true</code>；如果不相等，那么说明当前值已被其他线程修改，将期望值修改为取出的值，此时不对取出的值做任何修改，仅返回<code>false</code>。CAS操作本身不会自动重试，通常需要调用者在外层使用循环来实现"尝试直到成功"的逻辑</p> <p>但是，现在还存在另外一个问题：既然<code>*ptr</code>和<code>oldval</code>都是从内存取的，那么假设有一个线程的确对某个变量进行了修改但是还没有来得及写入内存，此时另外一个线程取出的<code>*ptr</code>和<code>oldval</code>依旧是一样的，这种情况下另外一个线程也开始对这个值进行了修改，再写入内存不就覆盖了吗？</p> <p>对于上面的问题，首先明确一个过程，如果CPU要读取到当前变量的值，在现代计算机架构中大部分都是从缓存中读取，而缓存中的数据来自于内存，同样，写入的时候也会先写入缓存，再考虑写入内存</p> <p>对于读数据和写数据分别有有相关的策略：</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>注意，缓存未命中时从内存中加载数据并不是一个字节一个字节加载，而是以块为单位进行的，这个块也被称为Cache Block或者称为Cache Line</p> </div> <div class="tabbed-set tabbed-alternate" data-tabs=3:2><input checked=checked id=__tabbed_3_1 name=__tabbed_3 type=radio><input id=__tabbed_3_2 name=__tabbed_3 type=radio><div class=tabbed-labels><label for=__tabbed_3_1>读策略</label><label for=__tabbed_3_2>写策略</label></div> <div class=tabbed-content> <div class=tabbed-block> <ul> <li><strong>直读（Read Through）策略</strong>：缓存未命中时，直接从内存中读取数据块（Cache Block），而不经过缓存</li> <li><strong>读分配（Read Alloc）策略</strong>：缓存未命中时：先在缓存中申请一块空间，再从内存中将需要的Cache Block读取到该空间中，最后从Cache Block中取出数据进行使用</li> </ul> </div> <div class=tabbed-block> <ul> <li> <p><strong>直写（Write Through）策略</strong>：</p> <ul> <li>缓存中不存在指定的Cache Block：直接将数据更新到内存中</li> <li>缓存中存在指定的Cache Block：更新缓存中的数据，再将数据写入到内存</li> </ul> </li> <li> <p><strong>写回（Write Back）策略</strong>：</p> <ul> <li> <p>缓存中存在指定的Cache Block：将数据更新到缓存中的Cache Block中。将该Cache Block标记为脏，但不向内存中写入</p> </li> <li> <p>缓存中不存在指定的Cache Block，并且存在其他数据，判断其他的Cache Block是否为脏数据：</p> <ul> <li> <p><strong>是脏数据</strong>：</p> <ol> <li>将脏数据写入到内存，</li> <li>从内存中重新读取数据块到缓存中，确保下一次缓存中的数据是最新的（这样也可以保证下一次的缓存命中率，而不是每次都从内存中读取）</li> <li>将当前要更新的数据写入到对应的Cache Block中</li> <li>最后将该Cache Block标记为脏</li> </ol> </li> <li> <p><strong>不是脏数据</strong>：</p> <ol> <li>说明此时缓存和内存是一致的</li> <li>但是当前缓存并不存在对应的Cache Block，所以将要更新的数据先读取到缓存中</li> <li>再将更新的数据写入到对应的Cache Block中</li> <li>最后将该Cache Block标记为脏</li> </ol> </li> </ul> </li> </ul> </li> </ul> </div> </div> </div> <p>有了上面的概念之后，再回到上面的问题，现在知道了实际上取数据大部分情况下并不是直接从内存中取，而是从缓存取，那么上面的问题就变成了如果不同的缓存看到的相同的值，并且同时有多个线程进行修改如何保证数据一致？这就涉及到了缓存一致性，所谓缓存一致性就是确保不同的核心拥有的缓存在数据发生改变时能够同步改变，要实现缓存一致性就需要做到下面两点：</p> <ol> <li>写传播：一旦有数据更新就同步该数据到其他缓存中，但是只有写传播无法保证同步修改的顺序</li> <li>事务串行化：确保所有处理器以相同的顺序看到对共享内存的写入操作。这通常通过缓存一致性协议（如MESI、MOESI等）来实现，这些协议会跟踪每个缓存行的状态，并在多个处理器尝试同时修改同一内存位置时协调它们的操作</li> </ol> <p>对于写传播来说，比较容易理解，下面主要考虑事务串行化，假设现在存在四个核心，每个核心对应着一个线程，并且都对同一个变量进行修改，该变量初始值为100，如下图所示：</p> <p><a class=glightbox href="35. C++并发支持库.assets/image-20250418151936642.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="35. C++并发支持库.assets/image-20250418151936642.png"></a></p> <p>接着核心A和核心B同时对该变量进行修改，核心A将该变量的值修改为200，核心B将该变量的值修改为300，如下图所示：</p> <p><a class=glightbox href="35. C++并发支持库.assets/image-20250418152027057.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="35. C++并发支持库.assets/image-20250418152027057.png"></a></p> <p>现在对于C和D来说，C可能认为先对该变量修改为200，再修改为300，D可能认为先对该变量修改为300，再修改为200，很明显虽然这样的确做到了写传播，但是却无法不同的核心一定看到的是相同的修改顺序，所以需要用到事务串行化来解决这个问题</p> <p>实现事务串行化可以使用MESI协议，即：</p> <ol> <li><code>Modified</code>：已修改，该缓存行已被当前处理器修改，与内存中的值不同（即脏数据）</li> <li><code>Exclusive</code>：独占，缓存行<strong>仅在当前处理器缓存</strong>中存在，但未被修改</li> <li><code>Shared</code>：共享，当前数据的缓存行可能存在于多个处理器的缓存中</li> <li><code>Invalid</code>：无效，缓存行无效，不包含有效数据</li> </ol> <p>基于MESI协议，就可以做到一个线程对变量进行修改之后通过写传播+事务串行化让其他的核心能够看到该变量的修改</p> <p>综上所述，实际上CAS操作具体描述为从缓存中加载值与当前的预期值进行比较（如果缓存中不存在需要的数据就从内存中加载），如果预期值和取出的值相等，那么更新取出的值为新值，并通知其他线程数据发生改变（此处涉及到写传播+事务串行化来实现缓存一致性）；如果不相同，就更新预期值为当前取出的值，做到预期值数据的更新</p> <h3 id=cas>原子库中针对CAS操作的函数<a class=headerlink href=#cas title="Permanent link">&para;</a></h3> <p>在C++11的原子操作库中也提供了有关CAS操作的接口：</p> <table> <thead> <tr> <th>函数名</th> <th>功能描述</th> </tr> </thead> <tbody> <tr> <td><code>compare_exchange_weak(T&amp; expected, T desired, memory_order success, memory_order failure)</code></td> <td>如果当前值等于 <code>expected</code>，则将其替换为 <code>desired</code>，否则将 <code>expected</code> 更新为当前值。<br>可能会虚假失败（硬件原因）</td> </tr> <tr> <td><code>compare_exchange_strong(T&amp; expected, T desired, memory_order success, memory_order failure)</code></td> <td>类似于 <code>compare_exchange_weak</code>，但保证不会虚假失败</td> </tr> <tr> <td><code>compare_exchange_weak(T&amp; expected, T desired, memory_order order = memory_order_seq_cst)</code></td> <td>简化版，成功和失败使用相同的内存顺序</td> </tr> <tr> <td><code>compare_exchange_strong(T&amp; expected, T desired, memory_order order = memory_order_seq_cst)</code></td> <td>简化版，成功和失败使用相同的内存顺序</td> </tr> </tbody> </table> <p>常用配套的接口如下：</p> <table> <thead> <tr> <th>函数名</th> <th>功能描述</th> </tr> </thead> <tbody> <tr> <td><code>load(memory_order order = memory_order_seq_cst)</code></td> <td>读取原子变量的值，可以选择不同的内存顺序。</td> </tr> <tr> <td><code>store(T value, memory_order order = memory_order_seq_cst)</code></td> <td>设置原子变量的值，可以选择不同的内存顺序。</td> </tr> <tr> <td><code>exchange(T value, memory_order order = memory_order_seq_cst)</code></td> <td>将原子变量的值替换为新值，并返回旧值。</td> </tr> <tr> <td><code>operator T()</code></td> <td>隐式转换操作符，将原子对象转换为其存储的值类型，等同于调用<code>load()</code></td> </tr> </tbody> </table> <p>例如下面的一个例子：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-28-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;atomic&gt;</span>
</span><span id=__span-28-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;vector&gt;</span>
</span><span id=__span-28-3>
</span><span id=__span-28-4><span class=k>struct</span><span class=w> </span><span class=nc>Node</span><span class=w> </span>
</span><span id=__span-28-5><span class=p>{</span><span class=w> </span>
</span><span id=__span-28-6><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w> </span>
</span><span id=__span-28-7><span class=w>    </span><span class=n>Node</span><span class=o>*</span><span class=w> </span><span class=n>next</span><span class=p>;</span><span class=w> </span>
</span><span id=__span-28-8><span class=p>};</span>
</span><span id=__span-28-9>
</span><span id=__span-28-10><span class=n>std</span><span class=o>::</span><span class=n>atomic</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>*&gt;</span><span class=w> </span><span class=n>list_head</span><span class=p>(</span><span class=k>nullptr</span><span class=p>);</span>
</span><span id=__span-28-11>
</span><span id=__span-28-12><span class=kt>void</span><span class=w> </span><span class=nf>insertBefore</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>val</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-28-13><span class=p>{</span><span class=w>     </span>
</span><span id=__span-28-14><span class=w>    </span><span class=c1>// 相当于Node* oldHead = list_head; 这里用到了operator T()函数，将atomic对象转换为存储的内容</span>
</span><span id=__span-28-15><span class=w>    </span><span class=n>Node</span><span class=o>*</span><span class=w> </span><span class=n>oldHead</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>list_head</span><span class=p>.</span><span class=n>load</span><span class=p>();</span>
</span><span id=__span-28-16><span class=w>    </span><span class=n>Node</span><span class=o>*</span><span class=w> </span><span class=n>newNode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Node</span><span class=p>{</span><span class=w> </span><span class=n>val</span><span class=p>,</span><span class=n>oldHead</span><span class=w> </span><span class=p>};</span>
</span><span id=__span-28-17>
</span><span id=__span-28-18><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>list_head</span><span class=p>.</span><span class=n>compare_exchange_weak</span><span class=p>(</span><span class=n>oldHead</span><span class=p>,</span><span class=w> </span><span class=n>newNode</span><span class=p>))</span>
</span><span id=__span-28-19><span class=w>        </span><span class=n>newNode</span><span class=o>-&gt;</span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>oldHead</span><span class=p>;</span>
</span><span id=__span-28-20><span class=p>}</span>
</span><span id=__span-28-21>
</span><span id=__span-28-22><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-28-23><span class=p>{</span>
</span><span id=__span-28-24><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>threads</span><span class=p>;</span>
</span><span id=__span-28-25>
</span><span id=__span-28-26><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-28-27><span class=w>        </span><span class=n>threads</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=p>(</span><span class=n>insertBefore</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>));</span>
</span><span id=__span-28-28><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=o>&amp;</span><span class=w> </span><span class=n>th</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>threads</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-28-29><span class=w>        </span><span class=n>th</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-28-30>
</span><span id=__span-28-31><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Node</span><span class=o>*</span><span class=w> </span><span class=n>it</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>list_head</span><span class=p>;</span><span class=w> </span><span class=n>it</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=k>nullptr</span><span class=p>;</span><span class=w> </span><span class=n>it</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>it</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>)</span>
</span><span id=__span-28-32><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=sc>&#39; &#39;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>it</span><span class=o>-&gt;</span><span class=n>value</span><span class=p>;</span>
</span><span id=__span-28-33><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=p>;</span>
</span><span id=__span-28-34>
</span><span id=__span-28-35><span class=w>    </span><span class=n>Node</span><span class=o>*</span><span class=w> </span><span class=n>it</span><span class=p>;</span><span class=w> </span>
</span><span id=__span-28-36><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>it</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>list_head</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-28-37><span class=w>    </span><span class=p>{</span><span class=w> </span>
</span><span id=__span-28-38><span class=w>        </span><span class=n>list_head</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>it</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>;</span><span class=w> </span>
</span><span id=__span-28-39><span class=w>        </span><span class=k>delete</span><span class=w> </span><span class=n>it</span><span class=p>;</span><span class=w> </span>
</span><span id=__span-28-40><span class=w>    </span><span class=p>}</span>
</span><span id=__span-28-41>
</span><span id=__span-28-42><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-28-43><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>参考输出：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-29-1> 9 8 6 7 4 5 3 2 1 0
</span></code></pre></div></td></tr></table></div> <p>在上面的代码中，使用到了<code>compare_exchange_weak</code>，以其中一段过程为例：首先头结点（<code>list_head</code>）为空，在<code>insertBefore</code>函数中首先获取到旧值<code>oldHead</code>为当前头结点，再创建一个新的节点<code>newHead</code>作为准备插入的节点，接着执行循环部分。因为当前<code>list_head</code>为空，<code>oldHead</code>也为空，所以二者按照内存序列比较时是相等的，根据CAS操作的特点，只要取出的值（此处为<code>list_head</code>）和预期值（此处为<code>oldHead</code>）相等，那么就将新值（此处为<code>newHead</code>）赋值给取出的值，即执行类似于：<code>list_head = newHead</code>，然后返回<code>true</code>不进入循环体</p> <p>根据上面的过程，现在假设有多个线程同时走到了循环部分，例如下图所示：</p> <p><a class=glightbox href="35. C++并发支持库.assets/image-20250418162636486.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="35. C++并发支持库.assets/image-20250418162636486.png"></a></p> <p>假如线程1先被调度，那么根据CAS操作，判断出<code>oldHead</code>与<code>list_head</code>相等，那么就会执行<code>list_head = newHead</code>，然后返回<code>true</code>，此时线程1执行完毕，轮到线程2继续从上一次离开的位置执行，即继续执行循环，此时直观来看线程2的<code>oldHead</code>依旧与<code>list_head</code>相同，但是实际上并不是，因为在上面提到过缓存一致性的问题，一旦线程1更新了<code>list_head</code>让其指向了线程1创建的<code>newHead</code>，那么线程2再次执行时取到的<code>list_head</code>是值由线程1创建的值为20的节点，那么很显然，此时取出的值<code>list_head</code>与预期值<code>oldHead</code>不相等，所以线程2这一轮插入失败，但是插入失败还没有结束运行，CAS操作会更新当前线程2的<code>oldHead</code>为<code>list_head</code>，即<code>oldHead = list_head</code>，此时线程2的<code>oldHead</code>即为值为20的头节点，接着因为CAS这一轮返回<code>false</code>，所以循环继续执行，在这一次循环中，<code>oldHead</code>与<code>list_head</code>相等，所以会执行<code>list_head = newHead</code>，然后返回<code>true</code>，此时线程2执行完毕，所以整个过程如下：</p> <p><a class=glightbox href="35. C++并发支持库.assets/image-20250418163620436.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="35. C++并发支持库.assets/image-20250418163620436.png"></a></p> <p>在上面的例子中已经介绍了CAS函数的基本使用和工作模式，但是上面的CAS函数不止一个，彼此之间最典型的区别首先就是一对是<code>weak</code>结尾，一对是<code>strong</code>结尾，那么二者有什么区别？</p> <table> <thead> <tr> <th>特性</th> <th><code>compare_exchange_weak</code></th> <th><code>compare_exchange_strong</code></th> </tr> </thead> <tbody> <tr> <td>虚假失败</td> <td><strong>可能发生</strong>。即使当前值等于期望值，也可能因硬件/系统原因而失败</td> <td><strong>不会发生</strong>。只有当前值不等于期望值时才会失败</td> </tr> <tr> <td>性能</td> <td>在某些平台上可能更高效</td> <td>在某些平台可能需要额外开销</td> </tr> <tr> <td>适用场景</td> <td>循环中使用，可接受偶尔重试</td> <td>失败代价高或不在循环中使用</td> </tr> </tbody> </table> <p>那么为什么会存在虚假失败？可能的情况有如下几点：</p> <ol> <li><strong>多处理器系统中的竞争条件</strong>：当多个核心同时尝试修改同一缓存行时</li> <li><strong>处理器架构限制</strong>：某些CPU架构无法直接实现原子的"比较并交换"操作</li> <li><strong>系统中断</strong>：比较后交换前的时间间隙中发生系统中断</li> </ol> <p>那么如何选择<code>weak</code>和<code>strong</code>这两个版本的CAS函数呢？有下面几点参考：</p> <ul> <li><strong>在循环中使用</strong>时，通常选择<code>weak</code>版本，因为虚假失败会在下一轮循环中重试</li> <li><strong>不在循环中使用</strong>或<strong>重试代价高</strong>时，选择<code>strong</code>版本</li> </ul> <p>参考示例：</p> <div class="tabbed-set tabbed-alternate" data-tabs=4:2><input checked=checked id=__tabbed_4_1 name=__tabbed_4 type=radio><input id=__tabbed_4_2 name=__tabbed_4 type=radio><div class=tabbed-labels><label for=__tabbed_4_1><code>weak</code>版本</label><label for=__tabbed_4_2><code>strong</code>版本</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-30-1><span class=n>std</span><span class=o>::</span><span class=n>atomic</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>value</span><span class=p>(</span><span class=mi>10</span><span class=p>);</span>
</span><span id=__span-30-2><span class=kt>int</span><span class=w> </span><span class=n>expected</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span>
</span><span id=__span-30-3><span class=kt>int</span><span class=w> </span><span class=n>new_value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>20</span><span class=p>;</span>
</span><span id=__span-30-4>
</span><span id=__span-30-5><span class=c1>// 在循环中使用，重试直到成功</span>
</span><span id=__span-30-6><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>value</span><span class=p>.</span><span class=n>compare_exchange_weak</span><span class=p>(</span><span class=n>expected</span><span class=p>,</span><span class=w> </span><span class=n>new_value</span><span class=p>))</span><span class=w> </span>
</span><span id=__span-30-7><span class=p>{</span>
</span><span id=__span-30-8><span class=w>    </span><span class=c1>// 虚假失败会自动更新expected，所以不需要重新加载</span>
</span><span id=__span-30-9><span class=w>    </span><span class=c1>// 如果是真实失败，expected已被更新为最新值</span>
</span><span id=__span-30-10><span class=w>    </span><span class=n>new_value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>expected</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w> </span><span class=c1>// 基于新的expected值重新计算</span>
</span><span id=__span-30-11><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-31-1><span class=n>std</span><span class=o>::</span><span class=n>atomic</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>value</span><span class=p>(</span><span class=mi>10</span><span class=p>);</span>
</span><span id=__span-31-2><span class=kt>int</span><span class=w> </span><span class=n>expected</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span>
</span><span id=__span-31-3><span class=kt>int</span><span class=w> </span><span class=n>new_value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>20</span><span class=p>;</span>
</span><span id=__span-31-4>
</span><span id=__span-31-5><span class=c1>// 单次尝试，不在循环中</span>
</span><span id=__span-31-6><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>value</span><span class=p>.</span><span class=n>compare_exchange_strong</span><span class=p>(</span><span class=n>expected</span><span class=p>,</span><span class=w> </span><span class=n>new_value</span><span class=p>))</span><span class=w> </span>
</span><span id=__span-31-7><span class=p>{</span>
</span><span id=__span-31-8><span class=w>    </span><span class=c1>// 交换成功，value现在是new_value</span>
</span><span id=__span-31-9><span class=p>}</span><span class=w> </span>
</span><span id=__span-31-10><span class=k>else</span><span class=w> </span>
</span><span id=__span-31-11><span class=p>{</span>
</span><span id=__span-31-12><span class=w>    </span><span class=c1>// 交换失败，expected现在包含value的实际值</span>
</span><span id=__span-31-13><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>除了存在<code>weak</code>和<code>strong</code>这两个版本外，在一个版本内部还存在着两个版本，主要区别就在于<code>memory_order</code>的数量。那么什么是<code>memory_order</code>？</p> <p><code>memory_order</code>是C++11引入的内存顺序模型，用于精确控制多线程程序中原子操作的可见性和执行顺序</p> <p>所谓内存顺序，就是定义了在多线程环境中，原子操作对内存的访问如何被其他线程观察到，以及这些操作之间如何排序。这对于无锁编程至关重要，因为现代处理器可能会对指令进行重排序以提高性能</p> <table> <thead> <tr> <th>内存顺序</th> <th>含义</th> <th>性能</th> <th>保证</th> </tr> </thead> <tbody> <tr> <td><code>memory_order_relaxed</code></td> <td>最宽松，仅保证原子性</td> <td>最高</td> <td>只保证操作本身的原子性</td> </tr> <tr> <td><code>memory_order_consume</code></td> <td>依赖顺序</td> <td>较高</td> <td>保证数据依赖关系的顺序</td> </tr> <tr> <td><code>memory_order_acquire</code></td> <td>获取顺序</td> <td>中等</td> <td>防止读操作被重排到获取操作之前</td> </tr> <tr> <td><code>memory_order_release</code></td> <td>释放顺序</td> <td>中等</td> <td>防止写操作被重排到释放操作之后</td> </tr> <tr> <td><code>memory_order_acq_rel</code></td> <td>获取-释放顺序</td> <td>较低</td> <td>结合获取和释放的保证</td> </tr> <tr> <td><code>memory_order_seq_cst</code></td> <td>顺序一致性（默认）</td> <td>最低</td> <td>所有线程看到的操作顺序完全一致</td> </tr> </tbody> </table> <p>为什么需要提供不同数量的控制内存顺序？</p> <p>在<code>compare_exchange_weak/strong</code>函数中提供两个内存顺序参数：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-32-1><span class=kt>bool</span><span class=w> </span><span class=nf>compare_exchange_weak</span><span class=p>(</span><span class=n>T</span><span class=o>&amp;</span><span class=w> </span><span class=n>expected</span><span class=p>,</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=n>desired</span><span class=p>,</span>
</span><span id=__span-32-2><span class=w>                          </span><span class=n>memory_order</span><span class=w> </span><span class=n>success</span><span class=p>,</span>
</span><span id=__span-32-3><span class=w>                          </span><span class=n>memory_order</span><span class=w> </span><span class=n>failure</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>这是因为：</p> <ol> <li> <p><strong>成功和失败的场景不同</strong>：</p> <ul> <li><code>success</code>：指定交换成功时使用的内存顺序</li> <li><code>failure</code>：指定交换失败时使用的内存顺序</li> </ul> </li> <li> <p><strong>性能优化</strong>：失败操作通常只是一个读操作，不需要与成功操作相同的严格内存序。例如，成功时可能需要<code>memory_order_acq_rel</code>，而失败时只需<code>memory_order_acquire</code></p> </li> </ol> <p>例如下面的例子：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-33-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;atomic&gt;</span>
</span><span id=__span-33-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;thread&gt;</span>
</span><span id=__span-33-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-33-4>
</span><span id=__span-33-5><span class=n>std</span><span class=o>::</span><span class=n>atomic</span><span class=o>&lt;</span><span class=kt>bool</span><span class=o>&gt;</span><span class=w> </span><span class=n>ready</span><span class=p>(</span><span class=nb>false</span><span class=p>);</span>
</span><span id=__span-33-6><span class=n>std</span><span class=o>::</span><span class=n>atomic</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>data</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-33-7>
</span><span id=__span-33-8><span class=kt>void</span><span class=w> </span><span class=nf>producer</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-33-9><span class=p>{</span>
</span><span id=__span-33-10><span class=w>    </span><span class=c1>// 准备数据</span>
</span><span id=__span-33-11><span class=w>    </span><span class=n>data</span><span class=p>.</span><span class=n>store</span><span class=p>(</span><span class=mi>42</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>memory_order_relaxed</span><span class=p>);</span>
</span><span id=__span-33-12>
</span><span id=__span-33-13><span class=w>    </span><span class=c1>// 使用memory_order_release确保之前的写入对其他线程可见</span>
</span><span id=__span-33-14><span class=w>    </span><span class=n>ready</span><span class=p>.</span><span class=n>store</span><span class=p>(</span><span class=nb>true</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>memory_order_release</span><span class=p>);</span>
</span><span id=__span-33-15><span class=p>}</span>
</span><span id=__span-33-16>
</span><span id=__span-33-17><span class=kt>void</span><span class=w> </span><span class=nf>consumer</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-33-18><span class=p>{</span>
</span><span id=__span-33-19><span class=w>    </span><span class=c1>// 等待数据准备好，使用memory_order_acquire确保能看到之前的写入</span>
</span><span id=__span-33-20><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>ready</span><span class=p>.</span><span class=n>load</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>memory_order_acquire</span><span class=p>))</span><span class=w> </span>
</span><span id=__span-33-21><span class=w>    </span><span class=p>{</span>
</span><span id=__span-33-22><span class=w>        </span><span class=c1>// 等待，直到读取到ready为true</span>
</span><span id=__span-33-23><span class=w>    </span><span class=p>}</span>
</span><span id=__span-33-24>
</span><span id=__span-33-25><span class=w>    </span><span class=c1>// 此处保证能看到producer中对data的写入</span>
</span><span id=__span-33-26><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=n>load</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>memory_order_relaxed</span><span class=p>);</span>
</span><span id=__span-33-27><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;读取到的数据: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span><span class=w> </span><span class=c1>// 一定输出42</span>
</span><span id=__span-33-28><span class=p>}</span>
</span><span id=__span-33-29>
</span><span id=__span-33-30><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-33-31><span class=p>{</span>
</span><span id=__span-33-32><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t1</span><span class=p>(</span><span class=n>producer</span><span class=p>);</span>
</span><span id=__span-33-33><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t2</span><span class=p>(</span><span class=n>consumer</span><span class=p>);</span>
</span><span id=__span-33-34>
</span><span id=__span-33-35><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-33-36><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-33-37><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-33-38><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>但是，尽管这里提供了那么多种内存顺序，但是大部分情况下直接使用<code>memory_order_seq_cst</code>（最严格）也可以，对性能影响并不是很大，除非是对性能要求非常高的场景</p> <h3 id=_7>原子操作函数<a class=headerlink href=#_7 title="Permanent link">&para;</a></h3> <p>对于原子操作，在库中也提供了一些操作函数：</p> <h4 id=_8>原子修改操作（带返回值）<a class=headerlink href=#_8 title="Permanent link">&para;</a></h4> <p>这些函数在修改原子变量的同时返回修改前或修改后的值。</p> <table> <thead> <tr> <th>函数名</th> <th>功能描述</th> </tr> </thead> <tbody> <tr> <td><code>fetch_add(T value, memory_order order = memory_order_seq_cst)</code></td> <td>对原子变量执行加法操作，返回加法前的值。</td> </tr> <tr> <td><code>fetch_sub(T value, memory_order order = memory_order_seq_cst)</code></td> <td>对原子变量执行减法操作，返回减法前的值。</td> </tr> <tr> <td><code>fetch_and(T value, memory_order order = memory_order_seq_cst)</code></td> <td>对原子变量执行按位与操作，返回操作前的值。</td> </tr> <tr> <td><code>fetch_or(T value, memory_order order = memory_order_seq_cst)</code></td> <td>对原子变量执行按位或操作，返回操作前的值。</td> </tr> <tr> <td><code>fetch_xor(T value, memory_order order = memory_order_seq_cst)</code></td> <td>对原子变量执行按位异或操作，返回操作前的值。</td> </tr> </tbody> </table> <p>以<code>fetch_add</code>为例：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-34-1><span class=n>std</span><span class=o>::</span><span class=n>atomic</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>count</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-34-2><span class=n>std</span><span class=o>::</span><span class=n>atomic</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>ret</span><span class=p>;</span>
</span><span id=__span-34-3>
</span><span id=__span-34-4><span class=kt>void</span><span class=w> </span><span class=nf>test</span><span class=p>()</span>
</span><span id=__span-34-5><span class=p>{</span>
</span><span id=__span-34-6><span class=w>    </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>count</span><span class=p>.</span><span class=n>fetch_add</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-34-7><span class=p>}</span>
</span><span id=__span-34-8>
</span><span id=__span-34-9><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-34-10><span class=p>{</span>
</span><span id=__span-34-11><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t</span><span class=p>(</span><span class=n>test</span><span class=p>);</span>
</span><span id=__span-34-12><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t1</span><span class=p>(</span><span class=n>test</span><span class=p>);</span>
</span><span id=__span-34-13>
</span><span id=__span-34-14><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>seconds</span><span class=p>(</span><span class=mi>3</span><span class=p>));</span>
</span><span id=__span-34-15>
</span><span id=__span-34-16><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span><span class=w> </span><span class=c1>// 2</span>
</span><span id=__span-34-17><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span><span class=w> </span><span class=c1>// 1</span>
</span><span id=__span-34-18>
</span><span id=__span-34-19><span class=w>    </span><span class=n>t</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-34-20><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-34-21>
</span><span id=__span-34-22><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-34-23><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h4 id=stdatomic_flag>原子标志（<code>std::atomic_flag</code>）<a class=headerlink href=#stdatomic_flag title="Permanent link">&para;</a></h4> <p><code>std::atomic_flag</code>是一个特殊的原子类型，通常用于实现自旋锁等低级同步机制，初始化时必须要使用<code>ATOMIC_FLAG_INIT</code></p> <table> <thead> <tr> <th>函数名</th> <th>功能描述</th> </tr> </thead> <tbody> <tr> <td><code>clear(memory_order order = memory_order_seq_cst)</code></td> <td>将<code>std::atomic_flag</code>标志清零（设置为 <code>false</code>）</td> </tr> <tr> <td><code>test_and_set(memory_order order = memory_order_seq_cst)</code></td> <td>将<code>std::atomic_flag</code>标志设置为<code>true</code>，并返回之前的值</td> </tr> </tbody> </table> <p>实际上，<code>std::atomic_flag</code>就是对<code>atomic&lt;bool&gt;</code>的一种封装，下面是分别使用<code>atomic&lt;bool&gt;</code>和<code>atomic_flag</code>实现自旋锁：</p> <div class="tabbed-set tabbed-alternate" data-tabs=5:2><input checked=checked id=__tabbed_5_1 name=__tabbed_5 type=radio><input id=__tabbed_5_2 name=__tabbed_5 type=radio><div class=tabbed-labels><label for=__tabbed_5_1>使用<code>atomic&lt;bool&gt;</code></label><label for=__tabbed_5_2>使用<code>atomic_flag</code></label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-35-1><span class=k>class</span><span class=w> </span><span class=nc>SpinningLock</span>
</span><span id=__span-35-2><span class=p>{</span>
</span><span id=__span-35-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-35-4><span class=w>    </span><span class=n>SpinningLock</span><span class=p>()</span>
</span><span id=__span-35-5><span class=w>        </span><span class=o>:</span><span class=n>flag_</span><span class=p>(</span><span class=nb>false</span><span class=p>)</span>
</span><span id=__span-35-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-35-7>
</span><span id=__span-35-8><span class=w>    </span><span class=p>}</span>
</span><span id=__span-35-9>
</span><span id=__span-35-10><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>lock</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-35-11><span class=w>    </span><span class=p>{</span>
</span><span id=__span-35-12><span class=w>        </span><span class=c1>// 期望值为false，一旦flag_为false就会触发CAS操作中期望值和取出的值相同的行为</span>
</span><span id=__span-35-13><span class=w>        </span><span class=c1>// 而flag_为true代表加锁</span>
</span><span id=__span-35-14><span class=w>        </span><span class=kt>bool</span><span class=w> </span><span class=n>expected</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-35-15><span class=w>        </span><span class=c1>// 尝试将flag_从false原子地设置为true</span>
</span><span id=__span-35-16><span class=w>        </span><span class=c1>// 如果失败（即flag_已经是true），则继续循环</span>
</span><span id=__span-35-17><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>flag_</span><span class=p>.</span><span class=n>compare_exchange_weak</span><span class=p>(</span><span class=n>expected</span><span class=p>,</span><span class=w> </span><span class=nb>true</span><span class=p>))</span><span class=w> </span>
</span><span id=__span-35-18><span class=w>            </span><span class=n>expected</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>false</span><span class=p>;</span><span class=w> </span><span class=c1>// 重置expected值用于下一次比较</span>
</span><span id=__span-35-19><span class=w>    </span><span class=p>}</span>
</span><span id=__span-35-20>
</span><span id=__span-35-21><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>unlock</span><span class=p>()</span>
</span><span id=__span-35-22><span class=w>    </span><span class=p>{</span>
</span><span id=__span-35-23><span class=w>        </span><span class=n>flag_</span><span class=p>.</span><span class=n>store</span><span class=p>(</span><span class=nb>false</span><span class=p>);</span>
</span><span id=__span-35-24><span class=w>    </span><span class=p>}</span>
</span><span id=__span-35-25>
</span><span id=__span-35-26><span class=k>private</span><span class=o>:</span>
</span><span id=__span-35-27><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>atomic</span><span class=o>&lt;</span><span class=kt>bool</span><span class=o>&gt;</span><span class=w> </span><span class=n>flag_</span><span class=p>;</span>
</span><span id=__span-35-28><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-36-1><span class=k>class</span><span class=w> </span><span class=nc>SpinningLock</span>
</span><span id=__span-36-2><span class=p>{</span>
</span><span id=__span-36-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-36-4><span class=w>    </span><span class=n>SpinningLock</span><span class=p>()</span>
</span><span id=__span-36-5><span class=w>    </span><span class=p>{</span><span class=w> </span><span class=p>}</span>
</span><span id=__span-36-6>
</span><span id=__span-36-7><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>lock</span><span class=p>()</span>
</span><span id=__span-36-8><span class=w>    </span><span class=p>{</span>
</span><span id=__span-36-9><span class=w>        </span><span class=c1>// test_and_set会将flag设为true并持续返回true</span>
</span><span id=__span-36-10><span class=w>        </span><span class=c1>// 除非调用clear</span>
</span><span id=__span-36-11><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>flag_</span><span class=p>.</span><span class=n>test_and_set</span><span class=p>())</span>
</span><span id=__span-36-12><span class=w>        </span><span class=p>{</span>
</span><span id=__span-36-13><span class=w>        </span><span class=p>}</span>
</span><span id=__span-36-14><span class=w>    </span><span class=p>}</span>
</span><span id=__span-36-15>
</span><span id=__span-36-16><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>unlock</span><span class=p>()</span>
</span><span id=__span-36-17><span class=w>    </span><span class=p>{</span>
</span><span id=__span-36-18><span class=w>        </span><span class=n>flag_</span><span class=p>.</span><span class=n>clear</span><span class=p>();</span>
</span><span id=__span-36-19><span class=w>    </span><span class=p>}</span>
</span><span id=__span-36-20>
</span><span id=__span-36-21><span class=k>private</span><span class=o>:</span>
</span><span id=__span-36-22><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>atomic_flag</span><span class=w> </span><span class=n>flag_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ATOMIC_FLAG_INIT</span><span class=p>;</span>
</span><span id=__span-36-23><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <h4 id=_9>其他辅助函数<a class=headerlink href=#_9 title="Permanent link">&para;</a></h4> <p>这些函数提供了对原子操作的支持，例如等待和通知机制（C++20 引入）</p> <table> <thead> <tr> <th>函数名</th> <th>功能描述</th> </tr> </thead> <tbody> <tr> <td><code>wait(T old, memory_order order = memory_order_seq_cst)</code></td> <td>（C++20）等待原子变量的值变为指定值</td> </tr> <tr> <td><code>notify_one()</code></td> <td>（C++20）唤醒一个等待该原子变量的线程</td> </tr> <tr> <td><code>notify_all()</code></td> <td>（C++20）唤醒所有等待该原子变量的线程</td> </tr> </tbody> </table> <h4 id=_10>特殊操作（适用于整数和指针类型）<a class=headerlink href=#_10 title="Permanent link">&para;</a></h4> <p>这些操作是针对整数类型的原子变量提供的额外功能</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>C++20后这些操作可以支持浮点数，而不仅限于整数和指针</p> </div> <table> <thead> <tr> <th>函数名</th> <th>功能描述</th> </tr> </thead> <tbody> <tr> <td><code>operator++</code> 和 <code>operator--</code></td> <td>原子递增或递减操作（前置和后置形式）。</td> </tr> <tr> <td><code>operator+=</code> 和 <code>operator-=</code></td> <td>原子加法或减法操作，并返回操作后的值。</td> </tr> <tr> <td><code>operator&amp;=</code>、<code>operator=</code> 和 <code>operator^=</code></td> <td>原子按位与、或、异或操作，并返回操作后的值。</td> </tr> </tbody> </table> <h2 id=condition_variable>条件变量库<code>&lt;condition_variable&gt;</code><a class=headerlink href=#condition_variable title="Permanent link">&para;</a></h2> <p>条件变量是C++11并发编程中的一种同步机制，用于线程间通信。它允许一个或多个线程等待某个条件满足后再继续执行。条件变量库主要包含在<code>&lt;condition_variable&gt;</code>头文件中</p> <h3 id=_11>条件变量类<a class=headerlink href=#_11 title="Permanent link">&para;</a></h3> <table> <thead> <tr> <th>类型</th> <th>描述</th> </tr> </thead> <tbody> <tr> <td><code>std::condition_variable</code></td> <td>标准条件变量，只能与<code>std::unique_lock</code>配合使用</td> </tr> <tr> <td><code>std::condition_variable_any</code></td> <td>更灵活的条件变量，可与任何满足基本锁要求的互斥量配合使用</td> </tr> </tbody> </table> <h3 id=_12>核心操作<a class=headerlink href=#_12 title="Permanent link">&para;</a></h3> <table> <thead> <tr> <th>操作</th> <th>描述</th> </tr> </thead> <tbody> <tr> <td><code>wait()</code></td> <td>等待条件满足，可能出现虚假唤醒</td> </tr> <tr> <td><code>wait_for()</code></td> <td>等待条件满足，但最多等待指定时间</td> </tr> <tr> <td><code>wait_until()</code></td> <td>等待条件满足，直到指定时间点</td> </tr> <tr> <td><code>notify_one()</code></td> <td>唤醒一个等待的线程</td> </tr> <tr> <td><code>notify_all()</code></td> <td>唤醒所有等待的线程</td> </tr> </tbody> </table> <p>需要注意的是，在标准库的实现中，<code>wait</code>系列接口除了传递一个<code>std::unique_lock</code>对象外，还可以传递一个谓词（<code>predicate</code>），这个谓词是一个可调用对象，用于检查条件是否满足，这种版本的<code>wait</code>接口执行可以类似于下面的情况：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-37-1><span class=k>while</span><span class=p>(</span><span class=o>!</span><span class=n>predicate</span><span class=p>())</span>
</span><span id=__span-37-2><span class=w>    </span><span class=n>wait</span><span class=p>(</span><span class=n>lock</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>通常建议使用带谓词的<code>wait</code>接口，因为这样可以避免伪唤醒的问题，当然如果使用不带谓词的<code>wait</code>接口就需要自己处理虚假唤醒</p> <h3 id=_13>基本使用模式<a class=headerlink href=#_13 title="Permanent link">&para;</a></h3> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span>
<span class=normal>59</span>
<span class=normal>60</span>
<span class=normal>61</span>
<span class=normal>62</span>
<span class=normal>63</span>
<span class=normal>64</span>
<span class=normal>65</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-38-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;condition_variable&gt;</span>
</span><span id=__span-38-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;mutex&gt;</span>
</span><span id=__span-38-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;thread&gt;</span>
</span><span id=__span-38-4><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-38-5><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;queue&gt;</span>
</span><span id=__span-38-6>
</span><span id=__span-38-7><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>mtx</span><span class=p>;</span>
</span><span id=__span-38-8><span class=n>std</span><span class=o>::</span><span class=n>condition_variable</span><span class=w> </span><span class=n>cv</span><span class=p>;</span>
</span><span id=__span-38-9><span class=n>std</span><span class=o>::</span><span class=n>queue</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>data_queue</span><span class=p>;</span>
</span><span id=__span-38-10><span class=kt>bool</span><span class=w> </span><span class=n>finished</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-38-11>
</span><span id=__span-38-12><span class=kt>void</span><span class=w> </span><span class=nf>producer</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-38-13><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-38-14><span class=w>    </span><span class=p>{</span>
</span><span id=__span-38-15><span class=w>        </span><span class=p>{</span>
</span><span id=__span-38-16><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>lock_guard</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock</span><span class=p>(</span><span class=n>mtx</span><span class=p>);</span>
</span><span id=__span-38-17><span class=w>            </span><span class=n>data_queue</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span><span id=__span-38-18><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;生产者: 插入数据 &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-38-19><span class=w>        </span><span class=p>}</span>
</span><span id=__span-38-20><span class=w>        </span><span class=n>cv</span><span class=p>.</span><span class=n>notify_one</span><span class=p>();</span><span class=w> </span><span class=c1>// 通知一个等待的消费者</span>
</span><span id=__span-38-21><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>milliseconds</span><span class=p>(</span><span class=mi>200</span><span class=p>));</span>
</span><span id=__span-38-22><span class=w>    </span><span class=p>}</span>
</span><span id=__span-38-23>
</span><span id=__span-38-24><span class=w>    </span><span class=p>{</span>
</span><span id=__span-38-25><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>lock_guard</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock</span><span class=p>(</span><span class=n>mtx</span><span class=p>);</span>
</span><span id=__span-38-26><span class=w>        </span><span class=n>finished</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-38-27><span class=w>    </span><span class=p>}</span>
</span><span id=__span-38-28><span class=w>    </span><span class=n>cv</span><span class=p>.</span><span class=n>notify_all</span><span class=p>();</span><span class=w> </span><span class=c1>// 通知所有等待的消费者已经完成</span>
</span><span id=__span-38-29><span class=p>}</span>
</span><span id=__span-38-30>
</span><span id=__span-38-31><span class=kt>void</span><span class=w> </span><span class=nf>consumer</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-38-32><span class=p>{</span>
</span><span id=__span-38-33><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-38-34><span class=w>    </span><span class=p>{</span>
</span><span id=__span-38-35><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock</span><span class=p>(</span><span class=n>mtx</span><span class=p>);</span>
</span><span id=__span-38-36>
</span><span id=__span-38-37><span class=w>        </span><span class=c1>// 等待条件满足：队列非空或生产结束</span>
</span><span id=__span-38-38><span class=w>        </span><span class=n>cv</span><span class=p>.</span><span class=n>wait</span><span class=p>(</span><span class=n>lock</span><span class=p>,</span><span class=w> </span><span class=p>[]</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=o>!</span><span class=n>data_queue</span><span class=p>.</span><span class=n>empty</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>finished</span><span class=p>;</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-38-39>
</span><span id=__span-38-40><span class=w>        </span><span class=c1>// 检查是否结束且队列为空</span>
</span><span id=__span-38-41><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>finished</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>data_queue</span><span class=p>.</span><span class=n>empty</span><span class=p>())</span><span class=w> </span>
</span><span id=__span-38-42><span class=w>        </span><span class=p>{</span>
</span><span id=__span-38-43><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;消费者 &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;: 生产者已完成，退出&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-38-44><span class=w>            </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-38-45><span class=w>        </span><span class=p>}</span>
</span><span id=__span-38-46>
</span><span id=__span-38-47><span class=w>        </span><span class=c1>// 处理数据</span>
</span><span id=__span-38-48><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data_queue</span><span class=p>.</span><span class=n>front</span><span class=p>();</span>
</span><span id=__span-38-49><span class=w>        </span><span class=n>data_queue</span><span class=p>.</span><span class=n>pop</span><span class=p>();</span>
</span><span id=__span-38-50><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;消费者 &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;: 处理数据 &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-38-51><span class=w>    </span><span class=p>}</span>
</span><span id=__span-38-52><span class=p>}</span>
</span><span id=__span-38-53>
</span><span id=__span-38-54><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-38-55><span class=p>{</span>
</span><span id=__span-38-56><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>prod</span><span class=p>(</span><span class=n>producer</span><span class=p>);</span>
</span><span id=__span-38-57><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>cons1</span><span class=p>(</span><span class=n>consumer</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-38-58><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>cons2</span><span class=p>(</span><span class=n>consumer</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>);</span>
</span><span id=__span-38-59>
</span><span id=__span-38-60><span class=w>    </span><span class=n>prod</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-38-61><span class=w>    </span><span class=n>cons1</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-38-62><span class=w>    </span><span class=n>cons2</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-38-63>
</span><span id=__span-38-64><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-38-65><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>参考输出：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-39-1>生产者: 插入数据 1
</span><span id=__span-39-2>消费者 1: 处理数据 1
</span><span id=__span-39-3>生产者: 插入数据 2
</span><span id=__span-39-4>消费者 1: 处理数据 2
</span><span id=__span-39-5>生产者: 插入数据 3
</span><span id=__span-39-6>消费者 2: 处理数据 3
</span><span id=__span-39-7>生产者: 插入数据 4
</span><span id=__span-39-8>消费者 1: 处理数据 4
</span><span id=__span-39-9>生产者: 插入数据 5
</span><span id=__span-39-10>消费者 2: 处理数据 5
</span><span id=__span-39-11>生产者: 插入数据 6
</span><span id=__span-39-12>消费者 1: 处理数据 6
</span><span id=__span-39-13>生产者: 插入数据 7
</span><span id=__span-39-14>消费者 2: 处理数据 7
</span><span id=__span-39-15>生产者: 插入数据 8
</span><span id=__span-39-16>消费者 1: 处理数据 8
</span><span id=__span-39-17>生产者: 插入数据 9
</span><span id=__span-39-18>消费者 2: 处理数据 9
</span><span id=__span-39-19>生产者: 插入数据 10
</span><span id=__span-39-20>消费者 1: 处理数据 10
</span><span id=__span-39-21>消费者 1: 生产者已完成，退出
</span><span id=__span-39-22>消费者 2: 生产者已完成，退出
</span></code></pre></div></td></tr></table></div> <h3 id=_14>案例：实现奇数偶数交替打印<a class=headerlink href=#_14 title="Permanent link">&para;</a></h3> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-40-1><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>mtx</span><span class=p>;</span>
</span><span id=__span-40-2><span class=n>std</span><span class=o>::</span><span class=n>condition_variable</span><span class=w> </span><span class=n>con</span><span class=p>;</span>
</span><span id=__span-40-3><span class=kt>bool</span><span class=w> </span><span class=n>flag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-40-4>
</span><span id=__span-40-5><span class=kt>void</span><span class=w> </span><span class=nf>printOdd</span><span class=p>()</span>
</span><span id=__span-40-6><span class=p>{</span>
</span><span id=__span-40-7><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>100</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>2</span><span class=p>)</span>
</span><span id=__span-40-8><span class=w>    </span><span class=p>{</span>
</span><span id=__span-40-9><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock</span><span class=p>(</span><span class=n>mtx</span><span class=p>);</span>
</span><span id=__span-40-10><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>flag</span><span class=p>)</span>
</span><span id=__span-40-11><span class=w>            </span><span class=n>con</span><span class=p>.</span><span class=n>wait</span><span class=p>(</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-40-12>
</span><span id=__span-40-13><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; &quot;</span><span class=p>;</span>
</span><span id=__span-40-14>
</span><span id=__span-40-15><span class=w>        </span><span class=n>flag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-40-16><span class=w>        </span><span class=n>con</span><span class=p>.</span><span class=n>notify_one</span><span class=p>();</span>
</span><span id=__span-40-17><span class=w>    </span><span class=p>}</span>
</span><span id=__span-40-18><span class=p>}</span>
</span><span id=__span-40-19>
</span><span id=__span-40-20><span class=kt>void</span><span class=w> </span><span class=nf>printEven</span><span class=p>()</span>
</span><span id=__span-40-21><span class=p>{</span>
</span><span id=__span-40-22><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>100</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>2</span><span class=p>)</span>
</span><span id=__span-40-23><span class=w>    </span><span class=p>{</span>
</span><span id=__span-40-24><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock</span><span class=p>(</span><span class=n>mtx</span><span class=p>);</span>
</span><span id=__span-40-25><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>flag</span><span class=p>)</span>
</span><span id=__span-40-26><span class=w>            </span><span class=n>con</span><span class=p>.</span><span class=n>wait</span><span class=p>(</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-40-27>
</span><span id=__span-40-28><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; &quot;</span><span class=p>;</span>
</span><span id=__span-40-29>
</span><span id=__span-40-30><span class=w>        </span><span class=n>flag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-40-31><span class=w>        </span><span class=n>con</span><span class=p>.</span><span class=n>notify_one</span><span class=p>();</span>
</span><span id=__span-40-32><span class=w>    </span><span class=p>}</span>
</span><span id=__span-40-33><span class=p>}</span>
</span><span id=__span-40-34>
</span><span id=__span-40-35><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-40-36><span class=p>{</span>
</span><span id=__span-40-37><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t1</span><span class=p>(</span><span class=n>printOdd</span><span class=p>);</span>
</span><span id=__span-40-38><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t2</span><span class=p>(</span><span class=n>printEven</span><span class=p>);</span>
</span><span id=__span-40-39>
</span><span id=__span-40-40><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-40-41><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-40-42>
</span><span id=__span-40-43><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-40-44><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>上面的代码执行流程如下：</p> <p><code>flag</code>初始化为<code>false</code>，如果<code>t1</code>先执行，那么此时会进入<code>printOdd</code>函数的循环体内部从而在<code>lock</code>上进行等待，此时<code>t2</code>线程开始执行，因为<code>flag</code>为<code>false</code>，所以不会进入循环体，接下来打印当前的<code>i</code>再将<code>flag</code>修改为<code>true</code>并唤醒在当前<code>lock</code>下等待的另外一个线程，此时因为<code>flag</code>为<code>true</code>，如果又是<code>t2</code>执行（尽管<code>t1</code>被唤醒，但是<code>t1</code>依旧需要和<code>t2</code>继续抢锁），那么此时<code>t2</code>会因为<code>flag</code>为<code>true</code>导致进入条件变量下等待被唤醒，此时<code>t1</code>执行打印出当前的<code>i</code></p> <p>如果<code>t2</code>先执行，就是正常的初始执行顺序</p> <p>输出结果如下：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-41-1>0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99
</span></code></pre></div></td></tr></table></div> <h2 id=future>异步操作库<code>&lt;future&gt;</code><a class=headerlink href=#future title="Permanent link">&para;</a></h2> <h3 id=_15>基本概念<a class=headerlink href=#_15 title="Permanent link">&para;</a></h3> <p>传统的编程模式通常是顺序执行的，即一个任务完成后才会开始下一个任务。这种模式在处理一些耗时操作（如文件读写、网络请求等）时会导致程序阻塞，降低了程序的响应性。而异步编程允许程序在执行某个耗时任务时，不等待该任务完成，而是继续执行后续的代码。当异步任务完成后，会通过某种机制通知程序获取结果，从而提高程序的并发性能</p> <h3 id=_16>主要组件<a class=headerlink href=#_16 title="Permanent link">&para;</a></h3> <p><code>std::future</code>库主要由三个核心组件构成：<code>std::future</code>、<code>std::promise</code>和<code>std::packaged_task</code>。它们相互协作，为异步编程提供了强大的支持，三者的介绍如下：</p> <ul> <li><strong><code>std::future</code></strong>：表示一个异步操作的结果。它提供了一种机制，让我们可以在异步任务完成后获取其返回值。<code>std::future</code>对象可以通过 <code>std::async</code>、<code>std::promise</code> 或<code>std::packaged_task</code>来创建</li> <li><strong><code>std::promise</code></strong>：用于设置异步操作的结果。它可以与一个<code>std::future</code>对象关联，当<code>std::promise</code>设置了结果后，与之关联的<code>std::future</code>就可以获取这个结果</li> <li><strong><code>std::packaged_task</code></strong>：是一个可调用对象包装器，它将一个可调用对象（如函数、函数对象或lambda表达式）与一个<code>std::future</code>关联起来。当<code>std::packaged_task</code>被调用时，它会执行关联的可调用对象，并将结果存储在<code>std::future</code>中</li> </ul> <h3 id=stdfuture><code>std::future</code>的详细使用<a class=headerlink href=#stdfuture title="Permanent link">&para;</a></h3> <h4 id=stdasyncstdfuture>使用<code>std::async</code>创建<code>std::future</code><a class=headerlink href=#stdasyncstdfuture title="Permanent link">&para;</a></h4> <p><code>std::async</code>是一个函数模板，它可以异步地执行一个函数，并返回一个<code>std::future</code>对象。<code>std::async</code>有两种启动策略：</p> <ul> <li><strong><code>std::launch::async</code></strong>：立即启动一个新线程来执行指定的函数</li> <li><strong><code>std::launch::deferred</code></strong>：延迟执行，直到调用<code>std::future</code>的<code>get()</code>或<code>wait()</code>方法时才执行指定的函数</li> </ul> <p>下面是一个基本的示例：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-42-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-42-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;future&gt;</span>
</span><span id=__span-42-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;mutex&gt;</span>
</span><span id=__span-42-4>
</span><span id=__span-42-5><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>mtx</span><span class=p>;</span>
</span><span id=__span-42-6>
</span><span id=__span-42-7><span class=c1>// 一个简单的异步任务函数</span>
</span><span id=__span-42-8><span class=kt>int</span><span class=w> </span><span class=nf>asyncTask</span><span class=p>()</span>
</span><span id=__span-42-9><span class=p>{</span>
</span><span id=__span-42-10><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>seconds</span><span class=p>(</span><span class=mi>2</span><span class=p>));</span>
</span><span id=__span-42-11><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock</span><span class=p>(</span><span class=n>mtx</span><span class=p>);</span>
</span><span id=__span-42-12><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Async task is running on thread: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>get_id</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-42-13><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>42</span><span class=p>;</span>
</span><span id=__span-42-14><span class=p>}</span>
</span><span id=__span-42-15>
</span><span id=__span-42-16><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-42-17><span class=p>{</span>
</span><span id=__span-42-18><span class=w>    </span><span class=c1>// 使用 std::async 启动异步任务，采用 async 策略</span>
</span><span id=__span-42-19><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>future</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>resultAsync</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>async</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>launch</span><span class=o>::</span><span class=n>async</span><span class=p>,</span><span class=w> </span><span class=n>asyncTask</span><span class=p>);</span>
</span><span id=__span-42-20>
</span><span id=__span-42-21><span class=w>    </span><span class=c1>// 使用 std::async 启动异步任务，采用 deferred 策略，这种情况下只会在下面调用 get 时才会执行任务</span>
</span><span id=__span-42-22><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>future</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>resultDeferred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>async</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>launch</span><span class=o>::</span><span class=n>deferred</span><span class=p>,</span><span class=w> </span><span class=n>asyncTask</span><span class=p>);</span>
</span><span id=__span-42-23>
</span><span id=__span-42-24><span class=w>    </span><span class=p>{</span>
</span><span id=__span-42-25><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock</span><span class=p>(</span><span class=n>mtx</span><span class=p>);</span>
</span><span id=__span-42-26><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Main thread is doing other things on thread: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>get_id</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-42-27><span class=w>    </span><span class=p>}</span>
</span><span id=__span-42-28><span class=w>    </span><span class=c1>// 获取异步任务的结果</span>
</span><span id=__span-42-29><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>valueAsync</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>resultAsync</span><span class=p>.</span><span class=n>get</span><span class=p>();</span>
</span><span id=__span-42-30><span class=w>    </span><span class=p>{</span>
</span><span id=__span-42-31><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock</span><span class=p>(</span><span class=n>mtx</span><span class=p>);</span>
</span><span id=__span-42-32><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;The result of the async task is: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>valueAsync</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-42-33><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;=================&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-42-34><span class=w>    </span><span class=p>}</span>
</span><span id=__span-42-35><span class=w>    </span><span class=c1>// 由于是 deferred 策略，此时才会执行任务</span>
</span><span id=__span-42-36><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>valueDeferred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>resultDeferred</span><span class=p>.</span><span class=n>get</span><span class=p>();</span>
</span><span id=__span-42-37><span class=w>    </span><span class=p>{</span>
</span><span id=__span-42-38><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock</span><span class=p>(</span><span class=n>mtx</span><span class=p>);</span>
</span><span id=__span-42-39><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;The result of the deferred task is: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>valueDeferred</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-42-40><span class=w>    </span><span class=p>}</span>
</span><span id=__span-42-41>
</span><span id=__span-42-42><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-42-43><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>参考输出如下：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-43-1>Main thread is doing other things on thread: 33860
</span><span id=__span-43-2>Async task is running on thread: 21940
</span><span id=__span-43-3>The result of the async task is: 42
</span><span id=__span-43-4>=================
</span><span id=__span-43-5>Async task is running on thread: 33860
</span><span id=__span-43-6>The result of the deferred task is: 42
</span></code></pre></div></td></tr></table></div> <p>如果将上面的<code>std::launch::deferred</code>改为<code>std::launch::async</code>，那么参考输出结果如下：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-44-1>Main thread is doing other things on thread: 40456
</span><span id=__span-44-2>Async task is running on thread: 35448
</span><span id=__span-44-3>Async task is running on thread: 43272
</span><span id=__span-44-4>The result of the async task is: 42
</span><span id=__span-44-5>=================
</span><span id=__span-44-6>The result of the deferred task is: 42
</span></code></pre></div></td></tr></table></div> <p>从上面的输出可以看到，使用<code>deffered</code>策略时，任务在调用<code>get</code>时才开始执行，而使用<code>async</code>策略时，任务会立即在新线程中执行</p> <p>需要注意的是，<code>std::async</code>函数还有一个版本，即不需要程序员指定策略：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-45-1><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>class</span><span class=w> </span><span class=nc>Fn</span><span class=p>,</span><span class=w> </span><span class=k>class</span><span class=p>...</span><span class=w> </span><span class=n>Args</span><span class=o>&gt;</span>
</span><span id=__span-45-2><span class=w>  </span><span class=n>future</span><span class=o>&lt;</span><span class=k>typename</span><span class=w> </span><span class=nc>result_of</span><span class=o>&lt;</span><span class=n>Fn</span><span class=p>(</span><span class=n>Args</span><span class=p>...)</span><span class=o>&gt;::</span><span class=n>type</span><span class=o>&gt;</span>
</span><span id=__span-45-3><span class=w>    </span><span class=n>async</span><span class=w> </span><span class=p>(</span><span class=n>Fn</span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>fn</span><span class=p>,</span><span class=w> </span><span class=n>Args</span><span class=o>&amp;&amp;</span><span class=p>...</span><span class=w> </span><span class=n>args</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>这个版本的策略设置会根据操作系统和标准库的实现进行自动选择，建议还是使用指定策略的版本</p> <h4 id=stdfuture_1><code>std::future</code>的常用方法<a class=headerlink href=#stdfuture_1 title="Permanent link">&para;</a></h4> <ul> <li><strong><code>get()</code></strong>：获取异步操作的结果。如果异步操作还未完成，该方法会阻塞当前线程，直到结果可用。需要注意的是，<code>get()</code>方法只能调用一次，一旦调用，<code>std::future</code>对象就会处于无效状态，可以通过<code>std::future</code>对象的成员函数<code>valid</code>来判断当前<code>std::future</code>对象是否有效</li> <li><strong><code>wait()</code></strong>：等待异步操作完成，但不获取结果。该方法会阻塞当前线程，直到异步操作完成</li> <li><strong><code>wait_for()</code></strong>：等待指定的时间，如果在该时间内异步操作完成，则返回结果；否则返回一个表示超时的状态<code>std::future_status</code></li> <li><strong><code>wait_until()</code></strong>：等待到指定的时间点，如果在该时间点之前异步操作完成，则返回结果；否则返回一个表示超时的状态<code>std::future_status</code></li> </ul> <p>下面是一个使用<code>std::future</code>相关函数的示例：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-46-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-46-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;future&gt;</span>
</span><span id=__span-46-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;chrono&gt;</span>
</span><span id=__span-46-4>
</span><span id=__span-46-5><span class=kt>int</span><span class=w> </span><span class=nf>task</span><span class=p>()</span>
</span><span id=__span-46-6><span class=p>{</span>
</span><span id=__span-46-7><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>seconds</span><span class=p>(</span><span class=mi>2</span><span class=p>));</span>
</span><span id=__span-46-8><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>100</span><span class=p>;</span>
</span><span id=__span-46-9><span class=p>}</span>
</span><span id=__span-46-10>
</span><span id=__span-46-11><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-46-12><span class=p>{</span>
</span><span id=__span-46-13><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>future</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>async</span><span class=p>(</span><span class=n>task</span><span class=p>);</span>
</span><span id=__span-46-14>
</span><span id=__span-46-15><span class=w>    </span><span class=c1>// 先等待1秒</span>
</span><span id=__span-46-16><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>future_status</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=n>wait_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>seconds</span><span class=p>(</span><span class=mi>1</span><span class=p>));</span>
</span><span id=__span-46-17>
</span><span id=__span-46-18><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>future_status</span><span class=o>::</span><span class=n>ready</span><span class=p>)</span>
</span><span id=__span-46-19><span class=w>    </span><span class=p>{</span>
</span><span id=__span-46-20><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Task is ready. Result: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=n>get</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-46-21><span class=w>    </span><span class=p>}</span>
</span><span id=__span-46-22><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>future_status</span><span class=o>::</span><span class=n>timeout</span><span class=p>)</span>
</span><span id=__span-46-23><span class=w>    </span><span class=p>{</span>
</span><span id=__span-46-24><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Task is not ready yet.&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-46-25><span class=w>        </span><span class=c1>// 继续等待直到任务完成</span>
</span><span id=__span-46-26><span class=w>        </span><span class=n>f</span><span class=p>.</span><span class=n>wait</span><span class=p>();</span>
</span><span id=__span-46-27><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Task is now ready. Result: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=n>get</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-46-28><span class=w>    </span><span class=p>}</span>
</span><span id=__span-46-29>
</span><span id=__span-46-30><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-46-31><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>参考输出如下：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-47-1>Task is not ready yet.
</span><span id=__span-47-2>Task is now ready. Result: 100
</span></code></pre></div></td></tr></table></div> <h4 id=stdfuture_status><code>std::future_status</code>类型<a class=headerlink href=#stdfuture_status title="Permanent link">&para;</a></h4> <p><code>std::future_status</code>是一个枚举类类型，其原型如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-48-1><span class=k>enum</span><span class=w> </span><span class=k>class</span><span class=w> </span><span class=nc>future_status</span><span class=w> </span>
</span><span id=__span-48-2><span class=p>{</span>
</span><span id=__span-48-3><span class=w>    </span><span class=n>ready</span><span class=p>,</span>
</span><span id=__span-48-4><span class=w>    </span><span class=n>timeout</span><span class=p>,</span>
</span><span id=__span-48-5><span class=w>    </span><span class=n>deferred</span>
</span><span id=__span-48-6><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>这三种状态的说明如下：</p> <p><strong><code>std::future_status::ready</code></strong>：表示异步操作已经完成，结果已经准备好可以被获取</p> <p>当调用<code>std::future</code>的<code>wait_for()</code>或<code>wait_until()</code>方法时，如果在指定的时间内异步操作完成，那么这两个方法会返回<code>std::future_status::ready</code>。另外，当调用<code>wait()</code>方法时，由于该方法会阻塞直到异步操作完成，所以操作完成后，再调用<code>wait_for()</code>或<code>wait_until()</code>且异步操作仍处于完成状态时，也会返回<code>std::future_status::ready</code></p> <p>例如下面的代码：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-49-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-49-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;future&gt;</span>
</span><span id=__span-49-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;chrono&gt;</span>
</span><span id=__span-49-4>
</span><span id=__span-49-5><span class=kt>int</span><span class=w> </span><span class=nf>asyncTask</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-49-6><span class=p>{</span>
</span><span id=__span-49-7><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>seconds</span><span class=p>(</span><span class=mi>1</span><span class=p>));</span>
</span><span id=__span-49-8><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>42</span><span class=p>;</span>
</span><span id=__span-49-9><span class=p>}</span>
</span><span id=__span-49-10>
</span><span id=__span-49-11><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-49-12><span class=p>{</span>
</span><span id=__span-49-13><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>future</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>async</span><span class=p>(</span><span class=n>asyncTask</span><span class=p>);</span>
</span><span id=__span-49-14>
</span><span id=__span-49-15><span class=w>    </span><span class=c1>// 等待 2 秒，由于任务只需 1 秒，所以会返回 ready</span>
</span><span id=__span-49-16><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=n>wait_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>seconds</span><span class=p>(</span><span class=mi>2</span><span class=p>));</span>
</span><span id=__span-49-17><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>future_status</span><span class=o>::</span><span class=n>ready</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-49-18><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Task is ready. Result: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=n>get</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-49-19>
</span><span id=__span-49-20><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-49-21><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p><strong><code>std::future_status::timeout</code></strong>：表示在调用<code>std::future</code>的<code>wait_for()</code>或<code>wait_until()</code>方法时，指定的等待时间已经过去，但异步操作尚未完成</p> <p>当使用<code>wait_for()</code>方法并指定一个时间间隔，或者使用<code>wait_until()</code>方法并指定一个时间点，在这个时间间隔或时间点到达时，异步操作还没有完成，那么这两个方法会返回<code>std::future_status::timeout</code></p> <p>例如下面的代码：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-50-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-50-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;future&gt;</span>
</span><span id=__span-50-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;chrono&gt;</span>
</span><span id=__span-50-4>
</span><span id=__span-50-5><span class=kt>int</span><span class=w> </span><span class=nf>asyncTask</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-50-6><span class=p>{</span>
</span><span id=__span-50-7><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>seconds</span><span class=p>(</span><span class=mi>2</span><span class=p>));</span>
</span><span id=__span-50-8><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>42</span><span class=p>;</span>
</span><span id=__span-50-9><span class=p>}</span>
</span><span id=__span-50-10>
</span><span id=__span-50-11><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-50-12><span class=p>{</span>
</span><span id=__span-50-13><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>future</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>async</span><span class=p>(</span><span class=n>asyncTask</span><span class=p>);</span>
</span><span id=__span-50-14>
</span><span id=__span-50-15><span class=w>    </span><span class=c1>// 等待 1 秒，由于任务需要 2 秒，所以会返回 timeout</span>
</span><span id=__span-50-16><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=n>wait_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>seconds</span><span class=p>(</span><span class=mi>1</span><span class=p>));</span>
</span><span id=__span-50-17><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>future_status</span><span class=o>::</span><span class=n>timeout</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-50-18><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Task is not ready yet.&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-50-19>
</span><span id=__span-50-20><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-50-21><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p><strong><code>std::future_status::deferred</code></strong>：表示异步操作被延迟执行。当使用<code>std::async</code>并指定 <code>std::launch::deferred</code> 策略时，异步任务不会立即启动，而是会在调用<code>std::future</code>的<code>get()</code>或<code>wait()</code>方法时才会执行</p> <p>当使用<code>std::async</code>以<code>std::launch::deferred</code>策略启动一个异步任务，然后调用<code>std::future</code>的<code>wait_for()</code>或<code>wait_until()</code>方法时，无论等待时间是多少，都会返回<code>std::future_status::deferred</code></p> <p>例如下面的代码：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-51-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-51-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;future&gt;</span>
</span><span id=__span-51-3>
</span><span id=__span-51-4><span class=kt>int</span><span class=w> </span><span class=nf>asyncTask</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-51-5><span class=p>{</span>
</span><span id=__span-51-6><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>42</span><span class=p>;</span>
</span><span id=__span-51-7><span class=p>}</span>
</span><span id=__span-51-8>
</span><span id=__span-51-9><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-51-10><span class=p>{</span>
</span><span id=__span-51-11><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>future</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>async</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>launch</span><span class=o>::</span><span class=n>deferred</span><span class=p>,</span><span class=w> </span><span class=n>asyncTask</span><span class=p>);</span>
</span><span id=__span-51-12>
</span><span id=__span-51-13><span class=w>    </span><span class=c1>// 由于使用了 deferred 策略，会返回 deferred</span>
</span><span id=__span-51-14><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=n>wait_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>seconds</span><span class=p>(</span><span class=mi>0</span><span class=p>));</span>
</span><span id=__span-51-15><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>future_status</span><span class=o>::</span><span class=n>deferred</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-51-16><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Task is deferred.&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-51-17>
</span><span id=__span-51-18><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-51-19><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>但是，根据<code>deffered</code>策略的特点，一旦调用了<code>get</code>就会执行异步任务函数，此时异步任务就会返回结果，状态就应该会切换为<code>ready</code>，为了验证这一点，直接用<code>future</code>无法做到，因为当前的需求是调用<code>get</code>后查看<code>wait_for</code>的返回值，但是根据<code>future</code>中<code>get</code>函数的特点：一旦调用了<code>get</code>，那么当前的<code>future</code>就会失效。这里可以考虑使用<code>std::shared_future</code>来实现（关于<code>std::shared_future</code>在后面会提及，此处先了解），代码如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-52-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-52-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;future&gt;</span>
</span><span id=__span-52-3>
</span><span id=__span-52-4><span class=kt>int</span><span class=w> </span><span class=nf>asyncTask</span><span class=p>()</span>
</span><span id=__span-52-5><span class=p>{</span>
</span><span id=__span-52-6><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>42</span><span class=p>;</span>
</span><span id=__span-52-7><span class=p>}</span>
</span><span id=__span-52-8>
</span><span id=__span-52-9><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-52-10><span class=p>{</span>
</span><span id=__span-52-11><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>future</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>async</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>launch</span><span class=o>::</span><span class=n>deferred</span><span class=p>,</span><span class=w> </span><span class=n>asyncTask</span><span class=p>);</span>
</span><span id=__span-52-12>
</span><span id=__span-52-13><span class=w>    </span><span class=c1>// 由于使用了 deferred 策略，会返回 deferred</span>
</span><span id=__span-52-14><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=n>wait_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>seconds</span><span class=p>(</span><span class=mi>0</span><span class=p>));</span>
</span><span id=__span-52-15><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>future_status</span><span class=o>::</span><span class=n>deferred</span><span class=p>)</span>
</span><span id=__span-52-16><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Task is deferred.&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-52-17><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>shared_future</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>sf</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>f</span><span class=p>));</span>
</span><span id=__span-52-18><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sf</span><span class=p>.</span><span class=n>get</span><span class=p>();</span>
</span><span id=__span-52-19><span class=w>    </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sf</span><span class=p>.</span><span class=n>wait_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>seconds</span><span class=p>(</span><span class=mi>0</span><span class=p>));</span>
</span><span id=__span-52-20><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>status</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>future_status</span><span class=o>::</span><span class=n>ready</span><span class=p>)</span>
</span><span id=__span-52-21><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Task is ready：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-52-22>
</span><span id=__span-52-23><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-52-24><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>输出结果如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-53-1><span class=n>Task</span><span class=w> </span><span class=n>is</span><span class=w> </span><span class=n>deferred</span><span class=p>.</span>
</span><span id=__span-53-2><span class=n>Task</span><span class=w> </span><span class=n>is</span><span class=w> </span><span class=n>ready</span><span class=err>：</span><span class=mi>42</span>
</span></code></pre></div></td></tr></table></div> <h3 id=stdpromise><code>std::promise</code> 的介绍<a class=headerlink href=#stdpromise title="Permanent link">&para;</a></h3> <p><code>std::promise</code>用于设置异步操作的结果，它与<code>std::future</code>紧密配合。在<code>std::promise</code>中，有下面几种常见的函数：</p> <ul> <li><strong><code>get_future()</code></strong>：用于获取与<code>std::promise</code>关联的<code>std::future</code>对象。<code>std::future</code>对象可以用来获取异步操作的结果</li> <li><strong><code>set_value(T value)</code></strong>：用于设置<code>std::promise</code>的结果。一旦调用了<code>set_value</code>，与之关联的<code>std::future</code>就可以通过<code>get()</code>方法获取到这个结果</li> <li><strong><code>set_exception(std::exception_ptr ex)</code></strong>：用于设置<code>std::promise</code>的异常。一旦调用了<code>set_exception</code>，与之关联的<code>std::future</code>的<code>get()</code>方法就会抛出这个异常</li> <li><strong><code>set_value_at_thread_exit(T value)</code></strong>：用于设置<code>std::promise</code>的结果。与<code>set_value</code>不同的是，这个函数会在当前线程退出时设置结果</li> <li><strong><code>set_exception_at_thread_exit(std::exception_ptr ex)</code></strong>：用于设置<code>std::promise</code>的异常。与<code>set_exception</code>不同的是，这个函数会在当前线程退出时设置异常</li> <li><strong><code>swap(std::promise&amp; other)</code></strong>：用于交换两个<code>std::promise</code>对象的内容</li> <li><strong><code>operator=(promise&amp;&amp; other)</code></strong>：移动赋值操作符，用于将一个 std::promise 对象的状态移动到另一个对象，转移所有权，但是不支持复制赋值</li> </ul> <p>以下是一个使用 <code>std::promise</code> 的示例：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-54-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-54-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;future&gt;</span>
</span><span id=__span-54-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;thread&gt;</span>
</span><span id=__span-54-4>
</span><span id=__span-54-5><span class=c1>// 工作线程函数</span>
</span><span id=__span-54-6><span class=kt>void</span><span class=w> </span><span class=nf>worker</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>promise</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&amp;</span><span class=w> </span><span class=n>p</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-54-7><span class=p>{</span>
</span><span id=__span-54-8><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-54-9><span class=w>        </span><span class=c1>// 模拟一个耗时操作</span>
</span><span id=__span-54-10><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>seconds</span><span class=p>(</span><span class=mi>2</span><span class=p>));</span>
</span><span id=__span-54-11><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>200</span><span class=p>;</span>
</span><span id=__span-54-12><span class=w>        </span><span class=c1>// 设置 promise 的结果</span>
</span><span id=__span-54-13><span class=w>        </span><span class=n>p</span><span class=p>.</span><span class=n>set_value</span><span class=p>(</span><span class=n>result</span><span class=p>);</span>
</span><span id=__span-54-14><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(...)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-54-15><span class=w>        </span><span class=c1>// 如果发生异常，设置异常</span>
</span><span id=__span-54-16><span class=w>        </span><span class=n>p</span><span class=p>.</span><span class=n>set_exception</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>current_exception</span><span class=p>());</span>
</span><span id=__span-54-17><span class=w>    </span><span class=p>}</span>
</span><span id=__span-54-18><span class=p>}</span>
</span><span id=__span-54-19>
</span><span id=__span-54-20><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-54-21><span class=p>{</span>
</span><span id=__span-54-22><span class=w>    </span><span class=c1>// 创建一个 promise 对象</span>
</span><span id=__span-54-23><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>promise</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>p</span><span class=p>;</span>
</span><span id=__span-54-24><span class=w>    </span><span class=c1>// 获取与 promise 关联的 future 对象</span>
</span><span id=__span-54-25><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>future</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>get_future</span><span class=p>();</span>
</span><span id=__span-54-26>
</span><span id=__span-54-27><span class=w>    </span><span class=c1>// 启动一个新线程执行工作函数</span>
</span><span id=__span-54-28><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t</span><span class=p>(</span><span class=n>worker</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>ref</span><span class=p>(</span><span class=n>p</span><span class=p>));</span>
</span><span id=__span-54-29>
</span><span id=__span-54-30><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-54-31><span class=w>        </span><span class=c1>// 获取异步操作的结果</span>
</span><span id=__span-54-32><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=n>get</span><span class=p>();</span>
</span><span id=__span-54-33><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;The result from the promise is: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-54-34><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>exception</span><span class=o>&amp;</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-54-35><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Exception caught: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=n>what</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-54-36><span class=w>    </span><span class=p>}</span>
</span><span id=__span-54-37>
</span><span id=__span-54-38><span class=w>    </span><span class=c1>// 等待线程结束</span>
</span><span id=__span-54-39><span class=w>    </span><span class=n>t</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-54-40>
</span><span id=__span-54-41><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-54-42><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>关于<code>set_value</code>和<code>set_value_at_thread_exit</code>的区别：</p> <ul> <li><strong><code>set_value</code></strong>：当调用<code>set_value</code>时，<code>std::promise</code>会立即将结果设置到与之关联的<code>std::future</code>中，并且<code>std::future</code>的<code>get()</code>方法会立即返回结果。<strong>这意味着一旦调用了<code>set_value</code>，与之关联的<code>std::future</code>就可以立即获取到结果</strong></li> <li><strong><code>set_value_at_thread_exit</code></strong>：当调用<code>set_value_at_thread_exit</code>时，<code>std::promise</code>会在当前线程退出时将结果设置到与之关联的<code>std::future</code>中。<strong>这意味着<code>std::future</code>的<code>get()</code>方法在当前线程退出之前不会返回结果，而是会阻塞直到当前线程退出</strong></li> </ul> <p>例如下面两个例子：</p> <div class="tabbed-set tabbed-alternate" data-tabs=6:2><input checked=checked id=__tabbed_6_1 name=__tabbed_6 type=radio><input id=__tabbed_6_2 name=__tabbed_6 type=radio><div class=tabbed-labels><label for=__tabbed_6_1><code>set_value</code></label><label for=__tabbed_6_2><code>set_value_at_thread_exit</code></label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-55-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-55-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;future&gt;</span>
</span><span id=__span-55-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;thread&gt;</span>
</span><span id=__span-55-4>
</span><span id=__span-55-5><span class=kt>void</span><span class=w> </span><span class=nf>producer</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>promise</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>prom</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-55-6><span class=p>{</span>
</span><span id=__span-55-7><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;生产者线程开始...&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-55-8>
</span><span id=__span-55-9><span class=w>    </span><span class=c1>// 执行一些计算</span>
</span><span id=__span-55-10><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>seconds</span><span class=p>(</span><span class=mi>2</span><span class=p>));</span>
</span><span id=__span-55-11>
</span><span id=__span-55-12><span class=w>    </span><span class=c1>// 立即设置结果</span>
</span><span id=__span-55-13><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;生产者设置结果...&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-55-14><span class=w>    </span><span class=n>prom</span><span class=p>.</span><span class=n>set_value</span><span class=p>(</span><span class=mi>42</span><span class=p>);</span>
</span><span id=__span-55-15>
</span><span id=__span-55-16><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;生产者继续执行其他工作...&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-55-17><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>seconds</span><span class=p>(</span><span class=mi>2</span><span class=p>));</span>
</span><span id=__span-55-18><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;生产者线程结束&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-55-19><span class=p>}</span>
</span><span id=__span-55-20>
</span><span id=__span-55-21><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-55-22><span class=p>{</span>
</span><span id=__span-55-23><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>promise</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>prom</span><span class=p>;</span>
</span><span id=__span-55-24><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>future</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>fut</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>prom</span><span class=p>.</span><span class=n>get_future</span><span class=p>();</span>
</span><span id=__span-55-25>
</span><span id=__span-55-26><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;主线程启动生产者线程...&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-55-27><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t</span><span class=p>(</span><span class=n>producer</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>prom</span><span class=p>));</span>
</span><span id=__span-55-28>
</span><span id=__span-55-29><span class=w>    </span><span class=c1>// 等待结果</span>
</span><span id=__span-55-30><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;主线程等待结果...&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-55-31><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fut</span><span class=p>.</span><span class=n>get</span><span class=p>();</span><span class=w>  </span><span class=c1>// 一旦生产者调用set_value，这里就会立即返回</span>
</span><span id=__span-55-32><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;主线程获取到结果: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-55-33><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;注意：生产者线程可能仍在运行&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-55-34>
</span><span id=__span-55-35><span class=w>    </span><span class=n>t</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-55-36>
</span><span id=__span-55-37><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-55-38><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-56-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-56-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;future&gt;</span>
</span><span id=__span-56-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;thread&gt;</span>
</span><span id=__span-56-4>
</span><span id=__span-56-5><span class=kt>void</span><span class=w> </span><span class=nf>producer</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>promise</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>prom</span><span class=p>)</span>
</span><span id=__span-56-6><span class=p>{</span>
</span><span id=__span-56-7><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;生产者线程开始...&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-56-8>
</span><span id=__span-56-9><span class=w>    </span><span class=c1>// 执行一些计算</span>
</span><span id=__span-56-10><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>seconds</span><span class=p>(</span><span class=mi>2</span><span class=p>));</span>
</span><span id=__span-56-11>
</span><span id=__span-56-12><span class=w>    </span><span class=c1>// 设置结果，但在线程结束前不会生效</span>
</span><span id=__span-56-13><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;生产者设置线程退出时的结果...&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-56-14><span class=w>    </span><span class=n>prom</span><span class=p>.</span><span class=n>set_value_at_thread_exit</span><span class=p>(</span><span class=mi>42</span><span class=p>);</span>
</span><span id=__span-56-15>
</span><span id=__span-56-16><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;生产者继续执行其他工作...&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-56-17><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>seconds</span><span class=p>(</span><span class=mi>2</span><span class=p>));</span>
</span><span id=__span-56-18><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;生产者线程即将结束，结果才会被实际传递&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-56-19><span class=w>    </span><span class=c1>// 当函数返回时，线程结束，结果才会被设置</span>
</span><span id=__span-56-20><span class=p>}</span>
</span><span id=__span-56-21>
</span><span id=__span-56-22><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-56-23><span class=p>{</span>
</span><span id=__span-56-24><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>promise</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>prom</span><span class=p>;</span>
</span><span id=__span-56-25><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>future</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>fut</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>prom</span><span class=p>.</span><span class=n>get_future</span><span class=p>();</span>
</span><span id=__span-56-26>
</span><span id=__span-56-27><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;主线程启动生产者线程...&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-56-28><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t</span><span class=p>(</span><span class=n>producer</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>prom</span><span class=p>));</span>
</span><span id=__span-56-29>
</span><span id=__span-56-30><span class=w>    </span><span class=c1>// 等待结果</span>
</span><span id=__span-56-31><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;主线程等待结果...&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-56-32><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fut</span><span class=p>.</span><span class=n>get</span><span class=p>();</span><span class=w> </span><span class=c1>// 会阻塞直到生产者线程完全结束</span>
</span><span id=__span-56-33><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;主线程获取到结果: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-56-34><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;此时生产者线程已经结束&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-56-35>
</span><span id=__span-56-36><span class=w>    </span><span class=n>t</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-56-37>
</span><span id=__span-56-38><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-56-39><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>输出结果分别如下：</p> <div class="tabbed-set tabbed-alternate" data-tabs=7:2><input checked=checked id=__tabbed_7_1 name=__tabbed_7 type=radio><input id=__tabbed_7_2 name=__tabbed_7 type=radio><div class=tabbed-labels><label for=__tabbed_7_1><code>set_value</code></label><label for=__tabbed_7_2><code>set_value_at_thread_exit</code></label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-57-1><span class=n>主线程启动生产者线程</span><span class=p>...</span>
</span><span id=__span-57-2><span class=n>主线程等待结果</span><span class=p>...</span>
</span><span id=__span-57-3><span class=n>生产者线程开始</span><span class=p>...</span>
</span><span id=__span-57-4><span class=n>生产者设置结果</span><span class=p>...</span>
</span><span id=__span-57-5><span class=n>生产者继续执行其他工作</span><span class=p>...</span>
</span><span id=__span-57-6><span class=nl>主线程获取到结果</span><span class=p>:</span><span class=w> </span><span class=mi>42</span>
</span><span id=__span-57-7><span class=n>注意</span><span class=err>：</span><span class=n>生产者线程可能仍在运行</span>
</span><span id=__span-57-8><span class=n>生产者线程结束</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-58-1><span class=n>主线程启动生产者线程</span><span class=p>...</span>
</span><span id=__span-58-2><span class=n>主线程等待结果</span><span class=p>...</span>
</span><span id=__span-58-3><span class=n>生产者线程开始</span><span class=p>...</span>
</span><span id=__span-58-4><span class=n>生产者设置线程退出时的结果</span><span class=p>...</span>
</span><span id=__span-58-5><span class=n>生产者继续执行其他工作</span><span class=p>...</span>
</span><span id=__span-58-6><span class=n>生产者线程即将结束</span><span class=err>，</span><span class=n>结果才会被实际传递</span>
</span><span id=__span-58-7><span class=nl>主线程获取到结果</span><span class=p>:</span><span class=w> </span><span class=mi>42</span>
</span><span id=__span-58-8><span class=n>此时生产者线程已经结束</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>需要注意，如果在Visual Studio中使用<code>set_value_at_thread_exit</code>，可能会出现程序崩溃，可以考虑使用引用的方式传递<code>std::promise</code>对象：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-59-1><span class=c1>// ...</span>
</span><span id=__span-59-2>
</span><span id=__span-59-3><span class=kt>void</span><span class=w> </span><span class=nf>producer</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>promise</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=o>&amp;</span><span class=n>prom</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-59-4><span class=p>{</span>
</span><span id=__span-59-5><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-59-6><span class=p>}</span>
</span><span id=__span-59-7>
</span><span id=__span-59-8><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-59-9><span class=p>{</span>
</span><span id=__span-59-10><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>promise</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>prom</span><span class=p>;</span>
</span><span id=__span-59-11><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>future</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>fut</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>prom</span><span class=p>.</span><span class=n>get_future</span><span class=p>();</span>
</span><span id=__span-59-12>
</span><span id=__span-59-13><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;主线程启动生产者线程...&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-59-14><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t</span><span class=p>(</span><span class=n>producer</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>ref</span><span class=p>(</span><span class=n>prom</span><span class=p>));</span>
</span><span id=__span-59-15>
</span><span id=__span-59-16><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-59-17><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h3 id=stdpackaged_task><code>std::packaged_task</code>的介绍<a class=headerlink href=#stdpackaged_task title="Permanent link">&para;</a></h3> <p><code>std::packaged_task</code>可以将一个可调用对象与一个<code>std::future</code>关联起来。常见函数如下：</p> <ul> <li><strong><code>get_future()</code></strong>：返回一个与<code>std::packaged_task</code>关联的<code>std::future</code>对象。借助该<code>std::future</code>对象，其他线程能够获取<code>std::packaged_task</code>执行后的结果</li> <li><strong><code>operator()</code></strong>：调用<code>std::packaged_task</code>所封装的可调用对象，并且把结果存储在与之关联的<code>std::future</code>对象里</li> <li><strong><code>valid()</code></strong>：检查<code>std::packaged_task</code>是否与一个有效的可调用对象相关联。若关联则返回<code>true</code>，反之返回<code>false</code></li> <li><strong><code>reset()</code></strong>：重置<code>std::packaged_task</code>对象，让它能够再次被调用。重置后，它会和一个新的未完成状态的<code>std::future</code>关联</li> <li><strong><code>swap()</code></strong>：交换两个<code>std::packaged_task</code>对象的状态</li> </ul> <p>以下是一个使用<code>std::packaged_task</code>的示例：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-60-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-60-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;future&gt;</span>
</span><span id=__span-60-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;thread&gt;</span>
</span><span id=__span-60-4>
</span><span id=__span-60-5><span class=c1>// 一个简单的任务函数</span>
</span><span id=__span-60-6><span class=kt>int</span><span class=w> </span><span class=nf>taskFunction</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>b</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-60-7><span class=p>{</span>
</span><span id=__span-60-8><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>b</span><span class=p>;</span>
</span><span id=__span-60-9><span class=p>}</span>
</span><span id=__span-60-10>
</span><span id=__span-60-11><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-60-12><span class=p>{</span>
</span><span id=__span-60-13><span class=w>    </span><span class=c1>// 创建一个 packaged_task 对象</span>
</span><span id=__span-60-14><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>packaged_task</span><span class=o>&lt;</span><span class=kt>int</span><span class=p>(</span><span class=kt>int</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=o>&gt;</span><span class=w> </span><span class=n>task</span><span class=p>(</span><span class=n>taskFunction</span><span class=p>);</span>
</span><span id=__span-60-15>
</span><span id=__span-60-16><span class=w>    </span><span class=c1>// 获取与 packaged_task 关联的 future 对象</span>
</span><span id=__span-60-17><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>future</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>task</span><span class=p>.</span><span class=n>get_future</span><span class=p>();</span>
</span><span id=__span-60-18>
</span><span id=__span-60-19><span class=w>    </span><span class=c1>// 启动一个新线程执行 packaged_task</span>
</span><span id=__span-60-20><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>task</span><span class=p>),</span><span class=w> </span><span class=mi>3</span><span class=p>,</span><span class=w> </span><span class=mi>5</span><span class=p>);</span>
</span><span id=__span-60-21>
</span><span id=__span-60-22><span class=w>    </span><span class=c1>// 获取异步操作的结果</span>
</span><span id=__span-60-23><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=n>get</span><span class=p>();</span>
</span><span id=__span-60-24><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;The result of the task is: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-60-25>
</span><span id=__span-60-26><span class=w>    </span><span class=c1>// 等待线程结束</span>
</span><span id=__span-60-27><span class=w>    </span><span class=n>t</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-60-28>
</span><span id=__span-60-29><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-60-30><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>从上面的例子可以看出，实际上<code>std::packaged_task</code>+<code>std::thread</code>可以理解为<code>std::async</code>的一种底层实现方式</p> <h3 id=futurepromiseasyncpackaged_task><code>future</code>、<code>promise</code>、<code>async</code>和<code>packaged_task</code>之间的关系和区别<a class=headerlink href=#futurepromiseasyncpackaged_task title="Permanent link">&para;</a></h3> <table> <thead> <tr> <th>组件</th> <th>与其他组件的关系</th> <th>区别</th> </tr> </thead> <tbody> <tr> <td><code>std::promise</code></td> <td>可通过<code>get_future()</code>方法创建<code>std::future</code>对象，将结果设置给<code>std::promise</code>后，与之关联的<code>std::future</code>能获取结果，可在新线程里为<code>std::promise</code>设置结果，与<code>std::async</code>一样用于实现异步操作</td> <td>重点在于设置结果，自身不直接执行任务，要搭配线程或其他可执行体来完成任务，所以灵活性高，能自定义任务执行逻辑</td> </tr> <tr> <td><code>std::async</code></td> <td>调用后返回<code>std::future</code>对象，借助该对象获取异步任务结果，内部或许会运用<code>std::promise</code>和<code>std::packaged_task</code>来实现异步操作</td> <td>简化异步任务启动流程，可快速让任务异步执行，提供<code>std::launch::async</code>和<code>std::launch::deferred</code>两种启动策略</td> </tr> <tr> <td><code>std::future</code></td> <td>可由<code>std::promise</code>的<code>get_future()</code>方法、<code>std::async</code>函数、<code>std::packaged_task</code>的<code>get_future()</code>方法创建，作为获取异步操作结果的接口，与<code>std::promise</code>、<code>std::async</code>、<code>std::packaged_task</code>协同工作</td> <td>主要用于获取结果，不负责任务执行和结果设置，提供<code>get()</code>、<code>wait()</code>、<code>wait_for()</code>、<code>wait_until()</code>等方法来管理异步操作状态</td> </tr> <tr> <td><code>std::packaged_task</code></td> <td>关联一个可调用对象与<code>std::future</code>，调用<code>std::packaged_task</code>时，会执行关联的可调用对象并把结果存于<code>std::future</code>中，可像普通可调用对象那样在线程里执行，类似<code>std::async</code>能执行任务</td> <td>强调将可调用对象封装成异步任务，需手动管理线程和执行，能复用可调用对象，多次调用<code>std::packaged_task</code>可执行多次任务</td> </tr> </tbody> </table> <h3 id=stdshared_future><code>std::shared_future</code>的介绍<a class=headerlink href=#stdshared_future title="Permanent link">&para;</a></h3> <p><code>std::shared_future</code>是C++11标准库中用于异步编程的一个模板类，它是<code>std::future</code>的扩展版本。在<code>std::future</code>中，<code>get()</code>方法只能被调用一次，调用后<code>std::future</code>对象就会处于无效状态，这意味着<code>std::future</code>不支持多个线程同时访问异步操作的结果。而<code>std::shared_future</code>则允许将异步操作的结果共享给多个线程，多个线程可以同时或先后调用<code>get()</code>方法来获取结果</p> <h4 id=stdshared_future_1>创建<code>std::shared_future</code><a class=headerlink href=#stdshared_future_1 title="Permanent link">&para;</a></h4> <p><code>std::shared_future</code>通常由<code>std::future</code>转换而来。可以通过调用<code>std::future</code>的<code>share()</code>方法来创建一个<code>std::shared_future</code>对象。以下是一个简单的示例：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-61-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-61-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;future&gt;</span>
</span><span id=__span-61-3>
</span><span id=__span-61-4><span class=kt>int</span><span class=w> </span><span class=nf>asyncTask</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-61-5><span class=p>{</span>
</span><span id=__span-61-6><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>42</span><span class=p>;</span>
</span><span id=__span-61-7><span class=p>}</span>
</span><span id=__span-61-8>
</span><span id=__span-61-9><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-61-10><span class=p>{</span>
</span><span id=__span-61-11><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>future</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>async</span><span class=p>(</span><span class=n>asyncTask</span><span class=p>);</span>
</span><span id=__span-61-12><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>shared_future</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>sf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=n>share</span><span class=p>();</span>
</span><span id=__span-61-13>
</span><span id=__span-61-14><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Result from shared_future: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>sf</span><span class=p>.</span><span class=n>get</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-61-15><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-61-16><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>除了通过<code>share()</code>方法获取到<code>shared_future</code>对象外，也可以通过直接构造函数来创建<code>std::shared_future</code>对象：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-62-1><span class=c1>// 构造一个空的shared_future对象</span>
</span><span id=__span-62-2><span class=n>std</span><span class=o>::</span><span class=n>shared_future</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>sf</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> <h4 id=stdshared_future_2><code>std::shared_future</code>的常用方法<a class=headerlink href=#stdshared_future_2 title="Permanent link">&para;</a></h4> <p><code>std::shared_future</code> 提供了与<code>std::future</code>类似的方法，用于获取异步操作的结果和管理状态：</p> <ul> <li><strong><code>get()</code></strong>：获取异步操作的结果。与<code>std::future</code>不同的是，<code>std::shared_future</code>的<code>get()</code>方法可以被多次调用，每次调用都会返回相同的结果</li> <li><strong><code>wait()</code></strong>：等待异步操作完成，但不获取结果</li> <li><strong><code>wait_for()</code></strong>：等待指定的时间，如果在该时间内异步操作完成，则返回结果；否则返回一个表示超时的状态</li> <li><strong><code>wait_until()</code></strong>：等待到指定的时间点，如果在该时间点之前异步操作完成，则返回结果；否则返回一个表示超时的状态</li> </ul> <h4 id=_17>多线程共享结果示例<a class=headerlink href=#_17 title="Permanent link">&para;</a></h4> <p>下面的示例展示了如何在多个线程中共享<code>std::shared_future</code>的结果：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-63-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-63-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;future&gt;</span>
</span><span id=__span-63-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;thread&gt;</span>
</span><span id=__span-63-4>
</span><span id=__span-63-5><span class=kt>int</span><span class=w> </span><span class=nf>asyncTask</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-63-6><span class=p>{</span>
</span><span id=__span-63-7><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>100</span><span class=p>;</span>
</span><span id=__span-63-8><span class=p>}</span>
</span><span id=__span-63-9>
</span><span id=__span-63-10><span class=kt>void</span><span class=w> </span><span class=nf>printResult</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>shared_future</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>sf</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-63-11><span class=p>{</span>
</span><span id=__span-63-12><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Result in thread: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>sf</span><span class=p>.</span><span class=n>get</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-63-13><span class=p>}</span>
</span><span id=__span-63-14>
</span><span id=__span-63-15><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-63-16><span class=p>{</span>
</span><span id=__span-63-17><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>future</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>async</span><span class=p>(</span><span class=n>asyncTask</span><span class=p>);</span>
</span><span id=__span-63-18><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>shared_future</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>sf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=n>share</span><span class=p>();</span>
</span><span id=__span-63-19>
</span><span id=__span-63-20><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t1</span><span class=p>(</span><span class=n>printResult</span><span class=p>,</span><span class=w> </span><span class=n>sf</span><span class=p>);</span>
</span><span id=__span-63-21><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=n>t2</span><span class=p>(</span><span class=n>printResult</span><span class=p>,</span><span class=w> </span><span class=n>sf</span><span class=p>);</span>
</span><span id=__span-63-22>
</span><span id=__span-63-23><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-63-24><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-63-25>
</span><span id=__span-63-26><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Result in main: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>sf</span><span class=p>.</span><span class=n>get</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-63-27><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-63-28><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h3 id=_18>使用并发支持库实现简易的线程池<a class=headerlink href=#_18 title="Permanent link">&para;</a></h3> <p>下面是一个使用并发支持库实现简易线程池的示例：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>  1</span>
<span class=normal>  2</span>
<span class=normal>  3</span>
<span class=normal>  4</span>
<span class=normal>  5</span>
<span class=normal>  6</span>
<span class=normal>  7</span>
<span class=normal>  8</span>
<span class=normal>  9</span>
<span class=normal> 10</span>
<span class=normal> 11</span>
<span class=normal> 12</span>
<span class=normal> 13</span>
<span class=normal> 14</span>
<span class=normal> 15</span>
<span class=normal> 16</span>
<span class=normal> 17</span>
<span class=normal> 18</span>
<span class=normal> 19</span>
<span class=normal> 20</span>
<span class=normal> 21</span>
<span class=normal> 22</span>
<span class=normal> 23</span>
<span class=normal> 24</span>
<span class=normal> 25</span>
<span class=normal> 26</span>
<span class=normal> 27</span>
<span class=normal> 28</span>
<span class=normal> 29</span>
<span class=normal> 30</span>
<span class=normal> 31</span>
<span class=normal> 32</span>
<span class=normal> 33</span>
<span class=normal> 34</span>
<span class=normal> 35</span>
<span class=normal> 36</span>
<span class=normal> 37</span>
<span class=normal> 38</span>
<span class=normal> 39</span>
<span class=normal> 40</span>
<span class=normal> 41</span>
<span class=normal> 42</span>
<span class=normal> 43</span>
<span class=normal> 44</span>
<span class=normal> 45</span>
<span class=normal> 46</span>
<span class=normal> 47</span>
<span class=normal> 48</span>
<span class=normal> 49</span>
<span class=normal> 50</span>
<span class=normal> 51</span>
<span class=normal> 52</span>
<span class=normal> 53</span>
<span class=normal> 54</span>
<span class=normal> 55</span>
<span class=normal> 56</span>
<span class=normal> 57</span>
<span class=normal> 58</span>
<span class=normal> 59</span>
<span class=normal> 60</span>
<span class=normal> 61</span>
<span class=normal> 62</span>
<span class=normal> 63</span>
<span class=normal> 64</span>
<span class=normal> 65</span>
<span class=normal> 66</span>
<span class=normal> 67</span>
<span class=normal> 68</span>
<span class=normal> 69</span>
<span class=normal> 70</span>
<span class=normal> 71</span>
<span class=normal> 72</span>
<span class=normal> 73</span>
<span class=normal> 74</span>
<span class=normal> 75</span>
<span class=normal> 76</span>
<span class=normal> 77</span>
<span class=normal> 78</span>
<span class=normal> 79</span>
<span class=normal> 80</span>
<span class=normal> 81</span>
<span class=normal> 82</span>
<span class=normal> 83</span>
<span class=normal> 84</span>
<span class=normal> 85</span>
<span class=normal> 86</span>
<span class=normal> 87</span>
<span class=normal> 88</span>
<span class=normal> 89</span>
<span class=normal> 90</span>
<span class=normal> 91</span>
<span class=normal> 92</span>
<span class=normal> 93</span>
<span class=normal> 94</span>
<span class=normal> 95</span>
<span class=normal> 96</span>
<span class=normal> 97</span>
<span class=normal> 98</span>
<span class=normal> 99</span>
<span class=normal>100</span>
<span class=normal>101</span>
<span class=normal>102</span>
<span class=normal>103</span>
<span class=normal>104</span>
<span class=normal>105</span>
<span class=normal>106</span>
<span class=normal>107</span>
<span class=normal>108</span>
<span class=normal>109</span>
<span class=normal>110</span>
<span class=normal>111</span>
<span class=normal>112</span>
<span class=normal>113</span>
<span class=normal>114</span>
<span class=normal>115</span>
<span class=normal>116</span>
<span class=normal>117</span>
<span class=normal>118</span>
<span class=normal>119</span>
<span class=normal>120</span>
<span class=normal>121</span>
<span class=normal>122</span>
<span class=normal>123</span>
<span class=normal>124</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-64-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-64-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;vector&gt;</span>
</span><span id=__span-64-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;queue&gt;</span>
</span><span id=__span-64-4><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;memory&gt;</span>
</span><span id=__span-64-5><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;thread&gt;</span>
</span><span id=__span-64-6><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;mutex&gt;</span>
</span><span id=__span-64-7><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;condition_variable&gt;</span>
</span><span id=__span-64-8><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;future&gt;</span>
</span><span id=__span-64-9><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;functional&gt;</span>
</span><span id=__span-64-10><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;stdexcept&gt;</span>
</span><span id=__span-64-11>
</span><span id=__span-64-12><span class=k>class</span><span class=w> </span><span class=nc>ThreadPool</span><span class=w> </span>
</span><span id=__span-64-13><span class=p>{</span>
</span><span id=__span-64-14><span class=k>public</span><span class=o>:</span>
</span><span id=__span-64-15><span class=w>    </span><span class=c1>// 构造函数，初始化线程池</span>
</span><span id=__span-64-16><span class=w>    </span><span class=n>ThreadPool</span><span class=p>(</span><span class=kt>size_t</span><span class=w> </span><span class=n>threads</span><span class=p>)</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>stop</span><span class=p>(</span><span class=nb>false</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-64-17><span class=w>    </span><span class=p>{</span>
</span><span id=__span-64-18><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>size_t</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>threads</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-64-19><span class=w>        </span><span class=p>{</span>
</span><span id=__span-64-20><span class=w>            </span><span class=c1>// 给线程池添加线程，使用lambda表达式创建线程</span>
</span><span id=__span-64-21><span class=w>            </span><span class=n>workers</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>([</span><span class=k>this</span><span class=p>]</span><span class=w> </span>
</span><span id=__span-64-22><span class=w>            </span><span class=p>{</span>
</span><span id=__span-64-23><span class=w>                </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-64-24><span class=w>                </span><span class=p>{</span>
</span><span id=__span-64-25><span class=w>                    </span><span class=n>std</span><span class=o>::</span><span class=n>function</span><span class=o>&lt;</span><span class=kt>void</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=n>task</span><span class=p>;</span>
</span><span id=__span-64-26><span class=w>                    </span><span class=p>{</span>
</span><span id=__span-64-27><span class=w>                        </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock</span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>queue_mutex</span><span class=p>);</span>
</span><span id=__span-64-28><span class=w>                        </span><span class=c1>// 如果线程池停止或者任务队列为空，则等待</span>
</span><span id=__span-64-29><span class=w>                        </span><span class=c1>// 注意带有谓词函数的执行逻辑</span>
</span><span id=__span-64-30><span class=w>                        </span><span class=k>this</span><span class=o>-&gt;</span><span class=n>condition</span><span class=p>.</span><span class=n>wait</span><span class=p>(</span><span class=n>lock</span><span class=p>,</span><span class=w> </span><span class=p>[</span><span class=k>this</span><span class=p>]</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=o>-&gt;</span><span class=n>stop</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>tasks</span><span class=p>.</span><span class=n>empty</span><span class=p>();</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-64-31>
</span><span id=__span-64-32><span class=w>                        </span><span class=c1>// 如果线程池停止且任务队列为空，则退出线程</span>
</span><span id=__span-64-33><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>stop</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=k>this</span><span class=o>-&gt;</span><span class=n>tasks</span><span class=p>.</span><span class=n>empty</span><span class=p>())</span>
</span><span id=__span-64-34><span class=w>                            </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-64-35><span class=w>                        </span><span class=c1>// 取出队头任务</span>
</span><span id=__span-64-36><span class=w>                        </span><span class=n>task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>tasks</span><span class=p>.</span><span class=n>front</span><span class=p>());</span>
</span><span id=__span-64-37><span class=w>                        </span><span class=k>this</span><span class=o>-&gt;</span><span class=n>tasks</span><span class=p>.</span><span class=n>pop</span><span class=p>();</span>
</span><span id=__span-64-38><span class=w>                    </span><span class=p>}</span>
</span><span id=__span-64-39>
</span><span id=__span-64-40><span class=w>                    </span><span class=c1>// 执行任务</span>
</span><span id=__span-64-41><span class=w>                    </span><span class=n>task</span><span class=p>();</span>
</span><span id=__span-64-42><span class=w>                </span><span class=p>}</span>
</span><span id=__span-64-43><span class=w>            </span><span class=p>});</span>
</span><span id=__span-64-44><span class=w>        </span><span class=p>}</span>
</span><span id=__span-64-45><span class=w>    </span><span class=p>}</span>
</span><span id=__span-64-46>
</span><span id=__span-64-47><span class=w>    </span><span class=c1>// 析构函数，停止线程池</span>
</span><span id=__span-64-48><span class=w>    </span><span class=o>~</span><span class=n>ThreadPool</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-64-49><span class=w>    </span><span class=p>{</span>
</span><span id=__span-64-50><span class=w>        </span><span class=p>{</span>
</span><span id=__span-64-51><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock</span><span class=p>(</span><span class=n>queue_mutex</span><span class=p>);</span>
</span><span id=__span-64-52><span class=w>            </span><span class=n>stop</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-64-53><span class=w>        </span><span class=p>}</span>
</span><span id=__span-64-54><span class=w>        </span><span class=n>condition</span><span class=p>.</span><span class=n>notify_all</span><span class=p>();</span>
</span><span id=__span-64-55><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=w> </span><span class=o>&amp;</span><span class=n>worker</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>workers</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-64-56><span class=w>            </span><span class=n>worker</span><span class=p>.</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-64-57><span class=w>    </span><span class=p>}</span>
</span><span id=__span-64-58>
</span><span id=__span-64-59><span class=w>    </span><span class=c1>// 向线程池添加任务</span>
</span><span id=__span-64-60><span class=w>    </span><span class=k>template</span><span class=o>&lt;</span><span class=k>class</span><span class=w> </span><span class=nc>F</span><span class=p>,</span><span class=w> </span><span class=k>class</span><span class=p>...</span><span class=w> </span><span class=n>Args</span><span class=o>&gt;</span>
</span><span id=__span-64-61><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>enqueue</span><span class=p>(</span><span class=n>F</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=n>f</span><span class=p>,</span><span class=w> </span><span class=n>Args</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=p>...</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-64-62><span class=w>        </span><span class=o>-&gt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>future</span><span class=o>&lt;</span><span class=k>typename</span><span class=w> </span><span class=nc>std</span><span class=o>::</span><span class=n>result_of</span><span class=o>&lt;</span><span class=n>F</span><span class=p>(</span><span class=n>Args</span><span class=p>...)</span><span class=o>&gt;::</span><span class=n>type</span><span class=o>&gt;</span><span class=w> </span>
</span><span id=__span-64-63><span class=w>    </span><span class=p>{</span>
</span><span id=__span-64-64><span class=w>        </span><span class=c1>// 获取到返回值</span>
</span><span id=__span-64-65><span class=w>        </span><span class=k>using</span><span class=w> </span><span class=n>return_type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>typename</span><span class=w> </span><span class=nc>std</span><span class=o>::</span><span class=n>result_of</span><span class=o>&lt;</span><span class=n>F</span><span class=p>(</span><span class=n>Args</span><span class=p>...)</span><span class=o>&gt;::</span><span class=n>type</span><span class=p>;</span>
</span><span id=__span-64-66>
</span><span id=__span-64-67><span class=w>        </span><span class=c1>// 包装任务到packaged_task中，使用std::bind绑定参数使得有参或者无参任务都可以被调用</span>
</span><span id=__span-64-68><span class=w>        </span><span class=k>auto</span><span class=w> </span><span class=n>task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>packaged_task</span><span class=o>&lt;</span><span class=n>return_type</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=o>&gt;</span><span class=p>(</span>
</span><span id=__span-64-69><span class=w>                </span><span class=n>std</span><span class=o>::</span><span class=n>bind</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>forward</span><span class=o>&lt;</span><span class=n>F</span><span class=o>&gt;</span><span class=p>(</span><span class=n>f</span><span class=p>),</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>forward</span><span class=o>&lt;</span><span class=n>Args</span><span class=o>&gt;</span><span class=p>(</span><span class=n>args</span><span class=p>)...)</span>
</span><span id=__span-64-70><span class=w>        </span><span class=p>);</span>
</span><span id=__span-64-71>
</span><span id=__span-64-72><span class=w>        </span><span class=c1>// 获得任务的future</span>
</span><span id=__span-64-73><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>future</span><span class=o>&lt;</span><span class=n>return_type</span><span class=o>&gt;</span><span class=w> </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>task</span><span class=o>-&gt;</span><span class=n>get_future</span><span class=p>();</span>
</span><span id=__span-64-74><span class=w>        </span><span class=p>{</span>
</span><span id=__span-64-75><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock</span><span class=p>(</span><span class=n>queue_mutex</span><span class=p>);</span>
</span><span id=__span-64-76><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stop</span><span class=p>)</span>
</span><span id=__span-64-77><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>runtime_error</span><span class=p>(</span><span class=s>&quot;enqueue on stopped ThreadPool&quot;</span><span class=p>);</span>
</span><span id=__span-64-78><span class=w>            </span><span class=n>tasks</span><span class=p>.</span><span class=n>emplace</span><span class=p>([</span><span class=n>task</span><span class=p>]()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>task</span><span class=p>)();</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-64-79><span class=w>        </span><span class=p>}</span>
</span><span id=__span-64-80><span class=w>        </span><span class=n>condition</span><span class=p>.</span><span class=n>notify_one</span><span class=p>();</span>
</span><span id=__span-64-81><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>res</span><span class=p>;</span>
</span><span id=__span-64-82><span class=w>    </span><span class=p>}</span>
</span><span id=__span-64-83>
</span><span id=__span-64-84><span class=k>private</span><span class=o>:</span>
</span><span id=__span-64-85><span class=w>    </span><span class=c1>// 工作线程集合</span>
</span><span id=__span-64-86><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=kr>thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>workers</span><span class=p>;</span>
</span><span id=__span-64-87><span class=w>    </span><span class=c1>// 任务队列</span>
</span><span id=__span-64-88><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>queue</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>function</span><span class=o>&lt;</span><span class=kt>void</span><span class=p>()</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>tasks</span><span class=p>;</span>
</span><span id=__span-64-89>
</span><span id=__span-64-90><span class=w>    </span><span class=c1>// 同步原语</span>
</span><span id=__span-64-91><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>queue_mutex</span><span class=p>;</span>
</span><span id=__span-64-92><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>condition_variable</span><span class=w> </span><span class=n>condition</span><span class=p>;</span>
</span><span id=__span-64-93><span class=w>    </span><span class=kt>bool</span><span class=w> </span><span class=n>stop</span><span class=p>;</span>
</span><span id=__span-64-94><span class=p>};</span>
</span><span id=__span-64-95>
</span><span id=__span-64-96><span class=c1>// 用于输出的互斥锁</span>
</span><span id=__span-64-97><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>cout_mtx</span><span class=p>;</span>
</span><span id=__span-64-98><span class=c1>// 测试函数</span>
</span><span id=__span-64-99><span class=kt>void</span><span class=w> </span><span class=nf>testFunction</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>)</span>
</span><span id=__span-64-100><span class=p>{</span>
</span><span id=__span-64-101><span class=w>    </span><span class=p>{</span>
</span><span id=__span-64-102><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock</span><span class=p>(</span><span class=n>cout_mtx</span><span class=p>);</span>
</span><span id=__span-64-103><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Task &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; is running on thread &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>get_id</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-64-104><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>seconds</span><span class=p>(</span><span class=mi>1</span><span class=p>));</span>
</span><span id=__span-64-105><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Task &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; is finished.&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-64-106><span class=w>    </span><span class=p>}</span>
</span><span id=__span-64-107><span class=p>}</span>
</span><span id=__span-64-108>
</span><span id=__span-64-109><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-64-110><span class=p>{</span>
</span><span id=__span-64-111><span class=w>    </span><span class=c1>// 创建一个包含 4 个线程的线程池</span>
</span><span id=__span-64-112><span class=w>    </span><span class=n>ThreadPool</span><span class=w> </span><span class=n>pool</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
</span><span id=__span-64-113>
</span><span id=__span-64-114><span class=w>    </span><span class=c1>// 向线程池添加任务</span>
</span><span id=__span-64-115><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>future</span><span class=o>&lt;</span><span class=kt>void</span><span class=o>&gt;</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>futures</span><span class=p>;</span>
</span><span id=__span-64-116><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>8</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-64-117><span class=w>        </span><span class=n>futures</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>pool</span><span class=p>.</span><span class=n>enqueue</span><span class=p>(</span><span class=n>testFunction</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>));</span>
</span><span id=__span-64-118>
</span><span id=__span-64-119><span class=w>    </span><span class=c1>// 等待所有任务完成</span>
</span><span id=__span-64-120><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>future</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>futures</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-64-121><span class=w>        </span><span class=n>future</span><span class=p>.</span><span class=n>wait</span><span class=p>();</span>
</span><span id=__span-64-122>
</span><span id=__span-64-123><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-64-124><span class=p>}</span><span class=w>    </span>
</span></code></pre></div></td></tr></table></div> <p>参考输出结果：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-65-1>Task 0 is running on thread 27024
</span><span id=__span-65-2>Task 0 is finished.
</span><span id=__span-65-3>Task 4 is running on thread 27024
</span><span id=__span-65-4>Task 4 is finished.
</span><span id=__span-65-5>Task 2 is running on thread 47348
</span><span id=__span-65-6>Task 2 is finished.
</span><span id=__span-65-7>Task 3 is running on thread 46656
</span><span id=__span-65-8>Task 3 is finished.
</span><span id=__span-65-9>Task 1 is running on thread 47936
</span><span id=__span-65-10>Task 1 is finished.
</span><span id=__span-65-11>Task 5 is running on thread 27024
</span><span id=__span-65-12>Task 5 is finished.
</span><span id=__span-65-13>Task 6 is running on thread 47348
</span><span id=__span-65-14>Task 6 is finished.
</span><span id=__span-65-15>Task 7 is running on thread 46656
</span><span id=__span-65-16>Task 7 is finished.
</span></code></pre></div></td></tr></table></div> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title=最后更新> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2025年9月1日</span> </span> </aside> <form class=md-feedback name=feedback hidden> <fieldset> <legend class=md-feedback__title> 页面有帮助吗？ </legend> <div class=md-feedback__inner> <div class=md-feedback__list> <button class="md-feedback__icon md-icon" type=submit title=页面对我有帮助 data-md-value=1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 9v12H1V9zm4 12a2 2 0 0 1-2-2V9c0-.55.22-1.05.59-1.41L14.17 1l1.06 1.06c.27.27.44.64.44 1.05l-.03.32L14.69 8H21a2 2 0 0 1 2 2v2c0 .26-.05.5-.14.73l-3.02 7.05C19.54 20.5 18.83 21 18 21zm0-2h9.03L21 12v-2h-8.79l1.13-5.32L9 9.03z"/></svg> </button> <button class="md-feedback__icon md-icon" type=submit title=页面没有帮助到我 data-md-value=0> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 15V3h4v12zM15 3a2 2 0 0 1 2 2v10c0 .55-.22 1.05-.59 1.41L9.83 23l-1.06-1.06c-.27-.27-.44-.64-.44-1.06l.03-.31.95-4.57H3a2 2 0 0 1-2-2v-2c0-.26.05-.5.14-.73l3.02-7.05C4.46 3.5 5.17 3 6 3zm0 2H5.97L3 12v2h8.78l-1.13 5.32L15 14.97z"/></svg> </button> </div> <div class=md-feedback__note> <div data-md-value=1 hidden> 谢谢你的反馈！ </div> <div data-md-value=0 hidden> 谢谢你的反馈！联系<a href=https://www.help-doc.top/author/contact/contact.html>作者</a>提供更详细的信息 </div> </div> </div> </fieldset> </form> <!-- Waline 评论系统 --> <div id=waline></div> <!-- Waline 评论系统 --> <div id=waline></div> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2024-2025 柯懒不是柯南 </div> </div> <div class="md-footer-love md-typeset"> 一闪一闪亮晶晶，不及<span class=love-highlight>小亮</span><span class=love-heart>♥</span>照我心。To Li Liang </div> <div class=md-social> <a href=https://github.com/H0308 target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://www.help-doc.top/author/contact/contact.html target=_blank rel=noopener title=www.help-doc.top class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M433.754 420.445c-11.526 1.393-44.86-52.741-44.86-52.741 0 31.345-16.136 72.247-51.051 101.786 16.842 5.192 54.843 19.167 45.803 34.421-7.316 12.343-125.51 7.881-159.632 4.037-34.122 3.844-152.316 8.306-159.632-4.037-9.045-15.25 28.918-29.214 45.783-34.415-34.92-29.539-51.059-70.445-51.059-101.792 0 0-33.334 54.134-44.859 52.741-5.37-.65-12.424-29.644 9.347-99.704 10.261-33.024 21.995-60.478 40.144-105.779C60.683 98.063 108.982.006 224 0c113.737.006 163.156 96.133 160.264 214.963 18.118 45.223 29.912 72.85 40.144 105.778 21.768 70.06 14.716 99.053 9.346 99.704"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.indexes", "navigation.prune", "navigation.tabs", "content.code.copy"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script> <script src=../../assets/javascripts/bundle.c8b220af.min.js></script> <script src=../../javascripts/other.min.js></script> <script src=../../javascripts/copyright.min.js></script> <script src=../../javascripts/docsearch.min.js></script> <script src=https://cdn.jsdelivr.net/npm/@docsearch/js@3></script> <script src=../../assets/javascripts/toggle-sidebar.js async></script> <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body> </html>