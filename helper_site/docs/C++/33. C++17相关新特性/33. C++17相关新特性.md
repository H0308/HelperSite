# C++17相关新特性

## filesystem库

### 概述

C\+\+17引入的[`filesystem`库](https://en.cppreference.com/w/cpp/filesystem)提供了跨平台的文件系统操作功能，使开发者能够以统一的方式处理路径、文件和目录操作，而不必担心不同操作系统间的差异。这个库最初源自`Boost.Filesystem`，现已成为C++标准的一部分

下面是基于官方文档对`filesystem`的介绍：

**Classes：**

定义在头文件 `<filesystem>`，定义在命名空间 `std::filesystem`：

| 类名                                     | 描述                           | 类型    |
| ---------------------------------------- | ------------------------------ | ------- |
| **path** (C++17)                         | 表示一个路径                   | class   |
| **filesystem_error** (C++17)             | 文件系统错误时抛出的异常       | class   |
| **directory_entry** (C++17)              | 一个目录项                     | class   |
| **directory_iterator** (C++17)           | 目录内容的迭代器               | class   |
| **recursive_directory_iterator** (C++17) | 目录及其子目录内容的迭代器     | class   |
| **file_status** (C++17)                  | 表示文件类型和权限             | class   |
| **space_info** (C++17)                   | 文件系统上可用和空闲空间的信息 | class   |
| **file_type** (C++17)                    | 文件的类型                     | enum    |
| **perms** (C++17)                        | 标识文件系统权限               | enum    |
| **perm_options** (C++17)                 | 指定权限操作的语义             | enum    |
| **copy_options** (C++17)                 | 指定复制操作的语义             | enum    |
| **directory_options** (C++17)            | 遍历目录内容的选项             | enum    |
| **file_time_type** (C++17)               | 表示文件时间值                 | typedef |

**非成员函数：**

定义在头文件 `<filesystem>`，定义在命名空间 `std::filesystem`

| 函数名                               | 描述                                   | 类型     |
| ------------------------------------ | -------------------------------------- | -------- |
| **absolute** (C++17)                 | 组合成一个绝对路径                     | function |
| **canonical** (C++17)                | 组合成一个规范路径                     | function |
| **weakly_canonical** (C++17)         | 组合成一个弱规范路径                   | function |
| **relative** (C++17)                 | 组合成一个相对路径                     | function |
| **proximate** (C++17)                | 组合成一个邻近路径                     | function |
| **copy** (C++17)                     | 复制文件或目录                         | function |
| **copy_file** (C++17)                | 复制文件内容                           | function |
| **copy_symlink** (C++17)             | 复制符号链接                           | function |
| **create_directory** (C++17)         | 创建新目录                             | function |
| **create_directories** (C++17)       | 创建多级目录                           | function |
| **create_hard_link** (C++17)         | 创建硬链接                             | function |
| **create_symlink** (C++17)           | 创建符号链接                           | function |
| **create_directory_symlink** (C++17) | 创建目录符号链接                       | function |
| **current_path** (C++17)             | 返回或设置当前工作目录                 | function |
| **exists** (C++17)                   | 检查路径是否引用现有的文件系统对象     | function |
| **equivalent** (C++17)               | 检查两个路径是否引用相同的文件系统对象 | function |
| **file_size** (C++17)                | 返回文件大小                           | function |
| **hard_link_count** (C++17)          | 返回指向特定文件的硬链接数量           | function |
| **last_write_time** (C++17)          | 获取或设置最后一次数据修改的时间       | function |
| **permissions** (C++17)              | 修改文件访问权限                       | function |
| **read_symlink** (C++17)             | 获取符号链接的目标                     | function |
| **remove** (C++17)                   | 移除文件或空目录                       | function |
| **remove_all** (C++17)               | 递归地移除文件或目录及其所有内容       | function |
| **rename** (C++17)                   | 移动或重命名文件或目录                 | function |
| **resize_file** (C++17)              | 通过截断或零填充更改常规文件的大小     | function |
| **space** (C++17)                    | 确定文件系统上的可用空闲空间           | function |
| **status** (C++17)                   | 确定文件属性                           | function |
| **symlink_status** (C++17)           | 确定文件属性，检查符号链接目标         | function |
| **temp_directory_path** (C++17)      | 返回一个适合临时文件的目录             | function |

**文件类型：**

| 函数名                        | 描述                             | 类型     |
| ----------------------------- | -------------------------------- | -------- |
| **is_block_file** (C++17)     | 检查给定路径是否引用块设备       | function |
| **is_character_file** (C++17) | 检查给定路径是否引用字符设备     | function |
| **is_directory** (C++17)      | 检查给定路径是否引用目录         | function |
| **is_empty** (C++17)          | 检查给定路径是否引用空文件或目录 | function |
| **is_fifo** (C++17)           | 检查给定路径是否引用命名管道     | function |
| **is_other** (C++17)          | 检查参数是否引用其他类型的文件   | function |
| **is_regular_file** (C++17)   | 检查参数是否引用常规文件         | function |
| **is_socket** (C++17)         | 检查参数是否引用命名 IPC 套接字  | function |
| **is_symlink** (C++17)        | 检查参数是否引用符号链接         | function |
| **status_known** (C++17)      | 检查文件状态是否已知             | function |

### 包含方式

```cpp
#include <filesystem>
namespace fs = std::filesystem; // 常用的命名空间别名
```

### 核心组件

#### 路径类 (path)

`std::filesystem::path`是该库的核心类，用于表示文件系统路径：

```cpp
// 直接使用string进行构造
fs::path p1 = "C:/Users/Documents/file.txt";  // Windows路径
fs::path p2 = "/home/user/documents/file.txt"; // Unix路径
```

**主要特性**：

- 自动处理不同平台的路径分隔符
- 提供路径组合、分解和规范化功能
- 支持Unicode

**常用操作**：
```cpp
fs::path p = "/home/user/documents/file.txt";

p.filename();    // "file.txt"
p.extension();   // ".txt"
p.stem();        // "file"
p.parent_path(); // "/home/user/documents"
p.root_name();   // 返回根名称
p.is_absolute(); // 是否是绝对路径
p.is_relative(); // 是否是相对路径
p.string(); // 返回当前路径字符串"/home/user/documents/file.txt"
```

**路径连接**：
```cpp
fs::path dir = "/home/user";
fs::path full = dir / "documents" / "file.txt"; // 使用/操作符连接路径
```

#### 文件状态和属性

```cpp
fs::file_status status = fs::status(path);
bool isDir = fs::is_directory(path);
bool isFile = fs::is_regular_file(path);
bool exists = fs::exists(path);
uintmax_t size = fs::file_size(path);
fs::file_time_type time = fs::last_write_time(path);
```

#### 文件和目录操作

**创建目录**：
```cpp
fs::create_directory(path);
fs::create_directories(path); // 创建多级目录
```

**复制、移动和删除**：
```cpp
fs::copy(from, to, fs::copy_options::recursive);
fs::rename(from, to);
fs::remove(path);
fs::remove_all(path); // 递归删除
```

**目录遍历**：
```cpp
// 遍历单个目录
for (const auto& entry : fs::directory_iterator(path)) {
    std::cout << entry.path() << std::endl;
}

// 递归遍历目录
for (const auto& entry : fs::recursive_directory_iterator(path)) {
    std::cout << entry.path() << std::endl;
}
```

### 实用功能

#### 空间查询

```cpp
fs::space_info info = fs::space("/home");
std::cout << "可用空间: " << info.available << " 字节\n";
std::cout << "总空间: " << info.capacity << " 字节\n";
std::cout << "空闲空间: " << info.free << " 字节\n";
```

#### 当前路径操作

```cpp
fs::path current = fs::current_path(); // 获取当前工作目录
fs::current_path(newPath); // 修改当前工作目录
```

### 返回当前路径字符串操作

```cpp
std::string path_str = current.string();
```

#### 临时目录

```cpp
fs::path temp = fs::temp_directory_path(); // 获取临时目录
```

### 完整示例

```cpp
#include <iostream>
#include <filesystem>
namespace fs = std::filesystem;

int main() {
    try {
        // 创建目录
        fs::path dir = "example_directory";
        fs::create_directory(dir);
        
        // 创建文件
        std::ofstream(dir / "file1.txt") << "Hello, filesystem!";
        std::ofstream(dir / "file2.txt") << "Another file";
        
        // 创建子目录
        fs::create_directory(dir / "subdir");
        
        // 递归遍历并显示所有条目
        std::cout << "目录内容:\n";
        for (const auto& entry : fs::recursive_directory_iterator(dir)) {
            std::cout << entry.path() << " - ";
            if (fs::is_regular_file(entry.path())) {
                std::cout << fs::file_size(entry.path()) << " 字节";
            } else if (fs::is_directory(entry.path())) {
                std::cout << "目录";
            }
            std::cout << std::endl;
        }
        
        // 复制文件
        fs::copy(dir / "file1.txt", dir / "file1_copy.txt");
        
        // 删除整个目录
        fs::remove_all(dir);
        
        std::cout << "操作完成" << std::endl;
    } catch (const fs::filesystem_error& e) {
        std::cerr << "文件系统错误: " << e.what() << std::endl;
    } catch (const std::exception& e) {
        std::cerr << "标准异常: " << e.what() << std::endl;
    }
    
    return 0;
}
```