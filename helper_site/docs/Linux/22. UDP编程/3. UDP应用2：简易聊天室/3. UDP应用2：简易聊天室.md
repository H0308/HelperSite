# UDP应用2：简易聊天室

## 本篇介绍

在前面的基本使用过程中已经完成了本地和网络通信，既然一个人和一台服务器可以进行通信，那么多个人连接一台服务器也可以和这台服务器实现通信。在这个基础上，如果服务器可以将某个人发给服务器的消息转发给所有连接到当前服务器的客户端，就可以实现一个人发消息，其他人看到消息的效果，这就是简易聊天室的原理

本篇就是利用UDP的操作实现上面提到的简易聊天室，其中客户端向服务端发送消息，服务端将收到的消息转发给所有连接到当前服务器的客户端

需要注意，本次实现基于[前面封装的服务端和客户端](https://www.help-doc.top/Linux/22.%20UDP%E7%BC%96%E7%A8%8B/1.%20UDP%E7%BC%96%E7%A8%8B%E6%8E%A5%E5%8F%A3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/1.%20UDP%E7%BC%96%E7%A8%8B%E6%8E%A5%E5%8F%A3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8.html)

## 基本实现思路

在实现具体功能之前，先了解本次设计聊天室的基本思路：

既然是多个人连接一台服务器，那么这些人需要具有一些属性字段，所以可以对每一个客户端进行描述，包括对应的IP地址和端口，因为是聊天室，所以还可以包括名称属性。此时每一个客户端就是一个具体类的对象，那么之后还需要对这些对象进行增加和删除，所以还需要对这些客户端进行管理。这整个过程就是先描述，再组织

有了描述客户端的类和管理客户端的结构后就可以设计服务端

前面提到，服务端需要将某一个客户端发给服务端的信息转发给所有连接当前服务器的所有客户端，那么此时就涉及到两个问题：

1. 服务器怎么知道是消息谁发的
2. 服务器怎么做信息转发

对于第一个问题，一台客户端连接到服务器时可以理解为向服务器请求添加用户，那么服务器只需要调用请求添加用户的接口就可以实现获取到用户信息，而这个用户信息并不需要服务器本身保存，而是用户自己保存，即在每一个客户端中，服务器需要做的只是添加用户

对于第二个问题，既然要服务器做信息转发，那么肯定少不了要遍历管理所有客户端的结构，前面提到服务器启动后的`socketfd`是全双工的，那么服务器既要接收客户端发送的消息又要将消息进行分发，服务器这一单一线程整体的负担就会非常重，所以可以考虑使用线程池，通过线程池中的线程完成分发操作，此时服务器主线程只需要维护线程池即可

## 实现管理用户

本次设计的管理用户模块可以采用观察者模式，观察者模式是一种行为型设计模式，用于定义对象之间的一对多依赖关系。当一个对象的状态发生变化时，所有依赖于它的对象都会自动收到通知并更新，其有下面的核心概念：

1. 主题（Subject）：被观察的对象。维护一组观察者，并提供添加、删除和通知观察者的方法
2. 观察者（Observer）：监听主题状态变化的对象。定义一个更新接口，用于接收主题的通知
3. 具体主题（Concrete Subject）：实现主题接口，维护状态并在状态变化时通知观察者
4. 具体观察者（Concrete Observer）：实现观察者接口，定义在接收到通知时的具体行为

根据上面的概念，代入用户管理模块设计，首先是设计基类，这个基类就是对应的观察者中的主题，因为需要提供添加、删除和通知观察者的方法，所以这个基类需要对应的虚函数，而在本次聊天室中，添加和删除观察者对应的就是添加用户到服务器和从服务器中删除用户，而通知观察者就是