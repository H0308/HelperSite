<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://www.help-doc.top/Linux/33.%20epoll%E5%AE%9E%E7%8E%B0%E5%A4%9A%E8%B7%AF%E8%BD%AC%E6%8E%A5/33.%20epoll%E5%AE%9E%E7%8E%B0%E5%A4%9A%E8%B7%AF%E8%BD%AC%E6%8E%A5.html><link rel=prev href=../32.%20%E4%BA%94%E7%A7%8DIO%E6%A8%A1%E5%9E%8B%E4%B8%8Eselect%E5%92%8Cpoll%E5%88%86%E5%88%AB%E5%AE%9E%E7%8E%B0%E5%A4%9A%E8%B7%AF%E8%BD%AC%E6%8E%A5/32.%20%E4%BA%94%E7%A7%8DIO%E6%A8%A1%E5%9E%8B%E4%B8%8Eselect%E5%92%8Cpoll%E5%88%86%E5%88%AB%E5%AE%9E%E7%8E%B0%E5%A4%9A%E8%B7%AF%E8%BD%AC%E6%8E%A5.html><link rel=next href=../34.%20Reactor%E6%A8%A1%E5%BC%8F%E4%B8%8E%E5%AE%8C%E5%96%84%E5%9F%BA%E4%BA%8E%E8%BE%B9%E7%BC%98%E8%A7%A6%E5%8F%91%E6%A8%A1%E5%BC%8Fepoll%E5%AE%9E%E7%8E%B0TCP%E6%9C%8D%E5%8A%A1%E5%99%A8/34.%20Reactor%E6%A8%A1%E5%BC%8F%E4%B8%8E%E5%AE%8C%E5%96%84%E5%9F%BA%E4%BA%8E%E8%BE%B9%E7%BC%98%E8%A7%A6%E5%8F%91%E6%A8%A1%E5%BC%8Fepoll%E5%AE%9E%E7%8E%B0TCP%E6%9C%8D%E5%8A%A1%E5%99%A8.html><link rel=icon href=../../images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.12"><title>epoll实现多路转接 - 柯懒的知识库</title><link rel=stylesheet href=../../assets/stylesheets/main.2afb09e1.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=stylesheet href=../../css/timeline.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-9XWRGNRRSY"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-9XWRGNRRSY",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-9XWRGNRRSY",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script><link rel=stylesheet href=../../stylesheets/colors.min.css><link rel=stylesheet href=../../stylesheets/theme2.min.css media="screen and (max-width: 767px)"><link rel=stylesheet href=../../stylesheets/theme2.min.css media="screen and (min-width: 768px) and (max-width: 1199px)"><link rel=stylesheet href=../../stylesheets/theme1.min.css media="screen and (min-width: 1200px)"><link rel=stylesheet href=../../stylesheets/print.min.css><!-- 字体样式表 --><link rel=stylesheet href=../../stylesheets/font-dongguanti.min.css id=font-dongguanti><link rel=stylesheet href=../../stylesheets/font-oppoti.min.css id=font-oppoti disabled><link rel=stylesheet href=../../stylesheets/font-jiangchengti.min.css id=font-jiangchengti disabled><link rel=stylesheet href=../../stylesheets/font-lxgw.min.css id=font-lxgw disabled><!-- 代码字体样式表 --><link rel=stylesheet href=../../stylesheets/code-font-dejavu-sans-mono.min.css id=code-font-dejavu-sans-mono><link rel=stylesheet href=../../stylesheets/code-font-zsft-hk.min.css id=code-font-zsft-hk disabled><script src=https://cdn.jsdelivr.net/npm/mermaid@11.5.0/dist/mermaid.min.js></script><style>
    /* 霞鹜臻楷 */
    @import url("https://static.zeoseven.com/zsft/2/main/result.css");
    /* 寒蝉团圆体 Sans */
    @import url("https://fontsapi.zeoseven.com/70/main/result.css");

    @font-face {
        font-family: "LXGW ZhenKai";
    }

    @font-face {
        font-family: "寒蝉团圆体 Sans";
    }

    .md-header__topic .md-ellipsis {
        font-family: "寒蝉团圆体 Sans" !important;
    }

    :root {
        --md-text-font: "STDongGuanTi", "OPPOSans", "JiangChengHeiTi 400W", sans-serif;
        --md-header-font: "LXGW ZhenKai", sans-serif;
        --md-code-font: "DejaVu Sans Mono", "ZSFT-hk";
        --code-font-color: var(--text-code);
    }

    h1+div>p {
        font-family: var(--md-header-font);
    }

    @media screen and (max-width: 1199px) {
        /* 隐藏功能区的主题切换按钮 */
        .theme-switcher {
            display: none !important;
        }
    }

    /* 右侧固定功能条样式 */
    .floating-toolbar {
        position: fixed;
        top: 50%;
        right: 0;
        transform: translateY(-50%);
        z-index: 99999;
        font-family: var(--md-text-font);
        background: var(--bg-white);
        border: 1px solid #eee;
        border-right: none;
        border-radius: 12px 0 0 12px;
        box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
        padding: 8px 0;
        min-width: 60px;
        transition: all 0.3s ease;
        display: block;
        visibility: visible;
        opacity: 1;
        width: auto;
        height: auto;
        max-width: none;
        max-height: none;
        overflow: visible;
    }


    .floating-toolbar:hover {
        box-shadow: -6px 0 30px var(--shadow-strong);
        transform: translateY(-50%) translateX(-2px);
    }

    /* 功能条项目 */
    .toolbar-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 12px 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        border-bottom: 1px solid #eee;
        background: transparent;
        color: #333;
        width: auto;
        height: auto;
        visibility: visible;
        opacity: 1;
    }

    .toolbar-item:last-child {
        border-bottom: none;
    }

    .toolbar-item:hover {
        background: var(--primary-blue-light);
        transform: translateX(-2px);
    }

    .toolbar-item.active {
        background: var(--primary-blue-medium);
        color: var(--primary-blue);
    }

    /* 功能条图标 */
    .toolbar-icon {
        font-size: 20px;
        line-height: 1;
        margin-bottom: 4px;
        transition: all 0.3s ease;
        display: block;
        visibility: visible;
        opacity: 1;
        color: #333;
    }

    .toolbar-item:hover .toolbar-icon {
        transform: scale(1.1) !important;
    }

    /* SVG图标样式 */
    .theme-icon {
        width: 20px !important;
        height: 20px !important;
        fill: currentColor !important;
        transition: all 0.3s ease !important;
    }

    .toolbar-item:hover .theme-icon {
        fill: var(--primary-blue) !important;
    }

    /* 返回顶部SVG图标样式 */
    .back-to-top-icon {
        width: 20px !important;
        height: 20px !important;
        fill: currentColor !important;
        transition: all 0.3s ease !important;
    }

    .toolbar-item:hover .back-to-top-icon {
        fill: var(--primary-blue) !important;
    }

    /* 字体切换SVG图标样式 */
    .font-icon {
        width: 20px;
        height: 20px;
        fill: currentColor;
        transition: all 0.3s ease;
    }

    .toolbar-item:hover {
        fill: var(--primary-blue);
    }

    /* 功能条标签 */
    .toolbar-label {
        font-size: 11px !important;
        font-weight: 500 !important;
        color: #666 !important;
        text-align: center !important;
        line-height: 1.2 !important;
        transition: all 0.3s ease !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    .toolbar-item:hover .toolbar-label {
        color: var(--text-primary);
    }

    /* 字体切换功能特殊样式 */
    .font-switcher {
        position: relative;
    }

    .font-dropdown-toolbar {
        position: absolute;
        right: 100%;
        top: 0;
        margin-right: 8px;
        min-width: 120px;
        opacity: 0;
        visibility: hidden;
        transform: translateX(10px);
        transition: all 0.3s ease;
        z-index: 1001;
    }

    .font-switcher:hover .font-dropdown-toolbar,
    .font-dropdown-toolbar.active {
        opacity: 1;
        visibility: visible;
        transform: translateX(0);
    }

    .font-current-toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        background: var(--bg-white);
        border: 1px solid var(--border-light);
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        color: var(--text-primary);
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px var(--shadow-light);
        white-space: nowrap;
    }

    .font-current-toolbar:hover {
        border-color: var(--primary-blue);
        background: var(--primary-blue-light);
        box-shadow: 0 4px 12px var(--shadow-primary-medium);
    }

    .current-font-name-toolbar {
        font-weight: 500;
        margin-right: 8px;
    }

    .dropdown-arrow-icon {
        width: 12px !important;
        height: 12px !important;
        fill: currentColor !important;
        color: var(--text-secondary) !important;
        transition: transform 0.3s ease !important;
    }

    .font-dropdown-toolbar.active .dropdown-arrow-icon {
        transform: rotate(180deg) !important;
    }

    .font-options-toolbar {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--bg-white);
        border: 1px solid var(--border-light);
        border-radius: 8px;
        box-shadow: 0 4px 12px var(--shadow-strong);
        z-index: 1002;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s ease;
        margin-top: 4px;
        max-height: 150px;
        overflow-y: auto;
    }

    .font-dropdown-toolbar.active .font-options-toolbar {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .font-option-toolbar {
        padding: 8px 12px;
        cursor: pointer;
        font-size: 13px;
        color: var(--text-primary);
        transition: all 0.2s ease;
        border-bottom: 1px solid var(--border-light);
        white-space: nowrap;
    }

    .font-option-toolbar:last-child {
        border-bottom: none;
        border-radius: 0 0 8px 8px;
    }

    .font-option-toolbar:first-child {
        border-radius: 8px 8px 0 0;
    }

    .font-option-toolbar:hover {
        background: var(--primary-blue-light);
        color: var(--text-primary-blue);
    }

    .font-option-toolbar.selected {
        background: var(--primary-blue-medium);
        color: var(--primary-blue);
        font-weight: 500;
    }

    /* 代码字体切换功能样式 */
    .code-font-switcher {
        position: relative;
    }

    .code-font-dropdown-toolbar {
        position: absolute;
        right: 100%;
        top: 0;
        margin-right: 8px;
        min-width: 140px;
        opacity: 0;
        visibility: hidden;
        transform: translateX(10px);
        transition: all 0.3s ease;
        z-index: 1001;
    }

    .code-font-switcher:hover .code-font-dropdown-toolbar,
    .code-font-dropdown-toolbar.active {
        opacity: 1;
        visibility: visible;
        transform: translateX(0);
    }

    .code-font-current-toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        background: var(--bg-white);
        border: 1px solid var(--border-light);
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        color: var(--text-primary);
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px var(--shadow-light);
        white-space: nowrap;
    }

    .code-font-current-toolbar:hover {
        border-color: var(--primary-blue);
        background: var(--primary-blue-light);
        box-shadow: 0 4px 12px var(--shadow-primary-medium);
    }

    .current-code-font-name-toolbar {
        font-weight: 500;
        margin-right: 8px;
    }

    .code-font-dropdown-toolbar.active .dropdown-arrow-icon {
        transform: rotate(180deg) !important;
    }

    .code-font-options-toolbar {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--bg-white);
        border: 1px solid var(--border-light);
        border-radius: 8px;
        box-shadow: 0 4px 12px var(--shadow-strong);
        z-index: 1002;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s ease;
        margin-top: 4px;
        max-height: 150px;
        overflow-y: auto;
    }

    .code-font-dropdown-toolbar.active .code-font-options-toolbar {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .code-font-option-toolbar {
        padding: 8px 12px;
        cursor: pointer;
        font-size: 13px;
        color: var(--text-primary);
        transition: all 0.2s ease;
        border-bottom: 1px solid var(--border-light);
        white-space: nowrap;
    }

    .code-font-option-toolbar:last-child {
        border-bottom: none;
        border-radius: 0 0 8px 8px;
    }

    .code-font-option-toolbar:first-child {
        border-radius: 8px 8px 0 0;
    }

    .code-font-option-toolbar:hover {
        background: var(--primary-blue-light);
        color: var(--text-primary-blue);
    }

    .code-font-option-toolbar.selected {
        background: var(--primary-blue-medium);
        color: var(--primary-blue);
        font-weight: 500;
    }

    /* 独立的切换按钮样式 */
    .toolbar-toggle-btn {
        position: fixed;
        top: 50%;
        right: 60px;
        transform: translateY(-50%);
        width: 30px;
        height: 60px;
        background: #ffffff;
        border: 1px solid #eee;
        border-right: none;
        border-radius: 8px 0 0 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        z-index: 99999;
    }

    .toolbar-toggle-btn:hover {
        background: var(--primary-blue-light) !important;
        transform: translateY(-50%) translateX(-2px) !important;
        box-shadow: -4px 0 15px rgba(0, 0, 0, 0.15) !important;
    }

    .toggle-icon {
        font-size: 16px;
        color: #666;
        transition: all 0.3s ease;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .toggle-arrow-icon {
        width: 16px !important;
        height: 16px !important;
        fill: currentColor !important;
        transition: all 0.3s ease !important;
    }

    .toolbar-toggle-btn:hover .toggle-icon {
        color: var(--primary-blue) !important;
        transform: scale(1.1) !important;
    }

    .toolbar-toggle-btn:hover .toggle-arrow-icon {
        fill: var(--primary-blue) !important;
    }

    /* 功能条隐藏状态 */
    .floating-toolbar.hidden {
        transform: translateY(-50%) translateX(100%) !important;
        opacity: 0 !important;
        visibility: hidden !important;
    }

    /* 切换按钮在功能条隐藏时的状态 */
    .toolbar-toggle-btn.toolbar-hidden {
        right: 0px !important;
        background: var(--border-white) !important;
        border-color: var(--border-white) !important;
        border-radius: 8px 0 0 8px !important;
    }

    .toolbar-toggle-btn.toolbar-hidden .toggle-icon {
        color: black !important;
        transform: rotate(180deg) !important;
    }

    .toolbar-toggle-btn.toolbar-hidden .toggle-arrow-icon {
        fill: black !important;
    }

    .toolbar-toggle-btn.toolbar-hidden:hover {
        background: var(--primary-blue-dark) !important;
        transform: translateY(-50%) translateX(-2px) !important;
    }

    /* 响应式设计 */
    @media screen and (max-width: 768px) {
        .floating-toolbar {
            min-width: 50px;
            padding: 6px 0;
        }
        
        .toolbar-item {
            padding: 10px 6px;
        }
        
        .toolbar-icon {
            font-size: 18px;
        }
        
        .theme-icon {
            width: 18px !important;
            height: 18px !important;
        }
        
        .back-to-top-icon {
            width: 18px !important;
            height: 18px !important;
        }
        
        .font-icon {
            width: 18px !important;
            height: 18px !important;
        }
        
        .toggle-arrow-icon {
            width: 14px !important;
            height: 14px !important;
        }
        
        .toolbar-label {
            font-size: 10px;
        }
        
        .font-dropdown-toolbar {
            min-width: 100px;
            margin-right: 6px;
        }
        
        .dropdown-arrow-icon {
            width: 10px !important;
            height: 10px !important;
        }
        
        .font-current-toolbar {
            padding: 6px 10px;
            font-size: 12px;
        }
    }

    @media screen and (max-width: 480px) {
        .floating-toolbar {
            right: -5px;
        }
        
        .toolbar-label {
            display: none;
        }
        
        .toolbar-item {
            padding: 8px 4px;
        }
        
        .theme-icon {
            width: 16px !important;
            height: 16px !important;
        }
        
        .back-to-top-icon {
            width: 16px !important;
            height: 16px !important;
        }
        
        .font-icon {
            width: 16px !important;
            height: 16px !important;
        }
        
        .toggle-arrow-icon {
            width: 12px !important;
            height: 12px !important;
        }
        
        .font-dropdown-toolbar {
            min-width: 90px;
            margin-right: 4px;
        }
        
        .dropdown-arrow-icon {
            width: 8px !important;
            height: 8px !important;
        }
    }

    .md-content article>*:not(.md-top):not(.md-nav) {
        animation: flyIn 0.6s ease-out forwards;
        opacity: 0;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(1) {
        animation-delay: 0.1s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(2) {
        animation-delay: 0.15s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(3) {
        animation-delay: 0.2s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(4) {
        animation-delay: 0.25s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(5) {
        animation-delay: 0.3s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(6) {
        animation-delay: 0.35s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(7) {
        animation-delay: 0.4s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(8) {
        animation-delay: 0.45s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(9) {
        animation-delay: 0.5s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(10) {
        animation-delay: 0.55s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(11) {
        animation-delay: 0.6s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(12) {
        animation-delay: 0.65s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(13) {
        animation-delay: 0.7s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(14) {
        animation-delay: 0.75s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(15) {
        animation-delay: 0.8s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(16) {
        animation-delay: 0.85s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(17) {
        animation-delay: 0.9s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(18) {
        animation-delay: 0.95s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(19) {
        animation-delay: 1s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(20) {
        animation-delay: 1.05s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(n + 21) {
        animation-delay: 1.1s;
    }

    @keyframes flyIn {
        0% {
            opacity: 0;
            transform: translateY(-20px);
        }

        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @media (prefers-reduced-motion: reduce) {
        .md-content article>*:not(.md-top):not(.md-nav) {
            animation: none !important;
            opacity: 1 !important;
            transform: none !important;
        }
    }

    /* 添加超时后强制显示内容 */
    .md-content article>*:not(.md-top):not(.md-nav) {
        animation: flyIn 0.6s ease-out forwards;
        opacity: 0;
        /* 添加延迟后的备用显示 */
        animation-fill-mode: both;
    }

    /* 确保在3秒后强制显示所有内容 */
    .md-content {
        animation: ensureVisible 0.1s ease-out 3s forwards;
    }

    @keyframes ensureVisible {
        to {
            --force-visible: 1;
        }
    }

    .md-content[style*="--force-visible"] article>*:not(.md-top):not(.md-nav) {
        opacity: 1 !important;
        transform: translateY(0) !important;
    }

    li::marker {
        color: var(--primary-blue-semi);
    }

    [data-md-toggle=search]:checked~.md-header .md-search__form {
        border-radius: 8px 8px 0px 0px;
    }

    .md-search__form {
        background: var(--primary-blue-strong);
        border-radius: 20px;
        padding: 2px;
        transition: all 0.3s ease;
    }

    .md-search__input {
        border: none;
        border-radius: 18px;
        padding: 8px 16px;
        font-size: 14px;
        transition: all 0.3s ease;
    }


    .md-search__input:hover,
    .md-search__input:focus {
        outline: none;
        box-shadow: var(--table-shadow);
        border-radius: 18px !important;
    }

    .md-search__output {
        border-radius: 0px 0px 8px 8px !important;
    }

    .md-tooltip {
        background-color: var(--overlay-dark);
        color: var(--text-white);
        border: none;
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 12px;
        box-shadow: var(--shadow-dark);
        position: relative;
    }

    .md-tooltip:after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        width: 0;
        height: 0;
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-top: 5px solid var(--overlay-dark);
    }

    :not(pre)>code {
        color: var(--text-orange) !important;
        font-weight: normal;
    }

    .highlight .c1,
    .highlight .cm {
        color: var(--text-gray);
    }

    .md-typeset .admonition,
    .md-typeset details {
        border-width: 0;
        border-left-width: 4px;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
        font-family: var(--md-header-font);
        color: var(--primary-blue) !important;
    }

    body {
        font-family: var(--md-text-font);
    }

    pre code {
        color: var(--md-code-fg-color) !important;
    }

    .highlight pre {
        background-color: var(--md-code-bg-color) !important;
    }

    .md-typeset code {
        font-family: var(--md-code-font), var(--md-text-font);
    }

    .md-tabs__item.md-tabs__item--active {
        border-bottom: 2px solid var(--primary-blue-semi);
    }

    .md-tabs__list>.md-tabs__item--active>.md-tabs__link {
        color: var(--primary-blue-semi) !important;
    }

    .timeline-content::before {
        background-color: var(--bg-gray-light);
    }

    .timeline-card {
        background-color: var(--bg-gray-light) !important;
    }

    .changelog-content a {
        color: var(--text-blue) !important;
        word-break: break-word;
    }

    .changelog-content a:focus,
    .changelog-content a:hover {
        color: var(--text-teal) !important;
    }

    .changelog-type-pageupdate {
        background-color: var(--primary-blue-semi) !important;
    }

    .md-footer-runtime {
        position: relative;
        z-index: 3;
        margin: 0.5rem 0;
        padding: 0.4rem 0;
        font-size: 0.7rem;
        line-height: 1.6;
        color: var(--md-footer-fg-color--light);
        display: flex;
        align-items: center;
    }

    ::selection {
        background: var(--primary-blue-strong);
    }

    html {
        scroll-behavior: smooth !important;
        /* 强制启用平滑滚动 */
        scroll-padding-top: 53px;
        /* 设置滚动偏移量,避免标题被导航栏遮挡 */
    }

    strong {
        color: var(--text-purple);
    }

    a[href^="#"],
    a[href*="/#"] {
        scroll-behavior: smooth !important;
    }

    .custom-tooltip {
        position: relative;
        display: inline-block;
        cursor: help;
        color: var(--primary-blue-semi);
        border-bottom: 1px dashed var(--primary-blue-semi);
        text-decoration: none !important;
    }

    .custom-tooltip::before {
        content: attr(data-title);
        position: absolute;
        width: 300px;
        background-color: var(--overlay-dark);
        color: var(--text-white);
        text-align: left;
        padding: 10px;
        border-radius: 6px;
        bottom: 125%;
        /* 定位在链接上方 */
        left: 50%;
        transform: translateX(-50%);
        z-index: 99999;
        /* 确保显示在最上层 */
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s;
        font-weight: normal;
        font-size: 14px;
        line-height: 1.5;
        pointer-events: none;
        box-shadow: var(--shadow-dark);
        word-wrap: break-word;
        white-space: normal;
    }

    .custom-tooltip::after {
        content: "";
        position: absolute;
        bottom: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: var(--overlay-dark) transparent transparent transparent;
        z-index: 99999;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s;
        pointer-events: none;
    }

    .custom-tooltip:hover::before {
        opacity: 1;
        visibility: visible;
    }

    .custom-tooltip:hover::after {
        opacity: 1;
        visibility: visible;
    }

    /* 修改移动设备上的 tooltip 样式，确保不会溢出屏幕 */
    @media (max-width: 767px) {
        .custom-tooltip::before {
            width: calc(100vw - 40px);
            max-width: 250px;
            white-space: normal;
            font-size: 14px;
            left: 50%;
            transform: translateX(-50%);
            bottom: 130%;
            /* 确保不会超出屏幕边缘 */
            box-sizing: border-box;

            /* 新增：定位逻辑调整，防止溢出 */
            position: fixed;
            top: auto;
            bottom: auto;
            left: 20px;
            /* 距离左边缘固定距离 */
            right: 20px;
            /* 距离右边缘固定距离 */
            transform: none;
            margin-top: -120px;
            /* 在目标元素上方显示，可根据需要调整 */
            width: auto;
            /* 宽度由left和right决定 */
        }

        /* 新增：处理靠近页面底部的 tooltip */
        .custom-tooltip:hover::before {
            max-height: 80vh;
            /* 最大高度限制 */
            overflow-y: auto;
            /* 内容过多时可滚动 */
        }
    }

    .md-content a.custom-tooltip::after {
        display: none !important;
    }

    @media screen and (max-width: 767px) {

        /* 移除可能导致问题的现有样式 */
        .md-typeset .arithmatex {
            max-width: 100%;
            overflow-x: hidden;
            text-overflow: ellipsis;
        }

        /* 修改为更有效的样式 */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.25em 0;
        }

        /* 对于行内公式的新样式 */
        .katex {
            font-size: 1em !important;
            /* 减小字体大小 */
        }

        /* 调整整体数学公式容器的样式 */
        .md-typeset .arithmatex {
            max-width: 100% !important;
            overflow-x: auto;
            padding: 0.1em 0;
            margin: 0;
        }

        /* 确保行内公式不破坏布局 */
        .katex-inline {
            display: inline-block;
            max-width: 100%;
            overflow-x: auto;
            vertical-align: middle;
            white-space: normal;
            line-break: anywhere;
        }

        /* 添加淡出效果指示可滚动 */
        .katex-display::after {
            content: "";
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 20px;
            background: linear-gradient(to right,
                    rgba(255, 255, 255, 0),
                    rgba(255, 255, 255, 0.7));
            pointer-events: none;
        }
    }

    /* 头像样式 - 增强版，添加悬浮区域控制 */
    .header-avatar {
        display: inline-flex;
        align-items: center;
        margin-right: 0.8rem;
        position: relative;
        z-index: 1;
        /* 添加一个内边距以增加可点击区域，但不会影响布局 */
        padding: 3px;
    }

    .header-avatar img {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        position: relative;
        z-index: 5;
    }

    /* 下拉菜单样式 - 增强版，改进悬浮区域控制 */
    .avatar-dropdown {
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%) translateY(25px) scale(0.95);
        background-color: var(--bg-white);
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.18);
        padding: 45px 0 8px 0;
        /* 增加更多顶部内边距 */
        min-width: 140px;
        opacity: 0;
        visibility: hidden;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        z-index: 4;
        /* 低于头像 */
        margin-top: -10px;
        /* 让菜单上移覆盖头像下半部分 */
        /* 添加一个缓冲区，防止鼠标离开时闪烁 */
        pointer-events: none;
    }

    /* 悬停效果，修改触发条件和过渡延迟 */
    .header-avatar:hover .avatar-dropdown {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(15px) scale(1);
        /* 添加延迟以防止闪烁 */
        transition-delay: 0.05s;
        pointer-events: auto;
    }

    /* 添加间隙区域保持悬停状态 */
    .avatar-dropdown::after {
        content: "";
        position: absolute;
        top: -20px;
        /* 创建顶部缓冲区 */
        left: 0;
        width: 100%;
        height: 20px;
        background: transparent;
    }

    .header-avatar:hover img {
        transform: scale(1.5) translateY(18px);
        /* 放大并稍微向下移动 */
        box-shadow: 0 6px 16px rgba(77, 166, 218, 0.35);
        border-color: var(--primary-blue-semi);
        /* 添加延迟以防止闪烁 */
        transition-delay: 0s;
    }

    /* 菜单三角形指示器 - 隐藏，因为视觉上头像已经作为指示器 */
    .avatar-dropdown::before {
        display: none;
    }

    /* 菜单项样式 */
    .avatar-dropdown-item {
        display: block;
        padding: 10px 16px;
        color: var(--text-primary);
        font-size: 14px;
        text-decoration: none;
        transition: all 0.25s ease;
        text-align: center;
        position: relative;
        white-space: nowrap;
    }

    .avatar-dropdown p {
        padding: 10px 16px;
        color: var(--text-primary);
        font-size: 16px;
        text-align: center;
        white-space: nowrap;
    }

    .avatar-dropdown-item:hover {
        background-color: rgba(77, 166, 218, 0.08);
        color: var(--primary-blue-semi);
    }

    .avatar-dropdown-item:hover::after {
        content: "";
        position: absolute;
        left: 8px;
        width: 3px;
        height: 70%;
        background: var(--primary-blue-semi);
        border-radius: 2px;
        top: 15%;
    }

    .avatar-dropdown-divider {
        height: 1px;
        background-color: rgba(0, 0, 0, 0.06);
        margin: 4px 8px;
    }

    /* 响应式设计调整 */
    @media screen and (max-width: 1199px) {
        .header-avatar {
            margin-right: 0.5rem;
        }
    }

    /* 响应式设计调整 */
    @media screen and (max-width: 1200px) {
        .header-avatar {
            margin-right: 0.3rem;
            padding: 2px;
        }

        .header-avatar img {
            width: 32px;
            height: 32px;
        }

        /* 调整菜单位置，靠左侧显示 */
        .avatar-dropdown {
            /* 调整left确保显示在左侧 */
            left: -120px;
            transform: translateX(0) translateY(25px) scale(0.95);
            padding-top: 15px;
            margin-top: 0;
            min-width: 130px;
            position: absolute;
            z-index: 100;
        }

        /* 点击时的行为，而不是悬停 */
        .header-avatar:hover .avatar-dropdown {
            transform: translateX(0) translateY(5px) scale(1);
        }

        /* 移动端头像不放大，防止页面移动 */
        .header-avatar:hover img {
            transform: none;
            border-color: var(--primary-blue-semi);
            box-shadow: 0 4px 12px rgba(77, 166, 218, 0.3);
        }

        /* 调整导航栏布局 */
        .md-header__inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* 确保下拉菜单不遮挡其他元素 */
        .avatar-dropdown {
            max-width: 85vw;
        }
    }

    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #999;
    }

    /* 主题切换蒙版 - 优化结构和性能 */
    .theme-transition-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--bg-white);
        z-index: 100000;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        display: flex;
        align-items: center;
        justify-content: center;
        /* 简化过渡效果，提高性能 */
        transition: opacity 0.3s ease-out, visibility 0.3s ease-out,
            background-color 0.3s ease-out, backdrop-filter 0.3s ease-out;
        backdrop-filter: blur(0px);
    }

    .theme-transition-overlay.active {
        opacity: 1;
        visibility: visible;
        pointer-events: all;
        backdrop-filter: blur(5px);
    }

    /* 主题切换内容容器 - 整合样式 */
    .theme-transition-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 20px;
        transform: scale(0.9);
        opacity: 0;
        transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1),
            opacity 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .theme-transition-overlay.active .theme-transition-content {
        transform: scale(1);
        opacity: 1;
    }

    /* 简化加载图标结构，移除不必要的嵌套 */
    .theme-transition-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(77, 166, 218, 0.2);
        border-top-color: var(--primary-blue-semi);
        border-radius: 50%;
        animation: none;
        transition: opacity 0.3s ease;
    }

    .theme-transition-overlay.active .theme-transition-spinner {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    /* 主题切换文字样式 */
    .theme-transition-text {
        font-family: var(--md-text-font);
        color: var(--primary-blue-semi);
        font-size: 16px;
        font-weight: 500;
        text-align: center;
        margin-top: 10px;
    }

    /* 页脚爱情宣言样式 */
    .md-footer-love {
        position: relative;
        font-family: var(--md-header-font) !important;
        font-size: 0.9rem;
        line-height: 1.6;
        margin: 0.5rem 0;
        padding: 0.5rem 1rem;
        color: rgba(255, 255, 255, 0.85);
        text-align: center;
        border-radius: 8px;
        background: linear-gradient(135deg,
                rgba(255, 255, 255, 0.1),
                rgba(255, 255, 255, 0.05));
        backdrop-filter: blur(4px);
        transition: all 0.4s ease;
        overflow: hidden;
        border-left: 3px solid rgba(255, 182, 193, 0.6);
    }

    .md-footer-love:hover {
        background: linear-gradient(135deg,
                rgba(255, 182, 193, 0.2),
                rgba(255, 255, 255, 0.1));
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 182, 193, 0.15);
    }

    /* 添加闪烁星星效果 */
    .md-footer-love::before,
    .md-footer-love::after {
        content: "★";
        position: absolute;
        opacity: 0;
        font-size: 0.8rem;
        color: rgba(255, 223, 223, 0.8);
        animation: twinkle 3s ease-in-out infinite alternate;
    }

    .md-footer-love::before {
        left: 0.5rem;
        top: 0.4rem;
        animation-delay: 0s;
    }

    .md-footer-love::after {
        right: 0.5rem;
        top: 0.4rem;
        animation-delay: 1.5s;
    }

    @keyframes twinkle {
        0% {
            opacity: 0.3;
            transform: scale(0.8);
        }

        50% {
            opacity: 0.9;
            transform: scale(1.2);
        }

        100% {
            opacity: 0.3;
            transform: scale(0.8);
        }
    }

    /* 名字高亮显示 */
    .love-highlight {
        font-weight: 500;
        background: linear-gradient(120deg, #ffb6c1, #ffc0cb);
        background-clip: text;
        -webkit-background-clip: text;
        color: transparent;
        padding: 0 0.2rem;
        position: relative;
        white-space: nowrap;
    }

    /* 添加心跳动画效果 */
    .love-heart {
        display: inline-block;
        font-size: 0.9em;
        color: rgba(255, 182, 193, 0.9);
        transform-origin: center;
        margin: 0 0.2rem;
        animation: heartbeat 1.5s ease-in-out infinite;
    }

    @keyframes heartbeat {
        0% {
            transform: scale(1);
        }

        15% {
            transform: scale(1.25);
        }

        30% {
            transform: scale(1);
        }

        45% {
            transform: scale(1.25);
        }

        60% {
            transform: scale(1);
        }

        100% {
            transform: scale(1);
        }
    }

    /* 添加响应式样式 - 平板设备 */
    @media screen and (max-width: 1199px) {
        .md-footer-love {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
            margin: 0.4rem 0;
        }

        .md-footer-love::before,
        .md-footer-love::after {
            font-size: 0.7rem;
        }
    }

    /* 添加响应式样式 - 移动设备 */
    @media screen and (max-width: 767px) {
        .md-footer-love {
            font-size: 0.75rem;
            padding: 0.3rem 0.5rem;
            margin: 0.3rem 0;
            border-radius: 6px;
            max-width: 90%;
            margin-left: auto;
            margin-right: auto;
            border-left-width: 2px;
        }

        .md-footer-love:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(255, 182, 193, 0.12);
        }

        .md-footer-love::before,
        .md-footer-love::after {
            font-size: 0.6rem;
        }

        .love-heart {
            font-size: 0.8em;
        }

        /* 在非常小的屏幕上隐藏星星效果 */
        @media screen and (max-width: 360px) {

            .md-footer-love::before,
            .md-footer-love::after {
                display: none;
            }
        }
    }

    /* Atom One Light 语法高亮样式 - 仅覆盖代码块语法高亮 */
    .highlight .hll {
        background-color: var(--code-bg) !important;
    }

    .highlight .c {
        color: var(--code-comment) !important;
    }

    /* Comment */
    .highlight .err {
        color: var(--code-string) !important;
    }

    /* Error */
    .highlight .k {
        color: var(--code-keyword) !important;
    }

    /* Keyword */
    .highlight .l {
        color: var(--code-number) !important;
    }

    /* Literal */
    .highlight .n {
        color: var(--code-text) !important;
    }

    /* Name */
    .highlight .o {
        color: var(--code-text) !important;
    }

    /* Operator */
    .highlight .p {
        color: var(--code-text) !important;
    }

    /* Punctuation */
    .highlight .ch {
        color: var(--code-comment) !important;
    }

    /* Comment.Hashbang */
    .highlight .cm {
        color: var(--code-comment) !important;
    }

    /* Comment.Multiline */
    .highlight .cp {
        color: var(--code-keyword) !important;
    }

    /* Comment.Preproc */
    .highlight .cpf {
        color: var(--code-string) !important;
    }

    /* Comment.PreprocFile */
    .highlight .c1 {
        color: var(--code-comment) !important;
    }

    /* Comment.Single */
    .highlight .cs {
        color: var(--code-comment) !important;
    }

    /* Comment.Special */
    .highlight .gd {
        color: var(--code-string) !important;
    }

    /* Generic.Deleted */
    .highlight .ge {}

    /* Generic.Emph */
    .highlight .gr {
        color: var(--code-string) !important;
    }

    /* Generic.Error */
    .highlight .gh {
        color: var(--code-function) !important;
        font-weight: bold !important;
    }

    /* Generic.Heading */
    .highlight .gi {
        color: var(--code-string) !important;
    }

    /* Generic.Inserted */
    .highlight .go {
        color: var(--code-text) !important;
    }

    /* Generic.Output */
    .highlight .gp {
        color: var(--code-text) !important;
    }

    /* Generic.Prompt */
    .highlight .gs {
        font-weight: bold !important;
    }

    /* Generic.Strong */
    .highlight .gu {
        color: var(--code-function) !important;
        font-weight: bold !important;
    }

    /* Generic.Subheading */
    .highlight .gt {
        color: var(--code-string) !important;
    }

    /* Generic.Traceback */
    .highlight .kc {
        color: var(--code-keyword) !important;
    }

    /* Keyword.Constant */
    .highlight .kd {
        color: var(--code-keyword) !important;
    }

    /* Keyword.Declaration */
    .highlight .kn {
        color: var(--code-keyword) !important;
    }

    /* Keyword.Namespace */
    .highlight .kp {
        color: var(--code-keyword) !important;
    }

    /* Keyword.Pseudo */
    .highlight .kr {
        color: var(--code-keyword) !important;
    }

    /* Keyword.Reserved */
    .highlight .kt {
        color: var(--code-class) !important;
    }

    /* Keyword.Type */
    .highlight .ld {
        color: var(--code-builtin) !important;
    }

    /* Literal.Date */
    .highlight .m {
        color: var(--code-number) !important;
    }

    /* Literal.Number */
    .highlight .s {
        color: var(--code-builtin) !important;
    }

    /* Literal.String */
    .highlight .na {
        color: var(--code-class) !important;
    }

    /* Name.Attribute */
    .highlight .nb {
        color: var(--code-class) !important;
    }

    /* Name.Builtin */
    .highlight .nc {
        color: var(--code-class) !important;
    }

    /* Name.Class */
    .highlight .no {
        color: var(--code-string) !important;
    }

    /* Name.Constant */
    .highlight .nd {
        color: var(--code-function) !important;
    }

    /* Name.Decorator */
    .highlight .ni {
        color: var(--code-text) !important;
    }

    /* Name.Entity */
    .highlight .ne {
        color: var(--code-string) !important;
    }

    /* Name.Exception */
    .highlight .nf {
        color: var(--code-function) !important;
    }

    /* Name.Function */
    .highlight .nl {
        color: var(--code-text) !important;
    }

    /* Name.Label */
    .highlight .nn {
        color: var(--code-text) !important;
    }

    /* Name.Namespace */
    .highlight .nx {
        color: var(--code-function) !important;
    }

    /* Name.Other */
    .highlight .py {
        color: var(--code-text) !important;
    }

    /* Name.Property */
    .highlight .nt {
        color: var(--code-variable) !important;
    }

    /* Name.Tag */
    .highlight .nv {
        color: var(--code-string) !important;
    }

    /* Name.Variable */
    .highlight .ow {
        color: var(--code-keyword) !important;
    }

    /* Operator.Word */
    .highlight .w {
        color: var(--code-text) !important;
    }

    /* Text.Whitespace */
    .highlight .mb {
        color: var(--code-number) !important;
    }

    /* Literal.Number.Bin */
    .highlight .mf {
        color: var(--code-number) !important;
    }

    /* Literal.Number.Float */
    .highlight .mh {
        color: var(--code-number) !important;
    }

    /* Literal.Number.Hex */
    .highlight .mi {
        color: var(--code-number) !important;
    }

    /* Literal.Number.Integer */
    .highlight .mo {
        color: var(--code-number) !important;
    }

    /* Literal.Number.Oct */
    .highlight .sa {
        color: var(--code-builtin) !important;
    }

    /* Literal.String.Affix */
    .highlight .sb {
        color: var(--code-builtin) !important;
    }

    /* Literal.String.Backtick */
    .highlight .sc {
        color: var(--code-builtin) !important;
    }

    /* Literal.String.Char */
    .highlight .dl {
        color: var(--code-builtin) !important;
    }

    /* Literal.String.Delimiter */
    .highlight .sd {
        color: var(--code-comment) !important;
    }

    /* Literal.String.Doc */
    .highlight .s2 {
        color: var(--code-builtin) !important;
    }

    /* Literal.String.Double */
    .highlight .se {
        color: var(--code-function) !important;
    }

    /* Literal.String.Escape */
    .highlight .sh {
        color: var(--code-builtin) !important;
    }

    /* Literal.String.Heredoc */
    .highlight .si {
        color: var(--code-function) !important;
    }

    /* Literal.String.Interpol */
    .highlight .sx {
        color: var(--code-builtin) !important;
    }

    /* Literal.String.Other */
    .highlight .sr {
        color: var(--code-builtin) !important;
    }

    /* Literal.String.Regex */
    .highlight .s1 {
        color: var(--code-builtin) !important;
    }

    /* Literal.String.Single */
    .highlight .ss {
        color: var(--code-builtin) !important;
    }

    /* Literal.String.Symbol */
    .highlight .bp {
        color: var(--code-class) !important;
    }

    /* Name.Builtin.Pseudo */
    .highlight .fm {
        color: var(--code-function) !important;
    }

    /* Name.Function.Magic */
    .highlight .vc {
        color: var(--code-string) !important;
    }

    /* Name.Variable.Class */
    .highlight .vg {
        color: var(--code-string) !important;
    }

    /* Name.Variable.Global */
    .highlight .vi {
        color: var(--code-string) !important;
    }

    /* Name.Variable.Instance */
    .highlight .vm {
        color: var(--code-string) !important;
    }

    /* Name.Variable.Magic */
    .highlight .il {
        color: var(--code-number) !important;
    }

    /* Literal.Number.Integer.Long */

    /* 特殊语言的额外样式调整 */
    .highlight[data-lang="json"] .nt {
        color: var(--code-variable) !important;
    }

    /* JSON keys */
    .highlight[data-lang="yaml"] .na {
        color: var(--code-variable) !important;
    }

    /* YAML keys */
    .highlight[data-lang="yml"] .na {
        color: var(--code-variable) !important;
    }

    /* YAML keys */
    .highlight[data-lang="xml"] .nt {
        color: var(--code-variable) !important;
    }

    /* XML tags */
    .highlight[data-lang="html"] .nt {
        color: var(--code-variable) !important;
    }

    /* HTML tags */

    /* CSS特殊处理 */
    .highlight[data-lang="css"] .nc {
        color: var(--code-class) !important;
    }

    /* CSS class selectors */
    .highlight[data-lang="css"] .nf {
        color: var(--code-function) !important;
    }

    /* CSS functions */
    .highlight[data-lang="css"] .nt {
        color: var(--code-variable) !important;
    }

    /* CSS element selectors */
    .highlight[data-lang="css"] .nd {
        color: var(--code-keyword) !important;
    }

    /* CSS pseudo-classes */

    /* JavaScript特殊处理 */
    .highlight[data-lang="javascript"] .nx {
        color: var(--code-function) !important;
    }

    /* JS functions and variables */
    .highlight[data-lang="js"] .nx {
        color: var(--code-function) !important;
    }

    /* JS functions and variables */

    /* Python特殊处理 */
    .highlight[data-lang="python"] .nd {
        color: var(--code-function) !important;
    }

    /* Python decorators */
    .highlight[data-lang="python"] .nf {
        color: var(--code-function) !important;
    }

    /* Python functions */
    .highlight[data-lang="python"] .nc {
        color: var(--code-class) !important;
    }

    /* Python classes */

    /* Shell/Bash特殊处理 */
    .highlight[data-lang="bash"] .nv {
        color: var(--code-string) !important;
    }

    /* Bash variables */
    .highlight[data-lang="shell"] .nv {
        color: var(--code-string) !important;
    }

    /* Shell variables */
    .highlight[data-lang="sh"] .nv {
        color: var(--code-string) !important;
    }

    /* Shell variables */

    /* C/C++特殊处理 */
    .highlight[data-lang="c"] .kt {
        color: var(--code-keyword) !important;
    }

    /* C types */
    .highlight[data-lang="cpp"] .kt {
        color: var(--code-keyword) !important;
    }

    /* C++ types */
    .highlight[data-lang="c++"] .kt {
        color: var(--code-keyword) !important;
    }

    /* C++ types */

    /* Java特殊处理 */
    .highlight[data-lang="java"] .nc {
        color: var(--code-class) !important;
    }

    /* Java classes */
    .highlight[data-lang="java"] .kt {
        color: var(--code-keyword) !important;
    }

    /* Java types */
</style><script>
    // 字体配置
    const fontConfig = {
        "dongguanti": {
            name: "上图东观体",
            id: "font-dongguanti"
        },
        "oppoti": {
            name: "OPPO Sans",
            id: "font-oppoti"
        },
        "jiangchengti": {
            name: "江城黑体",
            id: "font-jiangchengti"
        },
        "lxgw": {
            name: "霞鹜臻楷",
            id: "font-lxgw"
        }
    };

    // 代码字体配置
    const codeFontConfig = {
        "dejavu": {
            name: "DejaVu Sans Mono",
            id: "code-font-dejavu-sans-mono"
        },
        "zsft": {
            name: "JetBrains Mono",
            id: "code-font-zsft-hk"
        }
    };

    // 立即应用保存的字体设置（与主题初始化方式一致）
    (function initFont() {
        const savedFont = localStorage.getItem("preferred-font") || "dongguanti";
        
        // 禁用所有字体样式表
        Object.values(fontConfig).forEach(font => {
            const link = document.getElementById(font.id);
            if (link) {
                link.setAttribute("disabled", "true");
            }
        });
        
        // 启用选中的字体样式表
        const selectedFontLink = document.getElementById(fontConfig[savedFont].id);
        if (selectedFontLink) {
            selectedFontLink.removeAttribute("disabled");
        }
    })();

    // 立即应用保存的代码字体设置
    (function initCodeFont() {
        const savedCodeFont = localStorage.getItem("preferred-code-font") || "dejavu";
        
        // 禁用所有代码字体样式表
        Object.values(codeFontConfig).forEach(font => {
            const link = document.getElementById(font.id);
            if (link) {
                link.setAttribute("disabled", "true");
            }
        });
        
        // 启用选中的代码字体样式表
        const selectedCodeFontLink = document.getElementById(codeFontConfig[savedCodeFont].id);
        if (selectedCodeFontLink) {
            selectedCodeFontLink.removeAttribute("disabled");
        }
    })();

    document.addEventListener("DOMContentLoaded", () => {
        const savedTheme = localStorage.getItem("preferred-theme") || "theme1";
        const savedFont = localStorage.getItem("preferred-font") || "dongguanti";
        const savedCodeFont = localStorage.getItem("preferred-code-font") || "dejavu";

        // 初始化功能条字体下拉菜单和字体设置
        updateFontDropdownToolbar(savedFont);
        applyFont(savedFont);
        
        // 初始化功能条代码字体下拉菜单和代码字体设置
        updateCodeFontDropdownToolbar(savedCodeFont);
        applyCodeFont(savedCodeFont);
        
        // 初始化功能条状态
        initToolbarState();

        const initialTheme = localStorage.getItem("preferred-theme");
        if (initialTheme) {
            const theme1Link = document.querySelector('link[href*="theme1"]');
            const theme2Link = document.querySelector('link[href*="theme2"]');

            // 关闭过渡动画，直接设置主题
            if (initialTheme === "theme1") {
                theme1Link.removeAttribute("disabled");
                theme2Link.setAttribute("disabled", "true");
            } else {
                theme2Link.removeAttribute("disabled");
                theme1Link.setAttribute("disabled", "true");
            }
        }

        // 添加加载完成后的检测
        setTimeout(() => {
            const hiddenElements = document.querySelectorAll('.md-content article>*[style*="opacity: 0"]');
            hiddenElements.forEach(el => {
                el.style.opacity = '1';
                el.style.transform = 'translateY(0)';
            });
        }, 2000); // 2秒后强制显示所有隐藏元素
    });

    (function initTheme() {
        const savedTheme = localStorage.getItem("preferred-theme");
        if (savedTheme) {
            const theme1Link = document.querySelector('link[href*="theme1"]');
            const theme2Link = document.querySelector('link[href*="theme2"]');
            if (theme1Link && theme2Link) {
                if (savedTheme === "theme1") {
                    theme1Link.removeAttribute("disabled");
                    theme2Link.setAttribute("disabled", "true");
                } else {
                    theme2Link.removeAttribute("disabled");
                    theme1Link.setAttribute("disabled", "true");
                }
            }
        }
    })();

    // 通用下拉菜单切换函数
    function toggleDropdown(targetSelector, otherSelector) {
        const dropdown = document.querySelector(targetSelector);
        const otherDropdown = document.querySelector(otherSelector);
        const isActive = dropdown.classList.contains('active');
        
        if (isActive) {
            dropdown.classList.remove('active');
            return;
        }
        
        // 如果其他下拉菜单打开，先关闭并等待过渡完成
        if (otherDropdown && otherDropdown.classList.contains('active')) {
            const handleTransitionEnd = (event) => {
                if (event.target === otherDropdown && (event.propertyName === 'opacity' || event.propertyName === 'transform')) {
                    otherDropdown.removeEventListener('transitionend', handleTransitionEnd);
                    dropdown.classList.add('active');
                }
            };
            
            otherDropdown.addEventListener('transitionend', handleTransitionEnd);
            otherDropdown.classList.remove('active');
            
            // 超时保护
            setTimeout(() => {
                otherDropdown.removeEventListener('transitionend', handleTransitionEnd);
                if (!dropdown.classList.contains('active')) {
                    dropdown.classList.add('active');
                }
            }, 350);
        } else {
            dropdown.classList.add('active');
        }
    }

    // 字体下拉菜单功能
    function toggleFontDropdownToolbar() {
        toggleDropdown('.font-dropdown-toolbar', '.code-font-dropdown-toolbar');
    }

    // 代码字体下拉菜单功能
    function toggleCodeFontDropdownToolbar() {
        toggleDropdown('.code-font-dropdown-toolbar', '.font-dropdown-toolbar');
    }

    // 通用字体应用函数
    function applyFontStyle(config, fontKey, storageKey) {
        // 禁用所有字体样式表
        Object.values(config).forEach(font => {
            const link = document.getElementById(font.id);
            if (link) link.setAttribute("disabled", "true");
        });
        
        // 启用选中的字体样式表
        const selectedLink = document.getElementById(config[fontKey].id);
        if (selectedLink) selectedLink.removeAttribute("disabled");
        
        // 保存设置
        localStorage.setItem(storageKey, fontKey);
    }

    // 通用下拉菜单更新函数
    function updateDropdownDisplay(config, fontKey, nameSelector, optionSelector, dataAttr) {
        const nameEl = document.querySelector(nameSelector);
        const options = document.querySelectorAll(optionSelector);
        
        if (nameEl) nameEl.textContent = config[fontKey].name;
        
        options.forEach(option => {
            const key = option.getAttribute(dataAttr);
            option.classList.toggle('selected', key === fontKey);
        });
    }

    // 字体选择
    function selectFontToolbar(fontKey) {
        applyFontStyle(fontConfig, fontKey, "preferred-font");
        updateDropdownDisplay(fontConfig, fontKey, ".current-font-name-toolbar", ".font-option-toolbar", "data-font");
        document.querySelector('.font-dropdown-toolbar').classList.remove('active');
    }

    // 代码字体选择
    function selectCodeFontToolbar(codeFontKey) {
        applyFontStyle(codeFontConfig, codeFontKey, "preferred-code-font");
        updateDropdownDisplay(codeFontConfig, codeFontKey, ".current-code-font-name-toolbar", ".code-font-option-toolbar", "data-code-font");
        document.querySelector('.code-font-dropdown-toolbar').classList.remove('active');
    }

    // 应用字体（保持向后兼容）
    function applyFont(fontKey) {
        applyFontStyle(fontConfig, fontKey, "preferred-font");
    }

    // 应用代码字体（保持向后兼容）
    function applyCodeFont(codeFontKey) {
        applyFontStyle(codeFontConfig, codeFontKey, "preferred-code-font");
    }

    // 更新字体下拉菜单显示（保持向后兼容）
    function updateFontDropdownToolbar(currentFontKey) {
        updateDropdownDisplay(fontConfig, currentFontKey, ".current-font-name-toolbar", ".font-option-toolbar", "data-font");
    }

    // 更新代码字体下拉菜单显示（保持向后兼容）
    function updateCodeFontDropdownToolbar(currentCodeFontKey) {
        updateDropdownDisplay(codeFontConfig, currentCodeFontKey, ".current-code-font-name-toolbar", ".code-font-option-toolbar", "data-code-font");
    }

    // 返回顶部功能
    function scrollToTop() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }

    // 功能条切换功能
    function toggleToolbar() {
        const toolbar = document.getElementById('floatingToolbar');
        const toggleBtn = document.getElementById('toolbarToggleBtn');
        
        if (!toolbar || !toggleBtn) {
            console.error('无法找到功能条或切换按钮元素');
            return;
        }
        
        const isHidden = toolbar.classList.contains('hidden');
        
        if (isHidden) {
            // 显示功能条
            toolbar.classList.remove('hidden');
            toggleBtn.classList.remove('toolbar-hidden');
            localStorage.setItem('toolbar-visible', 'true');
        } else {
            // 隐藏功能条
            toolbar.classList.add('hidden');
            toggleBtn.classList.add('toolbar-hidden');
            localStorage.setItem('toolbar-visible', 'false');
        }
    }

    // 初始化功能条状态
    function initToolbarState() {
        const toolbar = document.getElementById('floatingToolbar');
        const toggleBtn = document.getElementById('toolbarToggleBtn');
        const isVisible = localStorage.getItem('toolbar-visible');
        
        if (!toolbar || !toggleBtn) {
            return;
        }
        
        // 如果之前设置为隐藏，则保持隐藏状态
        if (isVisible === 'false') {
            toolbar.classList.add('hidden');
            toggleBtn.classList.add('toolbar-hidden');
        } else {
            // 默认显示
            toolbar.classList.remove('hidden');
            toggleBtn.classList.remove('toolbar-hidden');
        }
    }

    // 隐藏所有子菜单的通用函数
    function hideAllSubmenus() {
        const fontDropdown = document.querySelector('.font-dropdown-toolbar');
        if (fontDropdown) {
            fontDropdown.classList.remove('active');
        }
        
        const codeFontDropdown = document.querySelector('.code-font-dropdown-toolbar');
        if (codeFontDropdown) {
            codeFontDropdown.classList.remove('active');
        }
        // 如果将来有其他子菜单，可以在这里添加
    }

    // 点击外部关闭下拉菜单
    document.addEventListener('click', function(event) {
        const fontDropdown = document.querySelector('.font-dropdown-toolbar');
        const codeFontDropdown = document.querySelector('.code-font-dropdown-toolbar');
        
        // 如果点击的不是字体下拉菜单内部，则关闭字体下拉菜单
        const fontSwitcher = document.querySelector('.font-switcher');
        if (fontSwitcher && fontDropdown && !fontSwitcher.contains(event.target)) {
            fontDropdown.classList.remove('active');
        }
        
        // 如果点击的不是代码字体下拉菜单内部，则关闭代码字体下拉菜单
        const codeFontSwitcher = document.querySelector('.code-font-switcher');
        if (codeFontSwitcher && codeFontDropdown && !codeFontSwitcher.contains(event.target)) {
            codeFontDropdown.classList.remove('active');
        }
    });

    // 为功能区的其他功能添加点击和悬浮事件监听器
    document.addEventListener('DOMContentLoaded', function() {
        const toolbarItems = document.querySelectorAll('.toolbar-item:not(.font-switcher):not(.code-font-switcher)');
        
        toolbarItems.forEach(item => {
            // 点击其他功能时隐藏子菜单
            item.addEventListener('click', function() {
                hideAllSubmenus();
            });
            
            // 鼠标悬浮在其他功能时隐藏子菜单
            item.addEventListener('mouseenter', function() {
                hideAllSubmenus();
            });
        });
        
        // 延迟隐藏的定时器
        let fontDropdownTimer = null;
        let codeFontDropdownTimer = null;
        
        // 为字体切换器添加鼠标事件监听器
        const fontSwitcher = document.querySelector('.font-switcher');
        if (fontSwitcher) {
            fontSwitcher.addEventListener('mouseleave', function() {
                // 清除之前的定时器
                if (fontDropdownTimer) {
                    clearTimeout(fontDropdownTimer);
                }
                
                // 设置延迟隐藏
                fontDropdownTimer = setTimeout(function() {
                    const fontDropdown = document.querySelector('.font-dropdown-toolbar');
                    if (fontDropdown) {
                        fontDropdown.classList.remove('active');
                    }
                }, 300); // 300ms延迟
            });
            
            // 鼠标重新进入时取消隐藏
            fontSwitcher.addEventListener('mouseenter', function() {
                if (fontDropdownTimer) {
                    clearTimeout(fontDropdownTimer);
                    fontDropdownTimer = null;
                }
            });
        }
        
        // 为代码字体切换器添加鼠标事件监听器
        const codeFontSwitcher = document.querySelector('.code-font-switcher');
        if (codeFontSwitcher) {
            codeFontSwitcher.addEventListener('mouseleave', function() {
                // 清除之前的定时器
                if (codeFontDropdownTimer) {
                    clearTimeout(codeFontDropdownTimer);
                }
                
                // 设置延迟隐藏
                codeFontDropdownTimer = setTimeout(function() {
                    const codeFontDropdown = document.querySelector('.code-font-dropdown-toolbar');
                    if (codeFontDropdown) {
                        codeFontDropdown.classList.remove('active');
                    }
                }, 150); // 300ms延迟
            });
            
            // 鼠标重新进入时取消隐藏
            codeFontSwitcher.addEventListener('mouseenter', function() {
                if (codeFontDropdownTimer) {
                    clearTimeout(codeFontDropdownTimer);
                    codeFontDropdownTimer = null;
                }
            });
        }
    });

    function switchTheme() {
        // 获取当前和目标主题信息
        const currentTheme =
            localStorage.getItem("preferred-theme") || "theme1";
        const newTheme = currentTheme === "theme1" ? "theme2" : "theme1";
        const targetThemeText = newTheme === "theme1" ? "新版主题" : "原生主题";

        // 获取主题样式链接
        const theme1Link = document.querySelector('link[href*="theme1"]');
        const theme2Link = document.querySelector('link[href*="theme2"]');

        if (!theme1Link || !theme2Link) {
            console.error("无法找到主题样式链接");
            return;
        }

        // 创建和添加过渡覆盖层
        const overlay = document.createElement("div");
        overlay.className = "theme-transition-overlay";
        overlay.innerHTML = `
        <div class="theme-transition-content">
            <div class="theme-transition-spinner"></div>
            <div class="theme-transition-text">正在切换到：${targetThemeText}</div>
        </div>
    `;
        document.body.appendChild(overlay);

        // 确保DOM已更新后再添加active类
        requestAnimationFrame(() => {
            // 激活蒙版
            overlay.classList.add("active");

            // 添加适当的延迟以确保蒙版已完全显示
            setTimeout(() => {
                // 切换主题样式
                if (newTheme === "theme1") {
                    theme1Link.removeAttribute("disabled");
                    theme2Link.setAttribute("disabled", "true");
                } else {
                    theme2Link.removeAttribute("disabled");
                    theme1Link.setAttribute("disabled", "true");
                }

                // 保存主题设置
                localStorage.setItem("preferred-theme", newTheme);

                // 给予足够的时间加载主题
                setTimeout(() => {
                    // 平滑淡出效果
                    fadeOutOverlay(overlay);
                }, 2500); // 主题加载时间
            }, 250); // 蒙版显示时间
        });
    }

    // 平滑淡出蒙版
    function fadeOutOverlay(overlay) {
        // 先改变背景色，制造渐变效果
        overlay.style.backgroundColor = "rgba(255, 255, 255, 0.85)";

        // 短暂延迟后淡出
        setTimeout(() => {
            overlay.classList.remove("active");

            // 等待淡出动画完成后移除元素
            setTimeout(() => {
                document.body.removeChild(overlay);
            }, 300);
        }, 150);
    }
</script> <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=teal> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#epoll class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../index.html title=柯懒的知识库 class="md-header__button md-logo" aria-label=柯懒的知识库 data-md-component=logo> <img src=../../assets/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> 柯懒的知识库 </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> epoll实现多路转接 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=teal aria-label type=radio name=__palette id=__palette_1> </form> <!-- 头像元素 - 直接在HTML中定义 --> <div class=header-avatar> <img src=../../作者/作者.assets/20250206-200653.jpg alt=头像> <div class=avatar-dropdown> <p><strong>柯懒不是柯南</strong></p> <a href=../../作者/联系作者/作者.html class=avatar-dropdown-item>吵醒柯懒</a> <div class=avatar-dropdown-divider></div> <a href=../../作者/关于作者/关于作者.html class=avatar-dropdown-item>柯懒自传</a> <div class=avatar-dropdown-divider></div> <a href=https://github.com/H0308 class=avatar-dropdown-item>柯懒的零食库</a> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=查找> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <!-- 独立的切换按钮 --> <div class=toolbar-toggle-btn id=toolbarToggleBtn onclick=toggleToolbar()> <div class=toggle-icon> <svg class=toggle-arrow-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=16 height=16> <path d="M346.538667 1024L170.666667 853.333333l341.333333-341.333333-341.333333-341.333333 175.872-170.666667L853.333333 512z" fill=currentColor></path> </svg> </div> </div> <!-- 右侧固定功能条 - 独立于内容区 --> <div class=floating-toolbar id=floatingToolbar> <!-- 字体切换功能 --> <div class="toolbar-item font-switcher"> <div class=toolbar-icon> <svg class=font-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=20 height=20> <path d="M913.408 1024l-66.56 0q-29.696 0-51.2-5.12t-36.864-15.872-26.112-27.136-19.968-37.888q-15.36-38.912-28.16-70.656t-22.016-55.296q-11.264-26.624-20.48-49.152l-254.976 0q-7.168 23.552-17.408 51.2-8.192 23.552-21.504 56.832t-30.72 72.192q-20.48 46.08-47.104 63.488t-60.416 17.408l-70.656 0q-45.056 0-60.928-19.968t2.56-68.096q18.432-46.08 43.008-108.544t52.224-132.608 57.344-143.872 57.344-144.384q65.536-164.864 137.216-343.04 7.168-17.408 18.432-31.744 10.24-11.264 27.136-21.504t42.496-10.24q26.624 0 43.52 10.752t28.16 24.064q12.288 15.36 19.456 33.792 72.704 180.224 138.24 345.088 27.648 70.656 57.344 143.872t56.832 142.336 51.2 129.536 41.472 104.448q14.336 34.816 4.096 62.464t-43.008 27.648zM616.448 634.88l-97.28-347.136-1.024 0-108.544 347.136 206.848 0z" fill=currentColor></path> </svg> </div> <div class=toolbar-label>内容字体</div> <div class=font-dropdown-toolbar> <div class=font-current-toolbar onclick=toggleFontDropdownToolbar()> <span class=current-font-name-toolbar>东观体</span> <svg class=dropdown-arrow-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=12 height=12> <path d="M878.592 250.88q29.696 0 48.128 11.264t24.576 29.696 0 41.472-26.624 45.568q-82.944 92.16-159.744 180.224t-148.48 164.864q-19.456 20.48-45.568 31.744t-53.76 11.776-53.248-8.704-43.008-28.672q-39.936-44.032-82.944-90.112l-88.064-92.16q-43.008-46.08-85.504-90.624t-79.36-86.528q-17.408-19.456-22.528-40.448t1.024-38.4 23.552-28.672 45.056-11.264q35.84 0 98.816-0.512t137.728-0.512l153.6 0 150.528 0 125.952 0 79.872 0z" fill=currentColor></path> </svg> </div> <div class=font-options-toolbar> <div class=font-option-toolbar data-font=dongguanti onclick="selectFontToolbar('dongguanti')">上图东观体</div> <div class=font-option-toolbar data-font=oppoti onclick="selectFontToolbar('oppoti')">OPPO Sans</div> <div class=font-option-toolbar data-font=jiangchengti onclick="selectFontToolbar('jiangchengti')">江城黑体</div> <div class=font-option-toolbar data-font=lxgw onclick="selectFontToolbar('lxgw')">霞鹜臻楷</div> </div> </div> </div> <!-- 代码字体切换功能 --> <div class="toolbar-item code-font-switcher"> <div class=toolbar-icon> <svg class=code-font-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=20 height=20> <path d="M320 213.333333l-213.333333 213.333334L320 640l60.16-60.16L227.84 426.666667l152.32-153.173334L320 213.333333z m384 0l-60.16 60.16L796.16 426.666667l-152.32 153.173333L704 640l213.333333-213.333333L704 213.333333z m-128 85.333334l-128 426.666666h85.333333l128-426.666666h-85.333333z" fill=currentColor></path> </svg> </div> <div class=toolbar-label>代码字体</div> <div class=code-font-dropdown-toolbar> <div class=code-font-current-toolbar onclick=toggleCodeFontDropdownToolbar()> <span class=current-code-font-name-toolbar>DejaVu Sans Mono</span> <svg class=dropdown-arrow-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=12 height=12> <path d="M878.592 250.88q29.696 0 48.128 11.264t24.576 29.696 0 41.472-26.624 45.568q-82.944 92.16-159.744 180.224t-148.48 164.864q-19.456 20.48-45.568 31.744t-53.76 11.776-53.248-8.704-43.008-28.672q-39.936-44.032-82.944-90.112l-88.064-92.16q-43.008-46.08-85.504-90.624t-79.36-86.528q-17.408-19.456-22.528-40.448t1.024-38.4 23.552-28.672 45.056-11.264q35.84 0 98.816-0.512t137.728-0.512l153.6 0 150.528 0 125.952 0 79.872 0z" fill=currentColor></path> </svg> </div> <div class=code-font-options-toolbar> <div class=code-font-option-toolbar data-code-font=dejavu onclick="selectCodeFontToolbar('dejavu')">DejaVu Sans Mono</div> <div class=code-font-option-toolbar data-code-font=zsft onclick="selectCodeFontToolbar('zsft')">JetBrains Mono</div> </div> </div> </div> <!-- 主题切换功能 --> <div class="toolbar-item theme-switcher" onclick=switchTheme()> <div class=toolbar-icon> <svg class=theme-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=20 height=20> <path d="M876.572788 522.301623c-1.886977 12.375865-9.657964 30.331819-35.880185 45.48903-56.489572 32.697703-150.21828 83.990926-174.010149 96.958262-13.143345 24.431435-66.067718 122.221646-98.141204 178.503487-16.117073 28.124548-36.055171 34.041304-50.030463 34.041304-0.031722 0-0.031722 0-0.031722 0-14.613836 0-29.1806-6.460132-43.234687-19.218714-47.183626-42.643216-125.994576-117.105115-146.013515-136.083351-27.757181-4.732791-138.338718-23.743774-200.584388-35.752272-17.924231-3.533476-32.649608-14.07046-40.372499-29.084409-5.78782-11.256368-10.281157-30.05962 1.471514-55.658647 26.989701-59.047838 74.126254-157.557432 85.957721-182.196599-3.437286-27.117614-16.996093-135.060045-23.760147-198.905142-1.886977-17.460674 3.901867-35.096333 15.829524-48.351218 12.791327-14.278191 30.667463-21.48943 49.854455-19.426445 63.669088 6.332219 173.259042 19.426445 200.584388 22.705118 24.335245-11.879562 121.085776-58.936297 180.133613-86.34146 9.91379-4.573155 19.85828-6.92369 29.596062-6.92369 28.748764 0 52.172243 20.642133 58.328453 51.421136 12.599969 62.997799 30.93864 166.70272 35.639708 193.484689 18.851347 19.682271 91.953272 96.031147 135.060045 143.07151C872.72004 487.125473 879.307062 504.71406 876.572788 522.301623L876.572788 522.301623zM825.375755 499.085876C776.017604 445.314205 687.245791 352.977193 686.365748 352.017332c-2.942005-3.069919-4.956895-6.971785-5.676279-11.208273-0.207731-1.215688-22.193465-127.001509-36.551474-198.936865-0.799202-3.917216-4.285606-16.836457-16.196891-16.836457-3.453658 0-7.30743 1.006933-11.464099 2.942005-67.282383 31.179117-183.955662 88.180342-185.170327 88.771813-3.693112 1.790786-7.850805 2.558265-11.975752 2.01489-1.295506-0.224104-133.63765-16.165168-205.988468-23.424502-0.079818 0-0.207731 0-0.287549 0-7.30743 0-11.128455 2.89391-13.319353 5.40408-3.677762 4.124947-5.644557 9.91379-5.068436 15.110139 7.674796 72.623018 24.255427 202.934922 24.463158 204.325595 0.511653 4.109598-0.159636 8.266267-1.966795 11.960403-0.591471 1.215688-57.657164 120.04712-88.339977 187.201589-3.565199 7.754614-4.41352 14.214746-2.350534 18.131963 1.935072 3.725858 6.588045 5.820566 10.360975 6.53995 70.719668 13.718443 204.644867 36.519752 206.036563 36.727483 4.189416 0.671289 8.058536 2.686179 11.112082 5.580089 1.006933 0.87902 96.414887 91.281983 150.090367 139.889027 8.314363 7.563256 13.143345 8.106632 14.437827 8.106632 3.485381 0 8.314363-4.621251 12.727882-12.391215 36.343743-63.828724 100.011808-181.988868 100.636025-183.155437 1.983167-3.64604 5.004991-6.667863 8.650007-8.650007 1.134847-0.671289 114.418936-62.373583 178.6314-99.516528 8.698103-5.036713 14.278191-10.568706 14.94948-14.854313C834.681702 511.845481 831.49922 505.800811 825.375755 499.085876L825.375755 499.085876zM935.333076 935.670256c-4.157693 4.157693-9.689686 6.299473-15.141862 6.299473-5.548366 0-11.048637-2.142803-15.238053-6.299473l-171.915441-171.915441c-8.362458-8.394181-8.362458-21.98471 0-30.426987 8.394181-8.394181 21.98471-8.394181 30.379914 0l171.915441 171.915441C943.727257 913.684522 943.727257 927.275052 935.333076 935.670256L935.333076 935.670256z" fill=currentColor></path> </svg> </div> <div class=toolbar-label>主题</div> </div> <!-- 返回顶部功能 --> <div class="toolbar-item back-to-top" onclick=scrollToTop()> <div class=toolbar-icon> <svg class=back-to-top-icon viewbox="0 0 1024 1024" xmlns=http://www.w3.org/2000/svg> <path d="M882.688 624.128l-336.896-583.68c-15.872-27.136-54.784-27.136-70.656 0L138.24 624.128c-15.872 27.136 4.096 61.44 35.328 61.44H317.44c22.528 0 40.96 18.432 40.96 40.96v239.616c0 22.528 18.432 40.96 40.96 40.96h223.232c22.528 0 40.96-18.432 40.96-40.96v-239.616c0-22.528 18.432-40.96 40.96-40.96h143.872c30.208 0 50.176-34.304 34.304-61.44z"></path> </svg> </div> <div class=toolbar-label>顶部</div> </div> </div> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../index.html class=md-tabs__link> 主页 </a> </li> <li class=md-tabs__item> <a href=../../%E7%BD%91%E7%AB%99%E4%BB%8B%E7%BB%8D/%E7%BD%91%E7%AB%99%E4%BB%8B%E7%BB%8D.html class=md-tabs__link> 网站介绍 </a> </li> <li class=md-tabs__item> <a href=../../%E7%BD%91%E7%AB%99%E6%97%B6%E9%97%B4%E7%BA%BF/%E7%BD%91%E7%AB%99%E6%97%B6%E9%97%B4%E7%BA%BF.html class=md-tabs__link> 网站时间线 </a> </li> <li class=md-tabs__item> <a href=../../C%E8%AF%AD%E8%A8%80/index.html class=md-tabs__link> 编程语言 </a> </li> <li class=md-tabs__item> <a href=../../%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/1.%20%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6%E5%92%8C%E7%A9%BA%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6/1.%20%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6%E4%B8%8E%E7%A9%BA%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6.html class=md-tabs__link> 数据结构与算法 </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../1.%20Linux%E5%B8%B8%E7%94%A8%E9%80%89%E9%A1%B9%E5%92%8C%E6%8C%87%E4%BB%A4/1.%20Linux%E5%B8%B8%E7%94%A8%E9%80%89%E9%A1%B9%E5%92%8C%E6%8C%87%E4%BB%A4.html class=md-tabs__link> Linux </a> </li> <li class=md-tabs__item> <a href=../../HTML%E4%B8%8ECSS/HTML%E7%AC%94%E8%AE%B0/HTML%E7%AC%94%E8%AE%B0.html class=md-tabs__link> 前端 </a> </li> <li class=md-tabs__item> <a href=../../MySQL/MySQL%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/MySQL%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8.html class=md-tabs__link> MySQL </a> </li> <li class=md-tabs__item> <a href=../../JavaEE/Spring/1.%20SpringMVC%E5%9F%BA%E7%A1%80/1.%20SpringMVC%E5%9F%BA%E7%A1%80.html class=md-tabs__link> JavaEE应用开发 </a> </li> <li class=md-tabs__item> <a href=../../%E5%85%B6%E5%AE%83/Shell%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80/%E5%85%B3%E4%BA%8EShell.html class=md-tabs__link> 扩展知识 </a> </li> <li class=md-tabs__item> <a href=../../%E5%B7%A5%E5%85%B7%E5%B8%AE%E5%8A%A9/vscode%E4%B8%AD%E6%B7%BB%E5%8A%A0%E4%BB%A3%E7%A0%81%E7%89%87%E6%AE%B5/vscode%E4%B8%AD%E6%B7%BB%E5%8A%A0%E4%BB%A3%E7%A0%81%E7%89%87%E6%AE%B5.html class=md-tabs__link> 工具帮助 </a> </li> <li class=md-tabs__item> <a href=../../%E9%A1%B9%E7%9B%AE/1.%20Boost%E5%BA%93%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/1.%20Boost%E5%BA%93%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E.html class=md-tabs__link> 项目 </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../index.html title=柯懒的知识库 class="md-nav__button md-logo" aria-label=柯懒的知识库 data-md-component=logo> <img src=../../assets/logo.png alt=logo> </a> 柯懒的知识库 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../index.html class=md-nav__link> <span class=md-ellipsis> 主页 </span> </a> </li> <li class=md-nav__item> <a href=../../%E7%BD%91%E7%AB%99%E4%BB%8B%E7%BB%8D/%E7%BD%91%E7%AB%99%E4%BB%8B%E7%BB%8D.html class=md-nav__link> <span class=md-ellipsis> 网站介绍 </span> </a> </li> <li class=md-nav__item> <a href=../../%E7%BD%91%E7%AB%99%E6%97%B6%E9%97%B4%E7%BA%BF/%E7%BD%91%E7%AB%99%E6%97%B6%E9%97%B4%E7%BA%BF.html class=md-nav__link> <span class=md-ellipsis> 网站时间线 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../C%E8%AF%AD%E8%A8%80/index.html class=md-nav__link> <span class=md-ellipsis> 编程语言 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/1.%20%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6%E5%92%8C%E7%A9%BA%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6/1.%20%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6%E4%B8%8E%E7%A9%BA%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6.html class=md-nav__link> <span class=md-ellipsis> 数据结构与算法 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6 checked> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex> <span class=md-ellipsis> Linux </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=true> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../1.%20Linux%E5%B8%B8%E7%94%A8%E9%80%89%E9%A1%B9%E5%92%8C%E6%8C%87%E4%BB%A4/1.%20Linux%E5%B8%B8%E7%94%A8%E9%80%89%E9%A1%B9%E5%92%8C%E6%8C%87%E4%BB%A4.html class=md-nav__link> <span class=md-ellipsis> Linux常用选项和指令 </span> </a> </li> <li class=md-nav__item> <a href=../2.%20Linux%E6%9D%83%E9%99%90%E7%9B%B8%E5%85%B3/2.%20Linux%E6%9D%83%E9%99%90%E7%9B%B8%E5%85%B3.html class=md-nav__link> <span class=md-ellipsis> Linux权限相关 </span> </a> </li> <li class=md-nav__item> <a href=../3.%20CentOS%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85/3.%20CentOS%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85.html class=md-nav__link> <span class=md-ellipsis> CentOS软件安装 </span> </a> </li> <li class=md-nav__item> <a href=../4.%20Linux%E4%B8%8B%E7%9A%84gcc%E4%B8%8Egdb/4.%20Linux%E4%B8%8B%E7%9A%84gcc%E4%B8%8Egdb.html class=md-nav__link> <span class=md-ellipsis> Linux下的gcc与gdb </span> </a> </li> <li class=md-nav__item> <a href=../5.%20Linux%E4%B8%8B%E7%9A%84Makefile%E4%B8%8E%E8%BF%9B%E5%BA%A6%E6%9D%A1%E7%A8%8B%E5%BA%8F/5.%20Linux%E4%B8%8B%E7%9A%84Makefile%E4%B8%8E%E8%BF%9B%E5%BA%A6%E6%9D%A1%E7%A8%8B%E5%BA%8F.html class=md-nav__link> <span class=md-ellipsis> Linux下的Makefile与进度条程序 </span> </a> </li> <li class=md-nav__item> <a href=../6.%20%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/6.%20%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86.html class=md-nav__link> <span class=md-ellipsis> 操作系统基础知识 </span> </a> </li> <li class=md-nav__item> <a href=../7.%20Linux%E8%BF%9B%E7%A8%8B/7.%20Linux%E8%BF%9B%E7%A8%8B.html class=md-nav__link> <span class=md-ellipsis> Linux进程基础 </span> </a> </li> <li class=md-nav__item> <a href=../8.%20Linux%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81%E4%B8%8E%E8%BF%9B%E7%A8%8B%E4%BC%98%E5%85%88%E7%BA%A7/8.%20Linux%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81%E4%B8%8E%E8%BF%9B%E7%A8%8B%E4%BC%98%E5%85%88%E7%BA%A7.html class=md-nav__link> <span class=md-ellipsis> Linux进程状态与进程优先级 </span> </a> </li> <li class=md-nav__item> <a href=../9.%20Linux%E8%BF%9B%E7%A8%8B%E5%88%87%E6%8D%A2%E4%BB%A5%E5%8F%8A%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95/9.%20Linux%E8%BF%9B%E7%A8%8B%E5%88%87%E6%8D%A2%E4%BB%A5%E5%8F%8A%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95.html class=md-nav__link> <span class=md-ellipsis> Linux进程切换以及调度算法 </span> </a> </li> <li class=md-nav__item> <a href=../10.%20Linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%B8%8E%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/10.%20Linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%B8%8E%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F.html class=md-nav__link> <span class=md-ellipsis> Linux命令行与环境变量 </span> </a> </li> <li class=md-nav__item> <a href=../11.%20Linux%E8%BF%9B%E7%A8%8B%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/11.%20%E8%BF%9B%E7%A8%8B%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4.html class=md-nav__link> <span class=md-ellipsis> Linux进程地址空间 </span> </a> </li> <li class=md-nav__item> <a href=../12.%20Linux%E8%BF%9B%E7%A8%8B%E6%8E%A7%E5%88%B6/12.%20Linux%E8%BF%9B%E7%A8%8B%E6%8E%A7%E5%88%B6.html class=md-nav__link> <span class=md-ellipsis> Linux进程控制 </span> </a> </li> <li class=md-nav__item> <a href=../13.%20Linux%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E5%9F%BA%E7%A1%80/13.%20Linux%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E5%9F%BA%E7%A1%80.html class=md-nav__link> <span class=md-ellipsis> Linux文件操作基础 </span> </a> </li> <li class=md-nav__item> <a href=../14.%20Linux%E4%B8%AD%E8%BE%93%E5%85%A5%E5%92%8C%E8%BE%93%E5%87%BA%E5%9F%BA%E6%9C%AC%E8%BF%87%E7%A8%8B/14.%20Linux%E4%B8%AD%E8%BE%93%E5%85%A5%E5%92%8C%E8%BE%93%E5%87%BA%E5%9F%BA%E6%9C%AC%E8%BF%87%E7%A8%8B.html class=md-nav__link> <span class=md-ellipsis> Linux中输入和输出基本过程 </span> </a> </li> <li class=md-nav__item> <a href=../15.%20Linux%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/15.%20Linux%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F.html class=md-nav__link> <span class=md-ellipsis> Linux文件系统 </span> </a> </li> <li class=md-nav__item> <a href=../16.%20Linux%E8%BD%AF%E9%93%BE%E6%8E%A5%E5%92%8C%E7%A1%AC%E9%93%BE%E6%8E%A5/16.%20Linux%E8%BD%AF%E9%93%BE%E6%8E%A5%E5%92%8C%E7%A1%AC%E9%93%BE%E6%8E%A5.html class=md-nav__link> <span class=md-ellipsis> Linux软链接和硬链接 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../17.%20Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/1.%20%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%E4%BB%8B%E7%BB%8D%E4%B8%8E%E5%8C%BF%E5%90%8D%E7%AE%A1%E9%81%93/1.%20%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%E4%BB%8B%E7%BB%8D%E4%B8%8E%E5%8C%BF%E5%90%8D%E7%AE%A1%E9%81%93.html class=md-nav__link> <span class=md-ellipsis> Linux进程间通信 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../18.%20Linux%E4%BF%A1%E5%8F%B7%E4%B8%8E%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/18.%20Linux%E4%BF%A1%E5%8F%B7%E4%B8%8E%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86.html class=md-nav__link> <span class=md-ellipsis> Linux信号与操作系统原理 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../19.%20Linux%E7%BA%BF%E7%A8%8B/1.%20Linux%E7%BA%BF%E7%A8%8B%E6%A6%82%E5%BF%B5%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%93%8D%E4%BD%9C/1.%20Linux%E7%BA%BF%E7%A8%8B%E6%A6%82%E5%BF%B5%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%93%8D%E4%BD%9C.html class=md-nav__link> <span class=md-ellipsis> Linux线程 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../20.%20%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/20.%20%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86.html class=md-nav__link> <span class=md-ellipsis> 网络基础知识 </span> </a> </li> <li class=md-nav__item> <a href=../21.%20Socket%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/21.%20Socket%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80.html class=md-nav__link> <span class=md-ellipsis> Socket编程基础 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../22.%20UDP%E7%BC%96%E7%A8%8B/1.%20UDP%E7%BC%96%E7%A8%8B%E6%8E%A5%E5%8F%A3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/1.%20UDP%E7%BC%96%E7%A8%8B%E6%8E%A5%E5%8F%A3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8.html class=md-nav__link> <span class=md-ellipsis> UDP编程 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../23.%20TCP%E7%BC%96%E7%A8%8B%E6%8E%A5%E5%8F%A3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/23.%20TCP%E7%BC%96%E7%A8%8B%E6%8E%A5%E5%8F%A3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8.html class=md-nav__link> <span class=md-ellipsis> TCP编程接口基本使用 </span> </a> </li> <li class=md-nav__item> <a href=../24.%20%E5%BA%8F%E5%88%97%E5%8C%96%E9%97%AE%E9%A2%98%E4%B8%8E%E7%BD%91%E7%BB%9C%E8%AE%A1%E7%AE%97%E5%99%A8/24.%20%E5%BA%8F%E5%88%97%E5%8C%96%E9%97%AE%E9%A2%98%E4%B8%8E%E7%BD%91%E7%BB%9C%E8%AE%A1%E7%AE%97%E5%99%A8.html class=md-nav__link> <span class=md-ellipsis> 序列化和反序列化与网络计算器 </span> </a> </li> <li class=md-nav__item> <a href=../25.%20%E8%BF%9B%E7%A8%8B%E9%97%B4%E5%85%B3%E7%B3%BB%E5%92%8C%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B/25.%20%E8%BF%9B%E7%A8%8B%E9%97%B4%E5%85%B3%E7%B3%BB%E5%92%8C%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B.html class=md-nav__link> <span class=md-ellipsis> 进程间关系和守护进程 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../26.%20%E5%BA%94%E7%94%A8%E5%B1%82%E5%8D%8F%E8%AE%AEHTTP/1.%20%E4%BB%8B%E7%BB%8DHTTP%E5%8D%8F%E8%AE%AE%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84%E4%B8%8E%E5%9F%BA%E6%9C%AC%E5%AE%9E%E7%8E%B0HTTPServer/1.%20%E4%BB%8B%E7%BB%8DHTTP%E5%8D%8F%E8%AE%AE%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84%E4%B8%8E%E5%9F%BA%E6%9C%AC%E5%AE%9E%E7%8E%B0HTTPServer.html class=md-nav__link> <span class=md-ellipsis> 应用层协议HTTP </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../27.%20UDP%E5%8D%8F%E8%AE%AE%E5%8E%9F%E7%90%86/27.%20UDP%E5%8D%8F%E8%AE%AE%E5%8E%9F%E7%90%86.html class=md-nav__link> <span class=md-ellipsis> UDP协议原理 </span> </a> </li> <li class=md-nav__item> <a href=../28.%20TCP%E5%8D%8F%E8%AE%AE%E5%8E%9F%E7%90%86/28.%20TCP%E5%8D%8F%E8%AE%AE%E5%8E%9F%E7%90%86.html class=md-nav__link> <span class=md-ellipsis> TCP协议原理 </span> </a> </li> <li class=md-nav__item> <a href=../35.%20%E7%90%86%E8%A7%A3Linux%E5%A6%82%E4%BD%95%E7%9C%8B%E5%BE%85%E8%BF%9E%E6%8E%A5%E4%BB%A5%E5%8F%8ATCP%E5%85%A8%E8%BF%9E%E6%8E%A5%E9%98%9F%E5%88%97/35.%20%E7%90%86%E8%A7%A3Linux%E5%A6%82%E4%BD%95%E7%9C%8B%E5%BE%85%E8%BF%9E%E6%8E%A5%E4%BB%A5%E5%8F%8ATCP%E5%85%A8%E8%BF%9E%E6%8E%A5%E9%98%9F%E5%88%97.html class=md-nav__link> <span class=md-ellipsis> 理解Linux如何看待连接以及TCP全连接队列 </span> </a> </li> <li class=md-nav__item> <a href=../29.%20%E7%BD%91%E7%BB%9C%E5%B1%82IP%E5%8D%8F%E8%AE%AE/29.%20%E7%BD%91%E7%BB%9C%E5%B1%82IP%E5%8D%8F%E8%AE%AE.html class=md-nav__link> <span class=md-ellipsis> 网络层IP协议 </span> </a> </li> <li class=md-nav__item> <a href=../30.%20%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82%E5%8D%8F%E8%AE%AE/30.%20%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82%E5%8D%8F%E8%AE%AE.html class=md-nav__link> <span class=md-ellipsis> 数据链路层协议 </span> </a> </li> <li class=md-nav__item> <a href=../36.%20DNS%E4%B8%8EICMP/36.%20DNS%E4%B8%8EICMP.html class=md-nav__link> <span class=md-ellipsis> DNS与ICMP </span> </a> </li> <li class=md-nav__item> <a href=../31.%20NAT%E6%8A%80%E6%9C%AF%E3%80%81%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%92%8C%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/31.%20NAT%E6%8A%80%E6%9C%AF%E3%80%81%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%92%8C%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F.html class=md-nav__link> <span class=md-ellipsis> NAT技术、代理服务器和内网穿透 </span> </a> </li> <li class=md-nav__item> <a href=../32.%20%E4%BA%94%E7%A7%8DIO%E6%A8%A1%E5%9E%8B%E4%B8%8Eselect%E5%92%8Cpoll%E5%88%86%E5%88%AB%E5%AE%9E%E7%8E%B0%E5%A4%9A%E8%B7%AF%E8%BD%AC%E6%8E%A5/32.%20%E4%BA%94%E7%A7%8DIO%E6%A8%A1%E5%9E%8B%E4%B8%8Eselect%E5%92%8Cpoll%E5%88%86%E5%88%AB%E5%AE%9E%E7%8E%B0%E5%A4%9A%E8%B7%AF%E8%BD%AC%E6%8E%A5.html class=md-nav__link> <span class=md-ellipsis> 五种IO模型与select和poll分别实现多路转接 </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> epoll实现多路转接 </span> <span class="md-nav__icon md-icon"></span> </label> <a href=33.%20epoll%E5%AE%9E%E7%8E%B0%E5%A4%9A%E8%B7%AF%E8%BD%AC%E6%8E%A5.html class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> epoll实现多路转接 </span> </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 本篇介绍 </span> </a> </li> <li class=md-nav__item> <a href=#epoll_1 class=md-nav__link> <span class=md-ellipsis> epoll接口介绍 </span> </a> </li> <li class=md-nav__item> <a href=#epollselectpoll class=md-nav__link> <span class=md-ellipsis> 从接口层面对比epoll与select和poll </span> </a> </li> <li class=md-nav__item> <a href=#epoll_2 class=md-nav__link> <span class=md-ellipsis> epoll 原理 </span> </a> </li> <li class=md-nav__item> <a href=#epoll_3 class=md-nav__link> <span class=md-ellipsis> epoll实现多路转接 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 水平触发和边缘触发 </span> </a> </li> <li class=md-nav__item> <a href=#epolltcp class=md-nav__link> <span class=md-ellipsis> 基于边缘触发模式的epoll实现基本TCP服务器结构 </span> </a> <nav class=md-nav aria-label=基于边缘触发模式的epoll实现基本TCP服务器结构> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 基本思路 </span> </a> </li> <li class=md-nav__item> <a href=#connection class=md-nav__link> <span class=md-ellipsis> 实现Connection类基本结构 </span> </a> </li> <li class=md-nav__item> <a href=#epollserver class=md-nav__link> <span class=md-ellipsis> 实现EpollServer类基本结构 </span> </a> </li> <li class=md-nav__item> <a href=#epollepoll class=md-nav__link> <span class=md-ellipsis> 实现epoll接口封装类Epoll基本结构 </span> </a> </li> <li class=md-nav__item> <a href=#epollepollserver class=md-nav__link> <span class=md-ellipsis> 设计Epoll类和EpollServer类 </span> </a> </li> <li class=md-nav__item> <a href=#listener class=md-nav__link> <span class=md-ellipsis> 实现Listener类基本结构 </span> </a> </li> <li class=md-nav__item> <a href=#listenerioservice class=md-nav__link> <span class=md-ellipsis> 设计Listener类和IOService类 </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 第一阶段测试 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../34.%20Reactor%E6%A8%A1%E5%BC%8F%E4%B8%8E%E5%AE%8C%E5%96%84%E5%9F%BA%E4%BA%8E%E8%BE%B9%E7%BC%98%E8%A7%A6%E5%8F%91%E6%A8%A1%E5%BC%8Fepoll%E5%AE%9E%E7%8E%B0TCP%E6%9C%8D%E5%8A%A1%E5%99%A8/34.%20Reactor%E6%A8%A1%E5%BC%8F%E4%B8%8E%E5%AE%8C%E5%96%84%E5%9F%BA%E4%BA%8E%E8%BE%B9%E7%BC%98%E8%A7%A6%E5%8F%91%E6%A8%A1%E5%BC%8Fepoll%E5%AE%9E%E7%8E%B0TCP%E6%9C%8D%E5%8A%A1%E5%99%A8.html class=md-nav__link> <span class=md-ellipsis> Reactor模式与完善基于边缘触发模式epoll实现TCP服务器 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../HTML%E4%B8%8ECSS/HTML%E7%AC%94%E8%AE%B0/HTML%E7%AC%94%E8%AE%B0.html class=md-nav__link> <span class=md-ellipsis> 前端 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../MySQL/MySQL%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/MySQL%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8.html class=md-nav__link> <span class=md-ellipsis> MySQL </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../JavaEE/Spring/1.%20SpringMVC%E5%9F%BA%E7%A1%80/1.%20SpringMVC%E5%9F%BA%E7%A1%80.html class=md-nav__link> <span class=md-ellipsis> JavaEE应用开发 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../%E5%85%B6%E5%AE%83/Shell%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80/%E5%85%B3%E4%BA%8EShell.html class=md-nav__link> <span class=md-ellipsis> 扩展知识 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../%E5%B7%A5%E5%85%B7%E5%B8%AE%E5%8A%A9/vscode%E4%B8%AD%E6%B7%BB%E5%8A%A0%E4%BB%A3%E7%A0%81%E7%89%87%E6%AE%B5/vscode%E4%B8%AD%E6%B7%BB%E5%8A%A0%E4%BB%A3%E7%A0%81%E7%89%87%E6%AE%B5.html class=md-nav__link> <span class=md-ellipsis> 工具帮助 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../%E9%A1%B9%E7%9B%AE/1.%20Boost%E5%BA%93%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/1.%20Boost%E5%BA%93%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E.html class=md-nav__link> <span class=md-ellipsis> 项目 </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 本篇介绍 </span> </a> </li> <li class=md-nav__item> <a href=#epoll_1 class=md-nav__link> <span class=md-ellipsis> epoll接口介绍 </span> </a> </li> <li class=md-nav__item> <a href=#epollselectpoll class=md-nav__link> <span class=md-ellipsis> 从接口层面对比epoll与select和poll </span> </a> </li> <li class=md-nav__item> <a href=#epoll_2 class=md-nav__link> <span class=md-ellipsis> epoll 原理 </span> </a> </li> <li class=md-nav__item> <a href=#epoll_3 class=md-nav__link> <span class=md-ellipsis> epoll实现多路转接 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 水平触发和边缘触发 </span> </a> </li> <li class=md-nav__item> <a href=#epolltcp class=md-nav__link> <span class=md-ellipsis> 基于边缘触发模式的epoll实现基本TCP服务器结构 </span> </a> <nav class=md-nav aria-label=基于边缘触发模式的epoll实现基本TCP服务器结构> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 基本思路 </span> </a> </li> <li class=md-nav__item> <a href=#connection class=md-nav__link> <span class=md-ellipsis> 实现Connection类基本结构 </span> </a> </li> <li class=md-nav__item> <a href=#epollserver class=md-nav__link> <span class=md-ellipsis> 实现EpollServer类基本结构 </span> </a> </li> <li class=md-nav__item> <a href=#epollepoll class=md-nav__link> <span class=md-ellipsis> 实现epoll接口封装类Epoll基本结构 </span> </a> </li> <li class=md-nav__item> <a href=#epollepollserver class=md-nav__link> <span class=md-ellipsis> 设计Epoll类和EpollServer类 </span> </a> </li> <li class=md-nav__item> <a href=#listener class=md-nav__link> <span class=md-ellipsis> 实现Listener类基本结构 </span> </a> </li> <li class=md-nav__item> <a href=#listenerioservice class=md-nav__link> <span class=md-ellipsis> 设计Listener类和IOService类 </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 第一阶段测试 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=epoll><code>epoll</code>实现多路转接<a class=headerlink href=#epoll title="Permanent link">&para;</a></h1> <div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;"> <p><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 7966 个字 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 775 行代码 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 1 张图片 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 36 分钟</p> </div> <h2 id=_1>本篇介绍<a class=headerlink href=#_1 title="Permanent link">&para;</a></h2> <p>在前面一节已经介绍了<code>select</code>和<code>poll</code>实现多路转接，但是<code>select</code>和<code>poll</code>都存在一些缺陷。而二者最大的缺陷就是都需要内核涉及到遍历操作。所以，为了尽可能减少内核的遍历，就需要用到<code>epoll</code>实现多路转接</p> <h2 id=epoll_1><code>epoll</code>接口介绍<a class=headerlink href=#epoll_1 title="Permanent link">&para;</a></h2> <p>要使用<code>epoll</code>实现多路转接，需要经过三个步骤：</p> <ol> <li>创建<code>epoll</code>模型</li> <li>设置需要关心的文件描述符和对应事件</li> <li>注册关心的文件描述符和事件</li> </ol> <p>根据这三个步骤，分别使用三个不同的接口：</p> <p><strong>创建<code>epoll</code>模型</strong></p> <p>在Linux中，要使用<code>epoll</code>实现多路转接，需要使用<code>epoll_create</code>函数创建一个<code>epoll</code>模型，该函数声明如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-1><span class=kt>int</span><span class=w> </span><span class=nf>epoll_create</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>size</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>尽管该函数存在一个参数，但是在2.6.8内核版本后，该参数已经被忽略，并且内核会使用一个默认值来代替，所以在使用时，该参数可以设置为任意值，一般设置为128或者256</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>需要注意，尽管<code>size</code>可以设置为任意值，但是必须要保证<code>size</code>大于0</p> </div> <p>该函数会返回创建的<code>epoll</code>模型对应的文件描述符</p> <p><strong>设置需要关心的文件描述符和对应事件</strong></p> <p>调用<code>epoll_create</code>函数创建好<code>epoll</code>模型后，需要使用<code>epoll_ctl</code>函数将需要关心的文件描述符和对应的事件添加到<code>epoll</code>模型中，该函数声明如下：</p> <p><div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-1-1><span class=kt>int</span><span class=w> </span><span class=nf>epoll_ctl</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>epfd</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>op</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>epoll_event</span><span class=w> </span><span class=o>*</span><span class=n>event</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> 该函数的第一个参数表示目标<code>epoll</code>模型对应的文件描述符，第二个参数表示操作类型，该参数有三种类型：</p> <ul> <li><code>EPOLL_CTL_ADD</code>：将指定的文件描述符添加到<code>epoll</code>模型中</li> <li><code>EPOLL_CTL_MOD</code>：修改指定文件描述符对应的事件</li> <li><code>EPOLL_CTL_DEL</code>：将指定文件描述符从指定的<code>epoll</code>模型中删除</li> </ul> <p>第三个参数表示需要关心的文件描述符，第四个参数表示需要关心的文件描述符对应的事件，该结构定义如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-2-1><span class=k>union</span><span class=w> </span><span class=nc>epoll_data</span><span class=w> </span>
</span><span id=__span-2-2><span class=p>{</span>
</span><span id=__span-2-3><span class=w>    </span><span class=kt>void</span><span class=w>     </span><span class=o>*</span><span class=n>ptr</span><span class=p>;</span>
</span><span id=__span-2-4><span class=w>    </span><span class=kt>int</span><span class=w>       </span><span class=n>fd</span><span class=p>;</span>
</span><span id=__span-2-5><span class=w>    </span><span class=kt>uint32_t</span><span class=w>  </span><span class=n>u32</span><span class=p>;</span>
</span><span id=__span-2-6><span class=w>    </span><span class=kt>uint64_t</span><span class=w>  </span><span class=n>u64</span><span class=p>;</span>
</span><span id=__span-2-7><span class=p>};</span>
</span><span id=__span-2-8>
</span><span id=__span-2-9><span class=k>typedef</span><span class=w> </span><span class=k>union</span><span class=w> </span><span class=nc>epoll_data</span><span class=w>  </span><span class=n>epoll_data_t</span><span class=p>;</span>
</span><span id=__span-2-10>
</span><span id=__span-2-11><span class=k>struct</span><span class=w> </span><span class=nc>epoll_event</span><span class=w> </span>
</span><span id=__span-2-12><span class=p>{</span>
</span><span id=__span-2-13><span class=w>    </span><span class=kt>uint32_t</span><span class=w>      </span><span class=n>events</span><span class=p>;</span><span class=w>  </span><span class=cm>/* Epoll events */</span>
</span><span id=__span-2-14><span class=w>    </span><span class=n>epoll_data_t</span><span class=w>  </span><span class=n>data</span><span class=p>;</span><span class=w>    </span><span class=cm>/* User data variable */</span>
</span><span id=__span-2-15><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>在<code>epoll_event</code>结构中，第一个字段表示文件描述符对应的事件，有下面的几种类型：</p> <ul> <li><code>EPOLLIN</code>：表示关心文件描述符的读事件</li> <li><code>EPOLLOUT</code>：表示关心文件描述符的写事件</li> <li><code>EPOLLET</code>：表示以边沿触发的方式进行事件通知</li> <li><code>EPOLLONESHOT</code>：表示文件描述符只能触发一次事件</li> <li><code>EPOLLRDHUP</code>：表示文件描述符对应的连接被对方关闭</li> <li><code>EPOLLPRI</code>：表示文件描述符对应的连接有紧急数据可读</li> <li><code>EPOLLERR</code>：表示文件描述符对应的连接发生错误</li> <li><code>EPOLLHUP</code>：表示文件描述符对应的连接被挂断</li> </ul> <p>第二个字段表示文件描述符对应的用户数据，一般使用<code>fd</code>字段来表示文件描述符</p> <p><strong>注册关心的文件描述符和事件</strong></p> <p>在调用<code>epoll_ctl</code>函数将需要关心的文件描述符和对应的事件添加到<code>epoll</code>模型中后，就可以使用<code>epoll_wait</code>函数来等待事件的发生，该函数声明如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-3-1><span class=kt>int</span><span class=w> </span><span class=nf>epoll_wait</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>epfd</span><span class=p>,</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>epoll_event</span><span class=w> </span><span class=o>*</span><span class=n>events</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>maxevents</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>timeout</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>该函数的第一个参数表示目标<code>epoll</code>模型对应的文件描述符，最后一个参数的设置与<code>poll</code>一致，此处不再赘述。接着，第二个参数和第三个参数共同表示一个数组，与<code>poll</code>类似，<code>struct epoll_event *events</code>表示数组的第一个元素的地址，<code>maxevents</code>表示数组的元素个数。但是需要注意的是，这里的第二个参数并不是输入型参数，而是一个输出型参数，<strong>该数组中存储的是对应事件已经就绪的文件描述符</strong>，而因为事件可能不止一个，也有可能有很多个，所以需要<code>maxevents</code>来控制一次最多可以获取到的事件个数</p> <p>该函数的返回值与<code>poll</code>一样，因为返回值大于0决定了具体就绪的文件描述符的个数，所以遍历就绪文件描述符数组<code>events</code>时需要用到该返回值</p> <h2 id=epollselectpoll>从接口层面对比<code>epoll</code>与<code>select</code>和<code>poll</code><a class=headerlink href=#epollselectpoll title="Permanent link">&para;</a></h2> <p>根据上面的接口介绍，可以看到<code>epoll</code>与<code>select</code>和<code>poll</code>最大的区别就在于接口的个数上，<code>epoll</code>只有三个接口，而<code>select</code>和<code>poll</code>根据前面的使用只有一个接口，而<code>epoll</code>三个接口中的后两个分别表示不同的功能：「用户需要内核关心的文件描述符和对应的事件」以及「内核告诉用户有哪些事件已经就绪」，所以从接口层面来看，<code>epoll</code>将这两个操作分离，使得操作变得更加清晰</p> <h2 id=epoll_2><code>epoll</code> 原理<a class=headerlink href=#epoll_2 title="Permanent link">&para;</a></h2> <p>虽然上面已经对<code>epoll</code>实现多路转接需要用到的接口进行了介绍，但是其中还涉及到一些更加细节的问题无法通过接口的声明来描述，所以除了需要知道<code>epoll</code>需要用的到的接口外，还需要了解<code>epoll</code>的实现原理</p> <p>在前面已经知道了文件描述符如何与套接字进行关联，接着看<code>epoll</code>实现多路转接的原理：</p> <p>首先用户调用<code>epoll_create</code>函数创建<code>epoll</code>模型，该函数会在内核中创建一个<code>struct eventpoll</code>类型的对象，该对象中包含一个<code>struct rb_root</code>类型的对象，该对象是一个红黑树，该红黑树的节点类型是<code>struct epitem</code>。这两个结构定义分别如下：</p> <div class="tabbed-set tabbed-alternate" data-tabs=1:2><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><input id=__tabbed_1_2 name=__tabbed_1 type=radio><div class=tabbed-labels><label for=__tabbed_1_1><code>struct eventpoll</code></label><label for=__tabbed_1_2><code>struct epitem</code></label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-4-1><span class=k>struct</span><span class=w> </span><span class=nc>eventpoll</span><span class=w> </span>
</span><span id=__span-4-2><span class=p>{</span>
</span><span id=__span-4-3><span class=w>    </span><span class=cm>/* Protect the this structure access */</span>
</span><span id=__span-4-4><span class=w>    </span><span class=n>rwlock_t</span><span class=w> </span><span class=n>lock</span><span class=p>;</span>
</span><span id=__span-4-5>
</span><span id=__span-4-6><span class=w>    </span><span class=cm>/*</span>
</span><span id=__span-4-7><span class=cm>    * This semaphore is used to ensure that files are not removed</span>
</span><span id=__span-4-8><span class=cm>    * while epoll is using them. This is read-held during the event</span>
</span><span id=__span-4-9><span class=cm>    * collection loop and it is write-held during the file cleanup</span>
</span><span id=__span-4-10><span class=cm>    * path, the epoll file exit code and the ctl operations.</span>
</span><span id=__span-4-11><span class=cm>    */</span>
</span><span id=__span-4-12><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>rw_semaphore</span><span class=w> </span><span class=n>sem</span><span class=p>;</span>
</span><span id=__span-4-13>
</span><span id=__span-4-14><span class=w>    </span><span class=cm>/* Wait queue used by sys_epoll_wait() */</span>
</span><span id=__span-4-15><span class=w>    </span><span class=n>wait_queue_head_t</span><span class=w> </span><span class=n>wq</span><span class=p>;</span>
</span><span id=__span-4-16>
</span><span id=__span-4-17><span class=w>    </span><span class=cm>/* Wait queue used by file-&gt;poll() */</span>
</span><span id=__span-4-18><span class=w>    </span><span class=n>wait_queue_head_t</span><span class=w> </span><span class=n>poll_wait</span><span class=p>;</span>
</span><span id=__span-4-19>
</span><span id=__span-4-20><span class=w>    </span><span class=cm>/* List of ready file descriptors */</span>
</span><span id=__span-4-21><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>list_head</span><span class=w> </span><span class=n>rdllist</span><span class=p>;</span>
</span><span id=__span-4-22>
</span><span id=__span-4-23><span class=w>    </span><span class=cm>/* RB-Tree root used to store monitored fd structs */</span>
</span><span id=__span-4-24><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>rb_root</span><span class=w> </span><span class=n>rbr</span><span class=p>;</span>
</span><span id=__span-4-25><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-5-1><span class=k>struct</span><span class=w> </span><span class=nc>epitem</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-2><span class=w>    </span><span class=cm>/* RB-Tree node used to link this structure to the eventpoll rb-tree */</span>
</span><span id=__span-5-3><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>rb_node</span><span class=w> </span><span class=n>rbn</span><span class=p>;</span>
</span><span id=__span-5-4>
</span><span id=__span-5-5><span class=w>    </span><span class=cm>/* List header used to link this structure to the eventpoll ready list */</span>
</span><span id=__span-5-6><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>list_head</span><span class=w> </span><span class=n>rdllink</span><span class=p>;</span>
</span><span id=__span-5-7>
</span><span id=__span-5-8><span class=w>    </span><span class=cm>/* The file descriptor information this item refers to */</span>
</span><span id=__span-5-9><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>epoll_filefd</span><span class=w> </span><span class=n>ffd</span><span class=p>;</span>
</span><span id=__span-5-10>
</span><span id=__span-5-11><span class=w>    </span><span class=cm>/* Number of active wait queue attached to poll operations */</span>
</span><span id=__span-5-12><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>nwait</span><span class=p>;</span>
</span><span id=__span-5-13>
</span><span id=__span-5-14><span class=w>    </span><span class=cm>/* List containing poll wait queues */</span>
</span><span id=__span-5-15><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>list_head</span><span class=w> </span><span class=n>pwqlist</span><span class=p>;</span>
</span><span id=__span-5-16>
</span><span id=__span-5-17><span class=w>    </span><span class=cm>/* The &quot;container&quot; of this item */</span>
</span><span id=__span-5-18><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>eventpoll</span><span class=w> </span><span class=o>*</span><span class=n>ep</span><span class=p>;</span>
</span><span id=__span-5-19>
</span><span id=__span-5-20><span class=w>    </span><span class=cm>/* The structure that describe the interested events and the source fd */</span>
</span><span id=__span-5-21><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>epoll_event</span><span class=w> </span><span class=n>event</span><span class=p>;</span>
</span><span id=__span-5-22>
</span><span id=__span-5-23><span class=w>    </span><span class=cm>/*</span>
</span><span id=__span-5-24><span class=cm>    * Used to keep track of the usage count of the structure. This avoids</span>
</span><span id=__span-5-25><span class=cm>    * that the structure will desappear from underneath our processing.</span>
</span><span id=__span-5-26><span class=cm>    */</span>
</span><span id=__span-5-27><span class=w>    </span><span class=n>atomic_t</span><span class=w> </span><span class=n>usecnt</span><span class=p>;</span>
</span><span id=__span-5-28>
</span><span id=__span-5-29><span class=w>    </span><span class=cm>/* List header used to link this item to the &quot;struct file&quot; items list */</span>
</span><span id=__span-5-30><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>list_head</span><span class=w> </span><span class=n>fllink</span><span class=p>;</span>
</span><span id=__span-5-31>
</span><span id=__span-5-32><span class=w>    </span><span class=cm>/* List header used to link the item to the transfer list */</span>
</span><span id=__span-5-33><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>list_head</span><span class=w> </span><span class=n>txlink</span><span class=p>;</span>
</span><span id=__span-5-34>
</span><span id=__span-5-35><span class=w>    </span><span class=cm>/*</span>
</span><span id=__span-5-36><span class=cm>    * This is used during the collection/transfer of events to userspace</span>
</span><span id=__span-5-37><span class=cm>    * to pin items empty events set.</span>
</span><span id=__span-5-38><span class=cm>    */</span>
</span><span id=__span-5-39><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>revents</span><span class=p>;</span>
</span><span id=__span-5-40><span class=p>};</span>
</span><span id=__span-5-41>
</span><span id=__span-5-42><span class=cm>/* Wrapper struct used by poll queueing */</span>
</span><span id=__span-5-43><span class=k>struct</span><span class=w> </span><span class=nc>ep_pqueue</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-44><span class=w>    </span><span class=n>poll_table</span><span class=w> </span><span class=n>pt</span><span class=p>;</span>
</span><span id=__span-5-45><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>epitem</span><span class=w> </span><span class=o>*</span><span class=n>epi</span><span class=p>;</span>
</span><span id=__span-5-46><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>在<code>struct eventpoll</code>结构中，除了有红黑树结构以外，还存在着<code>struct list_head rdllist;</code>，这个链表中存储的就是就绪的文件描述符，而在<code>struct epitem</code>结构中，<code>struct epoll_filefd ffd;</code>表示的就是具体的文件描述符，而<code>struct epoll_event event;</code>表示的就是文件描述符对应的事件</p> <p>结合前面的三个接口看具体的原理就是首先调用<code>epoll_create</code>函数创建<code>epoll</code>模型，接着调用<code>epoll_ctl</code>函数将需要关心的文件描述符和对应的事件添加到<code>epoll</code>模型中，然后调用<code>epoll_wait</code>函数等待事件的发生，当事件发生后，<code>epoll</code>模型会将对应的文件描述符添加到<code>rdllist</code>链表中，然后<code>epoll_wait</code>函数会返回，用户就可以遍历<code>rdllist</code>链表来获取就绪的文件描述符</p> <p>但是，这里还涉及到一个问题，就是<code>epoll_wait</code>函数是如何知道事件已经就绪的？这里实际上就是利用到了<strong>底层回调机制</strong>。所谓底层回调机制，可以理解为内核先准备一个函数指针，但是这个指针一开始指向为空，当存在一个事件就绪时，该指针就会指向一个具体的函数，接着，内核会调用该函数执行其中的函数体，在此处可以简单理解为函数体就是将挂在红黑树上的文件描述符节点添加到<code>rdllist</code>链表中</p> <p>整个过程示意图如下：</p> <p><a class=glightbox href="33. epoll实现多路转接.assets/image-20250408164946326.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="33. epoll实现多路转接.assets/image-20250408164946326.png"></a></p> <p>分析完上面的基本原理，下面思考几个问题：</p> <ol> <li><code>epoll</code>模型中使用到的红黑树结构相当于<code>select</code>和<code>poll</code>模型中的什么结构？</li> <li>红黑树本质就是<code>key-value</code>模型，那么什么元素作为<code>key</code>？</li> <li>为什么<code>epoll_create</code>函数返回的是一个文件描述符？</li> <li><code>epoll</code>模型为什么比<code>select</code>和<code>poll</code>模型更加高效？</li> </ol> <p>基于上面的问题，下面给出答案：</p> <ol> <li><code>epoll</code>模型中使用到的红黑树结构相当于<code>select</code>和<code>poll</code>模型中的辅助数组，因为本质都是保存着用户需要关心的文件描述符</li> <li>实际上<code>key</code>就是文件描述符，通过文件你描述符可以快速找到具体的一个红黑树节点，查找效率高</li> <li>在Linux中一切皆文件，而在<code>struct file</code>中存在一个<code>private_data</code>指针，<a href=javascript:; class=custom-tooltip data-title='根据Linux内核中的描述：This structure is stored inside the "private_data" member of the file structure'>这个指针在<code>epoll</code>模型中指向<code>struct eventpoll</code>结构</a></li> <li>首先，从内核查找用户需要关系的文件描述符时，<code>epoll</code>模型只需要查找红黑树，而<code>select</code>和<code>poll</code>模型需要遍历整个数组，这个时间消耗上比纯数组要低。其次，当有事件就绪时，对应的红黑树节点会被直接添加到<code>rdlist</code>中，这就可以避免了<code>select</code>和<code>poll</code>模型中需要遍历整个数组的过程，而用户在调用<code>epoll_wait</code>函数时获取到的<code>struct epoll_event *events</code>数组一定是包含着就绪的文件描述符的，此时用户就需要关心这个数组中的数据即可。所以，<code>epoll</code>模型比<code>select</code>和<code>poll</code>模型更加高效</li> </ol> <h2 id=epoll_3><code>epoll</code>实现多路转接<a class=headerlink href=#epoll_3 title="Permanent link">&para;</a></h2> <p>上面已经基本介绍了<code>epoll</code>的接口和实现原理，下面结合上面的介绍对前面通过<code>poll</code>实现的TCP服务器进行修改：</p> <p>首先是初始化部分，因为需要创建<code>epoll</code>模型，所以可以考虑在<code>epollServer</code>的构造函数中进行创建。因为<code>epoll_create</code>函数会返回一个文件描述符表示<code>epoll</code>模型，而且在后面的接口中也会使用到这个文件描述符，且该文件描述符只需要1份，所以考虑创建一个成员变量用于保存该文件描述符：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-6-1><span class=k>class</span><span class=w> </span><span class=nc>EpollServer</span>
</span><span id=__span-6-2><span class=p>{</span>
</span><span id=__span-6-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-6-4><span class=w>    </span><span class=n>EpollServer</span><span class=p>(</span><span class=kt>uint16_t</span><span class=w> </span><span class=n>port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>default_port</span><span class=p>)</span>
</span><span id=__span-6-5><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=n>bs_</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>TcpSocket</span><span class=o>&gt;</span><span class=p>()),</span><span class=w> </span><span class=n>isRunning_</span><span class=p>(</span><span class=nb>false</span><span class=p>),</span><span class=w> </span><span class=n>efd_</span><span class=p>(</span><span class=mi>-1</span><span class=p>)</span>
</span><span id=__span-6-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-6-7><span class=w>        </span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>initSocket</span><span class=p>();</span>
</span><span id=__span-6-8><span class=w>        </span><span class=c1>// 创建epoll模型</span>
</span><span id=__span-6-9><span class=w>        </span><span class=n>efd_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>epoll_create</span><span class=p>(</span><span class=mi>256</span><span class=p>);</span>
</span><span id=__span-6-10><span class=w>    </span><span class=p>}</span>
</span><span id=__span-6-11>
</span><span id=__span-6-12><span class=k>private</span><span class=o>:</span>
</span><span id=__span-6-13><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-6-14><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>efd_</span><span class=p>;</span>
</span><span id=__span-6-15><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>接着，因为服务器需要监听，所以需要在构造函数中将监听套接字和对应的写事件添加到<code>epoll</code>模型中：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-7-1><span class=n>EpollServer</span><span class=p>(</span><span class=kt>uint16_t</span><span class=w> </span><span class=n>port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>default_port</span><span class=p>)</span>
</span><span id=__span-7-2><span class=w>    </span><span class=o>:</span><span class=w> </span><span class=n>bs_</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>TcpSocket</span><span class=o>&gt;</span><span class=p>(</span><span class=n>port</span><span class=p>)),</span><span class=w> </span><span class=n>isRunning_</span><span class=p>(</span><span class=nb>false</span><span class=p>),</span><span class=w> </span><span class=n>efd_</span><span class=p>(</span><span class=mi>-1</span><span class=p>)</span>
</span><span id=__span-7-3><span class=p>{</span>
</span><span id=__span-7-4><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-7-5><span class=w>    </span><span class=c1>// 关心listen_socketfd</span>
</span><span id=__span-7-6><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>epoll_event</span><span class=w> </span><span class=n>ee</span><span class=p>;</span>
</span><span id=__span-7-7><span class=w>    </span><span class=c1>// 关心读事件</span>
</span><span id=__span-7-8><span class=w>    </span><span class=n>ee</span><span class=p>.</span><span class=n>events</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>EPOLLIN</span><span class=p>;</span>
</span><span id=__span-7-9><span class=w>    </span><span class=n>ee</span><span class=p>.</span><span class=n>data</span><span class=p>.</span><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>getListenSocketFd</span><span class=p>();</span>
</span><span id=__span-7-10><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>epoll_ctl</span><span class=p>(</span><span class=n>efd_</span><span class=p>,</span><span class=w> </span><span class=n>EPOLL_CTL_ADD</span><span class=p>,</span><span class=w> </span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>getListenSocketFd</span><span class=p>(),</span><span class=w> </span><span class=o>&amp;</span><span class=n>ee</span><span class=p>);</span>
</span><span id=__span-7-11><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>启动服务器时，需要<code>epoll</code>模型进行等待，所以在<code>startServer</code>函数中将原来的<code>poll</code>接口替换为<code>epoll_wait</code>接口，另外，本次考虑使用间隔1秒的方式进行等待，所以还需要设置<code>epoll_wait</code>函数的超时时间：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-8-1><span class=kt>void</span><span class=w> </span><span class=nf>startServer</span><span class=p>()</span>
</span><span id=__span-8-2><span class=p>{</span>
</span><span id=__span-8-3><span class=w>    </span><span class=n>isRunning_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-8-4><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>isRunning_</span><span class=p>)</span>
</span><span id=__span-8-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-8-6><span class=w>        </span><span class=c1>// 不再需要在循环中多次设置监听套接字到读文件描述符集中</span>
</span><span id=__span-8-7><span class=w>        </span><span class=c1>// 等待1秒</span>
</span><span id=__span-8-8><span class=w>        </span><span class=k>const</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>timeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1000</span><span class=p>;</span>
</span><span id=__span-8-9><span class=w>        </span><span class=c1>// 只关心读事件的文件描述符集</span>
</span><span id=__span-8-10><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>epoll_wait</span><span class=p>(</span><span class=n>efd_</span><span class=p>,</span><span class=w> </span><span class=n>fd_array_</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>(),</span><span class=w> </span><span class=n>g_fd_array_num</span><span class=p>,</span><span class=w> </span><span class=n>timeout</span><span class=p>);</span>
</span><span id=__span-8-11><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-8-12><span class=w>        </span><span class=p>{</span>
</span><span id=__span-8-13><span class=w>            </span><span class=c1>// 监听套接字文件描述符准备完毕</span>
</span><span id=__span-8-14><span class=w>            </span><span class=n>handler</span><span class=p>(</span><span class=n>n</span><span class=p>);</span>
</span><span id=__span-8-15><span class=w>        </span><span class=p>}</span>
</span><span id=__span-8-16><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-8-17><span class=w>        </span><span class=p>{</span>
</span><span id=__span-8-18><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;没有客户端连接&quot;</span><span class=p>;</span>
</span><span id=__span-8-19><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-8-20><span class=w>        </span><span class=p>}</span>
</span><span id=__span-8-21><span class=w>    </span><span class=p>}</span>
</span><span id=__span-8-22><span class=w>    </span><span class=n>isRunning_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-8-23><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>此时，一旦监听套接字就绪，就说明有对应的客户端进行了连接，此时调用<code>toAccept</code>函数获取到对应的<code>ac_socketfd</code>，并将其添加到<code>epoll</code>模型中，但是<code>epoll</code>模型中可能不只有一个文件描述符和对应的事件，所以需要遍历<code>epoll_wait</code>接口返回的数组，这里因为内核添加内容是按照数组从0下标开始填充，所以可以按照正常遍历数组的方式进行，判断当前是否是监听套接字，如果是监听套接字就调用<code>toAccept</code>函数进行处理，否则就调用<code>recvData</code>函数进行处理：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-9-1><span class=kt>void</span><span class=w> </span><span class=nf>handler</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>)</span>
</span><span id=__span-9-2><span class=p>{</span>
</span><span id=__span-9-3><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-9-4><span class=w>    </span><span class=p>{</span>
</span><span id=__span-9-5><span class=w>        </span><span class=c1>// 保证一定是就绪事件</span>
</span><span id=__span-9-6><span class=w>        </span><span class=c1>// 判断当前是否是监听套接字</span>
</span><span id=__span-9-7><span class=w>        </span><span class=k>if</span><span class=p>((</span><span class=o>*</span><span class=n>fd_array_</span><span class=p>)[</span><span class=n>i</span><span class=p>].</span><span class=n>data</span><span class=p>.</span><span class=n>fd</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>getListenSocketFd</span><span class=p>())</span>
</span><span id=__span-9-8><span class=w>        </span><span class=p>{</span>
</span><span id=__span-9-9><span class=w>            </span><span class=c1>// 获取链接</span>
</span><span id=__span-9-10><span class=w>            </span><span class=n>SockAddrIn</span><span class=w> </span><span class=n>client</span><span class=p>;</span>
</span><span id=__span-9-11><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>ac_socketfd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>toAccept</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>addressof</span><span class=p>(</span><span class=n>client</span><span class=p>));</span>
</span><span id=__span-9-12>
</span><span id=__span-9-13><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>ac_socketfd</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-9-14><span class=w>            </span><span class=p>{</span>
</span><span id=__span-9-15><span class=w>                </span><span class=c1>// 添加到epoll模型中</span>
</span><span id=__span-9-16><span class=w>                </span><span class=k>struct</span><span class=w> </span><span class=nc>epoll_event</span><span class=w> </span><span class=n>ev</span><span class=p>;</span>
</span><span id=__span-9-17><span class=w>                </span><span class=n>ev</span><span class=p>.</span><span class=n>events</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>EPOLLIN</span><span class=p>;</span>
</span><span id=__span-9-18><span class=w>                </span><span class=n>ev</span><span class=p>.</span><span class=n>data</span><span class=p>.</span><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ac_socketfd</span><span class=p>;</span>
</span><span id=__span-9-19><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>epoll_ctl</span><span class=p>(</span><span class=n>efd_</span><span class=p>,</span><span class=w> </span><span class=n>EPOLL_CTL_ADD</span><span class=p>,</span><span class=w> </span><span class=n>ac_socketfd</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>ev</span><span class=p>);</span>
</span><span id=__span-9-20><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-9-21><span class=w>                </span><span class=p>{</span>
</span><span id=__span-9-22><span class=w>                    </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;添加事件失败&quot;</span><span class=p>;</span>
</span><span id=__span-9-23><span class=w>                    </span><span class=n>exit</span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>ErrorNumber</span><span class=o>::</span><span class=n>Epoll_Ctl_Fail</span><span class=p>));</span>
</span><span id=__span-9-24><span class=w>                </span><span class=p>}</span>
</span><span id=__span-9-25><span class=w>            </span><span class=p>}</span>
</span><span id=__span-9-26><span class=w>        </span><span class=p>}</span>
</span><span id=__span-9-27><span class=w>        </span><span class=k>else</span><span class=w> </span>
</span><span id=__span-9-28><span class=w>        </span><span class=p>{</span>
</span><span id=__span-9-29><span class=w>            </span><span class=c1>// 不是监听套接字</span>
</span><span id=__span-9-30><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>buffer</span><span class=p>;</span>
</span><span id=__span-9-31><span class=w>            </span><span class=kt>ssize_t</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>recvData</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>fd_array_</span><span class=p>)[</span><span class=n>i</span><span class=p>].</span><span class=n>data</span><span class=p>.</span><span class=n>fd</span><span class=p>);</span>
</span><span id=__span-9-32><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-9-33><span class=w>            </span><span class=p>{</span>
</span><span id=__span-9-34><span class=w>                </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;客户端发送：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>buffer</span><span class=p>;</span>
</span><span id=__span-9-35><span class=w>            </span><span class=p>}</span>
</span><span id=__span-9-36><span class=w>            </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-9-37><span class=w>            </span><span class=p>{</span>
</span><span id=__span-9-38><span class=w>                </span><span class=c1>// 恢复操作</span>
</span><span id=__span-9-39><span class=w>                </span><span class=c1>// 从红黑树中移除指定文件描述符，此时不再需要关心事件</span>
</span><span id=__span-9-40><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>epoll_ctl</span><span class=p>(</span><span class=n>efd_</span><span class=p>,</span><span class=w> </span><span class=n>EPOLL_CTL_DEL</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>fd_array_</span><span class=p>)[</span><span class=n>i</span><span class=p>].</span><span class=n>data</span><span class=p>.</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=k>nullptr</span><span class=p>);</span>
</span><span id=__span-9-41><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-9-42><span class=w>                </span><span class=p>{</span>
</span><span id=__span-9-43><span class=w>                    </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;移除事件失败&quot;</span><span class=p>;</span>
</span><span id=__span-9-44><span class=w>                    </span><span class=n>exit</span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>ErrorNumber</span><span class=o>::</span><span class=n>Epoll_Ctl_Fail</span><span class=p>));</span>
</span><span id=__span-9-45><span class=w>                </span><span class=p>}</span>
</span><span id=__span-9-46><span class=w>            </span><span class=p>}</span>
</span><span id=__span-9-47><span class=w>            </span><span class=k>else</span>
</span><span id=__span-9-48><span class=w>            </span><span class=p>{</span>
</span><span id=__span-9-49><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>epoll_ctl</span><span class=p>(</span><span class=n>efd_</span><span class=p>,</span><span class=w> </span><span class=n>EPOLL_CTL_DEL</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>fd_array_</span><span class=p>)[</span><span class=n>i</span><span class=p>].</span><span class=n>data</span><span class=p>.</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=k>nullptr</span><span class=p>);</span>
</span><span id=__span-9-50><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-9-51><span class=w>                </span><span class=p>{</span>
</span><span id=__span-9-52><span class=w>                    </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;移除事件失败&quot;</span><span class=p>;</span>
</span><span id=__span-9-53><span class=w>                    </span><span class=n>exit</span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>ErrorNumber</span><span class=o>::</span><span class=n>Epoll_Ctl_Fail</span><span class=p>));</span>
</span><span id=__span-9-54><span class=w>                </span><span class=p>}</span>
</span><span id=__span-9-55><span class=w>            </span><span class=p>}</span>
</span><span id=__span-9-56><span class=w>        </span><span class=p>}</span>
</span><span id=__span-9-57><span class=w>    </span><span class=p>}</span>
</span><span id=__span-9-58><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>与<code>select</code>和<code>poll</code>一样，此时不可以直接读取，虽然<code>toAccept</code>此时不会阻塞，但是<code>toRead</code>函数会阻塞，所以需要现将<code>ac_socketfd</code>添加到<code>epoll</code>模型中，再下一次遍历时一旦是<code>ac_socketfd</code>就绪，就可以调用<code>recvData</code>函数进行数据读取</p> <p>直接编译运行上面的代码会发现，连接客户端没有问题和接收客户端发送的消息时没有问题，但是在客户端退出时会提示：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-10-1>[2025-04-09 11-18-28] [WARNING] [11674] [epollServer.hpp] [103] - 移除事件失败
</span></code></pre></div></td></tr></table></div> <p>出现这个问题的原因是当<code>recvData</code>中的<code>recv</code>函数返回0时，会将对应的文件描述符关闭，如下面的逻辑：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-11-1><span class=kt>ssize_t</span><span class=w> </span><span class=nf>recvData</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>out_data</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>ac_socketfd</span><span class=p>)</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-11-2><span class=p>{</span>
</span><span id=__span-11-3><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>buffer</span><span class=p>[</span><span class=mi>4096</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span><span id=__span-11-4><span class=w>    </span><span class=kt>ssize_t</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>recv</span><span class=p>(</span><span class=n>ac_socketfd</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>buffer</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-11-5><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-11-6><span class=w>        </span><span class=n>out_data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buffer</span><span class=p>;</span>
</span><span id=__span-11-7><span class=w>    </span><span class=k>else</span>
</span><span id=__span-11-8><span class=w>        </span><span class=n>close</span><span class=p>(</span><span class=n>ac_socketfd</span><span class=p>);</span>
</span><span id=__span-11-9>
</span><span id=__span-11-10><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>ret</span><span class=p>;</span>
</span><span id=__span-11-11><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>一旦文件描述符被关闭，那么此时就会造成对应的文件描述符变成无效的文件描述符，而<code>epoll_wait</code>函数如果要操作指定的文件描述符必须要保证该文件描述符是有效的，所以此时就会出现上面的错误提示，所以考虑移除<code>recvData</code>函数中的<code>close</code>函数，此时的代码如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-12-1><span class=c1>// 接收数据</span>
</span><span id=__span-12-2><span class=kt>ssize_t</span><span class=w> </span><span class=nf>recvData</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>out_data</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>ac_socketfd</span><span class=p>)</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-12-3><span class=p>{</span>
</span><span id=__span-12-4><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>buffer</span><span class=p>[</span><span class=mi>4096</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span><span id=__span-12-5><span class=w>    </span><span class=kt>ssize_t</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>recv</span><span class=p>(</span><span class=n>ac_socketfd</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>buffer</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-12-6><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-12-7><span class=w>        </span><span class=n>out_data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buffer</span><span class=p>;</span>
</span><span id=__span-12-8>
</span><span id=__span-12-9><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>ret</span><span class=p>;</span>
</span><span id=__span-12-10><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>接着，在调用<code>epoll_ctl</code>函数之后关闭文件描述符：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-13-1><span class=kt>void</span><span class=w> </span><span class=nf>handler</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>)</span>
</span><span id=__span-13-2><span class=p>{</span>
</span><span id=__span-13-3><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-13-4><span class=w>    </span><span class=p>{</span>
</span><span id=__span-13-5><span class=w>        </span><span class=c1>// 保证一定是就绪事件</span>
</span><span id=__span-13-6><span class=w>        </span><span class=c1>// 判断当前是否是监听套接字</span>
</span><span id=__span-13-7><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-13-8><span class=w>        </span><span class=k>else</span><span class=w> </span>
</span><span id=__span-13-9><span class=w>        </span><span class=p>{</span>
</span><span id=__span-13-10><span class=w>            </span><span class=c1>// 不是监听套接字</span>
</span><span id=__span-13-11><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>buffer</span><span class=p>;</span>
</span><span id=__span-13-12><span class=w>            </span><span class=kt>ssize_t</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>recvData</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>fd_array_</span><span class=p>)[</span><span class=n>i</span><span class=p>].</span><span class=n>data</span><span class=p>.</span><span class=n>fd</span><span class=p>);</span>
</span><span id=__span-13-13><span class=w>            </span><span class=c1>// ...</span>
</span><span id=__span-13-14><span class=w>            </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-13-15><span class=w>            </span><span class=p>{</span>
</span><span id=__span-13-16><span class=w>                </span><span class=c1>// ...</span>
</span><span id=__span-13-17><span class=w>                </span><span class=c1>// 在移除之后关闭文件描述符</span>
</span><span id=__span-13-18><span class=w>                </span><span class=n>close</span><span class=p>((</span><span class=o>*</span><span class=n>fd_array_</span><span class=p>)[</span><span class=n>i</span><span class=p>].</span><span class=n>data</span><span class=p>.</span><span class=n>fd</span><span class=p>);</span>
</span><span id=__span-13-19><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-13-20><span class=w>                </span><span class=p>{</span>
</span><span id=__span-13-21><span class=w>                    </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;移除事件失败&quot;</span><span class=p>;</span>
</span><span id=__span-13-22><span class=w>                    </span><span class=n>exit</span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>ErrorNumber</span><span class=o>::</span><span class=n>Epoll_Ctl_Fail</span><span class=p>));</span>
</span><span id=__span-13-23><span class=w>                </span><span class=p>}</span>
</span><span id=__span-13-24><span class=w>            </span><span class=p>}</span>
</span><span id=__span-13-25><span class=w>            </span><span class=k>else</span>
</span><span id=__span-13-26><span class=w>            </span><span class=p>{</span>
</span><span id=__span-13-27><span class=w>                </span><span class=c1>// ...</span>
</span><span id=__span-13-28><span class=w>                </span><span class=c1>// 在移除之后关闭文件描述符</span>
</span><span id=__span-13-29><span class=w>                </span><span class=n>close</span><span class=p>((</span><span class=o>*</span><span class=n>fd_array_</span><span class=p>)[</span><span class=n>i</span><span class=p>].</span><span class=n>data</span><span class=p>.</span><span class=n>fd</span><span class=p>);</span>
</span><span id=__span-13-30><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-13-31><span class=w>                </span><span class=p>{</span>
</span><span id=__span-13-32><span class=w>                    </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;移除事件失败&quot;</span><span class=p>;</span>
</span><span id=__span-13-33><span class=w>                    </span><span class=n>exit</span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>ErrorNumber</span><span class=o>::</span><span class=n>Epoll_Ctl_Fail</span><span class=p>));</span>
</span><span id=__span-13-34><span class=w>                </span><span class=p>}</span>
</span><span id=__span-13-35><span class=w>            </span><span class=p>}</span>
</span><span id=__span-13-36><span class=w>        </span><span class=p>}</span>
</span><span id=__span-13-37><span class=w>    </span><span class=p>}</span>
</span><span id=__span-13-38><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>运行上面的代码可以发现与<code>select</code>和<code>poll</code>一样实现了多路转接</p> <h2 id=_2>水平触发和边缘触发<a class=headerlink href=#_2 title="Permanent link">&para;</a></h2> <p>在<code>epoll</code>模型中，有两种触发方式：</p> <ol> <li>水平触发（LT，Level Trigger）：当文件描述符对应的事件发生时，会一直通知上层，直到上层将事件处理完毕</li> <li>边缘触发（ET，Edge Trigger）：当文件描述符对应的事件发生时，如果没有数据增多时，只会通知上层一次，这就导致了如果上层没有及时处理事件，那么后续的事件就会丢失，所以边缘出发会强制用户一次性读取完所有的数据</li> </ol> <p>实现水平触发和边缘触发的逻辑可以理解为：</p> <ul> <li> <p><strong>水平触发(LT)</strong>：当有事件就绪时，该事件对应的红黑树节点会被添加到就绪队列<code>rdlist</code>中，只要继续队列中存在节点就会一直通知上层，直到上层将事件处理完毕</p> </li> <li> <p><strong>边缘触发(ET)</strong>：当有事件就绪时，内核只会在刚就绪时通知一次，除非后续该文件描述符上关心的事件有数据增加。比如从无数据到有数据时触发一次<code>EPOLLIN</code>，之后即使缓冲区还有数据也不会再次通知</p> </li> </ul> <p>默认情况下，<code>epoll</code>使用的是水平触发模式。但是实际上，边缘触发模式更加高效，但是因为没有多次通知，所以要确保数据被完全读取完毕，就需要循环调用读取函数知道读到返回值为0为止，但是如果返回值为0，那么根据前面的经验，读取函数就会被阻塞，此时尽管<code>epoll</code>没有阻塞，但是读取函数一旦阻塞，服务器还是会卡住针对这个问题，解决方案就是<strong>将读取文件描述符设置为非阻塞</strong>。那么为什么边缘触发模式更高效？实际上，因为需要上层一次性把所有数据读取完毕，那么只要开始读取对应的接收缓冲区就可以保证越来越大，下一次服务端向客户端返回的窗口大小也会变大，从而提高了IO吞吐量，所以边缘触发模式更加高效</p> <details class=info> <summary>IO吞吐量</summary> <p>IO吞吐量（Input/Output Throughput）是。IO吞吐量指单位时间内系统能处理的数据量，通常以MB/s或GB/s为单位，常用于衡量系统IO性能的关键指标，特别是在高并发网络编程中。在网络编程中，它反映了服务器处理网络数据的能力</p> <p>在Linux下可以使用<code>iftop</code>命令查看IO吞吐量，但是首先需要安装<code>iftop</code>工具：</p> <div class="language-bash highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-14-1>sudo<span class=w> </span>apt<span class=w> </span>install<span class=w> </span>iftop
</span></code></pre></div></td></tr></table></div> <p>再使用下面的命令查看IO吞吐量：</p> <div class="language-bash highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-15-1>sudo<span class=w> </span>iftop<span class=w> </span>-i<span class=w> </span>eth0<span class=w> </span>-n<span class=w> </span>-P
</span></code></pre></div></td></tr></table></div> </details> <h2 id=epolltcp>基于边缘触发模式的<code>epoll</code>实现基本TCP服务器结构<a class=headerlink href=#epolltcp title="Permanent link">&para;</a></h2> <h3 id=_3>基本思路<a class=headerlink href=#_3 title="Permanent link">&para;</a></h3> <p>本次为了后面实现方便，首先对使用<code>epoll</code>实现多路转接的接口进行封装，接着，为了保证低耦合度，考虑将每一个客户端与服务端的连接设计为一个连接结构<code>Connection</code>的对象，这样可以保证在<code>EpollServer</code>看来，只有一个一个的连接对象而不是各种文件描述符。但是，除了有用于客户端和服务端进行数据通信的文件描述符外，还有监听套接字对应的文件描述符，而对于监听套接字来说，实际上其只关心读时间，所以可以考虑将监听套接字对应的文件描述符和普通的文件描述符看做一类连接结构对象，只是需要实现的方法不同</p> <p>上面的问题解决了底层<code>EpollServer</code>和上层连接之间的关系，但是上层连接有两种情况：</p> <ol> <li>文件描述符对应的是监听套接字，执行的行为是建立客户端与服务端的连接</li> <li>文件描述符对应的是普通的文件描述符，执行的行为是与客户端进行数据通信</li> </ol> <p>所以对于这一点，可以考虑设计两个类，一个类是<code>Listener</code>，表示的是监听套接字和其对应接口的封装，另一个类是<code>IOService</code>，表示的是普通的文件描述符和其对应接口的封装</p> <h3 id=connection>实现<code>Connection</code>类基本结构<a class=headerlink href=#connection title="Permanent link">&para;</a></h3> <p>首先是<code>Connection</code>类，该类需要管理每一次的连接，所以需要有一个成员变量用于保存对应的文件描述符。另外，在前面不论是<code>select</code>与<code>poll</code>还是<code>epoll</code>实现的TCP服务器都存在着一个问题：读操作不能保证读取到的是完整的数据。因为前面的实现中缓冲区都是一个临时变量，一旦离开了当前读取的过程就会被销毁，为了解决读取到完整的数据，就必须对上一次读取的数据进行缓存，再次读取时将该数据与上一次的数据进行拼接直到有完整的数据，所以考虑在<code>Connection</code>类中还需要添加<code>in_buffer_</code>成员，同样的再提供一个<code>out_buffer_</code>成员。接着，因为底层的<code>EpollServer</code>管理的是连接结构对象，所以为了可以看到客户端的信息，还需要提供一个用于保存客户端信息结构的成员变量，这个类型即为前面封装的<code>SockAddrIn</code>类，所以当前<code>Connection</code>类的结构如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-16-1><span class=k>class</span><span class=w> </span><span class=nc>Connection</span>
</span><span id=__span-16-2><span class=p>{</span>
</span><span id=__span-16-3><span class=k>private</span><span class=o>:</span>
</span><span id=__span-16-4><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>fd_</span><span class=p>;</span><span class=w> </span><span class=c1>// 当前套接字</span>
</span><span id=__span-16-5><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>in_buffer_</span><span class=p>;</span><span class=w> </span><span class=c1>// 读取缓冲区</span>
</span><span id=__span-16-6><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>out_buffer_</span><span class=p>;</span><span class=w> </span><span class=c1>// 写入缓冲区</span>
</span><span id=__span-16-7><span class=w>    </span><span class=n>SockAddrIn</span><span class=w> </span><span class=n>client_</span><span class=p>;</span><span class=w> </span><span class=c1>// 客户端信息</span>
</span><span id=__span-16-8><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>除了上面的信息外，为了保证当前<code>Connection</code>类既可以表示普通的文件描述符，还可以表示监听套接字，这里可以考虑将<code>Connection</code>作为基类，提供三个纯虚函数由子类进行实现，分别表示读、写和异常，如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-17-1><span class=k>class</span><span class=w> </span><span class=nc>Connection</span>
</span><span id=__span-17-2><span class=p>{</span>
</span><span id=__span-17-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-17-4><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-17-5>
</span><span id=__span-17-6><span class=w>    </span><span class=c1>// 读、写和异常纯虚函数</span>
</span><span id=__span-17-7><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=n>recvData</span><span class=p>()</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-17-8><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendData</span><span class=p>()</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-17-9><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handleException</span><span class=p>()</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-17-10>
</span><span id=__span-17-11><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-17-12><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>接着，为了保证子类可以访问到<code>Connection</code>类的成员变量，这里可以将<code>Connection</code>类的成员变量设置为<code>protected</code>，这样子类就可以直接访问到父类的成员变量，如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-18-1><span class=k>class</span><span class=w> </span><span class=nc>Connection</span>
</span><span id=__span-18-2><span class=p>{</span>
</span><span id=__span-18-3><span class=c1>// ...</span>
</span><span id=__span-18-4><span class=c1>// private:</span>
</span><span id=__span-18-5><span class=k>protected</span><span class=o>:</span>
</span><span id=__span-18-6><span class=c1>// ...</span>
</span><span id=__span-18-7><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>因为<code>EpollServer</code>类会管理每一个<code>Connection</code>对象，而<code>EpollServer</code>类会对每一个文件描述符进行关心，但是具体关心哪种事件当前在<code>Connection</code>类中并没有体现，所以还需要在<code>Connection</code>添加一个成员变量用于表示当前<code>Connection</code>关心的事件，类型为<code>uint32_t</code>，如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-19-1><span class=k>class</span><span class=w> </span><span class=nc>Connection</span>
</span><span id=__span-19-2><span class=p>{</span>
</span><span id=__span-19-3><span class=k>private</span><span class=o>:</span>
</span><span id=__span-19-4><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-19-5>
</span><span id=__span-19-6><span class=w>    </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>events_</span><span class=p>;</span><span class=w> </span><span class=c1>// 事件类型</span>
</span><span id=__span-19-7><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>同样的，可以添加一个成员变量<code>revents</code>表示就绪的事件：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-20-1><span class=k>class</span><span class=w> </span><span class=nc>Connection</span>
</span><span id=__span-20-2><span class=p>{</span>
</span><span id=__span-20-3><span class=k>private</span><span class=o>:</span>
</span><span id=__span-20-4><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-20-5>
</span><span id=__span-20-6><span class=w>    </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>revents_</span><span class=p>;</span><span class=w> </span><span class=c1>// 就绪事件类型</span>
</span><span id=__span-20-7><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>接下来需要对一些成员变量进行初始化，本次考虑在<code>Connection</code>类的构造函数中进行初始化操作：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-21-1><span class=n>Connection</span><span class=p>()</span>
</span><span id=__span-21-2><span class=w>    </span><span class=o>:</span><span class=n>fd_</span><span class=p>(</span><span class=mi>-1</span><span class=p>),</span><span class=w> </span><span class=n>events_</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span><span class=w> </span><span class=n>revents_</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-21-3><span class=p>{}</span>
</span></code></pre></div></td></tr></table></div> <p>接着，提供一些设置函数，如下：</p> <div class="tabbed-set tabbed-alternate" data-tabs=2:4><input checked=checked id=__tabbed_2_1 name=__tabbed_2 type=radio><input id=__tabbed_2_2 name=__tabbed_2 type=radio><input id=__tabbed_2_3 name=__tabbed_2 type=radio><input id=__tabbed_2_4 name=__tabbed_2 type=radio><div class=tabbed-labels><label for=__tabbed_2_1>设置<code>client_</code></label><label for=__tabbed_2_2>设置<code>events_</code></label><label for=__tabbed_2_3>设置<code>revents_</code></label><label for=__tabbed_2_4>设置<code>fd_</code></label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-22-1><span class=c1>// 设置client</span>
</span><span id=__span-22-2><span class=kt>void</span><span class=w> </span><span class=nf>setClient</span><span class=p>(</span><span class=n>SockAddrIn</span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>client</span><span class=p>)</span>
</span><span id=__span-22-3><span class=p>{</span>
</span><span id=__span-22-4><span class=w>    </span><span class=n>client_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>client</span><span class=p>;</span>
</span><span id=__span-22-5><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-23-1><span class=c1>// 设置事件</span>
</span><span id=__span-23-2><span class=kt>void</span><span class=w> </span><span class=nf>setEvent</span><span class=p>(</span><span class=kt>uint32_t</span><span class=w> </span><span class=n>events</span><span class=p>)</span>
</span><span id=__span-23-3><span class=p>{</span>
</span><span id=__span-23-4><span class=w>    </span><span class=n>events_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>events</span><span class=p>;</span>
</span><span id=__span-23-5><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-24-1><span class=c1>// 设置就绪事件</span>
</span><span id=__span-24-2><span class=kt>void</span><span class=w> </span><span class=nf>setRevents</span><span class=p>(</span><span class=kt>uint32_t</span><span class=w> </span><span class=n>revents</span><span class=p>)</span>
</span><span id=__span-24-3><span class=p>{</span>
</span><span id=__span-24-4><span class=w>    </span><span class=n>revents_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>revents</span><span class=p>;</span>
</span><span id=__span-24-5><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-25-1><span class=c1>// 设置文件描述符</span>
</span><span id=__span-25-2><span class=kt>void</span><span class=w> </span><span class=nf>setFd</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>fd</span><span class=p>)</span>
</span><span id=__span-25-3><span class=p>{</span>
</span><span id=__span-25-4><span class=w>    </span><span class=n>fd_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fd</span><span class=p>;</span>
</span><span id=__span-25-5><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>最后，提供一些获取函数，如下：</p> <div class="tabbed-set tabbed-alternate" data-tabs=3:4><input checked=checked id=__tabbed_3_1 name=__tabbed_3 type=radio><input id=__tabbed_3_2 name=__tabbed_3 type=radio><input id=__tabbed_3_3 name=__tabbed_3 type=radio><input id=__tabbed_3_4 name=__tabbed_3 type=radio><div class=tabbed-labels><label for=__tabbed_3_1>获取客户端信息</label><label for=__tabbed_3_2>获取文件描述符</label><label for=__tabbed_3_3>获取事件</label><label for=__tabbed_3_4>获取就绪事件</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-26-1><span class=c1>// 获取客户端信息</span>
</span><span id=__span-26-2><span class=n>SockAddrIn</span><span class=w> </span><span class=nf>getClientInfo</span><span class=p>()</span>
</span><span id=__span-26-3><span class=p>{</span>
</span><span id=__span-26-4><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>client_</span><span class=p>;</span>
</span><span id=__span-26-5><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-27-1><span class=c1>// 获取文件描述符</span>
</span><span id=__span-27-2><span class=kt>int</span><span class=w> </span><span class=nf>getFd</span><span class=p>()</span>
</span><span id=__span-27-3><span class=p>{</span>
</span><span id=__span-27-4><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>fd_</span><span class=p>;</span>
</span><span id=__span-27-5><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-28-1><span class=c1>// 获取事件类型</span>
</span><span id=__span-28-2><span class=kt>uint32_t</span><span class=w> </span><span class=nf>getEvents</span><span class=p>()</span>
</span><span id=__span-28-3><span class=p>{</span>
</span><span id=__span-28-4><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>events_</span><span class=p>;</span>
</span><span id=__span-28-5><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-29-1><span class=c1>// 获取就绪事件类型</span>
</span><span id=__span-29-2><span class=kt>uint32_t</span><span class=w> </span><span class=nf>getRevents</span><span class=p>()</span>
</span><span id=__span-29-3><span class=p>{</span>
</span><span id=__span-29-4><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>revents_</span><span class=p>;</span>
</span><span id=__span-29-5><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <h3 id=epollserver>实现<code>EpollServer</code>类基本结构<a class=headerlink href=#epollserver title="Permanent link">&para;</a></h3> <p>接着是<code>EpollServer</code>类，该类需要管理每一个<code>Connection</code>对象，因为<code>EpollServer</code>类需要对具体的描述符进行关心，而根据<code>Connection</code>类的设计：包含需要关心的事件，所以可以考虑在<code>EpollServer</code>类中创建一张哈希表存储文件描述符和<code>Connection</code>类对象的映射关系，本次考虑实现文件描述符和<code>Connection</code>类对象指针进行映射的方式如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-30-1><span class=k>using</span><span class=w> </span><span class=n>conn_t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>Connection</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-30-2>
</span><span id=__span-30-3><span class=k>class</span><span class=w> </span><span class=nc>EpollServer</span>
</span><span id=__span-30-4><span class=p>{</span>
</span><span id=__span-30-5><span class=k>private</span><span class=o>:</span>
</span><span id=__span-30-6><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unordered_map</span><span class=o>&lt;</span><span class=kt>int</span><span class=p>,</span><span class=w> </span><span class=n>conn_t</span><span class=o>&gt;</span><span class=w> </span><span class=n>connections_</span><span class=p>;</span><span class=w> </span><span class=c1>// 文件描述符与Connection类对象指针的映射关系</span>
</span><span id=__span-30-7><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>接着，因为<code>EpollServer</code>类会接收<code>epoll_wait</code>返回的就绪事件数组，所以可以考虑在<code>EpollServer</code>类中创建一个数组用于存储，这里使用定长数组，在构造时初始化对应的指针，如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-31-1><span class=k>class</span><span class=w> </span><span class=nc>EpollServer</span>
</span><span id=__span-31-2><span class=p>{</span>
</span><span id=__span-31-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-31-4><span class=w>    </span><span class=n>EpollServer</span><span class=p>()</span>
</span><span id=__span-31-5><span class=w>        </span><span class=o>:</span><span class=n>revents_arr_</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=k>struct</span><span class=w> </span><span class=nc>epoll_event</span><span class=p>,</span><span class=w> </span><span class=n>g_default_array_num</span><span class=o>&gt;&gt;</span><span class=p>())</span>
</span><span id=__span-31-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-31-7>
</span><span id=__span-31-8><span class=w>    </span><span class=p>}</span>
</span><span id=__span-31-9>
</span><span id=__span-31-10><span class=k>private</span><span class=o>:</span>
</span><span id=__span-31-11><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-31-12><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=k>struct</span><span class=w> </span><span class=nc>epoll_event</span><span class=p>,</span><span class=w> </span><span class=n>g_default_array_num</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>revents_arr_</span><span class=p>;</span><span class=w> </span><span class=c1>// 就绪事件数组</span>
</span><span id=__span-31-13><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <h3 id=epollepoll>实现<code>epoll</code>接口封装类<code>Epoll</code>基本结构<a class=headerlink href=#epollepoll title="Permanent link">&para;</a></h3> <p>因为<code>epoll</code>的设置接口和等待接口都会使用到<code>epoll</code>模型对应的文件描述符，所以考虑在<code>Epoll</code>类中创建一个成员变量存储该文件描述符，接着，既然是封装接口，就没有必要单独提供一个创建<code>epoll</code>模型的接口，所以可以考虑在<code>Epoll</code>类的构造函数中创建<code>epoll</code>模型，如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-32-1><span class=k>class</span><span class=w> </span><span class=nc>Epoll</span>
</span><span id=__span-32-2><span class=p>{</span>
</span><span id=__span-32-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-32-4><span class=w>    </span><span class=n>Epoll</span><span class=p>()</span>
</span><span id=__span-32-5><span class=w>        </span><span class=o>:</span><span class=n>epfd_</span><span class=p>(</span><span class=mi>-1</span><span class=p>)</span>
</span><span id=__span-32-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-32-7><span class=w>        </span><span class=n>epfd_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>epoll_create</span><span class=p>(</span><span class=mi>256</span><span class=p>);</span>
</span><span id=__span-32-8><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>epfd_</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-32-9><span class=w>        </span><span class=p>{</span>
</span><span id=__span-32-10><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>ERROR</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Epoll模型创建失败&quot;</span><span class=p>;</span>
</span><span id=__span-32-11><span class=w>            </span><span class=n>exit</span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>ErrorNumber</span><span class=o>::</span><span class=n>Epoll_Create_Fail</span><span class=p>));</span>
</span><span id=__span-32-12><span class=w>        </span><span class=p>}</span>
</span><span id=__span-32-13>
</span><span id=__span-32-14><span class=w>        </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Epoll模型创建成功&quot;</span><span class=p>;</span>
</span><span id=__span-32-15><span class=w>    </span><span class=p>}</span>
</span><span id=__span-32-16>
</span><span id=__span-32-17><span class=k>private</span><span class=o>:</span>
</span><span id=__span-32-18><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>epfd_</span><span class=p>;</span>
</span><span id=__span-32-19><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>接着在<code>EpollServer</code>中添加一个成员变量指针用于表示<code>Epoll</code>类对象，这样在<code>EpollServer</code>类中就可以调用封装后的接口。在构造函数初始化列表中对该指针进行初始化：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-33-1><span class=k>class</span><span class=w> </span><span class=nc>EpollServer</span>
</span><span id=__span-33-2><span class=p>{</span>
</span><span id=__span-33-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-33-4><span class=w>    </span><span class=n>EpollServer</span><span class=p>()</span>
</span><span id=__span-33-5><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-33-6><span class=w>        </span><span class=p>,</span><span class=n>ep_</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>Epoll</span><span class=o>&gt;</span><span class=p>())</span>
</span><span id=__span-33-7><span class=w>    </span><span class=p>{</span>
</span><span id=__span-33-8>
</span><span id=__span-33-9><span class=w>    </span><span class=p>}</span>
</span><span id=__span-33-10>
</span><span id=__span-33-11><span class=k>private</span><span class=o>:</span>
</span><span id=__span-33-12><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-33-13><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>Epoll</span><span class=o>&gt;</span><span class=w> </span><span class=n>ep_</span><span class=p>;</span><span class=w> </span><span class=c1>// 封装的Epoll类</span>
</span><span id=__span-33-14><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <h3 id=epollepollserver>设计<code>Epoll</code>类和<code>EpollServer</code>类<a class=headerlink href=#epollepollserver title="Permanent link">&para;</a></h3> <p>在下面进行设计之前先回顾之前的思路：</p> <p>在本次实现中，<code>Epoll</code>接口封装类是最底层的类，而<code>EpollServer</code>类是<code>Epoll</code>接口封装类的上层类，这个服务器用于处理IO，而网络服务本质都是IO，所以网络服务相关的类（客户端与服务端建立连接和客户端与服务端进行数据通信）都在<code>EpollServer</code>类的上层，但是为了统一<code>EpollServer</code>视角，利用到了<code>Connection</code>类的中间层</p> <p>首先既然要将文件描述符添加到<code>epoll</code>模型中，那么首先需要的就是在<code>Epoll</code>类中提供添加文件描述符到<code>epoll</code>模型的接口，如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-34-1><span class=kt>void</span><span class=w> </span><span class=nf>epollCtl</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>events</span><span class=p>)</span>
</span><span id=__span-34-2><span class=p>{</span>
</span><span id=__span-34-3><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>epoll_event</span><span class=w> </span><span class=n>ev</span><span class=p>;</span>
</span><span id=__span-34-4><span class=w>    </span><span class=n>ev</span><span class=p>.</span><span class=n>events</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>events</span><span class=p>;</span>
</span><span id=__span-34-5><span class=w>    </span><span class=n>ev</span><span class=p>.</span><span class=n>data</span><span class=p>.</span><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fd</span><span class=p>;</span>
</span><span id=__span-34-6><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>epoll_ctl</span><span class=p>(</span><span class=n>epfd_</span><span class=p>,</span><span class=w> </span><span class=n>EPOLL_CTL_ADD</span><span class=p>,</span><span class=w> </span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>ev</span><span class=p>);</span>
</span><span id=__span-34-7><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-34-8><span class=w>    </span><span class=p>{</span>
</span><span id=__span-34-9><span class=w>        </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;添加文件描述符和事件失败&quot;</span><span class=p>;</span>
</span><span id=__span-34-10><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>ErrorNumber</span><span class=o>::</span><span class=n>Epoll_Ctl_Fail</span><span class=p>));</span>
</span><span id=__span-34-11><span class=w>    </span><span class=p>}</span>
</span><span id=__span-34-12>
</span><span id=__span-34-13><span class=w>    </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;添加文件描述符和事件成功&quot;</span><span class=p>;</span>
</span><span id=__span-34-14><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>接着，在<code>EpollServer</code>类提供一个将<code>Connection</code>类对象添加到<code>epoll</code>模型中的接口，但是参数是<code>Connection</code>类对象的指针，因为<code>EpollServer</code>类中管理的是<code>Connection</code>类对象的指针，如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-35-1><span class=c1>// 添加文件描述符和关心的事件</span>
</span><span id=__span-35-2><span class=kt>void</span><span class=w> </span><span class=nf>insertFdAndEvents</span><span class=p>(</span><span class=n>conn_t</span><span class=w> </span><span class=n>con</span><span class=p>)</span>
</span><span id=__span-35-3><span class=p>{</span>
</span><span id=__span-35-4><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connections_</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>con</span><span class=o>-&gt;</span><span class=n>getFd</span><span class=p>());</span>
</span><span id=__span-35-5><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>pos</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>connections_</span><span class=p>.</span><span class=n>end</span><span class=p>())</span>
</span><span id=__span-35-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-35-7><span class=w>        </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;插入失败，指定描述符已存在&quot;</span><span class=p>;</span>
</span><span id=__span-35-8><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>ErrorNumber</span><span class=o>::</span><span class=n>Epoll_Ctl_Fail</span><span class=p>));</span>
</span><span id=__span-35-9><span class=w>    </span><span class=p>}</span>
</span><span id=__span-35-10>
</span><span id=__span-35-11><span class=w>    </span><span class=c1>// 将指定的文件描述符和对应的连接对象建立映射关系</span>
</span><span id=__span-35-12><span class=w>    </span><span class=n>connections_</span><span class=p>.</span><span class=n>insert</span><span class=p>({</span><span class=n>con</span><span class=o>-&gt;</span><span class=n>getFd</span><span class=p>(),</span><span class=w> </span><span class=n>con</span><span class=p>});</span>
</span><span id=__span-35-13>
</span><span id=__span-35-14><span class=w>    </span><span class=c1>// 添加到Epoll模型中</span>
</span><span id=__span-35-15><span class=w>    </span><span class=n>ep_</span><span class=o>-&gt;</span><span class=n>epollCtl</span><span class=p>(</span><span class=n>con</span><span class=o>-&gt;</span><span class=n>getFd</span><span class=p>(),</span><span class=w> </span><span class=n>con</span><span class=o>-&gt;</span><span class=n>getEvents</span><span class=p>());</span>
</span><span id=__span-35-16><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>因为<code>EpollServer</code>类需要等待每一个文件描述符就绪，所以需要<code>Epoll</code>提供一个等待接口，如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-36-1><span class=c1>// 等待就绪事件</span>
</span><span id=__span-36-2><span class=kt>int</span><span class=w> </span><span class=nf>epollWait</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>epoll_event</span><span class=o>*</span><span class=w> </span><span class=n>ep_arr</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>maxSize</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>timeout</span><span class=p>)</span>
</span><span id=__span-36-3><span class=p>{</span>
</span><span id=__span-36-4><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>epoll_wait</span><span class=p>(</span><span class=n>epfd_</span><span class=p>,</span><span class=w> </span><span class=n>ep_arr</span><span class=p>,</span><span class=w> </span><span class=n>maxSize</span><span class=p>,</span><span class=w> </span><span class=n>timeout</span><span class=p>);</span>
</span><span id=__span-36-5>
</span><span id=__span-36-6><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>num</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-36-7><span class=w>    </span><span class=p>{</span>
</span><span id=__span-36-8><span class=w>        </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Epoll等待错误&quot;</span><span class=p>;</span>
</span><span id=__span-36-9><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>ErrorNumber</span><span class=o>::</span><span class=n>Epoll_Wait_Fail</span><span class=p>));</span>
</span><span id=__span-36-10><span class=w>    </span><span class=p>}</span>
</span><span id=__span-36-11>
</span><span id=__span-36-12><span class=w>    </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Epoll开始等待&quot;</span><span class=p>;</span>
</span><span id=__span-36-13>
</span><span id=__span-36-14><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>num</span><span class=p>;</span>
</span><span id=__span-36-15><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>接着，在<code>EpollServer</code>类中实现服务器启动的函数，对于<code>EpollServer</code>来说，其主要任务就是等待文件描述符就绪，为了后续方便添加新功能，可以考虑将等待行为抽取到一个函数<code>loopOnce</code>中，而启动服务器函数就是启动服务器并持续执行<code>loopOnce</code>函数。为了标识服务器已经启动，可以使用一个成员变量<code>isRunning_</code>，在构造函数中初始化为<code>false</code>，如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-37-1><span class=k>class</span><span class=w> </span><span class=nc>EpollServer</span>
</span><span id=__span-37-2><span class=p>{</span>
</span><span id=__span-37-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-37-4><span class=w>    </span><span class=n>EpollServer</span><span class=p>()</span>
</span><span id=__span-37-5><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-37-6><span class=w>        </span><span class=p>,</span><span class=n>isRunning_</span><span class=p>(</span><span class=nb>false</span><span class=p>)</span>
</span><span id=__span-37-7><span class=w>    </span><span class=p>{</span>
</span><span id=__span-37-8>
</span><span id=__span-37-9><span class=w>    </span><span class=p>}</span>
</span><span id=__span-37-10>
</span><span id=__span-37-11><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-37-12>
</span><span id=__span-37-13><span class=w>    </span><span class=c1>// 单次循环</span>
</span><span id=__span-37-14><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>loopOnce</span><span class=p>()</span>
</span><span id=__span-37-15><span class=w>    </span><span class=p>{</span>
</span><span id=__span-37-16>
</span><span id=__span-37-17><span class=w>    </span><span class=p>}</span>
</span><span id=__span-37-18>
</span><span id=__span-37-19><span class=w>    </span><span class=c1>// 启动服务器</span>
</span><span id=__span-37-20><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>startServer</span><span class=p>()</span>
</span><span id=__span-37-21><span class=w>    </span><span class=p>{</span>
</span><span id=__span-37-22><span class=w>        </span><span class=n>isRunning_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-37-23><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>isRunning_</span><span class=p>)</span>
</span><span id=__span-37-24><span class=w>        </span><span class=p>{</span>
</span><span id=__span-37-25><span class=w>            </span><span class=n>loopOnce</span><span class=p>();</span>
</span><span id=__span-37-26><span class=w>        </span><span class=p>}</span>
</span><span id=__span-37-27>
</span><span id=__span-37-28><span class=w>        </span><span class=n>isRunning_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-37-29><span class=w>    </span><span class=p>}</span>
</span><span id=__span-37-30>
</span><span id=__span-37-31><span class=w>    </span><span class=o>~</span><span class=n>EpollServer</span><span class=p>()</span>
</span><span id=__span-37-32><span class=w>    </span><span class=p>{}</span>
</span><span id=__span-37-33>
</span><span id=__span-37-34><span class=k>private</span><span class=o>:</span>
</span><span id=__span-37-35><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-37-36><span class=w>    </span><span class=kt>bool</span><span class=w> </span><span class=n>isRunning_</span><span class=p>;</span><span class=w> </span><span class=c1>// 服务器运行标识</span>
</span><span id=__span-37-37><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>同样，可以提供函数用于停止服务器：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-38-1><span class=c1>// 停止服务器</span>
</span><span id=__span-38-2><span class=kt>void</span><span class=w> </span><span class=nf>stopServer</span><span class=p>()</span>
</span><span id=__span-38-3><span class=p>{</span>
</span><span id=__span-38-4><span class=w>    </span><span class=n>isRunning_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-38-5><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>接着，实现单次循环函数<code>loopOnce</code>，该函数就是等待已经存在于<code>epoll</code>模型中的文件描述符，并对具体的就绪事件进行处理。参考思路：单次循环中需要调用<code>Epoll</code>类中的<code>epollWait</code>函数，该函数会返回已经就绪事件的个数和数组，遍历数组获取到每一个继续的文件描述符和对应的事件，如果返回的事件是错误事件，为了处理方便，将该返回事件修改为读写事件就绪<code>EPOLLIN | EPOLLOUT</code>，交给上层的读写函数处理，这一点具体作用在后面会提及，此处不过多解释。接着就是正常情况，即要么是读事件就绪，要么是写事件继续，要么就是二者依次就绪，所以需要两个判断分别处理，但是此处不能只通过判断返回的就绪事件类型是否是或者写就决定执行某一种分支，而是还要判断对应的文件描述符是否存在。在执行就绪事件对应的逻辑分支中，因为哈希表的<code>value</code>是<code>Connection</code>对象指针类型，只需要调用父类的方法即可，如果是监听套接字，那么就会执行创建连接，否则就是正常的读写。根据这个思路，需要额外实现一个函数判断当前文件描述符是否存在于哈希表中：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-39-1><span class=c1>// 判断文件描述符是否存在</span>
</span><span id=__span-39-2><span class=kt>bool</span><span class=w> </span><span class=nf>checkFdIsInConnections</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>fd</span><span class=p>)</span>
</span><span id=__span-39-3><span class=p>{</span>
</span><span id=__span-39-4><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>connections_</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>fd</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>connections_</span><span class=p>.</span><span class=n>end</span><span class=p>();</span>
</span><span id=__span-39-5><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>接着实现<code>loopOnce</code>函数：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-40-1><span class=c1>// 单次循环</span>
</span><span id=__span-40-2><span class=kt>void</span><span class=w> </span><span class=nf>loopOnce</span><span class=p>()</span>
</span><span id=__span-40-3><span class=p>{</span>
</span><span id=__span-40-4><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>timeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1000</span><span class=p>;</span>
</span><span id=__span-40-5><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ep_</span><span class=o>-&gt;</span><span class=n>epollWait</span><span class=p>(</span><span class=n>revents_arr_</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>(),</span><span class=w> </span><span class=n>g_default_array_num</span><span class=p>,</span><span class=w> </span><span class=n>timeout</span><span class=p>);</span>
</span><span id=__span-40-6><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>num</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-40-7><span class=w>    </span><span class=p>{</span>
</span><span id=__span-40-8><span class=w>        </span><span class=c1>// 获取当前文件描述符和就绪的事件</span>
</span><span id=__span-40-9><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>revents_arr_</span><span class=p>)[</span><span class=n>i</span><span class=p>].</span><span class=n>data</span><span class=p>.</span><span class=n>fd</span><span class=p>;</span>
</span><span id=__span-40-10><span class=w>        </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>revents</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>revents_arr_</span><span class=p>)[</span><span class=n>i</span><span class=p>].</span><span class=n>events</span><span class=p>;</span>
</span><span id=__span-40-11><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>revents</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>EPOLLERR</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>revents</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>EPOLLHUP</span><span class=p>))</span>
</span><span id=__span-40-12><span class=w>            </span><span class=n>revents</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>EPOLLIN</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>EPOLLOUT</span><span class=p>);</span>
</span><span id=__span-40-13><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>revents</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>EPOLLIN</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>checkFdIsInConnections</span><span class=p>(</span><span class=n>fd</span><span class=p>))</span>
</span><span id=__span-40-14><span class=w>        </span><span class=p>{</span>
</span><span id=__span-40-15><span class=w>            </span><span class=c1>// 执行读方法</span>
</span><span id=__span-40-16><span class=w>            </span><span class=n>connections_</span><span class=p>[</span><span class=n>fd</span><span class=p>]</span><span class=o>-&gt;</span><span class=n>recvData</span><span class=p>();</span>
</span><span id=__span-40-17><span class=w>        </span><span class=p>}</span>
</span><span id=__span-40-18><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>revents</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>EPOLLOUT</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>checkFdIsInConnections</span><span class=p>(</span><span class=n>fd</span><span class=p>))</span>
</span><span id=__span-40-19><span class=w>        </span><span class=p>{</span>
</span><span id=__span-40-20><span class=w>            </span><span class=c1>// 执行写方法</span>
</span><span id=__span-40-21><span class=w>            </span><span class=n>connections_</span><span class=p>[</span><span class=n>fd</span><span class=p>]</span><span class=o>-&gt;</span><span class=n>sendData</span><span class=p>();</span>
</span><span id=__span-40-22><span class=w>        </span><span class=p>}</span>
</span><span id=__span-40-23><span class=w>    </span><span class=p>}</span>
</span><span id=__span-40-24><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h3 id=listener>实现<code>Listener</code>类基本结构<a class=headerlink href=#listener title="Permanent link">&para;</a></h3> <p>因为下层是通过<code>Connection</code>类对象来管理每一个链接，所以<code>Listener</code>类只需要作为<code>Connection</code>类的子类：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-41-1><span class=k>class</span><span class=w> </span><span class=nc>Listener</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>Connection</span>
</span><span id=__span-41-2><span class=p>{</span>
</span><span id=__span-41-3><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>接着，因为<code>Listener</code>类用于处理客户端和服务器端的链接，所以考虑在<code>Listener</code>类中添加一个成员表示TCP套接字，在构造函数初始化列表中进行初始化，如下：</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>这里使用到了<a href=https://www.help-doc.top/Linux/26.%20%E5%BA%94%E7%94%A8%E5%B1%82%E5%8D%8F%E8%AE%AEHTTP/1.%20%E4%BB%8B%E7%BB%8DHTTP%E5%8D%8F%E8%AE%AE%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84%E4%B8%8E%E5%9F%BA%E6%9C%AC%E5%AE%9E%E7%8E%B0HTTPServer/1.%20%E4%BB%8B%E7%BB%8DHTTP%E5%8D%8F%E8%AE%AE%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84%E4%B8%8E%E5%9F%BA%E6%9C%AC%E5%AE%9E%E7%8E%B0HTTPServer.html#_6>前面在「介绍HTTP协议基本结构与基本实现HTTPServer」封装的<code>TcpSocket</code>类</a></p> </div> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-42-1><span class=k>class</span><span class=w> </span><span class=nc>Listener</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>Connection</span>
</span><span id=__span-42-2><span class=p>{</span>
</span><span id=__span-42-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-42-4><span class=w>    </span><span class=n>Listener</span><span class=p>(</span><span class=kt>uint16_t</span><span class=w> </span><span class=n>port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>default_port</span><span class=p>)</span>
</span><span id=__span-42-5><span class=w>        </span><span class=o>:</span><span class=n>bs_</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>TcpSocket</span><span class=o>&gt;</span><span class=p>(</span><span class=n>port</span><span class=p>))</span>
</span><span id=__span-42-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-42-7><span class=w>    </span><span class=p>}</span>
</span><span id=__span-42-8>
</span><span id=__span-42-9><span class=k>private</span><span class=o>:</span>
</span><span id=__span-42-10><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>BaseSocket</span><span class=o>&gt;</span><span class=w> </span><span class=n>bs_</span><span class=p>;</span>
</span><span id=__span-42-11><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>因为<code>Listener</code>类是<code>Connection</code>类的子类，所以需要重写父类的纯虚函数，但是目前不具体实现，如下：</p> <div class="tabbed-set tabbed-alternate" data-tabs=4:3><input checked=checked id=__tabbed_4_1 name=__tabbed_4 type=radio><input id=__tabbed_4_2 name=__tabbed_4 type=radio><input id=__tabbed_4_3 name=__tabbed_4 type=radio><div class=tabbed-labels><label for=__tabbed_4_1><code>recvData</code></label><label for=__tabbed_4_2><code>sendData</code></label><label for=__tabbed_4_3><code>handleException</code></label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-43-1><span class=c1>// 接收信息</span>
</span><span id=__span-43-2><span class=kt>void</span><span class=w> </span><span class=nf>recvData</span><span class=p>()</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-43-3><span class=p>{}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-44-1><span class=c1>// 发送信息</span>
</span><span id=__span-44-2><span class=kt>void</span><span class=w> </span><span class=nf>sendData</span><span class=p>()</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-44-3><span class=p>{}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-45-1><span class=c1>// 处理异常</span>
</span><span id=__span-45-2><span class=kt>void</span><span class=w> </span><span class=nf>handleException</span><span class=p>()</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-45-3><span class=p>{}</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>接着，在构造函数中进行初始化操作，包括创建套接字、绑定地址信息和设置监听操作。另外，因为每个<code>Connection</code>类对象都需要用到文件描述符，所以在构造函数中还需要将监听套接字设置到当前子类对象<code>Listener</code>中，便于使用<code>Connection</code>类对象可以获取到监听套接字，如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-46-1><span class=n>Listener</span><span class=p>(</span><span class=kt>uint16_t</span><span class=w> </span><span class=n>port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>default_port</span><span class=p>)</span>
</span><span id=__span-46-2><span class=w>    </span><span class=o>:</span><span class=n>bs_</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>TcpSocket</span><span class=o>&gt;</span><span class=p>(</span><span class=n>port</span><span class=p>))</span>
</span><span id=__span-46-3><span class=p>{</span>
</span><span id=__span-46-4><span class=w>    </span><span class=c1>// 初始化套接字</span>
</span><span id=__span-46-5><span class=w>    </span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>initSocket</span><span class=p>();</span>
</span><span id=__span-46-6><span class=w>    </span><span class=c1>// 调用父类函数设置监听套接字</span>
</span><span id=__span-46-7><span class=w>    </span><span class=n>setFd</span><span class=p>(</span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>getListenSocketFd</span><span class=p>());</span>
</span><span id=__span-46-8><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h3 id=listenerioservice>设计<code>Listener</code>类和<code>IOService</code>类<a class=headerlink href=#listenerioservice title="Permanent link">&para;</a></h3> <p>因为客户端和服务端建立连接本质就是服务端读取客户端的请求信息，所以<code>Listener</code>类只需要实现<code>recvData</code>函数即可，但是需要注意的是，本次实现的是边缘触发模式，虽然能确定<code>accept</code>函数一定不会阻塞，但是不能保证<code>accept</code>函数一定只读取一次，也就是说<strong>需要将<code>accept</code>函数当做<code>read</code>等读取接口看待</strong>，所以需要循环监听。另外，如果当做IO函数看待，那么必然会出现多读一次用于判断是否读取到结尾，但是这多读的一步会导致服务器阻塞，所以还需要将对应的监听套接字设置为非阻塞，所以首先需要将监听套接字设置为非阻塞</p> <p>基于上面的思路，首先提供一个函数用于将文件描述符设置为非阻塞，因为这个函数在后续正常读取信息时也会用到，所以考虑将该函数放在一个工具类中：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-47-1><span class=k>class</span><span class=w> </span><span class=nc>EpollServerUtils</span>
</span><span id=__span-47-2><span class=p>{</span>
</span><span id=__span-47-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-47-4><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=n>setNonBlock</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>fd</span><span class=p>)</span>
</span><span id=__span-47-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-47-6><span class=w>        </span><span class=c1>// 获取文件描述符已有的模式</span>
</span><span id=__span-47-7><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fcntl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>F_GETFL</span><span class=p>);</span>
</span><span id=__span-47-8><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mode</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-47-9><span class=w>        </span><span class=p>{</span>
</span><span id=__span-47-10><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;获取文件描述符已有模式失败&quot;</span><span class=p>;</span>
</span><span id=__span-47-11><span class=w>            </span><span class=n>exit</span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>ErrorNumber</span><span class=o>::</span><span class=n>Fcntl_Fail</span><span class=p>));</span>
</span><span id=__span-47-12><span class=w>        </span><span class=p>}</span>
</span><span id=__span-47-13>
</span><span id=__span-47-14><span class=w>        </span><span class=c1>// 设置非阻塞</span>
</span><span id=__span-47-15><span class=w>        </span><span class=n>fcntl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>F_SETFL</span><span class=p>,</span><span class=w> </span><span class=n>mode</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>O_NONBLOCK</span><span class=p>);</span>
</span><span id=__span-47-16><span class=w>    </span><span class=p>}</span>
</span><span id=__span-47-17><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>接着，在获取到<code>listen_socketfd</code>之后将其设置为非阻塞，在<code>BaseSocket</code>类中的<code>initSocket</code>函数中添加如下代码：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-48-1><span class=k>class</span><span class=w> </span><span class=nc>BaseSocket</span>
</span><span id=__span-48-2><span class=p>{</span>
</span><span id=__span-48-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-48-4><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-48-5><span class=w>    </span><span class=c1>// 获取监听套接字</span>
</span><span id=__span-48-6><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>getListenSocketFd</span><span class=p>()</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-48-7>
</span><span id=__span-48-8><span class=w>    </span><span class=c1>// 具体实现方法</span>
</span><span id=__span-48-9><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>initSocket</span><span class=p>()</span>
</span><span id=__span-48-10><span class=w>    </span><span class=p>{</span>
</span><span id=__span-48-11><span class=w>        </span><span class=c1>// 创建套接字</span>
</span><span id=__span-48-12><span class=w>        </span><span class=n>createSocket</span><span class=p>();</span>
</span><span id=__span-48-13><span class=w>        </span><span class=c1>// 设置非阻塞</span>
</span><span id=__span-48-14><span class=w>        </span><span class=n>EpollServerUtils</span><span class=o>::</span><span class=n>setNonBlock</span><span class=p>(</span><span class=n>getListenSocketFd</span><span class=p>());</span>
</span><span id=__span-48-15><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-48-16><span class=w>    </span><span class=p>}</span>
</span><span id=__span-48-17><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>接着，为了拿到<code>accept</code>函数的错误码，可以考虑在<code>toAccept</code>函数的参数部分添加一个输出型参数<code>out_errno</code>：</p> <div class="tabbed-set tabbed-alternate" data-tabs=5:2><input checked=checked id=__tabbed_5_1 name=__tabbed_5 type=radio><input id=__tabbed_5_2 name=__tabbed_5 type=radio><div class=tabbed-labels><label for=__tabbed_5_1>父类<code>BaseSocket</code></label><label for=__tabbed_5_2>子类<code>TcpSocket</code></label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-49-1><span class=k>class</span><span class=w> </span><span class=nc>BaseSocket</span>
</span><span id=__span-49-2><span class=p>{</span>
</span><span id=__span-49-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-49-4><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-49-5><span class=w>    </span><span class=c1>// 接收</span>
</span><span id=__span-49-6><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>toAccept</span><span class=p>(</span><span class=n>SockAddrIn</span><span class=w> </span><span class=o>*</span><span class=n>client</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=o>*</span><span class=n>out_errno</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-49-7><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-49-8><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-50-1><span class=k>class</span><span class=w> </span><span class=nc>TcpSocket</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>BaseSocket</span>
</span><span id=__span-50-2><span class=p>{</span>
</span><span id=__span-50-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-50-4><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-50-5>
</span><span id=__span-50-6><span class=w>    </span><span class=c1>// 实现接收</span>
</span><span id=__span-50-7><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>toAccept</span><span class=p>(</span><span class=n>SockAddrIn</span><span class=w> </span><span class=o>*</span><span class=n>client</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=o>*</span><span class=n>out_errno</span><span class=p>)</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-50-8><span class=w>    </span><span class=p>{</span>
</span><span id=__span-50-9><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-50-10><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>ac_socketfd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>accept</span><span class=p>(</span><span class=n>_listen_socketfd</span><span class=p>,</span><span class=w> </span><span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=k>struct</span><span class=w> </span><span class=nc>sockaddr</span><span class=w> </span><span class=o>*&gt;</span><span class=p>(</span><span class=o>&amp;</span><span class=n>peer</span><span class=p>),</span><span class=w> </span><span class=o>&amp;</span><span class=n>length</span><span class=p>);</span>
</span><span id=__span-50-11><span class=w>        </span><span class=c1>// 获取accept的错误码</span>
</span><span id=__span-50-12><span class=w>        </span><span class=o>*</span><span class=n>out_errno</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>errno</span><span class=p>;</span>
</span><span id=__span-50-13><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-50-14><span class=w>    </span><span class=p>}</span>
</span><span id=__span-50-15><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-50-16><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>基于上面的思路，实现<code>recvData</code>函数基本结构：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-51-1><span class=c1>// 接收信息</span>
</span><span id=__span-51-2><span class=kt>void</span><span class=w> </span><span class=nf>recvData</span><span class=p>()</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-51-3><span class=p>{</span>
</span><span id=__span-51-4><span class=w>    </span><span class=c1>// 循环接收</span>
</span><span id=__span-51-5><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-51-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-51-7><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>rerrno</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-51-8><span class=w>        </span><span class=n>SockAddrIn</span><span class=w> </span><span class=n>client</span><span class=p>;</span>
</span><span id=__span-51-9><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>ac_socketfd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>toAccept</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>addressof</span><span class=p>(</span><span class=n>client</span><span class=p>),</span><span class=w> </span><span class=o>&amp;</span><span class=n>rerrno</span><span class=p>);</span>
</span><span id=__span-51-10><span class=w>        </span><span class=c1>// 当做IO行为处理</span>
</span><span id=__span-51-11><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>ac_socketfd</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-51-12><span class=w>        </span><span class=p>{</span>
</span><span id=__span-51-13><span class=w>            </span><span class=c1>// 正常情况，建立链接</span>
</span><span id=__span-51-14><span class=w>        </span><span class=p>}</span>
</span><span id=__span-51-15><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=p>(</span><span class=n>ac_socketfd</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-51-16><span class=w>        </span><span class=p>{</span>
</span><span id=__span-51-17><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>rerrno</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>EAGAIN</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>rerrno</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>EWOULDBLOCK</span><span class=p>)</span>
</span><span id=__span-51-18><span class=w>            </span><span class=p>{</span>
</span><span id=__span-51-19><span class=w>                </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;accept接收结束&quot;</span><span class=p>;</span>
</span><span id=__span-51-20><span class=w>                </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-51-21><span class=w>            </span><span class=p>}</span>
</span><span id=__span-51-22><span class=w>            </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=p>(</span><span class=n>rerrno</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>EINTR</span><span class=p>)</span>
</span><span id=__span-51-23><span class=w>            </span><span class=p>{</span>
</span><span id=__span-51-24><span class=w>                </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;accept被信号中断，重新接收&quot;</span><span class=p>;</span>
</span><span id=__span-51-25><span class=w>                </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-51-26><span class=w>            </span><span class=p>}</span>
</span><span id=__span-51-27><span class=w>            </span><span class=k>else</span>
</span><span id=__span-51-28><span class=w>            </span><span class=p>{</span>
</span><span id=__span-51-29><span class=w>                </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>ERROR</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;accept错误&quot;</span><span class=p>;</span>
</span><span id=__span-51-30><span class=w>                </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-51-31><span class=w>            </span><span class=p>}</span>
</span><span id=__span-51-32><span class=w>        </span><span class=p>}</span>
</span><span id=__span-51-33><span class=w>    </span><span class=p>}</span>
</span><span id=__span-51-34><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>接着思考<code>recvData</code>函数的正常情况如何处理，在前面都是直接将指定的文件描述符添加到<code>epoll</code>模型中，但是在本次实现中，当前<code>Listener</code>类和<code>EpollServer</code>类之间存在一个<code>Connection</code>类，而<code>EpollServer</code>类只能看到<code>Connection</code>类对象，所以需要考虑将获取到的<code>ac_socketfd</code>封装为<code>Connection</code>类对象，再将该对象添加到<code>EpollServer</code>类中。但是，此处遇到两个问题：</p> <ol> <li>如何将获取到的<code>ac_socketfd</code>封装为<code>Connection</code>类对象</li> <li>如何将该对象添加到<code>EpollServer</code>类中</li> </ol> <p>对于第一个问题，既然已经有了关于监听套接字的子类，那么自然还需要一个处理普通文件描述符的子类：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-52-1><span class=k>class</span><span class=w> </span><span class=nc>IOService</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>Connection</span>
</span><span id=__span-52-2><span class=p>{</span>
</span><span id=__span-52-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-52-4><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>recvData</span><span class=p>()</span>
</span><span id=__span-52-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-52-6><span class=w>    </span><span class=p>}</span>
</span><span id=__span-52-7>
</span><span id=__span-52-8><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>sendData</span><span class=p>()</span>
</span><span id=__span-52-9><span class=w>    </span><span class=p>{</span>
</span><span id=__span-52-10><span class=w>    </span><span class=p>}</span>
</span><span id=__span-52-11>
</span><span id=__span-52-12><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>handleException</span><span class=p>()</span>
</span><span id=__span-52-13><span class=w>    </span><span class=p>{</span>
</span><span id=__span-52-14><span class=w>    </span><span class=p>}</span>
</span><span id=__span-52-15><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>对于第二个问题，这里需要在<code>Connection</code>类中添加一个成员变量指针，用于表示<code>EpollServer</code>类对象，这样在<code>Connection</code>类中就可以调用封装后的接口。这里就需要考虑如何在<code>Connection</code>类中访问到<code>EpollServer</code>类，又如何在<code>Connection</code>类中拿到<code>EpollServer</code>类对象</p> <p>对于第一个问题，最直接的做法就是在<code>Connection</code>类所在文件中包含<code>EpollServer</code>类所在的文件，如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-53-1><span class=c1>// Connection类所在文件</span>
</span><span id=__span-53-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;EpollServer.h&quot;</span>
</span></code></pre></div></td></tr></table></div> <p>但是这种做法有一个弊端，就是如果在<code>EpollServer</code>类所在的文件中包含了<code>Connection</code>类所在的文件，就会出现<strong>头文件循环包含问题</strong>，所以这种做法是不可取的。所以需要考虑使用前置声明的方式，如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-54-1><span class=c1>// Connection类所在文件</span>
</span><span id=__span-54-2><span class=k>class</span><span class=w> </span><span class=nc>EpollServer</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> <details class=note> <summary>头文件循环包含问题</summary> <p>在<code>Connection</code>类所在的文件中需要用到<code>EpollServer</code>类，所以需要在<code>Connection</code>类所在的文件中添加<code>EpollServer</code>类的前置声明，但是注意，如果在<code>EpollServer</code>类所在文件中包含了<code>Connection</code>类所在文件，就<strong>不要在<code>Connection</code>类所在的文件中再添加包含<code>EpollServer</code>类所在的文件</strong>，防止出现头文件循环包含问题</p> </details> <p>但是，使用前置声明还会遇到一个问题：如果将前置声明放在<code>Connection</code>类所在的命名空间<code>connectionModule</code>中，会出现如下错误：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-55-1><span class=c1>// Connection类所在文件</span>
</span><span id=__span-55-2><span class=k>class</span><span class=w> </span><span class=nc>EpollServer</span><span class=p>;</span>
</span><span id=__span-55-3>
</span><span id=__span-55-4><span class=k>namespace</span><span class=w> </span><span class=nn>connectionModule</span>
</span><span id=__span-55-5><span class=p>{</span>
</span><span id=__span-55-6><span class=w>    </span><span class=k>class</span><span class=w> </span><span class=nc>Connection</span>
</span><span id=__span-55-7><span class=w>    </span><span class=p>{</span>
</span><span id=__span-55-8><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-55-9><span class=w>    </span><span class=k>protected</span><span class=o>:</span>
</span><span id=__span-55-10><span class=w>        </span><span class=c1>// 指向EpollServer指针</span>
</span><span id=__span-55-11><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>weak_ptr</span><span class=o>&lt;</span><span class=n>EpollServer</span><span class=o>&gt;</span><span class=w> </span><span class=n>ep_svr_</span><span class=p>;</span>
</span><span id=__span-55-12><span class=w>        </span><span class=c1>// 报错：&quot;connectionModule::EpollServer&quot; is ambiguous</span>
</span><span id=__span-55-13><span class=w>    </span><span class=p>};</span>
</span><span id=__span-55-14><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>对于这种情况能想到的直接方案就是将前置声明放在命名空间<code>connectionModule</code>中，但是这样还会出现第二个问题：当前<code>EpollServer</code>的声明是在<code>Connection</code>类所在的命名空间<code>connectionModule</code>，而实际上<code>EpollServer</code>类的声明是在命名空间<code>epollServerModule</code>中，如果直接使用上面的方式：<code>std::weak_ptr&lt;EpollServer&gt; ep_svr_</code>，一旦在<code>Listener</code>中将该指针转换为<code>shared_ptr</code>类型，就会发现指针类型是<code>std::shared_ptr&lt;connectionModule::EpollServer&gt;</code>，而不是<code>std::shared_ptr&lt;epollServerModule::EpollServer&gt;</code>，而作为前置声明的<code>connectionModule::EpollServer</code>并没有完整的实现，这就导致访问不到<code>epollServerModule::EpollServer</code>中的成员。所以正确的做法是，将<code>EpollServer</code>类的前置声明放在<code>EpollServer</code>类所在的命名空间中，再将该前置声明整体放在<code>Connection</code>类所在文件的全局，并在使用到<code>EpollServer</code>的地方使用指定命名空间的方式使用<code>EpollServer</code>。为了防止出现<a href=javascript:; class=custom-tooltip data-title=见下面的note描述>循环引用问题</a>，需要使用<code>weak_ptr</code>而不再是<code>shared_ptr</code>，如下：</p> <div class="admonition note"> <p class=admonition-title>上面提到的循环引用问题</p> <p><code>EpollServer</code>中管理了多个<code>Connection</code>对象指针，该指针是<code>shared_ptr</code>类型，如果再在<code>Connection</code>中使用<code>shared_ptr</code>就会出现<code>Connection</code>对象与<code>EpollServer</code>互指，一旦<code>Connection</code>类对象需要析构，就需要<code>EpollServer</code>先析构，而<code>EpollServer</code>要析构就需要<code>Connection</code>类对象析构导致循环引用问题</p> </div> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-56-1><span class=c1>// 前置声明</span>
</span><span id=__span-56-2><span class=k>namespace</span><span class=w> </span><span class=nn>epollServerModule</span>
</span><span id=__span-56-3><span class=p>{</span>
</span><span id=__span-56-4><span class=w>    </span><span class=k>class</span><span class=w> </span><span class=nc>EpollServer</span><span class=p>;</span>
</span><span id=__span-56-5><span class=p>}</span>
</span><span id=__span-56-6>
</span><span id=__span-56-7><span class=k>namespace</span><span class=w> </span><span class=nn>connectionModule</span>
</span><span id=__span-56-8><span class=p>{</span>
</span><span id=__span-56-9><span class=w>    </span><span class=k>class</span><span class=w> </span><span class=nc>Connection</span>
</span><span id=__span-56-10><span class=w>    </span><span class=p>{</span>
</span><span id=__span-56-11>
</span><span id=__span-56-12><span class=w>    </span><span class=k>protected</span><span class=o>:</span>
</span><span id=__span-56-13><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-56-14><span class=w>        </span><span class=c1>// 指向EpollServer指针</span>
</span><span id=__span-56-15><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>weak_ptr</span><span class=o>&lt;</span><span class=n>epollServerModule</span><span class=o>::</span><span class=n>EpollServer</span><span class=o>&gt;</span><span class=w> </span><span class=n>ep_svr_</span><span class=p>;</span>
</span><span id=__span-56-16><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-56-17><span class=w>    </span><span class=p>};</span>
</span><span id=__span-56-18><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>但是，有这个指针还不够，还需要对这个指针进行初始化，为了防止忘记初始化该指针导致的空指针错误，考虑在构造函数中添加参数用于初始化该指针，如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-57-1><span class=n>Connection</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>epollServerModule</span><span class=o>::</span><span class=n>EpollServer</span><span class=o>&gt;</span><span class=w> </span><span class=n>ep</span><span class=p>)</span>
</span><span id=__span-57-2><span class=w>    </span><span class=o>:</span><span class=w> </span><span class=n>fd_</span><span class=p>(</span><span class=mi>-1</span><span class=p>),</span><span class=w> </span><span class=n>events_</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span><span class=w> </span><span class=n>revents_</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span><span class=w> </span><span class=n>ep_svr_</span><span class=p>(</span><span class=n>ep</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-57-3><span class=p>{</span>
</span><span id=__span-57-4><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>但是，<code>Connection</code>是<code>Listener</code>类的父类，所以在<code>Listener</code>类中的成员初始化之前需要先调用父类的构造函数初始化父类成员（除非父类构造函数是全缺省或者无参），所以需要在<code>Listener</code>类的构造函数的初始化列表同样添加该参数，如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-58-1><span class=n>Listener</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>epollServerModule</span><span class=o>::</span><span class=n>EpollServer</span><span class=o>&gt;</span><span class=w> </span><span class=n>ep</span><span class=p>,</span><span class=w>  </span><span class=kt>uint16_t</span><span class=w> </span><span class=n>port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>default_port</span><span class=p>)</span>
</span><span id=__span-58-2><span class=w>    </span><span class=o>:</span><span class=w> </span><span class=n>Connection</span><span class=p>(</span><span class=n>ep</span><span class=p>),</span><span class=w> </span><span class=n>bs_</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>TcpSocket</span><span class=o>&gt;</span><span class=p>(</span><span class=n>port</span><span class=p>))</span>
</span><span id=__span-58-3><span class=p>{</span>
</span><span id=__span-58-4><span class=w>    </span><span class=c1>// 初始化套接字</span>
</span><span id=__span-58-5><span class=w>    </span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>initSocket</span><span class=p>();</span>
</span><span id=__span-58-6><span class=w>    </span><span class=c1>// 调用父类函数设置监听套接字</span>
</span><span id=__span-58-7><span class=w>    </span><span class=n>setFd</span><span class=p>(</span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>getListenSocketFd</span><span class=p>());</span>
</span><span id=__span-58-8><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>最后，不要遗忘还有一个子类<code>IOService</code>，同样，在其构造函数的初始化列表中同样添加该参数，如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-59-1><span class=n>IOService</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>epollServerModule</span><span class=o>::</span><span class=n>EpollServer</span><span class=o>&gt;</span><span class=w> </span><span class=n>ep</span><span class=p>)</span>
</span><span id=__span-59-2><span class=w>    </span><span class=o>:</span><span class=w> </span><span class=n>Connection</span><span class=p>(</span><span class=n>ep</span><span class=p>)</span>
</span><span id=__span-59-3><span class=p>{}</span>
</span></code></pre></div></td></tr></table></div> <p>接着，在<code>Connection</code>类中添加一个函数用于获取<code>EpollServer</code>类对象，如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-60-1><span class=c1>// 获取EpollServer指针</span>
</span><span id=__span-60-2><span class=n>std</span><span class=o>::</span><span class=n>weak_ptr</span><span class=o>&lt;</span><span class=n>epollServerModule</span><span class=o>::</span><span class=n>EpollServer</span><span class=o>&gt;</span><span class=w> </span><span class=n>getEpollServer</span><span class=p>()</span>
</span><span id=__span-60-3><span class=p>{</span>
</span><span id=__span-60-4><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>ep_svr_</span><span class=p>;</span>
</span><span id=__span-60-5><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>解决了上面的两个问题后，回到<code>Listener</code>类中的<code>recvData</code>函数编写剩下的逻辑。注意，要实现边缘触发模式一定要使用<code>EPOLLET</code>并且将对应的文件描述符设置为非阻塞：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-61-1><span class=c1>// 接收信息</span>
</span><span id=__span-61-2><span class=kt>void</span><span class=w> </span><span class=nf>recvData</span><span class=p>()</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-61-3><span class=p>{</span>
</span><span id=__span-61-4><span class=w>    </span><span class=c1>// 循环接收</span>
</span><span id=__span-61-5><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-61-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-61-7><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>rerrno</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-61-8><span class=w>        </span><span class=n>SockAddrIn</span><span class=w> </span><span class=n>client</span><span class=p>;</span>
</span><span id=__span-61-9><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>ac_socketfd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bs_</span><span class=o>-&gt;</span><span class=n>toAccept</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>addressof</span><span class=p>(</span><span class=n>client</span><span class=p>),</span><span class=w> </span><span class=o>&amp;</span><span class=n>rerrno</span><span class=p>);</span>
</span><span id=__span-61-10><span class=w>        </span><span class=c1>// 当做IO行为处理</span>
</span><span id=__span-61-11><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ac_socketfd</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-61-12><span class=w>        </span><span class=p>{</span>
</span><span id=__span-61-13><span class=w>            </span><span class=c1>// 获取EpollServer类对象</span>
</span><span id=__span-61-14><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>epollServerModule</span><span class=o>::</span><span class=n>EpollServer</span><span class=o>&gt;</span><span class=w> </span><span class=n>ep</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getEpollServer</span><span class=p>().</span><span class=n>lock</span><span class=p>();</span>
</span><span id=__span-61-15><span class=w>            </span><span class=c1>// 正常情况，建立链接</span>
</span><span id=__span-61-16><span class=w>            </span><span class=c1>// 1. 创建连接对象</span>
</span><span id=__span-61-17><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>Connection</span><span class=o>&gt;</span><span class=w> </span><span class=n>ac_con</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>IOService</span><span class=o>&gt;</span><span class=p>(</span><span class=n>ep</span><span class=p>);</span>
</span><span id=__span-61-18><span class=w>            </span><span class=c1>// 2. 设置非阻塞</span>
</span><span id=__span-61-19><span class=w>            </span><span class=n>EpollServerUtils</span><span class=o>::</span><span class=n>setNonBlock</span><span class=p>(</span><span class=n>ac_socketfd</span><span class=p>);</span>
</span><span id=__span-61-20><span class=w>            </span><span class=n>ac_con</span><span class=o>-&gt;</span><span class=n>setFd</span><span class=p>(</span><span class=n>ac_socketfd</span><span class=p>);</span>
</span><span id=__span-61-21><span class=w>            </span><span class=n>ac_con</span><span class=o>-&gt;</span><span class=n>setEvent</span><span class=p>(</span><span class=n>EPOLLIN</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>EPOLLET</span><span class=p>);</span>
</span><span id=__span-61-22><span class=w>            </span><span class=n>ac_con</span><span class=o>-&gt;</span><span class=n>setClient</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>client</span><span class=p>));</span>
</span><span id=__span-61-23><span class=w>            </span><span class=c1>// 3. 通过Connection将链接指针插入到Epoll模型中</span>
</span><span id=__span-61-24><span class=w>            </span><span class=n>ep</span><span class=o>-&gt;</span><span class=n>insertFdAndEvents</span><span class=p>(</span><span class=n>ac_con</span><span class=p>);</span>
</span><span id=__span-61-25><span class=w>        </span><span class=p>}</span>
</span><span id=__span-61-26><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-61-27><span class=w>    </span><span class=p>}</span>
</span><span id=__span-61-28><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>在上面的代码中，因为<code>getEpollServer</code>函数返回的是<code>weak_ptr</code>类型，所以需要调用<code>lock</code>函数将其转换为<code>shared_ptr</code>类型再使用。这里是临时提升为<code>shared_ptr</code>类型，所以使用完之后会自动释放，主要原因如下：<code>getEpollServer</code>持有的指针是对<code>EpollServer</code>类对象的弱引用，一旦<code>ep</code>变量离开作用域，哪怕<code>ep</code>变量是<code>shared_ptr</code>类型对<code>EpollServer</code>类对象的强引用，其引用计数器也不会等到<code>EpollServer</code>销毁再减1</p> <p>最后，需要修改前面<code>TcpSocket</code>类中的<code>toAccept</code>函数，该函数中存在对<code>ac_socketfd &lt; 0</code>的判断逻辑，但是这个逻辑已经在<code>loopOnce</code>函数处理了，所以需要删除<code>toAccept</code>函数中关于这部分的逻辑：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-62-1><span class=c1>// 实现接收</span>
</span><span id=__span-62-2><span class=kt>int</span><span class=w> </span><span class=nf>toAccept</span><span class=p>(</span><span class=n>SockAddrIn</span><span class=w> </span><span class=o>*</span><span class=n>client</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=o>*</span><span class=n>out_errno</span><span class=p>)</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-62-3><span class=p>{</span>
</span><span id=__span-62-4><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-62-5><span class=w>    </span><span class=c1>// 获取accept的错误码</span>
</span><span id=__span-62-6><span class=w>    </span><span class=o>*</span><span class=n>out_errno</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>errno</span><span class=p>;</span>
</span><span id=__span-62-7>
</span><span id=__span-62-8><span class=w>    </span><span class=c1>// 删除下面的逻辑——起始</span>
</span><span id=__span-62-9><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ac_socketfd</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-62-10><span class=w>    </span><span class=p>{</span>
</span><span id=__span-62-11><span class=w>        </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>ERROR</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;接收失败：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>);</span>
</span><span id=__span-62-12><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>ErrorNumber</span><span class=o>::</span><span class=n>AcceptFail</span><span class=p>));</span>
</span><span id=__span-62-13><span class=w>    </span><span class=p>}</span>
</span><span id=__span-62-14><span class=w>    </span><span class=c1>// 结束</span>
</span><span id=__span-62-15>
</span><span id=__span-62-16><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-62-17><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h3 id=_4>第一阶段测试<a class=headerlink href=#_4 title="Permanent link">&para;</a></h3> <p>首先，在<code>IOService</code>类中的<code>recvData</code>函数中添加一条日志：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-63-1><span class=kt>void</span><span class=w> </span><span class=nf>recvData</span><span class=p>()</span>
</span><span id=__span-63-2><span class=p>{</span>
</span><span id=__span-63-3><span class=w>    </span><span class=n>LOG</span><span class=p>(</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>DEBUG</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;进入IOService读模块&quot;</span><span class=p>;</span>
</span><span id=__span-63-4><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>接着，创建一个主函数：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-64-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;Listener.hpp&quot;</span>
</span><span id=__span-64-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;EpollServer.hpp&quot;</span>
</span><span id=__span-64-3>
</span><span id=__span-64-4><span class=k>using</span><span class=w> </span><span class=k>namespace</span><span class=w> </span><span class=nn>listenerModule</span><span class=p>;</span>
</span><span id=__span-64-5><span class=k>using</span><span class=w> </span><span class=k>namespace</span><span class=w> </span><span class=nn>epollServerModule</span><span class=p>;</span>
</span><span id=__span-64-6>
</span><span id=__span-64-7><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-64-8><span class=p>{</span>
</span><span id=__span-64-9><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>epollServerModule</span><span class=o>::</span><span class=n>EpollServer</span><span class=o>&gt;</span><span class=w> </span><span class=n>e_svr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>epollServerModule</span><span class=o>::</span><span class=n>EpollServer</span><span class=o>&gt;</span><span class=p>();</span>
</span><span id=__span-64-10><span class=w>    </span><span class=c1>// 创建Listener代表启动服务器</span>
</span><span id=__span-64-11><span class=w>    </span><span class=c1>// 将Listener套接字构建为Connection对象</span>
</span><span id=__span-64-12><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>Connection</span><span class=o>&gt;</span><span class=w> </span><span class=n>con</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>Listener</span><span class=o>&gt;</span><span class=p>(</span><span class=n>e_svr</span><span class=p>);</span>
</span><span id=__span-64-13><span class=w>    </span><span class=n>con</span><span class=o>-&gt;</span><span class=n>setFd</span><span class=p>(</span><span class=n>con</span><span class=o>-&gt;</span><span class=n>getFd</span><span class=p>());</span>
</span><span id=__span-64-14><span class=w>    </span><span class=c1>// 使用EPOLLET开启边缘触发模式</span>
</span><span id=__span-64-15><span class=w>    </span><span class=n>con</span><span class=o>-&gt;</span><span class=n>setEvent</span><span class=p>(</span><span class=n>EPOLLIN</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>EPOLLET</span><span class=p>);</span>
</span><span id=__span-64-16><span class=w>    </span><span class=c1>// 将Connection对象插入到Epoll模型中</span>
</span><span id=__span-64-17><span class=w>    </span><span class=n>e_svr</span><span class=o>-&gt;</span><span class=n>insertFdAndEvents</span><span class=p>(</span><span class=n>con</span><span class=p>);</span>
</span><span id=__span-64-18><span class=w>    </span><span class=c1>// 启动服务器</span>
</span><span id=__span-64-19><span class=w>    </span><span class=n>e_svr</span><span class=o>-&gt;</span><span class=n>startServer</span><span class=p>();</span>
</span><span id=__span-64-20>
</span><span id=__span-64-21><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-64-22><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>编译运行上面的代码使用一个客户端连接就可以发现一个进程就可以处理多个连接，并且只要客户端向服务端发送内容就会打印类似下面的内容：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-65-1>[2025-04-11 17-07-16] [DEBUG] [31041] [IOService.hpp] [20] - 进入IOService读模块
</span></code></pre></div></td></tr></table></div> <p>当前阶段已经完成了任务派发，但是还没有进行IO处理，下一节将继续完成IO处理</p> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title=最后更新> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2025年6月8日</span> </span> <span class=md-source-file__fact> <span class=md-icon title=创建日期> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2025年4月8日</span> </span> </aside> <form class=md-feedback name=feedback hidden> <fieldset> <legend class=md-feedback__title> 页面有帮助吗？ </legend> <div class=md-feedback__inner> <div class=md-feedback__list> <button class="md-feedback__icon md-icon" type=submit title=页面对我有帮助 data-md-value=1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 9v12H1V9zm4 12a2 2 0 0 1-2-2V9c0-.55.22-1.05.59-1.41L14.17 1l1.06 1.06c.27.27.44.64.44 1.05l-.03.32L14.69 8H21a2 2 0 0 1 2 2v2c0 .26-.05.5-.14.73l-3.02 7.05C19.54 20.5 18.83 21 18 21zm0-2h9.03L21 12v-2h-8.79l1.13-5.32L9 9.03z"/></svg> </button> <button class="md-feedback__icon md-icon" type=submit title=页面没有帮助到我 data-md-value=0> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 15V3h4v12zM15 3a2 2 0 0 1 2 2v10c0 .55-.22 1.05-.59 1.41L9.83 23l-1.06-1.06c-.27-.27-.44-.64-.44-1.06l.03-.31.95-4.57H3a2 2 0 0 1-2-2v-2c0-.26.05-.5.14-.73l3.02-7.05C4.46 3.5 5.17 3 6 3zm0 2H5.97L3 12v2h8.78l-1.13 5.32L15 14.97z"/></svg> </button> </div> <div class=md-feedback__note> <div data-md-value=1 hidden> 谢谢你的反馈！ </div> <div data-md-value=0 hidden> 谢谢你的反馈！联系<a href=https://www.help-doc.top/%E4%BD%9C%E8%80%85/%E4%BD%9C%E8%80%85.html>作者</a>提供更详细的信息 </div> </div> </div> </fieldset> </form> <!-- 阅读进度条 - 直接在HTML中定义 --> <div class=reading-progress></div> <!-- 滚动指示器 - 直接在HTML中定义 --> <div class=scroll-indicator></div> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <!--
  Copyright (c) 2016-2024 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!-- Footer --> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2024-2025 柯懒不是柯南 </div> </div> <!-- "一闪一闪亮晶晶"元素 - 插入在copyright和social之间 --> <div class="md-footer-love md-typeset"> 一闪一闪亮晶晶，不及<span class=love-highlight>小亮</span><span class=love-heart>♥</span>照我心。To Li Liang </div> <div class=md-social> <a href=https://github.com/H0308 target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://www.help-doc.top/%E4%BD%9C%E8%80%85/%E4%BD%9C%E8%80%85.html target=_blank rel=noopener title=www.help-doc.top class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M433.754 420.445c-11.526 1.393-44.86-52.741-44.86-52.741 0 31.345-16.136 72.247-51.051 101.786 16.842 5.192 54.843 19.167 45.803 34.421-7.316 12.343-125.51 7.881-159.632 4.037-34.122 3.844-152.316 8.306-159.632-4.037-9.045-15.25 28.918-29.214 45.783-34.415-34.92-29.539-51.059-70.445-51.059-101.792 0 0-33.334 54.134-44.859 52.741-5.37-.65-12.424-29.644 9.347-99.704 10.261-33.024 21.995-60.478 40.144-105.779C60.683 98.063 108.982.006 224 0c113.737.006 163.156 96.133 160.264 214.963 18.118 45.223 29.912 72.85 40.144 105.778 21.768 70.06 14.716 99.053 9.346 99.704"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.indexes", "navigation.prune", "navigation.tabs", "search.highlight", "content.code.copy"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script> <script src=../../assets/javascripts/bundle.c8b220af.min.js></script> <script src=../../javascripts/katex.min.js></script> <script src=../../javascripts/other.min.js></script> <script src=../../javascripts/copyright.min.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/contrib/auto-render.min.js></script> <script src=../../assets/javascripts/toggle-sidebar.js async></script> <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body> </html>