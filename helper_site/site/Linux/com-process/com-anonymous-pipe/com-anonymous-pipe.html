<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://www.help-doc.top/Linux/com-process/com-anonymous-pipe/com-anonymous-pipe.html><link rel=prev href=../../soft-hard-link/soft-hard-link.html><link rel=next href=../com-named-pipe-shm/com-named-pipe-shm.html><link rel=icon href=../../../images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.12"><title>进程间通信介绍与匿名管道 - 柯懒的知识库</title><link rel=stylesheet href=../../../assets/stylesheets/main.2afb09e1.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.06af60db.min.css><link rel=stylesheet href=../../../css/timeline.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-9XWRGNRRSY"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-9XWRGNRRSY",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-9XWRGNRRSY",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script><link rel=stylesheet href=../../../stylesheets/colors.min.css><link rel=stylesheet href=../../../stylesheets/theme2.min.css media="screen and (max-width: 1199px)"><link rel=stylesheet href=../../../stylesheets/theme2.min.css media="screen and (min-width: 1200px)" id=theme2-desktop><link rel=stylesheet href=../../../stylesheets/theme1.min.css media="screen and (min-width: 1200px)" id=theme1-desktop><link rel=stylesheet href=../../../stylesheets/print.min.css><link rel=stylesheet href=../../../stylesheets/font-dongguanti.min.css id=font-dongguanti><link rel=stylesheet href=../../../stylesheets/font-oppoti.min.css id=font-oppoti disabled><link rel=stylesheet href=../../../stylesheets/font-jiangchengti.min.css id=font-jiangchengti disabled><link rel=stylesheet href=../../../stylesheets/font-lxgw.min.css id=font-lxgw disabled><link rel=stylesheet href=../../../stylesheets/code-font-dejavu-sans-mono.min.css id=code-font-dejavu-sans-mono><link rel=stylesheet href=../../../stylesheets/code-font-zsft-hk.min.css id=code-font-zsft-hk disabled><link rel=stylesheet href=https://unpkg.com/@waline/client@v3/dist/waline.css><link rel=stylesheet href=../../../stylesheets/waline.min.css><script src=https://cdn.jsdelivr.net/npm/mermaid@11.5.0/dist/mermaid.min.js></script><script src=../../../javascripts/start.min.js></script><script type=module src=../../../javascripts/waline.min.js></script> <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../assets/javascripts/glightbox.min.js"></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=cyan> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#linux class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../../index.html title=柯懒的知识库 class="md-header__button md-logo" aria-label=柯懒的知识库 data-md-component=logo> <img src=../../../assets/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> 柯懒的知识库 </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> 进程间通信介绍与匿名管道 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=cyan aria-label type=radio name=__palette id=__palette_1> </form> <!-- 头像元素 - 直接在HTML中定义 --> <div class=header-avatar> <img src=../../../author/作者.assets/20250206-200653.jpg alt=头像> <div class=avatar-dropdown> <p><strong>柯懒不是柯南</strong></p> <a href=../../../author/contact/contact.html class=avatar-dropdown-item>吵醒柯懒</a> <div class=avatar-dropdown-divider></div> <a href=../../../author/about/about.html class=avatar-dropdown-item>柯懒自传</a> <div class=avatar-dropdown-divider></div> <a href=https://github.com/H0308 class=avatar-dropdown-item>柯懒的零食库</a> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=查找> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <!-- 独立的切换按钮 --> <div class=toolbar-toggle-btn id=toolbarToggleBtn onclick=toggleToolbar()> <div class=toggle-icon> <svg class=toggle-arrow-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=16 height=16> <path d="M346.538667 1024L170.666667 853.333333l341.333333-341.333333-341.333333-341.333333 175.872-170.666667L853.333333 512z" fill=currentColor></path> </svg> </div> </div> <!-- 右侧固定功能条 - 独立于内容区 --> <div class=floating-toolbar id=floatingToolbar> <!-- 字体切换功能 --> <div class="toolbar-item font-switcher"> <div class=toolbar-icon> <svg class=font-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=20 height=20> <path d="M913.408 1024l-66.56 0q-29.696 0-51.2-5.12t-36.864-15.872-26.112-27.136-19.968-37.888q-15.36-38.912-28.16-70.656t-22.016-55.296q-11.264-26.624-20.48-49.152l-254.976 0q-7.168 23.552-17.408 51.2-8.192 23.552-21.504 56.832t-30.72 72.192q-20.48 46.08-47.104 63.488t-60.416 17.408l-70.656 0q-45.056 0-60.928-19.968t2.56-68.096q18.432-46.08 43.008-108.544t52.224-132.608 57.344-143.872 57.344-144.384q65.536-164.864 137.216-343.04 7.168-17.408 18.432-31.744 10.24-11.264 27.136-21.504t42.496-10.24q26.624 0 43.52 10.752t28.16 24.064q12.288 15.36 19.456 33.792 72.704 180.224 138.24 345.088 27.648 70.656 57.344 143.872t56.832 142.336 51.2 129.536 41.472 104.448q14.336 34.816 4.096 62.464t-43.008 27.648zM616.448 634.88l-97.28-347.136-1.024 0-108.544 347.136 206.848 0z" fill=currentColor></path> </svg> </div> <div class=toolbar-label>内容字体</div> <div class=font-dropdown-toolbar> <div class=font-current-toolbar onclick=toggleFontDropdownToolbar()> <span class=current-font-name-toolbar>东观体</span> <svg class=dropdown-arrow-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=12 height=12> <path d="M878.592 250.88q29.696 0 48.128 11.264t24.576 29.696 0 41.472-26.624 45.568q-82.944 92.16-159.744 180.224t-148.48 164.864q-19.456 20.48-45.568 31.744t-53.76 11.776-53.248-8.704-43.008-28.672q-39.936-44.032-82.944-90.112l-88.064-92.16q-43.008-46.08-85.504-90.624t-79.36-86.528q-17.408-19.456-22.528-40.448t1.024-38.4 23.552-28.672 45.056-11.264q35.84 0 98.816-0.512t137.728-0.512l153.6 0 150.528 0 125.952 0 79.872 0z" fill=currentColor></path> </svg> </div> <div class=font-options-toolbar> <div class=font-option-toolbar data-font=dongguanti onclick="selectFontToolbar('dongguanti')">上图东观体 </div> <div class=font-option-toolbar data-font=oppoti onclick="selectFontToolbar('oppoti')">OPPO Sans </div> <div class=font-option-toolbar data-font=jiangchengti onclick="selectFontToolbar('jiangchengti')"> 江城黑体</div> <div class=font-option-toolbar data-font=lxgw onclick="selectFontToolbar('lxgw')">霞鹜臻楷</div> </div> </div> </div> <!-- 代码字体切换功能 --> <div class="toolbar-item code-font-switcher"> <div class=toolbar-icon> <svg t=1753672111433 class="icon code-font-icon" viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg p-id=5148 width=20 height=20> <path d="M941.709938 0H82.290062A82.290062 82.290062 0 0 0 0 82.290062v859.419876A82.290062 82.290062 0 0 0 82.290062 1022.53923h859.419876A82.290062 82.290062 0 0 0 1022.53923 941.709938V82.290062A82.290062 82.290062 0 0 0 941.709938 0zM188.439372 553.631954a40.901569 40.901569 0 0 1-29.215406-70.116975L292.154066 351.558726 159.223966 218.628626a40.901569 40.901569 0 0 1 58.430813-57.94389l160.197813 162.145507a40.901569 40.901569 0 0 1 0 57.943889l-160.197813 160.684736a40.901569 40.901569 0 0 1-29.215407 12.173086z m443.587257 0H405.120304a40.901569 40.901569 0 0 1 0-82.290061H633.000476a40.901569 40.901569 0 0 1 0 82.290061z" fill=currentColor p-id=5149></path> </svg> </div> <div class=toolbar-label>代码字体</div> <div class=code-font-dropdown-toolbar> <div class=code-font-current-toolbar onclick=toggleCodeFontDropdownToolbar()> <span class=current-code-font-name-toolbar>DejaVu Sans Mono</span> <svg class=dropdown-arrow-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=12 height=12> <path d="M878.592 250.88q29.696 0 48.128 11.264t24.576 29.696 0 41.472-26.624 45.568q-82.944 92.16-159.744 180.224t-148.48 164.864q-19.456 20.48-45.568 31.744t-53.76 11.776-53.248-8.704-43.008-28.672q-39.936-44.032-82.944-90.112l-88.064-92.16q-43.008-46.08-85.504-90.624t-79.36-86.528q-17.408-19.456-22.528-40.448t1.024-38.4 23.552-28.672 45.056-11.264q35.84 0 98.816-0.512t137.728-0.512l153.6 0 150.528 0 125.952 0 79.872 0z" fill=currentColor></path> </svg> </div> <div class=code-font-options-toolbar> <div class=code-font-option-toolbar data-code-font=dejavu onclick="selectCodeFontToolbar('dejavu')"> DejaVu Sans Mono</div> <div class=code-font-option-toolbar data-code-font=zsft onclick="selectCodeFontToolbar('zsft')"> JetBrains Mono</div> </div> </div> </div> <!-- 主题切换功能 --> <div class="toolbar-item theme-switcher" onclick=switchTheme()> <div class=toolbar-icon> <svg class=theme-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=20 height=20> <path d="M876.572788 522.301623c-1.886977 12.375865-9.657964 30.331819-35.880185 45.48903-56.489572 32.697703-150.21828 83.990926-174.010149 96.958262-13.143345 24.431435-66.067718 122.221646-98.141204 178.503487-16.117073 28.124548-36.055171 34.041304-50.030463 34.041304-0.031722 0-0.031722 0-0.031722 0-14.613836 0-29.1806-6.460132-43.234687-19.218714-47.183626-42.643216-125.994576-117.105115-146.013515-136.083351-27.757181-4.732791-138.338718-23.743774-200.584388-35.752272-17.924231-3.533476-32.649608-14.07046-40.372499-29.084409-5.78782-11.256368-10.281157-30.05962 1.471514-55.658647 26.989701-59.047838 74.126254-157.557432 85.957721-182.196599-3.437286-27.117614-16.996093-135.060045-23.760147-198.905142-1.886977-17.460674 3.901867-35.096333 15.829524-48.351218 12.791327-14.278191 30.667463-21.48943 49.854455-19.426445 63.669088 6.332219 173.259042 19.426445 200.584388 22.705118 24.335245-11.879562 121.085776-58.936297 180.133613-86.34146 9.91379-4.573155 19.85828-6.92369 29.596062-6.92369 28.748764 0 52.172243 20.642133 58.328453 51.421136 12.599969 62.997799 30.93864 166.70272 35.639708 193.484689 18.851347 19.682271 91.953272 96.031147 135.060045 143.07151C872.72004 487.125473 879.307062 504.71406 876.572788 522.301623L876.572788 522.301623zM825.375755 499.085876C776.017604 445.314205 687.245791 352.977193 686.365748 352.017332c-2.942005-3.069919-4.956895-6.971785-5.676279-11.208273-0.207731-1.215688-22.193465-127.001509-36.551474-198.936865-0.799202-3.917216-4.285606-16.836457-16.196891-16.836457-3.453658 0-7.30743 1.006933-11.464099 2.942005-67.282383 31.179117-183.955662 88.180342-185.170327 88.771813-3.693112 1.790786-7.850805 2.558265-11.975752 2.01489-1.295506-0.224104-133.63765-16.165168-205.988468-23.424502-0.079818 0-0.207731 0-0.287549 0-7.30743 0-11.128455 2.89391-13.319353 5.40408-3.677762 4.124947-5.644557 9.91379-5.068436 15.110139 7.674796 72.623018 24.255427 202.934922 24.463158 204.325595 0.511653 4.109598-0.159636 8.266267-1.966795 11.960403-0.591471 1.215688-57.657164 120.04712-88.339977 187.201589-3.565199 7.754614-4.41352 14.214746-2.350534 18.131963 1.935072 3.725858 6.588045 5.820566 10.360975 6.53995 70.719668 13.718443 204.644867 36.519752 206.036563 36.727483 4.189416 0.671289 8.058536 2.686179 11.112082 5.580089 1.006933 0.87902 96.414887 91.281983 150.090367 139.889027 8.314363 7.563256 13.143345 8.106632 14.437827 8.106632 3.485381 0 8.314363-4.621251 12.727882-12.391215 36.343743-63.828724 100.011808-181.988868 100.636025-183.155437 1.983167-3.64604 5.004991-6.667863 8.650007-8.650007 1.134847-0.671289 114.418936-62.373583 178.6314-99.516528 8.698103-5.036713 14.278191-10.568706 14.94948-14.854313C834.681702 511.845481 831.49922 505.800811 825.375755 499.085876L825.375755 499.085876zM935.333076 935.670256c-4.157693 4.157693-9.689686 6.299473-15.141862 6.299473-5.548366 0-11.048637-2.142803-15.238053-6.299473l-171.915441-171.915441c-8.362458-8.394181-8.362458-21.98471 0-30.426987 8.394181-8.394181 21.98471-8.394181 30.379914 0l171.915441 171.915441C943.727257 913.684522 943.727257 927.275052 935.333076 935.670256L935.333076 935.670256z" fill=currentColor></path> </svg> </div> <div class=toolbar-label>主题切换</div> </div> <!-- 返回顶部功能 --> <div class="toolbar-item back-to-top" onclick=scrollToTop()> <div class=toolbar-icon> <svg class=back-to-top-icon viewbox="0 0 1024 1024" xmlns=http://www.w3.org/2000/svg> <path d="M882.688 624.128l-336.896-583.68c-15.872-27.136-54.784-27.136-70.656 0L138.24 624.128c-15.872 27.136 4.096 61.44 35.328 61.44H317.44c22.528 0 40.96 18.432 40.96 40.96v239.616c0 22.528 18.432 40.96 40.96 40.96h223.232c22.528 0 40.96-18.432 40.96-40.96v-239.616c0-22.528 18.432-40.96 40.96-40.96h143.872c30.208 0 50.176-34.304 34.304-61.44z"> </path> </svg> </div> <div class=toolbar-label>返回顶部</div> </div> </div> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../index.html class=md-tabs__link> 主页 </a> </li> <li class=md-tabs__item> <a href=../../../intro/intro.html class=md-tabs__link> 网站介绍 </a> </li> <li class=md-tabs__item> <a href=../../../timeline/timeline.html class=md-tabs__link> 网站时间线 </a> </li> <li class=md-tabs__item> <a href=../../../c-lang/index.html class=md-tabs__link> 编程语言 </a> </li> <li class=md-tabs__item> <a href=../../../data-structure/time-space-complexity/time-space-complexity.html class=md-tabs__link> 数据结构与算法 </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../options-commands/options-commands.html class=md-tabs__link> Linux </a> </li> <li class=md-tabs__item> <a href=../../../html-css/html/html.html class=md-tabs__link> 前端 </a> </li> <li class=md-tabs__item> <a href=../../../MySQL/JDBC/JDBC-basic/JDBC-basic.html class=md-tabs__link> MySQL </a> </li> <li class=md-tabs__item> <a href=../../../JavaEE/Spring/springmvc-basic/springmvc-basic.html class=md-tabs__link> JavaEE应用开发 </a> </li> <li class=md-tabs__item> <a href=../../../other/shell/shell.html class=md-tabs__link> 扩展知识 </a> </li> <li class=md-tabs__item> <a href=../../../tooltips/vscode-snippets/vscode-snippets.html class=md-tabs__link> 工具帮助 </a> </li> <li class=md-tabs__item> <a href=../../../projects/boost-searching-engine/boost-searching-engine.html class=md-tabs__link> 项目 </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../index.html title=柯懒的知识库 class="md-nav__button md-logo" aria-label=柯懒的知识库 data-md-component=logo> <img src=../../../assets/logo.png alt=logo> </a> 柯懒的知识库 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../index.html class=md-nav__link> <span class=md-ellipsis> 主页 </span> </a> </li> <li class=md-nav__item> <a href=../../../intro/intro.html class=md-nav__link> <span class=md-ellipsis> 网站介绍 </span> </a> </li> <li class=md-nav__item> <a href=../../../timeline/timeline.html class=md-nav__link> <span class=md-ellipsis> 网站时间线 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../c-lang/index.html class=md-nav__link> <span class=md-ellipsis> 编程语言 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../data-structure/time-space-complexity/time-space-complexity.html class=md-nav__link> <span class=md-ellipsis> 数据结构与算法 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6 checked> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex> <span class=md-ellipsis> Linux </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=true> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../options-commands/options-commands.html class=md-nav__link> <span class=md-ellipsis> Linux常用选项和指令 </span> </a> </li> <li class=md-nav__item> <a href=../../permission/permission.html class=md-nav__link> <span class=md-ellipsis> Linux权限相关 </span> </a> </li> <li class=md-nav__item> <a href=../../software-installation/software-installation.html class=md-nav__link> <span class=md-ellipsis> CentOS软件安装 </span> </a> </li> <li class=md-nav__item> <a href=../../gcc-gdb/gcc-gdb.html class=md-nav__link> <span class=md-ellipsis> Linux下的gcc与gdb </span> </a> </li> <li class=md-nav__item> <a href=../../makefile-progress-bar/makefile-progress-bar.html class=md-nav__link> <span class=md-ellipsis> Linux下的Makefile与进度条程序 </span> </a> </li> <li class=md-nav__item> <a href=../../os-basic/os-basic.html class=md-nav__link> <span class=md-ellipsis> 操作系统基础知识 </span> </a> </li> <li class=md-nav__item> <a href=../../process-basic/process-basic.html class=md-nav__link> <span class=md-ellipsis> Linux进程基础 </span> </a> </li> <li class=md-nav__item> <a href=../../process-state-priority/process-state-priority.html class=md-nav__link> <span class=md-ellipsis> Linux进程状态与进程优先级 </span> </a> </li> <li class=md-nav__item> <a href=../../process-switch-scheduling/process-switch-scheduling.html class=md-nav__link> <span class=md-ellipsis> Linux进程切换以及调度算法 </span> </a> </li> <li class=md-nav__item> <a href=../../command-line-env/command-line-env.html class=md-nav__link> <span class=md-ellipsis> Linux命令行与环境变量 </span> </a> </li> <li class=md-nav__item> <a href=../../process-address-space/process-address-space.html class=md-nav__link> <span class=md-ellipsis> Linux进程地址空间 </span> </a> </li> <li class=md-nav__item> <a href=../../process-control/process-control.html class=md-nav__link> <span class=md-ellipsis> Linux进程控制 </span> </a> </li> <li class=md-nav__item> <a href=../../linux-fileop/linux-fileop.html class=md-nav__link> <span class=md-ellipsis> Linux文件操作基础 </span> </a> </li> <li class=md-nav__item> <a href=../../io-process/io-process.html class=md-nav__link> <span class=md-ellipsis> Linux中输入和输出基本过程 </span> </a> </li> <li class=md-nav__item> <a href=../../file-system/file-system.html class=md-nav__link> <span class=md-ellipsis> Linux文件系统 </span> </a> </li> <li class=md-nav__item> <a href=../../soft-hard-link/soft-hard-link.html class=md-nav__link> <span class=md-ellipsis> Linux软链接和硬链接 </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_17 checked> <label class=md-nav__link for=__nav_6_17 id=__nav_6_17_label tabindex=0> <span class=md-ellipsis> Linux进程间通信 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_17_label aria-expanded=true> <label class=md-nav__title for=__nav_6_17> <span class="md-nav__icon md-icon"></span> Linux进程间通信 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> 进程间通信介绍与匿名管道 </span> <span class="md-nav__icon md-icon"></span> </label> <a href=com-anonymous-pipe.html class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> 进程间通信介绍与匿名管道 </span> </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 进程间通信介绍 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 管道介绍 </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 匿名管道 </span> </a> <nav class=md-nav aria-label=匿名管道> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 匿名管道介绍 </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 创建匿名管道 </span> </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> 匿名管道的特点 </span> </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 匿名管道的应用（进程池） </span> </a> <nav class=md-nav aria-label=匿名管道的应用（进程池）> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> 创建进程池 </span> </a> </li> <li class=md-nav__item> <a href=#_9 class=md-nav__link> <span class=md-ellipsis> 父进程派发任务 </span> </a> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> <span class=md-ellipsis> 销毁进程池 </span> </a> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> <span class=md-ellipsis> 细节优化 </span> </a> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> <span class=md-ellipsis> 面向过程转面向对象 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../com-named-pipe-shm/com-named-pipe-shm.html class=md-nav__link> <span class=md-ellipsis> 命名管道与共享内存 </span> </a> </li> <li class=md-nav__item> <a href=../com-message-queue-semaphore/com-message-queue-semaphore.html class=md-nav__link> <span class=md-ellipsis> 消息队列与信号量 </span> </a> </li> <li class=md-nav__item> <a href=../com-system-v-resources/com-system-v-resources.html class=md-nav__link> <span class=md-ellipsis> 操作系统管理System V标准中三种资源的方式 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../signals-os-principles/signals-os-principles.html class=md-nav__link> <span class=md-ellipsis> Linux信号与操作系统原理 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../linux-thread/thread-concept-op/thread-concept-op.html class=md-nav__link> <span class=md-ellipsis> Linux线程 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../../net-basic/net-basic.html class=md-nav__link> <span class=md-ellipsis> 网络基础知识 </span> </a> </li> <li class=md-nav__item> <a href=../../socket-basic/socket-basic.html class=md-nav__link> <span class=md-ellipsis> Socket编程基础 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../udp/udp-basic/udp-basic.html class=md-nav__link> <span class=md-ellipsis> UDP编程 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../../tcp-basic/tcp-basic.html class=md-nav__link> <span class=md-ellipsis> TCP编程接口基本使用 </span> </a> </li> <li class=md-nav__item> <a href=../../serialization-net-cal/serialization-net-cal.html class=md-nav__link> <span class=md-ellipsis> 序列化和反序列化与网络计算器 </span> </a> </li> <li class=md-nav__item> <a href=../../process-relationship-daemon/process-relationship-daemon.html class=md-nav__link> <span class=md-ellipsis> 进程间关系和守护进程 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../http/http-basic-httpserver/http-basic-httpserver.html class=md-nav__link> <span class=md-ellipsis> 应用层协议HTTP </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../../udp-principles/udp-principles.html class=md-nav__link> <span class=md-ellipsis> UDP协议原理 </span> </a> </li> <li class=md-nav__item> <a href=../../tcp-principles/tcp-principles.html class=md-nav__link> <span class=md-ellipsis> TCP协议原理 </span> </a> </li> <li class=md-nav__item> <a href=../../tcp-connection-backlog/tcp-connection-backlog.html class=md-nav__link> <span class=md-ellipsis> 理解Linux如何看待连接以及TCP全连接队列 </span> </a> </li> <li class=md-nav__item> <a href=../../ip/ip.html class=md-nav__link> <span class=md-ellipsis> 网络层IP协议 </span> </a> </li> <li class=md-nav__item> <a href=../../datalink/datalink.html class=md-nav__link> <span class=md-ellipsis> 数据链路层协议 </span> </a> </li> <li class=md-nav__item> <a href=../../dns-icmp/dns-icmp.html class=md-nav__link> <span class=md-ellipsis> DNS与ICMP </span> </a> </li> <li class=md-nav__item> <a href=../../nat-proxy/nat-proxy.html class=md-nav__link> <span class=md-ellipsis> NAT技术、代理服务器和内网穿透 </span> </a> </li> <li class=md-nav__item> <a href=../../io-model-select-poll/io-model-select-poll.html class=md-nav__link> <span class=md-ellipsis> 五种IO模型与select和poll分别实现多路转接 </span> </a> </li> <li class=md-nav__item> <a href=../../epoll/epoll.html class=md-nav__link> <span class=md-ellipsis> epoll实现多路转接 </span> </a> </li> <li class=md-nav__item> <a href=../../reactor-et/reactor-et.html class=md-nav__link> <span class=md-ellipsis> Reactor模式与完善基于边缘触发模式epoll实现TCP服务器 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../html-css/html/html.html class=md-nav__link> <span class=md-ellipsis> 前端 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../MySQL/JDBC/JDBC-basic/JDBC-basic.html class=md-nav__link> <span class=md-ellipsis> MySQL </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../JavaEE/Spring/springmvc-basic/springmvc-basic.html class=md-nav__link> <span class=md-ellipsis> JavaEE应用开发 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../other/shell/shell.html class=md-nav__link> <span class=md-ellipsis> 扩展知识 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../tooltips/vscode-snippets/vscode-snippets.html class=md-nav__link> <span class=md-ellipsis> 工具帮助 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../projects/boost-searching-engine/boost-searching-engine.html class=md-nav__link> <span class=md-ellipsis> 项目 </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 进程间通信介绍 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 管道介绍 </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 匿名管道 </span> </a> <nav class=md-nav aria-label=匿名管道> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 匿名管道介绍 </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 创建匿名管道 </span> </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> 匿名管道的特点 </span> </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 匿名管道的应用（进程池） </span> </a> <nav class=md-nav aria-label=匿名管道的应用（进程池）> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> 创建进程池 </span> </a> </li> <li class=md-nav__item> <a href=#_9 class=md-nav__link> <span class=md-ellipsis> 父进程派发任务 </span> </a> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> <span class=md-ellipsis> 销毁进程池 </span> </a> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> <span class=md-ellipsis> 细节优化 </span> </a> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> <span class=md-ellipsis> 面向过程转面向对象 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=linux>Linux进程间通信<a class=headerlink href=#linux title="Permanent link">&para;</a></h1> <div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;"> <p><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 8015 个字 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 888 行代码 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 11 张图片 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 38 分钟</p> </div> <h2 id=_1>进程间通信介绍<a class=headerlink href=#_1 title="Permanent link">&para;</a></h2> <p>进程间通信，就是让进程之间可以访问同一个资源，但是进程本身是具有独立性的，所以直接让两个进程访问同一个资源是做不到的</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>需要注意，尽管父子进程可以访问到全局变量，但是这个变量如果子进程要修改就会发生写时拷贝，最后导致两个进程看到的实际上并不是同一个全局变量</p> </div> <p>既然从进程角度出发无法直接做到，就需要考虑通过「第三方」进行，此处的「第三方」就是操作系统。从某一个角度来看，操作系统是所有进程所共享的资源</p> <p>进程间通信在Linux中有下面的作用：</p> <ol> <li>数据传输：一个进程需要将它的数据发送给另一个进程</li> <li>资源共享：多个进程之间共享同样的资源</li> <li>通知事件：一个进程需要向另一个或一组进程发送消息，通知它（它们）发生了某种事件（如进程终止时要通知父进程）</li> <li>进程控制：有些进程希望完全控制另一个进程的执行（如Debug进程），此时控制进程希望能够拦截另一个进程的所有陷入和异常，并能够及时知道它的状态改变</li> </ol> <p>进程间通信本质上属于本地通信，即在同一台主机、同一个操作系统下进行的通信，对应着就有三种标准，根据进程间通信的发展，最先出现的就是管道方式通信，其次就是System V进程间通信一直到现在的POSIX进程间通信</p> <p>其中，管道方式通信有下面两种：</p> <ol> <li>匿名管道</li> <li>命名管道</li> </ol> <p>System V进程间通信有下面三种：</p> <ol> <li>System V消息队列</li> <li>System V共享内存</li> <li>System V信号量</li> </ol> <p>POSIX进程间通信有下面6种：</p> <ol> <li>消息队列</li> <li>共享内存</li> <li>信号量</li> <li>互斥量</li> <li>条件变量</li> <li>读写锁</li> </ol> <h2 id=_2>管道介绍<a class=headerlink href=#_2 title="Permanent link">&para;</a></h2> <p>在介绍匿名管道前，先了解何为管道：</p> <p>管道是Unix/Linux中最古老的进程间通信的形式，把从一个进程连接到另一个进程的一个数据流称为一个「管道」。在前面<a href=https://www.help-doc.top/Linux/options-commands/options-commands.html#_11>Linux常用选项和指令</a>已经介绍过管道的基础使用，此处进一步探讨管道到底是如何执行的</p> <p>以下面的命令为例：</p> <div class="language-shell highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-1>who<span class=w> </span><span class=p>|</span><span class=w> </span>wc<span class=w> </span>-l
</span></code></pre></div></td></tr></table></div> <p>这个指令的作用是：统计当前使用Linux系统有多少个用户登录。其中，<code>who</code>显示当前登录的用户和其他信息，<code>wc</code>用于代表word count，可以用来统计给定文件中的字节数、字数、行数等，其中的<code>-l</code>表示只输出行数</p> <p>上面的命令执行过程如下：</p> <p><a class=glightbox href="1. 进程间通信介绍与匿名管道.assets/image-20241222213037593.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="1. 进程间通信介绍与匿名管道.assets/image-20241222213037593.png"></a></p> <p>为了揭示管道左右两侧的命令的本质，可以执行下面的命令：</p> <div class="language-shell highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-1-1>sleep<span class=w> </span><span class=m>10</span><span class=w> </span><span class=p>|</span><span class=w> </span>sleep<span class=w> </span><span class=m>20</span><span class=w> </span><span class=p>&amp;</span>
</span></code></pre></div></td></tr></table></div> <div class="admonition info"> <p class=admonition-title>后台执行符号<code>&amp;</code></p> <p>当在命令末尾加上<code>&amp;</code>符号时，它会让该命令在后台运行，这样就可以立即得到命令行提示符，并可以继续输入其他命令而不必等待前面的命令完成。当一个进程在后台运行时，系统会提示后台运行的任务号和进程PID，如下图所示：</p> <p><a class=glightbox href="1. 进程间通信介绍与匿名管道.assets\Snipaste_2025-01-17_17-49-30.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="1. 进程间通信介绍与匿名管道.assets\Snipaste_2025-01-17_17-49-30.png"></a></p> <p>如果进程在后台运行，就不可以使用<span class=keys><kbd class=key-control>Ctrl</kbd><span>+</span><kbd class=key-c>C</kbd></span>终止，此时可以考虑使用<code>kill</code>指令终止，也可以通过<code>fg -任务号</code>将进程移动到前台再使用<span class=keys><kbd class=key-control>Ctrl</kbd><span>+</span><kbd class=key-c>C</kbd></span>终止</p> </div> <p>上面命令的作用是：同时启动睡眠计时器，并让二者在后台运行</p> <p>执行上面的指令后使用下面的指令查看<code>sleep</code>进程：</p> <div class="language-shell highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-2-1>ps<span class=w> </span>ajx<span class=w> </span><span class=p>|</span><span class=w> </span>head<span class=w> </span>-1<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>ps<span class=w> </span>ajx<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>sleep
</span></code></pre></div></td></tr></table></div> <p>可以看到下面的结果：</p> <p><a class=glightbox href="1. 进程间通信介绍与匿名管道.assets\Snipaste_2024-12-22_21-37-39.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="1. 进程间通信介绍与匿名管道.assets\Snipaste_2024-12-22_21-37-39.png"></a></p> <p>观察到二者的均为进程，并且二者的父进程相同，说明管道左侧和右侧的指令都变为了进程，并且具有兄弟关系。根据这个现象，可以得出<strong>管道实际上就是为两个进程提供通信的方式</strong></p> <h2 id=_3>匿名管道<a class=headerlink href=#_3 title="Permanent link">&para;</a></h2> <h3 id=_4>匿名管道介绍<a class=headerlink href=#_4 title="Permanent link">&para;</a></h3> <p>对管道有了了解后，接下来就可以了解何为匿名管道</p> <p>在前面学习文件时，当文件需要被一个进程打开时，操作系统会根据进程的<code>CWD</code>找到文件所在目录，再根据文件名和<code>inode</code>编号映射找到对应的文件将其加载到内存，此时在文件视角会创建对应的<code>struct file</code>，在进程视角会存在进程PCB和<code>files_struct</code>，其中存在<code>fd_array</code>，并在<code>fd_array</code>的空位置存储文件指针，为了可以进行文件内容写入和读取，打开文件后也会创建对应的文件内核级缓冲区，如下图所示：</p> <p><a class=glightbox href="1. 进程间通信介绍与匿名管道.assets\Snipaste_2024-12-22_21-52-11.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="1. 进程间通信介绍与匿名管道.assets\Snipaste_2024-12-22_21-52-11.png"></a></p> <p>如果此时的进程创建了一个子进程，那么在子进程不修改数据的前提下，子进程会拷贝父进程的<code>task_struct</code>、<code>files_struct</code>（包括<code>fd_array</code>）以及<code>struct file</code>，但是子进程不会再次打开父进程已经打开的文件，也就是说，对于文件内核级缓冲区和已经从磁盘加载到内存的文件来说，子进程和父进程是共享的</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>子进程之所以要拷贝<code>struct file</code>是为了保证子进程也可以向文件中写入数据，在<code>struct file</code>中存在文件偏移量，当子进程修改这个文件偏移量时只有在不与父进程共享的前提下才可以做到父进程和子进程在文件的不同位置写入数据</p> </div> <div class="admonition info"> <p class=admonition-title>何时关闭文件</p> <p>当一个进程打开了一个文件，那么正常情况下，在该进程结束后，这个文件会自动被操作系统释放，那么操作系统是如何知道这个文件已经没有进程在访问的，其实是通过<code>struct file</code>中的一个称为「引用计数」的属性，这个属性子进程并不会修改，只有这个引用计数为0时，操作系统才会自动释放文件。进程也可以调用关闭文件的接口关闭文件，例如<code>close()</code></p> </div> <p>既然子进程和父进程共享一个文件内核级缓冲区，那么此时这个文件内核级缓冲区就是子进程和父进程两个进程所共享的资源，也就满足了进程间通信的前提条件：「进程间共享同一个资源」，并且这个资源并不是由子进程或者父进程提供，而是由操作系统提供的，所以也就不会因为进程独立性导致一个进程修改另外一个进程看不到的情况</p> <p>但是现在的问题就是每一次父子进程需要通信就必须先打开一个磁盘中存在的文件，这个过程就会有点繁琐并且如果频繁做IO也会影响到系统整体的效率。为了解决这个问题就需要考虑一种存在于内存中的结构，这个结构不需要实际存在于硬盘中，也就想到了直接使用一个匿名的文件内核级缓冲区。这便是匿名管道「匿名」的由来</p> <p>既然是文件内核级缓冲区，就说明可以直接调用文件相关的接口直接操作，但需要保证这个文件内核级缓冲区不自动刷新，否则可能读端还没读取到内容数据就已经丢失了。其中「直接调用文件相关的接口」也是最开始想到使用文件内核级缓冲区作为通信介质的原因</p> <div class="admonition info"> <p class=admonition-title>「管道」的由来</p> <p>之所以叫这个作为进程通信介质的文件内核级缓冲区为「管道」是因为最开始只想到一端向另一端发送数据，也就是一方写入一方读取，即所谓的单向通信，在现实生活中，管道大部分便是一端进一端出，所以将其命名为「管道」</p> </div> <h3 id=_5>创建匿名管道<a class=headerlink href=#_5 title="Permanent link">&para;</a></h3> <p>在Linux中创建匿名管道按照下面的步骤：</p> <ol> <li>父进程调用系统调用接口<code>pipe()</code>打开匿名的文件内核级缓冲区，其中<code>pipe()</code>接口中传递一个两个元素的数组，数组的第一个元素表示读端，第二个元素表示写端，返回值为一个整数，返回0表示打开成功，-1表示打开失败</li> <li>父进程创建子进程</li> <li>因为管道只能单向通信，所以只能读写或者写读，如果是读写，那么父进程就需要关闭写，子进程就需要关闭读，这一步并不是必须的，但是如果不关闭可能会出现误操作导致数据错误</li> </ol> <div class="admonition note"> <p class=admonition-title>Note</p> <p>注意，不可以颠倒步骤1和步骤2，因为只有父进程创建了文件内核级缓冲区，子进程才能拷贝其文件描述符表和文件结构</p> </div> <p>根据上面的步骤可以写出下面的代码（以父进程读，子进程写为例）：</p> <ol> <li> <p>父进程调用<code>pipe()</code>接口</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-3-1><span class=kt>int</span><span class=w> </span><span class=n>fd_pipe</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span><span id=__span-3-2>
</span><span id=__span-3-3><span class=c1>// 1. 父进程调用pipe</span>
</span><span id=__span-3-4><span class=kt>int</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pipe</span><span class=p>(</span><span class=n>fd_pipe</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <p>父进程创建子进程</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-4-1><span class=c1>// 2. 父进程创建子进程</span>
</span><span id=__span-4-2><span class=kt>int</span><span class=w> </span><span class=n>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fork</span><span class=p>();</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <p>父进程关闭写端，子进程关闭读端</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-5-1><span class=c1>// 3. 父进程关闭写端，子进程关闭读端</span>
</span><span id=__span-5-2><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pid</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-5-3><span class=p>{</span>
</span><span id=__span-5-4><span class=w>    </span><span class=c1>// 子进程</span>
</span><span id=__span-5-5><span class=w>    </span><span class=c1>// 子进程关闭读端</span>
</span><span id=__span-5-6><span class=w>    </span><span class=n>close</span><span class=p>(</span><span class=n>fd_pipe</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span><span id=__span-5-7><span class=p>}</span>
</span><span id=__span-5-8><span class=k>else</span>
</span><span id=__span-5-9><span class=p>{</span>
</span><span id=__span-5-10><span class=w>    </span><span class=c1>// 父进程</span>
</span><span id=__span-5-11><span class=w>    </span><span class=c1>// 父进程关闭写端</span>
</span><span id=__span-5-12><span class=w>    </span><span class=n>close</span><span class=p>(</span><span class=n>fd_pipe</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-5-13><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> </ol> <p>现在，子进程向匿名管道中写入数据，为了保证父进程看到的数据是动态变化的，可以使用一个计数器<code>count</code>，子进程向父进程写入一串字符串，父进程读取该字符串，完整示例代码如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-6-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-6-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;unistd.h&gt;</span>
</span><span id=__span-6-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;sys/wait.h&gt;</span>
</span><span id=__span-6-4>
</span><span id=__span-6-5><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-6-6><span class=p>{</span>
</span><span id=__span-6-7><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>fd_pipe</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span><span id=__span-6-8>
</span><span id=__span-6-9><span class=w>    </span><span class=c1>// 1. 父进程调用pipe</span>
</span><span id=__span-6-10><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pipe</span><span class=p>(</span><span class=n>fd_pipe</span><span class=p>);</span>
</span><span id=__span-6-11>
</span><span id=__span-6-12><span class=w>    </span><span class=c1>// 如果ret为0，证明打开成功，否则打开失败</span>
</span><span id=__span-6-13><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=p>)</span>
</span><span id=__span-6-14><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-6-15>
</span><span id=__span-6-16><span class=w>    </span><span class=kt>pid_t</span><span class=w> </span><span class=n>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fork</span><span class=p>();</span>
</span><span id=__span-6-17>
</span><span id=__span-6-18><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pid</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-6-19><span class=w>    </span><span class=p>{</span>
</span><span id=__span-6-20><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-6-21><span class=w>        </span><span class=c1>// 子进程</span>
</span><span id=__span-6-22><span class=w>        </span><span class=c1>// 子进程关闭读端</span>
</span><span id=__span-6-23><span class=w>        </span><span class=n>close</span><span class=p>(</span><span class=n>fd_pipe</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span><span id=__span-6-24><span class=w>        </span><span class=c1>// 子进程持续写</span>
</span><span id=__span-6-25><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-6-26><span class=w>        </span><span class=p>{</span>
</span><span id=__span-6-27><span class=w>            </span><span class=n>count</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-6-28><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;hello linux &quot;</span><span class=p>;</span>
</span><span id=__span-6-29><span class=w>            </span><span class=n>msg</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>count</span><span class=p>);</span>
</span><span id=__span-6-30>
</span><span id=__span-6-31><span class=w>            </span><span class=c1>// 写入——C++字符串不包含\0</span>
</span><span id=__span-6-32><span class=w>            </span><span class=n>write</span><span class=p>(</span><span class=n>fd_pipe</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=w> </span><span class=n>msg</span><span class=p>.</span><span class=n>c_str</span><span class=p>(),</span><span class=w> </span><span class=n>msg</span><span class=p>.</span><span class=n>size</span><span class=p>());</span>
</span><span id=__span-6-33><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-6-34><span class=w>        </span><span class=p>}</span>
</span><span id=__span-6-35><span class=w>    </span><span class=p>}</span>
</span><span id=__span-6-36><span class=w>    </span><span class=k>else</span>
</span><span id=__span-6-37><span class=w>    </span><span class=p>{</span>
</span><span id=__span-6-38><span class=w>        </span><span class=c1>// 父进程</span>
</span><span id=__span-6-39><span class=w>        </span><span class=c1>// 父进程关闭写端</span>
</span><span id=__span-6-40><span class=w>        </span><span class=n>close</span><span class=p>(</span><span class=n>fd_pipe</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-6-41>
</span><span id=__span-6-42><span class=w>        </span><span class=kt>char</span><span class=w> </span><span class=n>buffer</span><span class=p>[</span><span class=mi>1024</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span><span id=__span-6-43><span class=w>        </span><span class=c1>// 父进程持续读取</span>
</span><span id=__span-6-44><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-6-45><span class=w>        </span><span class=p>{</span>
</span><span id=__span-6-46><span class=w>            </span><span class=kt>ssize_t</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>read</span><span class=p>(</span><span class=n>fd_pipe</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=mi>1024</span><span class=p>);</span>
</span><span id=__span-6-47><span class=w>            </span><span class=c1>// 在字符串末尾添加\0</span>
</span><span id=__span-6-48><span class=w>            </span><span class=n>buffer</span><span class=p>[</span><span class=n>n</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span><span id=__span-6-49><span class=w>            </span><span class=n>printf</span><span class=p>(</span><span class=s>&quot;父进程读取到：%s</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>);</span>
</span><span id=__span-6-50><span class=w>        </span><span class=p>}</span>
</span><span id=__span-6-51>
</span><span id=__span-6-52><span class=w>        </span><span class=c1>// 回收子进程</span>
</span><span id=__span-6-53><span class=w>        </span><span class=kt>pid_t</span><span class=w> </span><span class=n>rid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>waitpid</span><span class=p>(</span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=k>nullptr</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-6-54><span class=w>    </span><span class=p>}</span>
</span><span id=__span-6-55><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-6-56><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>部分输出结果如下：</p> <p><a class=glightbox href="1. 进程间通信介绍与匿名管道.assets\Snipaste_2024-12-23_16-03-45.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="1. 进程间通信介绍与匿名管道.assets\Snipaste_2024-12-23_16-03-45.png"></a></p> <p>从上面的运行结果可以看到，尽管子进程在一直修改<code>count</code>变量，父进程依旧可以正常读取到修改后的<code>count</code>，现在基本上就实现了父子进程通信</p> <h3 id=_6>匿名管道的特点<a class=headerlink href=#_6 title="Permanent link">&para;</a></h3> <p>在Linux中，匿名管道有如下四个现象：</p> <ol> <li>如果当前匿名管道为空且正常，那么此时读端就会等待，直到匿名管道中存在数据</li> <li>如果当前匿名管道为满（在Ubuntu下是64KB）且正常，那么此时写端就会等待，直到匿名管道重新有空间</li> <li>如果匿名管道的写端关闭，但是读端还在读取，那么此时读端相当于读取到文件结尾结束读取</li> <li>如果匿名管道写端正常写入，但是读端关闭，那么操作系统会直接关闭写端进程，关闭的方式就是通过发送<code>SIGPIPE</code>（编号为13）信号</li> </ol> <p>匿名管道的特点：</p> <ol> <li>面向字节流</li> <li>用来进行父子等具有“血缘”关系的进程进行进程间通信</li> <li>匿名管道的生命周期同文件的生命周期</li> <li>单向数据通信</li> <li>管道带有同步互斥等保护机制（从上面的现象1和2可以看出）。因为匿名管道属于共享资源，只要是共享资源就会有「数据不一致」问题，此时就必须要有对应的策略对这个资源进行保护，通常这个被保护的资源也被称为临界资源（即在一个时间段内只能有一个进程访问的资源），而访问临界资源的代码片段也被称为临界区</li> </ol> <div class="admonition info"> <p class=admonition-title>何为面向字节流</p> <p>当提到匿名管道具有「面向字节流」的特点时，这意味着：</p> <ol> <li>无消息边界：匿名管道处理的数据被视为连续的字节流，而不是离散的消息。发送方可以写入任意数量的字节到管道中，而接收方则从管道中读取这些字节。但是，读取操作并不保证会一次性读取所有写入的数据；每次读取可能返回任意数量的字节，直到所有数据都被读取完毕。因此，应用程序需要自行管理如何将字节流重新组合成有意义的消息</li> <li>顺序性：字节流中的字节保持它们被写入时的顺序。也就是说，第一个写入管道的字节将是第一个被读出的字节（FIFO, First In First Out），这确保了数据传输的顺序不会被打乱</li> <li>不可寻址性：由于是面向字节流的，所以不能像文件那样随机访问或定位到特定位置读写数据。你只能从当前的位置开始读或写，且一旦读取后，这些数据就被消费掉了，不能再次读取</li> <li>半双工通信：传统上的匿名管道是单向的，即数据只能在一个方向上流动。如果需要双向通信，则必须创建两个管道，每个管道负责一个方向的数据传输。然而，某些现代操作系统提供了全双工的匿名管道</li> <li>阻塞性质：当一个进程尝试从管道中读取数据但管道为空时，该读取操作会被阻塞，直到有数据可读为止。同样地，如果管道已满（尽管大多数现代系统对管道容量很大，几乎不会出现这种情况），写入操作也会被阻塞，直到有足够的空间来容纳新数据</li> <li>有限缓冲区：虽然理论上可以认为管道能处理无限量的数据流，但实际上每个匿名管道都有一定的缓冲区大小。当缓冲区满时，写入操作会被阻塞直到有足够空间可用</li> </ol> </div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>在Linux系统下，对于匿名管道来说存在一个<code>PIPE_BUF</code>宏，该宏指定了在匿名管道中，如果一次写入的数据小于<code>PIPE_BUF</code>的值，那么这个写入过程就是原子性的，即整个写入过程不会被其他进程向同一管道的写入操作所打断</p> </div> <h3 id=_7>匿名管道的应用（进程池）<a class=headerlink href=#_7 title="Permanent link">&para;</a></h3> <p>有了匿名管道之后，就可以通过实际的案例来体会匿名管道在进程通信中的作用，本次以进程池的例子作为演示</p> <p>在前面<a href=https://www.help-doc.top/Linux/process-control/process-control.html#shell1>手撕shell</a>中，每一次执行一个命令时，父进程会将该命令交给子进程进行处理，如果有多个命令就需要创建多个进程，例如执行<code>who | wc -l</code>命令。为了避免在每一次执行时都需要重新创建子进程，可以考虑提前创建好子进程，再由父进程将任务派发给指定的进程，此时的所有进程构成的就是一个进程池。当一个任务被提交到进程池中时，池中的空闲进程会取出任务并开始执行。一旦完成，该进程又回到池中等待下一个任务，示意图如下：</p> <p><a class=glightbox href="1. 进程间通信介绍与匿名管道.assets\Snipaste_2024-12-26_16-41-09.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="1. 进程间通信介绍与匿名管道.assets\Snipaste_2024-12-26_16-41-09.png"></a></p> <p>根据上面的描述，本次设计进程池分为下面的步骤：</p> <ol> <li>创建进程池</li> <li>父进程派发任务</li> <li>销毁进程池</li> </ol> <p>在本次实现进程池时，可能并不是使用<code>.cpp</code>或者<code>.h</code>的文件后缀，例如C++源文件使用<code>.cc</code>而不是<code>.cpp</code>，C++头文件使用<code>.hpp</code>而不是使用<code>.h</code>。下面是常见的C++源文件和头文件的后缀以及各自的区别：</p> <ul> <li> <p>源文件（Source Files）：</p> <ol> <li><code>.cpp</code>：这是最常用的C++源代码文件扩展名。它包含了程序的主要实现部分，包括函数定义、类成员函数的实现等。编译器会直接编译这些文件来生成目标代码</li> <li><code>.cc</code>或<code>.cxx</code>：这些也是用于表示C++源文件的扩展名，虽然不如<code>.cpp</code>常见，但在某些项目或组织中可能会用到。它们与<code>.cpp</code>文件的作用相同</li> </ol> </li> <li> <p>头文件（Header Files）：</p> <ol> <li><code>.h</code>：传统上，这是C语言头文件的扩展名，但它也被广泛应用于C++项目中。头文件主要用于声明，比如函数原型、宏定义、结构体定义等。它们通常不包含实现代码，而是提供给其他源文件包含（通过<code>#include</code>指令），以便共享声明信息。</li> <li><code>.hpp</code>或<code>.hxx</code>：这些是专门为C++设计的头文件扩展名，用来区别于C语言的头文件。<code>.hpp</code>可能更常用一些。这类文件除了可以包含声明外，有时也会包含模板的定义或者其他仅在编译时需要的信息，因为模板的实现通常必须在编译时可见</li> <li><code>.hh</code>：另一个较少见的C++头文件扩展名</li> </ol> </li> </ul> <p>为了当前项目可以更方便编译，下面是当前项目的通用<code>Makefile</code>：</p> <div class="language-makefile highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Makefile</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-7-1><span class=nv>TARGET</span><span class=o>=</span>process_pool
</span><span id=__span-7-2><span class=nv>SRC</span><span class=o>=</span><span class=k>$(</span>wildcard<span class=w> </span>*.cc<span class=k>)</span>
</span><span id=__span-7-3><span class=nv>FLAGS</span><span class=o>=</span>-c<span class=w> </span>-Wall<span class=w> </span>-std<span class=o>=</span>c++11
</span><span id=__span-7-4><span class=nv>TARGETFLAG</span><span class=w> </span><span class=o>=</span><span class=w> </span>-o
</span><span id=__span-7-5><span class=nv>CC</span><span class=o>=</span>g++
</span><span id=__span-7-6><span class=nv>OBJ</span><span class=o>=</span><span class=k>$(</span>SRC:.cc<span class=o>=</span>.o<span class=k>)</span>
</span><span id=__span-7-7>
</span><span id=__span-7-8><span class=c># 生成目标文件</span>
</span><span id=__span-7-9><span class=nf>$(TARGET)</span><span class=o>:</span><span class=k>$(</span><span class=nv>OBJ</span><span class=k>)</span>
</span><span id=__span-7-10><span class=w>    </span><span class=k>$(</span>CC<span class=k>)</span><span class=w> </span>$^<span class=w> </span><span class=k>$(</span>TARGETFLAG<span class=k>)</span><span class=w> </span><span class=nv>$@</span>
</span><span id=__span-7-11>
</span><span id=__span-7-12><span class=c># 生成对应的.o文件</span>
</span><span id=__span-7-13><span class=nf>%.o</span><span class=o>:</span>%.<span class=n>cc</span>
</span><span id=__span-7-14><span class=w>    </span><span class=k>$(</span>CC<span class=k>)</span><span class=w> </span>$&lt;<span class=w> </span><span class=k>$(</span>FLAGS<span class=k>)</span>
</span><span id=__span-7-15>
</span><span id=__span-7-16><span class=c># 清理</span>
</span><span id=__span-7-17><span class=nf>.PHONY</span><span class=o>:</span><span class=n>clean</span>
</span><span id=__span-7-18><span class=nf>clean</span><span class=o>:</span>
</span><span id=__span-7-19><span class=w>    </span>rm<span class=w> </span>-f<span class=w> </span><span class=k>$(</span>OBJ<span class=k>)</span><span class=w> </span><span class=k>$(</span>TARGET<span class=k>)</span>
</span></code></pre></div></td></tr></table></div> <p>在上面的<code>Makefile</code>中，<code>-Wall</code>表示展示所有<code>warning</code>信息</p> <div class="admonition abstract"> <p class=admonition-title>Abstract</p> <p>本项目先用面向过程的思想进行编写，再将面向过程的代码转换为面向对象的代码</p> </div> <h4 id=_8>创建进程池<a class=headerlink href=#_8 title="Permanent link">&para;</a></h4> <p><strong>通过用户输入获取进程池中进程的个数</strong></p> <p>为了可以自定义进程池中进程的个数，可以考虑通过从命令行中获取子进程个数，假设进程池项目可执行文件名为<code>process_pool</code>，那么正确的使用方法如下：</p> <div class="language-shell highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-8-1>./process_pool<span class=w> </span>子进程个数
</span></code></pre></div></td></tr></table></div> <p>为了达到上面的效果，可以写出下面的代码：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-9-1><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span><span id=__span-9-2><span class=p>{</span>
</span><span id=__span-9-3><span class=w>    </span><span class=c1>// 如果命令行参数个数不为两个，说明使用方法不对</span>
</span><span id=__span-9-4><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>argc</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>2</span><span class=p>)</span>
</span><span id=__span-9-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-9-6><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;正确使用方法：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;子进程个数&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-9-7><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-9-8><span class=w>    </span><span class=p>}</span>
</span><span id=__span-9-9>
</span><span id=__span-9-10><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-9-11><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>如果上面的<code>if</code>语句未进入，说明使用方式正确，执行后面的代码</p> <p><strong>创建指定个数个子进程</strong></p> <p>创建子进程使用<code>fork()</code>接口，创建子进程对应的管道使用<code>pipe()</code>接口，具体使用方式在前面已经提及，下面主要讨论如何管理管道和对应的子进程</p> <p>因为需要根据指定个数创建子进程，所以少不了要使用循环控制，考虑在循环中创建管道数组可以保证每一次的数组都存储不同的值，但是弊端就是除了每一次循环结束管道数组就会销毁，所以父进程就需要对管道数组进行统一管理，因为父进程是向子进程派发任务，所以父进程可以考虑只管理写端接口，此处可以考虑直接使用一个<code>vector</code>存储每一个管道写端的文件描述符，但是为了更好的进行管理以及添加属性和功能，可以为管道创建一个类，下面是管道的示例类：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-10-1><span class=c1>// 定义管道类</span>
</span><span id=__span-10-2><span class=k>class</span><span class=w> </span><span class=nc>Channel</span>
</span><span id=__span-10-3><span class=p>{</span>
</span><span id=__span-10-4><span class=k>public</span><span class=o>:</span>
</span><span id=__span-10-5><span class=w>    </span><span class=n>Channel</span><span class=p>(</span><span class=kt>pid_t</span><span class=w> </span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>wfd</span><span class=p>)</span>
</span><span id=__span-10-6><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=n>_pid</span><span class=p>(</span><span class=n>pid</span><span class=p>),</span><span class=w> </span><span class=n>_wfd</span><span class=p>(</span><span class=n>wfd</span><span class=p>)</span>
</span><span id=__span-10-7><span class=w>    </span><span class=p>{</span>
</span><span id=__span-10-8><span class=w>        </span><span class=c1>// 设置管道名称为：Channel-编号-写端文件描述符-对应的子进程</span>
</span><span id=__span-10-9><span class=w>        </span><span class=n>_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;Channel-&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>_count</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;-wfd&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>_wfd</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;-pid=&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>_pid</span><span class=p>);</span>
</span><span id=__span-10-10><span class=w>    </span><span class=p>}</span>
</span><span id=__span-10-11>
</span><span id=__span-10-12><span class=k>private</span><span class=o>:</span>
</span><span id=__span-10-13><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>_name</span><span class=p>;</span><span class=w> </span><span class=c1>// 管道名称</span>
</span><span id=__span-10-14><span class=w>    </span><span class=kt>pid_t</span><span class=w> </span><span class=n>_pid</span><span class=p>;</span><span class=w>        </span><span class=c1>// 管道对应的子进程</span>
</span><span id=__span-10-15><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>_wfd</span><span class=p>;</span><span class=w>          </span><span class=c1>// 管道的写端文件描述符</span>
</span><span id=__span-10-16><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>_count</span><span class=p>;</span><span class=w> </span><span class=c1>// 管道的编号</span>
</span><span id=__span-10-17><span class=p>};</span>
</span><span id=__span-10-18><span class=kt>int</span><span class=w> </span><span class=n>Channel</span><span class=o>::</span><span class=n>_count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> <p>创建进程池的步骤由父进程来完成，所以在父进程中执行循环，循环体内父进程先创建管道并创建子进程，子进程关闭写端，父进程关闭读端，为了保证子进程执行完任务后退出，可以使用<code>exit()</code>接口。最后，前面将管道定义为了一个类，这个过程只是做到了「先描述」，接下来就是根据子进程<code>pid</code>和对应的写端创建管道对象并插入到<code>vector</code>中完成「后组织」，整个过程的代码如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-11-1><span class=c1>// 根据指定个数创建子进程</span>
</span><span id=__span-11-2><span class=kt>int</span><span class=w> </span><span class=n>process_num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>atoi</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-11-3><span class=c1>// 用于组织Channel对象</span>
</span><span id=__span-11-4><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;</span><span class=w> </span><span class=n>channels</span><span class=p>;</span>
</span><span id=__span-11-5><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>process_num</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-11-6><span class=p>{</span>
</span><span id=__span-11-7><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>pipe_arr</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span><span id=__span-11-8><span class=w>    </span><span class=c1>// 创建管道</span>
</span><span id=__span-11-9><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>ret_p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pipe</span><span class=p>(</span><span class=n>pipe_arr</span><span class=p>);</span>
</span><span id=__span-11-10><span class=w>    </span><span class=c1>// 错误处理</span>
</span><span id=__span-11-11><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret_p</span><span class=p>)</span>
</span><span id=__span-11-12><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-11-13>
</span><span id=__span-11-14><span class=w>    </span><span class=c1>// 创建子进程</span>
</span><span id=__span-11-15><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fork</span><span class=p>();</span>
</span><span id=__span-11-16><span class=w>    </span><span class=c1>// 错误处理</span>
</span><span id=__span-11-17><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pid</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-11-18><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>2</span><span class=p>;</span>
</span><span id=__span-11-19>
</span><span id=__span-11-20><span class=w>    </span><span class=c1>// 子进程执行任务</span>
</span><span id=__span-11-21><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pid</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-11-22><span class=w>    </span><span class=p>{</span>
</span><span id=__span-11-23><span class=w>        </span><span class=c1>// 关闭写端</span>
</span><span id=__span-11-24><span class=w>        </span><span class=n>close</span><span class=p>(</span><span class=n>pipe_arr</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-11-25><span class=w>        </span><span class=c1>// 任务代码</span>
</span><span id=__span-11-26><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-11-27><span class=w>    </span><span class=p>}</span>
</span><span id=__span-11-28>
</span><span id=__span-11-29><span class=w>    </span><span class=c1>// 父进程关闭读端</span>
</span><span id=__span-11-30><span class=w>    </span><span class=n>close</span><span class=p>(</span><span class=n>pipe_arr</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span><span id=__span-11-31>
</span><span id=__span-11-32><span class=w>    </span><span class=c1>// 使用已有的值构建Channel对象</span>
</span><span id=__span-11-33><span class=w>    </span><span class=n>Channel</span><span class=w> </span><span class=nf>ch</span><span class=p>(</span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=n>pipe_arr</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-11-34><span class=w>    </span><span class=c1>// 组织</span>
</span><span id=__span-11-35><span class=w>    </span><span class=n>channels</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>ch</span><span class=p>);</span>
</span><span id=__span-11-36><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>上面的代码中，关于错误处理的返回值，可以考虑使用C语言的枚举定义对应的错误码：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-12-1><span class=k>enum</span>
</span><span id=__span-12-2><span class=p>{</span>
</span><span id=__span-12-3><span class=w>    </span><span class=n>normal</span><span class=p>,</span>
</span><span id=__span-12-4><span class=w>    </span><span class=n>usageError</span><span class=p>,</span>
</span><span id=__span-12-5><span class=w>    </span><span class=n>pipeError</span><span class=p>,</span>
</span><span id=__span-12-6><span class=w>    </span><span class=n>forkError</span>
</span><span id=__span-12-7><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>所以，上面的代码也可以修改为：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-13-1><span class=c1>// 如果命令行参数个数不为两个，说明使用方法不对</span>
</span><span id=__span-13-2><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>argc</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>2</span><span class=p>)</span>
</span><span id=__span-13-3><span class=p>{</span>
</span><span id=__span-13-4><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;正确使用方法：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;子进程个数&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-13-5><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>usageError</span><span class=p>;</span>
</span><span id=__span-13-6><span class=p>}</span>
</span><span id=__span-13-7>
</span><span id=__span-13-8><span class=c1>// 根据指定个数创建子进程</span>
</span><span id=__span-13-9><span class=kt>int</span><span class=w> </span><span class=n>process_num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>atoi</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-13-10><span class=c1>// 用于组织Channel对象</span>
</span><span id=__span-13-11><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;</span><span class=w> </span><span class=n>channels</span><span class=p>;</span>
</span><span id=__span-13-12><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>process_num</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-13-13><span class=p>{</span>
</span><span id=__span-13-14><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-13-15>
</span><span id=__span-13-16><span class=w>    </span><span class=c1>// 错误处理</span>
</span><span id=__span-13-17><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret_p</span><span class=p>)</span>
</span><span id=__span-13-18><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>pipeError</span><span class=p>;</span>
</span><span id=__span-13-19>
</span><span id=__span-13-20><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-13-21>
</span><span id=__span-13-22><span class=w>    </span><span class=c1>// 错误处理</span>
</span><span id=__span-13-23><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pid</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-13-24><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>forkError</span><span class=p>;</span>
</span><span id=__span-13-25><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-13-26><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>另外，在C++ 11中，提供了<code>emplace_back</code>接口，可以直接在插入的过程中自动构建指定类的对象，所以可以使用<code>emplace_back</code>简化构造<code>Channel</code>对象并<code>push_back</code>到<code>vector</code>的过程，即：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-14-1><span class=c1>// 使用已有的值构建Channel对象</span>
</span><span id=__span-14-2><span class=c1>// Channel ch(pid, pipe_arr[1]);</span>
</span><span id=__span-14-3><span class=c1>// 组织</span>
</span><span id=__span-14-4><span class=c1>// channels.push_back(ch);</span>
</span><span id=__span-14-5>
</span><span id=__span-14-6><span class=c1>// 替换为</span>
</span><span id=__span-14-7><span class=n>channels</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=n>pipe_arr</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></code></pre></div></td></tr></table></div> <p>上面的代码仅仅是完成了一部分，因为子进程只是创建了但还没有真正执行任务，并且因为使用了<code>exit()</code>接口结束了进程且父进程没有回收，此时就会出现所有子进程僵尸状态，因此，可以考虑创建一个主任务，该主任务的特点是所有子进程都必须执行的任务，既然是所有子进程都要执行的任务，那么根据前面的设定：子进程需要从管道中读取数据，所以所有子进程都要执行的任务就是读取，为了保证一直在读，考虑使用死循环，所以子进程的主任务代码框架如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-15-1><span class=k>while</span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-15-2><span class=p>{</span>
</span><span id=__span-15-3><span class=w>    </span><span class=kt>ssize_t</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>read</span><span class=p>(...)</span>
</span><span id=__span-15-4><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>具体子进程读到什么，读多少内容在接下来设计派发任务时再具体叙述。当子进程进入<code>read()</code>函数时，只要管道中没有数据，那么根据管道的特点，此时读端就会阻塞直到管道有数据为止</p> <p>考虑接下来的问题：如果这个主任务并不是直接写在子进程的<code>if</code>语句中，而是单独作为一个函数，那么此时就必须知道当前子进程对应的管道的文件描述符，也就是说如果主任务抽象为一个函数，那么函数的参数就必须传递一个整数，所以为了简化这个步骤，可以在子进程读取任务之前，先将子进程的读取过程进行重定向，本次考虑重定向到标准输入，此时函数参数就可以不需要表示管道文件描述符的整数了，基本框架如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-16-1><span class=kt>void</span><span class=w> </span><span class=nf>work</span><span class=p>()</span>
</span><span id=__span-16-2><span class=p>{</span>
</span><span id=__span-16-3><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-16-4><span class=w>    </span><span class=p>{</span>
</span><span id=__span-16-5><span class=w>        </span><span class=c1>// 直接从标准输入读取</span>
</span><span id=__span-16-6><span class=w>        </span><span class=kt>ssize_t</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=p>...)</span>
</span><span id=__span-16-7><span class=w>    </span><span class=p>}</span>
</span><span id=__span-16-8><span class=p>}</span>
</span><span id=__span-16-9>
</span><span id=__span-16-10><span class=c1>// ...</span>
</span><span id=__span-16-11><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=o>*</span><span class=w> </span><span class=n>argv</span><span class=p>[])</span>
</span><span id=__span-16-12><span class=p>{</span>
</span><span id=__span-16-13><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-16-14><span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>process_num</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-16-15><span class=w>    </span><span class=p>{</span>
</span><span id=__span-16-16><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-16-17><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>pid</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-16-18><span class=w>        </span><span class=p>{</span>
</span><span id=__span-16-19><span class=w>            </span><span class=c1>// ...</span>
</span><span id=__span-16-20><span class=w>            </span><span class=n>dup2</span><span class=p>(</span><span class=n>pipe</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-16-21><span class=w>            </span><span class=n>work</span><span class=p>();</span>
</span><span id=__span-16-22><span class=w>        </span><span class=p>}</span>
</span><span id=__span-16-23><span class=w>    </span><span class=p>}</span>
</span><span id=__span-16-24><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-16-25><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>至此，创建进程池的基本框架已经形成，为了代码具有复用性，不应将创建进程池的代码直接放在<code>main</code>函数中，所以可以将其抽离到单独的函数中：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-17-1><span class=c1>// 初始化进程池</span>
</span><span id=__span-17-2><span class=kt>int</span><span class=w> </span><span class=nf>initProcessPool</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>process_num</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;</span><span class=w> </span><span class=o>&amp;</span><span class=n>channels</span><span class=p>)</span>
</span><span id=__span-17-3><span class=p>{</span>
</span><span id=__span-17-4><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>process_num</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-17-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-17-6><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>pipe_arr</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span><span id=__span-17-7><span class=w>        </span><span class=c1>// 创建管道</span>
</span><span id=__span-17-8><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>ret_p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pipe</span><span class=p>(</span><span class=n>pipe_arr</span><span class=p>);</span>
</span><span id=__span-17-9><span class=w>        </span><span class=c1>// 错误处理</span>
</span><span id=__span-17-10><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret_p</span><span class=p>)</span>
</span><span id=__span-17-11><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>pipeError</span><span class=p>;</span>
</span><span id=__span-17-12>
</span><span id=__span-17-13><span class=w>        </span><span class=c1>// 创建子进程</span>
</span><span id=__span-17-14><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fork</span><span class=p>();</span>
</span><span id=__span-17-15><span class=w>        </span><span class=c1>// 错误处理</span>
</span><span id=__span-17-16><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pid</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-17-17><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>forkError</span><span class=p>;</span>
</span><span id=__span-17-18>
</span><span id=__span-17-19><span class=w>        </span><span class=c1>// 子进程执行任务</span>
</span><span id=__span-17-20><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pid</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-17-21><span class=w>        </span><span class=p>{</span>
</span><span id=__span-17-22><span class=w>            </span><span class=c1>// 关闭写端</span>
</span><span id=__span-17-23><span class=w>            </span><span class=n>close</span><span class=p>(</span><span class=n>pipe_arr</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-17-24><span class=w>            </span><span class=n>dup2</span><span class=p>(</span><span class=n>pipe</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-17-25><span class=w>            </span><span class=c1>// 任务代码</span>
</span><span id=__span-17-26><span class=w>            </span><span class=n>work</span><span class=p>();</span>
</span><span id=__span-17-27><span class=w>            </span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-17-28><span class=w>        </span><span class=p>}</span>
</span><span id=__span-17-29>
</span><span id=__span-17-30><span class=w>        </span><span class=c1>// 父进程关闭读端</span>
</span><span id=__span-17-31><span class=w>        </span><span class=n>close</span><span class=p>(</span><span class=n>pipe_arr</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span><span id=__span-17-32>
</span><span id=__span-17-33><span class=w>        </span><span class=c1>// 使用已有的值构建Channel对象</span>
</span><span id=__span-17-34><span class=w>        </span><span class=n>Channel</span><span class=w> </span><span class=n>ch</span><span class=p>(</span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=n>pipe_arr</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-17-35><span class=w>        </span><span class=c1>// 组织</span>
</span><span id=__span-17-36><span class=w>        </span><span class=n>channels</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>ch</span><span class=p>);</span>
</span><span id=__span-17-37><span class=w>    </span><span class=p>}</span>
</span><span id=__span-17-38>
</span><span id=__span-17-39><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>normal</span><span class=p>;</span>
</span><span id=__span-17-40><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>最后，上面的代码还可以进行功能性的优化，如果未来不想让子进程只能执行<code>work()</code>，可以考虑使用函数指针（在C++中就是包装器）构成回调函数，因为上面的代码是基于C++的，所以接下来就直接使用包装器而不是函数指针，所以上面的整体代码可以修改为：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span>
<span class=normal>59</span>
<span class=normal>60</span>
<span class=normal>61</span>
<span class=normal>62</span>
<span class=normal>63</span>
<span class=normal>64</span>
<span class=normal>65</span>
<span class=normal>66</span>
<span class=normal>67</span>
<span class=normal>68</span>
<span class=normal>69</span>
<span class=normal>70</span>
<span class=normal>71</span>
<span class=normal>72</span>
<span class=normal>73</span>
<span class=normal>74</span>
<span class=normal>75</span>
<span class=normal>76</span>
<span class=normal>77</span>
<span class=normal>78</span>
<span class=normal>79</span>
<span class=normal>80</span>
<span class=normal>81</span>
<span class=normal>82</span>
<span class=normal>83</span>
<span class=normal>84</span>
<span class=normal>85</span>
<span class=normal>86</span>
<span class=normal>87</span>
<span class=normal>88</span>
<span class=normal>89</span>
<span class=normal>90</span>
<span class=normal>91</span>
<span class=normal>92</span>
<span class=normal>93</span>
<span class=normal>94</span>
<span class=normal>95</span>
<span class=normal>96</span>
<span class=normal>97</span>
<span class=normal>98</span>
<span class=normal>99</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-18-1><span class=k>enum</span>
</span><span id=__span-18-2><span class=p>{</span>
</span><span id=__span-18-3><span class=w>    </span><span class=n>normal</span><span class=p>,</span>
</span><span id=__span-18-4><span class=w>    </span><span class=n>usageError</span><span class=p>,</span>
</span><span id=__span-18-5><span class=w>    </span><span class=n>pipeError</span><span class=p>,</span>
</span><span id=__span-18-6><span class=w>    </span><span class=n>forkError</span><span class=p>,</span>
</span><span id=__span-18-7><span class=p>};</span>
</span><span id=__span-18-8>
</span><span id=__span-18-9><span class=k>using</span><span class=w> </span><span class=n>main_task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>function</span><span class=o>&lt;</span><span class=kt>void</span><span class=p>()</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-18-10>
</span><span id=__span-18-11><span class=c1>// 定义管道类</span>
</span><span id=__span-18-12><span class=k>class</span><span class=w> </span><span class=nc>Channel</span>
</span><span id=__span-18-13><span class=p>{</span>
</span><span id=__span-18-14><span class=k>public</span><span class=o>:</span>
</span><span id=__span-18-15><span class=w>    </span><span class=n>Channel</span><span class=p>(</span><span class=kt>pid_t</span><span class=w> </span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>wfd</span><span class=p>)</span>
</span><span id=__span-18-16><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=n>_pid</span><span class=p>(</span><span class=n>pid</span><span class=p>),</span><span class=w> </span><span class=n>_wfd</span><span class=p>(</span><span class=n>wfd</span><span class=p>)</span>
</span><span id=__span-18-17><span class=w>    </span><span class=p>{</span>
</span><span id=__span-18-18><span class=w>        </span><span class=c1>// 设置管道名称为：Channel-编号-写端文件描述符-对应的子进程</span>
</span><span id=__span-18-19><span class=w>        </span><span class=n>_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;Channel-&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>_count</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;-wfd&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>_wfd</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;-pid=&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>_pid</span><span class=p>);</span>
</span><span id=__span-18-20><span class=w>    </span><span class=p>}</span>
</span><span id=__span-18-21>
</span><span id=__span-18-22><span class=k>private</span><span class=o>:</span>
</span><span id=__span-18-23><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>_name</span><span class=p>;</span><span class=w> </span><span class=c1>// 管道名称</span>
</span><span id=__span-18-24><span class=w>    </span><span class=kt>pid_t</span><span class=w> </span><span class=n>_pid</span><span class=p>;</span><span class=w>        </span><span class=c1>// 管道对应的子进程</span>
</span><span id=__span-18-25><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>_wfd</span><span class=p>;</span><span class=w>          </span><span class=c1>// 管道的写端文件描述符</span>
</span><span id=__span-18-26><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>_count</span><span class=p>;</span><span class=w> </span><span class=c1>// 管道的编号</span>
</span><span id=__span-18-27><span class=p>};</span>
</span><span id=__span-18-28><span class=kt>int</span><span class=w> </span><span class=n>Channel</span><span class=o>::</span><span class=n>_count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-18-29>
</span><span id=__span-18-30><span class=kt>void</span><span class=w> </span><span class=nf>main_work</span><span class=p>()</span>
</span><span id=__span-18-31><span class=p>{</span>
</span><span id=__span-18-32><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-18-33><span class=w>    </span><span class=p>{</span>
</span><span id=__span-18-34><span class=w>        </span><span class=c1>// ssize_t n = read(0, ...);</span>
</span><span id=__span-18-35><span class=w>    </span><span class=p>}</span>
</span><span id=__span-18-36><span class=p>}</span>
</span><span id=__span-18-37>
</span><span id=__span-18-38><span class=c1>// 初始化进程池</span>
</span><span id=__span-18-39><span class=kt>int</span><span class=w> </span><span class=nf>initProcessPool</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>process_num</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;</span><span class=w> </span><span class=o>&amp;</span><span class=n>channels</span><span class=p>,</span><span class=w> </span><span class=n>main_task</span><span class=w> </span><span class=n>work</span><span class=p>)</span>
</span><span id=__span-18-40><span class=p>{</span>
</span><span id=__span-18-41><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>process_num</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-18-42><span class=w>    </span><span class=p>{</span>
</span><span id=__span-18-43><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>pipe_arr</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span><span id=__span-18-44><span class=w>        </span><span class=c1>// 创建管道</span>
</span><span id=__span-18-45><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>ret_p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pipe</span><span class=p>(</span><span class=n>pipe_arr</span><span class=p>);</span>
</span><span id=__span-18-46><span class=w>        </span><span class=c1>// 错误处理</span>
</span><span id=__span-18-47><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret_p</span><span class=p>)</span>
</span><span id=__span-18-48><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>pipeError</span><span class=p>;</span>
</span><span id=__span-18-49>
</span><span id=__span-18-50><span class=w>        </span><span class=c1>// 创建子进程</span>
</span><span id=__span-18-51><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fork</span><span class=p>();</span>
</span><span id=__span-18-52><span class=w>        </span><span class=c1>// 错误处理</span>
</span><span id=__span-18-53><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pid</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-18-54><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>forkError</span><span class=p>;</span>
</span><span id=__span-18-55>
</span><span id=__span-18-56><span class=w>        </span><span class=c1>// 子进程执行任务</span>
</span><span id=__span-18-57><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pid</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-18-58><span class=w>        </span><span class=p>{</span>
</span><span id=__span-18-59><span class=w>            </span><span class=c1>// 关闭写端</span>
</span><span id=__span-18-60><span class=w>            </span><span class=n>close</span><span class=p>(</span><span class=n>pipe_arr</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-18-61><span class=w>            </span><span class=c1>// 重定向</span>
</span><span id=__span-18-62><span class=w>            </span><span class=n>dup2</span><span class=p>(</span><span class=n>pipe_arr</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-18-63><span class=w>            </span><span class=c1>// 任务代码</span>
</span><span id=__span-18-64><span class=w>            </span><span class=n>work</span><span class=p>();</span>
</span><span id=__span-18-65>
</span><span id=__span-18-66><span class=w>            </span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-18-67><span class=w>        </span><span class=p>}</span>
</span><span id=__span-18-68>
</span><span id=__span-18-69><span class=w>        </span><span class=c1>// 父进程关闭读端</span>
</span><span id=__span-18-70><span class=w>        </span><span class=n>close</span><span class=p>(</span><span class=n>pipe_arr</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span><span id=__span-18-71>
</span><span id=__span-18-72><span class=w>        </span><span class=c1>// 使用已有的值构建Channel对象</span>
</span><span id=__span-18-73><span class=w>        </span><span class=n>Channel</span><span class=w> </span><span class=n>ch</span><span class=p>(</span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=n>pipe_arr</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-18-74><span class=w>        </span><span class=c1>// 组织</span>
</span><span id=__span-18-75><span class=w>        </span><span class=n>channels</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>ch</span><span class=p>);</span>
</span><span id=__span-18-76><span class=w>    </span><span class=p>}</span>
</span><span id=__span-18-77>
</span><span id=__span-18-78><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>normal</span><span class=p>;</span>
</span><span id=__span-18-79><span class=p>}</span>
</span><span id=__span-18-80>
</span><span id=__span-18-81><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span><span id=__span-18-82><span class=p>{</span>
</span><span id=__span-18-83><span class=w>    </span><span class=c1>// 如果命令行参数个数不为两个，说明使用方法不对</span>
</span><span id=__span-18-84><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>argc</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>2</span><span class=p>)</span>
</span><span id=__span-18-85><span class=w>    </span><span class=p>{</span>
</span><span id=__span-18-86><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;正确使用方法：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;子进程个数&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-18-87><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>usageError</span><span class=p>;</span>
</span><span id=__span-18-88><span class=w>    </span><span class=p>}</span>
</span><span id=__span-18-89>
</span><span id=__span-18-90><span class=w>    </span><span class=c1>// 根据指定个数创建子进程</span>
</span><span id=__span-18-91><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>process_num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>atoi</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-18-92><span class=w>    </span><span class=c1>// 用于组织Channel对象</span>
</span><span id=__span-18-93><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;</span><span class=w> </span><span class=n>channels</span><span class=p>;</span>
</span><span id=__span-18-94><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>initProcessPool</span><span class=p>(</span><span class=n>process_num</span><span class=p>,</span><span class=w> </span><span class=n>channels</span><span class=p>,</span><span class=w> </span><span class=n>main_work</span><span class=p>);</span>
</span><span id=__span-18-95><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=p>)</span>
</span><span id=__span-18-96><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cerr</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-18-97>
</span><span id=__span-18-98><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-18-99><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>为了确保上面的代码没有问题，可以考虑使用下面的代码进行测试：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-19-1><span class=kt>void</span><span class=w> </span><span class=nf>Debug</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;</span><span class=w> </span><span class=o>&amp;</span><span class=n>channels</span><span class=p>)</span>
</span><span id=__span-19-2><span class=p>{</span>
</span><span id=__span-19-3><span class=w>    </span><span class=c1>// 查看已经创建好的进程以及对应的管道文件描述符</span>
</span><span id=__span-19-4><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>chn</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>channels</span><span class=p>)</span>
</span><span id=__span-19-5><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>chn</span><span class=p>.</span><span class=n>getName</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-19-6><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>注意上面的代码需要在<code>Channel</code>类中实现<code>getName()</code>函数：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-20-1><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=nf>getName</span><span class=p>()</span><span class=w> </span><span class=k>const</span>
</span><span id=__span-20-2><span class=p>{</span>
</span><span id=__span-20-3><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>_name</span><span class=p>;</span>
</span><span id=__span-20-4><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>为了保证子进程不会变为<a href=https://www.help-doc.top/Linux/process-state-priority/process-state-priority.html#_9>孤儿进程</a>，需要确保主进程不会提前结束，可以考虑使用<code>sleep()</code></p> </div> <h4 id=_9>父进程派发任务<a class=headerlink href=#_9 title="Permanent link">&para;</a></h4> <p><strong>创建任务</strong></p> <p>前面提到，在创建进程池时，子进程都需要执行一个主任务，但是子进程需要执行的子任务并没有确定，而是需要等待父进程进行分派，本次为了演示方便一共准备三个任务，并且三个任务只是简单的输出，不会涉及到具体的逻辑实现：</p> <div class="tabbed-set tabbed-alternate" data-tabs=1:3><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><input id=__tabbed_1_2 name=__tabbed_1 type=radio><input id=__tabbed_1_3 name=__tabbed_1 type=radio><div class=tabbed-labels><label for=__tabbed_1_1>下载任务</label><label for=__tabbed_1_2>上传任务</label><label for=__tabbed_1_3>修改任务</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-21-1><span class=c1>// 下载</span>
</span><span id=__span-21-2><span class=kt>void</span><span class=w> </span><span class=nf>download</span><span class=p>()</span>
</span><span id=__span-21-3><span class=p>{</span>
</span><span id=__span-21-4><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;下载任务-&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;执行的进程为：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>getpid</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-21-5><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-22-1><span class=c1>// 上传</span>
</span><span id=__span-22-2><span class=kt>void</span><span class=w> </span><span class=nf>upload</span><span class=p>()</span>
</span><span id=__span-22-3><span class=p>{</span>
</span><span id=__span-22-4><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;上传任务-&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;执行的进程为：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>getpid</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-22-5><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-23-1><span class=c1>// 修改</span>
</span><span id=__span-23-2><span class=kt>void</span><span class=w> </span><span class=nf>modify</span><span class=p>()</span>
</span><span id=__span-23-3><span class=p>{</span>
</span><span id=__span-23-4><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;移除任务-&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;执行的进程为：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>getpid</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-23-5><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>有了子任务，父进程就需要考虑如何管理任务，同样可以创建一个<code>TaskManager</code>的类，这个类负责向子进程分派任务。本次实现中为了让子进程更好得从管道中获取到指定的任务，考虑使用任务编号（本次设置为整型）表示每一个任务，即：0表示下载任务，1表示上传任务，2表示修改任务。为了实现这种映射关系，可以使用unordered_map或者map，因为主要是查询任务，所以使用unordered_map效率更高。</p> <p>接着需要考虑到一个问题，前面已经使用了<code>main_task</code>表示返回值为<code>void</code>、不接受参数的主任务函数，所以不可以再使用<code>using</code>对同类型的包装器进行声明。为了解决这种冲突，本次考虑创建一个新的文件，后缀为<code>.hpp</code></p> <p>例如下面的代码：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-24-1><span class=c1>// Task.hpp</span>
</span><span id=__span-24-2><span class=cp>#ifndef __TASK_HPP__</span>
</span><span id=__span-24-3><span class=cp>#define __TASK_HPP__</span>
</span><span id=__span-24-4>
</span><span id=__span-24-5><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-24-6><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;unordered_map&gt;</span>
</span><span id=__span-24-7><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;functional&gt;</span>
</span><span id=__span-24-8><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;unistd.h&gt;</span>
</span><span id=__span-24-9>
</span><span id=__span-24-10><span class=k>using</span><span class=w> </span><span class=n>sub_task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>function</span><span class=o>&lt;</span><span class=kt>void</span><span class=p>()</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-24-11>
</span><span id=__span-24-12><span class=c1>// 子任务</span>
</span><span id=__span-24-13><span class=c1>// 下载</span>
</span><span id=__span-24-14><span class=kt>void</span><span class=w> </span><span class=nf>download</span><span class=p>()</span>
</span><span id=__span-24-15><span class=p>{</span>
</span><span id=__span-24-16><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;下载任务-&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;执行的进程为：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>getpid</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-24-17><span class=p>}</span>
</span><span id=__span-24-18><span class=c1>// 上传</span>
</span><span id=__span-24-19><span class=kt>void</span><span class=w> </span><span class=nf>upload</span><span class=p>()</span>
</span><span id=__span-24-20><span class=p>{</span>
</span><span id=__span-24-21><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;上传任务-&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;执行的进程为：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>getpid</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-24-22><span class=p>}</span>
</span><span id=__span-24-23><span class=c1>// 修改</span>
</span><span id=__span-24-24><span class=kt>void</span><span class=w> </span><span class=nf>modify</span><span class=p>()</span>
</span><span id=__span-24-25><span class=p>{</span>
</span><span id=__span-24-26><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;移除任务-&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;执行的进程为：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>getpid</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-24-27><span class=p>}</span>
</span><span id=__span-24-28>
</span><span id=__span-24-29><span class=k>class</span><span class=w> </span><span class=nc>TaskManager</span>
</span><span id=__span-24-30><span class=p>{</span>
</span><span id=__span-24-31><span class=k>public</span><span class=o>:</span>
</span><span id=__span-24-32><span class=w>    </span><span class=n>TaskManager</span><span class=p>()</span>
</span><span id=__span-24-33><span class=w>    </span><span class=p>{</span>
</span><span id=__span-24-34><span class=w>        </span><span class=n>insertTask</span><span class=p>(</span><span class=n>download</span><span class=p>);</span>
</span><span id=__span-24-35><span class=w>        </span><span class=n>insertTask</span><span class=p>(</span><span class=n>upload</span><span class=p>);</span>
</span><span id=__span-24-36><span class=w>        </span><span class=n>insertTask</span><span class=p>(</span><span class=n>modify</span><span class=p>);</span>
</span><span id=__span-24-37><span class=w>    </span><span class=p>}</span>
</span><span id=__span-24-38>
</span><span id=__span-24-39><span class=w>    </span><span class=c1>// 添加任务和编号的映射</span>
</span><span id=__span-24-40><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>insertTask</span><span class=p>(</span><span class=n>sub_task</span><span class=w> </span><span class=n>sub</span><span class=p>)</span>
</span><span id=__span-24-41><span class=w>    </span><span class=p>{</span>
</span><span id=__span-24-42><span class=w>        </span><span class=n>task_count</span><span class=p>[</span><span class=n>_number</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sub</span><span class=p>;</span>
</span><span id=__span-24-43><span class=w>    </span><span class=p>}</span>
</span><span id=__span-24-44>
</span><span id=__span-24-45><span class=k>private</span><span class=o>:</span>
</span><span id=__span-24-46><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>_number</span><span class=p>;</span>
</span><span id=__span-24-47><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unordered_map</span><span class=o>&lt;</span><span class=kt>int</span><span class=p>,</span><span class=w> </span><span class=n>sub_task</span><span class=o>&gt;</span><span class=w> </span><span class=n>task_count</span><span class=p>;</span>
</span><span id=__span-24-48><span class=p>};</span>
</span><span id=__span-24-49><span class=kt>int</span><span class=w> </span><span class=n>TaskManager</span><span class=o>::</span><span class=n>_number</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-24-50>
</span><span id=__span-24-51><span class=cp>#endif</span>
</span></code></pre></div></td></tr></table></div> <p>在上面的代码中，使用宏定义确保头文件不会被重复包含：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-25-1><span class=cp>#ifndef __文件名_后缀名__</span>
</span><span id=__span-25-2><span class=cp>#define __文件名_后缀名__</span>
</span><span id=__span-25-3>
</span><span id=__span-25-4><span class=c1>// 定义和实现</span>
</span><span id=__span-25-5>
</span><span id=__span-25-6><span class=cp>#endif</span>
</span></code></pre></div></td></tr></table></div> <p>在<code>TaskManager</code>类中，通过成员方法<code>insertTask</code>在构造函数执行时将全局域中的三个子任务插入到哈希表并建立任务和编号映射，这里需要注意，此处的包装器包装了返回值为<code>void</code>、没有参数的函数，如果三个子任务为<code>TaskManager</code>类的成员函数，那么尽管显式情况下的函数返回值为<code>void</code>、没有参数，也无法插入到<code>task_count</code>中，因为成员函数含有隐藏的参数<code>this</code>，所以本次为了方便，将子任务放在全局作用域</p> <p><strong>分派任务</strong></p> <p>上面的步骤只是完成了任务的创建，接着就需要考虑父进程如何派发这三个任务，分派任务给子进程的方式有很多种，本次主要考虑轮询分派给每一个子进程，所谓轮询分派，就是一个接着一个、循环分派</p> <p>为了实现分派，父进程首先必须要从<code>TaskManager</code>中获取到任务编号并写进管道，否则子进程无法拿到任务，所以需要在<code>TaskManager</code>中添加获取编号的方法。这里获取任务编号的方式有很多种，也可以考虑使用轮询的方式获取编号，本次考虑使用随机数，为了简便，考虑使用C语言中的随机数获取方式：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-26-1><span class=c1>// 获取任务编号</span>
</span><span id=__span-26-2><span class=kt>int</span><span class=w> </span><span class=nf>getTaskNumber</span><span class=p>()</span>
</span><span id=__span-26-3><span class=p>{</span>
</span><span id=__span-26-4><span class=w>    </span><span class=c1>// 任务编号范围[0, _number]</span>
</span><span id=__span-26-5><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>rand</span><span class=p>()</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>_number</span><span class=p>;</span>
</span><span id=__span-26-6><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>接着就是在<code>TaskManager</code>添加根据指定任务编号执行任务的函数：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-27-1><span class=c1>// TaskManager类中</span>
</span><span id=__span-27-2><span class=c1>// 执行任务</span>
</span><span id=__span-27-3><span class=kt>void</span><span class=w> </span><span class=nf>executeTask</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>number</span><span class=p>)</span><span class=w> </span><span class=k>const</span>
</span><span id=__span-27-4><span class=p>{</span>
</span><span id=__span-27-5><span class=w>    </span><span class=c1>// 先判断任务是否存在于哈希表中</span>
</span><span id=__span-27-6><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>task_count</span><span class=p>.</span><span class=n>count</span><span class=p>(</span><span class=n>number</span><span class=p>))</span>
</span><span id=__span-27-7><span class=w>    </span><span class=p>{</span>
</span><span id=__span-27-8><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;不存在编号为：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>number</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;的任务&quot;</span><span class=p>;</span>
</span><span id=__span-27-9><span class=w>        </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-27-10><span class=w>    </span><span class=p>}</span>
</span><span id=__span-27-11>
</span><span id=__span-27-12><span class=w>    </span><span class=n>task_count</span><span class=p>[</span><span class=n>number</span><span class=p>]();</span>
</span><span id=__span-27-13><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>有了获取任务编号和根据任务编号执行的函数后，就需要父进程将获取到的任务编号写入管道，再由子进程从管道（已重定向为标准输入）中读取任务，所以需要在<code>Channel</code>类中添加相关的函数，同时为了便于在其他位置调用<code>TaskManager</code>类中的方法，在<code>Task.hpp</code>中创建一个<code>TaskManager</code>类对象：</p> <div class="tabbed-set tabbed-alternate" data-tabs=2:2><input checked=checked id=__tabbed_2_1 name=__tabbed_2 type=radio><input id=__tabbed_2_2 name=__tabbed_2 type=radio><div class=tabbed-labels><label for=__tabbed_2_1><code>Task.hpp</code>中</label><label for=__tabbed_2_2><code>Channel类中</code></label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-28-1><span class=c1>// Task.hpp</span>
</span><span id=__span-28-2><span class=c1>// 创建TaskManager类对象</span>
</span><span id=__span-28-3><span class=n>TaskManager</span><span class=w> </span><span class=n>tmg</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-29-1><span class=c1>// Channel类</span>
</span><span id=__span-29-2><span class=kt>void</span><span class=w> </span><span class=nf>sendTask</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>task_num</span><span class=p>)</span>
</span><span id=__span-29-3><span class=p>{</span>
</span><span id=__span-29-4><span class=w>    </span><span class=c1>// 向管道中写入任务编号</span>
</span><span id=__span-29-5><span class=w>    </span><span class=n>write</span><span class=p>(</span><span class=n>_wfd</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>task_num</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=kt>int</span><span class=p>));</span>
</span><span id=__span-29-6><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>上面的步骤只是编写了父进程发送任务的接口，并没有真正发送任务，所以接下来就是发送任务的逻辑，同样，为了保证复用性，直接将逻辑抽离放在单独的函数中：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-30-1><span class=c1>// 分派任务</span>
</span><span id=__span-30-2><span class=kt>void</span><span class=w> </span><span class=nf>dispatchTask</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;</span><span class=w> </span><span class=o>&amp;</span><span class=n>channels</span><span class=p>)</span>
</span><span id=__span-30-3><span class=p>{</span>
</span><span id=__span-30-4><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>child</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-30-5><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-30-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-30-7><span class=w>        </span><span class=c1>// 获取到任务编号</span>
</span><span id=__span-30-8><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>task_num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tmg</span><span class=p>.</span><span class=n>getTaskNumber</span><span class=p>();</span>
</span><span id=__span-30-9>
</span><span id=__span-30-10><span class=w>        </span><span class=c1>// 父进程轮询发送任务</span>
</span><span id=__span-30-11><span class=w>        </span><span class=n>Channel</span><span class=w> </span><span class=o>&amp;</span><span class=n>chn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>channels</span><span class=p>[</span><span class=n>child</span><span class=o>++</span><span class=p>];</span>
</span><span id=__span-30-12><span class=w>        </span><span class=n>child</span><span class=w> </span><span class=o>%=</span><span class=w> </span><span class=kt>int</span><span class=p>(</span><span class=n>channels</span><span class=p>.</span><span class=n>size</span><span class=p>());</span>
</span><span id=__span-30-13>
</span><span id=__span-30-14><span class=w>        </span><span class=n>chn</span><span class=p>.</span><span class=n>sendTask</span><span class=p>(</span><span class=n>task_num</span><span class=p>);</span>
</span><span id=__span-30-15><span class=w>    </span><span class=p>}</span>
</span><span id=__span-30-16><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>父进程发送任务后，子进程的主任务就可以开始进行读取，所以主任务修改为：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-31-1><span class=c1>// 主任务</span>
</span><span id=__span-31-2><span class=kt>void</span><span class=w> </span><span class=nf>main_work</span><span class=p>()</span>
</span><span id=__span-31-3><span class=p>{</span>
</span><span id=__span-31-4><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-31-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-31-6><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>task_num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-31-7><span class=w>        </span><span class=kt>ssize_t</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>task_num</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=kt>int</span><span class=p>));</span>
</span><span id=__span-31-8>
</span><span id=__span-31-9><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=kt>int</span><span class=p>))</span><span class=w> </span><span class=c1>// 读取正常，执行任务</span>
</span><span id=__span-31-10><span class=w>            </span><span class=n>tmg</span><span class=p>.</span><span class=n>executeTask</span><span class=p>(</span><span class=n>task_num</span><span class=p>);</span>
</span><span id=__span-31-11><span class=w>    </span><span class=p>}</span>
</span><span id=__span-31-12><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h4 id=_10>销毁进程池<a class=headerlink href=#_10 title="Permanent link">&para;</a></h4> <p>在前面提到，如果管道关闭，那么读端就会读取到文件结尾，即读取到的数据长度为0，所以可以利用这个特点结束子进程的任务，将进程池中所有的管道关闭再回收子进程就可以完成进程池的销毁，具体步骤如下：</p> <ol> <li>父进程关闭管道</li> <li>父进程回收子进程</li> </ol> <p><strong>父进程关闭管道</strong></p> <p>父进程想要关闭管道就需要关闭对应的写端，在<code>Channel</code>类中存在<code>_wfd</code>属性，利用该属性即可关闭对应管道的写端，即：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-32-1><span class=kt>void</span><span class=w> </span><span class=nf>closeChannel</span><span class=p>()</span>
</span><span id=__span-32-2><span class=p>{</span>
</span><span id=__span-32-3><span class=w>    </span><span class=c1>// 父进程关闭管道写端</span>
</span><span id=__span-32-4><span class=w>    </span><span class=n>close</span><span class=p>(</span><span class=n>_wfd</span><span class=p>);</span>
</span><span id=__span-32-5><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>接着父进程通过管道对象数组结构依次关闭管道，即：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-33-1><span class=c1>// 销毁进程池</span>
</span><span id=__span-33-2><span class=kt>void</span><span class=w> </span><span class=nf>closeProcessPool</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;</span><span class=w> </span><span class=o>&amp;</span><span class=n>channels</span><span class=p>)</span>
</span><span id=__span-33-3><span class=p>{</span>
</span><span id=__span-33-4><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>chn</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>channels</span><span class=p>)</span>
</span><span id=__span-33-5><span class=w>        </span><span class=n>chn</span><span class=p>.</span><span class=n>closeChannel</span><span class=p>();</span>
</span><span id=__span-33-6><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p><strong>父进程回收子进程</strong></p> <p>在关闭所有管道后，即可关闭所有依次回收所有子进程，在<code>Channel</code>类中存储了进程的<code>pid</code>，所以可以通过在<code>Channel</code>类中实现获取<code>pid</code>的接口：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-34-1><span class=kt>pid_t</span><span class=w> </span><span class=nf>getPid</span><span class=p>()</span><span class=w> </span><span class=k>const</span>
</span><span id=__span-34-2><span class=p>{</span>
</span><span id=__span-34-3><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>_pid</span><span class=p>;</span>
</span><span id=__span-34-4><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>在销毁进程池的函数中插入回收子进程的逻辑：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-35-1><span class=c1>// 销毁进程池</span>
</span><span id=__span-35-2><span class=kt>void</span><span class=w> </span><span class=nf>closeProcessPool</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;</span><span class=w> </span><span class=o>&amp;</span><span class=n>channels</span><span class=p>)</span>
</span><span id=__span-35-3><span class=p>{</span>
</span><span id=__span-35-4><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-35-5>
</span><span id=__span-35-6><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>chn</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>channels</span><span class=p>)</span>
</span><span id=__span-35-7><span class=w>    </span><span class=p>{</span>
</span><span id=__span-35-8><span class=w>        </span><span class=kt>pid_t</span><span class=w> </span><span class=n>rid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>waitpid</span><span class=p>(</span><span class=n>chn</span><span class=p>.</span><span class=n>getPid</span><span class=p>(),</span><span class=w> </span><span class=nb>NULL</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-35-9><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rid</span><span class=p>)</span>
</span><span id=__span-35-10><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;已回收进程：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>rid</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-35-11><span class=w>    </span><span class=p>}</span>
</span><span id=__span-35-12><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>最后，当父进程关闭写端后，子进程从管道中读取到的内容长度为0，所以可以通过判断<code>read()</code>接口返回值是否为0判断是否退出主任务：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-36-1><span class=c1>// 主任务</span>
</span><span id=__span-36-2><span class=kt>void</span><span class=w> </span><span class=nf>main_work</span><span class=p>()</span>
</span><span id=__span-36-3><span class=p>{</span>
</span><span id=__span-36-4><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-36-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-36-6><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>task_num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-36-7><span class=w>        </span><span class=kt>ssize_t</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>task_num</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=kt>int</span><span class=p>));</span>
</span><span id=__span-36-8>
</span><span id=__span-36-9><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=kt>int</span><span class=p>))</span><span class=w> </span><span class=c1>// 读取正常，执行任务</span>
</span><span id=__span-36-10><span class=w>            </span><span class=n>tmg</span><span class=p>.</span><span class=n>executeTask</span><span class=p>(</span><span class=n>task_num</span><span class=p>);</span>
</span><span id=__span-36-11><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>n</span><span class=p>)</span><span class=w> </span><span class=c1>// 读取到0，说明父进程关闭写端，退出主任务</span>
</span><span id=__span-36-12><span class=w>            </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-36-13><span class=w>    </span><span class=p>}</span>
</span><span id=__span-36-14><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h4 id=_11>细节优化<a class=headerlink href=#_11 title="Permanent link">&para;</a></h4> <p>上面的代码中存在一个比较深层的bug，如果按照上面的销毁进程池代码写法不会暴露出问题，但是如果将该代码修改为如下代码就会出现无法回收到子进程导致父进程一直等待：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-37-1><span class=c1>// 销毁进程池——版本2</span>
</span><span id=__span-37-2><span class=kt>void</span><span class=w> </span><span class=nf>closeProcessPool</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;</span><span class=w> </span><span class=o>&amp;</span><span class=n>channels</span><span class=p>)</span>
</span><span id=__span-37-3><span class=p>{</span>
</span><span id=__span-37-4><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>chn</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>channels</span><span class=p>)</span>
</span><span id=__span-37-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-37-6><span class=w>        </span><span class=n>chn</span><span class=p>.</span><span class=n>closeChannel</span><span class=p>();</span>
</span><span id=__span-37-7><span class=w>        </span><span class=kt>pid_t</span><span class=w> </span><span class=n>rid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>waitpid</span><span class=p>(</span><span class=n>chn</span><span class=p>.</span><span class=n>getPid</span><span class=p>(),</span><span class=w> </span><span class=nb>NULL</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-37-8><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rid</span><span class=p>)</span>
</span><span id=__span-37-9><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;已回收进程：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>rid</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-37-10><span class=w>    </span><span class=p>}</span>
</span><span id=__span-37-11><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>版本2的代码和版本1的代码的区别就在于版本2只使用了一个<code>for</code>循环同时完成关闭管道和回收子进程，版本1使用了两个<code>for</code>循环分别进行关闭管道和回收子进程</p> <p>使用版本2的代码后为了可以看到运行效果，考虑父进程派发10次任务后不再派发任务，结果如下：</p> <p><a class=glightbox href="1. 进程间通信介绍与匿名管道.assets\Snipaste_2024-12-28_21-11-34.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="1. 进程间通信介绍与匿名管道.assets\Snipaste_2024-12-28_21-11-34.png"></a></p> <p>之所以会出现这个问题，本质就是因为在创建进程池时，如果只有一个父进程和一个子进程那么子进程拷贝父进程的文件描述符表时只会有两个值，一个表示写，一个表示读，父进程关闭读端，子进程关闭写端，如下图所示：</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>注意，下面所有图中文件描述符表的数字都是下标，对应的真正下标为蓝色文字，为了更容易理解，将下标直接作为填充值，所以下标顺序错乱</p> </div> <p><a class=glightbox href="1. 进程间通信介绍与匿名管道.assets\Snipaste_2024-12-28_21-20-05.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="1. 进程间通信介绍与匿名管道.assets\Snipaste_2024-12-28_21-20-05.png"></a></p> <p>但是如果增加到两个子进程，那么此时父进程又会开辟一个新的管道数组存储管道读端和写端，子进程也会拷贝对应的值，如下图所示：</p> <p><a class=glightbox href="1. 进程间通信介绍与匿名管道.assets\Snipaste_2024-12-28_21-27-33.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="1. 进程间通信介绍与匿名管道.assets\Snipaste_2024-12-28_21-27-33.png"></a></p> <p>从上图可以看出，当同一个父进程创建第二个子进程后，第二个子进程也会保留一开始的4号端口</p> <p>为了便于观察，将两幅图合并为一副图：</p> <p><a class=glightbox href="1. 进程间通信介绍与匿名管道.assets\Snipaste_2024-12-28_21-35-53.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="1. 进程间通信介绍与匿名管道.assets\Snipaste_2024-12-28_21-35-53.png"></a></p> <p>可以看到，不但有父进程的4号指向第一个进程的管道写端，第二次拷贝文件描述符表的子进程也有4号文件描述符指向第一个进程的管道写端，问题就在这里，按照上面代码销毁进程池的逻辑，先关闭管道，接着就回收子进程，但是根据上面的图可以看到，第一次关闭管道时父进程只会关闭自己的文件描述符表中的4号，但是因为第二个子进程的文件描述符表的4号还指向第一个进程的管道写端，所以导致第一个进程认为自己还应该有数据而不会退出主任务，从而导致<code>waitpid()</code>接口一直处于等待状态，最后展现的就是开始的结果图。根据上面的原理依次类推，如果再创建一个进程，那么第一个子进程的管道写端就会有一个父进程和两个子进程共同指向，第二个进程的管道写端就会有一个父进程和一个子进程共同指向，以此类推，如果有<span class=arithmatex>\(n\)</span>个子进程，那么第一个子进程会有<span class=arithmatex>\(n\)</span>个进程（包括父进程在内）指向其管道写端，第二个子进程就会有<span class=arithmatex>\(n-1\)</span>个进程（包括父进程在内）执行其管道写端</p> <p>解决这个问题的方法有两种：</p> <ol> <li>从最后一个子进程（管理管道的数组结构的最后一个元素）开始关闭</li> <li>在创建进程池时，子进程关闭所有拷贝的写端</li> </ol> <p>下面采取第二个方法解决，既然是所有拷贝过来的写端，那么管道结构一定保存了对应的写端文件描述符，所以只需要将其依次关闭即可：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-38-1><span class=c1>// 初始化进程池</span>
</span><span id=__span-38-2><span class=kt>int</span><span class=w> </span><span class=nf>initProcessPool</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>process_num</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::&lt;</span><span class=n>Channel</span><span class=o>&gt;</span><span class=w> </span><span class=o>&amp;</span><span class=n>channels</span><span class=p>,</span><span class=w> </span><span class=n>main_task</span><span class=w> </span><span class=n>work</span><span class=p>)</span>
</span><span id=__span-38-3><span class=p>{</span>
</span><span id=__span-38-4><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>process_num</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-38-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-38-6><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-38-7>
</span><span id=__span-38-8><span class=w>        </span><span class=c1>// 子进程执行任务</span>
</span><span id=__span-38-9><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pid</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-38-10><span class=w>        </span><span class=p>{</span>
</span><span id=__span-38-11><span class=w>            </span><span class=c1>// 关闭写端</span>
</span><span id=__span-38-12><span class=w>            </span><span class=n>close</span><span class=p>(</span><span class=n>pipe_arr</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-38-13><span class=w>            </span><span class=c1>// 关闭当前子进程拷贝过来的所有写端</span>
</span><span id=__span-38-14><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>ch</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>channels</span><span class=p>)</span>
</span><span id=__span-38-15><span class=w>                </span><span class=n>ch</span><span class=p>.</span><span class=n>closeChannel</span><span class=p>();</span>
</span><span id=__span-38-16>
</span><span id=__span-38-17><span class=w>            </span><span class=c1>// ...</span>
</span><span id=__span-38-18><span class=w>        </span><span class=p>}</span>
</span><span id=__span-38-19>
</span><span id=__span-38-20><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-38-21><span class=w>    </span><span class=p>}</span>
</span><span id=__span-38-22>
</span><span id=__span-38-23><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>normal</span><span class=p>;</span>
</span><span id=__span-38-24><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>再次编译运行可以看到问题已经解决：</p> <p><a class=glightbox href="1. 进程间通信介绍与匿名管道.assets\Snipaste_2024-12-28_21-49-38.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="1. 进程间通信介绍与匿名管道.assets\Snipaste_2024-12-28_21-49-38.png"></a></p> <h4 id=_12>面向过程转面向对象<a class=headerlink href=#_12 title="Permanent link">&para;</a></h4> <p>面向过程转面向对象本质就是将属于各类的方法和成员放到一个模版中，并使用对象去调用，下面根据上面的步骤，可以划分出下面的类：</p> <ol> <li>进程池类<code>ProcessPool</code>：包括进程池初始化、进程池销毁、主任务以及任务派发，放到<code>ProcessPool.hpp</code>文件下</li> <li>任务类<code>TaskManager</code>：已存在</li> <li>管道类<code>Channel</code>：已存在，但是放到<code>Channel.hpp</code>文件中</li> </ol> <p>最后，单独创建<code>Main.cc</code>文件存放<code>main</code>函数，整体代码如下：</p> <div class="tabbed-set tabbed-alternate" data-tabs=3:4><input checked=checked id=__tabbed_3_1 name=__tabbed_3 type=radio><input id=__tabbed_3_2 name=__tabbed_3 type=radio><input id=__tabbed_3_3 name=__tabbed_3 type=radio><input id=__tabbed_3_4 name=__tabbed_3 type=radio><div class=tabbed-labels><label for=__tabbed_3_1><code>ProcessPool.hpp</code></label><label for=__tabbed_3_2><code>Task.hpp</code></label><label for=__tabbed_3_3><code>Channel.hpp</code></label><label for=__tabbed_3_4><code>Main.cc</code></label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>  1</span>
<span class=normal>  2</span>
<span class=normal>  3</span>
<span class=normal>  4</span>
<span class=normal>  5</span>
<span class=normal>  6</span>
<span class=normal>  7</span>
<span class=normal>  8</span>
<span class=normal>  9</span>
<span class=normal> 10</span>
<span class=normal> 11</span>
<span class=normal> 12</span>
<span class=normal> 13</span>
<span class=normal> 14</span>
<span class=normal> 15</span>
<span class=normal> 16</span>
<span class=normal> 17</span>
<span class=normal> 18</span>
<span class=normal> 19</span>
<span class=normal> 20</span>
<span class=normal> 21</span>
<span class=normal> 22</span>
<span class=normal> 23</span>
<span class=normal> 24</span>
<span class=normal> 25</span>
<span class=normal> 26</span>
<span class=normal> 27</span>
<span class=normal> 28</span>
<span class=normal> 29</span>
<span class=normal> 30</span>
<span class=normal> 31</span>
<span class=normal> 32</span>
<span class=normal> 33</span>
<span class=normal> 34</span>
<span class=normal> 35</span>
<span class=normal> 36</span>
<span class=normal> 37</span>
<span class=normal> 38</span>
<span class=normal> 39</span>
<span class=normal> 40</span>
<span class=normal> 41</span>
<span class=normal> 42</span>
<span class=normal> 43</span>
<span class=normal> 44</span>
<span class=normal> 45</span>
<span class=normal> 46</span>
<span class=normal> 47</span>
<span class=normal> 48</span>
<span class=normal> 49</span>
<span class=normal> 50</span>
<span class=normal> 51</span>
<span class=normal> 52</span>
<span class=normal> 53</span>
<span class=normal> 54</span>
<span class=normal> 55</span>
<span class=normal> 56</span>
<span class=normal> 57</span>
<span class=normal> 58</span>
<span class=normal> 59</span>
<span class=normal> 60</span>
<span class=normal> 61</span>
<span class=normal> 62</span>
<span class=normal> 63</span>
<span class=normal> 64</span>
<span class=normal> 65</span>
<span class=normal> 66</span>
<span class=normal> 67</span>
<span class=normal> 68</span>
<span class=normal> 69</span>
<span class=normal> 70</span>
<span class=normal> 71</span>
<span class=normal> 72</span>
<span class=normal> 73</span>
<span class=normal> 74</span>
<span class=normal> 75</span>
<span class=normal> 76</span>
<span class=normal> 77</span>
<span class=normal> 78</span>
<span class=normal> 79</span>
<span class=normal> 80</span>
<span class=normal> 81</span>
<span class=normal> 82</span>
<span class=normal> 83</span>
<span class=normal> 84</span>
<span class=normal> 85</span>
<span class=normal> 86</span>
<span class=normal> 87</span>
<span class=normal> 88</span>
<span class=normal> 89</span>
<span class=normal> 90</span>
<span class=normal> 91</span>
<span class=normal> 92</span>
<span class=normal> 93</span>
<span class=normal> 94</span>
<span class=normal> 95</span>
<span class=normal> 96</span>
<span class=normal> 97</span>
<span class=normal> 98</span>
<span class=normal> 99</span>
<span class=normal>100</span>
<span class=normal>101</span>
<span class=normal>102</span>
<span class=normal>103</span>
<span class=normal>104</span>
<span class=normal>105</span>
<span class=normal>106</span>
<span class=normal>107</span>
<span class=normal>108</span>
<span class=normal>109</span>
<span class=normal>110</span>
<span class=normal>111</span>
<span class=normal>112</span>
<span class=normal>113</span>
<span class=normal>114</span>
<span class=normal>115</span>
<span class=normal>116</span>
<span class=normal>117</span>
<span class=normal>118</span>
<span class=normal>119</span>
<span class=normal>120</span>
<span class=normal>121</span>
<span class=normal>122</span>
<span class=normal>123</span>
<span class=normal>124</span>
<span class=normal>125</span>
<span class=normal>126</span>
<span class=normal>127</span>
<span class=normal>128</span>
<span class=normal>129</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-39-1><span class=cp>#ifndef __PROCESSPOOL_HPP__</span>
</span><span id=__span-39-2><span class=cp>#define __PROCESSPOOL_HPP__</span>
</span><span id=__span-39-3>
</span><span id=__span-39-4><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-39-5><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;vector&gt;</span>
</span><span id=__span-39-6><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;functional&gt;</span>
</span><span id=__span-39-7><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;unistd.h&gt;</span>
</span><span id=__span-39-8><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;sys/wait.h&quot;</span>
</span><span id=__span-39-9><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;Channel.hpp&quot;</span>
</span><span id=__span-39-10><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;Task.hpp&quot;</span>
</span><span id=__span-39-11>
</span><span id=__span-39-12><span class=k>enum</span>
</span><span id=__span-39-13><span class=p>{</span>
</span><span id=__span-39-14><span class=w>    </span><span class=n>normal</span><span class=p>,</span>
</span><span id=__span-39-15><span class=w>    </span><span class=n>usageError</span><span class=p>,</span>
</span><span id=__span-39-16><span class=w>    </span><span class=n>pipeError</span><span class=p>,</span>
</span><span id=__span-39-17><span class=w>    </span><span class=n>forkError</span><span class=p>,</span>
</span><span id=__span-39-18><span class=p>};</span>
</span><span id=__span-39-19>
</span><span id=__span-39-20><span class=k>using</span><span class=w> </span><span class=n>main_task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>function</span><span class=o>&lt;</span><span class=kt>void</span><span class=p>()</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-39-21>
</span><span id=__span-39-22><span class=c1>// 主任务</span>
</span><span id=__span-39-23><span class=kt>void</span><span class=w> </span><span class=nf>main_work</span><span class=p>()</span>
</span><span id=__span-39-24><span class=p>{</span>
</span><span id=__span-39-25><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-39-26><span class=w>    </span><span class=p>{</span>
</span><span id=__span-39-27><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>task_num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-39-28><span class=w>        </span><span class=kt>ssize_t</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>task_num</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=kt>int</span><span class=p>));</span>
</span><span id=__span-39-29>
</span><span id=__span-39-30><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=kt>int</span><span class=p>))</span><span class=w> </span><span class=c1>// 读取正常，执行任务</span>
</span><span id=__span-39-31><span class=w>            </span><span class=n>tmg</span><span class=p>.</span><span class=n>executeTask</span><span class=p>(</span><span class=n>task_num</span><span class=p>);</span>
</span><span id=__span-39-32><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>n</span><span class=p>)</span><span class=w> </span><span class=c1>// 读取到0，说明父进程关闭写端，退出主任务</span>
</span><span id=__span-39-33><span class=w>            </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-39-34><span class=w>    </span><span class=p>}</span>
</span><span id=__span-39-35><span class=p>}</span>
</span><span id=__span-39-36>
</span><span id=__span-39-37><span class=k>class</span><span class=w> </span><span class=nc>ProcessPool</span>
</span><span id=__span-39-38><span class=p>{</span>
</span><span id=__span-39-39><span class=k>public</span><span class=o>:</span>
</span><span id=__span-39-40><span class=w>    </span><span class=n>ProcessPool</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>pn</span><span class=p>,</span><span class=w> </span><span class=n>main_task</span><span class=w> </span><span class=n>mt</span><span class=p>)</span>
</span><span id=__span-39-41><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=n>process_num</span><span class=p>(</span><span class=n>pn</span><span class=p>),</span><span class=w> </span><span class=n>work</span><span class=p>(</span><span class=n>mt</span><span class=p>)</span>
</span><span id=__span-39-42><span class=w>    </span><span class=p>{</span>
</span><span id=__span-39-43><span class=w>    </span><span class=p>}</span>
</span><span id=__span-39-44>
</span><span id=__span-39-45><span class=w>    </span><span class=c1>// 初始化进程池</span>
</span><span id=__span-39-46><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>initProcessPool</span><span class=p>()</span>
</span><span id=__span-39-47><span class=w>    </span><span class=p>{</span>
</span><span id=__span-39-48><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>process_num</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-39-49><span class=w>        </span><span class=p>{</span>
</span><span id=__span-39-50><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>pipe_arr</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span><span id=__span-39-51><span class=w>            </span><span class=c1>// 创建管道</span>
</span><span id=__span-39-52><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>ret_p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pipe</span><span class=p>(</span><span class=n>pipe_arr</span><span class=p>);</span>
</span><span id=__span-39-53><span class=w>            </span><span class=c1>// 错误处理</span>
</span><span id=__span-39-54><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret_p</span><span class=p>)</span>
</span><span id=__span-39-55><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>pipeError</span><span class=p>;</span>
</span><span id=__span-39-56>
</span><span id=__span-39-57><span class=w>            </span><span class=c1>// 创建子进程</span>
</span><span id=__span-39-58><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fork</span><span class=p>();</span>
</span><span id=__span-39-59><span class=w>            </span><span class=c1>// 错误处理</span>
</span><span id=__span-39-60><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pid</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-39-61><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>forkError</span><span class=p>;</span>
</span><span id=__span-39-62>
</span><span id=__span-39-63><span class=w>            </span><span class=c1>// 子进程执行任务</span>
</span><span id=__span-39-64><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pid</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-39-65><span class=w>            </span><span class=p>{</span>
</span><span id=__span-39-66><span class=w>                </span><span class=c1>// 关闭写端</span>
</span><span id=__span-39-67><span class=w>                </span><span class=n>close</span><span class=p>(</span><span class=n>pipe_arr</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-39-68><span class=w>                </span><span class=c1>// 关闭当前子进程所有的写端</span>
</span><span id=__span-39-69><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>ch</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>channels</span><span class=p>)</span>
</span><span id=__span-39-70><span class=w>                    </span><span class=n>ch</span><span class=p>.</span><span class=n>closeChannel</span><span class=p>();</span>
</span><span id=__span-39-71><span class=w>                </span><span class=c1>// 重定向</span>
</span><span id=__span-39-72><span class=w>                </span><span class=n>dup2</span><span class=p>(</span><span class=n>pipe_arr</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-39-73><span class=w>                </span><span class=c1>// 任务代码</span>
</span><span id=__span-39-74><span class=w>                </span><span class=n>work</span><span class=p>();</span>
</span><span id=__span-39-75>
</span><span id=__span-39-76><span class=w>                </span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-39-77><span class=w>            </span><span class=p>}</span>
</span><span id=__span-39-78>
</span><span id=__span-39-79><span class=w>            </span><span class=c1>// 父进程关闭读端</span>
</span><span id=__span-39-80><span class=w>            </span><span class=n>close</span><span class=p>(</span><span class=n>pipe_arr</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span><span id=__span-39-81>
</span><span id=__span-39-82><span class=w>            </span><span class=c1>// 使用已有的值构建Channel对象</span>
</span><span id=__span-39-83><span class=w>            </span><span class=n>Channel</span><span class=w> </span><span class=nf>ch</span><span class=p>(</span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=n>pipe_arr</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-39-84><span class=w>            </span><span class=c1>// 组织</span>
</span><span id=__span-39-85><span class=w>            </span><span class=n>channels</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>ch</span><span class=p>);</span>
</span><span id=__span-39-86><span class=w>        </span><span class=p>}</span>
</span><span id=__span-39-87>
</span><span id=__span-39-88><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>normal</span><span class=p>;</span>
</span><span id=__span-39-89><span class=w>    </span><span class=p>}</span>
</span><span id=__span-39-90>
</span><span id=__span-39-91><span class=w>    </span><span class=c1>// 分派任务</span>
</span><span id=__span-39-92><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>dispatchTask</span><span class=p>()</span>
</span><span id=__span-39-93><span class=w>    </span><span class=p>{</span>
</span><span id=__span-39-94><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>child</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-39-95><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>count_task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span>
</span><span id=__span-39-96><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>count_task</span><span class=o>--</span><span class=p>)</span>
</span><span id=__span-39-97><span class=w>        </span><span class=p>{</span>
</span><span id=__span-39-98><span class=w>            </span><span class=c1>// 获取到任务编号</span>
</span><span id=__span-39-99><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>task_num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tmg</span><span class=p>.</span><span class=n>getTaskNumber</span><span class=p>();</span>
</span><span id=__span-39-100>
</span><span id=__span-39-101><span class=w>            </span><span class=c1>// 父进程轮询发送任务</span>
</span><span id=__span-39-102><span class=w>            </span><span class=n>Channel</span><span class=w> </span><span class=o>&amp;</span><span class=n>chn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>channels</span><span class=p>[</span><span class=n>child</span><span class=o>++</span><span class=p>];</span>
</span><span id=__span-39-103><span class=w>            </span><span class=n>child</span><span class=w> </span><span class=o>%=</span><span class=w> </span><span class=kt>int</span><span class=p>(</span><span class=n>channels</span><span class=p>.</span><span class=n>size</span><span class=p>());</span>
</span><span id=__span-39-104>
</span><span id=__span-39-105><span class=w>            </span><span class=n>chn</span><span class=p>.</span><span class=n>sendTask</span><span class=p>(</span><span class=n>task_num</span><span class=p>);</span>
</span><span id=__span-39-106>
</span><span id=__span-39-107><span class=w>            </span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-39-108><span class=w>        </span><span class=p>}</span>
</span><span id=__span-39-109><span class=w>    </span><span class=p>}</span>
</span><span id=__span-39-110>
</span><span id=__span-39-111><span class=w>    </span><span class=c1>// 销毁进程池——版本2</span>
</span><span id=__span-39-112><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>closeProcessPool</span><span class=p>()</span>
</span><span id=__span-39-113><span class=w>    </span><span class=p>{</span>
</span><span id=__span-39-114><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>chn</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>channels</span><span class=p>)</span>
</span><span id=__span-39-115><span class=w>        </span><span class=p>{</span>
</span><span id=__span-39-116><span class=w>            </span><span class=n>chn</span><span class=p>.</span><span class=n>closeChannel</span><span class=p>();</span>
</span><span id=__span-39-117><span class=w>            </span><span class=kt>pid_t</span><span class=w> </span><span class=n>rid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>waitpid</span><span class=p>(</span><span class=n>chn</span><span class=p>.</span><span class=n>getPid</span><span class=p>(),</span><span class=w> </span><span class=nb>NULL</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-39-118><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rid</span><span class=p>)</span>
</span><span id=__span-39-119><span class=w>                </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;已回收进程：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>rid</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-39-120><span class=w>        </span><span class=p>}</span>
</span><span id=__span-39-121><span class=w>    </span><span class=p>}</span>
</span><span id=__span-39-122>
</span><span id=__span-39-123><span class=k>private</span><span class=o>:</span>
</span><span id=__span-39-124><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>process_num</span><span class=p>;</span><span class=w>               </span><span class=c1>// 子进程个数</span>
</span><span id=__span-39-125><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;</span><span class=w> </span><span class=n>channels</span><span class=p>;</span><span class=w> </span><span class=c1>// 管理管道数组</span>
</span><span id=__span-39-126><span class=w>    </span><span class=n>main_task</span><span class=w> </span><span class=n>work</span><span class=p>;</span><span class=w>                </span><span class=c1>// 主任务</span>
</span><span id=__span-39-127><span class=p>};</span>
</span><span id=__span-39-128>
</span><span id=__span-39-129><span class=cp>#endif</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span>
<span class=normal>59</span>
<span class=normal>60</span>
<span class=normal>61</span>
<span class=normal>62</span>
<span class=normal>63</span>
<span class=normal>64</span>
<span class=normal>65</span>
<span class=normal>66</span>
<span class=normal>67</span>
<span class=normal>68</span>
<span class=normal>69</span>
<span class=normal>70</span>
<span class=normal>71</span>
<span class=normal>72</span>
<span class=normal>73</span>
<span class=normal>74</span>
<span class=normal>75</span>
<span class=normal>76</span>
<span class=normal>77</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-40-1><span class=cp>#ifndef __TASK_HPP__</span>
</span><span id=__span-40-2><span class=cp>#define __TASK_HPP__</span>
</span><span id=__span-40-3>
</span><span id=__span-40-4><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-40-5><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;unordered_map&gt;</span>
</span><span id=__span-40-6><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;functional&gt;</span>
</span><span id=__span-40-7><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;cstdlib&gt;</span>
</span><span id=__span-40-8><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;ctime&gt;</span>
</span><span id=__span-40-9><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;unistd.h&gt;</span>
</span><span id=__span-40-10>
</span><span id=__span-40-11><span class=k>using</span><span class=w> </span><span class=n>sub_task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>function</span><span class=o>&lt;</span><span class=kt>void</span><span class=p>()</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-40-12>
</span><span id=__span-40-13><span class=c1>// 子任务</span>
</span><span id=__span-40-14><span class=c1>// 下载</span>
</span><span id=__span-40-15><span class=kt>void</span><span class=w> </span><span class=nf>download</span><span class=p>()</span>
</span><span id=__span-40-16><span class=p>{</span>
</span><span id=__span-40-17><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;下载任务-&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;执行的进程为：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>getpid</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-40-18><span class=p>}</span>
</span><span id=__span-40-19><span class=c1>// 上传</span>
</span><span id=__span-40-20><span class=kt>void</span><span class=w> </span><span class=nf>upload</span><span class=p>()</span>
</span><span id=__span-40-21><span class=p>{</span>
</span><span id=__span-40-22><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;上传任务-&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;执行的进程为：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>getpid</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-40-23><span class=p>}</span>
</span><span id=__span-40-24><span class=c1>// 修改</span>
</span><span id=__span-40-25><span class=kt>void</span><span class=w> </span><span class=nf>modify</span><span class=p>()</span>
</span><span id=__span-40-26><span class=p>{</span>
</span><span id=__span-40-27><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;移除任务-&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;执行的进程为：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>getpid</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-40-28><span class=p>}</span>
</span><span id=__span-40-29>
</span><span id=__span-40-30><span class=k>class</span><span class=w> </span><span class=nc>TaskManager</span>
</span><span id=__span-40-31><span class=p>{</span>
</span><span id=__span-40-32><span class=k>public</span><span class=o>:</span>
</span><span id=__span-40-33><span class=w>    </span><span class=n>TaskManager</span><span class=p>()</span>
</span><span id=__span-40-34><span class=w>    </span><span class=p>{</span>
</span><span id=__span-40-35><span class=w>        </span><span class=c1>// 随机数种子</span>
</span><span id=__span-40-36><span class=w>        </span><span class=n>srand</span><span class=p>(</span><span class=n>time</span><span class=p>(</span><span class=nb>NULL</span><span class=p>));</span>
</span><span id=__span-40-37><span class=w>        </span><span class=n>insertTask</span><span class=p>(</span><span class=n>download</span><span class=p>);</span>
</span><span id=__span-40-38><span class=w>        </span><span class=n>insertTask</span><span class=p>(</span><span class=n>upload</span><span class=p>);</span>
</span><span id=__span-40-39><span class=w>        </span><span class=n>insertTask</span><span class=p>(</span><span class=n>modify</span><span class=p>);</span>
</span><span id=__span-40-40><span class=w>    </span><span class=p>}</span>
</span><span id=__span-40-41>
</span><span id=__span-40-42><span class=w>    </span><span class=c1>// 添加任务和编号的映射</span>
</span><span id=__span-40-43><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>insertTask</span><span class=p>(</span><span class=n>sub_task</span><span class=w> </span><span class=n>sub</span><span class=p>)</span>
</span><span id=__span-40-44><span class=w>    </span><span class=p>{</span>
</span><span id=__span-40-45><span class=w>        </span><span class=n>task_count</span><span class=p>[</span><span class=n>_number</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sub</span><span class=p>;</span>
</span><span id=__span-40-46><span class=w>    </span><span class=p>}</span>
</span><span id=__span-40-47>
</span><span id=__span-40-48><span class=w>    </span><span class=c1>// 获取任务编号</span>
</span><span id=__span-40-49><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>getTaskNumber</span><span class=p>()</span>
</span><span id=__span-40-50><span class=w>    </span><span class=p>{</span>
</span><span id=__span-40-51><span class=w>        </span><span class=c1>// 任务编号范围[0, _number]</span>
</span><span id=__span-40-52><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>rand</span><span class=p>()</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>_number</span><span class=p>;</span>
</span><span id=__span-40-53><span class=w>    </span><span class=p>}</span>
</span><span id=__span-40-54>
</span><span id=__span-40-55><span class=w>    </span><span class=c1>// 执行任务</span>
</span><span id=__span-40-56><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>executeTask</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>number</span><span class=p>)</span>
</span><span id=__span-40-57><span class=w>    </span><span class=p>{</span>
</span><span id=__span-40-58><span class=w>        </span><span class=c1>// 先判断任务是否存在于哈希表中</span>
</span><span id=__span-40-59><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>task_count</span><span class=p>.</span><span class=n>count</span><span class=p>(</span><span class=n>number</span><span class=p>))</span>
</span><span id=__span-40-60><span class=w>        </span><span class=p>{</span>
</span><span id=__span-40-61><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;不存在编号为：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>number</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;的任务&quot;</span><span class=p>;</span>
</span><span id=__span-40-62><span class=w>            </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-40-63><span class=w>        </span><span class=p>}</span>
</span><span id=__span-40-64>
</span><span id=__span-40-65><span class=w>        </span><span class=n>task_count</span><span class=p>[</span><span class=n>number</span><span class=p>]();</span>
</span><span id=__span-40-66><span class=w>    </span><span class=p>}</span>
</span><span id=__span-40-67>
</span><span id=__span-40-68><span class=k>private</span><span class=o>:</span>
</span><span id=__span-40-69><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>_number</span><span class=p>;</span>
</span><span id=__span-40-70><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unordered_map</span><span class=o>&lt;</span><span class=kt>int</span><span class=p>,</span><span class=w> </span><span class=n>sub_task</span><span class=o>&gt;</span><span class=w> </span><span class=n>task_count</span><span class=p>;</span>
</span><span id=__span-40-71><span class=p>};</span>
</span><span id=__span-40-72><span class=kt>int</span><span class=w> </span><span class=n>TaskManager</span><span class=o>::</span><span class=n>_number</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-40-73>
</span><span id=__span-40-74><span class=c1>// 创建TaskManager类对象</span>
</span><span id=__span-40-75><span class=n>TaskManager</span><span class=w> </span><span class=n>tmg</span><span class=p>;</span>
</span><span id=__span-40-76>
</span><span id=__span-40-77><span class=cp>#endif</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-41-1><span class=cp>#ifndef __CHANNEL_HPP__</span>
</span><span id=__span-41-2><span class=cp>#define __CHANNEL_HPP__</span>
</span><span id=__span-41-3>
</span><span id=__span-41-4><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-41-5><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;string&gt;</span>
</span><span id=__span-41-6><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;unistd.h&gt;</span>
</span><span id=__span-41-7>
</span><span id=__span-41-8><span class=c1>// 定义管道类</span>
</span><span id=__span-41-9><span class=k>class</span><span class=w> </span><span class=nc>Channel</span>
</span><span id=__span-41-10><span class=p>{</span>
</span><span id=__span-41-11><span class=k>public</span><span class=o>:</span>
</span><span id=__span-41-12><span class=w>    </span><span class=n>Channel</span><span class=p>(</span><span class=kt>pid_t</span><span class=w> </span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>wfd</span><span class=p>)</span>
</span><span id=__span-41-13><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=n>_pid</span><span class=p>(</span><span class=n>pid</span><span class=p>),</span><span class=w> </span><span class=n>_wfd</span><span class=p>(</span><span class=n>wfd</span><span class=p>)</span>
</span><span id=__span-41-14><span class=w>    </span><span class=p>{</span>
</span><span id=__span-41-15><span class=w>        </span><span class=c1>// 设置管道名称为：Channel-编号-写端文件描述符-对应的子进程</span>
</span><span id=__span-41-16><span class=w>        </span><span class=n>_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;Channel-&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>_count</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;-wfd&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>_wfd</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;-pid=&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>_pid</span><span class=p>);</span>
</span><span id=__span-41-17><span class=w>    </span><span class=p>}</span>
</span><span id=__span-41-18>
</span><span id=__span-41-19><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>getName</span><span class=p>()</span><span class=w> </span><span class=k>const</span>
</span><span id=__span-41-20><span class=w>    </span><span class=p>{</span>
</span><span id=__span-41-21><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>_name</span><span class=p>;</span>
</span><span id=__span-41-22><span class=w>    </span><span class=p>}</span>
</span><span id=__span-41-23>
</span><span id=__span-41-24><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>sendTask</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>task_num</span><span class=p>)</span>
</span><span id=__span-41-25><span class=w>    </span><span class=p>{</span>
</span><span id=__span-41-26><span class=w>        </span><span class=n>write</span><span class=p>(</span><span class=n>_wfd</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>task_num</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=kt>int</span><span class=p>));</span>
</span><span id=__span-41-27><span class=w>    </span><span class=p>}</span>
</span><span id=__span-41-28>
</span><span id=__span-41-29><span class=w>    </span><span class=kt>pid_t</span><span class=w> </span><span class=n>getPid</span><span class=p>()</span><span class=w> </span><span class=k>const</span>
</span><span id=__span-41-30><span class=w>    </span><span class=p>{</span>
</span><span id=__span-41-31><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>_pid</span><span class=p>;</span>
</span><span id=__span-41-32><span class=w>    </span><span class=p>}</span>
</span><span id=__span-41-33>
</span><span id=__span-41-34><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>closeChannel</span><span class=p>()</span>
</span><span id=__span-41-35><span class=w>    </span><span class=p>{</span>
</span><span id=__span-41-36><span class=w>        </span><span class=c1>// 父进程关闭管道写端</span>
</span><span id=__span-41-37><span class=w>        </span><span class=n>close</span><span class=p>(</span><span class=n>_wfd</span><span class=p>);</span>
</span><span id=__span-41-38><span class=w>    </span><span class=p>}</span>
</span><span id=__span-41-39>
</span><span id=__span-41-40><span class=k>private</span><span class=o>:</span>
</span><span id=__span-41-41><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>_name</span><span class=p>;</span><span class=w> </span><span class=c1>// 管道名称</span>
</span><span id=__span-41-42><span class=w>    </span><span class=kt>pid_t</span><span class=w> </span><span class=n>_pid</span><span class=p>;</span><span class=w>        </span><span class=c1>// 管道对应的子进程</span>
</span><span id=__span-41-43><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>_wfd</span><span class=p>;</span><span class=w>          </span><span class=c1>// 管道的写端文件描述符</span>
</span><span id=__span-41-44><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>_count</span><span class=p>;</span><span class=w> </span><span class=c1>// 管道的编号</span>
</span><span id=__span-41-45><span class=p>};</span>
</span><span id=__span-41-46><span class=kt>int</span><span class=w> </span><span class=n>Channel</span><span class=o>::</span><span class=n>_count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-41-47>
</span><span id=__span-41-48><span class=cp>#endif</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-42-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-42-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;string&gt;</span>
</span><span id=__span-42-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;vector&gt;</span>
</span><span id=__span-42-4><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;functional&gt;</span>
</span><span id=__span-42-5><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;unistd.h&gt;</span>
</span><span id=__span-42-6><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;sys/wait.h&gt;</span>
</span><span id=__span-42-7><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;Task.hpp&quot;</span>
</span><span id=__span-42-8><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;Channel.hpp&quot;</span>
</span><span id=__span-42-9><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;ProcessPool.hpp&quot;</span>
</span><span id=__span-42-10>
</span><span id=__span-42-11><span class=kt>void</span><span class=w> </span><span class=nf>Debug</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;</span><span class=w> </span><span class=o>&amp;</span><span class=n>channels</span><span class=p>)</span>
</span><span id=__span-42-12><span class=p>{</span>
</span><span id=__span-42-13><span class=w>    </span><span class=c1>// 查看已经创建好的进程以及对应的管道文件描述符</span>
</span><span id=__span-42-14><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>chn</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>channels</span><span class=p>)</span>
</span><span id=__span-42-15><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>chn</span><span class=p>.</span><span class=n>getName</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-42-16><span class=p>}</span>
</span><span id=__span-42-17>
</span><span id=__span-42-18><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span><span id=__span-42-19><span class=p>{</span>
</span><span id=__span-42-20><span class=w>    </span><span class=c1>// 如果命令行参数个数不为两个，说明使用方法不对</span>
</span><span id=__span-42-21><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>argc</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>2</span><span class=p>)</span>
</span><span id=__span-42-22><span class=w>    </span><span class=p>{</span>
</span><span id=__span-42-23><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;正确使用方法：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;子进程个数&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-42-24><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>usageError</span><span class=p>;</span>
</span><span id=__span-42-25><span class=w>    </span><span class=p>}</span>
</span><span id=__span-42-26>
</span><span id=__span-42-27><span class=w>    </span><span class=c1>// 根据指定个数创建子进程</span>
</span><span id=__span-42-28><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>process_num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>atoi</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-42-29>
</span><span id=__span-42-30><span class=w>    </span><span class=c1>// 创建进程池对象</span>
</span><span id=__span-42-31><span class=w>    </span><span class=n>ProcessPool</span><span class=w> </span><span class=n>pp</span><span class=p>(</span><span class=n>process_num</span><span class=p>,</span><span class=w> </span><span class=n>main_work</span><span class=p>);</span>
</span><span id=__span-42-32>
</span><span id=__span-42-33><span class=w>    </span><span class=c1>// 1. 创建进程池</span>
</span><span id=__span-42-34><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pp</span><span class=p>.</span><span class=n>initProcessPool</span><span class=p>();</span>
</span><span id=__span-42-35><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=p>)</span>
</span><span id=__span-42-36><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cerr</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-42-37>
</span><span id=__span-42-38><span class=w>    </span><span class=c1>// Debug(channels);</span>
</span><span id=__span-42-39>
</span><span id=__span-42-40><span class=w>    </span><span class=c1>// sleep(20);</span>
</span><span id=__span-42-41>
</span><span id=__span-42-42><span class=w>    </span><span class=c1>// 2. 父进程分派任务</span>
</span><span id=__span-42-43><span class=w>    </span><span class=n>pp</span><span class=p>.</span><span class=n>dispatchTask</span><span class=p>();</span>
</span><span id=__span-42-44>
</span><span id=__span-42-45><span class=w>    </span><span class=c1>// 3. 父进程关闭进程池</span>
</span><span id=__span-42-46><span class=w>    </span><span class=n>pp</span><span class=p>.</span><span class=n>closeProcessPool</span><span class=p>();</span>
</span><span id=__span-42-47>
</span><span id=__span-42-48><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-42-49><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title=最后更新> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2025年7月30日</span> </span> </aside> <form class=md-feedback name=feedback hidden> <fieldset> <legend class=md-feedback__title> 页面有帮助吗？ </legend> <div class=md-feedback__inner> <div class=md-feedback__list> <button class="md-feedback__icon md-icon" type=submit title=页面对我有帮助 data-md-value=1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 9v12H1V9zm4 12a2 2 0 0 1-2-2V9c0-.55.22-1.05.59-1.41L14.17 1l1.06 1.06c.27.27.44.64.44 1.05l-.03.32L14.69 8H21a2 2 0 0 1 2 2v2c0 .26-.05.5-.14.73l-3.02 7.05C19.54 20.5 18.83 21 18 21zm0-2h9.03L21 12v-2h-8.79l1.13-5.32L9 9.03z"/></svg> </button> <button class="md-feedback__icon md-icon" type=submit title=页面没有帮助到我 data-md-value=0> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 15V3h4v12zM15 3a2 2 0 0 1 2 2v10c0 .55-.22 1.05-.59 1.41L9.83 23l-1.06-1.06c-.27-.27-.44-.64-.44-1.06l.03-.31.95-4.57H3a2 2 0 0 1-2-2v-2c0-.26.05-.5.14-.73l3.02-7.05C4.46 3.5 5.17 3 6 3zm0 2H5.97L3 12v2h8.78l-1.13 5.32L15 14.97z"/></svg> </button> </div> <div class=md-feedback__note> <div data-md-value=1 hidden> 谢谢你的反馈！ </div> <div data-md-value=0 hidden> 谢谢你的反馈！联系<a href=https://www.help-doc.top/author/contact/contact.html>作者</a>提供更详细的信息 </div> </div> </div> </fieldset> </form> <!-- Waline 评论系统 --> <div id=waline></div> <!-- 阅读进度条 - 直接在HTML中定义 --> <div class=reading-progress></div> <!-- 滚动指示器 - 直接在HTML中定义 --> <div class=scroll-indicator></div> <!-- 评论系统 --> <!-- Waline 评论系统 --> <div id=waline></div> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <!--
  Copyright (c) 2016-2024 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!-- Footer --> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2024-2025 柯懒不是柯南 </div> </div> <div class="md-footer-love md-typeset"> 一闪一闪亮晶晶，不及<span class=love-highlight>小亮</span><span class=love-heart>♥</span>照我心。To Li Liang </div> <div class=md-social> <a href=https://github.com/H0308 target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://www.help-doc.top/author/contact/contact.html target=_blank rel=noopener title=www.help-doc.top class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M433.754 420.445c-11.526 1.393-44.86-52.741-44.86-52.741 0 31.345-16.136 72.247-51.051 101.786 16.842 5.192 54.843 19.167 45.803 34.421-7.316 12.343-125.51 7.881-159.632 4.037-34.122 3.844-152.316 8.306-159.632-4.037-9.045-15.25 28.918-29.214 45.783-34.415-34.92-29.539-51.059-70.445-51.059-101.792 0 0-33.334 54.134-44.859 52.741-5.37-.65-12.424-29.644 9.347-99.704 10.261-33.024 21.995-60.478 40.144-105.779C60.683 98.063 108.982.006 224 0c113.737.006 163.156 96.133 160.264 214.963 18.118 45.223 29.912 72.85 40.144 105.778 21.768 70.06 14.716 99.053 9.346 99.704"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["navigation.indexes", "navigation.prune", "navigation.tabs", "search.highlight", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script> <script src=../../../assets/javascripts/bundle.c8b220af.min.js></script> <script src=../../../javascripts/katex.min.js></script> <script src=../../../javascripts/other.min.js></script> <script src=../../../javascripts/copyright.min.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/contrib/auto-render.min.js></script> <script src=../../../assets/javascripts/toggle-sidebar.js async></script> <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body> </html>