<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://www.help-doc.top/Linux/com-process/com-system-v-resources/com-system-v-resources.html><link rel=prev href=../com-message-queue-semaphore/com-message-queue-semaphore.html><link rel=next href=../../signals-os-principles/signals-os-principles.html><link rel=icon href=../../../images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.12"><title>操作系统管理System V标准中三种资源的方式 - 柯懒的知识库</title><link rel=stylesheet href=../../../assets/stylesheets/main.2afb09e1.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.06af60db.min.css><link rel=stylesheet href=../../../css/timeline.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-9XWRGNRRSY"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-9XWRGNRRSY",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-9XWRGNRRSY",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script><link rel=stylesheet href=../../../stylesheets/colors.min.css><link rel=stylesheet href=../../../stylesheets/theme2.min.css media="screen and (max-width: 1199px)"><link rel=stylesheet href=../../../stylesheets/theme2.min.css media="screen and (min-width: 1200px)" id=theme2-desktop><link rel=stylesheet href=../../../stylesheets/theme1.min.css media="screen and (min-width: 1200px)" id=theme1-desktop><link rel=stylesheet href=../../../stylesheets/print.min.css><link rel=stylesheet href=../../../stylesheets/font-dongguanti.min.css id=font-dongguanti><link rel=stylesheet href=../../../stylesheets/font-oppoti.min.css id=font-oppoti disabled><link rel=stylesheet href=../../../stylesheets/font-jiangchengti.min.css id=font-jiangchengti disabled><link rel=stylesheet href=../../../stylesheets/font-lxgw.min.css id=font-lxgw disabled><link rel=stylesheet href=../../../stylesheets/code-font-dejavu-sans-mono.min.css id=code-font-dejavu-sans-mono><link rel=stylesheet href=../../../stylesheets/code-font-zsft-hk.min.css id=code-font-zsft-hk disabled><link rel=stylesheet href=https://unpkg.com/@waline/client@v3/dist/waline.css><link rel=stylesheet href=../../../stylesheets/waline.min.css><script src=https://cdn.jsdelivr.net/npm/mermaid@11.5.0/dist/mermaid.min.js></script><script src=../../../javascripts/start.min.js></script><script type=module src=../../../javascripts/waline.min.js></script> <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../assets/javascripts/glightbox.min.js"></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=cyan> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#system-v class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../../index.html title=柯懒的知识库 class="md-header__button md-logo" aria-label=柯懒的知识库 data-md-component=logo> <img src=../../../assets/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> 柯懒的知识库 </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> 操作系统管理System V标准中三种资源的方式 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=cyan aria-label type=radio name=__palette id=__palette_1> </form> <!-- 头像元素 - 直接在HTML中定义 --> <div class=header-avatar> <img src=../../../author/作者.assets/20250206-200653.jpg alt=头像> <div class=avatar-dropdown> <p><strong>柯懒不是柯南</strong></p> <a href=../../../author/contact/contact.html class=avatar-dropdown-item>吵醒柯懒</a> <div class=avatar-dropdown-divider></div> <a href=../../../author/about/about.html class=avatar-dropdown-item>柯懒自传</a> <div class=avatar-dropdown-divider></div> <a href=https://github.com/H0308 class=avatar-dropdown-item>柯懒的零食库</a> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=查找> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <!-- 独立的切换按钮 --> <div class=toolbar-toggle-btn id=toolbarToggleBtn onclick=toggleToolbar()> <div class=toggle-icon> <svg class=toggle-arrow-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=16 height=16> <path d="M346.538667 1024L170.666667 853.333333l341.333333-341.333333-341.333333-341.333333 175.872-170.666667L853.333333 512z" fill=currentColor></path> </svg> </div> </div> <!-- 右侧固定功能条 - 独立于内容区 --> <div class=floating-toolbar id=floatingToolbar> <!-- 字体切换功能 --> <div class="toolbar-item font-switcher"> <div class=toolbar-icon> <svg class=font-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=20 height=20> <path d="M913.408 1024l-66.56 0q-29.696 0-51.2-5.12t-36.864-15.872-26.112-27.136-19.968-37.888q-15.36-38.912-28.16-70.656t-22.016-55.296q-11.264-26.624-20.48-49.152l-254.976 0q-7.168 23.552-17.408 51.2-8.192 23.552-21.504 56.832t-30.72 72.192q-20.48 46.08-47.104 63.488t-60.416 17.408l-70.656 0q-45.056 0-60.928-19.968t2.56-68.096q18.432-46.08 43.008-108.544t52.224-132.608 57.344-143.872 57.344-144.384q65.536-164.864 137.216-343.04 7.168-17.408 18.432-31.744 10.24-11.264 27.136-21.504t42.496-10.24q26.624 0 43.52 10.752t28.16 24.064q12.288 15.36 19.456 33.792 72.704 180.224 138.24 345.088 27.648 70.656 57.344 143.872t56.832 142.336 51.2 129.536 41.472 104.448q14.336 34.816 4.096 62.464t-43.008 27.648zM616.448 634.88l-97.28-347.136-1.024 0-108.544 347.136 206.848 0z" fill=currentColor></path> </svg> </div> <div class=toolbar-label>内容字体</div> <div class=font-dropdown-toolbar> <div class=font-current-toolbar onclick=toggleFontDropdownToolbar()> <span class=current-font-name-toolbar>东观体</span> <svg class=dropdown-arrow-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=12 height=12> <path d="M878.592 250.88q29.696 0 48.128 11.264t24.576 29.696 0 41.472-26.624 45.568q-82.944 92.16-159.744 180.224t-148.48 164.864q-19.456 20.48-45.568 31.744t-53.76 11.776-53.248-8.704-43.008-28.672q-39.936-44.032-82.944-90.112l-88.064-92.16q-43.008-46.08-85.504-90.624t-79.36-86.528q-17.408-19.456-22.528-40.448t1.024-38.4 23.552-28.672 45.056-11.264q35.84 0 98.816-0.512t137.728-0.512l153.6 0 150.528 0 125.952 0 79.872 0z" fill=currentColor></path> </svg> </div> <div class=font-options-toolbar> <div class=font-option-toolbar data-font=dongguanti onclick="selectFontToolbar('dongguanti')">上图东观体 </div> <div class=font-option-toolbar data-font=oppoti onclick="selectFontToolbar('oppoti')">OPPO Sans </div> <div class=font-option-toolbar data-font=jiangchengti onclick="selectFontToolbar('jiangchengti')"> 江城黑体</div> <div class=font-option-toolbar data-font=lxgw onclick="selectFontToolbar('lxgw')">霞鹜臻楷</div> </div> </div> </div> <!-- 代码字体切换功能 --> <div class="toolbar-item code-font-switcher"> <div class=toolbar-icon> <svg t=1753672111433 class="icon code-font-icon" viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg p-id=5148 width=20 height=20> <path d="M941.709938 0H82.290062A82.290062 82.290062 0 0 0 0 82.290062v859.419876A82.290062 82.290062 0 0 0 82.290062 1022.53923h859.419876A82.290062 82.290062 0 0 0 1022.53923 941.709938V82.290062A82.290062 82.290062 0 0 0 941.709938 0zM188.439372 553.631954a40.901569 40.901569 0 0 1-29.215406-70.116975L292.154066 351.558726 159.223966 218.628626a40.901569 40.901569 0 0 1 58.430813-57.94389l160.197813 162.145507a40.901569 40.901569 0 0 1 0 57.943889l-160.197813 160.684736a40.901569 40.901569 0 0 1-29.215407 12.173086z m443.587257 0H405.120304a40.901569 40.901569 0 0 1 0-82.290061H633.000476a40.901569 40.901569 0 0 1 0 82.290061z" fill=currentColor p-id=5149></path> </svg> </div> <div class=toolbar-label>代码字体</div> <div class=code-font-dropdown-toolbar> <div class=code-font-current-toolbar onclick=toggleCodeFontDropdownToolbar()> <span class=current-code-font-name-toolbar>DejaVu Sans Mono</span> <svg class=dropdown-arrow-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=12 height=12> <path d="M878.592 250.88q29.696 0 48.128 11.264t24.576 29.696 0 41.472-26.624 45.568q-82.944 92.16-159.744 180.224t-148.48 164.864q-19.456 20.48-45.568 31.744t-53.76 11.776-53.248-8.704-43.008-28.672q-39.936-44.032-82.944-90.112l-88.064-92.16q-43.008-46.08-85.504-90.624t-79.36-86.528q-17.408-19.456-22.528-40.448t1.024-38.4 23.552-28.672 45.056-11.264q35.84 0 98.816-0.512t137.728-0.512l153.6 0 150.528 0 125.952 0 79.872 0z" fill=currentColor></path> </svg> </div> <div class=code-font-options-toolbar> <div class=code-font-option-toolbar data-code-font=dejavu onclick="selectCodeFontToolbar('dejavu')"> DejaVu Sans Mono</div> <div class=code-font-option-toolbar data-code-font=zsft onclick="selectCodeFontToolbar('zsft')"> JetBrains Mono</div> </div> </div> </div> <!-- 主题切换功能 --> <div class="toolbar-item theme-switcher" onclick=switchTheme()> <div class=toolbar-icon> <svg class=theme-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=20 height=20> <path d="M876.572788 522.301623c-1.886977 12.375865-9.657964 30.331819-35.880185 45.48903-56.489572 32.697703-150.21828 83.990926-174.010149 96.958262-13.143345 24.431435-66.067718 122.221646-98.141204 178.503487-16.117073 28.124548-36.055171 34.041304-50.030463 34.041304-0.031722 0-0.031722 0-0.031722 0-14.613836 0-29.1806-6.460132-43.234687-19.218714-47.183626-42.643216-125.994576-117.105115-146.013515-136.083351-27.757181-4.732791-138.338718-23.743774-200.584388-35.752272-17.924231-3.533476-32.649608-14.07046-40.372499-29.084409-5.78782-11.256368-10.281157-30.05962 1.471514-55.658647 26.989701-59.047838 74.126254-157.557432 85.957721-182.196599-3.437286-27.117614-16.996093-135.060045-23.760147-198.905142-1.886977-17.460674 3.901867-35.096333 15.829524-48.351218 12.791327-14.278191 30.667463-21.48943 49.854455-19.426445 63.669088 6.332219 173.259042 19.426445 200.584388 22.705118 24.335245-11.879562 121.085776-58.936297 180.133613-86.34146 9.91379-4.573155 19.85828-6.92369 29.596062-6.92369 28.748764 0 52.172243 20.642133 58.328453 51.421136 12.599969 62.997799 30.93864 166.70272 35.639708 193.484689 18.851347 19.682271 91.953272 96.031147 135.060045 143.07151C872.72004 487.125473 879.307062 504.71406 876.572788 522.301623L876.572788 522.301623zM825.375755 499.085876C776.017604 445.314205 687.245791 352.977193 686.365748 352.017332c-2.942005-3.069919-4.956895-6.971785-5.676279-11.208273-0.207731-1.215688-22.193465-127.001509-36.551474-198.936865-0.799202-3.917216-4.285606-16.836457-16.196891-16.836457-3.453658 0-7.30743 1.006933-11.464099 2.942005-67.282383 31.179117-183.955662 88.180342-185.170327 88.771813-3.693112 1.790786-7.850805 2.558265-11.975752 2.01489-1.295506-0.224104-133.63765-16.165168-205.988468-23.424502-0.079818 0-0.207731 0-0.287549 0-7.30743 0-11.128455 2.89391-13.319353 5.40408-3.677762 4.124947-5.644557 9.91379-5.068436 15.110139 7.674796 72.623018 24.255427 202.934922 24.463158 204.325595 0.511653 4.109598-0.159636 8.266267-1.966795 11.960403-0.591471 1.215688-57.657164 120.04712-88.339977 187.201589-3.565199 7.754614-4.41352 14.214746-2.350534 18.131963 1.935072 3.725858 6.588045 5.820566 10.360975 6.53995 70.719668 13.718443 204.644867 36.519752 206.036563 36.727483 4.189416 0.671289 8.058536 2.686179 11.112082 5.580089 1.006933 0.87902 96.414887 91.281983 150.090367 139.889027 8.314363 7.563256 13.143345 8.106632 14.437827 8.106632 3.485381 0 8.314363-4.621251 12.727882-12.391215 36.343743-63.828724 100.011808-181.988868 100.636025-183.155437 1.983167-3.64604 5.004991-6.667863 8.650007-8.650007 1.134847-0.671289 114.418936-62.373583 178.6314-99.516528 8.698103-5.036713 14.278191-10.568706 14.94948-14.854313C834.681702 511.845481 831.49922 505.800811 825.375755 499.085876L825.375755 499.085876zM935.333076 935.670256c-4.157693 4.157693-9.689686 6.299473-15.141862 6.299473-5.548366 0-11.048637-2.142803-15.238053-6.299473l-171.915441-171.915441c-8.362458-8.394181-8.362458-21.98471 0-30.426987 8.394181-8.394181 21.98471-8.394181 30.379914 0l171.915441 171.915441C943.727257 913.684522 943.727257 927.275052 935.333076 935.670256L935.333076 935.670256z" fill=currentColor></path> </svg> </div> <div class=toolbar-label>主题切换</div> </div> <!-- 返回顶部功能 --> <div class="toolbar-item back-to-top" onclick=scrollToTop()> <div class=toolbar-icon> <svg class=back-to-top-icon viewbox="0 0 1024 1024" xmlns=http://www.w3.org/2000/svg> <path d="M882.688 624.128l-336.896-583.68c-15.872-27.136-54.784-27.136-70.656 0L138.24 624.128c-15.872 27.136 4.096 61.44 35.328 61.44H317.44c22.528 0 40.96 18.432 40.96 40.96v239.616c0 22.528 18.432 40.96 40.96 40.96h223.232c22.528 0 40.96-18.432 40.96-40.96v-239.616c0-22.528 18.432-40.96 40.96-40.96h143.872c30.208 0 50.176-34.304 34.304-61.44z"> </path> </svg> </div> <div class=toolbar-label>返回顶部</div> </div> </div> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../index.html class=md-tabs__link> 主页 </a> </li> <li class=md-tabs__item> <a href=../../../intro/intro.html class=md-tabs__link> 网站介绍 </a> </li> <li class=md-tabs__item> <a href=../../../timeline/timeline.html class=md-tabs__link> 网站时间线 </a> </li> <li class=md-tabs__item> <a href=../../../c-lang/index.html class=md-tabs__link> 编程语言 </a> </li> <li class=md-tabs__item> <a href=../../../data-structure/time-space-complexity/time-space-complexity.html class=md-tabs__link> 数据结构与算法 </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../options-commands/options-commands.html class=md-tabs__link> Linux </a> </li> <li class=md-tabs__item> <a href=../../../html-css/html/html.html class=md-tabs__link> 前端 </a> </li> <li class=md-tabs__item> <a href=../../../MySQL/JDBC/JDBC-basic/JDBC-basic.html class=md-tabs__link> MySQL </a> </li> <li class=md-tabs__item> <a href=../../../JavaEE/Spring/springmvc-basic/springmvc-basic.html class=md-tabs__link> JavaEE应用开发 </a> </li> <li class=md-tabs__item> <a href=../../../other/shell/shell.html class=md-tabs__link> 扩展知识 </a> </li> <li class=md-tabs__item> <a href=../../../tooltips/vscode-snippets/vscode-snippets.html class=md-tabs__link> 工具帮助 </a> </li> <li class=md-tabs__item> <a href=../../../projects/boost-searching-engine/boost-searching-engine.html class=md-tabs__link> 项目 </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../index.html title=柯懒的知识库 class="md-nav__button md-logo" aria-label=柯懒的知识库 data-md-component=logo> <img src=../../../assets/logo.png alt=logo> </a> 柯懒的知识库 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../index.html class=md-nav__link> <span class=md-ellipsis> 主页 </span> </a> </li> <li class=md-nav__item> <a href=../../../intro/intro.html class=md-nav__link> <span class=md-ellipsis> 网站介绍 </span> </a> </li> <li class=md-nav__item> <a href=../../../timeline/timeline.html class=md-nav__link> <span class=md-ellipsis> 网站时间线 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../c-lang/index.html class=md-nav__link> <span class=md-ellipsis> 编程语言 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../data-structure/time-space-complexity/time-space-complexity.html class=md-nav__link> <span class=md-ellipsis> 数据结构与算法 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6 checked> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex> <span class=md-ellipsis> Linux </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=true> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../options-commands/options-commands.html class=md-nav__link> <span class=md-ellipsis> Linux常用选项和指令 </span> </a> </li> <li class=md-nav__item> <a href=../../permission/permission.html class=md-nav__link> <span class=md-ellipsis> Linux权限相关 </span> </a> </li> <li class=md-nav__item> <a href=../../software-installation/software-installation.html class=md-nav__link> <span class=md-ellipsis> CentOS软件安装 </span> </a> </li> <li class=md-nav__item> <a href=../../gcc-gdb/gcc-gdb.html class=md-nav__link> <span class=md-ellipsis> Linux下的gcc与gdb </span> </a> </li> <li class=md-nav__item> <a href=../../makefile-progress-bar/makefile-progress-bar.html class=md-nav__link> <span class=md-ellipsis> Linux下的Makefile与进度条程序 </span> </a> </li> <li class=md-nav__item> <a href=../../os-basic/os-basic.html class=md-nav__link> <span class=md-ellipsis> 操作系统基础知识 </span> </a> </li> <li class=md-nav__item> <a href=../../process-basic/process-basic.html class=md-nav__link> <span class=md-ellipsis> Linux进程基础 </span> </a> </li> <li class=md-nav__item> <a href=../../process-state-priority/process-state-priority.html class=md-nav__link> <span class=md-ellipsis> Linux进程状态与进程优先级 </span> </a> </li> <li class=md-nav__item> <a href=../../process-switch-scheduling/process-switch-scheduling.html class=md-nav__link> <span class=md-ellipsis> Linux进程切换以及调度算法 </span> </a> </li> <li class=md-nav__item> <a href=../../command-line-env/command-line-env.html class=md-nav__link> <span class=md-ellipsis> Linux命令行与环境变量 </span> </a> </li> <li class=md-nav__item> <a href=../../process-address-space/process-address-space.html class=md-nav__link> <span class=md-ellipsis> Linux进程地址空间 </span> </a> </li> <li class=md-nav__item> <a href=../../process-control/process-control.html class=md-nav__link> <span class=md-ellipsis> Linux进程控制 </span> </a> </li> <li class=md-nav__item> <a href=../../linux-fileop/linux-fileop.html class=md-nav__link> <span class=md-ellipsis> Linux文件操作基础 </span> </a> </li> <li class=md-nav__item> <a href=../../io-process/io-process.html class=md-nav__link> <span class=md-ellipsis> Linux中输入和输出基本过程 </span> </a> </li> <li class=md-nav__item> <a href=../../file-system/file-system.html class=md-nav__link> <span class=md-ellipsis> Linux文件系统 </span> </a> </li> <li class=md-nav__item> <a href=../../soft-hard-link/soft-hard-link.html class=md-nav__link> <span class=md-ellipsis> Linux软链接和硬链接 </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_17 checked> <label class=md-nav__link for=__nav_6_17 id=__nav_6_17_label tabindex=0> <span class=md-ellipsis> Linux进程间通信 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_17_label aria-expanded=true> <label class=md-nav__title for=__nav_6_17> <span class="md-nav__icon md-icon"></span> Linux进程间通信 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../com-anonymous-pipe/com-anonymous-pipe.html class=md-nav__link> <span class=md-ellipsis> 进程间通信介绍与匿名管道 </span> </a> </li> <li class=md-nav__item> <a href=../com-named-pipe-shm/com-named-pipe-shm.html class=md-nav__link> <span class=md-ellipsis> 命名管道与共享内存 </span> </a> </li> <li class=md-nav__item> <a href=../com-message-queue-semaphore/com-message-queue-semaphore.html class=md-nav__link> <span class=md-ellipsis> 消息队列与信号量 </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> 操作系统管理System V标准中三种资源的方式 </span> <span class="md-nav__icon md-icon"></span> </label> <a href=com-system-v-resources.html class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> 操作系统管理System V标准中三种资源的方式 </span> </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 从应用层了解三种通信方式的属性 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 从内核层了解三者通信方式管理的本质 </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 再谈共享内存 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../signals-os-principles/signals-os-principles.html class=md-nav__link> <span class=md-ellipsis> Linux信号与操作系统原理 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../linux-thread/thread-concept-op/thread-concept-op.html class=md-nav__link> <span class=md-ellipsis> Linux线程 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../../net-basic/net-basic.html class=md-nav__link> <span class=md-ellipsis> 网络基础知识 </span> </a> </li> <li class=md-nav__item> <a href=../../socket-basic/socket-basic.html class=md-nav__link> <span class=md-ellipsis> Socket编程基础 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../udp/udp-basic/udp-basic.html class=md-nav__link> <span class=md-ellipsis> UDP编程 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../../tcp-basic/tcp-basic.html class=md-nav__link> <span class=md-ellipsis> TCP编程接口基本使用 </span> </a> </li> <li class=md-nav__item> <a href=../../serialization-net-cal/serialization-net-cal.html class=md-nav__link> <span class=md-ellipsis> 序列化和反序列化与网络计算器 </span> </a> </li> <li class=md-nav__item> <a href=../../process-relationship-daemon/process-relationship-daemon.html class=md-nav__link> <span class=md-ellipsis> 进程间关系和守护进程 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../http/http-basic-httpserver/http-basic-httpserver.html class=md-nav__link> <span class=md-ellipsis> 应用层协议HTTP </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../../udp-principles/udp-principles.html class=md-nav__link> <span class=md-ellipsis> UDP协议原理 </span> </a> </li> <li class=md-nav__item> <a href=../../tcp-principles/tcp-principles.html class=md-nav__link> <span class=md-ellipsis> TCP协议原理 </span> </a> </li> <li class=md-nav__item> <a href=../../tcp-connection-backlog/tcp-connection-backlog.html class=md-nav__link> <span class=md-ellipsis> 理解Linux如何看待连接以及TCP全连接队列 </span> </a> </li> <li class=md-nav__item> <a href=../../ip/ip.html class=md-nav__link> <span class=md-ellipsis> 网络层IP协议 </span> </a> </li> <li class=md-nav__item> <a href=../../datalink/datalink.html class=md-nav__link> <span class=md-ellipsis> 数据链路层协议 </span> </a> </li> <li class=md-nav__item> <a href=../../dns-icmp/dns-icmp.html class=md-nav__link> <span class=md-ellipsis> DNS与ICMP </span> </a> </li> <li class=md-nav__item> <a href=../../nat-proxy/nat-proxy.html class=md-nav__link> <span class=md-ellipsis> NAT技术、代理服务器和内网穿透 </span> </a> </li> <li class=md-nav__item> <a href=../../io-model-select-poll/io-model-select-poll.html class=md-nav__link> <span class=md-ellipsis> 五种IO模型与select和poll分别实现多路转接 </span> </a> </li> <li class=md-nav__item> <a href=../../epoll/epoll.html class=md-nav__link> <span class=md-ellipsis> epoll实现多路转接 </span> </a> </li> <li class=md-nav__item> <a href=../../reactor-et/reactor-et.html class=md-nav__link> <span class=md-ellipsis> Reactor模式与完善基于边缘触发模式epoll实现TCP服务器 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../html-css/html/html.html class=md-nav__link> <span class=md-ellipsis> 前端 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../MySQL/JDBC/JDBC-basic/JDBC-basic.html class=md-nav__link> <span class=md-ellipsis> MySQL </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../JavaEE/Spring/springmvc-basic/springmvc-basic.html class=md-nav__link> <span class=md-ellipsis> JavaEE应用开发 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../other/shell/shell.html class=md-nav__link> <span class=md-ellipsis> 扩展知识 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../tooltips/vscode-snippets/vscode-snippets.html class=md-nav__link> <span class=md-ellipsis> 工具帮助 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../projects/boost-searching-engine/boost-searching-engine.html class=md-nav__link> <span class=md-ellipsis> 项目 </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 从应用层了解三种通信方式的属性 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 从内核层了解三者通信方式管理的本质 </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 再谈共享内存 </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=system-v>操作系统管理System V标准中三种资源的方式<a class=headerlink href=#system-v title="Permanent link">&para;</a></h1> <div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;"> <p><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 1609 个字 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 244 行代码 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 8 分钟</p> </div> <p>前面介绍了四种进程间通信的方式，其中共享内存、消息队列和信号量属于System V标准的通信方式，在使用这三种进程间通信方式时可以发现其中的接口都比较类似，如下表所示：</p> <table> <thead> <tr> <th>操作\通信方式</th> <th>共享内存</th> <th>消息队列</th> <th>信号量</th> </tr> </thead> <tbody> <tr> <td>申请资源</td> <td><code>shmget</code></td> <td><code>msgget</code></td> <td><code>semget</code></td> </tr> <tr> <td>操作资源</td> <td>常规读写操作</td> <td><code>msgsnd</code>和<code>msgrcv</code></td> <td><code>semop</code></td> </tr> <tr> <td>释放资源</td> <td><code>shmctl</code></td> <td><code>msgctl</code></td> <td><code>semctl</code></td> </tr> </tbody> </table> <h2 id=_1>从应用层了解三种通信方式的属性<a class=headerlink href=#_1 title="Permanent link">&para;</a></h2> <p>因为遵循着同一个标准，所以三者的操作都大差不差，所以操作系统底层为了更方便管理这三种资源，就考虑对这三种资源进行统一管理，分析如下：</p> <p>首先查看共享内存的相关定义：</p> <div class="tabbed-set tabbed-alternate" data-tabs=1:2><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><input id=__tabbed_1_2 name=__tabbed_1 type=radio><div class=tabbed-labels><label for=__tabbed_1_1>共享内存结构</label><label for=__tabbed_1_2>共享内存第一个成员结构</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-1><span class=k>struct</span><span class=w> </span><span class=nc>shmid_ds</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-0-2><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>ipc_perm</span><span class=w> </span><span class=n>shm_perm</span><span class=p>;</span><span class=w>    </span><span class=cm>/* Ownership and permissions */</span>
</span><span id=__span-0-3><span class=w>    </span><span class=kt>size_t</span><span class=w>          </span><span class=n>shm_segsz</span><span class=p>;</span><span class=w>   </span><span class=cm>/* Size of segment (bytes) */</span>
</span><span id=__span-0-4><span class=w>    </span><span class=kt>time_t</span><span class=w>          </span><span class=n>shm_atime</span><span class=p>;</span><span class=w>   </span><span class=cm>/* Last attach time */</span>
</span><span id=__span-0-5><span class=w>    </span><span class=kt>time_t</span><span class=w>          </span><span class=n>shm_dtime</span><span class=p>;</span><span class=w>   </span><span class=cm>/* Last detach time */</span>
</span><span id=__span-0-6><span class=w>    </span><span class=kt>time_t</span><span class=w>          </span><span class=n>shm_ctime</span><span class=p>;</span><span class=w>   </span><span class=cm>/* Creation time/time of last</span>
</span><span id=__span-0-7><span class=cm>                                    modification via shmctl() */</span>
</span><span id=__span-0-8><span class=w>    </span><span class=kt>pid_t</span><span class=w>           </span><span class=n>shm_cpid</span><span class=p>;</span><span class=w>    </span><span class=cm>/* PID of creator */</span>
</span><span id=__span-0-9><span class=w>    </span><span class=kt>pid_t</span><span class=w>           </span><span class=n>shm_lpid</span><span class=p>;</span><span class=w>    </span><span class=cm>/* PID of last shmat(2)/shmdt(2) */</span>
</span><span id=__span-0-10><span class=w>    </span><span class=n>shmatt_t</span><span class=w>        </span><span class=n>shm_nattch</span><span class=p>;</span><span class=w>  </span><span class=cm>/* No. of current attaches */</span>
</span><span id=__span-0-11><span class=w>    </span><span class=p>...</span>
</span><span id=__span-0-12><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-1-1><span class=k>struct</span><span class=w> </span><span class=nc>ipc_perm</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-1-2><span class=w>    </span><span class=kt>key_t</span><span class=w>          </span><span class=n>__key</span><span class=p>;</span><span class=w>    </span><span class=cm>/* Key supplied to shmget(2) */</span>
</span><span id=__span-1-3><span class=w>    </span><span class=kt>uid_t</span><span class=w>          </span><span class=n>uid</span><span class=p>;</span><span class=w>      </span><span class=cm>/* Effective UID of owner */</span>
</span><span id=__span-1-4><span class=w>    </span><span class=kt>gid_t</span><span class=w>          </span><span class=n>gid</span><span class=p>;</span><span class=w>      </span><span class=cm>/* Effective GID of owner */</span>
</span><span id=__span-1-5><span class=w>    </span><span class=kt>uid_t</span><span class=w>          </span><span class=n>cuid</span><span class=p>;</span><span class=w>     </span><span class=cm>/* Effective UID of creator */</span>
</span><span id=__span-1-6><span class=w>    </span><span class=kt>gid_t</span><span class=w>          </span><span class=n>cgid</span><span class=p>;</span><span class=w>     </span><span class=cm>/* Effective GID of creator */</span>
</span><span id=__span-1-7><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>short</span><span class=w> </span><span class=n>mode</span><span class=p>;</span><span class=w>     </span><span class=cm>/* Permissions + SHM_DEST and</span>
</span><span id=__span-1-8><span class=cm>                                SHM_LOCKED flags */</span>
</span><span id=__span-1-9><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>short</span><span class=w> </span><span class=n>__seq</span><span class=p>;</span><span class=w>    </span><span class=cm>/* Sequence number */</span>
</span><span id=__span-1-10><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>接着查看消息队列的相关定义：</p> <div class="tabbed-set tabbed-alternate" data-tabs=2:2><input checked=checked id=__tabbed_2_1 name=__tabbed_2 type=radio><input id=__tabbed_2_2 name=__tabbed_2 type=radio><div class=tabbed-labels><label for=__tabbed_2_1>消息队列结构</label><label for=__tabbed_2_2>消息队列第一个成员结构</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-2-1><span class=k>struct</span><span class=w> </span><span class=nc>msqid_ds</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-2-2><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>ipc_perm</span><span class=w> </span><span class=n>msg_perm</span><span class=p>;</span><span class=w>   </span><span class=cm>/* Ownership and permissions */</span>
</span><span id=__span-2-3><span class=w>    </span><span class=kt>time_t</span><span class=w>          </span><span class=n>msg_stime</span><span class=p>;</span><span class=w>  </span><span class=cm>/* Time of last msgsnd(2) */</span>
</span><span id=__span-2-4><span class=w>    </span><span class=kt>time_t</span><span class=w>          </span><span class=n>msg_rtime</span><span class=p>;</span><span class=w>  </span><span class=cm>/* Time of last msgrcv(2) */</span>
</span><span id=__span-2-5><span class=w>    </span><span class=kt>time_t</span><span class=w>          </span><span class=n>msg_ctime</span><span class=p>;</span><span class=w>  </span><span class=cm>/* Time of creation or last</span>
</span><span id=__span-2-6><span class=cm>                                    modification by msgctl() */</span>
</span><span id=__span-2-7><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>long</span><span class=w>   </span><span class=n>msg_cbytes</span><span class=p>;</span><span class=w> </span><span class=cm>/* # of bytes in queue */</span>
</span><span id=__span-2-8><span class=w>    </span><span class=n>msgqnum_t</span><span class=w>       </span><span class=n>msg_qnum</span><span class=p>;</span><span class=w>   </span><span class=cm>/* # number of messages in queue */</span>
</span><span id=__span-2-9><span class=w>    </span><span class=n>msglen_t</span><span class=w>        </span><span class=n>msg_qbytes</span><span class=p>;</span><span class=w> </span><span class=cm>/* Maximum # of bytes in queue */</span>
</span><span id=__span-2-10><span class=w>    </span><span class=kt>pid_t</span><span class=w>           </span><span class=n>msg_lspid</span><span class=p>;</span><span class=w>  </span><span class=cm>/* PID of last msgsnd(2) */</span>
</span><span id=__span-2-11><span class=w>    </span><span class=kt>pid_t</span><span class=w>           </span><span class=n>msg_lrpid</span><span class=p>;</span><span class=w>  </span><span class=cm>/* PID of last msgrcv(2) */</span>
</span><span id=__span-2-12><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-3-1><span class=k>struct</span><span class=w> </span><span class=nc>ipc_perm</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-2><span class=w>    </span><span class=kt>key_t</span><span class=w>          </span><span class=n>__key</span><span class=p>;</span><span class=w>       </span><span class=cm>/* Key supplied to msgget(2) */</span>
</span><span id=__span-3-3><span class=w>    </span><span class=kt>uid_t</span><span class=w>          </span><span class=n>uid</span><span class=p>;</span><span class=w>         </span><span class=cm>/* Effective UID of owner */</span>
</span><span id=__span-3-4><span class=w>    </span><span class=kt>gid_t</span><span class=w>          </span><span class=n>gid</span><span class=p>;</span><span class=w>         </span><span class=cm>/* Effective GID of owner */</span>
</span><span id=__span-3-5><span class=w>    </span><span class=kt>uid_t</span><span class=w>          </span><span class=n>cuid</span><span class=p>;</span><span class=w>        </span><span class=cm>/* Effective UID of creator */</span>
</span><span id=__span-3-6><span class=w>    </span><span class=kt>gid_t</span><span class=w>          </span><span class=n>cgid</span><span class=p>;</span><span class=w>        </span><span class=cm>/* Effective GID of creator */</span>
</span><span id=__span-3-7><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>short</span><span class=w> </span><span class=n>mode</span><span class=p>;</span><span class=w>        </span><span class=cm>/* Permissions */</span>
</span><span id=__span-3-8><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>short</span><span class=w> </span><span class=n>__seq</span><span class=p>;</span><span class=w>       </span><span class=cm>/* Sequence number */</span>
</span><span id=__span-3-9><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>最后查看信号量的相关定义：</p> <div class="tabbed-set tabbed-alternate" data-tabs=3:2><input checked=checked id=__tabbed_3_1 name=__tabbed_3 type=radio><input id=__tabbed_3_2 name=__tabbed_3 type=radio><div class=tabbed-labels><label for=__tabbed_3_1>信号量相关结构</label><label for=__tabbed_3_2>信号量第一个成员结构</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-4-1><span class=k>struct</span><span class=w> </span><span class=nc>semid_ds</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-2><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>ipc_perm</span><span class=w> </span><span class=n>sem_perm</span><span class=p>;</span><span class=w>  </span><span class=cm>/* Ownership and permissions */</span>
</span><span id=__span-4-3><span class=w>    </span><span class=kt>time_t</span><span class=w>          </span><span class=n>sem_otime</span><span class=p>;</span><span class=w> </span><span class=cm>/* Last semop time */</span>
</span><span id=__span-4-4><span class=w>    </span><span class=kt>time_t</span><span class=w>          </span><span class=n>sem_ctime</span><span class=p>;</span><span class=w> </span><span class=cm>/* Creation time/time of last</span>
</span><span id=__span-4-5><span class=cm>                                    modification via semctl() */</span>
</span><span id=__span-4-6><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>long</span><span class=w>   </span><span class=n>sem_nsems</span><span class=p>;</span><span class=w> </span><span class=cm>/* No. of semaphores in set */</span>
</span><span id=__span-4-7><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-5-1><span class=k>struct</span><span class=w> </span><span class=nc>ipc_perm</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-2><span class=w>    </span><span class=kt>key_t</span><span class=w>          </span><span class=n>__key</span><span class=p>;</span><span class=w> </span><span class=cm>/* Key supplied to semget(2) */</span>
</span><span id=__span-5-3><span class=w>    </span><span class=kt>uid_t</span><span class=w>          </span><span class=n>uid</span><span class=p>;</span><span class=w>   </span><span class=cm>/* Effective UID of owner */</span>
</span><span id=__span-5-4><span class=w>    </span><span class=kt>gid_t</span><span class=w>          </span><span class=n>gid</span><span class=p>;</span><span class=w>   </span><span class=cm>/* Effective GID of owner */</span>
</span><span id=__span-5-5><span class=w>    </span><span class=kt>uid_t</span><span class=w>          </span><span class=n>cuid</span><span class=p>;</span><span class=w>  </span><span class=cm>/* Effective UID of creator */</span>
</span><span id=__span-5-6><span class=w>    </span><span class=kt>gid_t</span><span class=w>          </span><span class=n>cgid</span><span class=p>;</span><span class=w>  </span><span class=cm>/* Effective GID of creator */</span>
</span><span id=__span-5-7><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>short</span><span class=w> </span><span class=n>mode</span><span class=p>;</span><span class=w>  </span><span class=cm>/* Permissions */</span>
</span><span id=__span-5-8><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>short</span><span class=w> </span><span class=n>__seq</span><span class=p>;</span><span class=w> </span><span class=cm>/* Sequence number */</span>
</span><span id=__span-5-9><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>从上面的三部分代码可以看出，不论是共享内存、消息队列，还是信号量，三者的第一个成员都是<code>struct ipc_perm</code>结构，这个结构用于存放当前资源的相关权限已经标识符，例如其中的<code>__key</code>表示资源在系统中的编号，另外还有对应的<code>uid</code>表示持有当前资源的用户，三者除了有<code>struct ipc_perm</code>结构外，还有一些其他成员也基本类似，共同组成了指定的资源</p> <p>其他属性暂时不考虑，主要看每一种资源的第一个成员为什么都是<code>struct ipc_perm</code>，实际上这就是操作系统将三种资源都看成一种资源来管理的原因</p> <p>通过代码获取对应的属性如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-6-1><span class=kt>void</span><span class=w> </span><span class=nf>getInfo</span><span class=p>()</span>
</span><span id=__span-6-2><span class=p>{</span>
</span><span id=__span-6-3><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>shmid_ds</span><span class=w> </span><span class=n>buffer</span><span class=p>;</span><span class=w> </span><span class=c1>// 系统提供的数据类型</span>
</span><span id=__span-6-4><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>shmctl</span><span class=p>(</span><span class=n>_shmid</span><span class=p>,</span><span class=w> </span><span class=n>IPC_STAT</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>buffer</span><span class=p>);</span>
</span><span id=__span-6-5><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-6-6><span class=w>        </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-6-7><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>buffer</span><span class=p>.</span><span class=n>shm_atime</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-6-8><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>buffer</span><span class=p>.</span><span class=n>shm_cpid</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-6-9><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>buffer</span><span class=p>.</span><span class=n>shm_ctime</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-6-10><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>buffer</span><span class=p>.</span><span class=n>shm_nattch</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-6-11><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>buffer</span><span class=p>.</span><span class=n>shm_perm</span><span class=p>.</span><span class=n>__key</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-6-12><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h2 id=_2>从内核层了解三者通信方式管理的本质<a class=headerlink href=#_2 title="Permanent link">&para;</a></h2> <p>操作系统为了管理三种通信方式的资源，会通过一个数据结构进行管理，在Linux 2.6版本的内核中结构如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-7-1><span class=k>struct</span><span class=w> </span><span class=nc>ipc_ids</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-2><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>size</span><span class=p>;</span>
</span><span id=__span-7-3><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>in_use</span><span class=p>;</span>
</span><span id=__span-7-4><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>max_id</span><span class=p>;</span>
</span><span id=__span-7-5><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>short</span><span class=w> </span><span class=n>seq</span><span class=p>;</span>
</span><span id=__span-7-6><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>short</span><span class=w> </span><span class=n>seq_max</span><span class=p>;</span>
</span><span id=__span-7-7><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>semaphore</span><span class=w> </span><span class=n>sem</span><span class=p>;</span><span class=w>   </span>
</span><span id=__span-7-8><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>ipc_id</span><span class=o>*</span><span class=w> </span><span class=n>entries</span><span class=p>;</span>
</span><span id=__span-7-9><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>通过上面的结构，操作系统创建出三个对象分别为：</p> <div class="tabbed-set tabbed-alternate" data-tabs=4:3><input checked=checked id=__tabbed_4_1 name=__tabbed_4 type=radio><input id=__tabbed_4_2 name=__tabbed_4 type=radio><input id=__tabbed_4_3 name=__tabbed_4 type=radio><div class=tabbed-labels><label for=__tabbed_4_1>共享内存</label><label for=__tabbed_4_2>消息队列</label><label for=__tabbed_4_3>信号量</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-8-1><span class=k>static</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>ipc_ids</span><span class=w> </span><span class=n>shm_ids</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-9-1><span class=k>static</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>ipc_ids</span><span class=w> </span><span class=n>msg_ids</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-10-1><span class=k>static</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>ipc_ids</span><span class=w> </span><span class=n>sem_ids</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>上面三个结构对象中都存在着一个成员：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-11-1><span class=k>struct</span><span class=w> </span><span class=nc>ipc_id</span><span class=o>*</span><span class=w> </span><span class=n>entries</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> <p>该成员具体实现如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-12-1><span class=k>struct</span><span class=w> </span><span class=nc>ipc_id</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-12-2><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>kern_ipc_perm</span><span class=o>*</span><span class=w> </span><span class=n>p</span><span class=p>;</span>
</span><span id=__span-12-3><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>对应的<code>struct kern_ipc_perm</code>结构如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-13-1><span class=k>struct</span><span class=w> </span><span class=nc>kern_ipc_perm</span>
</span><span id=__span-13-2><span class=p>{</span>
</span><span id=__span-13-3><span class=w>    </span><span class=n>spinlock_t</span><span class=w>  </span><span class=n>lock</span><span class=p>;</span>
</span><span id=__span-13-4><span class=w>    </span><span class=kt>int</span><span class=w>     </span><span class=n>deleted</span><span class=p>;</span>
</span><span id=__span-13-5><span class=w>    </span><span class=kt>key_t</span><span class=w>       </span><span class=n>key</span><span class=p>;</span>
</span><span id=__span-13-6><span class=w>    </span><span class=kt>uid_t</span><span class=w>       </span><span class=n>uid</span><span class=p>;</span>
</span><span id=__span-13-7><span class=w>    </span><span class=kt>gid_t</span><span class=w>       </span><span class=n>gid</span><span class=p>;</span>
</span><span id=__span-13-8><span class=w>    </span><span class=kt>uid_t</span><span class=w>       </span><span class=n>cuid</span><span class=p>;</span>
</span><span id=__span-13-9><span class=w>    </span><span class=kt>gid_t</span><span class=w>       </span><span class=n>cgid</span><span class=p>;</span>
</span><span id=__span-13-10><span class=w>    </span><span class=kt>mode_t</span><span class=w>      </span><span class=n>mode</span><span class=p>;</span><span class=w> </span>
</span><span id=__span-13-11><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>long</span><span class=w>   </span><span class=n>seq</span><span class=p>;</span>
</span><span id=__span-13-12><span class=w>    </span><span class=kt>void</span><span class=w>        </span><span class=o>*</span><span class=n>security</span><span class=p>;</span>
</span><span id=__span-13-13><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>这个结构中的<code>struct kern_ipc_perm</code>实际上就是应用层的<code>struct ipc_perm</code>，从每一个资源的结构也可以得出这个结论：</p> <div class="tabbed-set tabbed-alternate" data-tabs=5:3><input checked=checked id=__tabbed_5_1 name=__tabbed_5 type=radio><input id=__tabbed_5_2 name=__tabbed_5 type=radio><input id=__tabbed_5_3 name=__tabbed_5 type=radio><div class=tabbed-labels><label for=__tabbed_5_1>共享内存</label><label for=__tabbed_5_2>消息队列</label><label for=__tabbed_5_3>信号量</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-14-1><span class=k>struct</span><span class=w> </span><span class=nc>shmid_kernel</span><span class=w> </span><span class=cm>/* private to the kernel */</span>
</span><span id=__span-14-2><span class=p>{</span><span class=w>   </span>
</span><span id=__span-14-3><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>kern_ipc_perm</span><span class=w>    </span><span class=n>shm_perm</span><span class=p>;</span>
</span><span id=__span-14-4><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>file</span><span class=w> </span><span class=o>*</span><span class=w>       </span><span class=n>shm_file</span><span class=p>;</span>
</span><span id=__span-14-5><span class=w>    </span><span class=kt>int</span><span class=w>         </span><span class=n>id</span><span class=p>;</span>
</span><span id=__span-14-6><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>long</span><span class=w>       </span><span class=n>shm_nattch</span><span class=p>;</span>
</span><span id=__span-14-7><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>long</span><span class=w>       </span><span class=n>shm_segsz</span><span class=p>;</span>
</span><span id=__span-14-8><span class=w>    </span><span class=kt>time_t</span><span class=w>          </span><span class=n>shm_atim</span><span class=p>;</span>
</span><span id=__span-14-9><span class=w>    </span><span class=kt>time_t</span><span class=w>          </span><span class=n>shm_dtim</span><span class=p>;</span>
</span><span id=__span-14-10><span class=w>    </span><span class=kt>time_t</span><span class=w>          </span><span class=n>shm_ctim</span><span class=p>;</span>
</span><span id=__span-14-11><span class=w>    </span><span class=kt>pid_t</span><span class=w>           </span><span class=n>shm_cprid</span><span class=p>;</span>
</span><span id=__span-14-12><span class=w>    </span><span class=kt>pid_t</span><span class=w>           </span><span class=n>shm_lprid</span><span class=p>;</span>
</span><span id=__span-14-13><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-15-1><span class=k>struct</span><span class=w> </span><span class=nc>msg_queue</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-15-2><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>kern_ipc_perm</span><span class=w> </span><span class=n>q_perm</span><span class=p>;</span>
</span><span id=__span-15-3><span class=w>    </span><span class=kt>time_t</span><span class=w> </span><span class=n>q_stime</span><span class=p>;</span><span class=w>         </span><span class=cm>/* last msgsnd time */</span>
</span><span id=__span-15-4><span class=w>    </span><span class=kt>time_t</span><span class=w> </span><span class=n>q_rtime</span><span class=p>;</span><span class=w>         </span><span class=cm>/* last msgrcv time */</span>
</span><span id=__span-15-5><span class=w>    </span><span class=kt>time_t</span><span class=w> </span><span class=n>q_ctime</span><span class=p>;</span><span class=w>         </span><span class=cm>/* last change time */</span>
</span><span id=__span-15-6><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>q_cbytes</span><span class=p>;</span><span class=w>     </span><span class=cm>/* current number of bytes on queue */</span>
</span><span id=__span-15-7><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>q_qnum</span><span class=p>;</span><span class=w>       </span><span class=cm>/* number of messages in queue */</span>
</span><span id=__span-15-8><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>q_qbytes</span><span class=p>;</span><span class=w>     </span><span class=cm>/* max number of bytes on queue */</span>
</span><span id=__span-15-9><span class=w>    </span><span class=kt>pid_t</span><span class=w> </span><span class=n>q_lspid</span><span class=p>;</span><span class=w>          </span><span class=cm>/* pid of last msgsnd */</span>
</span><span id=__span-15-10><span class=w>    </span><span class=kt>pid_t</span><span class=w> </span><span class=n>q_lrpid</span><span class=p>;</span><span class=w>          </span><span class=cm>/* last receive pid */</span>
</span><span id=__span-15-11>
</span><span id=__span-15-12><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>list_head</span><span class=w> </span><span class=n>q_messages</span><span class=p>;</span>
</span><span id=__span-15-13><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>list_head</span><span class=w> </span><span class=n>q_receivers</span><span class=p>;</span>
</span><span id=__span-15-14><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>list_head</span><span class=w> </span><span class=n>q_senders</span><span class=p>;</span>
</span><span id=__span-15-15><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-16-1><span class=k>struct</span><span class=w> </span><span class=nc>sem_array</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-2><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>kern_ipc_perm</span><span class=w>    </span><span class=n>sem_perm</span><span class=p>;</span><span class=w>   </span><span class=cm>/* permissions .. see ipc.h */</span>
</span><span id=__span-16-3><span class=w>    </span><span class=kt>time_t</span><span class=w>          </span><span class=n>sem_otime</span><span class=p>;</span><span class=w>  </span><span class=cm>/* last semop time */</span>
</span><span id=__span-16-4><span class=w>    </span><span class=kt>time_t</span><span class=w>          </span><span class=n>sem_ctime</span><span class=p>;</span><span class=w>  </span><span class=cm>/* last change time */</span>
</span><span id=__span-16-5><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>sem</span><span class=w>      </span><span class=o>*</span><span class=n>sem_base</span><span class=p>;</span><span class=w>  </span><span class=cm>/* ptr to first semaphore in array */</span>
</span><span id=__span-16-6><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>sem_queue</span><span class=w>    </span><span class=o>*</span><span class=n>sem_pending</span><span class=p>;</span><span class=w>   </span><span class=cm>/* pending operations to be processed */</span>
</span><span id=__span-16-7><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>sem_queue</span><span class=w>    </span><span class=o>**</span><span class=n>sem_pending_last</span><span class=p>;</span><span class=w> </span><span class=cm>/* last pending operation */</span>
</span><span id=__span-16-8><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>sem_undo</span><span class=w>     </span><span class=o>*</span><span class=n>undo</span><span class=p>;</span><span class=w>      </span><span class=cm>/* undo requests on this array */</span>
</span><span id=__span-16-9><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>long</span><span class=w>       </span><span class=n>sem_nsems</span><span class=p>;</span><span class=w>  </span><span class=cm>/* no. of semaphores in array */</span>
</span><span id=__span-16-10><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>因为每一个<code>struct ipc_ids</code>对象都有一个<code>struct kern_ipc_perm</code>成员，这个指针指向着一个动态开辟的空间，现在假设有三个资源的对象如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-17-1><span class=c1>// 共享内存</span>
</span><span id=__span-17-2><span class=k>struct</span><span class=w> </span><span class=nc>shmid_kernel</span><span class=w> </span><span class=n>shm</span><span class=p>;</span>
</span><span id=__span-17-3><span class=c1>// 消息队列</span>
</span><span id=__span-17-4><span class=k>struct</span><span class=w> </span><span class=nc>msg_queue</span><span class=w> </span><span class=n>msg</span><span class=p>;</span>
</span><span id=__span-17-5><span class=c1>// 信号量</span>
</span><span id=__span-17-6><span class=k>struct</span><span class=w> </span><span class=nc>sem_array</span><span class=w> </span><span class=n>sems</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> <p>操作系统获取到这三个对象就可以访问该对象对应的资源，即结构体中相关的成员。在C语言中，结构体的地址有一个特性：<strong>第一个成员的地址就是结构体的地址</strong>，此时操作系统就可以通过对上面三个对象进行强制类型转换使其成为<code>struct kern_ipc_perm *p</code>中的元素，例如：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-18-1><span class=c1>// 共享内存</span>
</span><span id=__span-18-2><span class=n>p</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>kern_ipc_perm</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>shm</span><span class=p>;</span>
</span><span id=__span-18-3><span class=c1>// 消息队列</span>
</span><span id=__span-18-4><span class=n>p</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>kern_ipc_perm</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>msg</span><span class=p>;</span>
</span><span id=__span-18-5><span class=c1>// 信号量</span>
</span><span id=__span-18-6><span class=n>p</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>kern_ipc_perm</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>sems</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> <p>此时操作系统就可以通过管理<code>struct kern_ipc_perm *p</code>统一对三个资源进行管理，而因为<code>struct kern_ipc_perm</code>中含有相关的成员，例如<code>key</code>，所以这个<code>key</code>实际上是一个三个资源共有的成员，也就是说三个资源都需要同一种<code>key</code></p> <p>如果此时需要通过<code>struct kern_ipc_perm *p</code>访问指定成员就可以再次通过强制转换为具体的资源访问对应资源中的其他成员：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-19-1><span class=c1>// 共享内存</span>
</span><span id=__span-19-2><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>shmid_kernel</span><span class=o>*</span><span class=p>)</span><span class=n>p</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>-&gt;</span><span class=p>...</span>
</span><span id=__span-19-3><span class=c1>// 消息队列</span>
</span><span id=__span-19-4><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>msg_queue</span><span class=o>*</span><span class=p>)</span><span class=n>p</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>-&gt;</span><span class=p>...</span>
</span><span id=__span-19-5><span class=c1>// 信号量</span>
</span><span id=__span-19-6><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>sem_array</span><span class=o>*</span><span class=p>)</span><span class=n>p</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>-&gt;</span><span class=p>...</span>
</span></code></pre></div></td></tr></table></div> <p>实际上，上面的过程就是多态的基本原理，其中<code>struct kern_ipc_perm</code>就是基类（父类），<code>struct shmid_kernel</code>、<code>struct msg_queue</code>和<code>struct sem_array</code>就是派生类（子类）</p> <h2 id=_3>再谈共享内存<a class=headerlink href=#_3 title="Permanent link">&para;</a></h2> <p>在共享内存的结构中，存在一个特殊的成员：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-20-1><span class=k>struct</span><span class=w> </span><span class=nc>shmid_kernel</span><span class=w> </span><span class=cm>/* private to the kernel */</span>
</span><span id=__span-20-2><span class=p>{</span><span class=w>   </span>
</span><span id=__span-20-3><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-20-4><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>file</span><span class=w> </span><span class=o>*</span><span class=w>       </span><span class=n>shm_file</span><span class=p>;</span>
</span><span id=__span-20-5><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-20-6><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>这个结构在文件部分也提到过，但是为什么作为内存也会存在这个结构，本质就是以为共享内存本质也是一个打开的文件，但是它并没有使用到文件的相关接口，这也是为什么他比管道的速度快，既然如此，其就需要将对应的地址映射到进程的虚拟地址空间，在进程地址空间结构的<code>vm_area_struct</code>中也存在一个结构如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-21-1><span class=k>struct</span><span class=w> </span><span class=nc>vm_area_struct</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-2><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-21-3><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>file</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>vm_file</span><span class=p>;</span><span class=w>      </span><span class=cm>/* File we map to (can be NULL). */</span>
</span><span id=__span-21-4><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-21-5><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>通过这个指针，就可以将共享内存这个文件映射到进程地址空间，而进程要访问就需要对应的起始地址和终止地址，即：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-22-1><span class=k>struct</span><span class=w> </span><span class=nc>vm_area_struct</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-2><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-22-3><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>vm_start</span><span class=p>;</span><span class=w>     </span><span class=cm>/* Our start address within vm_mm. */</span>
</span><span id=__span-22-4><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>vm_end</span><span class=p>;</span><span class=w>       </span><span class=cm>/* The first byte after our end address*/</span>
</span><span id=__span-22-5><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-22-6><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>这就是为什么共享内存可以直接使用常规的读写操作而不需要使用文件接口的原因</p> <p>同样，如果需要将用户打开的文件映射到进程地址空间，可以使用<code>mmap</code>接口：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-23-1><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=nf>mmap</span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=kt>size_t</span><span class=w> </span><span class=n>length</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>prot</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>flags</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=kt>off_t</span><span class=w> </span><span class=n>offset</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>接口中的第一个参数表示映射的地址，如果传递<code>NULL</code>表示让系统自动选择映射地址，第二个参数表示文件的大小，第三个参数表示文件的权限，第四个参数表示映射文件的类型，第五个参数为文件描述符，第六个参数为文件内容的偏移量。该接口返回映射的地址，在取消映射时需要使用</p> <p>对于第二个参数来说，其获取的方式有下面三种：</p> <ol> <li>通过<code>struct stat</code>结构中的<code>st_size</code>属性确定</li> <li>通过<code>lseek</code>获取偏移量确定</li> <li>通过<code>fseek</code>及<code>ftell</code>确定</li> </ol> <p><code>struct stat</code>结构定义如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-24-1><span class=k>struct</span><span class=w> </span><span class=nc>stat</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-2><span class=w>    </span><span class=kt>dev_t</span><span class=w>     </span><span class=n>st_dev</span><span class=p>;</span><span class=w>         </span><span class=cm>/* 设备ID */</span>
</span><span id=__span-24-3><span class=w>    </span><span class=kt>ino_t</span><span class=w>     </span><span class=n>st_ino</span><span class=p>;</span><span class=w>         </span><span class=cm>/* inode号 */</span>
</span><span id=__span-24-4><span class=w>    </span><span class=kt>mode_t</span><span class=w>    </span><span class=n>st_mode</span><span class=p>;</span><span class=w>        </span><span class=cm>/* 文件类型和权限 */</span>
</span><span id=__span-24-5><span class=w>    </span><span class=n>nlink_t</span><span class=w>   </span><span class=n>st_nlink</span><span class=p>;</span><span class=w>       </span><span class=cm>/* 硬链接数 */</span>
</span><span id=__span-24-6><span class=w>    </span><span class=kt>uid_t</span><span class=w>     </span><span class=n>st_uid</span><span class=p>;</span><span class=w>         </span><span class=cm>/* 用户ID */</span>
</span><span id=__span-24-7><span class=w>    </span><span class=kt>gid_t</span><span class=w>     </span><span class=n>st_gid</span><span class=p>;</span><span class=w>         </span><span class=cm>/* 组ID */</span>
</span><span id=__span-24-8><span class=w>    </span><span class=kt>dev_t</span><span class=w>     </span><span class=n>st_rdev</span><span class=p>;</span><span class=w>        </span><span class=cm>/* 设备类型 */</span>
</span><span id=__span-24-9><span class=w>    </span><span class=kt>off_t</span><span class=w>     </span><span class=n>st_size</span><span class=p>;</span><span class=w>        </span><span class=cm>/* 文件大小(字节) */</span>
</span><span id=__span-24-10><span class=w>    </span><span class=n>blksize_t</span><span class=w> </span><span class=n>st_blksize</span><span class=p>;</span><span class=w>     </span><span class=cm>/* 块大小 */</span>
</span><span id=__span-24-11><span class=w>    </span><span class=n>blkcnt_t</span><span class=w>  </span><span class=n>st_blocks</span><span class=p>;</span><span class=w>      </span><span class=cm>/* 分配的块数 */</span>
</span><span id=__span-24-12><span class=w>    </span><span class=kt>time_t</span><span class=w>    </span><span class=n>st_atime</span><span class=p>;</span><span class=w>       </span><span class=cm>/* 最后访问时间 */</span>
</span><span id=__span-24-13><span class=w>    </span><span class=kt>time_t</span><span class=w>    </span><span class=n>st_mtime</span><span class=p>;</span><span class=w>       </span><span class=cm>/* 最后修改时间 */</span>
</span><span id=__span-24-14><span class=w>    </span><span class=kt>time_t</span><span class=w>    </span><span class=n>st_ctime</span><span class=p>;</span><span class=w>       </span><span class=cm>/* 最后状态改变时间 */</span>
</span><span id=__span-24-15><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>后两种方式获取文件大小的代码如下：</p> <div class="tabbed-set tabbed-alternate" data-tabs=6:2><input checked=checked id=__tabbed_6_1 name=__tabbed_6 type=radio><input id=__tabbed_6_2 name=__tabbed_6 type=radio><div class=tabbed-labels><label for=__tabbed_6_1><code>lseek</code>获取</label><label for=__tabbed_6_2><code>fseek</code>及<code>ftell</code>获取</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-25-1><span class=kt>off_t</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lseek</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>SEEK_END</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-26-1><span class=n>fseek</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>SEEK_END</span><span class=p>);</span>
</span><span id=__span-26-2><span class=kt>long</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ftell</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>需要注意，如果文件已经映射到了进程的地址空间，但是文件在取消映射之前已经关闭，此时不会自动取消映射，所以关闭文件后还需要手动解除映射，可以使用<code>munmap</code>接口取消映射：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-27-1><span class=kt>int</span><span class=w> </span><span class=nf>munmap</span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=kt>size_t</span><span class=w> </span><span class=n>length</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>接口第一个参数传递映射的地址，第二个参数传递文件的大小</p> <p>例如下面使用<code>mmap</code>进行文件映射的示例代码：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-28-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;sys/mman.h&gt;</span>
</span><span id=__span-28-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;sys/stat.h&gt;</span>
</span><span id=__span-28-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;fcntl.h&gt;</span>
</span><span id=__span-28-4><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;stdio.h&gt;</span>
</span><span id=__span-28-5><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;stdlib.h&gt;</span>
</span><span id=__span-28-6><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;unistd.h&gt;</span>
</span><span id=__span-28-7>
</span><span id=__span-28-8><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-9><span class=w>    </span><span class=c1>// 打开文件</span>
</span><span id=__span-28-10><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>open</span><span class=p>(</span><span class=s>&quot;text.txt&quot;</span><span class=p>,</span><span class=w> </span><span class=n>O_RDWR</span><span class=p>);</span>
</span><span id=__span-28-11><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>fd</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>-1</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-12><span class=w>        </span><span class=n>perror</span><span class=p>(</span><span class=s>&quot;open&quot;</span><span class=p>);</span>
</span><span id=__span-28-13><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-28-14><span class=w>    </span><span class=p>}</span>
</span><span id=__span-28-15>
</span><span id=__span-28-16><span class=w>    </span><span class=c1>// 获取文件大小</span>
</span><span id=__span-28-17><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>stat</span><span class=w> </span><span class=n>sb</span><span class=p>;</span>
</span><span id=__span-28-18><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>fstat</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>sb</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>-1</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-19><span class=w>        </span><span class=n>perror</span><span class=p>(</span><span class=s>&quot;fstat&quot;</span><span class=p>);</span>
</span><span id=__span-28-20><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-28-21><span class=w>    </span><span class=p>}</span>
</span><span id=__span-28-22>
</span><span id=__span-28-23><span class=w>    </span><span class=c1>// 映射文件</span>
</span><span id=__span-28-24><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mmap</span><span class=p>(</span>
</span><span id=__span-28-25><span class=w>        </span><span class=nb>NULL</span><span class=p>,</span><span class=w>                   </span><span class=c1>// 让系统自动选择映射地址</span>
</span><span id=__span-28-26><span class=w>        </span><span class=n>sb</span><span class=p>.</span><span class=n>st_size</span><span class=p>,</span><span class=w>            </span><span class=c1>// 映射长度</span>
</span><span id=__span-28-27><span class=w>        </span><span class=n>PROT_READ</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>PROT_WRITE</span><span class=p>,</span><span class=c1>// 可读可写</span>
</span><span id=__span-28-28><span class=w>        </span><span class=n>MAP_SHARED</span><span class=p>,</span><span class=w>            </span><span class=c1>// 映射类型为共享</span>
</span><span id=__span-28-29><span class=w>        </span><span class=n>fd</span><span class=p>,</span><span class=w>                    </span><span class=c1>// 文件描述符</span>
</span><span id=__span-28-30><span class=w>        </span><span class=mi>0</span><span class=w>                      </span><span class=c1>// 偏移量</span>
</span><span id=__span-28-31><span class=w>    </span><span class=p>);</span>
</span><span id=__span-28-32>
</span><span id=__span-28-33><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>addr</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MAP_FAILED</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-34><span class=w>        </span><span class=n>perror</span><span class=p>(</span><span class=s>&quot;mmap&quot;</span><span class=p>);</span>
</span><span id=__span-28-35><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-28-36><span class=w>    </span><span class=p>}</span>
</span><span id=__span-28-37>
</span><span id=__span-28-38><span class=w>    </span><span class=c1>// 关闭文件描述符(映射仍然有效)</span>
</span><span id=__span-28-39><span class=w>    </span><span class=n>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span><span id=__span-28-40>
</span><span id=__span-28-41><span class=w>    </span><span class=c1>// 使用映射的内存</span>
</span><span id=__span-28-42><span class=w>    </span><span class=n>printf</span><span class=p>(</span><span class=s>&quot;文件内容: %s</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>,</span><span class=w> </span><span class=n>addr</span><span class=p>);</span>
</span><span id=__span-28-43>
</span><span id=__span-28-44><span class=w>    </span><span class=c1>// 解除映射</span>
</span><span id=__span-28-45><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>munmap</span><span class=p>(</span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=n>sb</span><span class=p>.</span><span class=n>st_size</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>-1</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-46><span class=w>        </span><span class=n>perror</span><span class=p>(</span><span class=s>&quot;munmap&quot;</span><span class=p>);</span>
</span><span id=__span-28-47><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-28-48><span class=w>    </span><span class=p>}</span>
</span><span id=__span-28-49>
</span><span id=__span-28-50><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-28-51><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title=最后更新> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2025年1月13日</span> </span> </aside> <form class=md-feedback name=feedback hidden> <fieldset> <legend class=md-feedback__title> 页面有帮助吗？ </legend> <div class=md-feedback__inner> <div class=md-feedback__list> <button class="md-feedback__icon md-icon" type=submit title=页面对我有帮助 data-md-value=1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 9v12H1V9zm4 12a2 2 0 0 1-2-2V9c0-.55.22-1.05.59-1.41L14.17 1l1.06 1.06c.27.27.44.64.44 1.05l-.03.32L14.69 8H21a2 2 0 0 1 2 2v2c0 .26-.05.5-.14.73l-3.02 7.05C19.54 20.5 18.83 21 18 21zm0-2h9.03L21 12v-2h-8.79l1.13-5.32L9 9.03z"/></svg> </button> <button class="md-feedback__icon md-icon" type=submit title=页面没有帮助到我 data-md-value=0> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 15V3h4v12zM15 3a2 2 0 0 1 2 2v10c0 .55-.22 1.05-.59 1.41L9.83 23l-1.06-1.06c-.27-.27-.44-.64-.44-1.06l.03-.31.95-4.57H3a2 2 0 0 1-2-2v-2c0-.26.05-.5.14-.73l3.02-7.05C4.46 3.5 5.17 3 6 3zm0 2H5.97L3 12v2h8.78l-1.13 5.32L15 14.97z"/></svg> </button> </div> <div class=md-feedback__note> <div data-md-value=1 hidden> 谢谢你的反馈！ </div> <div data-md-value=0 hidden> 谢谢你的反馈！联系<a href=https://www.help-doc.top/author/contact/contact.html>作者</a>提供更详细的信息 </div> </div> </div> </fieldset> </form> <!-- Waline 评论系统 --> <div id=waline></div> <!-- 阅读进度条 - 直接在HTML中定义 --> <div class=reading-progress></div> <!-- 滚动指示器 - 直接在HTML中定义 --> <div class=scroll-indicator></div> <!-- 评论系统 --> <!-- Waline 评论系统 --> <div id=waline></div> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <!--
  Copyright (c) 2016-2024 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!-- Footer --> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2024-2025 柯懒不是柯南 </div> </div> <div class="md-footer-love md-typeset"> 一闪一闪亮晶晶，不及<span class=love-highlight>小亮</span><span class=love-heart>♥</span>照我心。To Li Liang </div> <div class=md-social> <a href=https://github.com/H0308 target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://www.help-doc.top/author/contact/contact.html target=_blank rel=noopener title=www.help-doc.top class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M433.754 420.445c-11.526 1.393-44.86-52.741-44.86-52.741 0 31.345-16.136 72.247-51.051 101.786 16.842 5.192 54.843 19.167 45.803 34.421-7.316 12.343-125.51 7.881-159.632 4.037-34.122 3.844-152.316 8.306-159.632-4.037-9.045-15.25 28.918-29.214 45.783-34.415-34.92-29.539-51.059-70.445-51.059-101.792 0 0-33.334 54.134-44.859 52.741-5.37-.65-12.424-29.644 9.347-99.704 10.261-33.024 21.995-60.478 40.144-105.779C60.683 98.063 108.982.006 224 0c113.737.006 163.156 96.133 160.264 214.963 18.118 45.223 29.912 72.85 40.144 105.778 21.768 70.06 14.716 99.053 9.346 99.704"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["navigation.indexes", "navigation.prune", "navigation.tabs", "search.highlight", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script> <script src=../../../assets/javascripts/bundle.c8b220af.min.js></script> <script src=../../../javascripts/katex.min.js></script> <script src=../../../javascripts/other.min.js></script> <script src=../../../javascripts/copyright.min.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/contrib/auto-render.min.js></script> <script src=../../../assets/javascripts/toggle-sidebar.js async></script> <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body> </html>