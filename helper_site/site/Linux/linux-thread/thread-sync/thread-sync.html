<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://www.help-doc.top/Linux/linux-thread/thread-sync/thread-sync.html><link rel=prev href=../thread-lib/thread-lib.html><link rel=next href=../thread-semaphore/thread-semaphore.html><link rel=icon href=../../../images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.12"><title>Linux线程互斥与同步 - 柯懒的知识库</title><link rel=stylesheet href=../../../assets/stylesheets/main.2afb09e1.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.06af60db.min.css><link rel=stylesheet href=../../../css/timeline.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-9XWRGNRRSY"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-9XWRGNRRSY",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-9XWRGNRRSY",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script><link rel=stylesheet href=../../../stylesheets/colors.min.css><link rel=stylesheet href=../../../stylesheets/theme2.min.css media="screen and (max-width: 1199px)"><link rel=stylesheet href=../../../stylesheets/theme2.min.css media="screen and (min-width: 1200px)" id=theme2-desktop><link rel=stylesheet href=../../../stylesheets/theme1.min.css media="screen and (min-width: 1200px)" id=theme1-desktop><link rel=stylesheet href=../../../stylesheets/print.min.css><link rel=stylesheet href=../../../stylesheets/font-dongguanti.min.css id=font-dongguanti><link rel=stylesheet href=../../../stylesheets/font-oppoti.min.css id=font-oppoti disabled><link rel=stylesheet href=../../../stylesheets/font-jiangchengti.min.css id=font-jiangchengti disabled><link rel=stylesheet href=../../../stylesheets/font-lxgw.min.css id=font-lxgw disabled><link rel=stylesheet href=../../../stylesheets/code-font-dejavu-sans-mono.min.css id=code-font-dejavu-sans-mono><link rel=stylesheet href=../../../stylesheets/code-font-zsft-hk.min.css id=code-font-zsft-hk disabled><link rel=stylesheet href=../../../stylesheets/code-font-google-sans-code.min.css id=code-font-google-sans-code disabled><link rel=stylesheet href=https://unpkg.com/@waline/client@v3/dist/waline.css><link rel=stylesheet href=../../../stylesheets/waline.min.css><script src=../../../javascripts/start.min.js></script> <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../assets/javascripts/glightbox.min.js"></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=cyan> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#linux class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../../index.html title=柯懒的知识库 class="md-header__button md-logo" aria-label=柯懒的知识库 data-md-component=logo> <img src=../../../assets/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> 柯懒的知识库 </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Linux线程互斥与同步 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=cyan aria-label type=radio name=__palette id=__palette_1> </form> <!-- 头像元素 - 直接在HTML中定义 --> <div class=header-avatar> <img src=../../../author/作者.assets/20250206-200653.jpg alt=头像> <div class=avatar-dropdown> <p><strong>柯懒不是柯南</strong></p> <a href=../../../author/contact/contact.html class=avatar-dropdown-item>吵醒柯懒</a> <div class=avatar-dropdown-divider></div> <a href=../../../author/about/about.html class=avatar-dropdown-item>柯懒自传</a> <div class=avatar-dropdown-divider></div> <a href=https://github.com/H0308 class=avatar-dropdown-item>柯懒的零食库</a> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=查找> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <!-- 独立的切换按钮 --> <div class=toolbar-toggle-btn id=toolbarToggleBtn onclick=toggleToolbar()> <div class=toggle-icon> <svg class=toggle-arrow-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=16 height=16> <path d="M346.538667 1024L170.666667 853.333333l341.333333-341.333333-341.333333-341.333333 175.872-170.666667L853.333333 512z" fill=currentColor></path> </svg> </div> </div> <!-- 右侧固定功能条 - 独立于内容区 --> <div class=floating-toolbar id=floatingToolbar> <!-- 字体切换功能 --> <div class="toolbar-item font-switcher"> <div class=toolbar-icon> <svg class=font-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=20 height=20> <path d="M913.408 1024l-66.56 0q-29.696 0-51.2-5.12t-36.864-15.872-26.112-27.136-19.968-37.888q-15.36-38.912-28.16-70.656t-22.016-55.296q-11.264-26.624-20.48-49.152l-254.976 0q-7.168 23.552-17.408 51.2-8.192 23.552-21.504 56.832t-30.72 72.192q-20.48 46.08-47.104 63.488t-60.416 17.408l-70.656 0q-45.056 0-60.928-19.968t2.56-68.096q18.432-46.08 43.008-108.544t52.224-132.608 57.344-143.872 57.344-144.384q65.536-164.864 137.216-343.04 7.168-17.408 18.432-31.744 10.24-11.264 27.136-21.504t42.496-10.24q26.624 0 43.52 10.752t28.16 24.064q12.288 15.36 19.456 33.792 72.704 180.224 138.24 345.088 27.648 70.656 57.344 143.872t56.832 142.336 51.2 129.536 41.472 104.448q14.336 34.816 4.096 62.464t-43.008 27.648zM616.448 634.88l-97.28-347.136-1.024 0-108.544 347.136 206.848 0z" fill=currentColor></path> </svg> </div> <div class=toolbar-label>内容字体</div> <div class=font-dropdown-toolbar> <div class=font-current-toolbar onclick=toggleFontDropdownToolbar()> <span class=current-font-name-toolbar>东观体</span> <svg class=dropdown-arrow-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=12 height=12> <path d="M878.592 250.88q29.696 0 48.128 11.264t24.576 29.696 0 41.472-26.624 45.568q-82.944 92.16-159.744 180.224t-148.48 164.864q-19.456 20.48-45.568 31.744t-53.76 11.776-53.248-8.704-43.008-28.672q-39.936-44.032-82.944-90.112l-88.064-92.16q-43.008-46.08-85.504-90.624t-79.36-86.528q-17.408-19.456-22.528-40.448t1.024-38.4 23.552-28.672 45.056-11.264q35.84 0 98.816-0.512t137.728-0.512l153.6 0 150.528 0 125.952 0 79.872 0z" fill=currentColor></path> </svg> </div> <div class=font-options-toolbar> <div class=font-option-toolbar data-font=dongguanti onclick="selectFontToolbar('dongguanti')">上图东观体 </div> <div class=font-option-toolbar data-font=oppoti onclick="selectFontToolbar('oppoti')">OPPO Sans </div> <div class=font-option-toolbar data-font=jiangchengti onclick="selectFontToolbar('jiangchengti')"> 江城黑体</div> <div class=font-option-toolbar data-font=lxgw onclick="selectFontToolbar('lxgw')">霞鹜臻楷</div> </div> </div> </div> <!-- 代码字体切换功能 --> <div class="toolbar-item code-font-switcher"> <div class=toolbar-icon> <svg t=1753672111433 class="icon code-font-icon" viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg p-id=5148 width=20 height=20> <path d="M941.709938 0H82.290062A82.290062 82.290062 0 0 0 0 82.290062v859.419876A82.290062 82.290062 0 0 0 82.290062 1022.53923h859.419876A82.290062 82.290062 0 0 0 1022.53923 941.709938V82.290062A82.290062 82.290062 0 0 0 941.709938 0zM188.439372 553.631954a40.901569 40.901569 0 0 1-29.215406-70.116975L292.154066 351.558726 159.223966 218.628626a40.901569 40.901569 0 0 1 58.430813-57.94389l160.197813 162.145507a40.901569 40.901569 0 0 1 0 57.943889l-160.197813 160.684736a40.901569 40.901569 0 0 1-29.215407 12.173086z m443.587257 0H405.120304a40.901569 40.901569 0 0 1 0-82.290061H633.000476a40.901569 40.901569 0 0 1 0 82.290061z" fill=currentColor p-id=5149></path> </svg> </div> <div class=toolbar-label>代码字体</div> <div class=code-font-dropdown-toolbar> <div class=code-font-current-toolbar onclick=toggleCodeFontDropdownToolbar()> <span class=current-code-font-name-toolbar>DejaVu Sans Mono</span> <svg class=dropdown-arrow-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=12 height=12> <path d="M878.592 250.88q29.696 0 48.128 11.264t24.576 29.696 0 41.472-26.624 45.568q-82.944 92.16-159.744 180.224t-148.48 164.864q-19.456 20.48-45.568 31.744t-53.76 11.776-53.248-8.704-43.008-28.672q-39.936-44.032-82.944-90.112l-88.064-92.16q-43.008-46.08-85.504-90.624t-79.36-86.528q-17.408-19.456-22.528-40.448t1.024-38.4 23.552-28.672 45.056-11.264q35.84 0 98.816-0.512t137.728-0.512l153.6 0 150.528 0 125.952 0 79.872 0z" fill=currentColor></path> </svg> </div> <div class=code-font-options-toolbar> <div class=code-font-option-toolbar data-code-font=dejavu onclick="selectCodeFontToolbar('dejavu')"> DejaVu Sans Mono</div> <div class=code-font-option-toolbar data-code-font=google-sans-code onclick="selectCodeFontToolbar('google-sans-code')"> Google Sans Code</div> <div class=code-font-option-toolbar data-code-font=zsft onclick="selectCodeFontToolbar('zsft')"> JetBrains Mono</div> </div> </div> </div> <!-- 主题切换功能 --> <div class="toolbar-item theme-switcher" onclick=switchTheme()> <div class=toolbar-icon> <svg class=theme-icon viewbox="0 0 1024 1024" version=1.1 xmlns=http://www.w3.org/2000/svg width=20 height=20> <path d="M876.572788 522.301623c-1.886977 12.375865-9.657964 30.331819-35.880185 45.48903-56.489572 32.697703-150.21828 83.990926-174.010149 96.958262-13.143345 24.431435-66.067718 122.221646-98.141204 178.503487-16.117073 28.124548-36.055171 34.041304-50.030463 34.041304-0.031722 0-0.031722 0-0.031722 0-14.613836 0-29.1806-6.460132-43.234687-19.218714-47.183626-42.643216-125.994576-117.105115-146.013515-136.083351-27.757181-4.732791-138.338718-23.743774-200.584388-35.752272-17.924231-3.533476-32.649608-14.07046-40.372499-29.084409-5.78782-11.256368-10.281157-30.05962 1.471514-55.658647 26.989701-59.047838 74.126254-157.557432 85.957721-182.196599-3.437286-27.117614-16.996093-135.060045-23.760147-198.905142-1.886977-17.460674 3.901867-35.096333 15.829524-48.351218 12.791327-14.278191 30.667463-21.48943 49.854455-19.426445 63.669088 6.332219 173.259042 19.426445 200.584388 22.705118 24.335245-11.879562 121.085776-58.936297 180.133613-86.34146 9.91379-4.573155 19.85828-6.92369 29.596062-6.92369 28.748764 0 52.172243 20.642133 58.328453 51.421136 12.599969 62.997799 30.93864 166.70272 35.639708 193.484689 18.851347 19.682271 91.953272 96.031147 135.060045 143.07151C872.72004 487.125473 879.307062 504.71406 876.572788 522.301623L876.572788 522.301623zM825.375755 499.085876C776.017604 445.314205 687.245791 352.977193 686.365748 352.017332c-2.942005-3.069919-4.956895-6.971785-5.676279-11.208273-0.207731-1.215688-22.193465-127.001509-36.551474-198.936865-0.799202-3.917216-4.285606-16.836457-16.196891-16.836457-3.453658 0-7.30743 1.006933-11.464099 2.942005-67.282383 31.179117-183.955662 88.180342-185.170327 88.771813-3.693112 1.790786-7.850805 2.558265-11.975752 2.01489-1.295506-0.224104-133.63765-16.165168-205.988468-23.424502-0.079818 0-0.207731 0-0.287549 0-7.30743 0-11.128455 2.89391-13.319353 5.40408-3.677762 4.124947-5.644557 9.91379-5.068436 15.110139 7.674796 72.623018 24.255427 202.934922 24.463158 204.325595 0.511653 4.109598-0.159636 8.266267-1.966795 11.960403-0.591471 1.215688-57.657164 120.04712-88.339977 187.201589-3.565199 7.754614-4.41352 14.214746-2.350534 18.131963 1.935072 3.725858 6.588045 5.820566 10.360975 6.53995 70.719668 13.718443 204.644867 36.519752 206.036563 36.727483 4.189416 0.671289 8.058536 2.686179 11.112082 5.580089 1.006933 0.87902 96.414887 91.281983 150.090367 139.889027 8.314363 7.563256 13.143345 8.106632 14.437827 8.106632 3.485381 0 8.314363-4.621251 12.727882-12.391215 36.343743-63.828724 100.011808-181.988868 100.636025-183.155437 1.983167-3.64604 5.004991-6.667863 8.650007-8.650007 1.134847-0.671289 114.418936-62.373583 178.6314-99.516528 8.698103-5.036713 14.278191-10.568706 14.94948-14.854313C834.681702 511.845481 831.49922 505.800811 825.375755 499.085876L825.375755 499.085876zM935.333076 935.670256c-4.157693 4.157693-9.689686 6.299473-15.141862 6.299473-5.548366 0-11.048637-2.142803-15.238053-6.299473l-171.915441-171.915441c-8.362458-8.394181-8.362458-21.98471 0-30.426987 8.394181-8.394181 21.98471-8.394181 30.379914 0l171.915441 171.915441C943.727257 913.684522 943.727257 927.275052 935.333076 935.670256L935.333076 935.670256z" fill=currentColor></path> </svg> </div> <div class=toolbar-label>主题切换</div> </div> <!-- 返回顶部功能 --> <div class="toolbar-item back-to-top" onclick=scrollToTop()> <div class=toolbar-icon> <svg class=back-to-top-icon viewbox="0 0 1024 1024" xmlns=http://www.w3.org/2000/svg> <path d="M882.688 624.128l-336.896-583.68c-15.872-27.136-54.784-27.136-70.656 0L138.24 624.128c-15.872 27.136 4.096 61.44 35.328 61.44H317.44c22.528 0 40.96 18.432 40.96 40.96v239.616c0 22.528 18.432 40.96 40.96 40.96h223.232c22.528 0 40.96-18.432 40.96-40.96v-239.616c0-22.528 18.432-40.96 40.96-40.96h143.872c30.208 0 50.176-34.304 34.304-61.44z"> </path> </svg> </div> <div class=toolbar-label>返回顶部</div> </div> </div> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../index.html class=md-tabs__link> 主页 </a> </li> <li class=md-tabs__item> <a href=../../../intro/intro.html class=md-tabs__link> 网站介绍 </a> </li> <li class=md-tabs__item> <a href=../../../timeline/timeline.html class=md-tabs__link> 网站时间线 </a> </li> <li class=md-tabs__item> <a href=../../../languages/index.html class=md-tabs__link> 编程语言 </a> </li> <li class=md-tabs__item> <a href=../../../data-structure-algo/index.html class=md-tabs__link> 数据结构与算法 </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../index.html class=md-tabs__link> Linux </a> </li> <li class=md-tabs__item> <a href=../../../front-end/index.html class=md-tabs__link> 前端 </a> </li> <li class=md-tabs__item> <a href=../../../MySQL/index.html class=md-tabs__link> MySQL </a> </li> <li class=md-tabs__item> <a href=../../../JavaEE/index.html class=md-tabs__link> JavaEE应用开发 </a> </li> <li class=md-tabs__item> <a href=../../../other/index.html class=md-tabs__link> 扩展知识 </a> </li> <li class=md-tabs__item> <a href=../../../tooltips/index.html class=md-tabs__link> 工具帮助 </a> </li> <li class=md-tabs__item> <a href=../../../test-encrypt/test-encrypt.html class=md-tabs__link> 测试加密功能 </a> </li> <li class=md-tabs__item> <a href=../../../projects/index.html class=md-tabs__link> 项目 </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../index.html title=柯懒的知识库 class="md-nav__button md-logo" aria-label=柯懒的知识库 data-md-component=logo> <img src=../../../assets/logo.png alt=logo> </a> 柯懒的知识库 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../index.html class=md-nav__link> <span class=md-ellipsis> 主页 </span> </a> </li> <li class=md-nav__item> <a href=../../../intro/intro.html class=md-nav__link> <span class=md-ellipsis> 网站介绍 </span> </a> </li> <li class=md-nav__item> <a href=../../../timeline/timeline.html class=md-nav__link> <span class=md-ellipsis> 网站时间线 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../languages/index.html class=md-nav__link> <span class=md-ellipsis> 编程语言 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../data-structure-algo/index.html class=md-nav__link> <span class=md-ellipsis> 数据结构与算法 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6 checked> <div class="md-nav__link md-nav__container"> <a href=../../index.html class="md-nav__link "> <span class=md-ellipsis> Linux </span> </a> <label class="md-nav__link " for=__nav_6 id=__nav_6_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=true> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../options-commands/options-commands.html class=md-nav__link> <span class=md-ellipsis> Linux常用选项和指令 </span> </a> </li> <li class=md-nav__item> <a href=../../permission/permission.html class=md-nav__link> <span class=md-ellipsis> Linux权限相关 </span> </a> </li> <li class=md-nav__item> <a href=../../software-installation/software-installation.html class=md-nav__link> <span class=md-ellipsis> CentOS软件安装 </span> </a> </li> <li class=md-nav__item> <a href=../../gcc-gdb/gcc-gdb.html class=md-nav__link> <span class=md-ellipsis> Linux下的gcc与gdb </span> </a> </li> <li class=md-nav__item> <a href=../../makefile-progress-bar/makefile-progress-bar.html class=md-nav__link> <span class=md-ellipsis> Linux下的Makefile与进度条程序 </span> </a> </li> <li class=md-nav__item> <a href=../../os-basic/os-basic.html class=md-nav__link> <span class=md-ellipsis> 操作系统基础知识 </span> </a> </li> <li class=md-nav__item> <a href=../../process-basic/process-basic.html class=md-nav__link> <span class=md-ellipsis> Linux进程基础 </span> </a> </li> <li class=md-nav__item> <a href=../../process-state-priority/process-state-priority.html class=md-nav__link> <span class=md-ellipsis> Linux进程状态与进程优先级 </span> </a> </li> <li class=md-nav__item> <a href=../../process-switch-scheduling/process-switch-scheduling.html class=md-nav__link> <span class=md-ellipsis> Linux进程切换以及调度算法 </span> </a> </li> <li class=md-nav__item> <a href=../../command-line-env/command-line-env.html class=md-nav__link> <span class=md-ellipsis> Linux命令行与环境变量 </span> </a> </li> <li class=md-nav__item> <a href=../../process-address-space/process-address-space.html class=md-nav__link> <span class=md-ellipsis> Linux进程地址空间 </span> </a> </li> <li class=md-nav__item> <a href=../../process-control/process-control.html class=md-nav__link> <span class=md-ellipsis> Linux进程控制 </span> </a> </li> <li class=md-nav__item> <a href=../../linux-fileop/linux-fileop.html class=md-nav__link> <span class=md-ellipsis> Linux文件操作基础 </span> </a> </li> <li class=md-nav__item> <a href=../../io-process/io-process.html class=md-nav__link> <span class=md-ellipsis> Linux中输入和输出基本过程 </span> </a> </li> <li class=md-nav__item> <a href=../../file-system/file-system.html class=md-nav__link> <span class=md-ellipsis> Linux文件系统 </span> </a> </li> <li class=md-nav__item> <a href=../../soft-hard-link/soft-hard-link.html class=md-nav__link> <span class=md-ellipsis> Linux软链接和硬链接 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../com-process/com-anonymous-pipe/com-anonymous-pipe.html class=md-nav__link> <span class=md-ellipsis> Linux进程间通信 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../../signals-os-principles/signals-os-principles.html class=md-nav__link> <span class=md-ellipsis> Linux信号与操作系统原理 </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_20 checked> <label class=md-nav__link for=__nav_6_20 id=__nav_6_20_label tabindex=0> <span class=md-ellipsis> Linux线程 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_20_label aria-expanded=true> <label class=md-nav__title for=__nav_6_20> <span class="md-nav__icon md-icon"></span> Linux线程 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../thread-concept-op/thread-concept-op.html class=md-nav__link> <span class=md-ellipsis> Linux线程概念与线程操作 </span> </a> </li> <li class=md-nav__item> <a href=../thread-lib/thread-lib.html class=md-nav__link> <span class=md-ellipsis> Linux线程库与线程库封装 </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Linux线程互斥与同步 </span> <span class="md-nav__icon md-icon"></span> </label> <a href=thread-sync.html class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Linux线程互斥与同步 </span> </a> <nav class="md-nav md-nav--secondary" aria-label=本节目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 本节目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 前置知识 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 互斥锁（互斥量）的由来 </span> </a> </li> <li class=md-nav__item> <a href=#linux_1 class=md-nav__link> <span class=md-ellipsis> Linux下的互斥锁与封装 </span> </a> <nav class=md-nav aria-label=Linux下的互斥锁与封装> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 基本接口介绍 </span> </a> </li> <li class=md-nav__item> <a href=#pthread_mutex_initializer class=md-nav__link> <span class=md-ellipsis> 使用PTHREAD_MUTEX_INITIALIZER初始化并实现互斥 </span> </a> </li> <li class=md-nav__item> <a href=#pthread_mutex_init class=md-nav__link> <span class=md-ellipsis> 使用pthread_mutex_init初始化并实现互斥 </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 互斥之后代码运行缓慢 </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 互斥锁的基本实现原理 </span> </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> 封装互斥锁 </span> </a> <nav class=md-nav aria-label=封装互斥锁> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 对互斥锁的基本使用接口进行封装 </span> </a> </li> <li class=md-nav__item> <a href=#craii class=md-nav__link> <span class=md-ellipsis> 采用C++的RAII思想封装互斥锁的加锁和解锁 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> 同步的由来 </span> </a> </li> <li class=md-nav__item> <a href=#linux_2 class=md-nav__link> <span class=md-ellipsis> Linux下的同步与封装 </span> </a> <nav class=md-nav aria-label=Linux下的同步与封装> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_9 class=md-nav__link> <span class=md-ellipsis> 基本接口介绍 </span> </a> </li> <li class=md-nav__item> <a href=#pthread_cond_initializer class=md-nav__link> <span class=md-ellipsis> 使用PTHREAD_COND_INITIALIZER初始化并使用条件变量 </span> </a> </li> <li class=md-nav__item> <a href=#pthread_cond_init class=md-nav__link> <span class=md-ellipsis> 使用pthread_cond_init初始化并使用条件变量 </span> </a> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> <span class=md-ellipsis> 封装条件变量 </span> </a> <nav class=md-nav aria-label=封装条件变量> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_11 class=md-nav__link> <span class=md-ellipsis> 原生版 </span> </a> </li> <li class=md-nav__item> <a href=#mutex class=md-nav__link> <span class=md-ellipsis> 结合前面封装的Mutex </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../thread-semaphore/thread-semaphore.html class=md-nav__link> <span class=md-ellipsis> Linux线程与信号量 </span> </a> </li> <li class=md-nav__item> <a href=../thread-pc/thread-pc.html class=md-nav__link> <span class=md-ellipsis> 生产者消费者模型（Producer-Consumer Model） </span> </a> </li> <li class=md-nav__item> <a href=../log/log.html class=md-nav__link> <span class=md-ellipsis> 日志系统 </span> </a> </li> <li class=md-nav__item> <a href=../thread-safe-deadlock/thread-safe-deadlock.html class=md-nav__link> <span class=md-ellipsis> Linux线程安全与死锁 </span> </a> </li> <li class=md-nav__item> <a href=../thread-pool/thread-pool.html class=md-nav__link> <span class=md-ellipsis> Linux线程池 </span> </a> </li> <li class=md-nav__item> <a href=../thread-rw/thread-rw.html class=md-nav__link> <span class=md-ellipsis> 读者写者问题与读写锁 </span> </a> </li> <li class=md-nav__item> <a href=../thread-spin/thread-spin.html class=md-nav__link> <span class=md-ellipsis> 自旋锁 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../net-basic/net-basic.html class=md-nav__link> <span class=md-ellipsis> 网络基础知识 </span> </a> </li> <li class=md-nav__item> <a href=../../socket-basic/socket-basic.html class=md-nav__link> <span class=md-ellipsis> Socket编程基础 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../udp/udp-basic/udp-basic.html class=md-nav__link> <span class=md-ellipsis> UDP编程 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../../tcp-basic/tcp-basic.html class=md-nav__link> <span class=md-ellipsis> TCP编程接口基本使用 </span> </a> </li> <li class=md-nav__item> <a href=../../serialization-net-cal/serialization-net-cal.html class=md-nav__link> <span class=md-ellipsis> 序列化和反序列化与网络计算器 </span> </a> </li> <li class=md-nav__item> <a href=../../process-relationship-daemon/process-relationship-daemon.html class=md-nav__link> <span class=md-ellipsis> 进程间关系和守护进程 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../http/http-basic-httpserver/http-basic-httpserver.html class=md-nav__link> <span class=md-ellipsis> 应用层协议HTTP </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../../udp-principles/udp-principles.html class=md-nav__link> <span class=md-ellipsis> UDP协议原理 </span> </a> </li> <li class=md-nav__item> <a href=../../tcp-principles/tcp-principles.html class=md-nav__link> <span class=md-ellipsis> TCP协议原理 </span> </a> </li> <li class=md-nav__item> <a href=../../tcp-connection-backlog/tcp-connection-backlog.html class=md-nav__link> <span class=md-ellipsis> 理解Linux如何看待连接以及TCP全连接队列 </span> </a> </li> <li class=md-nav__item> <a href=../../ip/ip.html class=md-nav__link> <span class=md-ellipsis> 网络层IP协议 </span> </a> </li> <li class=md-nav__item> <a href=../../datalink/datalink.html class=md-nav__link> <span class=md-ellipsis> 数据链路层协议 </span> </a> </li> <li class=md-nav__item> <a href=../../dns-icmp/dns-icmp.html class=md-nav__link> <span class=md-ellipsis> DNS与ICMP </span> </a> </li> <li class=md-nav__item> <a href=../../nat-proxy/nat-proxy.html class=md-nav__link> <span class=md-ellipsis> NAT技术、代理服务器和内网穿透 </span> </a> </li> <li class=md-nav__item> <a href=../../io-model-select-poll/io-model-select-poll.html class=md-nav__link> <span class=md-ellipsis> 五种IO模型与select和poll分别实现多路转接 </span> </a> </li> <li class=md-nav__item> <a href=../../epoll/epoll.html class=md-nav__link> <span class=md-ellipsis> epoll实现多路转接 </span> </a> </li> <li class=md-nav__item> <a href=../../reactor-et/reactor-et.html class=md-nav__link> <span class=md-ellipsis> Reactor模式与完善基于边缘触发模式epoll实现TCP服务器 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../front-end/index.html class=md-nav__link> <span class=md-ellipsis> 前端 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../MySQL/index.html class=md-nav__link> <span class=md-ellipsis> MySQL </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../JavaEE/index.html class=md-nav__link> <span class=md-ellipsis> JavaEE应用开发 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../other/index.html class=md-nav__link> <span class=md-ellipsis> 扩展知识 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../tooltips/index.html class=md-nav__link> <span class=md-ellipsis> 工具帮助 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../test-encrypt/test-encrypt.html class=md-nav__link> <span class=md-ellipsis> 测试加密功能 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../projects/index.html class=md-nav__link> <span class=md-ellipsis> 项目 </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=本节目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 本节目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 前置知识 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 互斥锁（互斥量）的由来 </span> </a> </li> <li class=md-nav__item> <a href=#linux_1 class=md-nav__link> <span class=md-ellipsis> Linux下的互斥锁与封装 </span> </a> <nav class=md-nav aria-label=Linux下的互斥锁与封装> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 基本接口介绍 </span> </a> </li> <li class=md-nav__item> <a href=#pthread_mutex_initializer class=md-nav__link> <span class=md-ellipsis> 使用PTHREAD_MUTEX_INITIALIZER初始化并实现互斥 </span> </a> </li> <li class=md-nav__item> <a href=#pthread_mutex_init class=md-nav__link> <span class=md-ellipsis> 使用pthread_mutex_init初始化并实现互斥 </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 互斥之后代码运行缓慢 </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 互斥锁的基本实现原理 </span> </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> 封装互斥锁 </span> </a> <nav class=md-nav aria-label=封装互斥锁> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 对互斥锁的基本使用接口进行封装 </span> </a> </li> <li class=md-nav__item> <a href=#craii class=md-nav__link> <span class=md-ellipsis> 采用C++的RAII思想封装互斥锁的加锁和解锁 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> 同步的由来 </span> </a> </li> <li class=md-nav__item> <a href=#linux_2 class=md-nav__link> <span class=md-ellipsis> Linux下的同步与封装 </span> </a> <nav class=md-nav aria-label=Linux下的同步与封装> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_9 class=md-nav__link> <span class=md-ellipsis> 基本接口介绍 </span> </a> </li> <li class=md-nav__item> <a href=#pthread_cond_initializer class=md-nav__link> <span class=md-ellipsis> 使用PTHREAD_COND_INITIALIZER初始化并使用条件变量 </span> </a> </li> <li class=md-nav__item> <a href=#pthread_cond_init class=md-nav__link> <span class=md-ellipsis> 使用pthread_cond_init初始化并使用条件变量 </span> </a> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> <span class=md-ellipsis> 封装条件变量 </span> </a> <nav class=md-nav aria-label=封装条件变量> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_11 class=md-nav__link> <span class=md-ellipsis> 原生版 </span> </a> </li> <li class=md-nav__item> <a href=#mutex class=md-nav__link> <span class=md-ellipsis> 结合前面封装的Mutex </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=linux>Linux线程互斥与同步<a class=headerlink href=#linux title="Permanent link">&para;</a></h1> <div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;"> <p><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 5477 个字 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 713 行代码 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 3 张图片 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 27 分钟</p> </div> <h2 id=_1>前置知识<a class=headerlink href=#_1 title="Permanent link">&para;</a></h2> <p>在进程间通信部分已经提到过，当两个进程访问同一个资源时，这个资源就被称为是<a href=https://www.help-doc.top/Linux/com-process/com-anonymous-pipe/com-anonymous-pipe.html#_6>共享资源</a>，当这个共享资源被保护时就属于临界资源，对应的访问临界资源的代码就属于临界区。在这个概念基础之上，本节主要讨论共享资源的保护措施，在线程部分一般有两种保护措施：</p> <ol> <li>互斥：保证共享资源同一时刻只会有一个线程正在访问</li> <li>同步：在互斥的基础之上保证合理和高效</li> </ol> <h2 id=_2>互斥锁（互斥量）的由来<a class=headerlink href=#_2 title="Permanent link">&para;</a></h2> <p>互斥量是实现互斥的基本方式，对于一个没有互斥保护的共享资源，如果有多个线程同时访问该资源就会出现意外问题，例如下面的代码：</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>下面的代码用到了上一节<a href=https://www.help-doc.top/Linux/linux-thread/thread-lib/thread-lib.html#_4>封装的线程库</a></p> </div> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-0-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;vector&gt;</span>
</span><span id=__span-0-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;thread.hpp&quot;</span>
</span><span id=__span-0-4>
</span><span id=__span-0-5><span class=k>using</span><span class=w> </span><span class=k>namespace</span><span class=w> </span><span class=nn>ThreadModule</span><span class=p>;</span>
</span><span id=__span-0-6><span class=cp>#define NUM 4</span>
</span><span id=__span-0-7>
</span><span id=__span-0-8><span class=kt>int</span><span class=w> </span><span class=n>tickets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1000</span><span class=p>;</span>
</span><span id=__span-0-9>
</span><span id=__span-0-10><span class=kt>void</span><span class=w> </span><span class=nf>getTicket</span><span class=p>()</span>
</span><span id=__span-0-11><span class=p>{</span>
</span><span id=__span-0-12><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-0-13><span class=w>    </span><span class=p>{</span>
</span><span id=__span-0-14><span class=w>        </span><span class=c1>// 有票时，抢票，否则直接跳出循环</span>
</span><span id=__span-0-15><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tickets</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-0-16><span class=w>        </span><span class=p>{</span>
</span><span id=__span-0-17><span class=w>            </span><span class=n>usleep</span><span class=p>(</span><span class=mi>1000</span><span class=p>);</span>
</span><span id=__span-0-18><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;当前线程获取到一张票：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>tickets</span><span class=o>--</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-0-19><span class=w>        </span><span class=p>}</span>
</span><span id=__span-0-20><span class=w>        </span><span class=k>else</span>
</span><span id=__span-0-21><span class=w>        </span><span class=p>{</span>
</span><span id=__span-0-22><span class=w>            </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-0-23><span class=w>        </span><span class=p>}</span>
</span><span id=__span-0-24><span class=w>    </span><span class=p>}</span>
</span><span id=__span-0-25><span class=p>}</span>
</span><span id=__span-0-26>
</span><span id=__span-0-27><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-0-28><span class=p>{</span>
</span><span id=__span-0-29><span class=w>    </span><span class=c1>// 创建多个线程</span>
</span><span id=__span-0-30><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>threads</span><span class=p>;</span>
</span><span id=__span-0-31>
</span><span id=__span-0-32><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-0-33><span class=w>        </span><span class=n>threads</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>getTicket</span><span class=p>);</span>
</span><span id=__span-0-34>
</span><span id=__span-0-35><span class=w>    </span><span class=c1>// 启动多个线程</span>
</span><span id=__span-0-36><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-0-37><span class=w>        </span><span class=n>threads</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>start</span><span class=p>();</span>
</span><span id=__span-0-38>
</span><span id=__span-0-39><span class=w>    </span><span class=c1>// 等待多个线程</span>
</span><span id=__span-0-40><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-0-41><span class=w>        </span><span class=n>threads</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-0-42>
</span><span id=__span-0-43><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-0-44><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>上面代码的主要功能是实现4个线程之间进行“抢票”，这段代码看似没有任何问题，判断逻辑也正常，但是一旦运行上面的代码就会看到最终票数减到了-1和-2。此时就是问题所在，在上面的逻辑中，明明当票数小于等于0时就会走<code>break</code>，却会将票数减少到负数</p> <p>下面分析上面的代码为什么会出现问题：</p> <p>当多线程被创建后启动时，所有的线程都会看到<code>tickets</code>这个变量，当<code>tickets</code>变量值为1时，满足<code>if</code>条件进入到<code>usleep()</code>接口，当前线程就会休眠1秒，此时可能存在线程被切换的情况，假设已经被切换，那么当前线程就没有对<code>tickets</code>变量进行修改，并且因为线程切换时会保存上下文数据，所以此时这个线程看到的<code>tickets</code>依旧是1，如果刚好4个线程都是这种情况，那么就会出现4个线程全部在<code>usleep()</code>接口处</p> <p>当下一次所有线程都从<code>usleep</code>接口出来时，其上下文数据中<code>tickets</code>变量都是1，但是又因为都进入了<code>if</code>判断，所以都可以执行<code>tickets--</code>操作，所以最后<code>tickets</code>变量中的值减少到负数</p> <p>整个过程示意图如下：</p> <p><a class=glightbox href="3. Linux线程同步与互斥.assets/image-20250212165730134.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="3. Linux线程同步与互斥.assets/image-20250212165730134.png"></a></p> <p>当然，也有其他的情况导致减少到负数，例如下面的两种情况：</p> <ol> <li><code>if</code>判断为真，但是因为<code>if</code>判断并不是原子操作，导致刚结束<code>if</code>判断成立时，线程就被切换，此时线程也进入了<code>if</code>分支中</li> <li><code>tickets--</code>操作并不是原子操作，当线程刚准备进行自减操作时就被切换，此时因为<code>tickets</code>变量还是1，导致其他线程都进入了<code>if</code>分支中</li> </ol> <p>不论是哪一种原因，最后的结果都是<code>tickets</code>变量减少到了负数，为了解决这个问题，就需要考虑一种策略：当一个线程访问<code>tickets</code>变量时，其他线程不可以访问该变量。而因为<code>tickets</code>变量在整个过程中属于共享资源，所以这个策略也可以推广到：当一个线程访问共享资源时，其他线程不可以访问该共享资源，这种策略也被称为互斥锁（或互斥量，简称为互斥）</p> <p>通过上面的了解，对互斥锁下一个定义：互斥锁（Mutual exclusion，缩写：Mutex）是一种用于多线程编程中，防止多个线程同时对同一公共资源进行读写的机制</p> <h2 id=linux_1>Linux下的互斥锁与封装<a class=headerlink href=#linux_1 title="Permanent link">&para;</a></h2> <h3 id=_3>基本接口介绍<a class=headerlink href=#_3 title="Permanent link">&para;</a></h3> <p>在Linux下实现互斥需要利用到用户级线程库中的操作：</p> <ol> <li>创建互斥锁，使用<code>pthread_mutex_t</code>类型创建互斥锁变量</li> <li>初始化互斥锁，使用<code>PTHREAD_MUTEX_INITIALIZER</code>初始化互斥锁变量或者使用<code>pthread_mutex_init</code>接口进行初始化</li> <li>进入临界区之前加锁，使用<code>pthread_mutex_lock</code>接口</li> <li>出临界区进行解锁，使用<code>pthread_mutex_unlock</code>接口</li> <li>销毁互斥锁，使用<code>pthread_mutex_destroy</code>接口</li> </ol> <p>对于创建互斥锁的两种方式：如果使用<code>PTHREAD_MUTEX_INITIALIZER</code>直接初始化互斥锁变量，那么就不需要使用<code>pthread_mutex_init</code>对互斥锁变量进行初始化以及不需要使用<code>pthread_mutex_destroy</code>对互斥锁进行销毁</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>注意，不可以通过初始化赋值的形式初始化互斥锁变量</p> </div> <h3 id=pthread_mutex_initializer>使用<code>PTHREAD_MUTEX_INITIALIZER</code>初始化并实现互斥<a class=headerlink href=#pthread_mutex_initializer title="Permanent link">&para;</a></h3> <p><strong>创建并初始化互斥锁变量</strong></p> <p>因为互斥锁本质也是一种资源，并且为了确保多个线程可以访问到同一个互斥锁变量，需要将该变量设置为全局变量，即：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-1-1><span class=c1>// ...</span>
</span><span id=__span-1-2><span class=kt>int</span><span class=w> </span><span class=n>tickets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1000</span><span class=p>;</span>
</span><span id=__span-1-3><span class=n>pthread_mutex_t</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PTHREAD_MUTEX_INITIALIZER</span><span class=p>;</span>
</span><span id=__span-1-4><span class=c1>// ...</span>
</span></code></pre></div></td></tr></table></div> <p><strong>进入临界区前加锁</strong></p> <p>加锁前首先需要确定临界区，何为临界区，就是访问临界资源的代码，而临界资源就是加了保护的共享资源，所以先找到共享资源，在前面的代码中，访问的tickets变量就是共享资源，所以访问这个共享资源的代码段属于临界区，所以在<code>if</code>判断之前进行加锁</p> <p>加锁时需要使用到<code>pthread_mutex_lock</code>接口，其原型如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-2-1><span class=kt>int</span><span class=w> </span><span class=nf>pthread_mutex_lock</span><span class=p>(</span><span class=n>pthread_mutex_t</span><span class=w> </span><span class=o>*</span><span class=n>mutex</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>该接口只有一个参数，表示使用的锁对象</p> <p>针对前面的代码，使用如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-3-1><span class=c1>// 访问临界区之前加锁</span>
</span><span id=__span-3-2><span class=n>pthread_mutex_lock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-3-3><span class=k>if</span><span class=p>(</span><span class=n>tickets</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-3-4><span class=p>{</span>
</span><span id=__span-3-5><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-3-6><span class=p>}</span>
</span><span id=__span-3-7><span class=k>else</span>
</span><span id=__span-3-8><span class=p>{</span>
</span><span id=__span-3-9><span class=w>    </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-3-10><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p><strong>离开临界区后解锁</strong></p> <p>所谓理解离开临界区，就是后续的代码没有再访问共享资源，在前面的代码中对应的就是<code>else</code>语句之后，解锁使用到的接口为<code>pthread_mutex_unlock</code>，原型如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-4-1><span class=kt>int</span><span class=w> </span><span class=nf>pthread_mutex_unlock</span><span class=p>(</span><span class=n>pthread_mutex_t</span><span class=w> </span><span class=o>*</span><span class=n>mutex</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>与<code>pthread_mutex_lock</code>一样，传递一个参数，该参数表示使用的锁对象</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>需要注意，加锁和解锁必须使用同一个锁对象，否则加锁无意义</p> </div> <p>对前面的代码修改如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-5-1><span class=c1>// ...</span>
</span><span id=__span-5-2><span class=k>else</span>
</span><span id=__span-5-3><span class=p>{</span>
</span><span id=__span-5-4><span class=w>    </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-5-5><span class=p>}</span>
</span><span id=__span-5-6><span class=c1>// 离开临界区后解锁</span>
</span><span id=__span-5-7><span class=n>pthread_mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>lock</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p><strong>测试</strong></p> <p>整体代码修改如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-6-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-6-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;vector&gt;</span>
</span><span id=__span-6-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;thread.hpp&quot;</span>
</span><span id=__span-6-4>
</span><span id=__span-6-5><span class=k>using</span><span class=w> </span><span class=k>namespace</span><span class=w> </span><span class=nn>ThreadModule</span><span class=p>;</span>
</span><span id=__span-6-6><span class=cp>#define NUM 4</span>
</span><span id=__span-6-7>
</span><span id=__span-6-8><span class=kt>int</span><span class=w> </span><span class=n>tickets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1000</span><span class=p>;</span>
</span><span id=__span-6-9><span class=n>pthread_mutex_t</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PTHREAD_MUTEX_INITIALIZER</span><span class=p>;</span>
</span><span id=__span-6-10>
</span><span id=__span-6-11><span class=kt>void</span><span class=w> </span><span class=nf>getTicket</span><span class=p>()</span>
</span><span id=__span-6-12><span class=p>{</span>
</span><span id=__span-6-13><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-6-14><span class=w>    </span><span class=p>{</span>
</span><span id=__span-6-15><span class=w>        </span><span class=n>pthread_mutex_lock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-6-16><span class=w>        </span><span class=c1>// 有票时，抢票，否则直接跳出循环</span>
</span><span id=__span-6-17><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tickets</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-6-18><span class=w>        </span><span class=p>{</span>
</span><span id=__span-6-19><span class=w>            </span><span class=n>usleep</span><span class=p>(</span><span class=mi>1000</span><span class=p>);</span>
</span><span id=__span-6-20><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;当前线程获取到一张票&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>tickets</span><span class=o>--</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-6-21><span class=w>        </span><span class=p>}</span>
</span><span id=__span-6-22><span class=w>        </span><span class=k>else</span>
</span><span id=__span-6-23><span class=w>        </span><span class=p>{</span>
</span><span id=__span-6-24><span class=w>            </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-6-25><span class=w>        </span><span class=p>}</span>
</span><span id=__span-6-26><span class=w>        </span><span class=n>pthread_mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-6-27><span class=w>    </span><span class=p>}</span>
</span><span id=__span-6-28><span class=p>}</span>
</span><span id=__span-6-29>
</span><span id=__span-6-30><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-6-31><span class=p>{</span>
</span><span id=__span-6-32><span class=w>    </span><span class=c1>// 创建多个线程</span>
</span><span id=__span-6-33><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>threads</span><span class=p>;</span>
</span><span id=__span-6-34>
</span><span id=__span-6-35><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-6-36><span class=w>        </span><span class=n>threads</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>getTicket</span><span class=p>);</span>
</span><span id=__span-6-37>
</span><span id=__span-6-38><span class=w>    </span><span class=c1>// 启动多个线程</span>
</span><span id=__span-6-39><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-6-40><span class=w>        </span><span class=n>threads</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>start</span><span class=p>();</span>
</span><span id=__span-6-41>
</span><span id=__span-6-42><span class=w>    </span><span class=c1>// 等待多个线程</span>
</span><span id=__span-6-43><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-6-44><span class=w>        </span><span class=n>threads</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-6-45>
</span><span id=__span-6-46><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-6-47><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>现在再运行上面的代码即可看到<code>tickets</code>变量不会再减少负数，当没有票可以抢时，按理说所有线程进入<code>break</code>，此时主线程依次回收所有线程，整个进程结束，但是上面的代码却卡死，如下图所示：</p> <p><a class=glightbox href="3. Linux线程同步与互斥.assets\Snipaste_2025-02-12_17-48-14.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="3. Linux线程同步与互斥.assets\Snipaste_2025-02-12_17-48-14.png"></a></p> <p>出现上面这种问题，本质是因为如果一个线程当前持有锁，但是因为<code>tickets</code>小于或等于0，导致走到了<code>else</code>分支直接跳出循环，但是跳出循环时持有锁的线程并没有释放锁，导致其他线程一直处于等待锁的状态，从而导致整个进程卡死</p> <p>所以为了解决这个问题，考虑改变解锁的位置如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-7-1><span class=c1>// ...</span>
</span><span id=__span-7-2>
</span><span id=__span-7-3><span class=kt>void</span><span class=w> </span><span class=nf>getTicket</span><span class=p>()</span>
</span><span id=__span-7-4><span class=p>{</span>
</span><span id=__span-7-5><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-7-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-7-7><span class=w>        </span><span class=n>pthread_mutex_lock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-7-8><span class=w>        </span><span class=c1>// 有票时，抢票，否则直接跳出循环</span>
</span><span id=__span-7-9><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tickets</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-7-10><span class=w>        </span><span class=p>{</span>
</span><span id=__span-7-11><span class=w>            </span><span class=c1>// ...</span>
</span><span id=__span-7-12><span class=w>            </span><span class=n>pthread_mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-7-13><span class=w>        </span><span class=p>}</span>
</span><span id=__span-7-14><span class=w>        </span><span class=k>else</span>
</span><span id=__span-7-15><span class=w>        </span><span class=p>{</span>
</span><span id=__span-7-16><span class=w>            </span><span class=n>pthread_mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-7-17><span class=w>            </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-7-18><span class=w>        </span><span class=p>}</span>
</span><span id=__span-7-19><span class=w>    </span><span class=p>}</span>
</span><span id=__span-7-20><span class=p>}</span>
</span><span id=__span-7-21>
</span><span id=__span-7-22><span class=c1>// ...</span>
</span></code></pre></div></td></tr></table></div> <p>此时再运行代码即可发现问题已经解决：</p> <p><a class=glightbox href="3. Linux线程同步与互斥.assets\Snipaste_2025-02-12_17-55-06.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="3. Linux线程同步与互斥.assets\Snipaste_2025-02-12_17-55-06.png"></a></p> <h3 id=pthread_mutex_init>使用<code>pthread_mutex_init</code>初始化并实现互斥<a class=headerlink href=#pthread_mutex_init title="Permanent link">&para;</a></h3> <div class="admonition note"> <p class=admonition-title>Note</p> <p>因为实现互斥的方式和前面是一样的，所以下面只会讨论创建和销毁锁对象</p> </div> <p><strong>创建并初始化互斥锁变量</strong></p> <p>除了使用<code>PTHREAD_MUTEX_INITIALIZER</code>初始化互斥锁变量外，还可以使用<code>pthread_mutex_init</code>接口，其原型如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-8-1><span class=kt>int</span><span class=w> </span><span class=nf>pthread_mutex_init</span><span class=p>(</span><span class=n>pthread_mutex_t</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>mutex</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>pthread_mutexattr_t</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>attr</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>该接口第一个参数表示使用的锁，第二个参数表示锁属性，一般设置为<code>NULL</code>即可</p> <p>基本使用如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-9-1><span class=n>pthread_mutex_t</span><span class=w> </span><span class=n>lock</span><span class=p>;</span>
</span><span id=__span-9-2><span class=n>pthread_mutex_init</span><span class=p>(</span><span class=o>&amp;</span><span class=n>lock</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p><strong>销毁锁变量</strong></p> <p>如果使用的是<code>pthread_mutex_init</code>初始化锁变量，就需要使用<code>pthread_mutex_destroy</code>销毁锁变量，其原型如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-10-1><span class=kt>int</span><span class=w> </span><span class=nf>pthread_mutex_destroy</span><span class=p>(</span><span class=n>pthread_mutex_t</span><span class=w> </span><span class=o>*</span><span class=n>mutex</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>该接口的参数表示使用的锁</p> <p>基本使用如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-11-1><span class=n>pthread_mutex_destroy</span><span class=p>(</span><span class=o>&amp;</span><span class=n>lock</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p><strong>修改前面的代码</strong></p> <p>结合创建接口和销毁接口修改前面的代码如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-12-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-12-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;vector&gt;</span>
</span><span id=__span-12-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;thread.hpp&quot;</span>
</span><span id=__span-12-4>
</span><span id=__span-12-5><span class=k>using</span><span class=w> </span><span class=k>namespace</span><span class=w> </span><span class=nn>ThreadModule</span><span class=p>;</span>
</span><span id=__span-12-6><span class=cp>#define NUM 4</span>
</span><span id=__span-12-7>
</span><span id=__span-12-8><span class=kt>int</span><span class=w> </span><span class=n>tickets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1000</span><span class=p>;</span>
</span><span id=__span-12-9><span class=n>pthread_mutex_t</span><span class=w> </span><span class=n>lock</span><span class=p>;</span>
</span><span id=__span-12-10>
</span><span id=__span-12-11><span class=kt>void</span><span class=w> </span><span class=nf>getTicket</span><span class=p>()</span>
</span><span id=__span-12-12><span class=p>{</span>
</span><span id=__span-12-13><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-12-14><span class=w>    </span><span class=p>{</span>
</span><span id=__span-12-15><span class=w>        </span><span class=n>pthread_mutex_lock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-12-16><span class=w>        </span><span class=c1>// 有票时，抢票，否则直接跳出循环</span>
</span><span id=__span-12-17><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tickets</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-12-18><span class=w>        </span><span class=p>{</span>
</span><span id=__span-12-19><span class=w>            </span><span class=n>usleep</span><span class=p>(</span><span class=mi>1000</span><span class=p>);</span>
</span><span id=__span-12-20><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;当前线程获取到一张票&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>tickets</span><span class=o>--</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-12-21><span class=w>            </span><span class=n>pthread_mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-12-22><span class=w>        </span><span class=p>}</span>
</span><span id=__span-12-23><span class=w>        </span><span class=k>else</span>
</span><span id=__span-12-24><span class=w>        </span><span class=p>{</span>
</span><span id=__span-12-25><span class=w>            </span><span class=n>pthread_mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-12-26><span class=w>            </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-12-27><span class=w>        </span><span class=p>}</span>
</span><span id=__span-12-28><span class=w>    </span><span class=p>}</span>
</span><span id=__span-12-29><span class=p>}</span>
</span><span id=__span-12-30>
</span><span id=__span-12-31><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-12-32><span class=p>{</span>
</span><span id=__span-12-33><span class=w>    </span><span class=n>pthread_mutex_init</span><span class=p>(</span><span class=o>&amp;</span><span class=n>lock</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span>
</span><span id=__span-12-34><span class=w>    </span><span class=c1>// 创建多个线程</span>
</span><span id=__span-12-35><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>threads</span><span class=p>;</span>
</span><span id=__span-12-36>
</span><span id=__span-12-37><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-12-38><span class=w>        </span><span class=n>threads</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>getTicket</span><span class=p>);</span>
</span><span id=__span-12-39>
</span><span id=__span-12-40><span class=w>    </span><span class=c1>// 启动多个线程</span>
</span><span id=__span-12-41><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-12-42><span class=w>        </span><span class=n>threads</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>start</span><span class=p>();</span>
</span><span id=__span-12-43>
</span><span id=__span-12-44><span class=w>    </span><span class=c1>// 等待多个线程</span>
</span><span id=__span-12-45><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-12-46><span class=w>        </span><span class=n>threads</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-12-47>
</span><span id=__span-12-48><span class=w>    </span><span class=n>pthread_mutex_destroy</span><span class=p>(</span><span class=o>&amp;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-12-49>
</span><span id=__span-12-50><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-12-51><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>运行上面的代码同样可以实现正常访问临界资源</p> <h3 id=_4>互斥之后代码运行缓慢<a class=headerlink href=#_4 title="Permanent link">&para;</a></h3> <p>前面的抢票代码如果对比加锁前的代码运行速度和加锁后的代码运行速度可以发现，加锁后的代码运行速度慢了些许，主要的原因是加锁后只能保证同一时刻只有一个线程在访问临界资源，但是当有多个线程时，其他线程就需要等待正在访问临界资源的线程释放锁再抢锁才能访问临界资源，所以整体的并发性降低了，从而导致加锁后的代码整体运行缓慢</p> <h3 id=_5>互斥锁的基本实现原理<a class=headerlink href=#_5 title="Permanent link">&para;</a></h3> <p>前面提到<code>tickets</code>变量属于共享资源，并且判断<code>tickets</code>变量是否大于0和<code>tickets</code>变量自减的操作都不是原子的，所以就有可能出现在这两步执行期间出现线程切换从而出现问题，对此解决的方案是加锁，但是锁本质上也是一个共享资源，既然是共享资源，那么从前面的理解来看，锁本身也需要保护。但是实际上，操作锁的过程是原子性的，即在汇编层下只需要一条指令就可以完成，所以只存在两种状态：执行前和执行后，既然操作锁的过程本身是原子性的，那么就可以不需要对这个锁进行额外保护</p> <p>为了实现互斥锁操作，大多数体系结构都提供了<code>swap</code>或<code>exchange</code>指令，该指令的作用是把寄存器和内存单元的数据相交换，由于只有一条指令，保证了原子性，即使是多处理器平台，访问内存的总线周期也有先后，一个处理器上的交换指令执行时另一个处理器的交换指令只能等待总线周期。根据这个原理，现在把<code>lock</code>和<code>unlock</code>的伪代码改一下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-13-1><span class=nl>lock</span><span class=p>:</span>
</span><span id=__span-13-2><span class=w>    </span><span class=n>movb</span><span class=w> </span><span class=n>$0</span><span class=p>,</span><span class=w> </span><span class=o>%</span><span class=n>eax</span>
</span><span id=__span-13-3><span class=w>    </span><span class=n>xchgb</span><span class=w> </span><span class=o>%</span><span class=n>eax</span><span class=p>,</span><span class=w> </span><span class=n>mutex</span>
</span><span id=__span-13-4><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>eax寄存器的内容</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-13-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-13-6><span class=w>        </span><span class=c1>// 执行逻辑</span>
</span><span id=__span-13-7><span class=w>    </span><span class=p>}</span>
</span><span id=__span-13-8><span class=w>    </span><span class=k>else</span>
</span><span id=__span-13-9><span class=w>    </span><span class=p>{</span>
</span><span id=__span-13-10><span class=w>        </span><span class=n>挂起等待</span><span class=p>;</span>
</span><span id=__span-13-11><span class=w>    </span><span class=p>}</span>
</span><span id=__span-13-12>
</span><span id=__span-13-13><span class=w>    </span><span class=k>goto</span><span class=w> </span><span class=n>lock</span><span class=p>;</span>
</span><span id=__span-13-14>
</span><span id=__span-13-15><span class=nl>unlock</span><span class=p>:</span>
</span><span id=__span-13-16><span class=w>    </span><span class=n>movb</span><span class=w> </span><span class=n>$1</span><span class=p>,</span><span class=w> </span><span class=n>mutex</span>
</span><span id=__span-13-17><span class=w>    </span><span class=n>唤醒等待锁mutex的线程</span>
</span><span id=__span-13-18><span class=w>    </span><span class=c1>// 执行逻辑</span>
</span></code></pre></div></td></tr></table></div> <p>在上面的伪代码中，<code>lock:</code>表示下面的代码为加锁访问临界区，<code>unlock:</code>表示下面的代码离开临界区解锁</p> <p>对于<code>lock</code>来说，当执行到<code>movb $0, %eax</code>表示将数字0移动到当前线程的寄存器中，接着执行<code>xchgb %eax, mutex</code>将互斥锁<code>mutex</code>中的值（默认是1）和当前线程寄存器中的值进行交换，此时当前线程的寄存器就是1，<code>mutex</code>变量中的值就是0，接着判断当前线程寄存器的值是否是1决定是否可以执行对应的逻辑，否则就需要等待锁。当线程被操作系统唤醒时，就需要执行<code>goto lock</code>继续抢锁，重复上面的逻辑。</p> <p>对于<code>unlock</code>来说，执行<code>movb $1, mutex</code>将当前线程寄存器中的1移动到<code>mutex</code>变量中，这个操作就相当于释放锁，接着唤醒等待锁的线程即可让这些线程走到<code>goto lock</code></p> <p>上面对锁的操作之所以可以实现操作锁不需要额外保护就是因为加锁和释放锁都只是一行汇编代码，所以此时就只有执行对应汇编代码之前（没加锁或没解锁）和执行对应汇编代码之后（已加锁或已释放锁）两种状态，不论是在这两种状态的哪一种状态之前或者之后执行都不会有问题，所以操作锁不需要额外保护</p> <p>所以，互斥锁的本质就是二元信号量，其变化状态也只有两种，这也是互斥锁不允许用户进行直接赋值初始化的原因之一</p> <h3 id=_6>封装互斥锁<a class=headerlink href=#_6 title="Permanent link">&para;</a></h3> <p>本次封装互斥锁分为两步：</p> <ol> <li>对互斥锁的基本使用接口进行封装</li> <li>采用C++的RAII思想封装互斥锁的加锁和解锁</li> </ol> <h4 id=_7>对互斥锁的基本使用接口进行封装<a class=headerlink href=#_7 title="Permanent link">&para;</a></h4> <p>封装基本使用接口相对比较容易，下面是参考代码：</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>为了保证使用封装的互斥锁时始终只使用一把锁，需要保证这把锁不能被拷贝和赋值给新锁</p> </div> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-14-1><span class=k>namespace</span><span class=w> </span><span class=nn>MutexModule</span>
</span><span id=__span-14-2><span class=p>{</span>
</span><span id=__span-14-3><span class=w>    </span><span class=k>class</span><span class=w> </span><span class=nc>Mutex</span>
</span><span id=__span-14-4><span class=w>    </span><span class=p>{</span>
</span><span id=__span-14-5><span class=w>    </span><span class=k>private</span><span class=o>:</span>
</span><span id=__span-14-6><span class=w>        </span><span class=n>Mutex</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>Mutex</span><span class=w> </span><span class=o>&amp;</span><span class=n>m</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>delete</span><span class=p>;</span>
</span><span id=__span-14-7><span class=w>        </span><span class=n>Mutex</span><span class=w> </span><span class=k>operator</span><span class=o>=</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>Mutex</span><span class=w> </span><span class=o>&amp;</span><span class=n>m</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>delete</span><span class=p>;</span>
</span><span id=__span-14-8><span class=w>    </span><span class=k>public</span><span class=o>:</span>
</span><span id=__span-14-9><span class=w>        </span><span class=n>Mutex</span><span class=p>()</span>
</span><span id=__span-14-10><span class=w>        </span><span class=p>{</span>
</span><span id=__span-14-11><span class=w>            </span><span class=n>pthread_mutex_init</span><span class=p>(</span><span class=o>&amp;</span><span class=n>_mutex</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span>
</span><span id=__span-14-12><span class=w>        </span><span class=p>}</span>
</span><span id=__span-14-13>
</span><span id=__span-14-14><span class=w>        </span><span class=kt>void</span><span class=w> </span><span class=n>lock</span><span class=p>()</span>
</span><span id=__span-14-15><span class=w>        </span><span class=p>{</span>
</span><span id=__span-14-16><span class=w>            </span><span class=n>pthread_mutex_lock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>_mutex</span><span class=p>);</span>
</span><span id=__span-14-17><span class=w>        </span><span class=p>}</span>
</span><span id=__span-14-18>
</span><span id=__span-14-19><span class=w>        </span><span class=kt>void</span><span class=w> </span><span class=n>unlock</span><span class=p>()</span>
</span><span id=__span-14-20><span class=w>        </span><span class=p>{</span>
</span><span id=__span-14-21><span class=w>            </span><span class=n>pthread_mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>_mutex</span><span class=p>);</span>
</span><span id=__span-14-22><span class=w>        </span><span class=p>}</span>
</span><span id=__span-14-23>
</span><span id=__span-14-24><span class=w>        </span><span class=o>~</span><span class=n>Mutex</span><span class=p>()</span>
</span><span id=__span-14-25><span class=w>        </span><span class=p>{</span>
</span><span id=__span-14-26><span class=w>            </span><span class=n>pthread_mutex_destroy</span><span class=p>(</span><span class=o>&amp;</span><span class=n>_mutex</span><span class=p>);</span>
</span><span id=__span-14-27><span class=w>        </span><span class=p>}</span>
</span><span id=__span-14-28>
</span><span id=__span-14-29><span class=w>    </span><span class=k>private</span><span class=o>:</span>
</span><span id=__span-14-30><span class=w>        </span><span class=n>pthread_mutex_t</span><span class=w> </span><span class=n>_mutex</span><span class=p>;</span>
</span><span id=__span-14-31><span class=w>    </span><span class=p>};</span>
</span><span id=__span-14-32><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>根据上面的代码修改前面的抢票代码如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-15-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-15-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;vector&gt;</span>
</span><span id=__span-15-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;thread.hpp&quot;</span>
</span><span id=__span-15-4><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;mutex.hpp&quot;</span>
</span><span id=__span-15-5>
</span><span id=__span-15-6><span class=k>using</span><span class=w> </span><span class=k>namespace</span><span class=w> </span><span class=nn>ThreadModule</span><span class=p>;</span>
</span><span id=__span-15-7><span class=k>using</span><span class=w> </span><span class=k>namespace</span><span class=w> </span><span class=nn>MutexModule</span><span class=p>;</span>
</span><span id=__span-15-8><span class=cp>#define NUM 4</span>
</span><span id=__span-15-9>
</span><span id=__span-15-10><span class=kt>int</span><span class=w> </span><span class=n>tickets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1000</span><span class=p>;</span>
</span><span id=__span-15-11>
</span><span id=__span-15-12><span class=c1>// 创建锁对象</span>
</span><span id=__span-15-13><span class=n>Mutex</span><span class=w> </span><span class=n>lock</span><span class=p>;</span>
</span><span id=__span-15-14>
</span><span id=__span-15-15><span class=kt>void</span><span class=w> </span><span class=nf>getTicket</span><span class=p>()</span>
</span><span id=__span-15-16><span class=p>{</span>
</span><span id=__span-15-17><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-15-18><span class=w>    </span><span class=p>{</span>
</span><span id=__span-15-19><span class=w>        </span><span class=c1>// 加锁</span>
</span><span id=__span-15-20><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span>
</span><span id=__span-15-21><span class=w>        </span><span class=c1>// 有票时，抢票，否则直接跳出循环</span>
</span><span id=__span-15-22><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tickets</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-15-23><span class=w>        </span><span class=p>{</span>
</span><span id=__span-15-24><span class=w>            </span><span class=n>usleep</span><span class=p>(</span><span class=mi>1000</span><span class=p>);</span>
</span><span id=__span-15-25><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;当前线程获取到一张票&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>tickets</span><span class=o>--</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-15-26><span class=w>            </span><span class=c1>// 解锁</span>
</span><span id=__span-15-27><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
</span><span id=__span-15-28><span class=w>        </span><span class=p>}</span>
</span><span id=__span-15-29><span class=w>        </span><span class=k>else</span>
</span><span id=__span-15-30><span class=w>        </span><span class=p>{</span>
</span><span id=__span-15-31><span class=w>            </span><span class=c1>// 解锁</span>
</span><span id=__span-15-32><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
</span><span id=__span-15-33><span class=w>            </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-15-34><span class=w>        </span><span class=p>}</span>
</span><span id=__span-15-35><span class=w>    </span><span class=p>}</span>
</span><span id=__span-15-36><span class=p>}</span>
</span><span id=__span-15-37>
</span><span id=__span-15-38><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-15-39><span class=p>{</span>
</span><span id=__span-15-40><span class=w>    </span><span class=c1>// 创建多个线程</span>
</span><span id=__span-15-41><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>threads</span><span class=p>;</span>
</span><span id=__span-15-42>
</span><span id=__span-15-43><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-15-44><span class=w>        </span><span class=n>threads</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>getTicket</span><span class=p>);</span>
</span><span id=__span-15-45>
</span><span id=__span-15-46><span class=w>    </span><span class=c1>// 启动多个线程</span>
</span><span id=__span-15-47><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-15-48><span class=w>        </span><span class=n>threads</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>start</span><span class=p>();</span>
</span><span id=__span-15-49>
</span><span id=__span-15-50><span class=w>    </span><span class=c1>// 等待多个线程</span>
</span><span id=__span-15-51><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-15-52><span class=w>        </span><span class=n>threads</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-15-53>
</span><span id=__span-15-54><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-15-55><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h4 id=craii>采用C++的RAII思想封装互斥锁的加锁和解锁<a class=headerlink href=#craii title="Permanent link">&para;</a></h4> <p>RAII思想就是利用对象的生命周期对资源进行控制，而在上面的代码中，控制资源的操作就是加锁和解锁，所以只需要封装这两个操作即可，具体代码如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-16-1><span class=k>class</span><span class=w> </span><span class=nc>MutexGuard</span>
</span><span id=__span-16-2><span class=p>{</span>
</span><span id=__span-16-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-16-4><span class=w>    </span><span class=n>MutexGuard</span><span class=p>(</span><span class=n>Mutex</span><span class=w> </span><span class=o>&amp;</span><span class=n>mutex</span><span class=p>)</span>
</span><span id=__span-16-5><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=n>_mutex</span><span class=p>(</span><span class=n>mutex</span><span class=p>)</span>
</span><span id=__span-16-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-16-7><span class=w>        </span><span class=c1>// 创建对象时就自动上锁</span>
</span><span id=__span-16-8><span class=w>        </span><span class=n>_mutex</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span>
</span><span id=__span-16-9><span class=w>    </span><span class=p>}</span>
</span><span id=__span-16-10>
</span><span id=__span-16-11><span class=w>    </span><span class=o>~</span><span class=n>MutexGuard</span><span class=p>()</span>
</span><span id=__span-16-12><span class=w>    </span><span class=p>{</span>
</span><span id=__span-16-13><span class=w>        </span><span class=c1>// 销毁对象时就自动解锁</span>
</span><span id=__span-16-14><span class=w>        </span><span class=n>_mutex</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
</span><span id=__span-16-15><span class=w>    </span><span class=p>}</span>
</span><span id=__span-16-16>
</span><span id=__span-16-17><span class=k>private</span><span class=o>:</span>
</span><span id=__span-16-18><span class=w>    </span><span class=n>Mutex</span><span class=w> </span><span class=o>&amp;</span><span class=n>_mutex</span><span class=p>;</span>
</span><span id=__span-16-19><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>需要注意，在上面的代码中，为了保证多个线程访问的是同一把锁，必须在构造时使用引用，并且成员变量也必须是引用，因为在前面封装互斥锁时限制了拷贝和赋值构造函数</p> <p>此时再修改前面抢票的代码：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-17-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-17-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;vector&gt;</span>
</span><span id=__span-17-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;thread.hpp&quot;</span>
</span><span id=__span-17-4><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;mutex.hpp&quot;</span>
</span><span id=__span-17-5>
</span><span id=__span-17-6><span class=k>using</span><span class=w> </span><span class=k>namespace</span><span class=w> </span><span class=nn>ThreadModule</span><span class=p>;</span>
</span><span id=__span-17-7><span class=k>using</span><span class=w> </span><span class=k>namespace</span><span class=w> </span><span class=nn>MutexModule</span><span class=p>;</span>
</span><span id=__span-17-8><span class=cp>#define NUM 4</span>
</span><span id=__span-17-9>
</span><span id=__span-17-10><span class=kt>int</span><span class=w> </span><span class=n>tickets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1000</span><span class=p>;</span>
</span><span id=__span-17-11>
</span><span id=__span-17-12><span class=c1>// 创建锁对象</span>
</span><span id=__span-17-13><span class=n>Mutex</span><span class=w> </span><span class=n>lock</span><span class=p>;</span>
</span><span id=__span-17-14>
</span><span id=__span-17-15><span class=kt>void</span><span class=w> </span><span class=nf>getTicket</span><span class=p>()</span>
</span><span id=__span-17-16><span class=p>{</span>
</span><span id=__span-17-17><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-17-18><span class=w>    </span><span class=p>{</span>
</span><span id=__span-17-19><span class=w>        </span><span class=c1>// 加锁</span>
</span><span id=__span-17-20><span class=w>        </span><span class=n>MutexGuard</span><span class=w> </span><span class=n>lockGuard</span><span class=p>(</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-17-21><span class=w>        </span><span class=c1>// 有票时，抢票，否则直接跳出循环</span>
</span><span id=__span-17-22><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tickets</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-17-23><span class=w>        </span><span class=p>{</span>
</span><span id=__span-17-24><span class=w>            </span><span class=n>usleep</span><span class=p>(</span><span class=mi>1000</span><span class=p>);</span>
</span><span id=__span-17-25><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;当前线程获取到一张票&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>tickets</span><span class=o>--</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-17-26><span class=w>        </span><span class=p>}</span>
</span><span id=__span-17-27><span class=w>        </span><span class=k>else</span>
</span><span id=__span-17-28><span class=w>        </span><span class=p>{</span>
</span><span id=__span-17-29><span class=w>            </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-17-30><span class=w>        </span><span class=p>}</span>
</span><span id=__span-17-31><span class=w>    </span><span class=p>}</span>
</span><span id=__span-17-32><span class=p>}</span>
</span><span id=__span-17-33>
</span><span id=__span-17-34><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-17-35><span class=p>{</span>
</span><span id=__span-17-36><span class=w>    </span><span class=c1>// 创建多个线程</span>
</span><span id=__span-17-37><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>threads</span><span class=p>;</span>
</span><span id=__span-17-38>
</span><span id=__span-17-39><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-17-40><span class=w>        </span><span class=n>threads</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>getTicket</span><span class=p>);</span>
</span><span id=__span-17-41>
</span><span id=__span-17-42><span class=w>    </span><span class=c1>// 启动多个线程</span>
</span><span id=__span-17-43><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-17-44><span class=w>        </span><span class=n>threads</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>start</span><span class=p>();</span>
</span><span id=__span-17-45>
</span><span id=__span-17-46><span class=w>    </span><span class=c1>// 等待多个线程</span>
</span><span id=__span-17-47><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-17-48><span class=w>        </span><span class=n>threads</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-17-49>
</span><span id=__span-17-50><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-17-51><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>此时之所以同样可以做到对<code>tickets</code>进行保护是因为创建<code>MutexGuard</code>对象时始终使用的是同一个<code>Mutex</code>对象，一旦一个线程离开了<code>while</code>循环的代码块就会销毁<code>MutexGuard</code>对象，此时就会调用对应的解锁函数</p> <h2 id=_8>同步的由来<a class=headerlink href=#_8 title="Permanent link">&para;</a></h2> <p>前面互斥锁已经解决了共享资源被多个线程访问时的并发问题，但是现在又有一个新问题，还是基于前面的抢票场景，如果一个线程抢到了票，其执行完了抢票逻辑，就需要释放锁并且唤醒其他进程一起再抢锁，乍一看的确没有问题：所有线程都重新竞争同一把锁，然而常识告诉我们一个拥有锁的线程可以做到刚把锁放回去又抢到锁，这种情况下导致这个线程抢到锁的概率很大，其他线程就只能一直处于等待-&gt;唤醒-&gt;等待，循环往复始终无法拿到锁从而产生线程饥饿问题。所以为了解决这个问题，就需要保证某一个线程释放锁时不能再次立即拿锁，而是需要和其他线程一起抢锁，并且为了保证所有线程都可以拿到锁，还需要保证这些线程是有顺序拿到锁，这种机制就是同步</p> <p>从上面对同步的作用可以看出，同步的本质就是在原本的互斥基础上保证了运行有序和高效</p> <p>在Linux中，实现同步是通过控制条件变量的方式。所谓条件变量，就是一种基于某种条件的变量，如果这个条件成立，就允许执行，否则不允许执行，例如上面的例子，对于已经保护的<code>tickets</code>来说，如果当前有票，就代表条件成立，所有线程都可以去抢锁，否则所有线程都需要等待直到条件成立，一般情况下，这些线程在底层是按照队列的模式进行等待，即先进先出，并且释放锁的线程需要重新排到队尾与其他线程一起等待直到条件满足被唤醒。在这整个过程中，条件变量就相当于是个信号，当有资源时通知对应的线程可以开始访问，否则就必须等待</p> <h2 id=linux_2>Linux下的同步与封装<a class=headerlink href=#linux_2 title="Permanent link">&para;</a></h2> <h3 id=_9>基本接口介绍<a class=headerlink href=#_9 title="Permanent link">&para;</a></h3> <p>在Linux下实现同步需要经过下面的步骤：</p> <ol> <li>创建条件变量，使用<code>pthread_cond_t</code>类型创建条件变量</li> <li>初始化条件变量，使用<code>PTHREAD_COND_INITIALIZER</code>值或者使用<code>pthread_cond_init</code>接口进行初始化</li> <li>条件不成立时等待，使用<code>pthread_cond_wait</code>接口使指定线程等待</li> <li>条件成立时唤醒，使用<code>pthread_cond_signal</code>接口唤醒一个线程或者使用<code>pthread_cond_broadcast</code>唤醒所有线程</li> <li>销毁条件变量，使用<code>pthread_cond_destroy</code>接口进行销毁</li> </ol> <p>与互斥锁一样，如果初始化条件变量使用的是<code>PTHREAD_COND_INITIALIZER</code>就不需要使用<code>pthread_cond_init</code>再初始化以及<code>pthread_cond_destroy</code>销毁</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>注意，不可以通过初始化赋值的形式初始化条件变量</p> </div> <h3 id=pthread_cond_initializer>使用<code>PTHREAD_COND_INITIALIZER</code>初始化并使用条件变量<a class=headerlink href=#pthread_cond_initializer title="Permanent link">&para;</a></h3> <p>与互斥锁一样，为了保证多个线程可以访问到同一种条件，条件变量需要作为共享资源：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-18-1><span class=c1>// ...</span>
</span><span id=__span-18-2><span class=kt>int</span><span class=w> </span><span class=n>tickets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1000</span><span class=p>;</span>
</span><span id=__span-18-3><span class=n>pthread_mutex_t</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PTHREAD_MUTEX_INITIALIZER</span><span class=p>;</span>
</span><span id=__span-18-4><span class=n>pthread_cond_t</span><span class=w> </span><span class=n>cond</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PTHREAD_COND_INITIALIZER</span><span class=p>;</span>
</span><span id=__span-18-5><span class=c1>// ...</span>
</span></code></pre></div></td></tr></table></div> <p><strong>条件不成立时等待</strong></p> <p>在Linux下，当条件不成立时使线程等待的接口为<code>pthread_cond_wait</code>，其原型如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-19-1><span class=kt>int</span><span class=w> </span><span class=nf>pthread_cond_wait</span><span class=p>(</span><span class=n>pthread_cond_t</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>cond</span><span class=p>,</span><span class=w> </span><span class=n>pthread_mutex_t</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>mutex</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>这个接口的第一个参数表示需要使用的条件变量，第二个参数表示需要释放的锁</p> <p>在前面的抢票代码中，需要等待的情况就是没有票时，所以只需要在没有票的时候让所有线程进行等待即可，但是因为前面已经加锁，理论上来说，当一个线程进入等待就已经没有必要再抱着锁等待了，所以一个线程进入等待之前需要先释放当前拥有的锁，但是需要注意，并不需要手动调用<code>pthread_mutex_unlock</code>进行释放，因为<code>pthread_cond_wait</code>本身会先对当前线程的锁进行释放（即该接口的第二个参数），再让其进入等待队列</p> <p>另外，本次实现的逻辑是当没有票时，线程通过<code>pthread_cond_wait</code>进入等待队列进行等待，当下一次有票时再被唤醒继续抢锁买票，所以也不需要再使用<code>break</code>，代码修改如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-20-1><span class=c1>// ...</span>
</span><span id=__span-20-2><span class=k>else</span>
</span><span id=__span-20-3><span class=p>{</span>
</span><span id=__span-20-4><span class=w>    </span><span class=c1>// 条件不满足时等待</span>
</span><span id=__span-20-5><span class=w>    </span><span class=n>pthread_cond_wait</span><span class=p>(</span><span class=o>&amp;</span><span class=n>cond</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-20-6><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p><strong>条件成立时唤醒</strong></p> <p>在Linux中，在指定条件变量下唤醒一个线程可以使用<code>pthread_cond_signal</code>接口，其原型如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-21-1><span class=kt>int</span><span class=w> </span><span class=nf>pthread_cond_signal</span><span class=p>(</span><span class=n>pthread_cond_t</span><span class=w> </span><span class=o>*</span><span class=n>cond</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>该接口具有一个参数，表示指定的条件变量</p> <p>如果需要一次性唤醒所有在指定条件变量下等待的线程，可以使用<code>pthread_cond_broadcast</code>接口，其原型如下：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-22-1><span class=kt>int</span><span class=w> </span><span class=nf>pthread_cond_broadcast</span><span class=p>(</span><span class=n>pthread_cond_t</span><span class=w> </span><span class=o>*</span><span class=n>cond</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>在前面的抢票代码中，票的数量是固定的，所以本次需要对放票逻辑修改为主线程定期放票而不是程序运行时固定票数，每当主线程放票一次，就唤醒一个等待队列中的线程进行抢票即可：</p> <div class="language-c highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-23-1><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span>
</span><span id=__span-23-2><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=o>--</span><span class=p>)</span>
</span><span id=__span-23-3><span class=p>{</span>
</span><span id=__span-23-4><span class=w>    </span><span class=n>tickets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span>
</span><span id=__span-23-5><span class=w>    </span><span class=c1>// 唤醒线程</span>
</span><span id=__span-23-6><span class=w>    </span><span class=n>pthread_cond_signal</span><span class=p>(</span><span class=o>&amp;</span><span class=n>cond</span><span class=p>);</span>
</span><span id=__span-23-7><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-23-8><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p><strong>测试</strong></p> <p>整体修改的代码如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span>
<span class=normal>59</span>
<span class=normal>60</span>
<span class=normal>61</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-24-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-24-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;vector&gt;</span>
</span><span id=__span-24-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;thread.hpp&quot;</span>
</span><span id=__span-24-4>
</span><span id=__span-24-5><span class=k>using</span><span class=w> </span><span class=k>namespace</span><span class=w> </span><span class=nn>ThreadModule</span><span class=p>;</span>
</span><span id=__span-24-6><span class=cp>#define NUM 4</span>
</span><span id=__span-24-7>
</span><span id=__span-24-8><span class=kt>int</span><span class=w> </span><span class=n>tickets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-24-9><span class=n>pthread_mutex_t</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PTHREAD_MUTEX_INITIALIZER</span><span class=p>;</span>
</span><span id=__span-24-10><span class=n>pthread_cond_t</span><span class=w> </span><span class=n>cond</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PTHREAD_COND_INITIALIZER</span><span class=p>;</span>
</span><span id=__span-24-11>
</span><span id=__span-24-12><span class=kt>void</span><span class=w> </span><span class=nf>getTicket</span><span class=p>()</span>
</span><span id=__span-24-13><span class=p>{</span>
</span><span id=__span-24-14><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-24-15><span class=w>    </span><span class=p>{</span>
</span><span id=__span-24-16><span class=w>        </span><span class=n>pthread_mutex_lock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-24-17><span class=w>        </span><span class=c1>// 有票时，抢票，否则直接跳出循环</span>
</span><span id=__span-24-18><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tickets</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-24-19><span class=w>        </span><span class=p>{</span>
</span><span id=__span-24-20><span class=w>            </span><span class=n>usleep</span><span class=p>(</span><span class=mi>1000</span><span class=p>);</span>
</span><span id=__span-24-21><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;当前线程：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>pthread_self</span><span class=p>()</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>10</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;获取到一张票：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>tickets</span><span class=o>--</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-24-22><span class=w>            </span><span class=n>pthread_mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-24-23><span class=w>        </span><span class=p>}</span>
</span><span id=__span-24-24><span class=w>        </span><span class=k>else</span>
</span><span id=__span-24-25><span class=w>        </span><span class=p>{</span>
</span><span id=__span-24-26><span class=w>            </span><span class=c1>// 条件不满足时等待</span>
</span><span id=__span-24-27><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;新线程：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>pthread_self</span><span class=p>()</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>10</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;等待&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-24-28><span class=w>            </span><span class=n>pthread_cond_wait</span><span class=p>(</span><span class=o>&amp;</span><span class=n>cond</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-24-29><span class=w>        </span><span class=p>}</span>
</span><span id=__span-24-30><span class=w>    </span><span class=p>}</span>
</span><span id=__span-24-31><span class=p>}</span>
</span><span id=__span-24-32>
</span><span id=__span-24-33><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-24-34><span class=p>{</span>
</span><span id=__span-24-35><span class=w>    </span><span class=c1>// 创建多个线程</span>
</span><span id=__span-24-36><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>threads</span><span class=p>;</span>
</span><span id=__span-24-37>
</span><span id=__span-24-38><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-24-39><span class=w>        </span><span class=n>threads</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>getTicket</span><span class=p>);</span>
</span><span id=__span-24-40>
</span><span id=__span-24-41><span class=w>    </span><span class=c1>// 启动多个线程</span>
</span><span id=__span-24-42><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-24-43><span class=w>        </span><span class=n>threads</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>start</span><span class=p>();</span>
</span><span id=__span-24-44>
</span><span id=__span-24-45><span class=w>    </span><span class=c1>// 主线程放票10次，一次放票10张</span>
</span><span id=__span-24-46><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span>
</span><span id=__span-24-47><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=o>--</span><span class=p>)</span>
</span><span id=__span-24-48><span class=w>    </span><span class=p>{</span>
</span><span id=__span-24-49><span class=w>        </span><span class=n>tickets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span>
</span><span id=__span-24-50><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;主线程放票&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-24-51><span class=w>        </span><span class=c1>// 唤醒线程</span>
</span><span id=__span-24-52><span class=w>        </span><span class=n>pthread_cond_signal</span><span class=p>(</span><span class=o>&amp;</span><span class=n>cond</span><span class=p>);</span>
</span><span id=__span-24-53><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-24-54><span class=w>    </span><span class=p>}</span>
</span><span id=__span-24-55>
</span><span id=__span-24-56><span class=w>    </span><span class=c1>// 等待多个线程</span>
</span><span id=__span-24-57><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-24-58><span class=w>        </span><span class=n>threads</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>join</span><span class=p>();</span>
</span><span id=__span-24-59>
</span><span id=__span-24-60><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-24-61><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>编译运行上面的代码，预期上需要看到的效果是主线程放10张票，4个线程轮流抢到10张票，但是实际上看到的却是一个线程（可能抢到票，也可能没有抢到，取决于主线程和抢票线程哪个线程先运行）进入等待后，只剩下主进程正在放票的输出。之所以会出现这个问题是因为当等待的线程被唤醒时，<code>pthread_cond_wait</code>会让线程重新持有指定的锁，但是走完<code>else</code>后回到循环体的第一条语句时又开始执行<code>pthread_mutex_lock</code>抢锁，此时就导致持有锁的线程一直等着锁，而其他线程永远拿不到锁，所以就只有主线程一个线程在跑</p> <p>为了解决这个问题，可以考虑一种解决方案：在<code>pthread_cond_wait</code>后先释放锁，再让其去执行<code>pthread_mutex_lock</code>抢锁，代码如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-25-1><span class=c1>// ...</span>
</span><span id=__span-25-2><span class=k>else</span>
</span><span id=__span-25-3><span class=p>{</span>
</span><span id=__span-25-4><span class=w>    </span><span class=c1>// 条件不满足时等待</span>
</span><span id=__span-25-5><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;新线程：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>pthread_self</span><span class=p>()</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>1000</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;等待&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-25-6><span class=w>    </span><span class=n>pthread_cond_wait</span><span class=p>(</span><span class=o>&amp;</span><span class=n>cond</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-25-7><span class=w>    </span><span class=n>pthread_mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-25-8><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>再次运行代码即可发现4个线程已经可以轮流抢票了，但是因为当有票时一次只唤醒一个线程，所以有票的时候只有一个线程在抢票，其他线程还在等待，所以就出现了10张票被一个线程抢完的情况</p> <p><strong>优化</strong></p> <p>为了看出4个线程是按照队列的顺序依次拿票，可以先让主进程在放票前休眠一段时间，此时所有抢票线程就会都进入等待队列，当被唤醒时就可以看到唤醒的顺序和等待的顺序是一致的，另外为了保证最后进程不会卡死，所以考虑将等待的逻辑修改为取消，即主线程放票完毕后终止所有线程</p> <p>修改后的代码如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span>
<span class=normal>59</span>
<span class=normal>60</span>
<span class=normal>61</span>
<span class=normal>62</span>
<span class=normal>63</span>
<span class=normal>64</span>
<span class=normal>65</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-26-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-26-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;vector&gt;</span>
</span><span id=__span-26-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;thread.hpp&quot;</span>
</span><span id=__span-26-4>
</span><span id=__span-26-5><span class=k>using</span><span class=w> </span><span class=k>namespace</span><span class=w> </span><span class=nn>ThreadModule</span><span class=p>;</span>
</span><span id=__span-26-6><span class=cp>#define NUM 4</span>
</span><span id=__span-26-7>
</span><span id=__span-26-8><span class=kt>int</span><span class=w> </span><span class=n>tickets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-26-9><span class=n>pthread_mutex_t</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PTHREAD_MUTEX_INITIALIZER</span><span class=p>;</span>
</span><span id=__span-26-10><span class=n>pthread_cond_t</span><span class=w> </span><span class=n>cond</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PTHREAD_COND_INITIALIZER</span><span class=p>;</span>
</span><span id=__span-26-11>
</span><span id=__span-26-12><span class=kt>void</span><span class=w> </span><span class=nf>getTicket</span><span class=p>()</span>
</span><span id=__span-26-13><span class=p>{</span>
</span><span id=__span-26-14><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-26-15><span class=w>    </span><span class=p>{</span>
</span><span id=__span-26-16><span class=w>        </span><span class=n>pthread_mutex_lock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-26-17><span class=w>        </span><span class=c1>// 有票时，抢票，否则直接跳出循环</span>
</span><span id=__span-26-18><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tickets</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-26-19><span class=w>        </span><span class=p>{</span>
</span><span id=__span-26-20><span class=w>            </span><span class=n>usleep</span><span class=p>(</span><span class=mi>1000</span><span class=p>);</span>
</span><span id=__span-26-21><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;当前线程：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>pthread_self</span><span class=p>()</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>1000</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;获取到一张票：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>tickets</span><span class=o>--</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-26-22><span class=w>            </span><span class=n>pthread_mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-26-23><span class=w>        </span><span class=p>}</span>
</span><span id=__span-26-24><span class=w>        </span><span class=k>else</span>
</span><span id=__span-26-25><span class=w>        </span><span class=p>{</span>
</span><span id=__span-26-26><span class=w>            </span><span class=c1>// 条件不满足时等待</span>
</span><span id=__span-26-27><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;新线程：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>pthread_self</span><span class=p>()</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>1000</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;等待&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-26-28><span class=w>            </span><span class=n>pthread_cond_wait</span><span class=p>(</span><span class=o>&amp;</span><span class=n>cond</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-26-29><span class=w>            </span><span class=n>pthread_mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-26-30><span class=w>        </span><span class=p>}</span>
</span><span id=__span-26-31><span class=w>    </span><span class=p>}</span>
</span><span id=__span-26-32><span class=p>}</span>
</span><span id=__span-26-33>
</span><span id=__span-26-34><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-26-35><span class=p>{</span>
</span><span id=__span-26-36><span class=w>    </span><span class=c1>// 创建多个线程</span>
</span><span id=__span-26-37><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>threads</span><span class=p>;</span>
</span><span id=__span-26-38>
</span><span id=__span-26-39><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-26-40><span class=w>        </span><span class=n>threads</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>getTicket</span><span class=p>);</span>
</span><span id=__span-26-41>
</span><span id=__span-26-42><span class=w>    </span><span class=c1>// 启动多个线程</span>
</span><span id=__span-26-43><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-26-44><span class=w>        </span><span class=n>threads</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>start</span><span class=p>();</span>
</span><span id=__span-26-45>
</span><span id=__span-26-46><span class=w>    </span><span class=c1>// 主线程等待一段时间再放票，看出所有线程都在等待队列，再依次唤醒</span>
</span><span id=__span-26-47><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-26-48>
</span><span id=__span-26-49><span class=w>    </span><span class=c1>// 主线程放票10次，一次放票10张</span>
</span><span id=__span-26-50><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span>
</span><span id=__span-26-51><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=o>--</span><span class=p>)</span>
</span><span id=__span-26-52><span class=w>    </span><span class=p>{</span>
</span><span id=__span-26-53><span class=w>        </span><span class=n>tickets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span>
</span><span id=__span-26-54><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;主线程放票&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-26-55><span class=w>        </span><span class=c1>// 唤醒线程</span>
</span><span id=__span-26-56><span class=w>        </span><span class=n>pthread_cond_signal</span><span class=p>(</span><span class=o>&amp;</span><span class=n>cond</span><span class=p>);</span>
</span><span id=__span-26-57><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-26-58><span class=w>    </span><span class=p>}</span>
</span><span id=__span-26-59>
</span><span id=__span-26-60><span class=w>    </span><span class=c1>// 结束多个线程</span>
</span><span id=__span-26-61><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-26-62><span class=w>        </span><span class=n>threads</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>cancel</span><span class=p>();</span>
</span><span id=__span-26-63>
</span><span id=__span-26-64><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-26-65><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>编译运行上面的代码即可看到刚开始4个线程正在等待，紧接着当主线程放票时，第一个等待的线程被唤醒抢到10张票，第二个等待的线程被唤醒抢到10张票，以此类推，最后主线程结束所有线程</p> <h3 id=pthread_cond_init>使用<code>pthread_cond_init</code>初始化并使用条件变量<a class=headerlink href=#pthread_cond_init title="Permanent link">&para;</a></h3> <p>使用方式与互斥锁一致，不再演示</p> <h3 id=_10>封装条件变量<a class=headerlink href=#_10 title="Permanent link">&para;</a></h3> <h4 id=_11>原生版<a class=headerlink href=#_11 title="Permanent link">&para;</a></h4> <p>封装条件变量本质还是封装对应的使用接口，所以直接给出参考代码：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-27-1><span class=cp>#pragma once</span>
</span><span id=__span-27-2>
</span><span id=__span-27-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-27-4><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;pthread.h&gt;</span>
</span><span id=__span-27-5>
</span><span id=__span-27-6><span class=k>namespace</span><span class=w> </span><span class=nn>ConditionModule</span>
</span><span id=__span-27-7><span class=p>{</span>
</span><span id=__span-27-8><span class=w>    </span><span class=k>class</span><span class=w> </span><span class=nc>Condition</span>
</span><span id=__span-27-9><span class=w>    </span><span class=p>{</span>
</span><span id=__span-27-10><span class=w>    </span><span class=k>public</span><span class=o>:</span>
</span><span id=__span-27-11><span class=w>        </span><span class=n>Condition</span><span class=p>()</span>
</span><span id=__span-27-12><span class=w>        </span><span class=p>{</span>
</span><span id=__span-27-13><span class=w>            </span><span class=c1>// 初始化条件变量</span>
</span><span id=__span-27-14><span class=w>            </span><span class=n>pthread_cond_init</span><span class=p>(</span><span class=o>&amp;</span><span class=n>_cond</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span>
</span><span id=__span-27-15><span class=w>        </span><span class=p>}</span>
</span><span id=__span-27-16>
</span><span id=__span-27-17><span class=w>        </span><span class=kt>void</span><span class=w> </span><span class=n>wait</span><span class=p>(</span><span class=n>pthread_mutex_t</span><span class=w> </span><span class=o>&amp;</span><span class=n>mutex</span><span class=p>)</span>
</span><span id=__span-27-18><span class=w>        </span><span class=p>{</span>
</span><span id=__span-27-19><span class=w>            </span><span class=n>pthread_cond_wait</span><span class=p>(</span><span class=o>&amp;</span><span class=n>_cond</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>mutex</span><span class=p>);</span>
</span><span id=__span-27-20><span class=w>        </span><span class=p>}</span>
</span><span id=__span-27-21>
</span><span id=__span-27-22><span class=w>        </span><span class=kt>void</span><span class=w> </span><span class=n>notify</span><span class=p>()</span>
</span><span id=__span-27-23><span class=w>        </span><span class=p>{</span>
</span><span id=__span-27-24><span class=w>            </span><span class=c1>// 唤醒一个线程</span>
</span><span id=__span-27-25><span class=w>            </span><span class=n>pthread_cond_signal</span><span class=p>(</span><span class=o>&amp;</span><span class=n>_cond</span><span class=p>);</span>
</span><span id=__span-27-26><span class=w>        </span><span class=p>}</span>
</span><span id=__span-27-27>
</span><span id=__span-27-28><span class=w>        </span><span class=kt>void</span><span class=w> </span><span class=n>notifyAll</span><span class=p>()</span>
</span><span id=__span-27-29><span class=w>        </span><span class=p>{</span>
</span><span id=__span-27-30><span class=w>            </span><span class=c1>// 唤醒多个线程</span>
</span><span id=__span-27-31><span class=w>            </span><span class=n>pthread_cond_broadcast</span><span class=p>(</span><span class=o>&amp;</span><span class=n>_cond</span><span class=p>);</span>
</span><span id=__span-27-32><span class=w>        </span><span class=p>}</span>
</span><span id=__span-27-33>
</span><span id=__span-27-34><span class=w>        </span><span class=o>~</span><span class=n>Condition</span><span class=p>()</span>
</span><span id=__span-27-35><span class=w>        </span><span class=p>{</span>
</span><span id=__span-27-36><span class=w>            </span><span class=c1>// 销毁条件变量</span>
</span><span id=__span-27-37><span class=w>            </span><span class=n>pthread_cond_destroy</span><span class=p>(</span><span class=o>&amp;</span><span class=n>_cond</span><span class=p>);</span>
</span><span id=__span-27-38><span class=w>        </span><span class=p>}</span>
</span><span id=__span-27-39>
</span><span id=__span-27-40><span class=w>    </span><span class=k>private</span><span class=o>:</span>
</span><span id=__span-27-41><span class=w>        </span><span class=n>pthread_cond_t</span><span class=w> </span><span class=n>_cond</span><span class=p>;</span>
</span><span id=__span-27-42><span class=w>    </span><span class=p>};</span>
</span><span id=__span-27-43><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>在上面的代码中，需要注意<code>wait</code>函数，因为让线程在条件变量下等待时，<code>pthread_cond_wait</code>接口会释放线程所持有的锁，所以需要让该接口接收一个参数，用于<code>pthread_cond_wait</code>的第二个参数</p> <p><strong>测试</strong></p> <p>有了上面的封装，对前面的代码进行修改如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span>
<span class=normal>59</span>
<span class=normal>60</span>
<span class=normal>61</span>
<span class=normal>62</span>
<span class=normal>63</span>
<span class=normal>64</span>
<span class=normal>65</span>
<span class=normal>66</span>
<span class=normal>67</span>
<span class=normal>68</span>
<span class=normal>69</span>
<span class=normal>70</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-28-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;cond.hpp&quot;</span>
</span><span id=__span-28-2>
</span><span id=__span-28-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-28-4><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;vector&gt;</span>
</span><span id=__span-28-5><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;thread.hpp&quot;</span>
</span><span id=__span-28-6><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;cond.hpp&quot;</span>
</span><span id=__span-28-7>
</span><span id=__span-28-8><span class=k>using</span><span class=w> </span><span class=k>namespace</span><span class=w> </span><span class=nn>ThreadModule</span><span class=p>;</span>
</span><span id=__span-28-9><span class=k>using</span><span class=w> </span><span class=k>namespace</span><span class=w> </span><span class=nn>ConditionModule</span><span class=p>;</span>
</span><span id=__span-28-10><span class=cp>#define NUM 4</span>
</span><span id=__span-28-11>
</span><span id=__span-28-12><span class=kt>int</span><span class=w> </span><span class=n>tickets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-28-13><span class=n>pthread_mutex_t</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PTHREAD_MUTEX_INITIALIZER</span><span class=p>;</span>
</span><span id=__span-28-14><span class=c1>// pthread_cond_t cond = PTHREAD_COND_INITIALIZER;</span>
</span><span id=__span-28-15><span class=n>Condition</span><span class=w> </span><span class=n>cond</span><span class=p>;</span>
</span><span id=__span-28-16>
</span><span id=__span-28-17><span class=kt>void</span><span class=w> </span><span class=nf>getTicket</span><span class=p>()</span>
</span><span id=__span-28-18><span class=p>{</span>
</span><span id=__span-28-19><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-28-20><span class=w>    </span><span class=p>{</span>
</span><span id=__span-28-21><span class=w>        </span><span class=n>pthread_mutex_lock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-28-22><span class=w>        </span><span class=c1>// 有票时，抢票，否则直接跳出循环</span>
</span><span id=__span-28-23><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tickets</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-28-24><span class=w>        </span><span class=p>{</span>
</span><span id=__span-28-25><span class=w>            </span><span class=n>usleep</span><span class=p>(</span><span class=mi>1000</span><span class=p>);</span>
</span><span id=__span-28-26><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;当前线程：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>pthread_self</span><span class=p>()</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>1000</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;获取到一张票：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>tickets</span><span class=o>--</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-28-27><span class=w>            </span><span class=n>pthread_mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-28-28><span class=w>        </span><span class=p>}</span>
</span><span id=__span-28-29><span class=w>        </span><span class=k>else</span>
</span><span id=__span-28-30><span class=w>        </span><span class=p>{</span>
</span><span id=__span-28-31><span class=w>            </span><span class=c1>// 条件不满足时等待</span>
</span><span id=__span-28-32><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;新线程：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>pthread_self</span><span class=p>()</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>1000</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;等待&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-28-33><span class=w>            </span><span class=n>cond</span><span class=p>.</span><span class=n>wait</span><span class=p>(</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-28-34><span class=w>            </span><span class=n>pthread_mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-28-35><span class=w>        </span><span class=p>}</span>
</span><span id=__span-28-36><span class=w>    </span><span class=p>}</span>
</span><span id=__span-28-37><span class=p>}</span>
</span><span id=__span-28-38>
</span><span id=__span-28-39><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-28-40><span class=p>{</span>
</span><span id=__span-28-41><span class=w>    </span><span class=c1>// 创建多个线程</span>
</span><span id=__span-28-42><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>threads</span><span class=p>;</span>
</span><span id=__span-28-43>
</span><span id=__span-28-44><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-28-45><span class=w>        </span><span class=n>threads</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>getTicket</span><span class=p>);</span>
</span><span id=__span-28-46>
</span><span id=__span-28-47><span class=w>    </span><span class=c1>// 启动多个线程</span>
</span><span id=__span-28-48><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-28-49><span class=w>        </span><span class=n>threads</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>start</span><span class=p>();</span>
</span><span id=__span-28-50>
</span><span id=__span-28-51><span class=w>    </span><span class=c1>// 主线程等待一段时间再放票，看出所有线程都在等待队列，再依次唤醒</span>
</span><span id=__span-28-52><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-28-53>
</span><span id=__span-28-54><span class=w>    </span><span class=c1>// 主线程放票10次，一次放票10张</span>
</span><span id=__span-28-55><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span>
</span><span id=__span-28-56><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=o>--</span><span class=p>)</span>
</span><span id=__span-28-57><span class=w>    </span><span class=p>{</span>
</span><span id=__span-28-58><span class=w>        </span><span class=n>tickets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span>
</span><span id=__span-28-59><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;主线程放票&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-28-60><span class=w>        </span><span class=c1>// 唤醒线程</span>
</span><span id=__span-28-61><span class=w>        </span><span class=n>cond</span><span class=p>.</span><span class=n>notify</span><span class=p>();</span>
</span><span id=__span-28-62><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-28-63><span class=w>    </span><span class=p>}</span>
</span><span id=__span-28-64>
</span><span id=__span-28-65><span class=w>    </span><span class=c1>// 结束多个线程</span>
</span><span id=__span-28-66><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-28-67><span class=w>        </span><span class=n>threads</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>cancel</span><span class=p>();</span>
</span><span id=__span-28-68>
</span><span id=__span-28-69><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-28-70><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h4 id=mutex>结合前面封装的<code>Mutex</code><a class=headerlink href=#mutex title="Permanent link">&para;</a></h4> <p>在封装的条件变量中唯一需要用到<code>Mutex</code>对象的位置就是让线程等待的接口，并且该接口需要用到锁成员的地址，所以此时还需要在<code>Mutex</code>中提供一个返回锁成员地址的接口：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-29-1><span class=n>pthread_mutex_t</span><span class=w> </span><span class=o>*</span><span class=nf>getLockAddress</span><span class=p>()</span>
</span><span id=__span-29-2><span class=p>{</span>
</span><span id=__span-29-3><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=n>_mutex</span><span class=p>;</span>
</span><span id=__span-29-4><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>对封装的条件变量的<code>wait</code>函数修改如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-30-1><span class=kt>void</span><span class=w> </span><span class=nf>wait</span><span class=p>(</span><span class=n>Mutex</span><span class=w> </span><span class=o>&amp;</span><span class=n>mutex</span><span class=p>)</span>
</span><span id=__span-30-2><span class=p>{</span>
</span><span id=__span-30-3><span class=w>    </span><span class=n>pthread_cond_wait</span><span class=p>(</span><span class=o>&amp;</span><span class=n>_cond</span><span class=p>,</span><span class=w> </span><span class=n>mutex</span><span class=p>.</span><span class=n>getLockAddress</span><span class=p>());</span>
</span><span id=__span-30-4><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p><strong>测试</strong></p> <p>有了上面的封装，对前面的代码进行修改如下：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span>
<span class=normal>59</span>
<span class=normal>60</span>
<span class=normal>61</span>
<span class=normal>62</span>
<span class=normal>63</span>
<span class=normal>64</span>
<span class=normal>65</span>
<span class=normal>66</span>
<span class=normal>67</span>
<span class=normal>68</span>
<span class=normal>69</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-31-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;cond.hpp&quot;</span>
</span><span id=__span-31-2>
</span><span id=__span-31-3><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-31-4><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;vector&gt;</span>
</span><span id=__span-31-5><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;thread.hpp&quot;</span>
</span><span id=__span-31-6><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;cond.hpp&quot;</span>
</span><span id=__span-31-7><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;mutex.hpp&quot;</span>
</span><span id=__span-31-8>
</span><span id=__span-31-9><span class=k>using</span><span class=w> </span><span class=k>namespace</span><span class=w> </span><span class=nn>ThreadModule</span><span class=p>;</span>
</span><span id=__span-31-10><span class=k>using</span><span class=w> </span><span class=k>namespace</span><span class=w> </span><span class=nn>ConditionModule</span><span class=p>;</span>
</span><span id=__span-31-11><span class=k>using</span><span class=w> </span><span class=k>namespace</span><span class=w> </span><span class=nn>MutexModule</span><span class=p>;</span>
</span><span id=__span-31-12><span class=cp>#define NUM 4</span>
</span><span id=__span-31-13>
</span><span id=__span-31-14><span class=kt>int</span><span class=w> </span><span class=n>tickets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-31-15><span class=n>Mutex</span><span class=w> </span><span class=n>lock</span><span class=p>;</span>
</span><span id=__span-31-16><span class=n>Condition</span><span class=w> </span><span class=n>cond</span><span class=p>;</span>
</span><span id=__span-31-17>
</span><span id=__span-31-18><span class=kt>void</span><span class=w> </span><span class=nf>getTicket</span><span class=p>()</span>
</span><span id=__span-31-19><span class=p>{</span>
</span><span id=__span-31-20><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-31-21><span class=w>    </span><span class=p>{</span>
</span><span id=__span-31-22><span class=w>        </span><span class=n>MutexGuard</span><span class=w> </span><span class=n>mutex</span><span class=p>(</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-31-23><span class=w>        </span><span class=c1>// 有票时，抢票，否则直接跳出循环</span>
</span><span id=__span-31-24><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tickets</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-31-25><span class=w>        </span><span class=p>{</span>
</span><span id=__span-31-26><span class=w>            </span><span class=n>usleep</span><span class=p>(</span><span class=mi>1000</span><span class=p>);</span>
</span><span id=__span-31-27><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;当前线程：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>pthread_self</span><span class=p>()</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>1000</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;获取到一张票：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>tickets</span><span class=o>--</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-31-28><span class=w>        </span><span class=p>}</span>
</span><span id=__span-31-29><span class=w>        </span><span class=k>else</span>
</span><span id=__span-31-30><span class=w>        </span><span class=p>{</span>
</span><span id=__span-31-31><span class=w>            </span><span class=c1>// 条件不满足时等待</span>
</span><span id=__span-31-32><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;新线程：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>pthread_self</span><span class=p>()</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>1000</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;等待&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-31-33><span class=w>            </span><span class=n>cond</span><span class=p>.</span><span class=n>wait</span><span class=p>(</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-31-34><span class=w>        </span><span class=p>}</span>
</span><span id=__span-31-35><span class=w>    </span><span class=p>}</span>
</span><span id=__span-31-36><span class=p>}</span>
</span><span id=__span-31-37>
</span><span id=__span-31-38><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-31-39><span class=p>{</span>
</span><span id=__span-31-40><span class=w>    </span><span class=c1>// 创建多个线程</span>
</span><span id=__span-31-41><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>threads</span><span class=p>;</span>
</span><span id=__span-31-42>
</span><span id=__span-31-43><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-31-44><span class=w>        </span><span class=n>threads</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>getTicket</span><span class=p>);</span>
</span><span id=__span-31-45>
</span><span id=__span-31-46><span class=w>    </span><span class=c1>// 启动多个线程</span>
</span><span id=__span-31-47><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-31-48><span class=w>        </span><span class=n>threads</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>start</span><span class=p>();</span>
</span><span id=__span-31-49>
</span><span id=__span-31-50><span class=w>    </span><span class=c1>// 主线程等待一段时间再放票，看出所有线程都在等待队列，再依次唤醒</span>
</span><span id=__span-31-51><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-31-52>
</span><span id=__span-31-53><span class=w>    </span><span class=c1>// 主线程放票10次，一次放票10张</span>
</span><span id=__span-31-54><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span>
</span><span id=__span-31-55><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=o>--</span><span class=p>)</span>
</span><span id=__span-31-56><span class=w>    </span><span class=p>{</span>
</span><span id=__span-31-57><span class=w>        </span><span class=n>tickets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span>
</span><span id=__span-31-58><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;主线程放票&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-31-59><span class=w>        </span><span class=c1>// 唤醒线程</span>
</span><span id=__span-31-60><span class=w>        </span><span class=n>cond</span><span class=p>.</span><span class=n>notify</span><span class=p>();</span>
</span><span id=__span-31-61><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-31-62><span class=w>    </span><span class=p>}</span>
</span><span id=__span-31-63>
</span><span id=__span-31-64><span class=w>    </span><span class=c1>// 结束多个线程</span>
</span><span id=__span-31-65><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NUM</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-31-66><span class=w>        </span><span class=n>threads</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>cancel</span><span class=p>();</span>
</span><span id=__span-31-67>
</span><span id=__span-31-68><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-31-69><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>需要注意，在抢票逻辑的死循环中创建的<code>MutexGuard</code>对象会在每一次循环迭代时重新创建，也就是说，该对象会在本次循环体结束时（即进入下一次循环时）被析构，从而释放锁，所以不会出现前面提到的「只有主进程正在放票的输出」</p> </div> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title=最后更新> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2025年2月13日</span> </span> </aside> <form class=md-feedback name=feedback hidden> <fieldset> <legend class=md-feedback__title> 页面有帮助吗？ </legend> <div class=md-feedback__inner> <div class=md-feedback__list> <button class="md-feedback__icon md-icon" type=submit title=页面对我有帮助 data-md-value=1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 9v12H1V9zm4 12a2 2 0 0 1-2-2V9c0-.55.22-1.05.59-1.41L14.17 1l1.06 1.06c.27.27.44.64.44 1.05l-.03.32L14.69 8H21a2 2 0 0 1 2 2v2c0 .26-.05.5-.14.73l-3.02 7.05C19.54 20.5 18.83 21 18 21zm0-2h9.03L21 12v-2h-8.79l1.13-5.32L9 9.03z"/></svg> </button> <button class="md-feedback__icon md-icon" type=submit title=页面没有帮助到我 data-md-value=0> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 15V3h4v12zM15 3a2 2 0 0 1 2 2v10c0 .55-.22 1.05-.59 1.41L9.83 23l-1.06-1.06c-.27-.27-.44-.64-.44-1.06l.03-.31.95-4.57H3a2 2 0 0 1-2-2v-2c0-.26.05-.5.14-.73l3.02-7.05C4.46 3.5 5.17 3 6 3zm0 2H5.97L3 12v2h8.78l-1.13 5.32L15 14.97z"/></svg> </button> </div> <div class=md-feedback__note> <div data-md-value=1 hidden> 谢谢你的反馈！ </div> <div data-md-value=0 hidden> 谢谢你的反馈！联系<a href=https://www.help-doc.top/author/contact/contact.html>作者</a>提供更详细的信息 </div> </div> </div> </fieldset> </form> <!-- Waline 评论系统 --> <div id=waline></div> <!-- 阅读进度条 - 直接在HTML中定义 --> <div class=reading-progress></div> <!-- 滚动指示器 - 直接在HTML中定义 --> <div class=scroll-indicator></div> <!-- 评论系统 --> <!-- Waline 评论系统 --> <div id=waline></div> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2024-2025 柯懒不是柯南 </div> </div> <div class="md-footer-love md-typeset"> 一闪一闪亮晶晶，不及<span class=love-highlight>小亮</span><span class=love-heart>♥</span>照我心。To Li Liang </div> <div class=md-social> <a href=https://github.com/H0308 target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://www.help-doc.top/author/contact/contact.html target=_blank rel=noopener title=www.help-doc.top class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M433.754 420.445c-11.526 1.393-44.86-52.741-44.86-52.741 0 31.345-16.136 72.247-51.051 101.786 16.842 5.192 54.843 19.167 45.803 34.421-7.316 12.343-125.51 7.881-159.632 4.037-34.122 3.844-152.316 8.306-159.632-4.037-9.045-15.25 28.918-29.214 45.783-34.415-34.92-29.539-51.059-70.445-51.059-101.792 0 0-33.334 54.134-44.859 52.741-5.37-.65-12.424-29.644 9.347-99.704 10.261-33.024 21.995-60.478 40.144-105.779C60.683 98.063 108.982.006 224 0c113.737.006 163.156 96.133 160.264 214.963 18.118 45.223 29.912 72.85 40.144 105.778 21.768 70.06 14.716 99.053 9.346 99.704"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["navigation.indexes", "navigation.prune", "navigation.tabs", "search.highlight", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script> <script src=../../../assets/javascripts/bundle.c8b220af.min.js></script> <script src=../../../javascripts/katex.min.js></script> <script src=../../../javascripts/other.min.js></script> <script src=../../../javascripts/copyright.min.js></script> <script src=../../../javascripts/waline.min.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/contrib/auto-render.min.js></script> <script src=https://cdn.jsdelivr.net/npm/mermaid@11.5.0/dist/mermaid.min.js></script> <script src=../../../assets/javascripts/toggle-sidebar.js async></script> <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body> </html>