(function(){let previewBox=null;let currentLink=null;let currentUrl=null;let justExpanded=false;let scrollPosition=0;function createPreviewBox(){const overlay=document.createElement('div');overlay.className='link-preview-overlay';overlay.addEventListener('click',function(){if(previewBox&&!previewBox.classList.contains('collapsed')){hidePreview();}});document.body.appendChild(overlay);const box=document.createElement('div');box.className='link-preview-box';box.innerHTML=`
            <div class="link-preview-resizer"></div>
            <div class="link-preview-expand-trigger">
                <button class="link-preview-expand-btn" aria-label="展开预览" title="展开预览">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>
            </div>
            <div class="link-preview-content">
                <div class="link-preview-header">
                    <span class="link-preview-title">页面预览</span>
                    <div class="link-preview-actions">
                        <button class="link-preview-open" aria-label="在新标签页打开" title="在新标签页打开">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                <polyline points="15 3 21 3 21 9"></polyline>
                                <line x1="10" y1="14" x2="21" y2="3"></line>
                            </svg>
                        </button>
                        <button class="link-preview-collapse" aria-label="收起预览" title="收起预览">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </button>
                        <button class="link-preview-close" aria-label="关闭预览" title="关闭预览">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="link-preview-loading">加载中...</div>
                <iframe class="link-preview-iframe" sandbox="allow-same-origin allow-scripts allow-popups allow-forms"></iframe>
            </div>
        `;document.body.appendChild(box);box.addEventListener('touchmove',function(e){e.stopPropagation();},{passive:false});const content=box.querySelector('.link-preview-content');content.addEventListener('touchmove',function(e){e.stopPropagation();},{passive:false});box.addEventListener('wheel',function(e){e.stopPropagation();},{passive:true,capture:true});box.querySelector('.link-preview-close').addEventListener('click',hidePreview);box.querySelector('.link-preview-open').addEventListener('click',function(){if(currentUrl){window.open(currentUrl,'_blank');}});const collapseBtn=box.querySelector('.link-preview-collapse');collapseBtn.addEventListener('click',function(){const isCollapsed=box.classList.contains('collapsed');if(isCollapsed){box.classList.remove('collapsed');collapseBtn.setAttribute('aria-label','收起预览');collapseBtn.setAttribute('title','收起预览');collapseBtn.querySelector('svg').innerHTML='<polyline points="9 18 15 12 9 6"></polyline>';}else{box.classList.add('collapsed');collapseBtn.setAttribute('aria-label','展开预览');collapseBtn.setAttribute('title','展开预览');collapseBtn.querySelector('svg').innerHTML='<polyline points="15 18 9 12 15 6"></polyline>';}});const expandTrigger=box.querySelector('.link-preview-expand-trigger');expandTrigger.addEventListener('click',function(e){e.preventDefault();e.stopPropagation();box.classList.remove('collapsed');collapseBtn.setAttribute('aria-label','收起预览');collapseBtn.setAttribute('title','收起预览');collapseBtn.querySelector('svg').innerHTML='<polyline points="9 18 15 12 9 6"></polyline>';justExpanded=true;setTimeout(()=>{justExpanded=false;},500);});initResizer(box);return box;}
function initResizer(box){const resizer=box.querySelector('.link-preview-resizer');let isResizing=false;const handleMouseDown=function(e){isResizing=true;box.style.transition='none';document.body.style.cursor='ew-resize';document.body.style.userSelect='none';const iframe=box.querySelector('.link-preview-iframe');if(iframe){iframe.style.pointerEvents='none';}
e.preventDefault();e.stopPropagation();};const handleMouseMove=function(e){if(!isResizing)return;const newWidth=window.innerWidth-e.clientX;const minWidth=200;const maxWidth=window.innerWidth*0.9;const clampedWidth=Math.max(minWidth,Math.min(maxWidth,newWidth));box.style.width=clampedWidth+'px';e.preventDefault();e.stopPropagation();};const handleMouseUp=function(e){if(!isResizing)return;isResizing=false;document.body.style.cursor='';document.body.style.userSelect='';box.style.transition='';const iframe=box.querySelector('.link-preview-iframe');if(iframe){iframe.style.pointerEvents='';}
e.preventDefault();e.stopPropagation();};resizer.addEventListener('mousedown',handleMouseDown);document.addEventListener('mousemove',handleMouseMove);document.addEventListener('mouseup',handleMouseUp);}
function showPreview(url,linkElement){if(!previewBox){previewBox=createPreviewBox();}
currentLink=linkElement;currentUrl=url;const iframe=previewBox.querySelector('.link-preview-iframe');const loading=previewBox.querySelector('.link-preview-loading');const overlay=document.querySelector('.link-preview-overlay');iframe.style.display='none';loading.style.display='flex';loading.className='link-preview-loading';loading.innerHTML='加载中...';iframe.src='';if(overlay){overlay.classList.add('active');}
previewBox.classList.add('active');if(window.innerWidth<=768){scrollPosition=window.pageYOffset||document.documentElement.scrollTop;document.body.style.overflow='hidden';document.body.style.position='fixed';document.body.style.top=`-${scrollPosition}px`;document.body.style.width='100%';}
setTimeout(()=>{iframe.src=url;},50);let loadTimeout=setTimeout(()=>{if(iframe.style.display==='none'){showError(loading);}},15000);iframe.onload=function(){clearTimeout(loadTimeout);setTimeout(()=>{loading.style.display='none';iframe.style.display='block';},100);};iframe.onerror=function(){clearTimeout(loadTimeout);showError(loading);};}
function showError(loadingElement){loadingElement.className='link-preview-loading link-preview-error';loadingElement.innerHTML=`
            <svg class="error-icon" viewBox="0 0 24 24" width="48" height="48">
                <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
                <path d="M12 8v4M12 16h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <div class="error-text">网页无法访问或禁止嵌入预览</div>
            <div class="error-hint">请点击链接直接访问</div>
        `;}
function hidePreview(){const overlay=document.querySelector('.link-preview-overlay');if(previewBox){previewBox.classList.remove('active');previewBox.classList.remove('collapsed');}
if(overlay){overlay.classList.remove('active');}
if(window.innerWidth<=768){document.body.style.overflow='';document.body.style.position='';document.body.style.top='';document.body.style.width='';window.scrollTo(0,scrollPosition);}
currentLink=null;currentUrl=null;setTimeout(()=>{const iframe=previewBox&&previewBox.querySelector('.link-preview-iframe');if(iframe){iframe.src='';}},400);}
function isValidLink(link){const href=link.getAttribute('href');if(!href)return false;if(href.startsWith('#')||href.startsWith('javascript:')||href.startsWith('mailto:')||href.startsWith('tel:')){return false;}
return true;}
function getFullUrl(link){const href=link.getAttribute('href');if(!href)return null;if(href.startsWith('http://')||href.startsWith('https://')){return href;}
try{return new URL(href,window.location.href).href;}catch(e){return null;}}
function initLinkListeners(){const contentArea=document.querySelector('.md-content');if(!contentArea)return;contentArea.addEventListener('click',function(e){const link=e.target.closest('a');if(!link)return;if(link.closest('.link-preview-box'))return;if(link.closest('.tabbed-labels')||link.closest('.tabbed-labels--linked'))return;if(link.classList.contains('custom-tooltip'))return;if(link.classList.contains('glightbox'))return;if(!isValidLink(link))return;const url=getFullUrl(link);if(!url)return;e.preventDefault();showPreview(url,link);},true);}
document.addEventListener('keydown',function(e){if(e.key==='Escape'&&previewBox&&previewBox.classList.contains('active')){hidePreview();}});if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',initLinkListeners);}else{initLinkListeners();}
let lastUrl=location.href;new MutationObserver(()=>{const url=location.href;if(url!==lastUrl){lastUrl=url;if(justExpanded){return;}
if(previewBox&&!document.body.contains(previewBox)){previewBox=null;return;}
if(previewBox&&previewBox.classList.contains('active')&&!previewBox.classList.contains('collapsed')){hidePreview();}
setTimeout(initLinkListeners,100);}}).observe(document.body,{subtree:true,childList:true});})();