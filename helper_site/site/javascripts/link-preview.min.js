(function(){if(window.self!==window.top){return;}
if(window.__linkPreviewInitialized){return;}
window.__linkPreviewInitialized=true;let previewBox=null;let currentLink=null;let currentUrl=null;let justExpanded=false;let scrollPosition=0;function createPreviewBox(){const overlay=document.createElement('div');overlay.className='link-preview-overlay';overlay.addEventListener('click',function(){const isMobile=window.innerWidth<=768;if(isMobile&&previewBox&&!previewBox.classList.contains('collapsed')){hidePreview();}});document.body.appendChild(overlay);const box=document.createElement('div');box.className='link-preview-box';box.innerHTML=`
            <div class="link-preview-resizer"></div>
            <div class="link-preview-content">
                <div class="link-preview-header">
                    <span class="link-preview-title">页面预览</span>
                    <div class="link-preview-actions">
                        <button class="link-preview-open" aria-label="在新标签页打开" title="在新标签页打开">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                <polyline points="15 3 21 3 21 9"></polyline>
                                <line x1="10" y1="14" x2="21" y2="3"></line>
                            </svg>
                        </button>
                        <button class="link-preview-collapse" aria-label="收起预览" title="收起预览">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </button>
                        <button class="link-preview-close" aria-label="关闭预览" title="关闭预览">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="link-preview-loading">加载中...</div>
                <div class="link-preview-iframe-container">
                    <iframe class="link-preview-iframe" sandbox="allow-same-origin allow-scripts allow-popups allow-forms"></iframe>
                    <div class="link-preview-error-overlay"></div>
                </div>
            </div>
        `;document.body.appendChild(box);const expandTrigger=document.createElement('div');expandTrigger.className='link-preview-expand-trigger';expandTrigger.innerHTML=`
            <button class="link-preview-expand-btn" aria-label="展开预览" title="展开预览">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>
        `;document.body.appendChild(expandTrigger);box.addEventListener('touchmove',function(e){e.stopPropagation();},{passive:false});const content=box.querySelector('.link-preview-content');content.addEventListener('touchmove',function(e){e.stopPropagation();},{passive:false});box.addEventListener('wheel',function(e){e.stopPropagation();},{passive:true,capture:true});box.querySelector('.link-preview-close').addEventListener('click',hidePreview);box.querySelector('.link-preview-open').addEventListener('click',function(){if(currentUrl){window.open(currentUrl,'_blank');}});const collapseBtn=box.querySelector('.link-preview-collapse');collapseBtn.addEventListener('click',function(){const isCollapsed=box.classList.contains('collapsed');const isMobile=window.innerWidth<=768;const overlay=document.querySelector('.link-preview-overlay');const expandTrigger=document.querySelector('.link-preview-expand-trigger');if(isCollapsed){box.classList.remove('collapsed');if(expandTrigger)expandTrigger.classList.remove('active');if(isMobile){if(overlay){overlay.classList.add('active');}
scrollPosition=window.pageYOffset||document.documentElement.scrollTop;document.body.style.overflow='hidden';document.body.style.position='fixed';document.body.style.top=`-${scrollPosition}px`;document.body.style.width='100%';}}else{box.classList.add('collapsed');if(expandTrigger)expandTrigger.classList.add('active');if(overlay){overlay.classList.remove('active');}
if(isMobile){document.body.style.overflow='';document.body.style.position='';document.body.style.top='';document.body.style.width='';window.scrollTo(0,scrollPosition);}}});expandTrigger.addEventListener('click',function(e){e.preventDefault();e.stopPropagation();const isMobile=window.innerWidth<=768;const overlay=document.querySelector('.link-preview-overlay');box.classList.remove('collapsed');expandTrigger.classList.remove('active');if(isMobile){if(overlay){overlay.classList.add('active');}
scrollPosition=window.pageYOffset||document.documentElement.scrollTop;document.body.style.overflow='hidden';document.body.style.position='fixed';document.body.style.top=`-${scrollPosition}px`;document.body.style.width='100%';}
justExpanded=true;setTimeout(()=>{justExpanded=false;},500);});initResizer(box);return box;}
function initResizer(box){const resizer=box.querySelector('.link-preview-resizer');let isResizing=false;const handleMouseDown=function(e){isResizing=true;box.style.transition='none';document.body.style.cursor='ew-resize';document.body.style.userSelect='none';const iframe=box.querySelector('.link-preview-iframe');if(iframe){iframe.style.pointerEvents='none';}
e.preventDefault();e.stopPropagation();};const handleMouseMove=function(e){if(!isResizing)return;const newWidth=window.innerWidth-e.clientX;const minWidth=200;const maxWidth=window.innerWidth*0.9;const clampedWidth=Math.max(minWidth,Math.min(maxWidth,newWidth));box.style.width=clampedWidth+'px';e.preventDefault();e.stopPropagation();};const handleMouseUp=function(e){if(!isResizing)return;isResizing=false;document.body.style.cursor='';document.body.style.userSelect='';box.style.transition='';const iframe=box.querySelector('.link-preview-iframe');if(iframe){iframe.style.pointerEvents='';}
e.preventDefault();e.stopPropagation();};resizer.addEventListener('mousedown',handleMouseDown);document.addEventListener('mousemove',handleMouseMove);document.addEventListener('mouseup',handleMouseUp);}
function showPreview(url,linkElement){if(!previewBox){previewBox=createPreviewBox();}
currentLink=linkElement;currentUrl=url;const iframe=previewBox.querySelector('.link-preview-iframe');const loading=previewBox.querySelector('.link-preview-loading');const overlay=document.querySelector('.link-preview-overlay');const expandTrigger=document.querySelector('.link-preview-expand-trigger');const isMobile=window.innerWidth<=768;const isAlreadyOpen=previewBox.classList.contains('active');const isCollapsed=previewBox.classList.contains('collapsed');iframe.style.display='none';loading.style.display='flex';loading.className='link-preview-loading';loading.innerHTML='加载中...';iframe.src='';const errorOverlay=previewBox.querySelector('.link-preview-error-overlay');if(errorOverlay){errorOverlay.classList.remove('active');errorOverlay.innerHTML='';}
if(!isAlreadyOpen){previewBox.classList.remove('collapsed');if(expandTrigger)expandTrigger.classList.remove('active');if(isMobile&&overlay){overlay.classList.add('active');}
previewBox.classList.add('active');if(isMobile){scrollPosition=window.pageYOffset||document.documentElement.scrollTop;document.body.style.overflow='hidden';document.body.style.position='fixed';document.body.style.top=`-${scrollPosition}px`;document.body.style.width='100%';}}else if(isCollapsed){previewBox.classList.remove('collapsed');if(expandTrigger)expandTrigger.classList.remove('active');if(isMobile){if(overlay){overlay.classList.add('active');}
scrollPosition=window.pageYOffset||document.documentElement.scrollTop;document.body.style.overflow='hidden';document.body.style.position='fixed';document.body.style.top=`-${scrollPosition}px`;document.body.style.width='100%';}}
setTimeout(()=>{iframe.src=url;},50);let loadTimeout=setTimeout(()=>{if(iframe.style.display==='none'){showError(loading);}},15000);let hasError=false;const handleSecurityError=function(e){if(e.blockedURI&&iframe.src&&e.blockedURI.includes(new URL(url).hostname)){hasError=true;clearTimeout(loadTimeout);showError(loading);}};document.addEventListener('securitypolicyviolation',handleSecurityError);iframe.onload=function(){clearTimeout(loadTimeout);document.removeEventListener('securitypolicyviolation',handleSecurityError);if(hasError)return;const errorOverlay=previewBox.querySelector('.link-preview-error-overlay');setTimeout(()=>{let isDefinitelyError=false;let canAccessContent=false;try{const doc=iframe.contentDocument;const win=iframe.contentWindow;if(doc&&doc.body){canAccessContent=true;const title=(doc.title||'').toLowerCase();const bodyText=(doc.body?.innerText||'').toLowerCase();const bodyHtml=(doc.body?.innerHTML||'').toLowerCase();const errorIndicators=['refused to connect','refused connection','connection refused','err_blocked_by_response','err_blocked','err_connection','x-frame-options','frame-ancestors','content security policy','cannot be displayed in a frame','this content cannot be displayed','neterror','拒绝连接','禁止访问','此网页无法显示','连接被拒绝'];isDefinitelyError=errorIndicators.some(indicator=>title.includes(indicator)||bodyText.includes(indicator)||bodyHtml.includes(indicator));}
if(win&&!isDefinitelyError){try{const loc=win.location.href;if(loc==='about:blank'||loc.startsWith('chrome-error:')||loc.startsWith('about:neterror')||loc.startsWith('about:blocked')){isDefinitelyError=true;}}catch(locErr){}}}catch(e){canAccessContent=false;}
if(isDefinitelyError){showError(loading);}else if(!canAccessContent){showError(loading);}else{loading.style.display='none';iframe.style.display='block';if(errorOverlay){errorOverlay.classList.remove('active');}}},200);};iframe.onerror=function(){clearTimeout(loadTimeout);document.removeEventListener('securitypolicyviolation',handleSecurityError);showError(loading);};}
function showError(loadingElement){loadingElement.className='link-preview-loading link-preview-error';loadingElement.innerHTML=`
            <svg class="error-icon" viewBox="0 0 24 24" width="48" height="48">
                <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
                <path d="M12 8v4M12 16h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <div class="error-text">网页无法访问或禁止嵌入预览</div>
            <div class="error-hint">请点击右上角的跳转按钮直接访问</div>
        `;}
function hidePreview(){const overlay=document.querySelector('.link-preview-overlay');const expandTrigger=document.querySelector('.link-preview-expand-trigger');if(previewBox){previewBox.classList.remove('active');previewBox.classList.remove('collapsed');}
if(expandTrigger){expandTrigger.classList.remove('active');}
if(overlay){overlay.classList.remove('active');}
if(window.innerWidth<=768){document.body.style.overflow='';document.body.style.position='';document.body.style.top='';document.body.style.width='';window.scrollTo(0,scrollPosition);}
currentLink=null;currentUrl=null;setTimeout(()=>{const iframe=previewBox&&previewBox.querySelector('.link-preview-iframe');if(iframe){iframe.src='';}},400);}
function isValidLink(link){const href=link.getAttribute('href');if(!href)return false;if(href.startsWith('#')||href.startsWith('javascript:')||href.startsWith('mailto:')||href.startsWith('tel:')){return false;}
return true;}
function getFullUrl(link){const href=link.getAttribute('href');if(!href)return null;if(href.startsWith('http://')||href.startsWith('https://')){return href;}
try{return new URL(href,window.location.href).href;}catch(e){return null;}}
let isInitialized=false;function initLinkListeners(){if(isInitialized)return;isInitialized=true;document.addEventListener('click',function(e){const link=e.target.closest('a');if(!link)return;const isInPreviewBox=link.closest('.link-preview-box');if(isInPreviewBox){if(!isValidLink(link))return;const url=getFullUrl(link);if(!url)return;e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();if(previewBox&&previewBox.classList.contains('active')){currentUrl=url;const iframe=previewBox.querySelector('.link-preview-iframe');const loading=previewBox.querySelector('.link-preview-loading');const errorOverlay=previewBox.querySelector('.link-preview-error-overlay');iframe.style.display='none';loading.style.display='flex';loading.className='link-preview-loading';loading.innerHTML='加载中...';if(errorOverlay){errorOverlay.classList.remove('active');errorOverlay.innerHTML='';}
iframe.src=url;}
return;}
const contentArea=document.querySelector('.md-content');if(!contentArea||!contentArea.contains(link))return;if(link.closest('.tabbed-labels')||link.closest('.tabbed-labels--linked'))return;if(link.classList.contains('custom-tooltip'))return;if(link.classList.contains('glightbox'))return;if(!isValidLink(link))return;const url=getFullUrl(link);if(!url)return;e.preventDefault();e.stopPropagation();showPreview(url,link);},true);}
document.addEventListener('keydown',function(e){if(e.key==='Escape'&&previewBox&&previewBox.classList.contains('active')){hidePreview();}});if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',initLinkListeners);}else{initLinkListeners();}
let lastUrl=location.href;new MutationObserver(()=>{const url=location.href;if(url!==lastUrl){lastUrl=url;if(justExpanded){return;}
if(previewBox&&!document.body.contains(previewBox)){previewBox=null;return;}
if(previewBox&&previewBox.classList.contains('active')&&!previewBox.classList.contains('collapsed')){hidePreview();}
setTimeout(initLinkListeners,100);}}).observe(document.body,{subtree:true,childList:true});})();