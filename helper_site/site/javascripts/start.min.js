const fontConfig={"dongguanti":{name:"上图东观体",id:"font-dongguanti"},"oppoti":{name:"OPPO Sans",id:"font-oppoti"},"jiangchengti":{name:"江城黑体",id:"font-jiangchengti"},"lxgw":{name:"霞鹜臻楷",id:"font-lxgw"}};const codeFontConfig={"google-sans-code":{name:"Google Sans Code",id:"code-font-google-sans-code"},"dejavu":{name:"DejaVu Sans Mono",id:"code-font-dejavu-sans-mono"},"zsft":{name:"JetBrains Mono",id:"code-font-zsft-hk"}};(function initFont(){const savedFont=localStorage.getItem("preferred-font")||"dongguanti";Object.values(fontConfig).forEach(font=>{const link=document.getElementById(font.id);if(link){link.setAttribute("disabled","true");}});const selectedFontLink=document.getElementById(fontConfig[savedFont].id);if(selectedFontLink){selectedFontLink.removeAttribute("disabled");}})();(function initCodeFont(){const savedCodeFont=localStorage.getItem("preferred-code-font")||"dejavu";Object.values(codeFontConfig).forEach(font=>{const link=document.getElementById(font.id);if(link){link.setAttribute("disabled","true");}});const selectedCodeFontLink=document.getElementById(codeFontConfig[savedCodeFont].id);if(selectedCodeFontLink){selectedCodeFontLink.removeAttribute("disabled");}})();document.addEventListener("DOMContentLoaded",()=>{const savedTheme=localStorage.getItem("preferred-theme")||"theme2";const savedFont=localStorage.getItem("preferred-font")||"dongguanti";const savedCodeFont=localStorage.getItem("preferred-code-font")||"dejavu";updateFontDropdownToolbar(savedFont);applyFont(savedFont);updateCodeFontDropdownToolbar(savedCodeFont);applyCodeFont(savedCodeFont);initToolbarState();initDesktopTheme();setTimeout(()=>{const hiddenElements=document.querySelectorAll('.md-content article>*[style*="opacity: 0"]');hiddenElements.forEach(el=>{el.style.opacity='1';el.style.transform='translateY(0)';});},2000);});function initDesktopTheme(){const savedTheme=localStorage.getItem("preferred-theme")||"theme2";const theme1Link=document.getElementById("theme1-desktop");const theme2Link=document.getElementById("theme2-desktop");if(theme1Link&&theme2Link){if(savedTheme==="theme1"){theme1Link.removeAttribute("disabled");theme2Link.removeAttribute("disabled");}else{theme1Link.setAttribute("disabled","true");theme2Link.removeAttribute("disabled");}}}
(function initTheme(){const savedTheme=localStorage.getItem("preferred-theme")||"theme2";const theme1Link=document.getElementById("theme1-desktop");const theme2Link=document.getElementById("theme2-desktop");if(theme1Link&&theme2Link){if(savedTheme==="theme1"){theme1Link.removeAttribute("disabled");theme2Link.removeAttribute("disabled");}else{theme1Link.setAttribute("disabled","true");theme2Link.removeAttribute("disabled");}}})();function toggleDropdown(targetSelector,otherSelector){const dropdown=document.querySelector(targetSelector);const otherDropdown=document.querySelector(otherSelector);const isActive=dropdown.classList.contains('active');if(isActive){dropdown.classList.remove('active');return;}
if(otherDropdown&&otherDropdown.classList.contains('active')){const handleTransitionEnd=(event)=>{if(event.target===otherDropdown&&(event.propertyName==='opacity'||event.propertyName==='transform')){otherDropdown.removeEventListener('transitionend',handleTransitionEnd);dropdown.classList.add('active');}};otherDropdown.addEventListener('transitionend',handleTransitionEnd);otherDropdown.classList.remove('active');setTimeout(()=>{otherDropdown.removeEventListener('transitionend',handleTransitionEnd);if(!dropdown.classList.contains('active')){dropdown.classList.add('active');}},350);}else{dropdown.classList.add('active');}}
function toggleFontDropdownToolbar(){toggleDropdown('.font-dropdown-toolbar','.code-font-dropdown-toolbar');}
function toggleCodeFontDropdownToolbar(){toggleDropdown('.code-font-dropdown-toolbar','.font-dropdown-toolbar');}
function applyFontStyle(config,fontKey,storageKey){Object.values(config).forEach(font=>{const link=document.getElementById(font.id);if(link)link.setAttribute("disabled","true");});const selectedLink=document.getElementById(config[fontKey].id);if(selectedLink)selectedLink.removeAttribute("disabled");localStorage.setItem(storageKey,fontKey);}
function updateDropdownDisplay(config,fontKey,nameSelector,optionSelector,dataAttr){const nameEl=document.querySelector(nameSelector);const options=document.querySelectorAll(optionSelector);if(nameEl)nameEl.textContent=config[fontKey].name;options.forEach(option=>{const key=option.getAttribute(dataAttr);option.classList.toggle('selected',key===fontKey);});}
function selectFontToolbar(fontKey){applyFontStyle(fontConfig,fontKey,"preferred-font");updateDropdownDisplay(fontConfig,fontKey,".current-font-name-toolbar",".font-option-toolbar","data-font");document.querySelector('.font-dropdown-toolbar').classList.remove('active');}
function selectCodeFontToolbar(codeFontKey){applyFontStyle(codeFontConfig,codeFontKey,"preferred-code-font");updateDropdownDisplay(codeFontConfig,codeFontKey,".current-code-font-name-toolbar",".code-font-option-toolbar","data-code-font");document.querySelector('.code-font-dropdown-toolbar').classList.remove('active');}
function applyFont(fontKey){applyFontStyle(fontConfig,fontKey,"preferred-font");}
function applyCodeFont(codeFontKey){applyFontStyle(codeFontConfig,codeFontKey,"preferred-code-font");}
function updateFontDropdownToolbar(currentFontKey){updateDropdownDisplay(fontConfig,currentFontKey,".current-font-name-toolbar",".font-option-toolbar","data-font");}
function updateCodeFontDropdownToolbar(currentCodeFontKey){updateDropdownDisplay(codeFontConfig,currentCodeFontKey,".current-code-font-name-toolbar",".code-font-option-toolbar","data-code-font");}
function scrollToTop(){window.scrollTo({top:0,behavior:'smooth'});}
function toggleToolbar(){const toolbar=document.getElementById('floatingToolbar');const toggleBtn=document.getElementById('toolbarToggleBtn');if(!toolbar||!toggleBtn){console.error('无法找到功能条或切换按钮元素');return;}
const isHidden=toolbar.classList.contains('hidden');if(isHidden){toolbar.classList.remove('hidden');toggleBtn.classList.remove('toolbar-hidden');localStorage.setItem('toolbar-visible','true');}else{toolbar.classList.add('hidden');toggleBtn.classList.add('toolbar-hidden');localStorage.setItem('toolbar-visible','false');}}
function initToolbarState(){const toolbar=document.getElementById('floatingToolbar');const toggleBtn=document.getElementById('toolbarToggleBtn');const isVisible=localStorage.getItem('toolbar-visible');if(!toolbar||!toggleBtn){return;}
if(isVisible==='false'){toolbar.classList.add('hidden');toggleBtn.classList.add('toolbar-hidden');}else{toolbar.classList.remove('hidden');toggleBtn.classList.remove('toolbar-hidden');}}
function hideAllSubmenus(){const fontDropdown=document.querySelector('.font-dropdown-toolbar');if(fontDropdown){fontDropdown.classList.remove('active');}
const codeFontDropdown=document.querySelector('.code-font-dropdown-toolbar');if(codeFontDropdown){codeFontDropdown.classList.remove('active');}
}
document.addEventListener('click',function(event){const fontDropdown=document.querySelector('.font-dropdown-toolbar');const codeFontDropdown=document.querySelector('.code-font-dropdown-toolbar');const historyDropdown=document.querySelector('.history-dropdown-toolbar');const fontSwitcher=document.querySelector('.font-switcher');if(fontSwitcher&&fontDropdown&&!fontSwitcher.contains(event.target)){fontDropdown.classList.remove('active');}
const codeFontSwitcher=document.querySelector('.code-font-switcher');if(codeFontSwitcher&&codeFontDropdown&&!codeFontSwitcher.contains(event.target)){codeFontDropdown.classList.remove('active');}
const historyViewer=document.querySelector('.history-viewer');if(historyViewer&&historyDropdown&&!historyViewer.contains(event.target)&&!historyDropdown.contains(event.target)){historyDropdown.classList.remove('show');}});document.addEventListener('DOMContentLoaded',function(){const toolbarItems=document.querySelectorAll('.toolbar-item:not(.font-switcher):not(.code-font-switcher)');toolbarItems.forEach(item=>{item.addEventListener('click',function(){hideAllSubmenus();});item.addEventListener('mouseenter',function(){hideAllSubmenus();});});let fontDropdownTimer=null;let codeFontDropdownTimer=null;const fontSwitcher=document.querySelector('.font-switcher');if(fontSwitcher){fontSwitcher.addEventListener('mouseleave',function(){if(fontDropdownTimer){clearTimeout(fontDropdownTimer);}
fontDropdownTimer=setTimeout(function(){const fontDropdown=document.querySelector('.font-dropdown-toolbar');if(fontDropdown){fontDropdown.classList.remove('active');}},50);});fontSwitcher.addEventListener('mouseenter',function(){if(fontDropdownTimer){clearTimeout(fontDropdownTimer);fontDropdownTimer=null;}});}
const codeFontSwitcher=document.querySelector('.code-font-switcher');if(codeFontSwitcher){codeFontSwitcher.addEventListener('mouseleave',function(){if(codeFontDropdownTimer){clearTimeout(codeFontDropdownTimer);}
codeFontDropdownTimer=setTimeout(function(){const codeFontDropdown=document.querySelector('.code-font-dropdown-toolbar');if(codeFontDropdown){codeFontDropdown.classList.remove('active');}},50);});codeFontSwitcher.addEventListener('mouseenter',function(){if(codeFontDropdownTimer){clearTimeout(codeFontDropdownTimer);codeFontDropdownTimer=null;}});}
initHistoryFeature();recordPageVisit();});function switchTheme(){const currentTheme=localStorage.getItem("preferred-theme")||"theme2";const newTheme=currentTheme==="theme1"?"theme2":"theme1";const targetThemeText=newTheme==="theme1"?"新版主题":"原生主题";const theme1Link=document.getElementById("theme1-desktop");const theme2Link=document.getElementById("theme2-desktop");if(!theme1Link||!theme2Link){console.error("无法找到桌面端主题样式链接");return;}
const overlay=document.createElement("div");overlay.className="theme-transition-overlay";overlay.innerHTML=`
        <div class="theme-transition-content">
            <div class="theme-transition-spinner"></div>
            <div class="theme-transition-text">正在切换到：${targetThemeText}</div>
        </div>
    `;document.body.appendChild(overlay);requestAnimationFrame(()=>{overlay.classList.add("active");setTimeout(()=>{if(newTheme==="theme1"){theme1Link.removeAttribute("disabled");theme2Link.removeAttribute("disabled");}else{theme1Link.setAttribute("disabled","true");theme2Link.removeAttribute("disabled");}
localStorage.setItem("preferred-theme",newTheme);setTimeout(()=>{fadeOutOverlay(overlay);},2500);},250);});}
function fadeOutOverlay(overlay){overlay.style.backgroundColor="rgba(255, 255, 255, 0.85)";setTimeout(()=>{overlay.classList.remove("active");setTimeout(()=>{document.body.removeChild(overlay);},300);},150);}
function initHistoryFeature(){const historyViewer=document.querySelector('.history-viewer');const historyDropdown=document.querySelector('.history-dropdown-toolbar');if(historyViewer&&historyDropdown){historyViewer.addEventListener('click',function(e){e.stopPropagation();toggleHistoryDropdown();});historyDropdown.addEventListener('click',function(e){e.stopPropagation();});}
recordPageVisit();loadHistoryList();const observer=new MutationObserver(function(mutations){mutations.forEach(function(mutation){if(mutation.type==='childList'&&mutation.target.classList.contains('md-content')){setTimeout(()=>{loadHistoryList();},100);}});});const content=document.querySelector('.md-content');if(content){observer.observe(content,{childList:true,subtree:true});}}
function toggleHistoryDropdown(){const historyDropdown=document.querySelector('.history-dropdown-toolbar');if(historyDropdown){historyDropdown.classList.toggle('show');if(historyDropdown.classList.contains('show')){loadHistoryList();}}}
let lastVisitedAnchor='';let currentPageUrl='';let isPageFullyLoaded=false;let isRestoringAnchor=false;let isNavigatingFromHistory=false;function trackAnchorVisit(){if(!isPageFullyLoaded||isRestoringAnchor){return;}
const headings=document.querySelectorAll('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]');const scrollTop=window.pageYOffset||document.documentElement.scrollTop;const viewportHeight=window.innerHeight;const currentViewCenter=scrollTop+viewportHeight/2;let closestAnchor=null;let minDistance=Infinity;headings.forEach(heading=>{const headingTop=heading.offsetTop;const distance=Math.abs(headingTop-currentViewCenter);if(headingTop<=currentViewCenter+viewportHeight/4&&distance<minDistance){minDistance=distance;closestAnchor=heading.id;}});if(!closestAnchor){headings.forEach(heading=>{const rect=heading.getBoundingClientRect();if(rect.top>=0&&rect.top<=viewportHeight&&heading.id){if(!closestAnchor||rect.top<document.getElementById(closestAnchor).getBoundingClientRect().top){closestAnchor=heading.id;}}});}
if(closestAnchor&&closestAnchor!==lastVisitedAnchor){lastVisitedAnchor=closestAnchor;updateCurrentPageAnchor(closestAnchor);}}
function updateCurrentPageAnchor(anchor){if(!currentPageUrl)return;const history=JSON.parse(localStorage.getItem('pageHistory')||'[]');const baseUrl=currentPageUrl.split('#')[0];const pageIndex=history.findIndex(item=>item.url.split('#')[0]===baseUrl);if(pageIndex!==-1){let anchorTitle='';if(anchor){const anchorElement=document.getElementById(anchor);if(anchorElement){const headingText=anchorElement.textContent||anchorElement.innerText;if(headingText&&headingText.trim()){anchorTitle=headingText.trim();}}}
history[pageIndex].lastVisitedAnchor=anchor;history[pageIndex].lastVisitedAnchorTitle=anchorTitle;history[pageIndex].lastVisitedTime=new Date().toLocaleString('zh-CN');localStorage.setItem('pageHistory',JSON.stringify(history));}}
function recordPageVisit(){setTimeout(()=>{const currentUrl=window.location.href;const currentTitle=document.title;const currentTime=new Date().toLocaleString('zh-CN');currentPageUrl=currentUrl;const hash=window.location.hash;const anchor=hash?hash.substring(1):'';let anchorTitle='';if(anchor){const anchorElement=document.getElementById(anchor);if(anchorElement){const headingText=anchorElement.textContent||anchorElement.innerText;if(headingText&&headingText.trim()){anchorTitle=headingText.trim();}}}
const pageInfo={url:currentUrl,title:currentTitle,time:currentTime,anchor:anchor,anchorTitle:anchorTitle,lastVisitedAnchor:anchor,lastVisitedAnchorTitle:anchorTitle,lastVisitedTime:currentTime,displayUrl:currentUrl.replace(window.location.origin,'')};let history=JSON.parse(localStorage.getItem('pageHistory')||'[]');const existingIndex=history.findIndex(item=>item.url===pageInfo.url&&item.anchor===pageInfo.anchor);if(existingIndex!==-1){history[existingIndex].time=currentTime;const updatedItem=history.splice(existingIndex,1)[0];history.unshift(updatedItem);}else{history.unshift(pageInfo);}
if(history.length>50){history=history.slice(0,50);}
localStorage.setItem('pageHistory',JSON.stringify(history));loadHistoryList();lastVisitedAnchor=anchor;setupAnchorTracking();},50);}
function setupAnchorTracking(){window.removeEventListener('scroll',trackAnchorVisit);let scrollTimeout;window.addEventListener('scroll',function(){clearTimeout(scrollTimeout);scrollTimeout=setTimeout(trackAnchorVisit,150);});window.addEventListener('beforeunload',function(){if(lastVisitedAnchor&&currentPageUrl){updateCurrentPageAnchor(lastVisitedAnchor);}});document.addEventListener('visibilitychange',function(){if(document.hidden&&lastVisitedAnchor&&currentPageUrl){updateCurrentPageAnchor(lastVisitedAnchor);}});setTimeout(()=>{isPageFullyLoaded=true;setTimeout(trackAnchorVisit,300);},1000);}
function loadHistoryList(){const historyList=document.querySelector('.history-list-toolbar');if(!historyList)return;const history=JSON.parse(localStorage.getItem('pageHistory')||'[]');if(history.length===0){historyList.innerHTML='<div class="history-empty-toolbar">暂无浏览记录</div>';return;}
let historyHTML='';history.forEach((item,index)=>{let displayTitle=item.title;let lastVisitInfo='';if(item.anchor){if(item.anchorTitle&&item.anchorTitle.trim()){displayTitle=item.anchorTitle;}else{const anchorElement=document.getElementById(item.anchor);if(anchorElement){const headingText=anchorElement.textContent||anchorElement.innerText;if(headingText&&headingText.trim()){displayTitle=headingText.trim();}}}}
if(item.lastVisitedAnchor&&item.lastVisitedAnchor!==item.anchor){if(item.lastVisitedAnchorTitle){lastVisitInfo=`<div class="history-last-visit">最后访问: ${item.lastVisitedAnchorTitle}</div>`;}else{lastVisitInfo=`<div class="history-last-visit">最后访问: #${item.lastVisitedAnchor}</div>`;}}
historyHTML+=`
            <div class="history-item-toolbar">
                <div class="history-content" data-url="${item.url}">
                    <div class="history-title-toolbar">${displayTitle}</div>
                    <div class="history-time-toolbar">${item.time}</div>
                    ${lastVisitInfo}
                    <div class="history-url-toolbar">${item.displayUrl}</div>
                </div>
                <div class="history-delete" data-index="${index}" title="删除此记录">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3,6 5,6 21,6"></polyline>
                        <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                </div>
            </div>
        `;});historyList.innerHTML=historyHTML;const historyItems=historyList.querySelectorAll('.history-content');historyItems.forEach(item=>{let touchStartTime=0;let hasMoved=false;item.addEventListener('touchstart',function(e){touchStartTime=Date.now();hasMoved=false;},{passive:true});item.addEventListener('touchmove',function(e){hasMoved=true;},{passive:true});item.addEventListener('touchend',function(e){const touchDuration=Date.now()-touchStartTime;if(!hasMoved&&touchDuration<500){e.preventDefault();e.stopPropagation();const url=this.getAttribute('data-url');if(url){navigateToHistory(url);}}});item.addEventListener('click',function(e){if(e.detail===0||e.pointerType==='mouse'){e.preventDefault();e.stopPropagation();const url=this.getAttribute('data-url');if(url){navigateToHistory(url);}}});});const deleteButtons=historyList.querySelectorAll('.history-delete');deleteButtons.forEach(button=>{let touchStartTime=0;let hasMoved=false;button.addEventListener('touchstart',function(e){touchStartTime=Date.now();hasMoved=false;},{passive:true});button.addEventListener('touchmove',function(e){hasMoved=true;},{passive:true});button.addEventListener('touchend',function(e){const touchDuration=Date.now()-touchStartTime;if(!hasMoved&&touchDuration<500){e.preventDefault();e.stopPropagation();const index=parseInt(this.getAttribute('data-index'));if(!isNaN(index)){deleteHistoryItem(index);}}});button.addEventListener('click',function(e){if(e.detail===0||e.pointerType==='mouse'){e.preventDefault();e.stopPropagation();const index=parseInt(this.getAttribute('data-index'));if(!isNaN(index)){deleteHistoryItem(index);}}});});}
function navigateToHistory(url){isNavigatingFromHistory=true;const history=JSON.parse(localStorage.getItem('pageHistory')||'[]');const historyItem=history.find(item=>item.url===url);if(historyItem&&historyItem.lastVisitedAnchor){const baseUrl=url.split('#')[0];const targetUrl=`${baseUrl}#${historyItem.lastVisitedAnchor}`;window.location.href=targetUrl;}else{window.location.href=url;}}
function deleteHistoryItem(index){const history=JSON.parse(localStorage.getItem('pageHistory')||'[]');history.splice(index,1);localStorage.setItem('pageHistory',JSON.stringify(history));loadHistoryList();}
function clearHistory(){if(confirm('确定要清空所有浏览历史记录吗？')){localStorage.removeItem('pageHistory');loadHistoryList();}}
function restoreLastVisitedAnchor(){const currentUrl=window.location.href.split('#')[0];const currentHash=window.location.hash.substring(1);if(currentHash){isNavigatingFromHistory=false;return;}
if(!isNavigatingFromHistory){return;}
const history=JSON.parse(localStorage.getItem('pageHistory')||'[]');const pageHistory=history.find(item=>item.url.split('#')[0]===currentUrl);if(pageHistory&&pageHistory.lastVisitedAnchor){isRestoringAnchor=true;setTimeout(()=>{const targetElement=document.getElementById(pageHistory.lastVisitedAnchor);if(targetElement){targetElement.scrollIntoView({behavior:'smooth',block:'start'});lastVisitedAnchor=pageHistory.lastVisitedAnchor;if(window.history.replaceState){const newUrl=`${currentUrl}#${pageHistory.lastVisitedAnchor}`;window.history.replaceState(null,null,newUrl);}
setTimeout(()=>{isRestoringAnchor=false;isNavigatingFromHistory=false;},1000);}else{isRestoringAnchor=false;isNavigatingFromHistory=false;}},800);}else{isNavigatingFromHistory=false;}}
window.addEventListener('hashchange',function(){recordPageVisit();});window.addEventListener('popstate',function(){isPageFullyLoaded=false;isRestoringAnchor=false;isNavigatingFromHistory=false;recordPageVisit();setTimeout(()=>{restoreLastVisitedAnchor();setTimeout(()=>{isPageFullyLoaded=true;},500);},200);});window.addEventListener('load',function(){isNavigatingFromHistory=false;recordPageVisit();setTimeout(()=>{restoreLastVisitedAnchor();setTimeout(()=>{isPageFullyLoaded=true;},500);},300);});document.addEventListener('DOMContentLoaded',function(){document.addEventListener('click',function(e){const link=e.target.closest('a');if(link&&link.href&&!link.href.startsWith('javascript:')&&!link.href.startsWith('#')){setTimeout(()=>{recordPageVisit();},300);}});const observer=new MutationObserver(function(mutations){let pageChanged=false;mutations.forEach(function(mutation){if(mutation.type==='childList'){const addedNodes=Array.from(mutation.addedNodes);if(addedNodes.some(node=>node.nodeType===1&&(node.classList.contains('md-content__inner')||node.querySelector('.md-content__inner')))){pageChanged=true;}}});if(pageChanged){isPageFullyLoaded=false;isRestoringAnchor=false;isNavigatingFromHistory=false;recordPageVisit();setTimeout(()=>{restoreLastVisitedAnchor();setTimeout(()=>{isPageFullyLoaded=true;},500);},300);}});const content=document.querySelector('.md-main');if(content){observer.observe(content,{childList:true,subtree:true});}});