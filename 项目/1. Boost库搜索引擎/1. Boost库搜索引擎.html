<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://www.help-doc.top/%E9%A1%B9%E7%9B%AE/1.%20Boost%E5%BA%93%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/1.%20Boost%E5%BA%93%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E.html><link rel=prev href=../../%E5%B7%A5%E5%85%B7%E5%B8%AE%E5%8A%A9/vim%E4%BD%BF%E7%94%A8%E5%B8%AE%E5%8A%A9/vim%E4%BD%BF%E7%94%A8%E5%B8%AE%E5%8A%A9.html><link rel=next href=../../%E4%BD%9C%E8%80%85/%E4%BD%9C%E8%80%85.html><link rel=icon href=../../images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.8"><title>Boost库搜索引擎 - 学习档案</title><link rel=stylesheet href=../../assets/stylesheets/main.8608ea7d.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=stylesheet href=../../css/timeline.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-9XWRGNRRSY"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-9XWRGNRRSY",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-9XWRGNRRSY",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script><link rel=stylesheet href=../../stylesheets/theme2.css media="screen and (min-width: 768px) and (max-width: 1199px), screen and (min-width: 768px) and (max-width: 1199px) and (orientation: landscape)"><link rel=stylesheet href=../../stylesheets/theme2.css media="screen and (max-width: 767px)"><link rel=stylesheet href=../../stylesheets/theme1.css media="screen and (min-width: 1200px)"><link rel=stylesheet href=../../stylesheets/print.css><script src=https://cdn.jsdelivr.net/npm/mermaid@11.5.0/dist/mermaid.min.js></script><style>
    @import url('https://static.zeoseven.com/zsft/2/main/result.css');
    @import url('https://static.zeoseven.com/zsft/442/main/result.css');
    /* @import url('https://static.zeoseven.com/zsft/288/main/result.css'); */
    @import url('https://static.zeoseven.com/zsft/84/main/result.css');

    /* @font-face {
        font-family: "Source Han Sans SC VF";
    } */
    @font-face {
        font-family: "zsft-hq";
        src: url("https://fontsapi.zeoseven.com/hq/main.woff2") format('woff2'),
            url("https://fontsapi-storage.zeoseven.com/hq/main.woff2") format('woff2');
    }

    @font-face {
        font-family: 'LXGW ZhenKai';
    }

    @font-face {
        font-family: "JetBrains Mono";
        src: url('https://static.zeoseven.com/zsft/hk/main.woff2') format('woff2'),
            url('https://static-host.zeoseven.com/zsft/hk/main.woff2') format('woff2');
    }

    @font-face {
        font-family: "Douyin Sans";
    }

    .md-header__topic .md-ellipsis {
        font-family: "Douyin Sans" !important;
    }

    :root {
        /* --md-text-font: "Source Han Sans SC VF"; */
        --md-text-font: "zsft-hq";
        --md-header-font: "LXGW ZhenKai";
        --md-code-font: "JetBrains Mono";
        --code-font-color: #e96900;
    }

    h1+div>p {
        font-family: var(--md-header-font);
    }

    @media screen and (max-width: 1199px) {
        .theme-switch {
            display: none !important;
        }
    }

    .md-consent__controls .md-button {
        border: none !important;
        background: none !important;
    }

    .md-consent__controls .md-button:hover {
        background-color: #00bda4 !important;
    }

    .md-consent__controls .md-button--primary {
        background: #4da6da !important;
    }

    .theme-switch {
        display: inline-flex;
        gap: 8px;
        margin-right: 1rem;
        padding: 4px;
    }

    .theme-switch {
        margin-right: 1rem;
    }

    .theme-btn {
        font-family: var(--md-text-font);
        font-size: medium;
        padding: 8px 16px;
        border: none;
        border-radius: 8px 8px;
        color: #fff;
        cursor: pointer;
        min-width: 100px;
        height: 36px;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #333;
        background-size: 200% 100%;
        background-position: right bottom;
        background-repeat: no-repeat;
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .theme-btn .current-theme,
    .theme-btn .target-theme {
        position: absolute;
        width: 100%;
        left: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 2;
    }

    .theme-btn .current-theme {
        transform: translateX(0);
        opacity: 1;
        transition-delay: 0ms;
    }

    .theme-btn .target-theme {
        transform: translateX(-100%);
        opacity: 0;
        transition-delay: 0ms;
    }

    .theme-btn:hover {
        transform: scale(1.05);
        background-image: linear-gradient(to right, #4da6da 0%, #275796 100%);
        background-position: left bottom;
    }

    .theme-btn:hover .current-theme {
        transform: translateX(100%);
        opacity: 0;
        transition-delay: 100ms;
    }

    .theme-btn:hover .target-theme {
        transform: translateX(0);
        opacity: 1;
        transition-delay: 200ms;
    }

    .theme-btn:active {
        transform: scale(0.95);
        transition: all 100ms ease;
    }

    .md-content article>*:not(.md-top):not(.md-nav) {
        animation: flyIn 0.6s ease-out forwards;
        opacity: 0;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(1) {
        animation-delay: 0.1s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(2) {
        animation-delay: 0.15s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(3) {
        animation-delay: 0.2s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(4) {
        animation-delay: 0.25s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(5) {
        animation-delay: 0.3s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(6) {
        animation-delay: 0.35s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(7) {
        animation-delay: 0.4s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(8) {
        animation-delay: 0.45s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(9) {
        animation-delay: 0.5s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(10) {
        animation-delay: 0.55s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(11) {
        animation-delay: 0.6s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(12) {
        animation-delay: 0.65s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(13) {
        animation-delay: 0.7s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(14) {
        animation-delay: 0.75s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(15) {
        animation-delay: 0.8s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(16) {
        animation-delay: 0.85s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(17) {
        animation-delay: 0.9s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(18) {
        animation-delay: 0.95s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(19) {
        animation-delay: 1s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(20) {
        animation-delay: 1.05s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(n+21) {
        animation-delay: 1.1s;
    }

    @keyframes flyIn {
        0% {
            opacity: 0;
            transform: translateY(-20px);
        }

        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    li::marker {
        color: rgba(77, 166, 218, 0.9);
    }

    .md-search__input:hover,
    .md-search__input:focus {
        border-radius: 8px !important;
    }

    .md-search__form {
        border-radius: 8px !important;
    }

    .md-search__output {
        border-radius: 8px !important;
    }

    .md-search__overlay {
        border-radius: 8px !important;
    }

    .md-search-result {
        border-radius: 8px !important;
    }

    .md-search__inner {
        border-radius: 8px !important;
    }

    :not(pre)>code {
        color: #ff7043 !important;
        font-weight: normal;
    }

    .highlight .c1,
    .highlight .cm {
        color: #6a737d;
    }

    .md-typeset .admonition,
    .md-typeset details {
        border-width: 0;
        border-left-width: 4px;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
        font-family: var(--md-header-font);
        color: #4da6da !important;
    }

    body {
        font-family: var(--md-text-font);
    }

    .particle {
        position: absolute;
        width: 8px;
        height: 8px;
        background-color: var(--code-font-color);
        border-radius: 50%;
        pointer-events: none;
        animation: particleEffect 0.6s ease-out forwards;
        transform: translate(var(--translate-x, 0), var(--translate-y, 0)) scale(1);
    }

    @keyframes particleEffect {
        from {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        to {
            opacity: 0;
            transform: translate(var(--translate-x), var(--translate-y)) scale(0.5);
        }
    }

    pre code {
        color: var(--md-code-fg-color) !important;
    }

    .highlight pre {
        background-color: var(--md-code-bg-color) !important;
    }

    .md-typeset code {
        font-family: var(--md-code-font), var(--md-text-font);
    }

    .md-tabs__item.md-tabs__item--active {
        border-bottom: 2px solid rgba(77, 166, 218, 0.9);
    }

    .md-tabs__list>.md-tabs__item--active>.md-tabs__link {
        color: rgba(77, 166, 218, 0.9) !important;
    }

    .timeline-content::before {
        background-color: #efefef;
    }

    .timeline-card {
        background-color: #efefef !important;
    }

    .changelog-content a {
        color: #4051b5 !important;
        word-break: break-word;
    }

    .changelog-content a:focus,
    .changelog-content a:hover {
        color: #00bda4 !important;
    }

    .changelog-type-pageupdate {
        background-color: rgba(77, 166, 218, 0.9) !important;
    }

    .md-footer-runtime {
        position: relative;
        z-index: 3;
        margin: 0.5rem 0;
        padding: 0.4rem 0;
        font-size: .7rem;
        line-height: 1.6;
        color: var(--md-footer-fg-color--light);
        display: flex;
        align-items: center;
    }

    ::selection {
        background: rgba(77, 166, 218, 0.2);
    }

    html {
        scroll-behavior: smooth !important;
        /* 强制启用平滑滚动 */
        scroll-padding-top: 53px;
        /* 设置滚动偏移量,避免标题被导航栏遮挡 */
    }

    a[href^="#"],
    /* 站内锚点 */
    a[href*="/#"]

    /* 跨页锚点 */
        {
        scroll-behavior: smooth !important;
    }

    @media (prefers-reduced-motion: reduce) {
        html {
            scroll-behavior: auto !important;
        }

        a[href^="#"],
        a[href*="/#"] {
            scroll-behavior: auto !important;
        }
    }

    .custom-tooltip {
        position: relative;
        display: inline-block;
        cursor: help;
        color: rgba(77, 166, 218, 0.9);
        border-bottom: 1px dashed rgba(77, 166, 218, 0.9);
        text-decoration: none !important;
    }

    .custom-tooltip::before {
        content: attr(data-title);
        position: absolute;
        width: 300px;
        background-color: rgba(51, 51, 51, 0.95);
        color: #fff;
        text-align: left;
        padding: 10px;
        border-radius: 6px;
        bottom: 125%;
        /* 定位在链接上方 */
        left: 50%;
        transform: translateX(-50%);
        z-index: 99999;
        /* 确保显示在最上层 */
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s;
        font-weight: normal;
        font-size: 14px;
        line-height: 1.5;
        pointer-events: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        word-wrap: break-word;
        white-space: normal;
    }

    .custom-tooltip::after {
        content: "";
        position: absolute;
        bottom: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: rgba(51, 51, 51, 0.95) transparent transparent transparent;
        z-index: 99999;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s;
        pointer-events: none;
    }

    .custom-tooltip:hover::before {
        opacity: 1;
        visibility: visible;
    }

    .custom-tooltip:hover::after {
        opacity: 1;
        visibility: visible;
    }

    @media (max-width: 767px) {
        .custom-tooltip::before {
            width: 250px;
            white-space: normal;
            left: 50%;
            transform: translateX(-50%);
            bottom: 130%;
        }
    }

    .md-content a.custom-tooltip::after {
        display: none !important;
    }

    @media screen and (max-width: 767px) {
        .md-typeset table {
            display: block;
            max-width: 100% !important;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-right: 0 !important;
            margin-left: 0 !important;
            box-sizing: border-box;
            table-layout: fixed;
            position: relative;
        }

        .md-typeset .arithmatex {
            max-width: 100%;
            overflow-x: hidden;
            text-overflow: ellipsis;
        }

        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.25em 0;
        }

        .md-md-typeset__table table th,
        .md-md-typeset__table table td {
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            white-space: normal !important;
        }

        .md-typeset__table table:after {
            content: "";
            display: table;
            clear: both;
        }

        .md-typeset .md-typeset__table {
            max-width: 100% !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
            overflow: visible;
        }

        .md-typeset__table table th {
            font-size: 0.85em;
            padding: 0.6em 0.8em;
        }

        .md-typeset__table .md-typeset__scrollwrap {
            margin: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
        }
    }
</style><script>
    document.addEventListener('DOMContentLoaded', () => {
        const searchEl = document.querySelector('.md-search');
        const savedTheme = localStorage.getItem('preferred-theme') || 'theme1';
        const themeSwitch = document.createElement('div');
        themeSwitch.className = 'theme-switch';
        themeSwitch.innerHTML = `
                <button class="theme-btn" onclick="switchTheme()">
                    <span class="current-theme">${savedTheme === 'theme1' ? '新版主题' : '原生主题'}</span>
                    <span class="target-theme">${savedTheme === 'theme1' ? '原生主题' : '新版主题'}</span>
                </button>
            `;
        searchEl.parentNode.insertBefore(themeSwitch, searchEl);
        setTimeout(() => {
            const hash = window.location.hash;
            if (hash) {
                const readmoreBtn = document.getElementById('readmore-wrapper');
                if (!readmoreBtn || window.getComputedStyle(readmoreBtn).display === 'none') {
                    const targetId = hash.substring(1);
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        // 平滑滚动到目标元素
                        targetElement.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                }
            }
        }, 300);
    });

    (function initTheme() {
        const savedTheme = localStorage.getItem('preferred-theme');
        if (savedTheme) {
            const theme1Link = document.querySelector('link[href*="theme1"]');
            const theme2Link = document.querySelector('link[href*="theme2"]');
            if (theme1Link && theme2Link) {
                if (savedTheme === 'theme1') {
                    theme1Link.removeAttribute('disabled');
                    theme2Link.setAttribute('disabled', 'true');
                } else {
                    theme2Link.removeAttribute('disabled');
                    theme1Link.setAttribute('disabled', 'true');
                }
            }
        }
    })();

    function switchTheme() {
        const currentTheme = localStorage.getItem('preferred-theme') || 'theme1';
        const newTheme = currentTheme === 'theme1' ? 'theme2' : 'theme1';
        const theme1Link = document.querySelector('link[href*="theme1"]');
        const theme2Link = document.querySelector('link[href*="theme2"]');
        if (newTheme === 'theme1') {
            theme1Link.removeAttribute('disabled');
            theme2Link.setAttribute('disabled', 'true');
        } else {
            theme2Link.removeAttribute('disabled');
            theme1Link.setAttribute('disabled', 'true');
        }
        localStorage.setItem('preferred-theme', newTheme);
        const themeBtn = document.querySelector('.theme-btn');
        const currentThemeEl = themeBtn.querySelector('.current-theme');
        const targetThemeEl = themeBtn.querySelector('.target-theme');
        currentThemeEl.textContent = newTheme === 'theme1' ? '新版主题' : '原生主题';
        targetThemeEl.textContent = newTheme === 'theme1' ? '原生主题' : '新版主题';
    }

    document.addEventListener('copy', function (e) {
        const selectedText = window.getSelection().toString();
        if (selectedText) {
            const copyright = '\n\n' +
                '————————————————\n' +
                '文章作者：怡晗★\n' +
                '网站链接：https://www.help-doc.top\n' +
                '当前文章链接：' + window.location.href + '\n' +
                '版权声明：本博客所有文章除特别声明外，均采用 CC BY-NC-ND 4.0 许可协议。\n' +
                '转载请注明来自怡晗★的个人网站！';
            e.preventDefault();
            e.clipboardData.setData('text/plain', selectedText + copyright);
        }
    });
</script> <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=teal> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#boost class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../index.html title=学习档案 class="md-header__button md-logo" aria-label=学习档案 data-md-component=logo> <img src=../../assets/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> 学习档案 </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Boost库搜索引擎 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=teal aria-hidden=true type=radio name=__palette id=__palette_0> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=查找> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../index.html class=md-tabs__link> 主页 </a> </li> <li class=md-tabs__item> <a href=../../%E7%BD%91%E7%AB%99%E6%97%B6%E9%97%B4%E7%BA%BF/%E7%BD%91%E7%AB%99%E6%97%B6%E9%97%B4%E7%BA%BF.html class=md-tabs__link> 网站时间线 </a> </li> <li class=md-tabs__item> <a href=../../C%E8%AF%AD%E8%A8%80/1.%20C%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/1.%20C%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86.html class=md-tabs__link> 编程语言 </a> </li> <li class=md-tabs__item> <a href=../../%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/1.%20%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6%E5%92%8C%E7%A9%BA%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6/1.%20%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6%E4%B8%8E%E7%A9%BA%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6.html class=md-tabs__link> 数据结构与算法 </a> </li> <li class=md-tabs__item> <a href=../../Linux/1.%20Linux%E5%B8%B8%E7%94%A8%E9%80%89%E9%A1%B9%E5%92%8C%E6%8C%87%E4%BB%A4/1.%20Linux%E5%B8%B8%E7%94%A8%E9%80%89%E9%A1%B9%E5%92%8C%E6%8C%87%E4%BB%A4.html class=md-tabs__link> Linux </a> </li> <li class=md-tabs__item> <a href=../../HTML%E4%B8%8ECSS/HTML%E7%AC%94%E8%AE%B0/HTML%E7%AC%94%E8%AE%B0.html class=md-tabs__link> 前端 </a> </li> <li class=md-tabs__item> <a href=../../MySQL/MySQL%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/MySQL%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8.html class=md-tabs__link> MySQL </a> </li> <li class=md-tabs__item> <a href=../../%E5%85%B6%E5%AE%83/Shell%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80/%E5%85%B3%E4%BA%8EShell.html class=md-tabs__link> 扩展知识 </a> </li> <li class=md-tabs__item> <a href=../../%E5%B7%A5%E5%85%B7%E5%B8%AE%E5%8A%A9/vscode%E4%B8%AD%E6%B7%BB%E5%8A%A0%E4%BB%A3%E7%A0%81%E7%89%87%E6%AE%B5/vscode%E4%B8%AD%E6%B7%BB%E5%8A%A0%E4%BB%A3%E7%A0%81%E7%89%87%E6%AE%B5.html class=md-tabs__link> 工具帮助 </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=1.%20Boost%E5%BA%93%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E.html class=md-tabs__link> 项目 </a> </li> <li class=md-tabs__item> <a href=../../%E4%BD%9C%E8%80%85/%E4%BD%9C%E8%80%85.html class=md-tabs__link> 联系作者 </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../index.html title=学习档案 class="md-nav__button md-logo" aria-label=学习档案 data-md-component=logo> <img src=../../assets/logo.png alt=logo> </a> 学习档案 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../index.html class=md-nav__link> <span class=md-ellipsis> 主页 </span> </a> </li> <li class=md-nav__item> <a href=../../%E7%BD%91%E7%AB%99%E6%97%B6%E9%97%B4%E7%BA%BF/%E7%BD%91%E7%AB%99%E6%97%B6%E9%97%B4%E7%BA%BF.html class=md-nav__link> <span class=md-ellipsis> 网站时间线 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../C%E8%AF%AD%E8%A8%80/1.%20C%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/1.%20C%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86.html class=md-nav__link> <span class=md-ellipsis> 编程语言 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/1.%20%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6%E5%92%8C%E7%A9%BA%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6/1.%20%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6%E4%B8%8E%E7%A9%BA%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6.html class=md-nav__link> <span class=md-ellipsis> 数据结构与算法 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../Linux/1.%20Linux%E5%B8%B8%E7%94%A8%E9%80%89%E9%A1%B9%E5%92%8C%E6%8C%87%E4%BB%A4/1.%20Linux%E5%B8%B8%E7%94%A8%E9%80%89%E9%A1%B9%E5%92%8C%E6%8C%87%E4%BB%A4.html class=md-nav__link> <span class=md-ellipsis> Linux </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../HTML%E4%B8%8ECSS/HTML%E7%AC%94%E8%AE%B0/HTML%E7%AC%94%E8%AE%B0.html class=md-nav__link> <span class=md-ellipsis> 前端 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../MySQL/MySQL%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/MySQL%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8.html class=md-nav__link> <span class=md-ellipsis> MySQL </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../%E5%85%B6%E5%AE%83/Shell%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80/%E5%85%B3%E4%BA%8EShell.html class=md-nav__link> <span class=md-ellipsis> 扩展知识 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../%E5%B7%A5%E5%85%B7%E5%B8%AE%E5%8A%A9/vscode%E4%B8%AD%E6%B7%BB%E5%8A%A0%E4%BB%A3%E7%A0%81%E7%89%87%E6%AE%B5/vscode%E4%B8%AD%E6%B7%BB%E5%8A%A0%E4%BB%A3%E7%A0%81%E7%89%87%E6%AE%B5.html class=md-nav__link> <span class=md-ellipsis> 工具帮助 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_10 checked> <label class=md-nav__link for=__nav_10 id=__nav_10_label tabindex> <span class=md-ellipsis> 项目 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_10_label aria-expanded=true> <label class=md-nav__title for=__nav_10> <span class="md-nav__icon md-icon"></span> 项目 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Boost库搜索引擎 </span> <span class="md-nav__icon md-icon"></span> </label> <a href=1.%20Boost%E5%BA%93%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E.html class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Boost库搜索引擎 </span> </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 前置知识 </span> </a> <nav class=md-nav aria-label=前置知识> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 了解搜索引擎 </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 分词 </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 正排索引和倒排索引 </span> </a> <nav class=md-nav aria-label=正排索引和倒排索引> <ul class=md-nav__list> <li class=md-nav__item> <a href=#forward-index class=md-nav__link> <span class=md-ellipsis> 正排索引（Forward Index） </span> </a> </li> <li class=md-nav__item> <a href=#inverted-index class=md-nav__link> <span class=md-ellipsis> 倒排索引（Inverted Index） </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 两者对比与应用 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> 项目准备 </span> </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 实现思路 </span> </a> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> 数据清洗 </span> </a> <nav class=md-nav aria-label=数据清洗> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_9 class=md-nav__link> <span class=md-ellipsis> 介绍 </span> </a> </li> <li class=md-nav__item> <a href=#html class=md-nav__link> <span class=md-ellipsis> 读取所有HTML路径 </span> </a> </li> <li class=md-nav__item> <a href=#html_1 class=md-nav__link> <span class=md-ellipsis> 读取HTML文件内容到结构体字段中 </span> </a> <nav class=md-nav aria-label=读取HTML文件内容到结构体字段中> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_10 class=md-nav__link> <span class=md-ellipsis> 基本逻辑介绍 </span> </a> </li> <li class=md-nav__item> <a href=#readhtmlfile class=md-nav__link> <span class=md-ellipsis> 实现读取文件内容readHtmlFile </span> </a> </li> <li class=md-nav__item> <a href=#gettitlefromhtml class=md-nav__link> <span class=md-ellipsis> 实现读取文件标题getTitleFromHtml </span> </a> </li> <li class=md-nav__item> <a href=#getcontentfromhtml class=md-nav__link> <span class=md-ellipsis> 实现读取文件内容getContentFromHtml </span> </a> </li> <li class=md-nav__item> <a href=#urlconstructhtmlurl class=md-nav__link> <span class=md-ellipsis> 实现URL构建constructHtmlUrl </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> <span class=md-ellipsis> 写入结构体对象数据到文本文件中 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> <span class=md-ellipsis> 构建正排索引和构建倒排索引 </span> </a> <nav class=md-nav aria-label=构建正排索引和构建倒排索引> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_13 class=md-nav__link> <span class=md-ellipsis> 基本思路和结构介绍 </span> </a> </li> <li class=md-nav__item> <a href=#_14 class=md-nav__link> <span class=md-ellipsis> 实现构建索引函数 </span> </a> </li> <li class=md-nav__item> <a href=#buildforwardindex class=md-nav__link> <span class=md-ellipsis> 实现构建正排索引buildForwardIndex </span> </a> </li> <li class=md-nav__item> <a href=#buildbackwardindex class=md-nav__link> <span class=md-ellipsis> 实现构建倒排索引buildBackwardIndex </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_15 class=md-nav__link> <span class=md-ellipsis> 实现搜索引擎模块 </span> </a> <nav class=md-nav aria-label=实现搜索引擎模块> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_16 class=md-nav__link> <span class=md-ellipsis> 基本实现 </span> </a> </li> <li class=md-nav__item> <a href=#_17 class=md-nav__link> <span class=md-ellipsis> 搜索关键字查询优化 </span> </a> </li> <li class=md-nav__item> <a href=#_18 class=md-nav__link> <span class=md-ellipsis> 查询结果优化 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_19 class=md-nav__link> <span class=md-ellipsis> 第一阶段问题 </span> </a> <nav class=md-nav aria-label=第一阶段问题> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_20 class=md-nav__link> <span class=md-ellipsis> 构建索引速度慢 </span> </a> </li> <li class=md-nav__item> <a href=#_21 class=md-nav__link> <span class=md-ellipsis> 进程占满内存，系统杀死进程 </span> </a> </li> <li class=md-nav__item> <a href=#_22 class=md-nav__link> <span class=md-ellipsis> 错误进入本不应该进入的逻辑 </span> </a> <nav class=md-nav aria-label=错误进入本不应该进入的逻辑> <ul class=md-nav__list> <li class=md-nav__item> <a href=#getpartialbodywithkeyword class=md-nav__link> <span class=md-ellipsis> 进入getPartialBodyWithKeyword中无法找到关键字分支 </span> </a> </li> <li class=md-nav__item> <a href=#getpartialbodywithkeyword_1 class=md-nav__link> <span class=md-ellipsis> 进入getPartialBodyWithKeyword中内容不足截取不到内容分支 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#url class=md-nav__link> <span class=md-ellipsis> 构建的URL在官网出现页面不存在 </span> </a> </li> <li class=md-nav__item> <a href=#_23 class=md-nav__link> <span class=md-ellipsis> 权重计算异常 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_24 class=md-nav__link> <span class=md-ellipsis> 创建服务器 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../%E4%BD%9C%E8%80%85/%E4%BD%9C%E8%80%85.html class=md-nav__link> <span class=md-ellipsis> 联系作者 </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 前置知识 </span> </a> <nav class=md-nav aria-label=前置知识> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 了解搜索引擎 </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 分词 </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 正排索引和倒排索引 </span> </a> <nav class=md-nav aria-label=正排索引和倒排索引> <ul class=md-nav__list> <li class=md-nav__item> <a href=#forward-index class=md-nav__link> <span class=md-ellipsis> 正排索引（Forward Index） </span> </a> </li> <li class=md-nav__item> <a href=#inverted-index class=md-nav__link> <span class=md-ellipsis> 倒排索引（Inverted Index） </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 两者对比与应用 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> 项目准备 </span> </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 实现思路 </span> </a> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> 数据清洗 </span> </a> <nav class=md-nav aria-label=数据清洗> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_9 class=md-nav__link> <span class=md-ellipsis> 介绍 </span> </a> </li> <li class=md-nav__item> <a href=#html class=md-nav__link> <span class=md-ellipsis> 读取所有HTML路径 </span> </a> </li> <li class=md-nav__item> <a href=#html_1 class=md-nav__link> <span class=md-ellipsis> 读取HTML文件内容到结构体字段中 </span> </a> <nav class=md-nav aria-label=读取HTML文件内容到结构体字段中> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_10 class=md-nav__link> <span class=md-ellipsis> 基本逻辑介绍 </span> </a> </li> <li class=md-nav__item> <a href=#readhtmlfile class=md-nav__link> <span class=md-ellipsis> 实现读取文件内容readHtmlFile </span> </a> </li> <li class=md-nav__item> <a href=#gettitlefromhtml class=md-nav__link> <span class=md-ellipsis> 实现读取文件标题getTitleFromHtml </span> </a> </li> <li class=md-nav__item> <a href=#getcontentfromhtml class=md-nav__link> <span class=md-ellipsis> 实现读取文件内容getContentFromHtml </span> </a> </li> <li class=md-nav__item> <a href=#urlconstructhtmlurl class=md-nav__link> <span class=md-ellipsis> 实现URL构建constructHtmlUrl </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> <span class=md-ellipsis> 写入结构体对象数据到文本文件中 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> <span class=md-ellipsis> 构建正排索引和构建倒排索引 </span> </a> <nav class=md-nav aria-label=构建正排索引和构建倒排索引> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_13 class=md-nav__link> <span class=md-ellipsis> 基本思路和结构介绍 </span> </a> </li> <li class=md-nav__item> <a href=#_14 class=md-nav__link> <span class=md-ellipsis> 实现构建索引函数 </span> </a> </li> <li class=md-nav__item> <a href=#buildforwardindex class=md-nav__link> <span class=md-ellipsis> 实现构建正排索引buildForwardIndex </span> </a> </li> <li class=md-nav__item> <a href=#buildbackwardindex class=md-nav__link> <span class=md-ellipsis> 实现构建倒排索引buildBackwardIndex </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_15 class=md-nav__link> <span class=md-ellipsis> 实现搜索引擎模块 </span> </a> <nav class=md-nav aria-label=实现搜索引擎模块> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_16 class=md-nav__link> <span class=md-ellipsis> 基本实现 </span> </a> </li> <li class=md-nav__item> <a href=#_17 class=md-nav__link> <span class=md-ellipsis> 搜索关键字查询优化 </span> </a> </li> <li class=md-nav__item> <a href=#_18 class=md-nav__link> <span class=md-ellipsis> 查询结果优化 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_19 class=md-nav__link> <span class=md-ellipsis> 第一阶段问题 </span> </a> <nav class=md-nav aria-label=第一阶段问题> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_20 class=md-nav__link> <span class=md-ellipsis> 构建索引速度慢 </span> </a> </li> <li class=md-nav__item> <a href=#_21 class=md-nav__link> <span class=md-ellipsis> 进程占满内存，系统杀死进程 </span> </a> </li> <li class=md-nav__item> <a href=#_22 class=md-nav__link> <span class=md-ellipsis> 错误进入本不应该进入的逻辑 </span> </a> <nav class=md-nav aria-label=错误进入本不应该进入的逻辑> <ul class=md-nav__list> <li class=md-nav__item> <a href=#getpartialbodywithkeyword class=md-nav__link> <span class=md-ellipsis> 进入getPartialBodyWithKeyword中无法找到关键字分支 </span> </a> </li> <li class=md-nav__item> <a href=#getpartialbodywithkeyword_1 class=md-nav__link> <span class=md-ellipsis> 进入getPartialBodyWithKeyword中内容不足截取不到内容分支 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#url class=md-nav__link> <span class=md-ellipsis> 构建的URL在官网出现页面不存在 </span> </a> </li> <li class=md-nav__item> <a href=#_23 class=md-nav__link> <span class=md-ellipsis> 权重计算异常 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_24 class=md-nav__link> <span class=md-ellipsis> 创建服务器 </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=boost>Boost库搜索引擎<a class=headerlink href=#boost title="Permanent link">&para;</a></h1> <div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;"> <p><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 8449 个字 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 1205 行代码 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"/></svg></span> 3 张图片 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 43 分钟</p> </div> <h2 id=_1>前置知识<a class=headerlink href=#_1 title="Permanent link">&para;</a></h2> <h3 id=_2>了解搜索引擎<a class=headerlink href=#_2 title="Permanent link">&para;</a></h3> <p>搜索引擎是一种信息检索系统，它能够自动从互联网或特定数据集合中收集、分析和组织信息，并根据用户的查询需求快速定位和返回相关结果。搜索引擎通常由爬虫、索引器和检索系统三大核心组件构成，实现数据采集、处理和高效查询</p> <p>一般情况下，搜索引擎分为两种：</p> <ol> <li>站内搜索引擎：只在当前网站的内容之上进行搜索，实现难度较为容易</li> <li>全网搜索引擎：在整个互联网的内容之上进行搜索，实现难度大且维护成本高</li> </ol> <p>本次只实现站内搜索，了解站内搜索基本原理再推测全网搜索的原理</p> <h3 id=_3>分词<a class=headerlink href=#_3 title="Permanent link">&para;</a></h3> <p>分词是将文本切分成有意义的基本单元（词语或词元）的过程，是搜索引擎和自然语言处理的基础环节</p> <p>一般分词可以分为两种模式：</p> <ol> <li>全模式：切分出文本中所有可能成词的单元，不考虑语义合理性，特点是同一个字可能出现在多个词中，产生词语重叠。这种模式适合模糊匹配的需求，但是会产生大量冗余结果</li> <li>精确模式：只切分出最符合语义的词语组合，特点是每个字只会出现在一个词中，无重叠现象。这种模式下分词结果符合人类语义理解，但是依赖高质量词典或训练语料</li> </ol> <p>例如，将“我来到北京清华大学”这段话，通过分词可以分为：</p> <ol> <li>我/ 来到/ 北京/ 清华/ 清华大学/ 华大/ 大学（全模式）</li> <li>我/ 来到/ 北京/ 清华大学（精确模式）</li> </ol> <p>本次项目中会使用分词技术查找出满足条件的文档</p> <h3 id=_4>正排索引和倒排索引<a class=headerlink href=#_4 title="Permanent link">&para;</a></h3> <h4 id=forward-index>正排索引（Forward Index）<a class=headerlink href=#forward-index title="Permanent link">&para;</a></h4> <p>正排索引是以文档为中心的索引结构：</p> <ul> <li><strong>定义</strong>：以文档ID为索引，文档内容为值的数据结构</li> <li><strong>结构</strong>：文档ID → 文档内容/词项集合</li> <li><strong>示例</strong>： <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-1>文档1 → {标题:&quot;Boost库简介&quot;, 内容:&quot;Boost是一个C++库集合...&quot;}
</span><span id=__span-0-2>文档2 → {标题:&quot;C\+\+编程&quot;, 内容:&quot;C\+\+是一种面向对象编程语言...&quot;}
</span></code></pre></div></td></tr></table></div></li> <li><strong>特点</strong>：<ul> <li>适合已知文档ID时获取文档内容</li> <li>类似于图书馆中按编号排列的书架</li> <li>不利于根据关键词查找文档</li> <li>构建简单，存储效率低</li> </ul> </li> </ul> <h4 id=inverted-index>倒排索引（Inverted Index）<a class=headerlink href=#inverted-index title="Permanent link">&para;</a></h4> <p>倒排索引是以词项为中心的索引结构：</p> <ul> <li><strong>定义</strong>：以词项为索引，包含该词项的文档列表为值</li> <li><strong>结构</strong>：词项 → 文档ID列表(可能包含位置、频率等信息)</li> <li><strong>示例</strong>： <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-1-1>&quot;Boost&quot; → {文档1: [位置1, 位置4], 文档3: [位置2]}
</span><span id=__span-1-2>&quot;C++&quot; → {文档1: [位置10], 文档2: [位置1, 位置5]}
</span></code></pre></div></td></tr></table></div></li> <li><strong>特点</strong>：<ul> <li>适合根据关键词快速查找相关文档</li> <li>类似于图书馆中的关键词目录</li> <li>支持高效的全文检索</li> <li>构建复杂，查询高效</li> </ul> </li> </ul> <h4 id=_5>两者对比与应用<a class=headerlink href=#_5 title="Permanent link">&para;</a></h4> <table> <thead> <tr> <th>特性</th> <th>正排索引</th> <th>倒排索引</th> </tr> </thead> <tbody> <tr> <td>查询方向</td> <td>文档→词项</td> <td>词项→文档</td> </tr> <tr> <td>适用场景</td> <td>文档展示和获取</td> <td>关键词搜索</td> </tr> <tr> <td>构建复杂度</td> <td>低</td> <td>高</td> </tr> <tr> <td>查询效率</td> <td>特定文档高</td> <td>关键词搜索高</td> </tr> <tr> <td>存储需求</td> <td>大</td> <td>相对小</td> </tr> </tbody> </table> <p>实际搜索引擎通常同时使用两种索引：</p> <ul> <li>用倒排索引快速找到匹配查询的文档集合</li> <li>用正排索引获取匹配文档的完整内容以展示给用户</li> </ul> <p>倒排索引是现代搜索引擎的核心数据结构，使得快速全文检索成为可能</p> <h2 id=_6>项目准备<a class=headerlink href=#_6 title="Permanent link">&para;</a></h2> <p>本次项目会使用到下面的内容：</p> <ol> <li>后端：C++、<a href=https://github.com/yhirose/cpp-httplib>cpp-httplib开源库</a>、<a href=https://github.com/fxsjy/jieba>Jieba分词</a>、<a href=https://www.help-doc.top/%E5%85%B6%E5%AE%83/%E5%85%B3%E4%BA%8EJSONCPP%E5%BA%93/%E5%85%B3%E4%BA%8EJSONCPP%E5%BA%93.html#jsoncpp>Jsoncpp</a></li> <li>前端：HTML、CSS和JavaScript</li> <li>搜索内容：<a href=https://archives.boost.io/release/1.78.0/source/ >1.78版本的Boost库</a>中的<code>doc/html</code>中的内容</li> <li>日志：在Linux下实现的<a href=https://www.help-doc.top/Linux/19.%20Linux%E7%BA%BF%E7%A8%8B/6.%20%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/6.%20%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F.html#_1>日志系统</a></li> <li>操作系统：Ubuntu 24.04（Linux）</li> </ol> <div class="admonition note"> <p class=admonition-title>Note</p> <ol> <li>注意，这里的Boost库不要使用最新的，最新的Boost库中的HTML文件并不存在。另外，官网下载有的时候可能比较慢，可以使用<a href=https://sourceforge.net/projects/boost/files/boost/1.78.0/ >本链接</a>作为替代，这个链接是官方认可的资源站</li> <li>关于JSONCPP的使用可以看<a href=https://www.help-doc.top/%E5%85%B6%E5%AE%83/%E5%85%B3%E4%BA%8EJSONCPP%E5%BA%93/%E5%85%B3%E4%BA%8EJSONCPP%E5%BA%93.html#jsoncpp>关于JSONCPP库</a></li> </ol> </div> <h2 id=_7>实现思路<a class=headerlink href=#_7 title="Permanent link">&para;</a></h2> <p>根据常见搜素引擎的搜索结果可以看出，一条结果一般包含下面三个内容：</p> <ol> <li>内容标题</li> <li>描述内容或者部分主体内容</li> <li>内容网址</li> </ol> <p>但是直接从下载到的Boost库资源中可以看到都是HTML文件，直接从该文件中获取到上面三个内容就需要做最重要的一步：去除HTML文件中的标签留下纯文本内容，这便是本次实现的第一步：数据清洗</p> <p>完成数据清洗之后就需要对构建搜索引擎做准备，首先需要完成的就是索引的构建，在前面提到了两种索引方式：正排索引和倒排索引，本次实现中也会包含这两种索引，根据两种索引的特点完成索引的构建</p> <p>构建完成索引后就需要根据用户的输入查找索引给用户返回查找到的内容</p> <p>最后，编写前端代码，完善服务端模块，客户端请求即可完成搜索</p> <h2 id=_8>数据清洗<a class=headerlink href=#_8 title="Permanent link">&para;</a></h2> <h3 id=_9>介绍<a class=headerlink href=#_9 title="Permanent link">&para;</a></h3> <p>根据前面提到的一条搜索结果的构成可以分析出需要创建一个结构体包含这三个字段：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-2-1><span class=c1>// 结果基本内容结构</span>
</span><span id=__span-2-2><span class=k>struct</span><span class=w> </span><span class=nc>ResultData</span>
</span><span id=__span-2-3><span class=p>{</span>
</span><span id=__span-2-4><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>title</span><span class=p>;</span><span class=w> </span><span class=c1>// 结构标题</span>
</span><span id=__span-2-5><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>body</span><span class=p>;</span><span class=w> </span><span class=c1>// 结果内容或描述</span>
</span><span id=__span-2-6><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>url</span><span class=p>;</span><span class=w> </span><span class=c1>// 网址</span>
</span><span id=__span-2-7><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>接着就是将一个正常HTML文件中的内容依次读取到结构体对应的字段中，下面分三步走：</p> <ol> <li>读取到源文件目录下所有的HTML文件，将其拼接为一个字符串存储到vector中</li> <li>根据上一步得到的vector中的数据，取出每一个文件中的三个字段：文档标题、文档内容和文档在Boost官网的URL都存放到一个结构化对象中，再将该对象存储到一个vector中</li> <li>根据上一步结果的vector中每一个结构化数据读取并写入到一个文本文档<code>raw</code>，每一个结构化数据以一个<code>\n</code>分隔，而其中的成员以<code>\3</code>分隔</li> </ol> <p>下面是本次项目的目录结构：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-3-1><span class=o>-</span><span class=w> </span><span class=n>根路径</span>
</span><span id=__span-3-2><span class=w>    </span><span class=o>-</span><span class=w> </span><span class=n>data</span>
</span><span id=__span-3-3><span class=w>        </span><span class=o>-</span><span class=w> </span><span class=n>source</span>
</span><span id=__span-3-4><span class=w>            </span><span class=o>-</span><span class=w> </span><span class=n>html</span><span class=w> </span><span class=c1>// 所有的HTML文件位于这里</span>
</span><span id=__span-3-5><span class=w>        </span><span class=o>-</span><span class=w> </span><span class=n>raw</span><span class=w> </span><span class=c1>// 结构化数据存储到这里</span>
</span><span id=__span-3-6><span class=w>    </span><span class=c1>// 头文件和源文件文件与data目录平级</span>
</span></code></pre></div></td></tr></table></div> <p>接着，创建一个<code>DataParse</code>类，用于进行数据清洗：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-4-1><span class=k>class</span><span class=w> </span><span class=nc>DataParse</span>
</span><span id=__span-4-2><span class=p>{</span>
</span><span id=__span-4-3><span class=k>private</span><span class=o>:</span>
</span><span id=__span-4-4>
</span><span id=__span-4-5><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <h3 id=html>读取所有HTML路径<a class=headerlink href=#html title="Permanent link">&para;</a></h3> <p>本步骤的基本思路就是获取到HTML路径存储到vector中，所以需要使用C++ 17中的<code>filesystem</code>库，也可以使用Boost库中提供的<code>filesystem</code>，二者在使用方式上都是一样的。关于<code>filesystem</code>的介绍可以看<a href=#>C++17 相关新特性</a></p> <p>首先定义出当前HTML文件所在路径：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-5-1><span class=c1>// HTML文件路径</span>
</span><span id=__span-5-2><span class=k>const</span><span class=w> </span><span class=n>fs</span><span class=o>::</span><span class=n>path</span><span class=w> </span><span class=n>g_datasource_path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;data/source/html&quot;</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> <p>接着，实现函数读取到所有的HTML文件，如果不是HTML文件就不统计。因为当前HTML文件路径中存在目录，目录中还存在更多的HTML文件，所以还需要用到递归遍历目录</p> <p>基于上面的思路，首先需要添加一个vector成员<code>sources</code>和获取HTML文件函数<code>getHtmlSourceFiles</code>：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-6-1><span class=k>class</span><span class=w> </span><span class=nc>DataParse</span>
</span><span id=__span-6-2><span class=p>{</span>
</span><span id=__span-6-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-6-4><span class=w>    </span><span class=c1>// 获取HTML文件路径函数</span>
</span><span id=__span-6-5><span class=w>    </span><span class=kt>bool</span><span class=w> </span><span class=n>getHtmlSourceFiles</span><span class=p>()</span>
</span><span id=__span-6-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-6-7>
</span><span id=__span-6-8><span class=w>    </span><span class=p>}</span>
</span><span id=__span-6-9><span class=k>private</span><span class=o>:</span>
</span><span id=__span-6-10><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>fs</span><span class=o>::</span><span class=n>path</span><span class=o>&gt;</span><span class=w> </span><span class=n>sources</span><span class=p>;</span>
</span><span id=__span-6-11><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>读取思路：从<code>g_datasource_path</code>开始遍历，遇到后缀为HTML的文件就添加到<code>sources</code>中，如果遇到的是目录就进入目录继续查找，实现代码如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-7-1><span class=c1>// HTML文件后缀</span>
</span><span id=__span-7-2><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>g_html_extension</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;.html&quot;</span><span class=p>;</span>
</span><span id=__span-7-3>
</span><span id=__span-7-4><span class=c1>// 获取HTML文件路径函数</span>
</span><span id=__span-7-5><span class=kt>bool</span><span class=w> </span><span class=nf>getHtmlSourceFiles</span><span class=p>()</span>
</span><span id=__span-7-6><span class=p>{</span>
</span><span id=__span-7-7><span class=w>    </span><span class=c1>// 如果路径不存在，直接返回false</span>
</span><span id=__span-7-8><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>fs</span><span class=o>::</span><span class=n>exists</span><span class=p>(</span><span class=n>g_datasource_path</span><span class=p>))</span>
</span><span id=__span-7-9><span class=w>    </span><span class=p>{</span>
</span><span id=__span-7-10><span class=w>        </span><span class=n>ls</span><span class=o>::</span><span class=n>LOG</span><span class=p>(</span><span class=n>ls</span><span class=o>::</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>DEBUG</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;不存在指定路径&quot;</span><span class=p>;</span>
</span><span id=__span-7-11><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-7-12><span class=w>    </span><span class=p>}</span>
</span><span id=__span-7-13>
</span><span id=__span-7-14><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>entry</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>fs</span><span class=o>::</span><span class=n>recursive_directory_iterator</span><span class=p>(</span><span class=n>g_datasource_path</span><span class=p>))</span>
</span><span id=__span-7-15><span class=w>    </span><span class=p>{</span>
</span><span id=__span-7-16><span class=w>        </span><span class=c1>// 1. 不是普通文件就是目录，继续遍历</span>
</span><span id=__span-7-17><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>fs</span><span class=o>::</span><span class=n>is_regular_file</span><span class=p>(</span><span class=n>entry</span><span class=p>))</span>
</span><span id=__span-7-18><span class=w>            </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-7-19>
</span><span id=__span-7-20><span class=w>        </span><span class=c1>// 2. 是普通文件，但是不是HTML文件，继续遍历</span>
</span><span id=__span-7-21><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=n>path</span><span class=p>().</span><span class=n>extension</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>g_html_extension</span><span class=p>)</span>
</span><span id=__span-7-22><span class=w>            </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-7-23>
</span><span id=__span-7-24><span class=w>        </span><span class=c1>// 3. 是普通文件并且是HTML文件，插入结果</span>
</span><span id=__span-7-25><span class=w>        </span><span class=n>sources_</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=n>path</span><span class=p>()));</span>
</span><span id=__span-7-26><span class=w>    </span><span class=p>}</span>
</span><span id=__span-7-27>
</span><span id=__span-7-28><span class=w>    </span><span class=c1>// 空结果返回false</span>
</span><span id=__span-7-29><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>!</span><span class=n>sources_</span><span class=p>.</span><span class=n>empty</span><span class=p>();</span>
</span><span id=__span-7-30><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h3 id=html_1>读取HTML文件内容到结构体字段中<a class=headerlink href=#html_1 title="Permanent link">&para;</a></h3> <h4 id=_10>基本逻辑介绍<a class=headerlink href=#_10 title="Permanent link">&para;</a></h4> <p>本部分的思路就是根据HTML文件中的特点提取出对应的内容，因为HTML文件的内容都是由标签和普通文本构成，而需要的内容就是文本，对应的行为就是去标签。本次实现分四步：</p> <ol> <li>读取文件</li> <li>截取标题</li> <li>截取主体内容</li> <li>构建URL</li> </ol> <p>对于每一个HTML文件都需要走这四步，所以需要使用一个循环，通过一个函数<code>readInfoFromHtml</code>包裹主体逻辑：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-8-1><span class=c1>// 读取HTML文件内容</span>
</span><span id=__span-8-2><span class=kt>bool</span><span class=w> </span><span class=nf>readInfoFromHtml</span><span class=p>()</span>
</span><span id=__span-8-3><span class=p>{</span>
</span><span id=__span-8-4><span class=w>    </span><span class=c1>// 不存在路径返回false</span>
</span><span id=__span-8-5><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sources_</span><span class=p>.</span><span class=n>empty</span><span class=p>())</span>
</span><span id=__span-8-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-8-7><span class=w>        </span><span class=n>ls</span><span class=o>::</span><span class=n>LOG</span><span class=p>(</span><span class=n>ls</span><span class=o>::</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;文件路径不存在&quot;</span><span class=p>;</span>
</span><span id=__span-8-8><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-8-9><span class=w>    </span><span class=p>}</span>
</span><span id=__span-8-10>
</span><span id=__span-8-11><span class=w>    </span><span class=c1>// 每一个文件都执行四步</span>
</span><span id=__span-8-12><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>path</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>sources_</span><span class=p>)</span>
</span><span id=__span-8-13><span class=w>    </span><span class=p>{</span>
</span><span id=__span-8-14><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>out</span><span class=p>;</span><span class=w> </span><span class=c1>// 存储HTML文件内容</span>
</span><span id=__span-8-15><span class=w>        </span><span class=k>struct</span><span class=w> </span><span class=nc>pd</span><span class=o>::</span><span class=n>ResultData</span><span class=w> </span><span class=n>rd</span><span class=p>;</span>
</span><span id=__span-8-16><span class=w>        </span><span class=c1>// 1. 读取文件</span>
</span><span id=__span-8-17><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>readHtmlFile</span><span class=p>(</span><span class=n>path</span><span class=p>,</span><span class=w> </span><span class=n>out</span><span class=p>))</span>
</span><span id=__span-8-18><span class=w>        </span><span class=p>{</span>
</span><span id=__span-8-19><span class=w>            </span><span class=n>ls</span><span class=o>::</span><span class=n>LOG</span><span class=p>(</span><span class=n>ls</span><span class=o>::</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;打开文件：&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>path</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;失败&quot;</span><span class=p>;</span>
</span><span id=__span-8-20><span class=w>            </span><span class=c1>// 读取当前文件失败时继续读取后面的文件</span>
</span><span id=__span-8-21><span class=w>            </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-8-22><span class=w>        </span><span class=p>}</span>
</span><span id=__span-8-23>
</span><span id=__span-8-24><span class=w>        </span><span class=c1>// 2. 获取标题</span>
</span><span id=__span-8-25><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>getTitleFromHtml</span><span class=p>(</span><span class=n>out</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>rd</span><span class=p>.</span><span class=n>title</span><span class=p>))</span>
</span><span id=__span-8-26><span class=w>        </span><span class=p>{</span>
</span><span id=__span-8-27><span class=w>            </span><span class=n>ls</span><span class=o>::</span><span class=n>LOG</span><span class=p>(</span><span class=n>ls</span><span class=o>::</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;获取文件标题失败&quot;</span><span class=p>;</span>
</span><span id=__span-8-28><span class=w>            </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-8-29><span class=w>        </span><span class=p>}</span>
</span><span id=__span-8-30>
</span><span id=__span-8-31><span class=w>        </span><span class=c1>// 3. 读取文件内容</span>
</span><span id=__span-8-32><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>getContentFromHtml</span><span class=p>(</span><span class=n>out</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>rd</span><span class=p>.</span><span class=n>body</span><span class=p>))</span>
</span><span id=__span-8-33><span class=w>        </span><span class=p>{</span>
</span><span id=__span-8-34><span class=w>            </span><span class=n>ls</span><span class=o>::</span><span class=n>LOG</span><span class=p>(</span><span class=n>ls</span><span class=o>::</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;获取文件内容失败&quot;</span><span class=p>;</span>
</span><span id=__span-8-35><span class=w>            </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-8-36><span class=w>        </span><span class=p>}</span>
</span><span id=__span-8-37>
</span><span id=__span-8-38><span class=w>        </span><span class=c1>// 4. 构建URL</span>
</span><span id=__span-8-39><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>constructHtmlUrl</span><span class=p>(</span><span class=n>path</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>rd</span><span class=p>.</span><span class=n>url</span><span class=p>))</span>
</span><span id=__span-8-40><span class=w>        </span><span class=p>{</span>
</span><span id=__span-8-41><span class=w>            </span><span class=n>ls</span><span class=o>::</span><span class=n>LOG</span><span class=p>(</span><span class=n>ls</span><span class=o>::</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;构建文件URL失败&quot;</span><span class=p>;</span>
</span><span id=__span-8-42><span class=w>            </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-8-43><span class=w>        </span><span class=p>}</span>
</span><span id=__span-8-44><span class=w>    </span><span class=p>}</span>
</span><span id=__span-8-45>
</span><span id=__span-8-46><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-8-47><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>最后，四个逻辑全部正常执行完后需要将形成的结构体对象插入到一个vector对象<code>results_</code>，此处需要一个添加类成员<code>results_</code>：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-9-1><span class=k>class</span><span class=w> </span><span class=nc>DataParse</span>
</span><span id=__span-9-2><span class=p>{</span>
</span><span id=__span-9-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-9-4><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-9-5>
</span><span id=__span-9-6><span class=w>    </span><span class=c1>// 从HTML文件中读取信息</span>
</span><span id=__span-9-7><span class=w>    </span><span class=kt>bool</span><span class=w> </span><span class=n>readInfoFromHtml</span><span class=p>()</span>
</span><span id=__span-9-8><span class=w>    </span><span class=p>{</span>
</span><span id=__span-9-9><span class=w>        </span><span class=c1>// 不存在路径返回false</span>
</span><span id=__span-9-10><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sources_</span><span class=p>.</span><span class=n>empty</span><span class=p>())</span>
</span><span id=__span-9-11><span class=w>        </span><span class=p>{</span>
</span><span id=__span-9-12><span class=w>            </span><span class=n>ls</span><span class=o>::</span><span class=n>LOG</span><span class=p>(</span><span class=n>ls</span><span class=o>::</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;文件路径不存在&quot;</span><span class=p>;</span>
</span><span id=__span-9-13><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-9-14><span class=w>        </span><span class=p>}</span>
</span><span id=__span-9-15>
</span><span id=__span-9-16><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>path</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>sources</span><span class=p>)</span>
</span><span id=__span-9-17><span class=w>        </span><span class=p>{</span>
</span><span id=__span-9-18><span class=w>            </span><span class=c1>// ...</span>
</span><span id=__span-9-19>
</span><span id=__span-9-20><span class=w>            </span><span class=n>results_</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>rd</span><span class=p>));</span>
</span><span id=__span-9-21><span class=w>        </span><span class=p>}</span>
</span><span id=__span-9-22>
</span><span id=__span-9-23><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-9-24><span class=w>    </span><span class=p>}</span>
</span><span id=__span-9-25>
</span><span id=__span-9-26><span class=k>private</span><span class=o>:</span>
</span><span id=__span-9-27><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-9-28><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>pd</span><span class=o>::</span><span class=n>ResultData</span><span class=o>&gt;</span><span class=w> </span><span class=n>results_</span><span class=p>;</span>
</span><span id=__span-9-29><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>接着，根据上面的函数主体，依次实现其中的四个函数</p> <h4 id=readhtmlfile>实现读取文件内容<code>readHtmlFile</code><a class=headerlink href=#readhtmlfile title="Permanent link">&para;</a></h4> <p>读取HTML文件内容比较简单，就是简单的读取文件内容操作，参考代码如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-10-1><span class=c1>// 读取HTML文件</span>
</span><span id=__span-10-2><span class=kt>bool</span><span class=w> </span><span class=nf>readHtmlFile</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>fs</span><span class=o>::</span><span class=n>path</span><span class=w> </span><span class=o>&amp;</span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>out</span><span class=p>)</span>
</span><span id=__span-10-3><span class=p>{</span>
</span><span id=__span-10-4><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=p>.</span><span class=n>empty</span><span class=p>())</span>
</span><span id=__span-10-5><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-10-6>
</span><span id=__span-10-7><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>fstream</span><span class=w> </span><span class=n>f</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span><span id=__span-10-8>
</span><span id=__span-10-9><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>f</span><span class=p>.</span><span class=n>is_open</span><span class=p>())</span>
</span><span id=__span-10-10><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-10-11>
</span><span id=__span-10-12><span class=w>    </span><span class=c1>// 读取文件</span>
</span><span id=__span-10-13><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>buffer</span><span class=p>;</span>
</span><span id=__span-10-14><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>getline</span><span class=p>(</span><span class=n>f</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>))</span>
</span><span id=__span-10-15><span class=w>        </span><span class=n>out</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>buffer</span><span class=p>;</span>
</span><span id=__span-10-16>
</span><span id=__span-10-17><span class=w>    </span><span class=n>f</span><span class=p>.</span><span class=n>close</span><span class=p>();</span>
</span><span id=__span-10-18>
</span><span id=__span-10-19><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-10-20><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h4 id=gettitlefromhtml>实现读取文件标题<code>getTitleFromHtml</code><a class=headerlink href=#gettitlefromhtml title="Permanent link">&para;</a></h4> <p>因为一个标准的HTML文件中存在且只存在一个语义化标签<code>&lt;title&gt;&lt;/title&gt;</code>，所以只需要在文件中找到这个标签，并提取出其中的普通文本即可：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-11-1><span class=c1>// 读取标题</span>
</span><span id=__span-11-2><span class=c1>// &amp;为输入型参数，*为输出型参数</span>
</span><span id=__span-11-3><span class=kt>bool</span><span class=w> </span><span class=nf>getTitleFromHtml</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>in</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>*</span><span class=n>title</span><span class=p>)</span>
</span><span id=__span-11-4><span class=p>{</span>
</span><span id=__span-11-5><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>in</span><span class=p>.</span><span class=n>empty</span><span class=p>())</span>
</span><span id=__span-11-6><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-11-7>
</span><span id=__span-11-8><span class=w>    </span><span class=c1>// 找到开始标签&lt;title&gt;</span>
</span><span id=__span-11-9><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>in</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=s>&quot;&lt;title&gt;&quot;</span><span class=p>);</span>
</span><span id=__span-11-10><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>start</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>::</span><span class=n>npos</span><span class=p>)</span>
</span><span id=__span-11-11><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-11-12>
</span><span id=__span-11-13><span class=w>    </span><span class=c1>// 找到终止标签&lt;/title&gt;</span>
</span><span id=__span-11-14><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>in</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=s>&quot;&lt;/title&gt;&quot;</span><span class=p>);</span>
</span><span id=__span-11-15><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>end</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>::</span><span class=n>npos</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>start</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>end</span><span class=p>)</span>
</span><span id=__span-11-16><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-11-17>
</span><span id=__span-11-18><span class=w>    </span><span class=c1>// 截取出其中的内容，左闭右开</span>
</span><span id=__span-11-19><span class=w>    </span><span class=o>*</span><span class=n>title</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>in</span><span class=p>.</span><span class=n>substr</span><span class=p>(</span><span class=n>start</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=p>(</span><span class=s>&quot;&lt;title&gt;&quot;</span><span class=p>).</span><span class=n>size</span><span class=p>(),</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=p>(</span><span class=n>start</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=p>(</span><span class=s>&quot;&lt;title&gt;&quot;</span><span class=p>).</span><span class=n>size</span><span class=p>()));</span>
</span><span id=__span-11-20>
</span><span id=__span-11-21><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-11-22><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h4 id=getcontentfromhtml>实现读取文件内容<code>getContentFromHtml</code><a class=headerlink href=#getcontentfromhtml title="Permanent link">&para;</a></h4> <p>前面提到一个HTML文件只有两种内容：标签和普通文本，所以可以创建一个简单的状态机：如果当前的内容是标签，状态为<code>Label</code>，否则为<code>OrdinaryContent</code>，所以首先需要一个枚举类型描述这两个状态：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-12-1><span class=c1>// 内容状态</span>
</span><span id=__span-12-2><span class=k>enum</span><span class=w> </span><span class=nc>ContentStatus</span>
</span><span id=__span-12-3><span class=p>{</span>
</span><span id=__span-12-4><span class=w>    </span><span class=n>Label</span><span class=p>,</span><span class=w> </span><span class=c1>// 标签状态</span>
</span><span id=__span-12-5><span class=w>    </span><span class=n>OrdinaryContent</span><span class=w> </span><span class=c1>// 普通文本状态</span>
</span><span id=__span-12-6><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>接下来考虑何时进行两种状态的切换，默认从文件开始，读取到的内容就是<code>&lt;</code>，所以默认状态为<code>Label</code>，而读取到<code>&gt;</code>有三种情况：</p> <ol> <li>单标签的结尾</li> <li>双标签开始标签的结尾</li> <li>双标签闭合标签的结尾</li> </ol> <p>而对于这三种情况，第三种情况和第一种情况可以归类为一种情况，因为这两种情况下都是作为当前标签的最后一个<code>&gt;</code>，所以现在就变成了两种情况：</p> <ol> <li>双标签起始标签的结尾<code>&gt;</code></li> <li>当前标签的最后一个<code>&gt;</code></li> </ol> <p>根据这两个情况以一个HTML内容为例进行分析：</p> <div class="language-html highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>HTML</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-13-1><span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>内容1<span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span><span id=__span-13-2><span class=p>&lt;</span><span class=nt>img</span> <span class=p>/&gt;</span>
</span><span id=__span-13-3>内容2
</span><span id=__span-13-4><span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>内容3<span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></code></pre></div></td></tr></table></div> <p>以双标签为例，起始时，状态为<code>Label</code>，读取到第一个<code>&gt;</code>时，得到一个条件：<code>Label</code>且<code>&gt;</code>，假设此时可以修改状态为<code>OrdinaryContent</code>，那么接下来读取的就是文本内容，接着读取第一个到<code>&lt;</code>时，得到下一个条件：<code>OrdinaryContent</code>且<code>&lt;</code>，假设此时可以修改状态为<code>Label</code>，那么在读取到最后一个<code>&gt;</code>时，状态为<code>Label</code>，即回到默认值<code>Label</code>继续读取后续内容</p> <p>接着读取到单标签，状态为<code>Label</code>，得到一个条件：<code>Label</code>且<code>&lt;</code>，根据上面的逻辑，不进行状态改变，接着读取到第一个<code>&gt;</code>，得到一个条件：<code>Label</code>且<code>&gt;</code>，根据上面的思路此时修改状态为<code>OrdinaryContent</code>，接下来读取文本内容，当读取到<code>&lt;div&gt;内容3&lt;/div&gt;</code>的第一个<code>&lt;</code>时，得到下一个条件：<code>OrdinaryContent</code>且<code>&lt;</code>，根据上面的逻辑可以修改状态为<code>Label</code>，即回到默认值<code>Label</code>继续读取后续内容</p> <p>所以，综上所述，状态切换时机为：</p> <ol> <li>当前状态为<code>Label</code>且遇到的是<code>&gt;</code>，切换为<code>OrdinaryContent</code></li> <li>当前状态为<code>OrdinaryContent</code>且遇到的是<code>&lt;</code>，切换为<code>Label</code></li> </ol> <p>根据上面的逻辑，在函数中判断出状态为<code>OrdinaryContent</code>就可以执行插入内容，需要注意的是，后面需要使用<code>\n</code>作为分隔符，所以为了防止源文件内容中的<code>\n</code>干扰，需要将该<code>\n</code>替换为一个空格字符：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-14-1><span class=c1>// 读取HTML文件内容</span>
</span><span id=__span-14-2><span class=kt>bool</span><span class=w> </span><span class=nf>getContentFromHtml</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>out</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>*</span><span class=n>body</span><span class=p>)</span>
</span><span id=__span-14-3><span class=p>{</span>
</span><span id=__span-14-4><span class=w>    </span><span class=c1>// 默认状态为标签</span>
</span><span id=__span-14-5><span class=w>    </span><span class=n>ContentStatus</span><span class=w> </span><span class=n>cs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ContentStatus</span><span class=o>::</span><span class=n>Label</span><span class=p>;</span>
</span><span id=__span-14-6>
</span><span id=__span-14-7><span class=w>    </span><span class=c1>// 注意，因为文档没有中文，直接用char没有问题</span>
</span><span id=__span-14-8><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>char</span><span class=w> </span><span class=n>ch</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>out</span><span class=p>)</span>
</span><span id=__span-14-9><span class=w>    </span><span class=p>{</span>
</span><span id=__span-14-10><span class=w>        </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>cs</span><span class=p>)</span>
</span><span id=__span-14-11><span class=w>        </span><span class=p>{</span>
</span><span id=__span-14-12><span class=w>        </span><span class=c1>// 读取到右尖括号且状态为标签说明接下来为文本内容</span>
</span><span id=__span-14-13><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>ContentStatus</span><span class=o>::</span><span class=no>Label</span><span class=p>:</span>
</span><span id=__span-14-14><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>ch</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=sc>&#39;&gt;&#39;</span><span class=p>)</span>
</span><span id=__span-14-15><span class=w>                </span><span class=n>cs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ContentStatus</span><span class=o>::</span><span class=n>OrdinaryContent</span><span class=p>;</span><span class=w> </span><span class=c1>// 切换状态</span>
</span><span id=__span-14-16><span class=w>            </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-14-17><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>ContentStatus</span><span class=o>::</span><span class=no>OrdinaryContent</span><span class=p>:</span>
</span><span id=__span-14-18><span class=w>            </span><span class=c1>// 去除\n</span>
</span><span id=__span-14-19><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ch</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=sc>&#39;&lt;&#39;</span><span class=p>)</span>
</span><span id=__span-14-20><span class=w>                </span><span class=n>cs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ContentStatus</span><span class=o>::</span><span class=n>Label</span><span class=p>;</span><span class=w> </span><span class=c1>// 切换状态</span>
</span><span id=__span-14-21><span class=w>            </span><span class=k>else</span>
</span><span id=__span-14-22><span class=w>            </span><span class=p>{</span>
</span><span id=__span-14-23><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ch</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=p>)</span>
</span><span id=__span-14-24><span class=w>                    </span><span class=o>*</span><span class=n>body</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=sc>&#39; &#39;</span><span class=p>;</span>
</span><span id=__span-14-25><span class=w>                </span><span class=k>else</span><span class=w> </span>
</span><span id=__span-14-26><span class=w>                    </span><span class=o>*</span><span class=n>body</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>ch</span><span class=p>;</span>
</span><span id=__span-14-27><span class=w>            </span><span class=p>}</span>
</span><span id=__span-14-28><span class=w>            </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-14-29><span class=w>        </span><span class=k>default</span><span class=o>:</span>
</span><span id=__span-14-30><span class=w>            </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-14-31><span class=w>        </span><span class=p>}</span>
</span><span id=__span-14-32><span class=w>    </span><span class=p>}</span>
</span><span id=__span-14-33>
</span><span id=__span-14-34><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-14-35><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h4 id=urlconstructhtmlurl>实现URL构建<code>constructHtmlUrl</code><a class=headerlink href=#urlconstructhtmlurl title="Permanent link">&para;</a></h4> <p>要构建一个有效的URL，就必须要将本地文件的路径和官网的路径进行对比，找出一个固定的值和可以改变的部分，例如以<code>accumulators.html</code>，在本地的路径和<a href=https://www.boost.org/doc/libs/1_78_0/ >官网URL</a>路径分别如下：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-15-1>本地路径：data/source/html/accumulators.html
</span><span id=__span-15-2>官网路径：https://www.boost.org/doc/libs/1_78_0/doc/html/accumulators.html
</span></code></pre></div></td></tr></table></div> <p>从上面的路径可以看出，只需要获取到本地路径中的最后一个文件内容<code>/accumulators.html</code>拼接到<code>https://www.boost.org/doc/libs/1_78_0/doc/html</code>后方即可</p> <p>基于这个思路，实现下面的函数：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-16-1><span class=c1>// 构建URL</span>
</span><span id=__span-16-2><span class=kt>bool</span><span class=w> </span><span class=nf>constructHtmlUrl</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>fs</span><span class=o>::</span><span class=n>path</span><span class=o>&amp;</span><span class=w> </span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>*</span><span class=n>url</span><span class=p>)</span>
</span><span id=__span-16-3><span class=p>{</span>
</span><span id=__span-16-4><span class=w>    </span><span class=c1>// 在本地路径中找到&quot;/文件&quot;</span>
</span><span id=__span-16-5><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>t_path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>string</span><span class=p>();</span>
</span><span id=__span-16-6><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>t_path</span><span class=p>.</span><span class=n>rfind</span><span class=p>(</span><span class=s>&quot;/&quot;</span><span class=p>);</span>
</span><span id=__span-16-7>
</span><span id=__span-16-8><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>pos</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>::</span><span class=n>npos</span><span class=p>)</span>
</span><span id=__span-16-9><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-16-10>
</span><span id=__span-16-11><span class=w>    </span><span class=c1>// 从/开始截取一直到结尾</span>
</span><span id=__span-16-12><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>source_path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>t_path</span><span class=p>.</span><span class=n>substr</span><span class=p>(</span><span class=n>pos</span><span class=p>);</span>
</span><span id=__span-16-13><span class=w>    </span><span class=o>*</span><span class=n>url</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>g_url_to_concat</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>source_path</span><span class=p>;</span>
</span><span id=__span-16-14>
</span><span id=__span-16-15><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-16-16><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h3 id=_11>写入结构体对象数据到文本文件中<a class=headerlink href=#_11 title="Permanent link">&para;</a></h3> <p>首先指定好文本文件的位置和分隔符：</p> <div class="language-c++ highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-17-1><span class=c1>// 文本文件路径</span>
</span><span id=__span-17-2><span class=k>const</span><span class=w> </span><span class=n>fs</span><span class=o>::</span><span class=n>path</span><span class=w> </span><span class=n>g_rawfile_path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;data/raw&quot;</span><span class=p>;</span>
</span><span id=__span-17-3><span class=c1>// 结构体字段间的分隔符</span>
</span><span id=__span-17-4><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>g_rd_sep</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;</span><span class=se>\3</span><span class=s>&quot;</span><span class=p>;</span>
</span><span id=__span-17-5><span class=c1>// 不同HTML文件的分隔符</span>
</span><span id=__span-17-6><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>g_html_sep</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> <p>接着就是基本的文件写入操作，但是为了保证不可打印字符可以正常显示，建议使用二进制写入的方式，函数实现如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-18-1><span class=c1>// 将结构体字段写入文本文件中</span>
</span><span id=__span-18-2><span class=kt>bool</span><span class=w> </span><span class=nf>writeToRawFile</span><span class=p>()</span>
</span><span id=__span-18-3><span class=p>{</span>
</span><span id=__span-18-4><span class=w>    </span><span class=c1>// 以二进制形式打开文件</span>
</span><span id=__span-18-5><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>fstream</span><span class=w> </span><span class=n>f</span><span class=p>(</span><span class=n>g_rawfile_path</span><span class=p>);</span>
</span><span id=__span-18-6>
</span><span id=__span-18-7><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>f</span><span class=p>.</span><span class=n>is_open</span><span class=p>())</span>
</span><span id=__span-18-8><span class=w>    </span><span class=p>{</span>
</span><span id=__span-18-9><span class=w>        </span><span class=n>ls</span><span class=o>::</span><span class=n>LOG</span><span class=p>(</span><span class=n>ls</span><span class=o>::</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;文本文件不存在&quot;</span><span class=p>;</span>
</span><span id=__span-18-10><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-18-11><span class=w>    </span><span class=p>}</span>
</span><span id=__span-18-12>
</span><span id=__span-18-13><span class=w>    </span><span class=c1>// 写入结构化数据</span>
</span><span id=__span-18-14><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>rd</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>results_</span><span class=p>)</span>
</span><span id=__span-18-15><span class=w>    </span><span class=p>{</span>
</span><span id=__span-18-16><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>temp</span><span class=p>;</span>
</span><span id=__span-18-17><span class=w>        </span><span class=n>temp</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>rd</span><span class=p>.</span><span class=n>title</span><span class=p>;</span>
</span><span id=__span-18-18><span class=w>        </span><span class=n>temp</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>g_rd_sep</span><span class=p>;</span>
</span><span id=__span-18-19><span class=w>        </span><span class=n>temp</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>rd</span><span class=p>.</span><span class=n>body</span><span class=p>;</span>
</span><span id=__span-18-20><span class=w>        </span><span class=n>temp</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>g_rd_sep</span><span class=p>;</span>
</span><span id=__span-18-21><span class=w>        </span><span class=n>temp</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>rd</span><span class=p>.</span><span class=n>url</span><span class=p>;</span>
</span><span id=__span-18-22><span class=w>        </span><span class=n>temp</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>g_html_sep</span><span class=p>;</span>
</span><span id=__span-18-23>
</span><span id=__span-18-24><span class=w>        </span><span class=n>f</span><span class=p>.</span><span class=n>write</span><span class=p>(</span><span class=n>temp</span><span class=p>.</span><span class=n>c_str</span><span class=p>(),</span><span class=w> </span><span class=n>temp</span><span class=p>.</span><span class=n>size</span><span class=p>());</span>
</span><span id=__span-18-25><span class=w>    </span><span class=p>}</span>
</span><span id=__span-18-26>
</span><span id=__span-18-27><span class=w>    </span><span class=n>f</span><span class=p>.</span><span class=n>close</span><span class=p>();</span>
</span><span id=__span-18-28>
</span><span id=__span-18-29><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-18-30><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h2 id=_12>构建正排索引和构建倒排索引<a class=headerlink href=#_12 title="Permanent link">&para;</a></h2> <h3 id=_13>基本思路和结构介绍<a class=headerlink href=#_13 title="Permanent link">&para;</a></h3> <p>因为正排索引和倒排索引最后都会筛选出一组数据，这个数据肯定包括前面封装的结构体<code>ResultData</code>；另外，因为不论是正排索引和倒排索引，最后都需要知道当前的文档ID，所以此处需要创建一个结构体，包含这里提到的两个字段：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-19-1><span class=k>struct</span><span class=w> </span><span class=nc>SelectedDocInfo</span>
</span><span id=__span-19-2><span class=p>{</span>
</span><span id=__span-19-3><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>pd</span><span class=o>::</span><span class=n>ResultData</span><span class=w> </span><span class=n>rd</span><span class=p>;</span>
</span><span id=__span-19-4><span class=w>    </span><span class=kt>uint64_t</span><span class=w> </span><span class=n>id</span><span class=p>;</span>
</span><span id=__span-19-5><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>接着，为了创建一个类用于构建正排索引和倒排索引。在这个类中需要有两个成员，一个成员存储正排索引的结果，另外一个成员存储倒排索引的结果</p> <p>首先考虑正排索引，正排索引只需要根据文档ID查询到文档的信息即可，而因为数组可以通过下标访问元素，这就可以保证文档ID与数组下标进行对应，将来查询时直接使用文档ID即可获取到指定的文章信息，所以存储正排索引的结构可以是一个动态数组，而每一个元素就是<code>SelectedDocInfo</code>结构体对象</p> <p>接着是倒排索引，倒排索引是根据关键字进行构建的结果，而一个关键字可能对应着多个文章信息，所以这里首先需要一个有关当前关键字和相关文章的对应关系，也就是说，并不是直接通过关键字找出某一个文章信息，而是通过关键字对应的相关属性查询到具体的文章，这个属性包含文档ID、当前关键字和权重信息，通过权重信息筛选出结果后再根据其中的文档ID通过正排索引查询出对应的文章。根据这个思路，首先就需要一个用于保存关键字相关属性的结构：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-20-1><span class=c1>// 倒排索引时当前关键字的信息</span>
</span><span id=__span-20-2><span class=k>struct</span><span class=w> </span><span class=nc>BackwardIndexElement</span>
</span><span id=__span-20-3><span class=p>{</span>
</span><span id=__span-20-4><span class=w>    </span><span class=kt>uint64_t</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w> </span><span class=c1>// 文档ID</span>
</span><span id=__span-20-5><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>word</span><span class=p>;</span><span class=w> </span><span class=c1>// 关键字</span>
</span><span id=__span-20-6><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>weight</span><span class=p>;</span><span class=w> </span><span class=c1>// 权重信息</span>
</span><span id=__span-20-7><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>接着，因为在查询时肯定需要用到获取方法，可能是获取正排索引，也可能是获取倒排索引，所以在类中需要提供两个函数用于获取当前正排索引的<code>SelectedDocInfo</code>对象和倒排索引中存储<code>BackwardIndexElement</code>对象数组，为了避免结构体对象的频繁拷贝，考虑返回对应节点的指针</p> <p>考虑如何获取，对于正排索引来说，在前面介绍时已经提到是通过文档ID进行查询，所以获取时需要的参数就是文档ID；对于倒排索引来说，因为一个关键字可能对应着多个关键字信息节点<code>BackwardIndexElement</code>，对应的就需要用一个数组存储所有的信息节点，所以就需要建立一个哈希表用于关键字和关键字信息节点数组之间的映射关系，对应的获取时通过关键字获取到的就是关键字信息节点数组</p> <div class="tabbed-set tabbed-alternate" data-tabs=1:2><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><input id=__tabbed_1_2 name=__tabbed_1 type=radio><div class=tabbed-labels><label for=__tabbed_1_1><code>getForwardIndexDocInfo</code>函数</label><label for=__tabbed_1_2><code>getBackwardIndexElement</code>函数</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-21-1><span class=n>SelectedDocInfo</span><span class=w> </span><span class=o>*</span><span class=nf>getForwardIndexDocInfo</span><span class=p>()</span>
</span><span id=__span-21-2><span class=p>{</span>
</span><span id=__span-21-3><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-22-1><span class=c1>// 获取倒排索引结果</span>
</span><span id=__span-22-2><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>BackwardIndexElement</span><span class=o>&gt;</span><span class=w> </span><span class=o>*</span><span class=n>getBackwardIndexElement</span><span class=p>()</span>
</span><span id=__span-22-3><span class=p>{</span>
</span><span id=__span-22-4><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>接着，既然是建立索引，那么少不了的就是构建索引的函数。这个函数并不是只进行正排索引或者倒排索引，而是二者都进行，即当前函数包含着正排索引和倒排索引的主逻辑：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-23-1><span class=c1>// 构建索引</span>
</span><span id=__span-23-2><span class=kt>bool</span><span class=w> </span><span class=nf>buildIndex</span><span class=p>()</span>
</span><span id=__span-23-3><span class=p>{</span>
</span><span id=__span-23-4>
</span><span id=__span-23-5><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>所以，当前用于构建索引的类的结构如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-24-1><span class=k>class</span><span class=w> </span><span class=nc>SearchIndex</span>
</span><span id=__span-24-2><span class=p>{</span>
</span><span id=__span-24-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-24-4><span class=w>    </span><span class=c1>// 获取正排索引结果</span>
</span><span id=__span-24-5><span class=w>    </span><span class=n>SelectedDocInfo</span><span class=w> </span><span class=o>*</span><span class=n>getForwardIndexDocInfo</span><span class=p>()</span>
</span><span id=__span-24-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-24-7><span class=w>    </span><span class=p>}</span>
</span><span id=__span-24-8>
</span><span id=__span-24-9><span class=w>    </span><span class=c1>// 获取倒排索引结果</span>
</span><span id=__span-24-10><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>BackwardIndexElement</span><span class=o>&gt;</span><span class=w> </span><span class=o>*</span><span class=n>getBackwardIndexElement</span><span class=p>()</span>
</span><span id=__span-24-11><span class=w>    </span><span class=p>{</span>
</span><span id=__span-24-12><span class=w>    </span><span class=p>}</span>
</span><span id=__span-24-13>
</span><span id=__span-24-14><span class=w>    </span><span class=c1>// 构建索引</span>
</span><span id=__span-24-15><span class=w>    </span><span class=kt>bool</span><span class=w> </span><span class=n>buildIndex</span><span class=p>()</span>
</span><span id=__span-24-16><span class=w>    </span><span class=p>{</span>
</span><span id=__span-24-17>
</span><span id=__span-24-18><span class=w>    </span><span class=p>}</span>
</span><span id=__span-24-19>
</span><span id=__span-24-20><span class=k>private</span><span class=o>:</span>
</span><span id=__span-24-21><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>SelectedDocInfo</span><span class=o>&gt;</span><span class=w> </span><span class=n>forward_index_</span><span class=p>;</span><span class=w> </span><span class=c1>// 正排索引结果</span>
</span><span id=__span-24-22><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unordered_map</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>BackwardIndexElement</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>backward_index_</span><span class=p>;</span><span class=w> </span><span class=c1>// 倒排索引结果</span>
</span><span id=__span-24-23><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <h3 id=_14>实现构建索引函数<a class=headerlink href=#_14 title="Permanent link">&para;</a></h3> <p>既然要构建索引，那么少不了的就是获取到用于构建索引的内容，而在上一步：数据清洗中已经将清洗后的数据存储到了一个文本文件中，所以当前构建索引函数只需要从该文件中读取数据即可。读取数据时需要根据写入时的格式和方式进行读取，因为当时是使用二进制的方式进行写入，那么读取时就需要使用二进制的方式读取；另外，在构建内容时，每一个<code>ResultData</code>对象之间都是以<code>\n</code>进行的分隔，所以在读取一个<code>ResultData</code>对象数据时就可以直接使用<code>getline</code>函数（该函数不会读取到用于分隔的<code>\n</code>）</p> <p>接着，根据读取到的数据进行正排索引的构建和倒排索引的构建。这里的设计就涉及到前面提到的思路。首先，构建正排索引需要根据当前读取到的信息构建，所以参数需要传递一个当前读取到的信息，另外当前函数考虑返回一个<code>SelectedDocInfo</code>对象地址，只要这个对象地址不为空，就说明是成功构建一个了<code>SelectedDocInfo</code>对象，否则就不是。接着就是构建倒排索引，根据前面的思路，构建倒排索引需要使用到<code>SelectedDocInfo</code>对象中的文档ID值，所以构建倒排索引的函数需要传递一个<code>SelectedDocInfo</code>对象，而这个函数可以考虑返回一个布尔值</p> <p>基于上面的思路，所以构建索引函数的基本逻辑如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-25-1><span class=c1>// 构建索引</span>
</span><span id=__span-25-2><span class=kt>bool</span><span class=w> </span><span class=nf>buildIndex</span><span class=p>()</span>
</span><span id=__span-25-3><span class=p>{</span>
</span><span id=__span-25-4><span class=w>    </span><span class=c1>// 以二进制方式读取文本文件中的内容</span>
</span><span id=__span-25-5><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>fstream</span><span class=w> </span><span class=n>in</span><span class=p>(</span><span class=n>pd</span><span class=o>::</span><span class=n>g_rawfile_path</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>ios</span><span class=o>::</span><span class=n>in</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>ios</span><span class=o>::</span><span class=n>binary</span><span class=p>);</span>
</span><span id=__span-25-6>
</span><span id=__span-25-7><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>in</span><span class=p>.</span><span class=n>is_open</span><span class=p>())</span>
</span><span id=__span-25-8><span class=w>    </span><span class=p>{</span>
</span><span id=__span-25-9><span class=w>        </span><span class=n>ls</span><span class=o>::</span><span class=n>LOG</span><span class=p>(</span><span class=n>ls</span><span class=o>::</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;打开文本文件失败&quot;</span><span class=p>;</span>
</span><span id=__span-25-10><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-25-11><span class=w>    </span><span class=p>}</span>
</span><span id=__span-25-12>
</span><span id=__span-25-13><span class=w>    </span><span class=c1>// 读取每一个ResultData对象</span>
</span><span id=__span-25-14><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>line</span><span class=p>;</span>
</span><span id=__span-25-15><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=n>getline</span><span class=p>(</span><span class=n>in</span><span class=p>,</span><span class=w> </span><span class=n>line</span><span class=p>))</span>
</span><span id=__span-25-16><span class=w>    </span><span class=p>{</span>
</span><span id=__span-25-17><span class=w>        </span><span class=c1>// 构建正排索引</span>
</span><span id=__span-25-18><span class=w>        </span><span class=k>struct</span><span class=w> </span><span class=nc>SelectedDocInfo</span><span class=o>*</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buildForwardIndex</span><span class=p>(</span><span class=n>line</span><span class=p>);</span>
</span><span id=__span-25-19><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>s</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=k>nullptr</span><span class=p>)</span>
</span><span id=__span-25-20><span class=w>        </span><span class=p>{</span>
</span><span id=__span-25-21><span class=w>            </span><span class=n>ls</span><span class=o>::</span><span class=n>LOG</span><span class=p>(</span><span class=n>ls</span><span class=o>::</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;构建正排索引失败&quot;</span><span class=p>;</span>
</span><span id=__span-25-22><span class=w>            </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-25-23><span class=w>        </span><span class=p>}</span>
</span><span id=__span-25-24>
</span><span id=__span-25-25><span class=w>        </span><span class=c1>// 构建倒排索引</span>
</span><span id=__span-25-26><span class=w>        </span><span class=kt>bool</span><span class=w> </span><span class=n>flag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buildBackwardIndex</span><span class=p>(</span><span class=o>*</span><span class=n>s</span><span class=p>);</span>
</span><span id=__span-25-27>
</span><span id=__span-25-28><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>flag</span><span class=p>)</span>
</span><span id=__span-25-29><span class=w>        </span><span class=p>{</span>
</span><span id=__span-25-30><span class=w>            </span><span class=n>ls</span><span class=o>::</span><span class=n>LOG</span><span class=p>(</span><span class=n>ls</span><span class=o>::</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;构建倒排索引失败&quot;</span><span class=p>;</span>
</span><span id=__span-25-31><span class=w>            </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-25-32><span class=w>        </span><span class=p>}</span>
</span><span id=__span-25-33><span class=w>    </span><span class=p>}</span>
</span><span id=__span-25-34>
</span><span id=__span-25-35><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-25-36><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>接下来就是实现构建正排索引函数和构建倒排索引函数</p> <h3 id=buildforwardindex>实现构建正排索引<code>buildForwardIndex</code><a class=headerlink href=#buildforwardindex title="Permanent link">&para;</a></h3> <p>构建正排索引函数思路就是根据当前文章的内容填入<code>SelectedDocInfo</code>对象中对应的信息</p> <p>思路虽然比较简短，但是其中的实现方式其实并不简短。当前<code>buildForwardIndex</code>函数接收到了一行的数据，这个数据不包括结尾的<code>\n</code>，所以在当前函数中要考虑的就是读取到一行数据中以<code>\3</code>分隔的三个字段，这里涉及到了对整体数据按照某一种分隔符进行切割，按照之前的思路就是使用<code>strtok</code>函数，但是这个函数使用起来并不方便，所以本次可以考虑两个思路：</p> <ol> <li>使用Boost库中的<code>split</code>函数</li> <li>使用string_view实现自定义的<code>split</code>函数</li> </ol> <div class="admonition note"> <p class=admonition-title>为什么用string_view而不是string实现<code>split</code>函数</p> <p>因为string_view的性能远高于直接使用string，具体分析见<a href=#>C++17 相关新特性</a></p> </div> <p><strong>使用Boost库中的<code>split</code>函数：</strong></p> <p>首先介绍第一种思路，在Boost库中，提供了字符串切割的函数<code>split</code>，这个函数的原型如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-26-1><span class=k>template</span><span class=o>&lt;</span><span class=k>typename</span><span class=w> </span><span class=nc>SequenceSequenceT</span><span class=p>,</span><span class=w> </span><span class=k>typename</span><span class=w> </span><span class=nc>RangeT</span><span class=p>,</span><span class=w> </span><span class=k>typename</span><span class=w> </span><span class=nc>PredicateT</span><span class=o>&gt;</span><span class=w>  </span>
</span><span id=__span-26-2><span class=n>SequenceSequenceT</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>split</span><span class=p>(</span><span class=n>SequenceSequenceT</span><span class=w> </span><span class=o>&amp;</span><span class=p>,</span><span class=w> </span><span class=n>RangeT</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=p>,</span><span class=w> </span><span class=n>PredicateT</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-26-3><span class=w>            </span><span class=n>token_compress_mode_type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>token_compress_off</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>这个函数的第一个参数是输出型参数，表示切割后的每一段内容的存储位置，第二个参数表示需要切割的内容，第三个参数表示分隔符，第四个参数表示是否需要开启压缩模式，默认为关闭状态，使用示例如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-27-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;boost/algorithm/string.hpp&gt;</span>
</span><span id=__span-27-2>
</span><span id=__span-27-3><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-27-4><span class=p>{</span>
</span><span id=__span-27-5><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>str</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;aaaaa</span><span class=se>\3</span><span class=s>bbbbb</span><span class=se>\3</span><span class=s>ccccc&quot;</span><span class=p>;</span><span class=w> </span><span class=c1>// 原始数据</span>
</span><span id=__span-27-6><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=w> </span><span class=n>out</span><span class=p>;</span><span class=w> </span><span class=c1>// 存储切割后的数据</span>
</span><span id=__span-27-7><span class=w>    </span><span class=c1>// 以\3作为切割符切割，默认不压缩</span>
</span><span id=__span-27-8><span class=w>    </span><span class=n>boost</span><span class=o>::</span><span class=n>split</span><span class=p>(</span><span class=n>out</span><span class=p>,</span><span class=w> </span><span class=n>str</span><span class=p>,</span><span class=w> </span><span class=n>boost</span><span class=o>::</span><span class=n>is_any_of</span><span class=p>(</span><span class=s>&quot;</span><span class=se>\3</span><span class=s>&quot;</span><span class=p>));</span>
</span><span id=__span-27-9>
</span><span id=__span-27-10><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>for_each</span><span class=p>(</span><span class=n>out</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span><span class=w> </span><span class=n>out</span><span class=p>.</span><span class=n>end</span><span class=p>(),</span><span class=w> </span><span class=p>[</span><span class=o>&amp;</span><span class=n>out</span><span class=p>](</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>s</span><span class=p>){</span>
</span><span id=__span-27-11><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-27-12><span class=w>    </span><span class=p>});</span>
</span><span id=__span-27-13>
</span><span id=__span-27-14><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-27-15><span class=p>}</span>
</span><span id=__span-27-16>
</span><span id=__span-27-17><span class=n>输出结果</span><span class=err>：</span>
</span><span id=__span-27-18><span class=n>aaaaa</span>
</span><span id=__span-27-19><span class=n>bbbbb</span>
</span><span id=__span-27-20><span class=n>ccccc</span>
</span></code></pre></div></td></tr></table></div> <p>上面使用默认的不压缩，所谓的压缩，就是对于连续出现多次<code>\3</code>时将其压缩为一个<code>\3</code>处理：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-28-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;boost/algorithm/string.hpp&gt;</span>
</span><span id=__span-28-2>
</span><span id=__span-28-3><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-28-4><span class=p>{</span>
</span><span id=__span-28-5><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>str</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;aaaaa</span><span class=se>\3\3\3\3\3</span><span class=s>bbbbb</span><span class=se>\3</span><span class=s>ccccc&quot;</span><span class=p>;</span><span class=w> </span><span class=c1>// 原始数据</span>
</span><span id=__span-28-6><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=w> </span><span class=n>out</span><span class=p>;</span><span class=w> </span><span class=c1>// 存储切割后的数据</span>
</span><span id=__span-28-7><span class=w>    </span><span class=c1>// 以\3作为切割符切割，压缩</span>
</span><span id=__span-28-8><span class=w>    </span><span class=n>boost</span><span class=o>::</span><span class=n>split</span><span class=p>(</span><span class=n>out</span><span class=p>,</span><span class=w> </span><span class=n>str</span><span class=p>,</span><span class=w> </span><span class=n>boost</span><span class=o>::</span><span class=n>is_any_of</span><span class=p>(</span><span class=s>&quot;</span><span class=se>\3</span><span class=s>&quot;</span><span class=p>),</span><span class=w> </span><span class=n>boost</span><span class=o>::</span><span class=n>token_compress_on</span><span class=p>);</span>
</span><span id=__span-28-9>
</span><span id=__span-28-10><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>for_each</span><span class=p>(</span><span class=n>out</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span><span class=w> </span><span class=n>out</span><span class=p>.</span><span class=n>end</span><span class=p>(),</span><span class=w> </span><span class=p>[</span><span class=o>&amp;</span><span class=n>out</span><span class=p>](</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>s</span><span class=p>){</span>
</span><span id=__span-28-11><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-28-12><span class=w>    </span><span class=p>});</span>
</span><span id=__span-28-13>
</span><span id=__span-28-14><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-28-15><span class=p>}</span>
</span><span id=__span-28-16>
</span><span id=__span-28-17><span class=n>输出结果</span><span class=err>：</span>
</span><span id=__span-28-18><span class=n>aaaaa</span>
</span><span id=__span-28-19><span class=n>bbbbb</span>
</span><span id=__span-28-20><span class=n>ccccc</span>
</span></code></pre></div></td></tr></table></div> <p>如果上面的代码中不进行压缩，那么默认结果如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-29-1><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-29-2><span class=p>{</span>
</span><span id=__span-29-3><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-29-4><span class=w>    </span><span class=n>boost</span><span class=o>::</span><span class=n>split</span><span class=p>(</span><span class=n>out</span><span class=p>,</span><span class=w> </span><span class=n>str</span><span class=p>,</span><span class=w> </span><span class=n>boost</span><span class=o>::</span><span class=n>is_any_of</span><span class=p>(</span><span class=s>&quot;</span><span class=se>\3</span><span class=s>&quot;</span><span class=p>));</span>
</span><span id=__span-29-5><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-29-6><span class=p>}</span>
</span><span id=__span-29-7>
</span><span id=__span-29-8><span class=n>输出结果</span><span class=err>：</span>
</span><span id=__span-29-9><span class=n>aaaaa</span>
</span><span id=__span-29-10>
</span><span id=__span-29-11>
</span><span id=__span-29-12>
</span><span id=__span-29-13>
</span><span id=__span-29-14><span class=n>bbbbb</span>
</span><span id=__span-29-15><span class=n>ccccc</span>
</span></code></pre></div></td></tr></table></div> <p>基于上面的使用示例，接下来就是根据<code>\3</code>对读取到的一行内容进行分隔，将分割后的内容存储到一个vector中便于接下来创建<code>ResultData</code>对象可以快速填充字段，为了便于可维护性，将切割逻辑单独作为一个函数抽离：</p> <div class="tabbed-set tabbed-alternate" data-tabs=2:2><input checked=checked id=__tabbed_2_1 name=__tabbed_2 type=radio><input id=__tabbed_2_2 name=__tabbed_2 type=radio><div class=tabbed-labels><label for=__tabbed_2_1>切割字符串函数</label><label for=__tabbed_2_2>构建正排索引函数</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-30-1><span class=c1>// boost中的split</span>
</span><span id=__span-30-2><span class=kt>void</span><span class=w> </span><span class=nf>split</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;&amp;</span><span class=w> </span><span class=n>out</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>line</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>sep</span><span class=p>)</span>
</span><span id=__span-30-3><span class=p>{</span>
</span><span id=__span-30-4><span class=w>    </span><span class=n>boost</span><span class=o>::</span><span class=n>split</span><span class=p>(</span><span class=n>out</span><span class=p>,</span><span class=w> </span><span class=n>line</span><span class=p>,</span><span class=w> </span><span class=n>boost</span><span class=o>::</span><span class=n>is_any_of</span><span class=p>(</span><span class=s>&quot;</span><span class=se>\3</span><span class=s>&quot;</span><span class=p>),</span><span class=w> </span><span class=n>boost</span><span class=o>::</span><span class=n>token_compress_on</span><span class=p>);</span>
</span><span id=__span-30-5><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-31-1><span class=n>SelectedDocInfo</span><span class=w> </span><span class=o>*</span><span class=nf>buildForwardIndex</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>line</span><span class=p>)</span>
</span><span id=__span-31-2><span class=p>{</span>
</span><span id=__span-31-3><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=w> </span><span class=n>out</span><span class=p>;</span>
</span><span id=__span-31-4><span class=w>    </span><span class=n>split</span><span class=p>(</span><span class=n>out</span><span class=p>,</span><span class=w> </span><span class=n>line</span><span class=p>,</span><span class=w> </span><span class=n>pd</span><span class=o>::</span><span class=n>g_rd_sep</span><span class=p>);</span>
</span><span id=__span-31-5>
</span><span id=__span-31-6><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>out</span><span class=p>.</span><span class=n>size</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>3</span><span class=p>)</span>
</span><span id=__span-31-7><span class=w>    </span><span class=p>{</span>
</span><span id=__span-31-8><span class=w>        </span><span class=n>ls</span><span class=o>::</span><span class=n>LOG</span><span class=p>(</span><span class=n>ls</span><span class=o>::</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;无法读取元信息&quot;</span><span class=p>;</span>
</span><span id=__span-31-9><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>nullptr</span><span class=p>;</span>
</span><span id=__span-31-10><span class=w>    </span><span class=p>}</span>
</span><span id=__span-31-11>
</span><span id=__span-31-12><span class=w>    </span><span class=n>SelectedDocInfo</span><span class=w> </span><span class=n>sd</span><span class=p>;</span>
</span><span id=__span-31-13><span class=w>    </span><span class=c1>// 注意填充顺序</span>
</span><span id=__span-31-14><span class=w>    </span><span class=n>sd</span><span class=p>.</span><span class=n>rd</span><span class=p>.</span><span class=n>title</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>out</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span><span id=__span-31-15><span class=w>    </span><span class=n>sd</span><span class=p>.</span><span class=n>rd</span><span class=p>.</span><span class=n>body</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>out</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span><span id=__span-31-16><span class=w>    </span><span class=n>sd</span><span class=p>.</span><span class=n>rd</span><span class=p>.</span><span class=n>url</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>out</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span><span id=__span-31-17><span class=w>    </span><span class=c1>// 先设置id时直接使用正排索引数组长度</span>
</span><span id=__span-31-18><span class=w>    </span><span class=n>sd</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>forward_index_</span><span class=p>.</span><span class=n>size</span><span class=p>();</span>
</span><span id=__span-31-19><span class=w>    </span><span class=c1>// 再添加SelectedDocInfo对象</span>
</span><span id=__span-31-20><span class=w>    </span><span class=n>forward_index_</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>sd</span><span class=p>));</span>
</span><span id=__span-31-21>
</span><span id=__span-31-22><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=n>forward_index_</span><span class=p>.</span><span class=n>back</span><span class=p>();</span>
</span><span id=__span-31-23><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p><strong>使用string_view实现自定义的<code>split</code>函数：</strong></p> <p>接下来思考第二种方式，使用string_view自主实现一个<code>split</code>函数，实现的基本思路与直接使用string是基本一致的，但是如果直接使用string会出现各种拷贝的情况。而最后在插入到结果集中时需要注意重新转换为string对象，因为参数传递的<code>line</code>属于局部对象，离开了<code>while</code>代码块就会销毁，这就直接导致了vector中存储的数据丢失导致的野指针问题，所以vector需要存储string对象，这里是无法避免的。整体的实现方式如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-32-1><span class=c1>// 使用string_view自主实现split</span>
</span><span id=__span-32-2><span class=kt>void</span><span class=w> </span><span class=nf>split</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=w> </span><span class=o>&amp;</span><span class=n>out</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string_view</span><span class=w> </span><span class=n>line</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string_view</span><span class=w> </span><span class=n>sep</span><span class=p>)</span>
</span><span id=__span-32-3><span class=p>{</span>
</span><span id=__span-32-4><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>line</span><span class=p>.</span><span class=n>empty</span><span class=p>())</span>
</span><span id=__span-32-5><span class=w>        </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-32-6>
</span><span id=__span-32-7><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-32-8><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>found</span><span class=p>;</span>
</span><span id=__span-32-9>
</span><span id=__span-32-10><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>((</span><span class=n>found</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>line</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>sep</span><span class=p>,</span><span class=w> </span><span class=n>pos</span><span class=p>))</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string_view</span><span class=o>::</span><span class=n>npos</span><span class=p>)</span>
</span><span id=__span-32-11><span class=w>    </span><span class=p>{</span>
</span><span id=__span-32-12><span class=w>        </span><span class=c1>// 添加当前位置到分隔符之间的子字符串</span>
</span><span id=__span-32-13><span class=w>        </span><span class=n>out</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=p>(</span><span class=n>line</span><span class=p>.</span><span class=n>substr</span><span class=p>(</span><span class=n>pos</span><span class=p>,</span><span class=w> </span><span class=n>found</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>pos</span><span class=p>)));</span>
</span><span id=__span-32-14><span class=w>        </span><span class=c1>// 更新位置到分隔符之后</span>
</span><span id=__span-32-15><span class=w>        </span><span class=n>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>found</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>sep</span><span class=p>.</span><span class=n>length</span><span class=p>();</span>
</span><span id=__span-32-16><span class=w>    </span><span class=p>}</span>
</span><span id=__span-32-17>
</span><span id=__span-32-18><span class=w>    </span><span class=c1>// 添加最后一个分隔符之后的子字符串</span>
</span><span id=__span-32-19><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pos</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>line</span><span class=p>.</span><span class=n>length</span><span class=p>())</span>
</span><span id=__span-32-20><span class=w>        </span><span class=n>out</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=p>(</span><span class=n>line</span><span class=p>.</span><span class=n>substr</span><span class=p>(</span><span class=n>pos</span><span class=p>)));</span>
</span><span id=__span-32-21><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>构建正排索引的主逻辑代码不需要改变，因为string_view对象可以通过string对象构建</p> <h3 id=buildbackwardindex>实现构建倒排索引<code>buildBackwardIndex</code><a class=headerlink href=#buildbackwardindex title="Permanent link">&para;</a></h3> <p>为了构建倒排索引首先需要知道本次构建倒排索引的思路：</p> <p>倒排索引本质就是根据已有的关键字筛选出出现该关键字的文章</p> <p>基于上面这个本质，可以推出两种情况：</p> <ol> <li>一个关键字可能对应着多个文档 </li> <li>一个文档内可能含有多个关键字</li> </ol> <p>很明显，上面构成的是一种“多对多”的关系</p> <p>首先从一方面考虑：一个文档中含有多个关键字。根据前面的结构<code>SelectDocInfo</code>中的内容，其中的<code>ResultData</code>结构体中存在着<code>title</code>和<code>content</code>字段，这两个字段都有可能出现某一个关键字，所以二者都需要考虑。再看前面的<code>BackwardIndexElement</code>结构，这个结构中含有关键字、文档ID和文章权重三个字段，既然是一个文档中含有多个关键字，那么对于同一篇文档，多个关键字<code>BackwardIndexElement</code>对象中的文档ID一定是相同的</p> <p>接下来考虑关键字的问题，关键字既可能出现在<code>title</code>中，也可能出现在<code>content</code>中，那么必然需要对<code>title</code>和<code>content</code>两部分进行分词解析提取出其中的关键字，这里可以为每一个关键字建立一个结构体<code>WordCount</code>，这个结构体中存储着当前关键字在当前文档中的标题和内容部分出现的次数，所以有两个变量<code>title_cnt</code>和<code>body_cnt</code>，而为了建立关键字和对应的关键字出现次数结构体之间的映射关系，就需要用到一个<code>unordered_map&lt;string, WordCount&gt;</code>，分别统计<code>title</code>和<code>content</code>中关键字出现的次数更新对应字段的值即可统计出当前关键字在当前文档中出现的次数</p> <p>最后，在<code>BackwardIndexElement</code>中还有一个字段：权重，本质上这里需要涉及到相关性分析，但是相关性分析是一套很复杂的过程，所以本次为了简便，考虑一种思路：关键字出现在标题的权重值要大于关键字出现在内容的权重值，所以可以设计权重的计算公式为<span class=arithmatex>\(title \times 10 + body\)</span>，这样就完成了一篇文档内所有关键字的统计</p> <p>最后，既然是“多对多”的关系，那么除了考虑一个文档内含有多个关键字以外，还需要考虑一个关键字对应多个文档的情况。实际上，因为每一个文档都需要统计当前文档中所有的关键字，而一旦所有的文档全部统计完毕就相当于处理了一个关键字对应多个文档的情况</p> <p>基于上面的思路，首先需要一个结构体<code>WordCount</code>表示一个关键字分别在标题和文章中出现的频率：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-33-1><span class=c1>// 频率结构</span>
</span><span id=__span-33-2><span class=k>struct</span><span class=w> </span><span class=nc>WordCount</span>
</span><span id=__span-33-3><span class=p>{</span>
</span><span id=__span-33-4><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>title_cnt</span><span class=p>;</span>
</span><span id=__span-33-5><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>body_cnt</span><span class=p>;</span>
</span><span id=__span-33-6><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>接着，还需要一个哈希表用于表示这个关键字和对应词频结构对象之间的映射关系，所以需要在索引类中添加一个哈希表成员：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-34-1><span class=n>std</span><span class=o>::</span><span class=n>unordered_map</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=p>,</span><span class=w> </span><span class=n>WordCount</span><span class=o>&gt;</span><span class=w> </span><span class=n>word_cnt_</span><span class=p>;</span><span class=w> </span><span class=c1>// 词频统计</span>
</span></code></pre></div></td></tr></table></div> <p>根据上面的思路实现<code>buildBackwardIndex</code>函数，但是实现之前首先需要提取出标题和内容中的关键字，这里就需要用到分词工具Jieba：</p> <p>根据Jieba的操作指示，首先需要将远程的Jieba克隆到本地，具体存放位置自定义：</p> <div class="language-shell highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-35-1>git<span class=w> </span>clone<span class=w> </span>https://github.com/yanyiwu/cppjieba.git
</span></code></pre></div></td></tr></table></div> <p>接着，为了能在项目中使用，考虑在当前路径下建立软链接指向<code>cppjieba</code>文件夹中的<code>include</code>目录，例如：</p> <div class="language-shell highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-36-1>ln<span class=w> </span>-s<span class=w> </span>/home/epsda/dependencies/cppjieba/include<span class=w> </span>include
</span></code></pre></div></td></tr></table></div> <p>创建完成后就可以看到下面的信息：</p> <div class="language-shell highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-37-1>lrwxrwxrwx<span class=w> </span><span class=m>1</span><span class=w> </span>epsda<span class=w> </span>epsda<span class=w> </span><span class=m>41</span><span class=w> </span>Apr<span class=w> </span><span class=m>3</span><span class=w> </span><span class=m>09</span>:28<span class=w> </span>include<span class=w> </span>-&gt;<span class=w> </span>/home/epsda/dependencies/cppjieba/include/
</span></code></pre></div></td></tr></table></div> <p>在接下来的项目中使用就可以通过下面的方式引入：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-38-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;include/cppjieba/Jieba.hpp&quot;</span>
</span></code></pre></div></td></tr></table></div> <p>但是，如果执行上面的步骤就会出现丢失文件的问题，本质是因为<code>Jieba.hpp</code>中的<code>QuerySegment.hpp</code>引入了<code>limonp/Logging.hpp</code>，这个文件在新版的Jieba库中并不是直接存储在Jieba仓库中，而是单独在limonp仓库中，所以接下来需要克隆limonp仓库：</p> <div class="language-shell highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-39-1>git<span class=w> </span>clone<span class=w> </span>https://github.com/yanyiwu/limonp.git
</span></code></pre></div></td></tr></table></div> <p>克隆完成后可以在该仓库中的<code>include</code>文件夹下找到<code>limonp</code>文件夹，这个文件夹中就包含了<code>Logging.hpp</code>文件，所以只需要将<code>include/limonp</code>拷贝到cppjieba目录中的<code>include</code>目录中即可，最后的目录结构如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-40-1><span class=o>/</span><span class=n>home</span><span class=o>/</span><span class=n>epsda</span><span class=o>/</span><span class=n>dependencies</span><span class=o>/</span><span class=n>cppjieba</span><span class=o>/</span><span class=n>include</span><span class=o>/</span><span class=n>cppjieba</span>
</span><span id=__span-40-2><span class=err>├──</span><span class=w> </span><span class=n>DictTrie</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-40-3><span class=err>├──</span><span class=w> </span><span class=n>FullSegment</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-40-4><span class=err>├──</span><span class=w> </span><span class=n>HMMModel</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-40-5><span class=err>├──</span><span class=w> </span><span class=n>HMMSegment</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-40-6><span class=err>├──</span><span class=w> </span><span class=n>Jieba</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-40-7><span class=err>├──</span><span class=w> </span><span class=n>KeywordExtractor</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-40-8><span class=err>├──</span><span class=w> </span><span class=n>MPSegment</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-40-9><span class=err>├──</span><span class=w> </span><span class=n>MixSegment</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-40-10><span class=err>├──</span><span class=w> </span><span class=n>PosTagger</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-40-11><span class=err>├──</span><span class=w> </span><span class=n>PreFilter</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-40-12><span class=err>├──</span><span class=w> </span><span class=n>QuerySegment</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-40-13><span class=err>├──</span><span class=w> </span><span class=n>SegmentBase</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-40-14><span class=err>├──</span><span class=w> </span><span class=n>SegmentTagged</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-40-15><span class=err>├──</span><span class=w> </span><span class=n>TextRankExtractor</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-40-16><span class=err>├──</span><span class=w> </span><span class=n>Trie</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-40-17><span class=err>├──</span><span class=w> </span><span class=n>Unicode</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-40-18><span class=err>└──</span><span class=w> </span><span class=n>limonp</span><span class=w> </span><span class=c1>// limonp文件</span>
</span><span id=__span-40-19><span class=w>    </span><span class=err>├──</span><span class=w> </span><span class=n>ArgvContext</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-40-20><span class=w>    </span><span class=err>├──</span><span class=w> </span><span class=n>Closure</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-40-21><span class=w>    </span><span class=err>├──</span><span class=w> </span><span class=n>Colors</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-40-22><span class=w>    </span><span class=err>├──</span><span class=w> </span><span class=n>Condition</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-40-23><span class=w>    </span><span class=err>├──</span><span class=w> </span><span class=n>Config</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-40-24><span class=w>    </span><span class=err>├──</span><span class=w> </span><span class=n>ForcePublic</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-40-25><span class=w>    </span><span class=err>├──</span><span class=w> </span><span class=n>LocalVector</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-40-26><span class=w>    </span><span class=err>├──</span><span class=w> </span><span class=n>Logging</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-40-27><span class=w>    </span><span class=err>├──</span><span class=w> </span><span class=n>NonCopyable</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-40-28><span class=w>    </span><span class=err>├──</span><span class=w> </span><span class=n>StdExtension</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-40-29><span class=w>    </span><span class=err>└──</span><span class=w> </span><span class=n>StringUtil</span><span class=p>.</span><span class=n>hpp</span>
</span></code></pre></div></td></tr></table></div> <p>接着，执行Jieba的测试代码：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-41-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-41-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;include/cppjieba/Jieba.hpp&quot;</span>
</span><span id=__span-41-3>
</span><span id=__span-41-4><span class=k>using</span><span class=w> </span><span class=k>namespace</span><span class=w> </span><span class=nn>std</span><span class=p>;</span>
</span><span id=__span-41-5>
</span><span id=__span-41-6><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>**</span><span class=n>argv</span><span class=p>)</span>
</span><span id=__span-41-7><span class=p>{</span>
</span><span id=__span-41-8><span class=w>    </span><span class=n>cppjieba</span><span class=o>::</span><span class=n>Jieba</span><span class=w> </span><span class=n>jieba</span><span class=p>;</span>
</span><span id=__span-41-9><span class=w>    </span><span class=n>vector</span><span class=o>&lt;</span><span class=n>string</span><span class=o>&gt;</span><span class=w> </span><span class=n>words</span><span class=p>;</span>
</span><span id=__span-41-10><span class=w>    </span><span class=n>vector</span><span class=o>&lt;</span><span class=n>cppjieba</span><span class=o>::</span><span class=n>Word</span><span class=o>&gt;</span><span class=w> </span><span class=n>jiebawords</span><span class=p>;</span>
</span><span id=__span-41-11><span class=w>    </span><span class=n>string</span><span class=w> </span><span class=n>s</span><span class=p>;</span>
</span><span id=__span-41-12><span class=w>    </span><span class=n>string</span><span class=w> </span><span class=n>result</span><span class=p>;</span>
</span><span id=__span-41-13>
</span><span id=__span-41-14><span class=w>    </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;他来到了网易杭研大厦&quot;</span><span class=p>;</span>
</span><span id=__span-41-15><span class=w>    </span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-41-16><span class=w>    </span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;[demo] Cut With HMM&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-41-17><span class=w>    </span><span class=n>jieba</span><span class=p>.</span><span class=n>Cut</span><span class=p>(</span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=n>words</span><span class=p>,</span><span class=w> </span><span class=nb>true</span><span class=p>);</span>
</span><span id=__span-41-18><span class=w>    </span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>limonp</span><span class=o>::</span><span class=n>Join</span><span class=p>(</span><span class=n>words</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span><span class=w> </span><span class=n>words</span><span class=p>.</span><span class=n>end</span><span class=p>(),</span><span class=w> </span><span class=s>&quot;/&quot;</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-41-19>
</span><span id=__span-41-20><span class=w>    </span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;[demo] Cut Without HMM &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-41-21><span class=w>    </span><span class=n>jieba</span><span class=p>.</span><span class=n>Cut</span><span class=p>(</span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=n>words</span><span class=p>,</span><span class=w> </span><span class=nb>false</span><span class=p>);</span>
</span><span id=__span-41-22><span class=w>    </span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>limonp</span><span class=o>::</span><span class=n>Join</span><span class=p>(</span><span class=n>words</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span><span class=w> </span><span class=n>words</span><span class=p>.</span><span class=n>end</span><span class=p>(),</span><span class=w> </span><span class=s>&quot;/&quot;</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-41-23>
</span><span id=__span-41-24><span class=w>    </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;我来到北京清华大学&quot;</span><span class=p>;</span>
</span><span id=__span-41-25><span class=w>    </span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-41-26><span class=w>    </span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;[demo] CutAll&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-41-27><span class=w>    </span><span class=n>jieba</span><span class=p>.</span><span class=n>CutAll</span><span class=p>(</span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=n>words</span><span class=p>);</span>
</span><span id=__span-41-28><span class=w>    </span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>limonp</span><span class=o>::</span><span class=n>Join</span><span class=p>(</span><span class=n>words</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span><span class=w> </span><span class=n>words</span><span class=p>.</span><span class=n>end</span><span class=p>(),</span><span class=w> </span><span class=s>&quot;/&quot;</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-41-29>
</span><span id=__span-41-30><span class=w>    </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;小明硕士毕业于中国科学院计算所，后在日本京都大学深造&quot;</span><span class=p>;</span>
</span><span id=__span-41-31><span class=w>    </span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-41-32><span class=w>    </span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;[demo] CutForSearch&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-41-33><span class=w>    </span><span class=n>jieba</span><span class=p>.</span><span class=n>CutForSearch</span><span class=p>(</span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=n>words</span><span class=p>);</span>
</span><span id=__span-41-34><span class=w>    </span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>limonp</span><span class=o>::</span><span class=n>Join</span><span class=p>(</span><span class=n>words</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span><span class=w> </span><span class=n>words</span><span class=p>.</span><span class=n>end</span><span class=p>(),</span><span class=w> </span><span class=s>&quot;/&quot;</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-41-35>
</span><span id=__span-41-36><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>EXIT_SUCCESS</span><span class=p>;</span>
</span><span id=__span-41-37><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>上面的代码相对于原始的<code>demo.cpp</code>中删除了部分不需要的代码，不影响整体代码运行</p> </div> <p>这个代码在<code>demo.cpp</code>文件中，<code>demo.cpp</code>可以在<a href=https://github.com/yanyiwu/cppjieba-demo/blob/main/demo.cpp>此链接</a>处可以找到，但是需要注意，如果直接使用这个文件会出现找不到字典文件的问题，因为该文件中默认初始化<code>Jieba</code>类时使用的是下面的方式：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-42-1><span class=c1>// ...</span>
</span><span id=__span-42-2><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=o>**</span><span class=w> </span><span class=n>argv</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-3><span class=w>    </span><span class=n>cppjieba</span><span class=o>::</span><span class=n>Jieba</span><span class=w> </span><span class=n>jieba</span><span class=p>;</span>
</span><span id=__span-42-4><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-42-5><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>但是，在<code>Jieba.hpp</code>中可以看到初始化时默认字典值都是空：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-43-1><span class=c1>// ...</span>
</span><span id=__span-43-2><span class=k>class</span><span class=w> </span><span class=nc>Jieba</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-43-3><span class=w>    </span><span class=k>public</span><span class=o>:</span>
</span><span id=__span-43-4><span class=w>    </span><span class=n>Jieba</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>dict_path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;&quot;</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-43-5><span class=w>            </span><span class=k>const</span><span class=w> </span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>model_path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;&quot;</span><span class=p>,</span>
</span><span id=__span-43-6><span class=w>            </span><span class=k>const</span><span class=w> </span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>user_dict_path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;&quot;</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-43-7><span class=w>            </span><span class=k>const</span><span class=w> </span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>idf_path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;&quot;</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-43-8><span class=w>            </span><span class=k>const</span><span class=w> </span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>stop_word_path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;&quot;</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-43-9><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=n>dict_trie_</span><span class=p>(</span><span class=n>getPath</span><span class=p>(</span><span class=n>dict_path</span><span class=p>,</span><span class=w> </span><span class=s>&quot;jieba.dict.utf8&quot;</span><span class=p>),</span><span class=w> </span><span class=n>getPath</span><span class=p>(</span><span class=n>user_dict_path</span><span class=p>,</span><span class=w> </span><span class=s>&quot;user.dict.utf8&quot;</span><span class=p>)),</span>
</span><span id=__span-43-10><span class=w>        </span><span class=n>model_</span><span class=p>(</span><span class=n>getPath</span><span class=p>(</span><span class=n>model_path</span><span class=p>,</span><span class=w> </span><span class=s>&quot;hmm_model.utf8&quot;</span><span class=p>)),</span>
</span><span id=__span-43-11><span class=w>        </span><span class=n>mp_seg_</span><span class=p>(</span><span class=o>&amp;</span><span class=n>dict_trie_</span><span class=p>),</span>
</span><span id=__span-43-12><span class=w>        </span><span class=n>hmm_seg_</span><span class=p>(</span><span class=o>&amp;</span><span class=n>model_</span><span class=p>),</span>
</span><span id=__span-43-13><span class=w>        </span><span class=n>mix_seg_</span><span class=p>(</span><span class=o>&amp;</span><span class=n>dict_trie_</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>model_</span><span class=p>),</span>
</span><span id=__span-43-14><span class=w>        </span><span class=n>full_seg_</span><span class=p>(</span><span class=o>&amp;</span><span class=n>dict_trie_</span><span class=p>),</span>
</span><span id=__span-43-15><span class=w>        </span><span class=n>query_seg_</span><span class=p>(</span><span class=o>&amp;</span><span class=n>dict_trie_</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>model_</span><span class=p>),</span>
</span><span id=__span-43-16><span class=w>        </span><span class=n>extractor</span><span class=p>(</span><span class=o>&amp;</span><span class=n>dict_trie_</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>model_</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-43-17><span class=w>                    </span><span class=n>getPath</span><span class=p>(</span><span class=n>idf_path</span><span class=p>,</span><span class=w> </span><span class=s>&quot;idf.utf8&quot;</span><span class=p>),</span><span class=w> </span>
</span><span id=__span-43-18><span class=w>                    </span><span class=n>getPath</span><span class=p>(</span><span class=n>stop_word_path</span><span class=p>,</span><span class=w> </span><span class=s>&quot;stop_words.utf8&quot;</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-43-19><span class=w>    </span><span class=p>}</span>
</span><span id=__span-43-20><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-43-21>
</span><span id=__span-43-22><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=n>string</span><span class=w> </span><span class=n>getPath</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>path</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>default_file</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-43-23><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>path</span><span class=p>.</span><span class=n>empty</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-43-24><span class=w>            </span><span class=n>string</span><span class=w> </span><span class=n>current_dir</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getCurrentDirectory</span><span class=p>();</span>
</span><span id=__span-43-25><span class=w>            </span><span class=n>string</span><span class=w> </span><span class=n>parent_dir</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>current_dir</span><span class=p>.</span><span class=n>substr</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>current_dir</span><span class=p>.</span><span class=n>find_last_of</span><span class=p>(</span><span class=s>&quot;/</span><span class=se>\\</span><span class=s>&quot;</span><span class=p>));</span>
</span><span id=__span-43-26><span class=w>            </span><span class=n>string</span><span class=w> </span><span class=n>grandparent_dir</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parent_dir</span><span class=p>.</span><span class=n>substr</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>parent_dir</span><span class=p>.</span><span class=n>find_last_of</span><span class=p>(</span><span class=s>&quot;/</span><span class=se>\\</span><span class=s>&quot;</span><span class=p>));</span>
</span><span id=__span-43-27><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>pathJoin</span><span class=p>(</span><span class=n>pathJoin</span><span class=p>(</span><span class=n>grandparent_dir</span><span class=p>,</span><span class=w> </span><span class=s>&quot;dict&quot;</span><span class=p>),</span><span class=w> </span><span class=n>default_file</span><span class=p>);</span>
</span><span id=__span-43-28><span class=w>        </span><span class=p>}</span>
</span><span id=__span-43-29><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>path</span><span class=p>;</span>
</span><span id=__span-43-30><span class=w>    </span><span class=p>}</span>
</span><span id=__span-43-31><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>根据<code>getPath</code>函数的逻辑：如果用户指定的字典文件路径为空，那么就会读取默认路径的值例如如果<code>dict_path</code>为空，<code>jieba.dict.utf8</code>就会作为默认文件路径，在函数内部会调用<code>pathJoin</code>将祖父路径、<code>dict</code>目录和当前<code>jieba.dict.utf8</code>拼接形成一个路径。但是当前因为是软链接，所以实际三个路径获取的结果都是<code>include/cppjieba</code>，此时根据<code>Jieba.hpp</code>的文件位置：<code>include/cppjieba</code>，如果要使用原始文件就需要将<code>cppjieba/dict</code>目录拷贝到<code>cppjieba/include</code>目录中。对于这种情况，使用的目录结构如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-44-1><span class=o>/</span><span class=n>home</span><span class=o>/</span><span class=n>epsda</span><span class=o>/</span><span class=n>dependencies</span><span class=o>/</span><span class=n>cppjieba</span><span class=o>/</span><span class=n>include</span>
</span><span id=__span-44-2><span class=err>├──</span><span class=w> </span><span class=n>cppjieba</span><span class=w> </span><span class=c1>// Jieba.hpp所在的路径</span>
</span><span id=__span-44-3><span class=err>│</span><span class=w>   </span><span class=err>├──</span><span class=w> </span><span class=n>DictTrie</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-44-4><span class=err>│</span><span class=w>   </span><span class=err>├──</span><span class=w> </span><span class=n>FullSegment</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-44-5><span class=err>│</span><span class=w>   </span><span class=err>├──</span><span class=w> </span><span class=n>HMMModel</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-44-6><span class=err>│</span><span class=w>   </span><span class=err>├──</span><span class=w> </span><span class=n>HMMSegment</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-44-7><span class=err>│</span><span class=w>   </span><span class=err>├──</span><span class=w> </span><span class=n>Jieba</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-44-8><span class=err>│</span><span class=w>   </span><span class=err>├──</span><span class=w> </span><span class=n>KeywordExtractor</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-44-9><span class=err>│</span><span class=w>   </span><span class=err>├──</span><span class=w> </span><span class=n>MPSegment</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-44-10><span class=err>│</span><span class=w>   </span><span class=err>├──</span><span class=w> </span><span class=n>MixSegment</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-44-11><span class=err>│</span><span class=w>   </span><span class=err>├──</span><span class=w> </span><span class=n>PosTagger</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-44-12><span class=err>│</span><span class=w>   </span><span class=err>├──</span><span class=w> </span><span class=n>PreFilter</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-44-13><span class=err>│</span><span class=w>   </span><span class=err>├──</span><span class=w> </span><span class=n>QuerySegment</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-44-14><span class=err>│</span><span class=w>   </span><span class=err>├──</span><span class=w> </span><span class=n>SegmentBase</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-44-15><span class=err>│</span><span class=w>   </span><span class=err>├──</span><span class=w> </span><span class=n>SegmentTagged</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-44-16><span class=err>│</span><span class=w>   </span><span class=err>├──</span><span class=w> </span><span class=n>TextRankExtractor</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-44-17><span class=err>│</span><span class=w>   </span><span class=err>├──</span><span class=w> </span><span class=n>Trie</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-44-18><span class=err>│</span><span class=w>   </span><span class=err>├──</span><span class=w> </span><span class=n>Unicode</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-44-19><span class=err>│</span><span class=w>   </span><span class=err>└──</span><span class=w> </span><span class=n>limonp</span>
</span><span id=__span-44-20><span class=err>│</span><span class=w>       </span><span class=err>├──</span><span class=w> </span><span class=n>ArgvContext</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-44-21><span class=err>│</span><span class=w>       </span><span class=err>├──</span><span class=w> </span><span class=n>Closure</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-44-22><span class=err>│</span><span class=w>       </span><span class=err>├──</span><span class=w> </span><span class=n>Colors</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-44-23><span class=err>│</span><span class=w>       </span><span class=err>├──</span><span class=w> </span><span class=n>Condition</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-44-24><span class=err>│</span><span class=w>       </span><span class=err>├──</span><span class=w> </span><span class=n>Config</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-44-25><span class=err>│</span><span class=w>       </span><span class=err>├──</span><span class=w> </span><span class=n>ForcePublic</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-44-26><span class=err>│</span><span class=w>       </span><span class=err>├──</span><span class=w> </span><span class=n>LocalVector</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-44-27><span class=err>│</span><span class=w>       </span><span class=err>├──</span><span class=w> </span><span class=n>Logging</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-44-28><span class=err>│</span><span class=w>       </span><span class=err>├──</span><span class=w> </span><span class=n>NonCopyable</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-44-29><span class=err>│</span><span class=w>       </span><span class=err>├──</span><span class=w> </span><span class=n>StdExtension</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-44-30><span class=err>│</span><span class=w>       </span><span class=err>└──</span><span class=w> </span><span class=n>StringUtil</span><span class=p>.</span><span class=n>hpp</span>
</span><span id=__span-44-31><span class=err>└──</span><span class=w> </span><span class=n>dict</span><span class=w> </span><span class=c1>// 与cppjieba目录同级的dict目录</span>
</span><span id=__span-44-32><span class=w>    </span><span class=err>├──</span><span class=w> </span><span class=n>README</span><span class=p>.</span><span class=n>md</span>
</span><span id=__span-44-33><span class=w>    </span><span class=err>├──</span><span class=w> </span><span class=n>hmm_model</span><span class=p>.</span><span class=n>utf8</span>
</span><span id=__span-44-34><span class=w>    </span><span class=err>├──</span><span class=w> </span><span class=n>idf</span><span class=p>.</span><span class=n>utf8</span>
</span><span id=__span-44-35><span class=w>    </span><span class=err>├──</span><span class=w> </span><span class=n>jieba</span><span class=p>.</span><span class=n>dict</span><span class=p>.</span><span class=n>utf8</span>
</span><span id=__span-44-36><span class=w>    </span><span class=err>├──</span><span class=w> </span><span class=n>pos_dict</span>
</span><span id=__span-44-37><span class=w>    </span><span class=err>│</span><span class=w>   </span><span class=err>├──</span><span class=w> </span><span class=n>char_state_tab</span><span class=p>.</span><span class=n>utf8</span>
</span><span id=__span-44-38><span class=w>    </span><span class=err>│</span><span class=w>   </span><span class=err>├──</span><span class=w> </span><span class=n>prob_emit</span><span class=p>.</span><span class=n>utf8</span>
</span><span id=__span-44-39><span class=w>    </span><span class=err>│</span><span class=w>   </span><span class=err>├──</span><span class=w> </span><span class=n>prob_start</span><span class=p>.</span><span class=n>utf8</span>
</span><span id=__span-44-40><span class=w>    </span><span class=err>│</span><span class=w>   </span><span class=err>└──</span><span class=w> </span><span class=n>prob_trans</span><span class=p>.</span><span class=n>utf8</span>
</span><span id=__span-44-41><span class=w>    </span><span class=err>├──</span><span class=w> </span><span class=n>stop_words</span><span class=p>.</span><span class=n>utf8</span>
</span><span id=__span-44-42><span class=w>    </span><span class=err>└──</span><span class=w> </span><span class=n>user</span><span class=p>.</span><span class=n>dict</span><span class=p>.</span><span class=n>utf8</span>
</span></code></pre></div></td></tr></table></div> <p>另外还有一种方法，在当前项目路径中创建一个软链接指向<code>cppjieba/dict</code>目录，例如：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-45-1><span class=n>ln</span><span class=w> </span><span class=o>-</span><span class=n>s</span><span class=w> </span><span class=o>/</span><span class=n>home</span><span class=o>/</span><span class=n>epsda</span><span class=o>/</span><span class=n>dependencies</span><span class=o>/</span><span class=n>cppjieba</span><span class=o>/</span><span class=n>dict</span><span class=w> </span><span class=n>dict</span>
</span></code></pre></div></td></tr></table></div> <p>再在代码中创建<code>Jieba</code>对象时指定字典文件：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-46-1><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>**</span><span class=n>argv</span><span class=p>)</span>
</span><span id=__span-46-2><span class=p>{</span>
</span><span id=__span-46-3><span class=w>    </span><span class=n>cppjieba</span><span class=o>::</span><span class=n>Jieba</span><span class=w> </span><span class=n>jieba</span><span class=p>(</span><span class=s>&quot;./dict/jieba.dict.utf8&quot;</span><span class=p>,</span>
</span><span id=__span-46-4><span class=w>                          </span><span class=s>&quot;./dict/hmm_model.utf8&quot;</span><span class=p>,</span>
</span><span id=__span-46-5><span class=w>                          </span><span class=s>&quot;./dict/user.dict.utf8&quot;</span><span class=p>,</span>
</span><span id=__span-46-6><span class=w>                          </span><span class=s>&quot;./dict/idf.utf8&quot;</span><span class=p>,</span>
</span><span id=__span-46-7><span class=w>                          </span><span class=s>&quot;./dict/stop_words.utf8&quot;</span><span class=p>);</span>
</span><span id=__span-46-8><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-46-9><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>本次考虑使用第一种方案，运行<code>demo.cpp</code>代码就可以看到下面的结果：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-47-1>他来到了网易杭研大厦
</span><span id=__span-47-2>[demo] Cut With HMM
</span><span id=__span-47-3>他/来到/了/网易/杭研/大厦
</span><span id=__span-47-4>[demo] Cut Without HMM 
</span><span id=__span-47-5>他/来到/了/网易/杭/研/大厦
</span><span id=__span-47-6>我来到北京清华大学
</span><span id=__span-47-7>[demo] CutAll
</span><span id=__span-47-8>我/来到/北京/清华/清华大学/华大/大学
</span><span id=__span-47-9>小明硕士毕业于中国科学院计算所，后在日本京都大学深造
</span><span id=__span-47-10>[demo] CutForSearch
</span><span id=__span-47-11>小明/硕士/毕业/于/中国/科学/学院/科学院/中国科学院/计算/计算所/，/后/在/日本/京都/大学/日本京都大学/深造
</span></code></pre></div></td></tr></table></div> <p>在本次使用中，只需要用到其中的<code>CutForSearch</code>方法，其定义如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-48-1><span class=kt>void</span><span class=w> </span><span class=nf>CutForSearch</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>sentence</span><span class=p>,</span><span class=w> </span><span class=n>vector</span><span class=o>&lt;</span><span class=n>string</span><span class=o>&gt;&amp;</span><span class=w> </span><span class=n>words</span><span class=p>,</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=n>hmm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>)</span><span class=w> </span><span class=k>const</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> <p>虽然函数中有三个参数，但是本次只需要考虑前两个参数即可。第一个参数表示待切割的内容，第二个参数表示切割后的结果存放位置</p> <p>基于上面的介绍，现在继续完成<code>buildBackwardIndex</code>的逻辑。因为需要统计切分后的词在标题和内容中的频次，所以需要对标题和内容分别进行切分，这里分两步走：</p> <ol> <li>切分标题统计切分后的词出现的次数</li> <li>切分内容统计切分后的词出现的次数</li> </ol> <p>统计完毕后，接下来需要根据关键字构建对应的倒排索引文章信息节点，这一步只需要创建倒排索引文章信息节点再填入对应的信息即可完成构建</p> <p>所以，构建倒排索引<code>buildBackwardIndex</code>函数基本逻辑如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-49-1><span class=k>class</span><span class=w> </span><span class=nc>SearchIndex</span>
</span><span id=__span-49-2><span class=p>{</span>
</span><span id=__span-49-3><span class=k>private</span><span class=o>:</span>
</span><span id=__span-49-4><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>title_weight_per</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span>
</span><span id=__span-49-5><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>body_weight_per</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-49-6><span class=k>public</span><span class=o>:</span>
</span><span id=__span-49-7><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-49-8>
</span><span id=__span-49-9><span class=w>    </span><span class=c1>// 构建倒排索引</span>
</span><span id=__span-49-10><span class=w>    </span><span class=kt>bool</span><span class=w> </span><span class=n>buildBackwardIndex</span><span class=p>(</span><span class=n>SelectedDocInfo</span><span class=w> </span><span class=o>&amp;</span><span class=n>sd</span><span class=p>)</span>
</span><span id=__span-49-11><span class=w>    </span><span class=p>{</span>
</span><span id=__span-49-12><span class=w>        </span><span class=c1>// 统计标题中关键字出现的次数</span>
</span><span id=__span-49-13><span class=w>        </span><span class=n>cppjieba</span><span class=o>::</span><span class=n>Jieba</span><span class=w> </span><span class=n>jieba</span><span class=p>;</span>
</span><span id=__span-49-14><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=w> </span><span class=n>title_words</span><span class=p>;</span>
</span><span id=__span-49-15><span class=w>        </span><span class=n>jieba</span><span class=p>.</span><span class=n>CutForSearch</span><span class=p>(</span><span class=n>sd</span><span class=p>.</span><span class=n>rd</span><span class=p>.</span><span class=n>title</span><span class=p>,</span><span class=w> </span><span class=n>title_words</span><span class=p>);</span>
</span><span id=__span-49-16><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>tw</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>title_words</span><span class=p>)</span>
</span><span id=__span-49-17><span class=w>            </span><span class=n>word_cnt_</span><span class=p>[</span><span class=n>tw</span><span class=p>].</span><span class=n>title_cnt</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-49-18>
</span><span id=__span-49-19><span class=w>        </span><span class=c1>// 统计内容中关键字出现的次数</span>
</span><span id=__span-49-20><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=w> </span><span class=n>body_words</span><span class=p>;</span>
</span><span id=__span-49-21><span class=w>        </span><span class=n>jieba</span><span class=p>.</span><span class=n>CutForSearch</span><span class=p>(</span><span class=n>sd</span><span class=p>.</span><span class=n>rd</span><span class=p>.</span><span class=n>body</span><span class=p>,</span><span class=w> </span><span class=n>body_words</span><span class=p>);</span>
</span><span id=__span-49-22><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>bw</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>body_words</span><span class=p>)</span>
</span><span id=__span-49-23><span class=w>            </span><span class=n>word_cnt_</span><span class=p>[</span><span class=n>bw</span><span class=p>].</span><span class=n>body_cnt</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-49-24>
</span><span id=__span-49-25><span class=w>        </span><span class=c1>// 遍历关键字哈希表获取关键字填充对应的倒排索引节点</span>
</span><span id=__span-49-26><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>word</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>word_cnt_</span><span class=p>)</span>
</span><span id=__span-49-27><span class=w>        </span><span class=p>{</span>
</span><span id=__span-49-28><span class=w>            </span><span class=n>BackwardIndexElement</span><span class=w> </span><span class=n>b</span><span class=p>;</span>
</span><span id=__span-49-29><span class=w>            </span><span class=n>b</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sd</span><span class=p>.</span><span class=n>id</span><span class=p>;</span>
</span><span id=__span-49-30><span class=w>            </span><span class=n>b</span><span class=p>.</span><span class=n>word</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>word</span><span class=p>.</span><span class=n>first</span><span class=p>;</span>
</span><span id=__span-49-31><span class=w>            </span><span class=c1>// 权重统计按照公式计算</span>
</span><span id=__span-49-32><span class=w>            </span><span class=n>b</span><span class=p>.</span><span class=n>weight</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>word</span><span class=p>.</span><span class=n>second</span><span class=p>.</span><span class=n>title_cnt</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>title_weight_per</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>word</span><span class=p>.</span><span class=n>second</span><span class=p>.</span><span class=n>body_cnt</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>body_weight_per</span><span class=p>;</span>
</span><span id=__span-49-33>
</span><span id=__span-49-34><span class=w>            </span><span class=n>backward_index_</span><span class=p>[</span><span class=n>b</span><span class=p>.</span><span class=n>word</span><span class=p>].</span><span class=n>push_back</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>b</span><span class=p>));</span>
</span><span id=__span-49-35><span class=w>        </span><span class=p>}</span>
</span><span id=__span-49-36>
</span><span id=__span-49-37><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-49-38><span class=w>    </span><span class=p>}</span>
</span><span id=__span-49-39>
</span><span id=__span-49-40><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-49-41><span class=k>private</span><span class=o>:</span>
</span><span id=__span-49-42><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-49-43><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unordered_map</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>BackwardIndexElement</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>backward_index_</span><span class=p>;</span><span class=w> </span><span class=c1>// 倒排索引结果</span>
</span><span id=__span-49-44><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unordered_map</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=p>,</span><span class=w> </span><span class=n>WordCount</span><span class=o>&gt;</span><span class=w> </span><span class=n>word_cnt_</span><span class=p>;</span><span class=w>                               </span><span class=c1>// 词频统计</span>
</span><span id=__span-49-45><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <h2 id=_15>实现搜索引擎模块<a class=headerlink href=#_15 title="Permanent link">&para;</a></h2> <h3 id=_16>基本实现<a class=headerlink href=#_16 title="Permanent link">&para;</a></h3> <p>搜索的本质就是根据搜索关键字在已有的关键字中查询出需要的文章，所以这里首先建立一个类用于表示搜索服务：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-50-1><span class=k>class</span><span class=w> </span><span class=nc>SearchEngine</span>
</span><span id=__span-50-2><span class=p>{</span>
</span><span id=__span-50-3>
</span><span id=__span-50-4><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>既然是搜索引擎，那么在初始化搜索引擎对象时就需要先构建需要用到的索引，所以考虑搜索引擎的构造函数中完成对索引对象的初始化。所以在搜索引擎类中需要有一个<code>SearchIndex</code>类对象作为成员，接着在<code>SearchEngine</code>的构造函数中初始化这个成员：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-51-1><span class=k>class</span><span class=w> </span><span class=nc>SearchEngine</span>
</span><span id=__span-51-2><span class=p>{</span>
</span><span id=__span-51-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-51-4><span class=w>    </span><span class=n>SearchEngine</span><span class=p>()</span>
</span><span id=__span-51-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-51-6><span class=w>        </span><span class=c1>// 构建索引</span>
</span><span id=__span-51-7><span class=w>        </span><span class=n>search_index_</span><span class=p>.</span><span class=n>buildIndex</span><span class=p>();</span>
</span><span id=__span-51-8><span class=w>    </span><span class=p>}</span>
</span><span id=__span-51-9>
</span><span id=__span-51-10><span class=k>private</span><span class=o>:</span>
</span><span id=__span-51-11><span class=w>    </span><span class=n>si</span><span class=o>::</span><span class=n>SearchIndex</span><span class=w> </span><span class=n>search_index_</span><span class=p>;</span>
</span><span id=__span-51-12><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>上面这种创建<code>SearchIndex</code>类成员的方式可以达到需要的效果，但是如果<code>SearchEngine</code>类对象被多次创建就会出现多次构建索引的情况，所以为了避免这个问题，考虑将<code>SearchIndex</code>类设置为单例模式：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-52-1><span class=k>class</span><span class=w> </span><span class=nc>SearchIndex</span>
</span><span id=__span-52-2><span class=p>{</span>
</span><span id=__span-52-3><span class=k>private</span><span class=o>:</span>
</span><span id=__span-52-4><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-52-5>
</span><span id=__span-52-6><span class=w>    </span><span class=c1>// 私有构造函数</span>
</span><span id=__span-52-7><span class=w>    </span><span class=n>SearchIndex</span><span class=p>()</span>
</span><span id=__span-52-8><span class=w>    </span><span class=p>{}</span>
</span><span id=__span-52-9>
</span><span id=__span-52-10><span class=w>    </span><span class=c1>// 禁用拷贝和赋值</span>
</span><span id=__span-52-11><span class=w>    </span><span class=n>SearchIndex</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>SearchIndex</span><span class=o>&amp;</span><span class=w> </span><span class=n>si</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>delete</span><span class=p>;</span>
</span><span id=__span-52-12><span class=w>    </span><span class=n>SearchIndex</span><span class=o>&amp;</span><span class=w> </span><span class=k>operator</span><span class=o>=</span><span class=p>(</span><span class=n>SearchIndex</span><span class=o>&amp;</span><span class=w> </span><span class=n>si</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>delete</span><span class=p>;</span>
</span><span id=__span-52-13><span class=w>    </span><span class=n>SearchIndex</span><span class=p>(</span><span class=n>SearchIndex</span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>si</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>delete</span><span class=p>;</span>
</span><span id=__span-52-14>
</span><span id=__span-52-15><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=n>SearchIndex</span><span class=o>*</span><span class=w> </span><span class=n>si</span><span class=p>;</span>
</span><span id=__span-52-16><span class=k>public</span><span class=o>:</span>
</span><span id=__span-52-17><span class=w>    </span><span class=c1>// 获取单例对象</span>
</span><span id=__span-52-18><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=n>SearchIndex</span><span class=o>*</span><span class=w> </span><span class=n>getSearchIndexInstance</span><span class=p>()</span>
</span><span id=__span-52-19><span class=w>    </span><span class=p>{</span>
</span><span id=__span-52-20><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>si</span><span class=p>)</span>
</span><span id=__span-52-21><span class=w>        </span><span class=p>{</span>
</span><span id=__span-52-22><span class=w>            </span><span class=c1>// 加锁</span>
</span><span id=__span-52-23><span class=w>            </span><span class=n>mtx</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span>
</span><span id=__span-52-24><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>si</span><span class=p>)</span>
</span><span id=__span-52-25><span class=w>                </span><span class=n>si</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SearchIndex</span><span class=p>();</span>
</span><span id=__span-52-26><span class=w>            </span><span class=n>mtx</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
</span><span id=__span-52-27><span class=w>        </span><span class=p>}</span>
</span><span id=__span-52-28>
</span><span id=__span-52-29><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>si</span><span class=p>;</span>
</span><span id=__span-52-30><span class=w>    </span><span class=p>}</span>
</span><span id=__span-52-31>
</span><span id=__span-52-32><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-52-33><span class=k>private</span><span class=o>:</span>
</span><span id=__span-52-34><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-52-35><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>mtx</span><span class=p>;</span>
</span><span id=__span-52-36><span class=p>};</span>
</span><span id=__span-52-37>
</span><span id=__span-52-38><span class=n>SearchIndex</span><span class=o>*</span><span class=w> </span><span class=n>SearchIndex</span><span class=o>::</span><span class=n>si</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>nullptr</span><span class=p>;</span>
</span><span id=__span-52-39><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>SearchIndex</span><span class=o>::</span><span class=n>mtx</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> <p>接着，在<code>SearchEngine</code>对象中通过调用<code>getSearchIndexInstance</code>函数获取<code>SearchIndex</code>类对象：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-53-1><span class=k>class</span><span class=w> </span><span class=nc>SearchEngine</span>
</span><span id=__span-53-2><span class=p>{</span>
</span><span id=__span-53-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-53-4><span class=w>    </span><span class=n>SearchEngine</span><span class=p>()</span>
</span><span id=__span-53-5><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=n>search_index_</span><span class=p>(</span><span class=n>si</span><span class=o>::</span><span class=n>SearchIndex</span><span class=o>::</span><span class=n>getSearchIndexInstance</span><span class=p>())</span>
</span><span id=__span-53-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-53-7><span class=w>        </span><span class=c1>// 构建索引</span>
</span><span id=__span-53-8><span class=w>        </span><span class=n>search_index_</span><span class=o>-&gt;</span><span class=n>buildIndex</span><span class=p>();</span>
</span><span id=__span-53-9><span class=w>    </span><span class=p>}</span>
</span><span id=__span-53-10>
</span><span id=__span-53-11><span class=w>    </span><span class=o>~</span><span class=n>SearchEngine</span><span class=p>()</span>
</span><span id=__span-53-12><span class=w>    </span><span class=p>{</span>
</span><span id=__span-53-13>
</span><span id=__span-53-14><span class=w>    </span><span class=p>}</span>
</span><span id=__span-53-15>
</span><span id=__span-53-16><span class=k>private</span><span class=o>:</span>
</span><span id=__span-53-17><span class=w>    </span><span class=n>si</span><span class=o>::</span><span class=n>SearchIndex</span><span class=o>*</span><span class=w> </span><span class=n>search_index_</span><span class=p>;</span>
</span><span id=__span-53-18><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>完成索引的构建之后就需要根据用户输入的关键字查询出对应的结果，这里可以通过一个<code>search</code>函数包裹整体逻辑，这个函数的第一个参数就是用户输入的关键字，第二个参数是查询到的结果。因为后面需要进行网络传输，所以少不了的就是对查询的结果进行协议化，为了保证客户端也可以正常识别当前服务端传送的数据，这里考虑使用JSON字符串作为第二个参数，即：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-54-1><span class=c1>// 根据关键字进行搜索</span>
</span><span id=__span-54-2><span class=kt>void</span><span class=w> </span><span class=nf>search</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>keyword</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>json_string</span><span class=p>)</span>
</span><span id=__span-54-3><span class=p>{</span>
</span><span id=__span-54-4>
</span><span id=__span-54-5><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>接下来考虑<code>search</code>函数中的逻辑，因为用户输入的词可能并不是文章中一定存在的<a href=javascript:; class=custom-tooltip data-title=即倒排索引哈希表中的key>某一个关键词</a>，所以此处还需要对用户输入的内容进行分词。对搜索关键字进行分词之后就是在哈希表中查询出相应的结果，这里可以需要考虑将内容存储到一个结构中。这里需要考虑两个问题：</p> <ol> <li>前面建立了两个哈希表，具体需要查询哪一个哈希表 </li> <li>如何处理分词后的结果</li> </ol> <p>对于第一个问题，两张哈希表分别为<code>unordered_map&lt;string, WordCount&gt;</code>用于统计关键字和对应权重的映射关系以及<code>unordered_map&lt;string, vector&lt;BackwardIndexElement&gt;&gt;</code>用于统计关键字和所有倒排结果的映射关系，考虑到后面需要根据<code>BackwardIndexElement</code>中的文档ID查询正排索引，所以需要查询的哈希表实际上就是<code>unordered_map&lt;string, vector&lt;BackwardIndexElement&gt;&gt;</code></p> <p>对于第二个问题，在<code>unordered_map&lt;string, vector&lt;BackwardIndexElement&gt;&gt;</code>中通过关键字查询得到的结果就是出现指定关键字对应的关键字信息节点数组，所以接下来为了在下一步可以对结果进行排序，考虑将查询出的结果存储到一个数组中。注意这个数组中存储的不是<code>vector&lt;BackwardIndexElement&gt;</code>，而是其中的<code>BackwardIndexElement</code>对象，因为获取到所有的结果后实际上就已经不需要再考虑关键字的问题了，接下来考虑的只是权重优先级问题</p> <p>明确了上面提到的两个问题之后，思考<code>search</code>函数的基本逻辑：首先对用户输入的关键词进行切分。接着，根据切分后的每个词查找倒排索引得到其中存储倒排索引文章信息节点的数组<code>vector&lt;BackwardIndexElement&gt;</code>，将这个数组中的每一个<code>BackwardIndexElement</code>对象存储到一个单独的结构中便于接下来的排序，本次排序的基本思路就是按照倒排信息节点中的权重字段进行降序排序（即权重高的排在前面）</p> <p>基于上面的思路，首先需要实现<code>SearchIndex</code>类中的<code>getBackwardIndexElement</code>函数：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-55-1><span class=c1>// 获取倒排索引结果</span>
</span><span id=__span-55-2><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>BackwardIndexElement</span><span class=o>&gt;</span><span class=w> </span><span class=o>*</span><span class=n>getBackwardIndexElement</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>keyword</span><span class=p>)</span>
</span><span id=__span-55-3><span class=p>{</span>
</span><span id=__span-55-4><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>backward_index_</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>keyword</span><span class=p>);</span>
</span><span id=__span-55-5><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>pos</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>backward_index_</span><span class=p>.</span><span class=n>end</span><span class=p>())</span>
</span><span id=__span-55-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-55-7><span class=w>        </span><span class=n>ls</span><span class=o>::</span><span class=n>LOG</span><span class=p>(</span><span class=n>ls</span><span class=o>::</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;不存在对应的关键字&quot;</span><span class=p>;</span>
</span><span id=__span-55-8><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>nullptr</span><span class=p>;</span>
</span><span id=__span-55-9><span class=w>    </span><span class=p>}</span>
</span><span id=__span-55-10>
</span><span id=__span-55-11><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=n>backward_index_</span><span class=p>[</span><span class=n>keyword</span><span class=p>];</span>
</span><span id=__span-55-12><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>接着实现<code>search</code>函数中的逻辑：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-56-1><span class=c1>// 根据关键字进行搜索</span>
</span><span id=__span-56-2><span class=kt>void</span><span class=w> </span><span class=nf>search</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>keyword</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>json_string</span><span class=p>)</span>
</span><span id=__span-56-3><span class=p>{</span>
</span><span id=__span-56-4><span class=w>    </span><span class=c1>// 对用户输入的关键字进行切分</span>
</span><span id=__span-56-5><span class=w>    </span><span class=n>cppjieba</span><span class=o>::</span><span class=n>Jieba</span><span class=w> </span><span class=n>jieba</span><span class=p>;</span>
</span><span id=__span-56-6><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=w> </span><span class=n>keywords</span><span class=p>;</span>
</span><span id=__span-56-7><span class=w>    </span><span class=n>jieba</span><span class=p>.</span><span class=n>CutForSearch</span><span class=p>(</span><span class=n>keyword</span><span class=p>,</span><span class=w> </span><span class=n>keywords</span><span class=p>);</span>
</span><span id=__span-56-8>
</span><span id=__span-56-9><span class=w>    </span><span class=c1>// 查询哈希表得到结果</span>
</span><span id=__span-56-10><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>si</span><span class=o>::</span><span class=n>BackwardIndexElement</span><span class=o>&gt;</span><span class=w> </span><span class=n>results</span><span class=p>;</span>
</span><span id=__span-56-11><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>word</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>keywords</span><span class=p>)</span>
</span><span id=__span-56-12><span class=w>    </span><span class=p>{</span>
</span><span id=__span-56-13><span class=w>        </span><span class=c1>// 查倒排索引</span>
</span><span id=__span-56-14><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>si</span><span class=o>::</span><span class=n>BackwardIndexElement</span><span class=o>&gt;*</span><span class=w> </span><span class=n>ret_ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>search_index_</span><span class=o>-&gt;</span><span class=n>getBackwardIndexElement</span><span class=p>(</span><span class=n>word</span><span class=p>);</span>
</span><span id=__span-56-15><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>ret_ptr</span><span class=p>)</span>
</span><span id=__span-56-16><span class=w>            </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-56-17><span class=w>        </span><span class=c1>// 插入结果</span>
</span><span id=__span-56-18><span class=w>        </span><span class=n>results</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=n>results</span><span class=p>.</span><span class=n>end</span><span class=p>(),</span><span class=w> </span><span class=n>ret_ptr</span><span class=o>-&gt;</span><span class=n>begin</span><span class=p>(),</span><span class=w> </span><span class=n>ret_ptr</span><span class=o>-&gt;</span><span class=n>end</span><span class=p>());</span>
</span><span id=__span-56-19><span class=w>    </span><span class=p>}</span>
</span><span id=__span-56-20>
</span><span id=__span-56-21><span class=w>    </span><span class=c1>// 按照权重排序</span>
</span><span id=__span-56-22><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>stable_sort</span><span class=p>(</span><span class=n>results</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span><span class=w> </span><span class=n>results</span><span class=p>.</span><span class=n>end</span><span class=p>(),</span><span class=w> </span><span class=p>[](</span><span class=n>si</span><span class=o>::</span><span class=n>BackwardIndexElement</span><span class=w> </span><span class=o>&amp;</span><span class=n>b1</span><span class=p>,</span><span class=w> </span><span class=n>si</span><span class=o>::</span><span class=n>BackwardIndexElement</span><span class=w> </span><span class=o>&amp;</span><span class=n>b2</span><span class=p>)</span>
</span><span id=__span-56-23><span class=w>                    </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>b1</span><span class=p>.</span><span class=n>weight</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>b2</span><span class=p>.</span><span class=n>weight</span><span class=p>;</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-56-24><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>虽然上面的过程能实现基本的目标，但是还存在一个问题：如果存在多个关键字对应着同样的文章，例如关键字1和关键字2都对应着文档1和文档2。这种情况下执行上面的逻辑就会出现文档1和文档2的结果被插入两次导致最后的结果存在相同的内容。为了解决这个问题，可以考虑下面的思路：</p> <p>因为问一个<code>BackwardIndexElement</code>节点都有对应的文档ID，可以根据文档ID是否重复出现判断是否出现了重复插入，所以这里可以建立一张哈希表，这个哈希表的第二个元素类型就是<code>BackwardIndexElement</code>，第一个元素类型就是文档ID：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-57-1><span class=n>std</span><span class=o>::</span><span class=n>unordered_map</span><span class=o>&lt;</span><span class=kt>uint64_t</span><span class=p>,</span><span class=w> </span><span class=n>si</span><span class=o>::</span><span class=n>BackwardIndexElement</span><span class=o>&gt;</span><span class=w> </span><span class=n>select_map</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> <p>接着，在每一次遍历获取倒排索引文章信息节点数组后遍历该数组，判断其中的文章是否已经在<code>select_map</code>出现，没有出现就插入，否则不插入。当遍历完用户输入的所有可能的关键词后将<code>select_map</code>再插入到<code>results</code>即可：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-58-1><span class=c1>// 根据关键字进行搜索</span>
</span><span id=__span-58-2><span class=kt>void</span><span class=w> </span><span class=nf>search</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>keyword</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>json_string</span><span class=p>)</span>
</span><span id=__span-58-3><span class=p>{</span>
</span><span id=__span-58-4><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-58-5><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>word</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>keywords</span><span class=p>)</span>
</span><span id=__span-58-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-58-7><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-58-8><span class=w>        </span><span class=k>for</span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>bi</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=o>*</span><span class=n>ret_ptr</span><span class=p>)</span>
</span><span id=__span-58-9><span class=w>        </span><span class=p>{</span>
</span><span id=__span-58-10><span class=w>            </span><span class=c1>// 如果文档ID已经存在，说明已经存在，否则不存在</span>
</span><span id=__span-58-11><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>select_map</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>bi</span><span class=p>.</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>select_map</span><span class=p>.</span><span class=n>end</span><span class=p>())</span>
</span><span id=__span-58-12><span class=w>                </span><span class=n>select_map</span><span class=p>[</span><span class=n>bi</span><span class=p>.</span><span class=n>id</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bi</span><span class=p>;</span>
</span><span id=__span-58-13><span class=w>        </span><span class=p>}</span>
</span><span id=__span-58-14><span class=w>    </span><span class=p>}</span>
</span><span id=__span-58-15>
</span><span id=__span-58-16><span class=w>    </span><span class=c1>// 遍历select_map存储结果</span>
</span><span id=__span-58-17><span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>pair</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>select_map</span><span class=p>)</span>
</span><span id=__span-58-18><span class=w>        </span><span class=n>results</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>pair</span><span class=p>.</span><span class=n>second</span><span class=p>));</span>
</span><span id=__span-58-19>
</span><span id=__span-58-20><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-58-21><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>但是，仅仅有上面的逻辑还不足以完成去重的行为，因为当前只考虑了多个关键字对应同一篇文档的情况，也可能存在文档内部存在多个关键字的情况，对于第二种情况上面的逻辑就只是简单的获取赋值而已，并没有实现去重</p> <p>解决第二种情况的方式很简单，就是将同一个文档中多个关键字进行累积，但是基于已有的<code>BackwardIndexElement</code>无法做到这一点，因为<code>BackwardIndexElement</code>中只能保存一个关键字，所以考虑创建一个新的节点结构<code>SearchIndexElement</code>，该结构与<code>BackwardIndexElement</code>主要不同点就是<code>std::string word</code>变为<code>std::vector&lt;std::string&gt; words</code>：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-59-1><span class=c1>// 搜索节点结构</span>
</span><span id=__span-59-2><span class=k>struct</span><span class=w> </span><span class=nc>SearchIndexElement</span>
</span><span id=__span-59-3><span class=p>{</span>
</span><span id=__span-59-4><span class=w>    </span><span class=kt>uint64_t</span><span class=w> </span><span class=n>id</span><span class=p>;</span>
</span><span id=__span-59-5><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=w> </span><span class=n>words</span><span class=p>;</span>
</span><span id=__span-59-6><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>weight</span><span class=p>;</span>
</span><span id=__span-59-7><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>另外，为了后续计算安全，考虑提供一个构造函数对成员进行初始化：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-60-1><span class=n>SearchIndexElement</span><span class=p>()</span>
</span><span id=__span-60-2><span class=w>    </span><span class=o>:</span><span class=n>id</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span><span class=w> </span><span class=n>weight</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-60-3><span class=p>{}</span>
</span></code></pre></div></td></tr></table></div> <p>接着更改用于去重的哈希表结构：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-61-1><span class=c1>// std::unordered_map&lt;uint64_t, si::BackwardIndexElement&gt; select_map;</span>
</span><span id=__span-61-2><span class=n>std</span><span class=o>::</span><span class=n>unordered_map</span><span class=o>&lt;</span><span class=kt>uint64_t</span><span class=p>,</span><span class=w> </span><span class=n>SearchIndexElement</span><span class=o>&gt;</span><span class=w> </span><span class=n>select_map</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> <p>基于上面的哈希表结构，修改去重逻辑：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-62-1><span class=c1>// 根据关键字进行搜索</span>
</span><span id=__span-62-2><span class=kt>void</span><span class=w> </span><span class=nf>search</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>keyword</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>json_string</span><span class=p>)</span>
</span><span id=__span-62-3><span class=p>{</span>
</span><span id=__span-62-4><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-62-5><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>word</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>keywords</span><span class=p>)</span>
</span><span id=__span-62-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-62-7><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-62-8><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>bi</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=o>*</span><span class=n>ret_ptr</span><span class=p>)</span>
</span><span id=__span-62-9><span class=w>        </span><span class=p>{</span>
</span><span id=__span-62-10><span class=w>            </span><span class=c1>// 如果文档ID已经存在，说明已经存在，否则不存在</span>
</span><span id=__span-62-11><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>select_map</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>bi</span><span class=p>.</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>select_map</span><span class=p>.</span><span class=n>end</span><span class=p>())</span>
</span><span id=__span-62-12><span class=w>            </span><span class=p>{</span>
</span><span id=__span-62-13><span class=w>                </span><span class=c1>// 获取当前文档搜索结构节点，不存在自动插入，存在直接获取</span>
</span><span id=__span-62-14><span class=w>                </span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>el</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>select_map</span><span class=p>[</span><span class=n>bi</span><span class=p>.</span><span class=n>id</span><span class=p>];</span>
</span><span id=__span-62-15><span class=w>                </span><span class=c1>// 如果是新节点，直接赋值；如果是重复出现的节点，覆盖</span>
</span><span id=__span-62-16><span class=w>                </span><span class=n>el</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bi</span><span class=p>.</span><span class=n>id</span><span class=p>;</span>
</span><span id=__span-62-17><span class=w>                </span><span class=c1>// 如果是新节点，第一次添加；如果是重复节点，追加</span>
</span><span id=__span-62-18><span class=w>                </span><span class=n>el</span><span class=p>.</span><span class=n>words</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>bi</span><span class=p>.</span><span class=n>word</span><span class=p>);</span>
</span><span id=__span-62-19><span class=w>                </span><span class=c1>// 如果是新节点，直接赋值；如果是重复节点，累加</span>
</span><span id=__span-62-20><span class=w>                </span><span class=n>el</span><span class=p>.</span><span class=n>weight</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>bi</span><span class=p>.</span><span class=n>weight</span><span class=p>;</span>
</span><span id=__span-62-21><span class=w>            </span><span class=p>}</span>
</span><span id=__span-62-22><span class=w>        </span><span class=p>}</span>
</span><span id=__span-62-23><span class=w>    </span><span class=p>}</span>
</span><span id=__span-62-24><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-62-25><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>接着添加去重后的节点到结果集中便于后续排序，此处需要修改结果集结构：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-63-1><span class=c1>// std::vector&lt;si::BackwardIndexElement&gt; results;</span>
</span><span id=__span-63-2><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>SearchIndexElement</span><span class=o>&gt;</span><span class=w> </span><span class=n>results</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> <p>修改排序逻辑：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-64-1><span class=c1>// std::stable_sort(results.begin(), results.end(), [](const si::BackwardIndexElement &amp;b1, const si::BackwardIndexElement &amp;b2) { return b1.weight &gt; b2.weight; });</span>
</span><span id=__span-64-2><span class=n>std</span><span class=o>::</span><span class=n>stable_sort</span><span class=p>(</span><span class=n>results</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span><span class=w> </span><span class=n>results</span><span class=p>.</span><span class=n>end</span><span class=p>(),</span><span class=w> </span><span class=p>[](</span><span class=k>const</span><span class=w> </span><span class=n>SearchIndexElement</span><span class=w> </span><span class=o>&amp;</span><span class=n>b1</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>SearchIndexElement</span><span class=w> </span><span class=o>&amp;</span><span class=n>b2</span><span class=p>)</span>
</span><span id=__span-64-3><span class=w>                    </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>b1</span><span class=p>.</span><span class=n>weight</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>b2</span><span class=p>.</span><span class=n>weight</span><span class=p>;</span><span class=w> </span><span class=p>});</span>
</span></code></pre></div></td></tr></table></div> <p>完成上面的逻辑之后，最后就是将结果转换为JSON字符串存储到<code>search</code>函数的第二个参数中。因为需要给用户返回的内容时文章标题、文章内容和文章在官网的URL，而此处的<code>SearchIndexElement</code>并没有这三个字段，所以此处还需要借助正排索引，这就是为什么需要同时在正排索引文章信息节点<code>SelectDocInfo</code>和<code>SearchIndexElement</code>设置文档ID字段的原因。一旦获取到文章信息后，就可以将三个字段的内容转换为JSON字符串并赋值给<code>json_string</code></p> <p>基于这个逻辑，首先实现获取正排索引文章信息节点函数<code>getForwardIndexDocInfo</code>：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-65-1><span class=c1>// 获取正排索引结果</span>
</span><span id=__span-65-2><span class=n>SelectedDocInfo</span><span class=w> </span><span class=o>*</span><span class=nf>getForwardIndexDocInfo</span><span class=p>(</span><span class=kt>uint64_t</span><span class=w> </span><span class=n>id</span><span class=p>)</span>
</span><span id=__span-65-3><span class=p>{</span>
</span><span id=__span-65-4><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>id</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>forward_index_</span><span class=p>.</span><span class=n>size</span><span class=p>())</span>
</span><span id=__span-65-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-65-6><span class=w>        </span><span class=n>ls</span><span class=o>::</span><span class=n>LOG</span><span class=p>(</span><span class=n>ls</span><span class=o>::</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;不存在对应的文档ID&quot;</span><span class=p>;</span>
</span><span id=__span-65-7><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>nullptr</span><span class=p>;</span>
</span><span id=__span-65-8><span class=w>    </span><span class=p>}</span>
</span><span id=__span-65-9>
</span><span id=__span-65-10><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=n>forward_index_</span><span class=p>[</span><span class=n>id</span><span class=p>];</span>
</span><span id=__span-65-11><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>接着，实现<code>search</code>最后一部分逻辑。对于一个文档中含有多个关键字的情况，此处为了简便只取出第一个关键词：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-66-1><span class=c1>// 根据关键字进行搜索</span>
</span><span id=__span-66-2><span class=kt>void</span><span class=w> </span><span class=nf>search</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>keyword</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>json_string</span><span class=p>)</span>
</span><span id=__span-66-3><span class=p>{</span>
</span><span id=__span-66-4><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-66-5>
</span><span id=__span-66-6><span class=w>    </span><span class=c1>// 转换为JSON字符串</span>
</span><span id=__span-66-7><span class=w>    </span><span class=n>Json</span><span class=o>::</span><span class=n>Value</span><span class=w> </span><span class=n>root</span><span class=p>;</span>
</span><span id=__span-66-8><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>el</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>results</span><span class=p>)</span>
</span><span id=__span-66-9><span class=w>    </span><span class=p>{</span>
</span><span id=__span-66-10><span class=w>        </span><span class=c1>// 通过正排索引获取文章内容</span>
</span><span id=__span-66-11><span class=w>        </span><span class=n>si</span><span class=o>::</span><span class=n>SelectedDocInfo</span><span class=w> </span><span class=o>*</span><span class=n>sd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>search_index_</span><span class=o>-&gt;</span><span class=n>getForwardIndexDocInfo</span><span class=p>(</span><span class=n>el</span><span class=p>.</span><span class=n>id</span><span class=p>);</span>
</span><span id=__span-66-12>
</span><span id=__span-66-13><span class=w>        </span><span class=n>Json</span><span class=o>::</span><span class=n>Value</span><span class=w> </span><span class=n>item</span><span class=p>;</span>
</span><span id=__span-66-14><span class=w>        </span><span class=c1>// debug</span>
</span><span id=__span-66-15><span class=w>        </span><span class=c1>// item[&quot;id&quot;] = sd-&gt;id;</span>
</span><span id=__span-66-16><span class=w>        </span><span class=c1>// item[&quot;word&quot;] = bi.word;</span>
</span><span id=__span-66-17><span class=w>        </span><span class=c1>// item[&quot;weight&quot;] = bi.weight;</span>
</span><span id=__span-66-18>
</span><span id=__span-66-19><span class=w>        </span><span class=n>item</span><span class=p>[</span><span class=s>&quot;title&quot;</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sd</span><span class=o>-&gt;</span><span class=n>rd</span><span class=p>.</span><span class=n>title</span><span class=p>;</span>
</span><span id=__span-66-20><span class=w>        </span><span class=c1>// 取出第一个关键词</span>
</span><span id=__span-66-21><span class=w>        </span><span class=n>item</span><span class=p>[</span><span class=s>&quot;body&quot;</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getPartialBodyWithKeyword</span><span class=p>(</span><span class=n>sd</span><span class=o>-&gt;</span><span class=n>rd</span><span class=p>.</span><span class=n>body</span><span class=p>,</span><span class=w> </span><span class=n>el</span><span class=p>.</span><span class=n>words</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span><span id=__span-66-22><span class=w>        </span><span class=n>item</span><span class=p>[</span><span class=s>&quot;url&quot;</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sd</span><span class=o>-&gt;</span><span class=n>rd</span><span class=p>.</span><span class=n>url</span><span class=p>;</span>
</span><span id=__span-66-23>
</span><span id=__span-66-24><span class=w>        </span><span class=c1>// 将item作为一个JSON对象插入到root中作为子JSON对象</span>
</span><span id=__span-66-25><span class=w>        </span><span class=n>root</span><span class=p>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>);</span>
</span><span id=__span-66-26><span class=w>    </span><span class=p>}</span>
</span><span id=__span-66-27>
</span><span id=__span-66-28><span class=w>    </span><span class=n>json_string</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>root</span><span class=p>.</span><span class=n>toStyledString</span><span class=p>();</span>
</span><span id=__span-66-29><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h3 id=_17>搜索关键字查询优化<a class=headerlink href=#_17 title="Permanent link">&para;</a></h3> <p>使用上面实现的搜索引擎会发现一个比较影响体验的问题：大小写问题。在实际生活中使用的搜索引擎实际上都是忽略大小写的，所以为了保证本次实现的搜索引擎符合日常使用，添加忽略大小写的功能到当前项目中</p> <p>既然要实现忽略大小写，那么必然涉及到两个方面：</p> <ol> <li>构建索引时对应的关键字需要忽略大小写</li> <li>获取到用户输入的关键字需要忽略大小写</li> </ol> <p>根据上面两个方面对前面的代码进行修改：</p> <p>首先是构建索引部分，只有倒排索引需要修改。对于标题和内容都需要忽略大小写，而忽略大小写的时机就在切割关键词之后，统计关键词频次之前，修改如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-67-1><span class=c1>// 构建倒排索引</span>
</span><span id=__span-67-2><span class=kt>bool</span><span class=w> </span><span class=nf>buildBackwardIndex</span><span class=p>(</span><span class=n>SelectedDocInfo</span><span class=w> </span><span class=o>&amp;</span><span class=n>sd</span><span class=p>)</span>
</span><span id=__span-67-3><span class=p>{</span>
</span><span id=__span-67-4><span class=w>    </span><span class=c1>// 统计标题中关键字出现的次数</span>
</span><span id=__span-67-5><span class=w>    </span><span class=n>cppjieba</span><span class=o>::</span><span class=n>Jieba</span><span class=w> </span><span class=n>jieba</span><span class=p>;</span>
</span><span id=__span-67-6><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=w> </span><span class=n>title_words</span><span class=p>;</span>
</span><span id=__span-67-7><span class=w>    </span><span class=n>jieba</span><span class=p>.</span><span class=n>CutForSearch</span><span class=p>(</span><span class=n>sd</span><span class=p>.</span><span class=n>rd</span><span class=p>.</span><span class=n>title</span><span class=p>,</span><span class=w> </span><span class=n>title_words</span><span class=p>);</span>
</span><span id=__span-67-8><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>tw</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>title_words</span><span class=p>)</span>
</span><span id=__span-67-9><span class=w>    </span><span class=p>{</span>
</span><span id=__span-67-10><span class=w>        </span><span class=c1>// 忽略大小写</span>
</span><span id=__span-67-11><span class=w>        </span><span class=n>boost</span><span class=o>::</span><span class=n>to_lower</span><span class=p>(</span><span class=n>tw</span><span class=p>);</span>
</span><span id=__span-67-12><span class=w>        </span><span class=n>word_cnt_</span><span class=p>[</span><span class=n>tw</span><span class=p>].</span><span class=n>title_cnt</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-67-13><span class=w>    </span><span class=p>}</span>
</span><span id=__span-67-14>
</span><span id=__span-67-15><span class=w>    </span><span class=c1>// 统计内容中关键字出现的次数</span>
</span><span id=__span-67-16><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=w> </span><span class=n>body_words</span><span class=p>;</span>
</span><span id=__span-67-17><span class=w>    </span><span class=n>jieba</span><span class=p>.</span><span class=n>CutForSearch</span><span class=p>(</span><span class=n>sd</span><span class=p>.</span><span class=n>rd</span><span class=p>.</span><span class=n>body</span><span class=p>,</span><span class=w> </span><span class=n>body_words</span><span class=p>);</span>
</span><span id=__span-67-18><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>bw</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>body_words</span><span class=p>)</span>
</span><span id=__span-67-19><span class=w>    </span><span class=p>{</span>
</span><span id=__span-67-20><span class=w>        </span><span class=n>boost</span><span class=o>::</span><span class=n>to_lower</span><span class=p>(</span><span class=n>bw</span><span class=p>);</span>
</span><span id=__span-67-21><span class=w>        </span><span class=n>word_cnt_</span><span class=p>[</span><span class=n>bw</span><span class=p>].</span><span class=n>body_cnt</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-67-22><span class=w>    </span><span class=p>}</span>
</span><span id=__span-67-23>
</span><span id=__span-67-24><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-67-25><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>接着就是对用户输入的关键字进行大小写忽略，执行的位置就是在分词之后，查找之前：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-68-1><span class=c1>// 根据关键字进行搜索</span>
</span><span id=__span-68-2><span class=kt>void</span><span class=w> </span><span class=nf>search</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>keyword</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>json_string</span><span class=p>)</span>
</span><span id=__span-68-3><span class=p>{</span>
</span><span id=__span-68-4><span class=w>    </span><span class=c1>// 对用户输入的关键字进行切分</span>
</span><span id=__span-68-5><span class=w>    </span><span class=n>cppjieba</span><span class=o>::</span><span class=n>Jieba</span><span class=w> </span><span class=n>jieba</span><span class=p>;</span>
</span><span id=__span-68-6><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=w> </span><span class=n>keywords</span><span class=p>;</span>
</span><span id=__span-68-7><span class=w>    </span><span class=n>jieba</span><span class=p>.</span><span class=n>CutForSearch</span><span class=p>(</span><span class=n>keyword</span><span class=p>,</span><span class=w> </span><span class=n>keywords</span><span class=p>);</span>
</span><span id=__span-68-8>
</span><span id=__span-68-9><span class=w>    </span><span class=c1>// 查询哈希表得到结果</span>
</span><span id=__span-68-10><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>si</span><span class=o>::</span><span class=n>BackwardIndexElement</span><span class=o>&gt;</span><span class=w> </span><span class=n>results</span><span class=p>;</span>
</span><span id=__span-68-11><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unordered_map</span><span class=o>&lt;</span><span class=kt>uint64_t</span><span class=p>,</span><span class=w> </span><span class=n>si</span><span class=o>::</span><span class=n>BackwardIndexElement</span><span class=o>&gt;</span><span class=w> </span><span class=n>select_map</span><span class=p>;</span>
</span><span id=__span-68-12><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>word</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>keywords</span><span class=p>)</span>
</span><span id=__span-68-13><span class=w>    </span><span class=p>{</span>
</span><span id=__span-68-14><span class=w>        </span><span class=c1>// 忽略大小写</span>
</span><span id=__span-68-15><span class=w>        </span><span class=n>boost</span><span class=o>::</span><span class=n>to_lower</span><span class=p>(</span><span class=n>word</span><span class=p>);</span>
</span><span id=__span-68-16><span class=w>        </span><span class=c1>// 查倒排索引</span>
</span><span id=__span-68-17><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-68-18><span class=w>    </span><span class=p>}</span>
</span><span id=__span-68-19>
</span><span id=__span-68-20><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-68-21><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h3 id=_18>查询结果优化<a class=headerlink href=#_18 title="Permanent link">&para;</a></h3> <p>在上面的代码中可以发现获取到的内容中有些<code>body</code>部分内容特别多，这是因为在写入时直接写入了整个<code>body</code>的内容，这个内容对应的就是去除标签后整个网页的内容，其中还包括了标题，但是在一个搜索引擎结果中，描述性文字实际上只有用户输入的关键字附近的一部分内容，如下图所示：</p> <p><a class=glightbox href="1. Boost库搜索引擎.assets/image-20250403204014782.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="1. Boost库搜索引擎.assets/image-20250403204014782.png"></a></p> <p>本次实现同样考虑实现这个方案，实现方式很简单，只需要截取以关键字为中心附近的字符组成一个新字符串再转换为JSON字符串即可。这里实现可以考虑使用string_view，因为涉及到大量的字符串操作</p> <p>本次实现中考虑取出第一个关键字前50个字符（如果没有就从头开始取）以及后100个字符（如果没有就取到结尾）构成一个新的字符串：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-69-1><span class=k>static</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>prev_words</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>50</span><span class=p>;</span>
</span><span id=__span-69-2><span class=k>static</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>after_words</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>100</span><span class=p>;</span>
</span><span id=__span-69-3><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=nf>getPartialBodyWithKeyword</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string_view</span><span class=w> </span><span class=n>body</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string_view</span><span class=w> </span><span class=n>keyword</span><span class=p>)</span>
</span><span id=__span-69-4><span class=p>{</span>
</span><span id=__span-69-5><span class=w>    </span><span class=c1>// 找到关键字</span>
</span><span id=__span-69-6><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>body</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>keyword</span><span class=p>);</span>
</span><span id=__span-69-7><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>pos</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string_view</span><span class=o>::</span><span class=n>npos</span><span class=p>)</span>
</span><span id=__span-69-8><span class=w>    </span><span class=p>{</span>
</span><span id=__span-69-9><span class=w>        </span><span class=n>ls</span><span class=o>::</span><span class=n>LOG</span><span class=p>(</span><span class=n>ls</span><span class=o>::</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;无法找到关键字，无法截取文章内容&quot;</span><span class=p>;</span>
</span><span id=__span-69-10><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&quot;Fail to cut body, can&#39;t find keyword&quot;</span><span class=p>;</span>
</span><span id=__span-69-11><span class=w>    </span><span class=p>}</span>
</span><span id=__span-69-12>
</span><span id=__span-69-13><span class=w>    </span><span class=c1>// 默认起始位置为0，终止位置为body字符串最后一个字符</span>
</span><span id=__span-69-14><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-69-15><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>body</span><span class=p>.</span><span class=n>size</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-69-16>
</span><span id=__span-69-17><span class=w>    </span><span class=c1>// 如果pos位置前有50个字符，就取前50个字符</span>
</span><span id=__span-69-18><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>pos</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>prev_words</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>start</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-69-19><span class=w>        </span><span class=n>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pos</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>prev_words</span><span class=p>;</span>
</span><span id=__span-69-20><span class=w>    </span><span class=c1>// 如果pos位置后有100个字符，就取后100个字符</span>
</span><span id=__span-69-21><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>pos</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>keyword</span><span class=p>.</span><span class=n>size</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>after_words</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>end</span><span class=p>)</span>
</span><span id=__span-69-22><span class=w>        </span><span class=n>end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pos</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>keyword</span><span class=p>.</span><span class=n>size</span><span class=p>())</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>after_words</span><span class=p>;</span>
</span><span id=__span-69-23>
</span><span id=__span-69-24><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>start</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>end</span><span class=p>)</span>
</span><span id=__span-69-25><span class=w>    </span><span class=p>{</span>
</span><span id=__span-69-26><span class=w>        </span><span class=n>ls</span><span class=o>::</span><span class=n>LOG</span><span class=p>(</span><span class=n>ls</span><span class=o>::</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;内容不足，无法截取文章内容&quot;</span><span class=p>;</span>
</span><span id=__span-69-27><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&quot;Fail to cut body, body is not enough&quot;</span><span class=p>;</span>
</span><span id=__span-69-28><span class=w>    </span><span class=p>}</span>
</span><span id=__span-69-29>
</span><span id=__span-69-30><span class=w>    </span><span class=c1>// 左闭右闭区间</span>
</span><span id=__span-69-31><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=p>(</span><span class=n>body</span><span class=p>.</span><span class=n>substr</span><span class=p>(</span><span class=n>start</span><span class=p>,</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>start</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>));</span>
</span><span id=__span-69-32><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h2 id=_19>第一阶段问题<a class=headerlink href=#_19 title="Permanent link">&para;</a></h2> <h3 id=_20>构建索引速度慢<a class=headerlink href=#_20 title="Permanent link">&para;</a></h3> <p>在构建索引函数<code>buildIndex</code>中分别添加两条日志：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-70-1><span class=c1>// 构建索引</span>
</span><span id=__span-70-2><span class=kt>bool</span><span class=w> </span><span class=nf>buildIndex</span><span class=p>()</span>
</span><span id=__span-70-3><span class=p>{</span>
</span><span id=__span-70-4><span class=w>    </span><span class=c1>// debug</span>
</span><span id=__span-70-5><span class=w>    </span><span class=n>ls</span><span class=o>::</span><span class=n>LOG</span><span class=p>(</span><span class=n>ls</span><span class=o>::</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>DEBUG</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;开始建立索引&quot;</span><span class=p>;</span>
</span><span id=__span-70-6>
</span><span id=__span-70-7><span class=w>    </span><span class=c1>// ..</span>
</span><span id=__span-70-8>
</span><span id=__span-70-9><span class=w>    </span><span class=n>ls</span><span class=o>::</span><span class=n>LOG</span><span class=p>(</span><span class=n>ls</span><span class=o>::</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>DEBUG</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;建立索引完成&quot;</span><span class=p>;</span>
</span><span id=__span-70-10>
</span><span id=__span-70-11><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-70-12><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>测试上面的代码可以发现几乎3秒钟执行一次10次构建，而<code>raw</code>文件中的内容有8141行，计算下来需要花费将近40分钟进行构建</p> <p>出现这个问题的主要原因就是<code>buildBackwardIndex</code>和<code>search</code>两个函数中的Jieba分词对象都是以局部变量的形式创建的，<code>search</code>会在用户搜索时执行，刚开始并没有出现明显的速度拖慢，但是<code>buildBackwardIndex</code>会在每一行内容构建时执行，这就导致了Jieba对象需要创建8141次</p> <p>解决这个问题的方式就是将Jieba分词对象作为成员变量：</p> <div class="tabbed-set tabbed-alternate" data-tabs=3:2><input checked=checked id=__tabbed_3_1 name=__tabbed_3 type=radio><input id=__tabbed_3_2 name=__tabbed_3 type=radio><div class=tabbed-labels><label for=__tabbed_3_1><code>SearchIndex</code>类</label><label for=__tabbed_3_2><code>SearchEngine</code>类</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-71-1><span class=k>class</span><span class=w> </span><span class=nc>SearchIndex</span>
</span><span id=__span-71-2><span class=p>{</span>
</span><span id=__span-71-3><span class=c1>// ...</span>
</span><span id=__span-71-4><span class=k>public</span><span class=o>:</span>
</span><span id=__span-71-5><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-71-6>
</span><span id=__span-71-7><span class=k>private</span><span class=o>:</span>
</span><span id=__span-71-8><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-71-9>
</span><span id=__span-71-10><span class=w>    </span><span class=c1>// 构建倒排索引</span>
</span><span id=__span-71-11><span class=w>    </span><span class=kt>bool</span><span class=w> </span><span class=n>buildBackwardIndex</span><span class=p>(</span><span class=n>SelectedDocInfo</span><span class=w> </span><span class=o>&amp;</span><span class=n>sd</span><span class=p>)</span>
</span><span id=__span-71-12><span class=w>    </span><span class=p>{</span>
</span><span id=__span-71-13><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-71-14>
</span><span id=__span-71-15><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=w> </span><span class=n>title_words</span><span class=p>;</span>
</span><span id=__span-71-16><span class=w>        </span><span class=n>jieba_</span><span class=p>.</span><span class=n>CutForSearch</span><span class=p>(</span><span class=n>sd</span><span class=p>.</span><span class=n>rd</span><span class=p>.</span><span class=n>title</span><span class=p>,</span><span class=w> </span><span class=n>title_words</span><span class=p>);</span>
</span><span id=__span-71-17><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-71-18><span class=w>    </span><span class=p>}</span>
</span><span id=__span-71-19><span class=w>    </span><span class=c1>//...</span>
</span><span id=__span-71-20><span class=k>private</span><span class=o>:</span>
</span><span id=__span-71-21><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-71-22><span class=w>    </span><span class=n>cppjieba</span><span class=o>::</span><span class=n>Jieba</span><span class=w> </span><span class=n>jieba_</span><span class=p>;</span>
</span><span id=__span-71-23><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-72-1><span class=k>class</span><span class=w> </span><span class=nc>SearchEngine</span>
</span><span id=__span-72-2><span class=p>{</span>
</span><span id=__span-72-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-72-4><span class=w>    </span><span class=n>SearchEngine</span><span class=p>()</span>
</span><span id=__span-72-5><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=n>search_index_</span><span class=p>(</span><span class=n>si</span><span class=o>::</span><span class=n>SearchIndex</span><span class=o>::</span><span class=n>getSearchIndexInstance</span><span class=p>())</span>
</span><span id=__span-72-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-72-7><span class=w>        </span><span class=c1>// 构建索引</span>
</span><span id=__span-72-8><span class=w>        </span><span class=n>search_index_</span><span class=o>-&gt;</span><span class=n>buildIndex</span><span class=p>();</span>
</span><span id=__span-72-9><span class=w>    </span><span class=p>}</span>
</span><span id=__span-72-10>
</span><span id=__span-72-11><span class=w>    </span><span class=c1>// 根据关键字进行搜索</span>
</span><span id=__span-72-12><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>search</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>keyword</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>json_string</span><span class=p>)</span>
</span><span id=__span-72-13><span class=w>    </span><span class=p>{</span>
</span><span id=__span-72-14><span class=w>        </span><span class=c1>// 对用户输入的关键字进行切分</span>
</span><span id=__span-72-15>
</span><span id=__span-72-16><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=w> </span><span class=n>keywords</span><span class=p>;</span>
</span><span id=__span-72-17><span class=w>        </span><span class=n>jieba_</span><span class=p>.</span><span class=n>CutForSearch</span><span class=p>(</span><span class=n>keyword</span><span class=p>,</span><span class=w> </span><span class=n>keywords</span><span class=p>);</span>
</span><span id=__span-72-18>
</span><span id=__span-72-19><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-72-20><span class=w>    </span><span class=p>}</span>
</span><span id=__span-72-21>
</span><span id=__span-72-22><span class=w>    </span><span class=o>~</span><span class=n>SearchEngine</span><span class=p>()</span>
</span><span id=__span-72-23><span class=w>    </span><span class=p>{</span>
</span><span id=__span-72-24><span class=w>    </span><span class=p>}</span>
</span><span id=__span-72-25>
</span><span id=__span-72-26><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-72-27>
</span><span id=__span-72-28><span class=k>private</span><span class=o>:</span>
</span><span id=__span-72-29><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-72-30><span class=w>    </span><span class=n>cppjieba</span><span class=o>::</span><span class=n>Jieba</span><span class=w> </span><span class=n>jieba_</span><span class=p>;</span>
</span><span id=__span-72-31><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <h3 id=_21>进程占满内存，系统杀死进程<a class=headerlink href=#_21 title="Permanent link">&para;</a></h3> <p>解决第一个问题之后，再次运行代码可以发现建立索引的速度的确变快了，但是同时出现了第二个问题，当前系统的内存为4GB，在建立到五千行时会出现系统杀死进程，本质就是当前进程在运行一段时间后占满了内存，操作系统为了保护自己不得已杀死进程，如下图：</p> <p><a class=glightbox href="1. Boost库搜索引擎.assets/09de545073befbbf914afcfcc0b42859.png" data-type=image data-width=100% data-height=auto data-desc-position=bottom><img src="1. Boost库搜索引擎.assets/09de545073befbbf914afcfcc0b42859.png"></a></p> <p>出现这个问题的原因就是用于统计词频的哈希表成员。这张哈希表作为了成员变量，其生命周期随着对象，而当前对象只有在<code>SearchEngine</code>对象销毁时才会销毁，这就导致了<code>word_cnt_</code>成员在8141次构建倒排索引时一直在增长，最后内存无法存储这么大的哈希表不得已杀死进程</p> <p>但是实际上，<code>word_cnt_</code>只需要统计当前一行的关键字即可，因为在<code>buildBackwardIndex</code>中最后会将词频计算存储到倒排索引信息节点的权重属性，所以执行完这一步，<code>word_cnt_</code>当前的内容就可以不需要了</p> <p>解决方案有两种：</p> <ol> <li>将<code>word_cnt_</code>作为<code>buildBackwardIndex</code>函数的成员变量</li> <li>在<code>buildBackwardIndex</code>函数刚开始调用<code>word_cnt_</code>的<code>clear</code>函数清空当前的<code>word_cnt_</code></li> </ol> <p>本次采用第二种方法，修改如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-73-1><span class=c1>// 构建倒排索引</span>
</span><span id=__span-73-2><span class=kt>bool</span><span class=w> </span><span class=nf>buildBackwardIndex</span><span class=p>(</span><span class=n>SelectedDocInfo</span><span class=w> </span><span class=o>&amp;</span><span class=n>sd</span><span class=p>)</span>
</span><span id=__span-73-3><span class=p>{</span>
</span><span id=__span-73-4><span class=w>    </span><span class=n>word_cnt_</span><span class=p>.</span><span class=n>clear</span><span class=p>();</span>
</span><span id=__span-73-5><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-73-6><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h3 id=_22>错误进入本不应该进入的逻辑<a class=headerlink href=#_22 title="Permanent link">&para;</a></h3> <h4 id=getpartialbodywithkeyword>进入<code>getPartialBodyWithKeyword</code>中无法找到关键字分支<a class=headerlink href=#getpartialbodywithkeyword title="Permanent link">&para;</a></h4> <p>出现这个问题的本质是在<code>getPartialBodyWithKeyword</code>函数中，因为第一个参数获取到的是文章原始内容，其中的每一个单词包含大写和小写，但是第二个参数是忽略大小写之后的结果，这就导致在查找倒排索引时的确查得到，但是截取时因为可能存在大写字母而没有忽略大小写导致没有截取到对应的关键字</p> <p>最简单的解决方案就是将内容全部转换为小写，但是这样的成本过高，另外一种方案就是在查找的时候忽略大小写，但是<code>string_view</code>中并没有提供忽略大小写查找的方案，所以需要借助<code>&lt;algorithm&gt;</code>中的<code>search</code>方法解决，该方法的原型如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-74-1><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>class</span><span class=w> </span><span class=nc>ForwardIterator1</span><span class=p>,</span><span class=w> </span><span class=k>class</span><span class=w> </span><span class=nc>ForwardIterator2</span><span class=p>,</span><span class=w> </span><span class=k>class</span><span class=w> </span><span class=nc>BinaryPredicate</span><span class=o>&gt;</span>
</span><span id=__span-74-2><span class=n>ForwardIterator1</span><span class=w> </span><span class=n>search</span><span class=w> </span><span class=p>(</span><span class=n>ForwardIterator1</span><span class=w> </span><span class=n>first1</span><span class=p>,</span><span class=w> </span><span class=n>ForwardIterator1</span><span class=w> </span><span class=n>last1</span><span class=p>,</span>
</span><span id=__span-74-3><span class=w>                        </span><span class=n>ForwardIterator2</span><span class=w> </span><span class=n>first2</span><span class=p>,</span><span class=w> </span><span class=n>ForwardIterator2</span><span class=w> </span><span class=n>last2</span><span class=p>,</span>
</span><span id=__span-74-4><span class=w>                        </span><span class=n>BinaryPredicate</span><span class=w> </span><span class=n>pred</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>该方法的含义是根据<code>pred</code>的比较方式查找第一个容器中是否连续含有第二个容器的内容，因为本次查找就是为了查找出内容中是否含有关键字并且需要忽略大小写，本质就是查找是否在内容中存在连续的字符转换为小写与关键字的每一个字符在转换小写后相同</p> <p>但是，<code>search</code>函数会返回一个迭代器而不是整数表示第一次出现的位置，所以还需要计算出当前迭代器位置与原始内容字符串开始的距离</p> <p>这里可以使用<code>&lt;iterator&gt;</code>库中的<code>distance</code>函数，该函数原型如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-75-1><span class=k>template</span><span class=o>&lt;</span><span class=k>class</span><span class=w> </span><span class=nc>InputIterator</span><span class=o>&gt;</span>
</span><span id=__span-75-2><span class=k>typename</span><span class=w> </span><span class=nc>iterator_traits</span><span class=o>&lt;</span><span class=n>InputIterator</span><span class=o>&gt;::</span><span class=n>difference_type</span>
</span><span id=__span-75-3><span class=n>distance</span><span class=w> </span><span class=p>(</span><span class=n>InputIterator</span><span class=w> </span><span class=n>first</span><span class=p>,</span><span class=w> </span><span class=n>InputIterator</span><span class=w> </span><span class=n>last</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>该函数会返回第一个迭代器和第二个迭代器之间的位置值，如果将迭代器类比为指针，因为当前元素是字符，占用一个字节，那么就可以理解为两个指针直接相减得到的值</p> <p>基于上面这个解决方案，修改原来的<code>getPartialBodyWithKeyword</code>函数：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-76-1><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=nf>getPartialBodyWithKeyword</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string_view</span><span class=w> </span><span class=n>body</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string_view</span><span class=w> </span><span class=n>keyword</span><span class=p>)</span>
</span><span id=__span-76-2><span class=p>{</span>
</span><span id=__span-76-3><span class=w>    </span><span class=c1>// 找到关键字</span>
</span><span id=__span-76-4><span class=w>    </span><span class=c1>// size_t pos = body.find(keyword);</span>
</span><span id=__span-76-5><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>pos_t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>search</span><span class=p>(</span><span class=n>body</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span><span class=w> </span><span class=n>body</span><span class=p>.</span><span class=n>end</span><span class=p>(),</span><span class=w> </span><span class=n>keyword</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span><span class=w> </span><span class=n>keyword</span><span class=p>.</span><span class=n>end</span><span class=p>(),</span><span class=w> </span><span class=p>[](</span><span class=kt>char</span><span class=w> </span><span class=n>c1</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=n>c2</span><span class=p>)</span>
</span><span id=__span-76-6><span class=w>    </span><span class=p>{</span><span class=w> </span>
</span><span id=__span-76-7><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>tolower</span><span class=p>(</span><span class=n>c1</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>tolower</span><span class=p>(</span><span class=n>c2</span><span class=p>);</span><span class=w> </span>
</span><span id=__span-76-8><span class=w>    </span><span class=p>});</span>
</span><span id=__span-76-9>
</span><span id=__span-76-10><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pos_t</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>body</span><span class=p>.</span><span class=n>end</span><span class=p>())</span>
</span><span id=__span-76-11><span class=w>    </span><span class=p>{</span>
</span><span id=__span-76-12><span class=w>        </span><span class=n>ls</span><span class=o>::</span><span class=n>LOG</span><span class=p>(</span><span class=n>ls</span><span class=o>::</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>WARNING</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;无法找到关键字，无法截取文章内容&quot;</span><span class=p>;</span>
</span><span id=__span-76-13><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&quot;Fail to cut body, can&#39;t find keyword&quot;</span><span class=p>;</span>
</span><span id=__span-76-14><span class=w>    </span><span class=p>}</span>
</span><span id=__span-76-15>
</span><span id=__span-76-16><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>distance</span><span class=p>(</span><span class=n>body</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span><span class=w> </span><span class=n>pos_t</span><span class=p>);</span>
</span><span id=__span-76-17>
</span><span id=__span-76-18><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-76-19><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h4 id=getpartialbodywithkeyword_1>进入<code>getPartialBodyWithKeyword</code>中内容不足截取不到内容分支<a class=headerlink href=#getpartialbodywithkeyword_1 title="Permanent link">&para;</a></h4> <p>出现这个问题的原因在<code>getPartialBodyWithKeyword</code>中，计算是否可以取出前50个字符时<code>pos</code>并没有转换为<code>int</code>，而是保留了<code>size_t</code>参与运算，这就导致计算<code>pos - prev_words &gt; start</code>是出现了类型提升，即全部以<code>size_t</code>类型进行计算，而此时的<code>pos</code>一旦是<code>size_t</code>就会变成<code>npos</code>的值（即<code>int</code>类型下的-1，<code>size_t</code>下的<span class=arithmatex>\(2^{64} - 1\)</span>），因此<code>pos - prev_words</code>始终大于<code>start</code>，因为根本减不到负数。这里条件成立进入分支之后执行<code>start = pos - prev_words;</code>。接着，一旦满足<code>start &gt; end</code>，就会进入到<code>内容不足截取不到内容分支</code>的逻辑</p> <p>解决方案就是将<code>pos</code>转换为<code>int</code>类型防止出现类型提升：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-77-1><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=nf>getPartialBodyWithKeyword</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string_view</span><span class=w> </span><span class=n>body</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string_view</span><span class=w> </span><span class=n>keyword</span><span class=p>)</span>
</span><span id=__span-77-2><span class=p>{</span>
</span><span id=__span-77-3><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-77-4>
</span><span id=__span-77-5><span class=w>    </span><span class=c1>// 如果pos位置前有50个字符，就取前50个字符</span>
</span><span id=__span-77-6><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>pos</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>prev_words</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>start</span><span class=p>)</span>
</span><span id=__span-77-7><span class=w>        </span><span class=n>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pos</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>prev_words</span><span class=p>;</span>
</span><span id=__span-77-8><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-77-9><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h3 id=url>构建的URL在官网出现页面不存在<a class=headerlink href=#url title="Permanent link">&para;</a></h3> <p>例如下面构建出的URL：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-78-1>https://www.boost.org/doc/libs/1_78_0/doc/html/some_basic_explanations.html
</span></code></pre></div></td></tr></table></div> <p>官网实际的URL为：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-79-1>https://www.boost.org/doc/libs/1_78_0/doc/html/interprocess/some_basic_explanations.html
</span></code></pre></div></td></tr></table></div> <p>首先排除目录路径问题，如下：</p> <div class="language-shell highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-80-1>epsda@ham-carrier-ubuntu:~/BoostSearchingEngine$<span class=w> </span>find<span class=w> </span>-name<span class=w> </span>some_basic_explanations.html
</span><span id=__span-80-2>./data/source/html/interprocess/some_basic_explanations.html
</span></code></pre></div></td></tr></table></div> <p>可以看到在<code>html</code>目录下的确存在<code>interprocess/some_basic_explanations.html</code>，如果按照预期的拼接方式应该为：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-81-1>https://www.boost.org/doc/libs/1_78_0/doc/html/ + interprocess/some_basic_explanations.html
</span></code></pre></div></td></tr></table></div> <p>但是这里的拼接方式为：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-82-1>https://www.boost.org/doc/libs/1_78_0/doc/html/ + some_basic_explanations.html
</span></code></pre></div></td></tr></table></div> <p>这就导致出现了页面不存在（404）的问题</p> <p>出现这个问题的代码就是<code>constructHtmlUrl</code>中截取本地路径部分。原始的逻辑是找到最后一个<code>/</code>就停止查找，导致截取出的<code>some_basic_explanations.html</code>实际上缺少了其父级目录<code>interprocess/</code>，进而导致构建URL时得到的URL在官网不存在</p> <p>解决这个问题的思路很简单，只需要查找路径<code>/data/source/html</code>在<code>/data/source/html/interprocess/some_basic_explanations.html</code>出现的起始位置值<code>pos</code>，再从<code>pos + 路径长度</code>开始截取后面的内容即可</p> <p>基于上面的思路修改代码如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-83-1><span class=c1>// 构建URL</span>
</span><span id=__span-83-2><span class=kt>bool</span><span class=w> </span><span class=nf>constructHtmlUrl</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>fs</span><span class=o>::</span><span class=n>path</span><span class=w> </span><span class=o>&amp;</span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>*</span><span class=n>url</span><span class=p>)</span>
</span><span id=__span-83-3><span class=p>{</span>
</span><span id=__span-83-4><span class=w>    </span><span class=c1>// 查找/data/source/html</span>
</span><span id=__span-83-5><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>t_path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>string</span><span class=p>();</span>
</span><span id=__span-83-6><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>t_path</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>g_datasource_path</span><span class=p>);</span>
</span><span id=__span-83-7>
</span><span id=__span-83-8><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-83-9>
</span><span id=__span-83-10><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>source_path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>t_path</span><span class=p>.</span><span class=n>substr</span><span class=p>(</span><span class=n>pos</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>g_datasource_path</span><span class=p>.</span><span class=n>string</span><span class=p>().</span><span class=n>size</span><span class=p>());</span>
</span><span id=__span-83-11><span class=w>    </span><span class=o>*</span><span class=n>url</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>g_url_to_concat</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>source_path</span><span class=p>;</span>
</span><span id=__span-83-12>
</span><span id=__span-83-13><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-83-14><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h3 id=_23>权重计算异常<a class=headerlink href=#_23 title="Permanent link">&para;</a></h3> <p>在构建JSON字符串时，添加文档ID、权重和关键字后测试：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-84-1><span class=kt>void</span><span class=w> </span><span class=nf>search</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>keyword</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>json_string</span><span class=p>)</span>
</span><span id=__span-84-2><span class=p>{</span>
</span><span id=__span-84-3><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-84-4>
</span><span id=__span-84-5><span class=w>    </span><span class=c1>// 转换为JSON字符串</span>
</span><span id=__span-84-6><span class=w>    </span><span class=n>Json</span><span class=o>::</span><span class=n>Value</span><span class=w> </span><span class=n>root</span><span class=p>;</span>
</span><span id=__span-84-7><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>bi</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>results</span><span class=p>)</span>
</span><span id=__span-84-8><span class=w>    </span><span class=p>{</span>
</span><span id=__span-84-9><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-84-10><span class=w>        </span><span class=n>item</span><span class=p>[</span><span class=s>&quot;id&quot;</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sd</span><span class=o>-&gt;</span><span class=n>id</span><span class=p>;</span>
</span><span id=__span-84-11><span class=w>        </span><span class=n>item</span><span class=p>[</span><span class=s>&quot;word&quot;</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bi</span><span class=p>.</span><span class=n>word</span><span class=p>;</span>
</span><span id=__span-84-12><span class=w>        </span><span class=n>item</span><span class=p>[</span><span class=s>&quot;weight&quot;</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bi</span><span class=p>.</span><span class=n>weight</span><span class=p>;</span>
</span><span id=__span-84-13><span class=w>        </span><span class=c1>// ...</span>
</span><span id=__span-84-14><span class=w>    </span><span class=p>}</span>
</span><span id=__span-84-15>
</span><span id=__span-84-16><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-84-17><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>测试结果可以看到，有些权重计算结果存在一定误差，例如搜索<code>split</code>：</p> <div class="language-json highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>JSON</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-85-1><span class=p>{</span>
</span><span id=__span-85-2><span class=w>        </span><span class=nt>&quot;body&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;Class template split_iteratorHomeLibrariesPeopleFAQMoreClass template split_iteratorboost::algorithm::split_iterator \u2014 &quot;</span><span class=p>,</span>
</span><span id=__span-85-3><span class=w>        </span><span class=nt>&quot;id&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=mi>6164</span><span class=p>,</span>
</span><span id=__span-85-4><span class=w>        </span><span class=nt>&quot;title&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;Class template split_iterator&quot;</span><span class=p>,</span>
</span><span id=__span-85-5><span class=w>        </span><span class=nt>&quot;url&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;https://www.boost.org/doc/libs/1_78_0/doc/html/boost/algorithm/split_iterator.html&quot;</span><span class=p>,</span>
</span><span id=__span-85-6><span class=w>        </span><span class=nt>&quot;weight&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=mi>34</span><span class=p>,</span>
</span><span id=__span-85-7><span class=w>        </span><span class=nt>&quot;word&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;split&quot;</span>
</span><span id=__span-85-8><span class=p>},</span>
</span></code></pre></div></td></tr></table></div> <p>通过网址到官网启动浏览器搜索可以看到结果总共是25，其中标题中也存在<code>split</code>，按照设定的权重计算公式<span class=arithmatex>\(title \times 10 + body\)</span>应该是35而并非34</p> <p>为了找出这个问题出现的原因，需要在查询时针对当前文档ID单独打印处理，猜测出现这个问题的原因是分词工具的分词逻辑和浏览器的分词逻辑不同，修改<code>buildBackwardIndex</code>代码如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-86-1><span class=c1>// 构建倒排索引</span>
</span><span id=__span-86-2><span class=kt>bool</span><span class=w> </span><span class=nf>buildBackwardIndex</span><span class=p>(</span><span class=n>SelectedDocInfo</span><span class=w> </span><span class=o>&amp;</span><span class=n>sd</span><span class=p>)</span>
</span><span id=__span-86-3><span class=p>{</span>
</span><span id=__span-86-4><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-86-5>
</span><span id=__span-86-6><span class=w>    </span><span class=c1>// 一旦文档ID为6164就打印出标题的所有分词结果</span>
</span><span id=__span-86-7><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sd</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>6164</span><span class=p>)</span>
</span><span id=__span-86-8><span class=w>    </span><span class=p>{</span>
</span><span id=__span-86-9><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>s</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>title_words</span><span class=p>)</span>
</span><span id=__span-86-10><span class=w>        </span><span class=p>{</span>
</span><span id=__span-86-11><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;title: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-86-12><span class=w>        </span><span class=p>}</span>
</span><span id=__span-86-13><span class=w>    </span><span class=p>}</span>
</span><span id=__span-86-14>
</span><span id=__span-86-15><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-86-16>
</span><span id=__span-86-17><span class=w>    </span><span class=c1>// 一旦文档ID为6164就打印出所有文档内容的所有分词结果</span>
</span><span id=__span-86-18><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sd</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>6164</span><span class=p>)</span>
</span><span id=__span-86-19><span class=w>    </span><span class=p>{</span>
</span><span id=__span-86-20><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>s</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>body_words</span><span class=p>)</span>
</span><span id=__span-86-21><span class=w>        </span><span class=p>{</span>
</span><span id=__span-86-22><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;body: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-86-23><span class=w>        </span><span class=p>}</span>
</span><span id=__span-86-24><span class=w>    </span><span class=p>}</span>
</span><span id=__span-86-25>
</span><span id=__span-86-26><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-86-27><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>再次进行测试，可以发现，标题存在1个<code>split</code>，文章内容中只有24个<code>split</code>，根据前面的计算公式可以得出权重值为34，可以发现代码并没有问题，只是分词的逻辑不同而已</p> <h2 id=_24>创建服务器<a class=headerlink href=#_24 title="Permanent link">&para;</a></h2> <p>本次创建服务器不直接使用原生的网络接口，而是使用封装后的cpp-httplib库，所以首先需要准备该库：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-87-1><span class=n>git</span><span class=w> </span><span class=n>clone</span><span class=w> </span><span class=n>https</span><span class=o>:</span><span class=c1>//github.com/yhirose/cpp-httplib.git</span>
</span></code></pre></div></td></tr></table></div> <p>接着，在当前项目目录下建立一个软链接指向cpp-httplib对应的目录即可，例如：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-88-1><span class=n>ln</span><span class=w> </span><span class=o>-</span><span class=n>s</span><span class=w> </span><span class=o>/</span><span class=n>home</span><span class=o>/</span><span class=n>epsda</span><span class=o>/</span><span class=n>dependencies</span><span class=o>/</span><span class=n>cpp</span><span class=o>-</span><span class=n>httplib</span><span class=o>/</span>
</span></code></pre></div></td></tr></table></div> <p>完成安装后即可写出对应的服务器代码</p> <p>关于cpp-httplib的基本使用可以看<a href=https://github.com/yhirose/cpp-httplib>对应仓库中的介绍</a>，此处不再提及</p> <p>首先，为了保证客户端可以直接通过IP地址+端口号的方式直接访问到主页，先设置Web根目录为<code>wwwroot</code>，其中含有一个<code>index.html</code>文件作为主页，并在服务器程序中通过cpp-httplib.h中的<code>set_base_dir</code>函数设置：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-89-1><span class=c1>// 设置网页根路径</span>
</span><span id=__span-89-2><span class=n>httplib</span><span class=o>::</span><span class=n>Server</span><span class=w> </span><span class=n>s</span><span class=p>;</span>
</span><span id=__span-89-3><span class=n>s</span><span class=p>.</span><span class=n>set_base_dir</span><span class=p>(</span><span class=n>pd</span><span class=o>::</span><span class=n>root_path</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>设置完成后直接访问IP地址+端口号即可访问到主页</p> <p>接着服务器需要设置对应处理请求的方案，本次考虑用户请求<code>/search</code>服务时调用服务器中的<code>search</code>方法执行搜索，所以实现方式如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-90-1><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>(</span><span class=n>se</span><span class=o>::</span><span class=n>SearchEngine</span><span class=o>&amp;</span><span class=w> </span><span class=n>s_engine</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>httplib</span><span class=o>::</span><span class=n>Request</span><span class=o>&amp;</span><span class=w> </span><span class=n>req</span><span class=p>,</span><span class=w> </span><span class=n>httplib</span><span class=o>::</span><span class=n>Response</span><span class=w> </span><span class=o>&amp;</span><span class=n>resp</span><span class=p>)</span>
</span><span id=__span-90-2><span class=p>{</span>
</span><span id=__span-90-3>
</span><span id=__span-90-4><span class=p>}</span>
</span><span id=__span-90-5>
</span><span id=__span-90-6><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
</span><span id=__span-90-7><span class=p>{</span>
</span><span id=__span-90-8><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-90-9><span class=w>    </span><span class=n>se</span><span class=o>::</span><span class=n>SearchEngine</span><span class=w> </span><span class=n>s_engine</span><span class=p>;</span>
</span><span id=__span-90-10><span class=w>    </span><span class=n>s</span><span class=p>.</span><span class=n>Get</span><span class=p>(</span><span class=s>&quot;/search&quot;</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>bind</span><span class=p>(</span><span class=n>run</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>ref</span><span class=p>(</span><span class=n>s_engine</span><span class=p>),</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>placeholders</span><span class=o>::</span><span class=n>_1</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>placeholders</span><span class=o>::</span><span class=n>_2</span><span class=p>));</span>
</span><span id=__span-90-11><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-90-12><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>接着，本次考虑需要用户按照下面的方式请求才可以获取到内容：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-91-1>http://IP地址+端口/search?keyword=xxx
</span></code></pre></div></td></tr></table></div> <p>所以可以编写出对应的代码为：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-92-1><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>(</span><span class=n>se</span><span class=o>::</span><span class=n>SearchEngine</span><span class=o>&amp;</span><span class=w> </span><span class=n>s_engine</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>httplib</span><span class=o>::</span><span class=n>Request</span><span class=o>&amp;</span><span class=w> </span><span class=n>req</span><span class=p>,</span><span class=w> </span><span class=n>httplib</span><span class=o>::</span><span class=n>Response</span><span class=w> </span><span class=o>&amp;</span><span class=n>resp</span><span class=p>)</span>
</span><span id=__span-92-2><span class=p>{</span>
</span><span id=__span-92-3><span class=w>    </span><span class=c1>// 如果不存在word，说明在请求不存在的页面，返回404</span>
</span><span id=__span-92-4><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>req</span><span class=p>.</span><span class=n>has_param</span><span class=p>(</span><span class=s>&quot;keyword&quot;</span><span class=p>))</span>
</span><span id=__span-92-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-92-6><span class=w>        </span><span class=n>se</span><span class=o>::</span><span class=n>ls</span><span class=o>::</span><span class=n>LOG</span><span class=p>(</span><span class=n>se</span><span class=o>::</span><span class=n>ls</span><span class=o>::</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;请求不存在的资源&quot;</span><span class=p>;</span>
</span><span id=__span-92-7><span class=w>        </span><span class=n>resp</span><span class=p>.</span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>httplib</span><span class=o>::</span><span class=n>StatusCode</span><span class=o>::</span><span class=n>NotFound_404</span><span class=p>;</span>
</span><span id=__span-92-8><span class=w>        </span><span class=n>resp</span><span class=p>.</span><span class=n>set_file_content</span><span class=p>(</span><span class=s>&quot;wwwroot/404.html&quot;</span><span class=p>,</span><span class=w> </span><span class=s>&quot;text/html&quot;</span><span class=p>);</span>
</span><span id=__span-92-9><span class=w>        </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-92-10><span class=w>    </span><span class=p>}</span>
</span><span id=__span-92-11>
</span><span id=__span-92-12><span class=w>    </span><span class=c1>// 此时说明存在对应的值，获取值</span>
</span><span id=__span-92-13><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>val</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>req</span><span class=p>.</span><span class=n>get_param_value</span><span class=p>(</span><span class=s>&quot;keyword&quot;</span><span class=p>);</span>
</span><span id=__span-92-14>
</span><span id=__span-92-15><span class=w>    </span><span class=c1>// 执行搜索</span>
</span><span id=__span-92-16><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>json_string</span><span class=p>;</span>
</span><span id=__span-92-17><span class=w>    </span><span class=n>s_engine</span><span class=p>.</span><span class=n>search</span><span class=p>(</span><span class=n>val</span><span class=p>,</span><span class=w> </span><span class=n>json_string</span><span class=p>);</span>
</span><span id=__span-92-18>
</span><span id=__span-92-19><span class=w>    </span><span class=n>se</span><span class=o>::</span><span class=n>ls</span><span class=o>::</span><span class=n>LOG</span><span class=p>(</span><span class=n>se</span><span class=o>::</span><span class=n>ls</span><span class=o>::</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>INFO</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;搜索关键词: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>val</span><span class=p>;</span>
</span><span id=__span-92-20><span class=w>    </span><span class=n>resp</span><span class=p>.</span><span class=n>set_content</span><span class=p>(</span><span class=n>json_string</span><span class=p>,</span><span class=w> </span><span class=s>&quot;application/json&quot;</span><span class=p>);</span>
</span><span id=__span-92-21><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>最后，为了保证服务器可以正常被客户端访问，服务器还需要启动监听。本次考虑监听端口由启动方设定：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-93-1><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=o>*</span><span class=w> </span><span class=n>argv</span><span class=p>[])</span>
</span><span id=__span-93-2><span class=p>{</span>
</span><span id=__span-93-3><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>argc</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>2</span><span class=p>)</span>
</span><span id=__span-93-4><span class=w>    </span><span class=p>{</span>
</span><span id=__span-93-5><span class=w>        </span><span class=n>se</span><span class=o>::</span><span class=n>ls</span><span class=o>::</span><span class=n>LOG</span><span class=p>(</span><span class=n>se</span><span class=o>::</span><span class=n>ls</span><span class=o>::</span><span class=n>LogLevel</span><span class=o>::</span><span class=n>ERROR</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;启动方式错误&quot;</span><span class=p>;</span>
</span><span id=__span-93-6><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-93-7><span class=w>    </span><span class=p>}</span>
</span><span id=__span-93-8>
</span><span id=__span-93-9><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-93-10>
</span><span id=__span-93-11><span class=w>    </span><span class=c1>// 获取端口</span>
</span><span id=__span-93-12><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>stoi</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-93-13><span class=w>    </span><span class=c1>// 监听任意端口</span>
</span><span id=__span-93-14><span class=w>    </span><span class=n>s</span><span class=p>.</span><span class=n>listen</span><span class=p>(</span><span class=s>&quot;0.0.0.0&quot;</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>);</span>
</span><span id=__span-93-15>
</span><span id=__span-93-16><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-93-17><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title=最后更新> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2025年4月5日</span> </span> <span class=md-source-file__fact> <span class=md-icon title=创建日期> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2025年3月24日</span> </span> </aside> <form class=md-feedback name=feedback hidden> <fieldset> <legend class=md-feedback__title> 页面有帮助吗？ </legend> <div class=md-feedback__inner> <div class=md-feedback__list> <button class="md-feedback__icon md-icon" type=submit title=页面对我有帮助 data-md-value=1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 9v12H1V9zm4 12a2 2 0 0 1-2-2V9c0-.55.22-1.05.59-1.41L14.17 1l1.06 1.06c.27.27.44.64.44 1.05l-.03.32L14.69 8H21a2 2 0 0 1 2 2v2c0 .26-.05.5-.14.73l-3.02 7.05C19.54 20.5 18.83 21 18 21zm0-2h9.03L21 12v-2h-8.79l1.13-5.32L9 9.03z"/></svg> </button> <button class="md-feedback__icon md-icon" type=submit title=页面没有帮助到我 data-md-value=0> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 15V3h4v12zM15 3a2 2 0 0 1 2 2v10c0 .55-.22 1.05-.59 1.41L9.83 23l-1.06-1.06c-.27-.27-.44-.64-.44-1.06l.03-.31.95-4.57H3a2 2 0 0 1-2-2v-2c0-.26.05-.5.14-.73l3.02-7.05C4.46 3.5 5.17 3 6 3zm0 2H5.97L3 12v2h8.78l-1.13 5.32L15 14.97z"/></svg> </button> </div> <div class=md-feedback__note> <div data-md-value=1 hidden> 谢谢你的反馈！ </div> <div data-md-value=0 hidden> 谢谢你的反馈！联系<a href=https://www.help-doc.top/%E4%BD%9C%E8%80%85/%E4%BD%9C%E8%80%85.html>作者</a>提供更详细的信息 </div> </div> </div> </fieldset> </form> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> 回到页面顶部 </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2024-2025 柯懒不是柯南 </div> </div> <div class=md-social> <a href=https://github.com/H0308 target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://www.help-doc.top/%E4%BD%9C%E8%80%85/%E4%BD%9C%E8%80%85.html target=_blank rel=noopener title=www.help-doc.top class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M433.754 420.445c-11.526 1.393-44.86-52.741-44.86-52.741 0 31.345-16.136 72.247-51.051 101.786 16.842 5.192 54.843 19.167 45.803 34.421-7.316 12.343-125.51 7.881-159.632 4.037-34.122 3.844-152.316 8.306-159.632-4.037-9.045-15.25 28.918-29.214 45.783-34.415-34.92-29.539-51.059-70.445-51.059-101.792 0 0-33.334 54.134-44.859 52.741-5.37-.65-12.424-29.644 9.347-99.704 10.261-33.024 21.995-60.478 40.144-105.779C60.683 98.063 108.982.006 224 0c113.737.006 163.156 96.133 160.264 214.963 18.118 45.223 29.912 72.85 40.144 105.778 21.768 70.06 14.716 99.053 9.346 99.704"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.prune", "navigation.tabs", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script> <script src=../../assets/javascripts/bundle.c8b220af.min.js></script> <script src=../../javascripts/katex.min.js></script> <script src=../../javascripts/particles.min.js></script> <script src=../../javascripts/other.min.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/contrib/auto-render.min.js></script> <script src=../../assets/javascripts/toggle-sidebar.js async></script> <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body> </html>