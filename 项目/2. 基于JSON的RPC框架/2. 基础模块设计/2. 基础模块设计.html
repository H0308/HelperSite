<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://www.help-doc.top/%E9%A1%B9%E7%9B%AE/2.%20%E5%9F%BA%E4%BA%8EJSON%E7%9A%84RPC%E6%A1%86%E6%9E%B6/2.%20%E5%9F%BA%E7%A1%80%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1/2.%20%E5%9F%BA%E7%A1%80%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1.html><link rel=prev href=../1.%20%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D%E4%B8%8E%E5%87%86%E5%A4%87/1.%20%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D%E4%B8%8E%E5%87%86%E5%A4%87.html><link rel=next href=../3.%20%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1%EF%BC%88RPC%E3%80%81%E6%B3%A8%E5%86%8C%EF%BC%89/3.%20%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1%EF%BC%88RPC%E3%80%81%E6%B3%A8%E5%86%8C%EF%BC%89.html><link rel=icon href=../../../images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.12"><title>基础模块设计 - 柯懒的知识库</title><link rel=stylesheet href=../../../assets/stylesheets/main.2afb09e1.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.06af60db.min.css><link rel=stylesheet href=../../../css/timeline.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-9XWRGNRRSY"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-9XWRGNRRSY",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-9XWRGNRRSY",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script><link rel=stylesheet href=../../../stylesheets/theme2.css media="screen and (min-width: 768px) and (max-width: 1199px), screen and (min-width: 768px) and (max-width: 1199px) and (orientation: landscape)"><link rel=stylesheet href=../../../stylesheets/theme2.css media="screen and (max-width: 767px)"><link rel=stylesheet href=../../../stylesheets/theme1.css media="screen and (min-width: 1200px)"><link rel=stylesheet href=../../../stylesheets/print.css><script src=https://cdn.jsdelivr.net/npm/mermaid@11.5.0/dist/mermaid.min.js></script><style>
    @import url("https://static.zeoseven.com/zsft/2/main/result.css");
    /* 江城黑体备用 */
    @import url("https://fontsapi.zeoseven.com/194/main/result.css");
    /* OPPO Sans主字体 */
    @import url("https://fonts.cdnfonts.com/css/opposans");
    /* Dejavu Sans Mono */
    @import url('https://fonts.cdnfonts.com/css/dejavu-sans-mono');
    /* 寒蝉团圆体 Sans */
    @import url("https://fontsapi.zeoseven.com/70/main/result.css");

    @font-face {
        font-family: "OPPOSans";
    }

    @font-face {
        font-family: "JiangChengHeiTi 400W";
    }

    @font-face {
        font-family: "LXGW ZhenKai";
    }

    @font-face {
        font-family: 'DejaVu Sans Mono';
    }

    @font-face {
        font-family: "JetBrains Mono";
        src: url("https://static.zeoseven.com/zsft/hk/main.woff2") format("woff2"),
            url("https://static-host.zeoseven.com/zsft/hk/main.woff2") format("woff2");
    }

    @font-face {
        font-family: "寒蝉团圆体 Sans";
    }

    .md-header__topic .md-ellipsis {
        font-family: "寒蝉团圆体 Sans" !important;
    }

    :root {
        --md-text-font: "OPPOSans", "JiangChengHeiTi 400W", sans-serif;
        --md-header-font: "LXGW ZhenKai", sans-serif;
        --md-code-font: "DejaVu Sans Mono", "JetBrains Mono";
        --code-font-color: #e96900;
    }

    h1+div>p {
        font-family: var(--md-header-font);
    }

    @media screen and (max-width: 1199px) {
        .theme-switch {
            display: none !important;
        }
    }

    .theme-switch {
        display: inline-flex;
        gap: 8px;
        margin-right: 1rem;
        padding: 4px;
    }

    .theme-switch {
        margin-right: 1rem;
    }

    .theme-btn {
        font-family: var(--md-text-font);
        font-size: medium;
        padding: 8px 16px;
        border: none;
        border-radius: 8px 8px;
        color: #fff;
        cursor: pointer;
        min-width: 135px;
        height: 36px;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        /* 创建一个横向的渐变，包含两种状态的颜色 */
        background-image: linear-gradient(to right,
                #275796 0%,
                #4da6da 50%,
                #4da6da 50%,
                #00bda4 100%);
        /* 设置背景尺寸为两倍按钮宽度，这样可以容纳两种状态 */
        background-size: 200% 100%;
        /* 初始位置显示右半部分（默认颜色） */
        background-position: 100% 0;
        background-repeat: no-repeat;
        /* 确保背景位置变化有过渡效果 */
        transition: background-position 0.5s cubic-bezier(0.4, 0, 0.2, 1),
            transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .theme-btn .current-theme,
    .theme-btn .target-theme {
        position: absolute;
        width: 100%;
        left: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 2;
    }

    .theme-btn .current-theme {
        transform: translateX(0);
        opacity: 1;
        transition-delay: 0ms;
    }

    .theme-btn .target-theme {
        transform: translateX(-100%);
        opacity: 0;
        transition-delay: 0ms;
    }

    .theme-btn:hover {
        transform: scale(1.05);
        /* 悬浮时显示左半部分（悬浮颜色） */
        background-position: 0 0;
    }

    .theme-btn:hover .current-theme {
        transform: translateX(100%);
        opacity: 0;
        transition-delay: 100ms;
    }

    .theme-btn:hover .target-theme {
        transform: translateX(0);
        opacity: 1;
        transition-delay: 200ms;
    }

    .theme-btn:active {
        transform: scale(0.95);
        transition: all 100ms ease;
    }

    .md-content article>*:not(.md-top):not(.md-nav) {
        animation: flyIn 0.6s ease-out forwards;
        opacity: 0;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(1) {
        animation-delay: 0.1s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(2) {
        animation-delay: 0.15s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(3) {
        animation-delay: 0.2s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(4) {
        animation-delay: 0.25s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(5) {
        animation-delay: 0.3s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(6) {
        animation-delay: 0.35s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(7) {
        animation-delay: 0.4s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(8) {
        animation-delay: 0.45s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(9) {
        animation-delay: 0.5s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(10) {
        animation-delay: 0.55s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(11) {
        animation-delay: 0.6s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(12) {
        animation-delay: 0.65s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(13) {
        animation-delay: 0.7s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(14) {
        animation-delay: 0.75s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(15) {
        animation-delay: 0.8s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(16) {
        animation-delay: 0.85s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(17) {
        animation-delay: 0.9s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(18) {
        animation-delay: 0.95s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(19) {
        animation-delay: 1s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(20) {
        animation-delay: 1.05s;
    }

    .md-content article>*:not(.md-top):not(.md-nav):nth-child(n + 21) {
        animation-delay: 1.1s;
    }

    @keyframes flyIn {
        0% {
            opacity: 0;
            transform: translateY(-20px);
        }

        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @media (prefers-reduced-motion: reduce) {
        .md-content article>*:not(.md-top):not(.md-nav) {
            animation: none !important;
            opacity: 1 !important;
            transform: none !important;
        }
    }

    /* 添加超时后强制显示内容 */
    .md-content article>*:not(.md-top):not(.md-nav) {
        animation: flyIn 0.6s ease-out forwards;
        opacity: 0;
        /* 添加延迟后的备用显示 */
        animation-fill-mode: both;
    }

    /* 确保在3秒后强制显示所有内容 */
    .md-content {
        animation: ensureVisible 0.1s ease-out 3s forwards;
    }

    @keyframes ensureVisible {
        to {
            --force-visible: 1;
        }
    }

    .md-content[style*="--force-visible"] article>*:not(.md-top):not(.md-nav) {
        opacity: 1 !important;
        transform: translateY(0) !important;
    }

    li::marker {
        color: rgba(77, 166, 218, 0.9);
    }

    .md-search__input:hover,
    .md-search__input:focus {
        border-radius: 8px !important;
    }

    .md-search__form {
        border-radius: 8px !important;
    }

    .md-search__output {
        border-radius: 8px !important;
    }

    .md-search__overlay {
        border-radius: 8px !important;
    }

    .md-search-result {
        border-radius: 8px !important;
    }

    .md-search__inner {
        border-radius: 8px !important;
    }

    :not(pre)>code {
        color: #ff7043 !important;
        font-weight: normal;
    }

    .highlight .c1,
    .highlight .cm {
        color: #6a737d;
    }

    .md-typeset .admonition,
    .md-typeset details {
        border-width: 0;
        border-left-width: 4px;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
        font-family: var(--md-header-font);
        color: #4da6da !important;
    }

    body {
        font-family: var(--md-text-font);
    }

    pre code {
        color: var(--md-code-fg-color) !important;
    }

    .highlight pre {
        background-color: var(--md-code-bg-color) !important;
    }

    .md-typeset code {
        font-family: var(--md-code-font), var(--md-text-font);
    }

    .md-tabs__item.md-tabs__item--active {
        border-bottom: 2px solid rgba(77, 166, 218, 0.9);
    }

    .md-tabs__list>.md-tabs__item--active>.md-tabs__link {
        color: rgba(77, 166, 218, 0.9) !important;
    }

    .timeline-content::before {
        background-color: #efefef;
    }

    .timeline-card {
        background-color: #efefef !important;
    }

    .changelog-content a {
        color: #4051b5 !important;
        word-break: break-word;
    }

    .changelog-content a:focus,
    .changelog-content a:hover {
        color: #00bda4 !important;
    }

    .changelog-type-pageupdate {
        background-color: rgba(77, 166, 218, 0.9) !important;
    }

    .md-footer-runtime {
        position: relative;
        z-index: 3;
        margin: 0.5rem 0;
        padding: 0.4rem 0;
        font-size: 0.7rem;
        line-height: 1.6;
        color: var(--md-footer-fg-color--light);
        display: flex;
        align-items: center;
    }

    ::selection {
        background: rgba(77, 166, 218, 0.2);
    }

    html {
        scroll-behavior: smooth !important;
        /* 强制启用平滑滚动 */
        scroll-padding-top: 53px;
        /* 设置滚动偏移量,避免标题被导航栏遮挡 */
    }

    strong {
        color: rgb(182 68 180);
    }

    a[href^="#"],
    a[href*="/#"] {
        scroll-behavior: smooth !important;
    }

    .custom-tooltip {
        position: relative;
        display: inline-block;
        cursor: help;
        color: rgba(77, 166, 218, 0.9);
        border-bottom: 1px dashed rgba(77, 166, 218, 0.9);
        text-decoration: none !important;
    }

    .custom-tooltip::before {
        content: attr(data-title);
        position: absolute;
        width: 300px;
        background-color: rgba(51, 51, 51, 0.95);
        color: #fff;
        text-align: left;
        padding: 10px;
        border-radius: 6px;
        bottom: 125%;
        /* 定位在链接上方 */
        left: 50%;
        transform: translateX(-50%);
        z-index: 99999;
        /* 确保显示在最上层 */
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s;
        font-weight: normal;
        font-size: 14px;
        line-height: 1.5;
        pointer-events: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        word-wrap: break-word;
        white-space: normal;
    }

    .custom-tooltip::after {
        content: "";
        position: absolute;
        bottom: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: rgba(51, 51, 51, 0.95) transparent transparent transparent;
        z-index: 99999;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s;
        pointer-events: none;
    }

    .custom-tooltip:hover::before {
        opacity: 1;
        visibility: visible;
    }

    .custom-tooltip:hover::after {
        opacity: 1;
        visibility: visible;
    }

    /* 修改移动设备上的 tooltip 样式，确保不会溢出屏幕 */
    @media (max-width: 767px) {
        .custom-tooltip::before {
            width: calc(100vw - 40px);
            max-width: 250px;
            white-space: normal;
            font-size: 14px;
            left: 50%;
            transform: translateX(-50%);
            bottom: 130%;
            /* 确保不会超出屏幕边缘 */
            box-sizing: border-box;

            /* 新增：定位逻辑调整，防止溢出 */
            position: fixed;
            top: auto;
            bottom: auto;
            left: 20px;
            /* 距离左边缘固定距离 */
            right: 20px;
            /* 距离右边缘固定距离 */
            transform: none;
            margin-top: -120px;
            /* 在目标元素上方显示，可根据需要调整 */
            width: auto;
            /* 宽度由left和right决定 */
        }

        /* 新增：处理靠近页面底部的 tooltip */
        .custom-tooltip:hover::before {
            max-height: 80vh;
            /* 最大高度限制 */
            overflow-y: auto;
            /* 内容过多时可滚动 */
        }
    }

    .md-content a.custom-tooltip::after {
        display: none !important;
    }

    @media screen and (max-width: 767px) {

        /* 移除可能导致问题的现有样式 */
        .md-typeset .arithmatex {
            max-width: 100%;
            overflow-x: hidden;
            text-overflow: ellipsis;
        }

        /* 修改为更有效的样式 */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.25em 0;
        }

        /* 对于行内公式的新样式 */
        .katex {
            font-size: 1em !important;
            /* 减小字体大小 */
        }

        /* 调整整体数学公式容器的样式 */
        .md-typeset .arithmatex {
            max-width: 100% !important;
            overflow-x: auto;
            padding: 0.1em 0;
            margin: 0;
            display: block;
        }

        /* 确保行内公式不破坏布局 */
        .katex-inline {
            display: inline-block;
            max-width: 100%;
            overflow-x: auto;
            vertical-align: middle;
            white-space: normal;
            line-break: anywhere;
        }

        /* 添加淡出效果指示可滚动 */
        .katex-display::after {
            content: "";
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 20px;
            background: linear-gradient(to right,
                    rgba(255, 255, 255, 0),
                    rgba(255, 255, 255, 0.7));
            pointer-events: none;
        }
    }

    /* 头像样式 - 增强版，添加悬浮区域控制 */
    .header-avatar {
        display: inline-flex;
        align-items: center;
        margin-right: 0.8rem;
        position: relative;
        z-index: 10;
        /* 添加一个内边距以增加可点击区域，但不会影响布局 */
        padding: 3px;
    }

    .header-avatar img {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        position: relative;
        z-index: 5;
    }

    /* 下拉菜单样式 - 增强版，改进悬浮区域控制 */
    .avatar-dropdown {
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%) translateY(25px) scale(0.95);
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.18);
        padding: 45px 0 8px 0;
        /* 增加更多顶部内边距 */
        min-width: 140px;
        opacity: 0;
        visibility: hidden;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        z-index: 4;
        /* 低于头像 */
        margin-top: -10px;
        /* 让菜单上移覆盖头像下半部分 */
        /* 添加一个缓冲区，防止鼠标离开时闪烁 */
        pointer-events: none;
    }

    /* 悬停效果，修改触发条件和过渡延迟 */
    .header-avatar:hover .avatar-dropdown {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(15px) scale(1);
        /* 添加延迟以防止闪烁 */
        transition-delay: 0.05s;
        pointer-events: auto;
    }

    /* 添加间隙区域保持悬停状态 */
    .avatar-dropdown::after {
        content: "";
        position: absolute;
        top: -20px;
        /* 创建顶部缓冲区 */
        left: 0;
        width: 100%;
        height: 20px;
        background: transparent;
    }

    .header-avatar:hover img {
        transform: scale(1.5) translateY(18px);
        /* 放大并稍微向下移动 */
        box-shadow: 0 6px 16px rgba(77, 166, 218, 0.35);
        border-color: rgba(77, 166, 218, 0.8);
        /* 添加延迟以防止闪烁 */
        transition-delay: 0s;
    }

    /* 菜单三角形指示器 - 隐藏，因为视觉上头像已经作为指示器 */
    .avatar-dropdown::before {
        display: none;
    }

    /* 菜单项样式 */
    .avatar-dropdown-item {
        display: block;
        padding: 10px 16px;
        color: #333;
        font-size: 14px;
        text-decoration: none;
        transition: all 0.25s ease;
        text-align: center;
        position: relative;
        white-space: nowrap;
    }

    .avatar-dropdown p {
        padding: 10px 16px;
        color: #333;
        font-size: 16px;
        text-align: center;
        white-space: nowrap;
    }

    .avatar-dropdown-item:hover {
        background-color: rgba(77, 166, 218, 0.08);
        color: rgba(77, 166, 218, 0.9);
    }

    .avatar-dropdown-item:hover::after {
        content: "";
        position: absolute;
        left: 8px;
        width: 3px;
        height: 70%;
        background: rgba(77, 166, 218, 0.9);
        border-radius: 2px;
        top: 15%;
    }

    .avatar-dropdown-divider {
        height: 1px;
        background-color: rgba(0, 0, 0, 0.06);
        margin: 4px 8px;
    }

    /* 响应式设计调整 */
    @media screen and (max-width: 1199px) {
        .theme-switch {
            display: none !important;
        }

        .header-avatar {
            margin-right: 0.5rem;
        }
    }

    /* 响应式设计调整 */
    @media screen and (max-width: 1200px) {
        .header-avatar {
            margin-right: 0.3rem;
            padding: 2px;
        }

        .header-avatar img {
            width: 32px;
            height: 32px;
        }

        /* 调整菜单位置，靠左侧显示 */
        .avatar-dropdown {
            /* 调整left确保显示在左侧 */
            left: -120px;
            transform: translateX(0) translateY(25px) scale(0.95);
            padding-top: 15px;
            margin-top: 0;
            min-width: 130px;
            position: absolute;
            z-index: 100;
        }

        /* 点击时的行为，而不是悬停 */
        .header-avatar:hover .avatar-dropdown {
            transform: translateX(0) translateY(5px) scale(1);
        }

        /* 移动端头像不放大，防止页面移动 */
        .header-avatar:hover img {
            transform: none;
            border-color: rgba(77, 166, 218, 0.8);
            box-shadow: 0 4px 12px rgba(77, 166, 218, 0.3);
        }

        /* 调整导航栏布局 */
        .md-header__inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* 确保下拉菜单不遮挡其他元素 */
        .avatar-dropdown {
            max-width: 85vw;
        }
    }

    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #999;
    }

    /* 主题切换蒙版 - 优化结构和性能 */
    .theme-transition-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #ffffff;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        display: flex;
        align-items: center;
        justify-content: center;
        /* 简化过渡效果，提高性能 */
        transition: opacity 0.3s ease-out, visibility 0.3s ease-out,
            background-color 0.3s ease-out, backdrop-filter 0.3s ease-out;
        backdrop-filter: blur(0px);
    }

    .theme-transition-overlay.active {
        opacity: 1;
        visibility: visible;
        pointer-events: all;
        backdrop-filter: blur(5px);
    }

    /* 主题切换内容容器 - 整合样式 */
    .theme-transition-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 20px;
        transform: scale(0.9);
        opacity: 0;
        transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1),
            opacity 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .theme-transition-overlay.active .theme-transition-content {
        transform: scale(1);
        opacity: 1;
    }

    /* 简化加载图标结构，移除不必要的嵌套 */
    .theme-transition-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(77, 166, 218, 0.2);
        border-top-color: rgba(77, 166, 218, 0.8);
        border-radius: 50%;
        animation: none;
        transition: opacity 0.3s ease;
    }

    .theme-transition-overlay.active .theme-transition-spinner {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    /* 主题切换文字样式 */
    .theme-transition-text {
        font-family: var(--md-text-font);
        color: rgba(77, 166, 218, 0.9);
        font-size: 16px;
        font-weight: 500;
        text-align: center;
        margin-top: 10px;
    }

    /* 页脚爱情宣言样式 */
    .md-footer-love {
        position: relative;
        font-family: var(--md-header-font);
        font-size: 0.9rem;
        line-height: 1.6;
        margin: 0.5rem 0;
        padding: 0.5rem 1rem;
        color: rgba(255, 255, 255, 0.85);
        text-align: center;
        border-radius: 8px;
        background: linear-gradient(135deg,
                rgba(255, 255, 255, 0.1),
                rgba(255, 255, 255, 0.05));
        backdrop-filter: blur(4px);
        transition: all 0.4s ease;
        overflow: hidden;
        border-left: 3px solid rgba(255, 182, 193, 0.6);
    }

    .md-footer-love:hover {
        background: linear-gradient(135deg,
                rgba(255, 182, 193, 0.2),
                rgba(255, 255, 255, 0.1));
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 182, 193, 0.15);
    }

    /* 添加闪烁星星效果 */
    .md-footer-love::before,
    .md-footer-love::after {
        content: "★";
        position: absolute;
        opacity: 0;
        font-size: 0.8rem;
        color: rgba(255, 223, 223, 0.8);
        animation: twinkle 3s ease-in-out infinite alternate;
    }

    .md-footer-love::before {
        left: 0.5rem;
        top: 0.4rem;
        animation-delay: 0s;
    }

    .md-footer-love::after {
        right: 0.5rem;
        top: 0.4rem;
        animation-delay: 1.5s;
    }

    @keyframes twinkle {
        0% {
            opacity: 0.3;
            transform: scale(0.8);
        }

        50% {
            opacity: 0.9;
            transform: scale(1.2);
        }

        100% {
            opacity: 0.3;
            transform: scale(0.8);
        }
    }

    /* 名字高亮显示 */
    .love-highlight {
        font-weight: 500;
        background: linear-gradient(120deg, #ffb6c1, #ffc0cb);
        background-clip: text;
        -webkit-background-clip: text;
        color: transparent;
        padding: 0 0.2rem;
        position: relative;
        white-space: nowrap;
    }

    /* 添加心跳动画效果 */
    .love-heart {
        display: inline-block;
        font-size: 0.9em;
        color: rgba(255, 182, 193, 0.9);
        transform-origin: center;
        margin: 0 0.2rem;
        animation: heartbeat 1.5s ease-in-out infinite;
    }

    @keyframes heartbeat {
        0% {
            transform: scale(1);
        }

        15% {
            transform: scale(1.25);
        }

        30% {
            transform: scale(1);
        }

        45% {
            transform: scale(1.25);
        }

        60% {
            transform: scale(1);
        }

        100% {
            transform: scale(1);
        }
    }

    /* 添加响应式样式 - 平板设备 */
    @media screen and (max-width: 1199px) {
        .md-footer-love {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
            margin: 0.4rem 0;
        }

        .md-footer-love::before,
        .md-footer-love::after {
            font-size: 0.7rem;
        }
    }

    /* 添加响应式样式 - 移动设备 */
    @media screen and (max-width: 767px) {
        .md-footer-love {
            font-size: 0.75rem;
            padding: 0.3rem 0.5rem;
            margin: 0.3rem 0;
            border-radius: 6px;
            max-width: 90%;
            margin-left: auto;
            margin-right: auto;
            border-left-width: 2px;
        }

        .md-footer-love:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(255, 182, 193, 0.12);
        }

        .md-footer-love::before,
        .md-footer-love::after {
            font-size: 0.6rem;
        }

        .love-heart {
            font-size: 0.8em;
        }

        /* 在非常小的屏幕上隐藏星星效果 */
        @media screen and (max-width: 360px) {

            .md-footer-love::before,
            .md-footer-love::after {
                display: none;
            }
        }
    }

    /* Atom One Light 语法高亮样式 - 仅覆盖代码块语法高亮 */
    .highlight .hll {
        background-color: #e5e5e6 !important;
    }

    .highlight .c {
        color: #a0a1a7 !important;
    }

    /* Comment */
    .highlight .err {
        color: #ca1243 !important;
    }

    /* Error */
    .highlight .k {
        color: #a626a4 !important;
    }

    /* Keyword */
    .highlight .l {
        color: #986801 !important;
    }

    /* Literal */
    .highlight .n {
        color: #383a42 !important;
    }

    /* Name */
    .highlight .o {
        color: #383a42 !important;
    }

    /* Operator */
    .highlight .p {
        color: #383a42 !important;
    }

    /* Punctuation */
    .highlight .ch {
        color: #a0a1a7 !important;
    }

    /* Comment.Hashbang */
    .highlight .cm {
        color: #a0a1a7 !important;
    }

    /* Comment.Multiline */
    .highlight .cp {
        color: #a626a4 !important;
    }

    /* Comment.Preproc */
    .highlight .cpf {
        color: rgb(80, 161, 79) !important;
    }

    /* Comment.PreprocFile */
    .highlight .c1 {
        color: #a0a1a7 !important;
    }

    /* Comment.Single */
    .highlight .cs {
        color: #a0a1a7 !important;
    }

    /* Comment.Special */
    .highlight .gd {
        color: #ca1243 !important;
    }

    /* Generic.Deleted */
    .highlight .ge {
    }

    /* Generic.Emph */
    .highlight .gr {
        color: #ca1243 !important;
    }

    /* Generic.Error */
    .highlight .gh {
        color: #0184bc !important;
        font-weight: bold !important;
    }

    /* Generic.Heading */
    .highlight .gi {
        color: #50a14f !important;
    }

    /* Generic.Inserted */
    .highlight .go {
        color: #383a42 !important;
    }

    /* Generic.Output */
    .highlight .gp {
        color: #383a42 !important;
    }

    /* Generic.Prompt */
    .highlight .gs {
        font-weight: bold !important;
    }

    /* Generic.Strong */
    .highlight .gu {
        color: #0997b3 !important;
        font-weight: bold !important;
    }

    /* Generic.Subheading */
    .highlight .gt {
        color: #ca1243 !important;
    }

    /* Generic.Traceback */
    .highlight .kc {
        color: #a626a4 !important;
    }

    /* Keyword.Constant */
    .highlight .kd {
        color: #a626a4 !important;
    }

    /* Keyword.Declaration */
    .highlight .kn {
        color: #a626a4 !important;
    }

    /* Keyword.Namespace */
    .highlight .kp {
        color: #a626a4 !important;
    }

    /* Keyword.Pseudo */
    .highlight .kr {
        color: #a626a4 !important;
    }

    /* Keyword.Reserved */
    .highlight .kt {
        color: #c18401 !important;
    }

    /* Keyword.Type */
    .highlight .ld {
        color: #50a14f !important;
    }

    /* Literal.Date */
    .highlight .m {
        color: #986801 !important;
    }

    /* Literal.Number */
    .highlight .s {
        color: #50a14f !important;
    }

    /* Literal.String */
    .highlight .na {
        color: #c18401 !important;
    }

    /* Name.Attribute */
    .highlight .nb {
        color: #c18401 !important;
    }

    /* Name.Builtin */
    .highlight .nc {
        color: #c18401 !important;
    }

    /* Name.Class */
    .highlight .no {
        color: #ca1243 !important;
    }

    /* Name.Constant */
    .highlight .nd {
        color: #4078f2 !important;
    }

    /* Name.Decorator */
    .highlight .ni {
        color: #383a42 !important;
    }

    /* Name.Entity */
    .highlight .ne {
        color: #ca1243 !important;
    }

    /* Name.Exception */
    .highlight .nf {
        color: #4078f2 !important;
    }

    /* Name.Function */
    .highlight .nl {
        color: #383a42 !important;
    }

    /* Name.Label */
    .highlight .nn {
        color: #383a42 !important;
    }

    /* Name.Namespace */
    .highlight .nx {
        color: #4078f2 !important;
    }

    /* Name.Other */
    .highlight .py {
        color: #383a42 !important;
    }

    /* Name.Property */
    .highlight .nt {
        color: #e45649 !important;
    }

    /* Name.Tag */
    .highlight .nv {
        color: #ca1243 !important;
    }

    /* Name.Variable */
    .highlight .ow {
        color: #a626a4 !important;
    }

    /* Operator.Word */
    .highlight .w {
        color: #383a42 !important;
    }

    /* Text.Whitespace */
    .highlight .mb {
        color: #986801 !important;
    }

    /* Literal.Number.Bin */
    .highlight .mf {
        color: #986801 !important;
    }

    /* Literal.Number.Float */
    .highlight .mh {
        color: #986801 !important;
    }

    /* Literal.Number.Hex */
    .highlight .mi {
        color: #986801 !important;
    }

    /* Literal.Number.Integer */
    .highlight .mo {
        color: #986801 !important;
    }

    /* Literal.Number.Oct */
    .highlight .sa {
        color: #50a14f !important;
    }

    /* Literal.String.Affix */
    .highlight .sb {
        color: #50a14f !important;
    }

    /* Literal.String.Backtick */
    .highlight .sc {
        color: #50a14f !important;
    }

    /* Literal.String.Char */
    .highlight .dl {
        color: #50a14f !important;
    }

    /* Literal.String.Delimiter */
    .highlight .sd {
        color: #a0a1a7 !important;
    }

    /* Literal.String.Doc */
    .highlight .s2 {
        color: #50a14f !important;
    }

    /* Literal.String.Double */
    .highlight .se {
        color: #4078f2 !important;
    }

    /* Literal.String.Escape */
    .highlight .sh {
        color: #50a14f !important;
    }

    /* Literal.String.Heredoc */
    .highlight .si {
        color: #4078f2 !important;
    }

    /* Literal.String.Interpol */
    .highlight .sx {
        color: #50a14f !important;
    }

    /* Literal.String.Other */
    .highlight .sr {
        color: #50a14f !important;
    }

    /* Literal.String.Regex */
    .highlight .s1 {
        color: #50a14f !important;
    }

    /* Literal.String.Single */
    .highlight .ss {
        color: #50a14f !important;
    }

    /* Literal.String.Symbol */
    .highlight .bp {
        color: #c18401 !important;
    }

    /* Name.Builtin.Pseudo */
    .highlight .fm {
        color: #4078f2 !important;
    }

    /* Name.Function.Magic */
    .highlight .vc {
        color: #ca1243 !important;
    }

    /* Name.Variable.Class */
    .highlight .vg {
        color: #ca1243 !important;
    }

    /* Name.Variable.Global */
    .highlight .vi {
        color: #ca1243 !important;
    }

    /* Name.Variable.Instance */
    .highlight .vm {
        color: #ca1243 !important;
    }

    /* Name.Variable.Magic */
    .highlight .il {
        color: #986801 !important;
    }

    /* Literal.Number.Integer.Long */

    /* 特殊语言的额外样式调整 */
    .highlight[data-lang="json"] .nt {
        color: #e45649 !important;
    }

    /* JSON keys */
    .highlight[data-lang="yaml"] .na {
        color: #e45649 !important;
    }

    /* YAML keys */
    .highlight[data-lang="yml"] .na {
        color: #e45649 !important;
    }

    /* YAML keys */
    .highlight[data-lang="xml"] .nt {
        color: #e45649 !important;
    }

    /* XML tags */
    .highlight[data-lang="html"] .nt {
        color: #e45649 !important;
    }

    /* HTML tags */

    /* CSS特殊处理 */
    .highlight[data-lang="css"] .nc {
        color: #c18401 !important;
    }

    /* CSS class selectors */
    .highlight[data-lang="css"] .nf {
        color: #4078f2 !important;
    }

    /* CSS functions */
    .highlight[data-lang="css"] .nt {
        color: #e45649 !important;
    }

    /* CSS element selectors */
    .highlight[data-lang="css"] .nd {
        color: #a626a4 !important;
    }

    /* CSS pseudo-classes */

    /* JavaScript特殊处理 */
    .highlight[data-lang="javascript"] .nx {
        color: #4078f2 !important;
    }

    /* JS functions and variables */
    .highlight[data-lang="js"] .nx {
        color: #4078f2 !important;
    }

    /* JS functions and variables */

    /* Python特殊处理 */
    .highlight[data-lang="python"] .nd {
        color: #4078f2 !important;
    }

    /* Python decorators */
    .highlight[data-lang="python"] .nf {
        color: #4078f2 !important;
    }

    /* Python functions */
    .highlight[data-lang="python"] .nc {
        color: #c18401 !important;
    }

    /* Python classes */

    /* Shell/Bash特殊处理 */
    .highlight[data-lang="bash"] .nv {
        color: #ca1243 !important;
    }

    /* Bash variables */
    .highlight[data-lang="shell"] .nv {
        color: #ca1243 !important;
    }

    /* Shell variables */
    .highlight[data-lang="sh"] .nv {
        color: #ca1243 !important;
    }

    /* Shell variables */

    /* C/C++特殊处理 */
    .highlight[data-lang="c"] .kt {
        color: #a626a4 !important;
    }

    /* C types */
    .highlight[data-lang="cpp"] .kt {
        color: #a626a4 !important;
    }

    /* C++ types */
    .highlight[data-lang="c++"] .kt {
        color: #a626a4 !important;
    }

    /* C++ types */

    /* Java特殊处理 */
    .highlight[data-lang="java"] .nc {
        color: #c18401 !important;
    }

    /* Java classes */
    .highlight[data-lang="java"] .kt {
        color: #a626a4 !important;
    }

    /* Java types */
</style><script>
    document.addEventListener("DOMContentLoaded", () => {
        const searchEl = document.querySelector(".md-search");
        const savedTheme = localStorage.getItem("preferred-theme") || "theme1";

        // 创建头像元素，包含下拉菜单
        const avatarEl = document.createElement("div");
        avatarEl.className = "header-avatar";

        // 创建头像图片和下拉菜单
        avatarEl.innerHTML = `
        <img src="/作者/作者.assets/20250206-200653.jpg" alt="头像">
        <div class="avatar-dropdown">
            <p><strong>柯懒不是柯南</strong></p>
            <a href="/作者/联系作者/作者.html" class="avatar-dropdown-item">吵醒柯懒</a>
            <div class="avatar-dropdown-divider"></div>
            <a href="/作者/关于作者/关于作者.html" class="avatar-dropdown-item">柯懒自传</a>
            <div class="avatar-dropdown-divider"></div>
            <a href="https://github.com/H0308" class="avatar-dropdown-item">柯懒的零食库</a>
        </div>
    `;

        // 创建主题切换按钮
        const themeSwitch = document.createElement("div");
        themeSwitch.className = "theme-switch";
        themeSwitch.innerHTML = `
        <button class="theme-btn" onclick="switchTheme()">
            <span class="current-theme">${savedTheme === "theme1" ? "当前：新版主题" : "当前：原生主题"
            }</span>
            <span class="target-theme">${savedTheme === "theme1"
                ? "切换到：原生主题"
                : "切换到：新版主题"
            }</span>
        </button>
    `;

        // 插入元素
        searchEl.parentNode.insertBefore(avatarEl, searchEl);
        searchEl.parentNode.insertBefore(themeSwitch, searchEl);

        const initialTheme = localStorage.getItem("preferred-theme");
        if (initialTheme) {
            const theme1Link = document.querySelector('link[href*="theme1"]');
            const theme2Link = document.querySelector('link[href*="theme2"]');

            // 关闭过渡动画，直接设置主题
            if (initialTheme === "theme1") {
                theme1Link.removeAttribute("disabled");
                theme2Link.setAttribute("disabled", "true");
            } else {
                theme2Link.removeAttribute("disabled");
                theme1Link.setAttribute("disabled", "true");
            }
        }

        // 添加加载完成后的检测
        setTimeout(() => {
            const hiddenElements = document.querySelectorAll('.md-content article>*[style*="opacity: 0"]');
            hiddenElements.forEach(el => {
                el.style.opacity = '1';
                el.style.transform = 'translateY(0)';
            });
        }, 2000); // 2秒后强制显示所有隐藏元素
    });

    (function initTheme() {
        const savedTheme = localStorage.getItem("preferred-theme");
        if (savedTheme) {
            const theme1Link = document.querySelector('link[href*="theme1"]');
            const theme2Link = document.querySelector('link[href*="theme2"]');
            if (theme1Link && theme2Link) {
                if (savedTheme === "theme1") {
                    theme1Link.removeAttribute("disabled");
                    theme2Link.setAttribute("disabled", "true");
                } else {
                    theme2Link.removeAttribute("disabled");
                    theme1Link.setAttribute("disabled", "true");
                }
            }
        }
    })();

    function switchTheme() {
        // 获取当前和目标主题信息
        const currentTheme =
            localStorage.getItem("preferred-theme") || "theme1";
        const newTheme = currentTheme === "theme1" ? "theme2" : "theme1";
        const targetThemeText = newTheme === "theme1" ? "新版主题" : "原生主题";

        // 获取主题样式链接
        const theme1Link = document.querySelector('link[href*="theme1"]');
        const theme2Link = document.querySelector('link[href*="theme2"]');

        if (!theme1Link || !theme2Link) {
            console.error("无法找到主题样式链接");
            return;
        }

        // 创建和添加过渡覆盖层
        const overlay = document.createElement("div");
        overlay.className = "theme-transition-overlay";
        overlay.innerHTML = `
        <div class="theme-transition-content">
            <div class="theme-transition-spinner"></div>
            <div class="theme-transition-text">正在切换到：${targetThemeText}</div>
        </div>
    `;
        document.body.appendChild(overlay);

        // 确保DOM已更新后再添加active类
        requestAnimationFrame(() => {
            // 激活蒙版
            overlay.classList.add("active");

            // 添加适当的延迟以确保蒙版已完全显示
            setTimeout(() => {
                // 切换主题样式
                if (newTheme === "theme1") {
                    theme1Link.removeAttribute("disabled");
                    theme2Link.setAttribute("disabled", "true");
                } else {
                    theme2Link.removeAttribute("disabled");
                    theme1Link.setAttribute("disabled", "true");
                }

                // 保存主题设置
                localStorage.setItem("preferred-theme", newTheme);

                // 更新切换按钮文本
                updateThemeSwitchButton(newTheme);

                // 给予足够的时间加载主题
                setTimeout(() => {
                    // 平滑淡出效果
                    fadeOutOverlay(overlay);
                }, 2500); // 主题加载时间
            }, 250); // 蒙版显示时间
        });
    }

    // 更新主题切换按钮文本
    function updateThemeSwitchButton(theme) {
        const themeBtn = document.querySelector(".theme-btn");
        if (themeBtn) {
            const currentThemeEl = themeBtn.querySelector(".current-theme");
            const targetThemeEl = themeBtn.querySelector(".target-theme");

            if (currentThemeEl && targetThemeEl) {
                currentThemeEl.textContent =
                    theme === "theme1" ? "当前：新版主题" : "当前：原生主题";
                targetThemeEl.textContent =
                    theme === "theme1"
                        ? "切换到：原生主题"
                        : "切换到：新版主题";
            }
        }
    }

    // 平滑淡出蒙版
    function fadeOutOverlay(overlay) {
        // 先改变背景色，制造渐变效果
        overlay.style.backgroundColor = "rgba(255, 255, 255, 0.85)";

        // 短暂延迟后淡出
        setTimeout(() => {
            overlay.classList.remove("active");

            // 等待淡出动画完成后移除元素
            setTimeout(() => {
                document.body.removeChild(overlay);
            }, 300);
        }, 150);
    }
</script> <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../assets/javascripts/glightbox.min.js"></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=teal> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#_1 class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../../index.html title=柯懒的知识库 class="md-header__button md-logo" aria-label=柯懒的知识库 data-md-component=logo> <img src=../../../assets/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> 柯懒的知识库 </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> 基础模块设计 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=teal aria-hidden=true type=radio name=__palette id=__palette_0> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=查找> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../index.html class=md-tabs__link> 主页 </a> </li> <li class=md-tabs__item> <a href=../../../%E7%BD%91%E7%AB%99%E6%97%B6%E9%97%B4%E7%BA%BF/%E7%BD%91%E7%AB%99%E6%97%B6%E9%97%B4%E7%BA%BF.html class=md-tabs__link> 网站时间线 </a> </li> <li class=md-tabs__item> <a href=../../../C%E8%AF%AD%E8%A8%80/index.html class=md-tabs__link> 编程语言 </a> </li> <li class=md-tabs__item> <a href=../../../%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/1.%20%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6%E5%92%8C%E7%A9%BA%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6/1.%20%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6%E4%B8%8E%E7%A9%BA%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6.html class=md-tabs__link> 数据结构与算法 </a> </li> <li class=md-tabs__item> <a href=../../../Linux/1.%20Linux%E5%B8%B8%E7%94%A8%E9%80%89%E9%A1%B9%E5%92%8C%E6%8C%87%E4%BB%A4/1.%20Linux%E5%B8%B8%E7%94%A8%E9%80%89%E9%A1%B9%E5%92%8C%E6%8C%87%E4%BB%A4.html class=md-tabs__link> Linux </a> </li> <li class=md-tabs__item> <a href=../../../HTML%E4%B8%8ECSS/HTML%E7%AC%94%E8%AE%B0/HTML%E7%AC%94%E8%AE%B0.html class=md-tabs__link> 前端 </a> </li> <li class=md-tabs__item> <a href=../../../MySQL/MySQL%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/MySQL%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8.html class=md-tabs__link> MySQL </a> </li> <li class=md-tabs__item> <a href=../../../%E5%85%B6%E5%AE%83/Shell%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80/%E5%85%B3%E4%BA%8EShell.html class=md-tabs__link> 扩展知识 </a> </li> <li class=md-tabs__item> <a href=../../../%E5%B7%A5%E5%85%B7%E5%B8%AE%E5%8A%A9/vscode%E4%B8%AD%E6%B7%BB%E5%8A%A0%E4%BB%A3%E7%A0%81%E7%89%87%E6%AE%B5/vscode%E4%B8%AD%E6%B7%BB%E5%8A%A0%E4%BB%A3%E7%A0%81%E7%89%87%E6%AE%B5.html class=md-tabs__link> 工具帮助 </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../1.%20Boost%E5%BA%93%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/1.%20Boost%E5%BA%93%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E.html class=md-tabs__link> 项目 </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../index.html title=柯懒的知识库 class="md-nav__button md-logo" aria-label=柯懒的知识库 data-md-component=logo> <img src=../../../assets/logo.png alt=logo> </a> 柯懒的知识库 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../index.html class=md-nav__link> <span class=md-ellipsis> 主页 </span> </a> </li> <li class=md-nav__item> <a href=../../../%E7%BD%91%E7%AB%99%E6%97%B6%E9%97%B4%E7%BA%BF/%E7%BD%91%E7%AB%99%E6%97%B6%E9%97%B4%E7%BA%BF.html class=md-nav__link> <span class=md-ellipsis> 网站时间线 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../C%E8%AF%AD%E8%A8%80/index.html class=md-nav__link> <span class=md-ellipsis> 编程语言 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/1.%20%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6%E5%92%8C%E7%A9%BA%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6/1.%20%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6%E4%B8%8E%E7%A9%BA%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6.html class=md-nav__link> <span class=md-ellipsis> 数据结构与算法 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../Linux/1.%20Linux%E5%B8%B8%E7%94%A8%E9%80%89%E9%A1%B9%E5%92%8C%E6%8C%87%E4%BB%A4/1.%20Linux%E5%B8%B8%E7%94%A8%E9%80%89%E9%A1%B9%E5%92%8C%E6%8C%87%E4%BB%A4.html class=md-nav__link> <span class=md-ellipsis> Linux </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../HTML%E4%B8%8ECSS/HTML%E7%AC%94%E8%AE%B0/HTML%E7%AC%94%E8%AE%B0.html class=md-nav__link> <span class=md-ellipsis> 前端 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../MySQL/MySQL%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/MySQL%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8.html class=md-nav__link> <span class=md-ellipsis> MySQL </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../%E5%85%B6%E5%AE%83/Shell%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80/%E5%85%B3%E4%BA%8EShell.html class=md-nav__link> <span class=md-ellipsis> 扩展知识 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../%E5%B7%A5%E5%85%B7%E5%B8%AE%E5%8A%A9/vscode%E4%B8%AD%E6%B7%BB%E5%8A%A0%E4%BB%A3%E7%A0%81%E7%89%87%E6%AE%B5/vscode%E4%B8%AD%E6%B7%BB%E5%8A%A0%E4%BB%A3%E7%A0%81%E7%89%87%E6%AE%B5.html class=md-nav__link> <span class=md-ellipsis> 工具帮助 </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_10 checked> <label class=md-nav__link for=__nav_10 id=__nav_10_label tabindex> <span class=md-ellipsis> 项目 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_10_label aria-expanded=true> <label class=md-nav__title for=__nav_10> <span class="md-nav__icon md-icon"></span> 项目 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../1.%20Boost%E5%BA%93%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/1.%20Boost%E5%BA%93%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E.html class=md-nav__link> <span class=md-ellipsis> Boost库搜索引擎 </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_10_2 checked> <label class=md-nav__link for=__nav_10_2 id=__nav_10_2_label tabindex=0> <span class=md-ellipsis> 基于JSON的RPC框架 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_10_2_label aria-expanded=true> <label class=md-nav__title for=__nav_10_2> <span class="md-nav__icon md-icon"></span> 基于JSON的RPC框架 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../1.%20%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D%E4%B8%8E%E5%87%86%E5%A4%87/1.%20%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D%E4%B8%8E%E5%87%86%E5%A4%87.html class=md-nav__link> <span class=md-ellipsis> 项目介绍与准备 </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> 基础模块设计 </span> <span class="md-nav__icon md-icon"></span> </label> <a href=2.%20%E5%9F%BA%E7%A1%80%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1.html class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> 基础模块设计 </span> </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 工具模块设计 </span> </a> <nav class=md-nav aria-label=工具模块设计> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 日志模块 </span> </a> </li> <li class=md-nav__item> <a href=#json class=md-nav__link> <span class=md-ellipsis> JSON序列化和反序列化封装 </span> </a> </li> <li class=md-nav__item> <a href=#uuid class=md-nav__link> <span class=md-ellipsis> UUID生成封装 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 枚举字段和宏定义 </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 基类设计 </span> </a> <nav class=md-nav aria-label=基类设计> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> 设计思想及抽象类介绍 </span> </a> </li> <li class=md-nav__item> <a href=#buffer class=md-nav__link> <span class=md-ellipsis> Buffer基类设计 </span> </a> </li> <li class=md-nav__item> <a href=#message class=md-nav__link> <span class=md-ellipsis> Message基类设计 </span> </a> </li> <li class=md-nav__item> <a href=#connection class=md-nav__link> <span class=md-ellipsis> Connection基类设计 </span> </a> </li> <li class=md-nav__item> <a href=#protocol class=md-nav__link> <span class=md-ellipsis> Protocol基类设计 </span> </a> </li> <li class=md-nav__item> <a href=#client class=md-nav__link> <span class=md-ellipsis> Client基类设计 </span> </a> </li> <li class=md-nav__item> <a href=#server class=md-nav__link> <span class=md-ellipsis> Server基类设计 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 派生类设计 </span> </a> <nav class=md-nav aria-label=派生类设计> <ul class=md-nav__list> <li class=md-nav__item> <a href=#buffer_1 class=md-nav__link> <span class=md-ellipsis> Buffer派生类设计 </span> </a> </li> <li class=md-nav__item> <a href=#message_1 class=md-nav__link> <span class=md-ellipsis> Message派生类设计 </span> </a> <nav class=md-nav aria-label=Message派生类设计> <ul class=md-nav__list> <li class=md-nav__item> <a href=#basemessagejsonmessage class=md-nav__link> <span class=md-ellipsis> 基于BaseMessage的JsonMessage子类设计 </span> </a> </li> <li class=md-nav__item> <a href=#jsonmessagejsonrequestjsonresponse class=md-nav__link> <span class=md-ellipsis> 基于JsonMessage的JsonRequest和JsonResponse子类设计 </span> </a> </li> <li class=md-nav__item> <a href=#jsonrequestrpcrequest class=md-nav__link> <span class=md-ellipsis> 基于JsonRequest的RpcRequest子类设计 </span> </a> </li> <li class=md-nav__item> <a href=#jsonrequesttopicrequest class=md-nav__link> <span class=md-ellipsis> 基于JsonRequest的TopicRequest子类设计 </span> </a> </li> <li class=md-nav__item> <a href=#jsonrequestservicerequest class=md-nav__link> <span class=md-ellipsis> 基于JsonRequest的ServiceRequest子类设计 </span> </a> </li> <li class=md-nav__item> <a href=#jsonresponserpcresponse class=md-nav__link> <span class=md-ellipsis> 基于JsonResponse的RpcResponse子类设计 </span> </a> </li> <li class=md-nav__item> <a href=#jsonresponsetopicresponse class=md-nav__link> <span class=md-ellipsis> 基于JsonResponse的TopicResponse子类设计 </span> </a> </li> <li class=md-nav__item> <a href=#jsonresponseserviceresponse class=md-nav__link> <span class=md-ellipsis> 基于JsonResponse的ServiceResponse子类设计 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#protocol_1 class=md-nav__link> <span class=md-ellipsis> Protocol派生类设计 </span> </a> </li> <li class=md-nav__item> <a href=#connection_1 class=md-nav__link> <span class=md-ellipsis> Connection派生类设计 </span> </a> </li> <li class=md-nav__item> <a href=#client_1 class=md-nav__link> <span class=md-ellipsis> Client派生类设计 </span> </a> </li> <li class=md-nav__item> <a href=#server_1 class=md-nav__link> <span class=md-ellipsis> Server派生类设计 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> 消息分发模块设计 </span> </a> <nav class=md-nav aria-label=消息分发模块设计> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_9 class=md-nav__link> <span class=md-ellipsis> 基础版本 </span> </a> </li> <li class=md-nav__item> <a href=#message_2 class=md-nav__link> <span class=md-ellipsis> 优化版本（回调函数的第二个参数支持Message类派生类对象） </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../3.%20%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1%EF%BC%88RPC%E3%80%81%E6%B3%A8%E5%86%8C%EF%BC%89/3.%20%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1%EF%BC%88RPC%E3%80%81%E6%B3%A8%E5%86%8C%EF%BC%89.html class=md-nav__link> <span class=md-ellipsis> 功能模块设计（RPC、注册） </span> </a> </li> <li class=md-nav__item> <a href=../5.%20%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1%EF%BC%88%E4%B8%BB%E9%A2%98%E3%80%81%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%B0%81%E8%A3%85%E3%80%81%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%B0%81%E8%A3%85%EF%BC%89/5.%20%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1%EF%BC%88%E4%B8%BB%E9%A2%98%E3%80%81%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%B0%81%E8%A3%85%E3%80%81%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%B0%81%E8%A3%85%EF%BC%89.html class=md-nav__link> <span class=md-ellipsis> 功能模块设计（主题、客户端封装、服务端封装） </span> </a> </li> <li class=md-nav__item> <a href=../4.%20%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95/4.%20%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95.html class=md-nav__link> <span class=md-ellipsis> 功能测试 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 工具模块设计 </span> </a> <nav class=md-nav aria-label=工具模块设计> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 日志模块 </span> </a> </li> <li class=md-nav__item> <a href=#json class=md-nav__link> <span class=md-ellipsis> JSON序列化和反序列化封装 </span> </a> </li> <li class=md-nav__item> <a href=#uuid class=md-nav__link> <span class=md-ellipsis> UUID生成封装 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 枚举字段和宏定义 </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 基类设计 </span> </a> <nav class=md-nav aria-label=基类设计> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> 设计思想及抽象类介绍 </span> </a> </li> <li class=md-nav__item> <a href=#buffer class=md-nav__link> <span class=md-ellipsis> Buffer基类设计 </span> </a> </li> <li class=md-nav__item> <a href=#message class=md-nav__link> <span class=md-ellipsis> Message基类设计 </span> </a> </li> <li class=md-nav__item> <a href=#connection class=md-nav__link> <span class=md-ellipsis> Connection基类设计 </span> </a> </li> <li class=md-nav__item> <a href=#protocol class=md-nav__link> <span class=md-ellipsis> Protocol基类设计 </span> </a> </li> <li class=md-nav__item> <a href=#client class=md-nav__link> <span class=md-ellipsis> Client基类设计 </span> </a> </li> <li class=md-nav__item> <a href=#server class=md-nav__link> <span class=md-ellipsis> Server基类设计 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 派生类设计 </span> </a> <nav class=md-nav aria-label=派生类设计> <ul class=md-nav__list> <li class=md-nav__item> <a href=#buffer_1 class=md-nav__link> <span class=md-ellipsis> Buffer派生类设计 </span> </a> </li> <li class=md-nav__item> <a href=#message_1 class=md-nav__link> <span class=md-ellipsis> Message派生类设计 </span> </a> <nav class=md-nav aria-label=Message派生类设计> <ul class=md-nav__list> <li class=md-nav__item> <a href=#basemessagejsonmessage class=md-nav__link> <span class=md-ellipsis> 基于BaseMessage的JsonMessage子类设计 </span> </a> </li> <li class=md-nav__item> <a href=#jsonmessagejsonrequestjsonresponse class=md-nav__link> <span class=md-ellipsis> 基于JsonMessage的JsonRequest和JsonResponse子类设计 </span> </a> </li> <li class=md-nav__item> <a href=#jsonrequestrpcrequest class=md-nav__link> <span class=md-ellipsis> 基于JsonRequest的RpcRequest子类设计 </span> </a> </li> <li class=md-nav__item> <a href=#jsonrequesttopicrequest class=md-nav__link> <span class=md-ellipsis> 基于JsonRequest的TopicRequest子类设计 </span> </a> </li> <li class=md-nav__item> <a href=#jsonrequestservicerequest class=md-nav__link> <span class=md-ellipsis> 基于JsonRequest的ServiceRequest子类设计 </span> </a> </li> <li class=md-nav__item> <a href=#jsonresponserpcresponse class=md-nav__link> <span class=md-ellipsis> 基于JsonResponse的RpcResponse子类设计 </span> </a> </li> <li class=md-nav__item> <a href=#jsonresponsetopicresponse class=md-nav__link> <span class=md-ellipsis> 基于JsonResponse的TopicResponse子类设计 </span> </a> </li> <li class=md-nav__item> <a href=#jsonresponseserviceresponse class=md-nav__link> <span class=md-ellipsis> 基于JsonResponse的ServiceResponse子类设计 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#protocol_1 class=md-nav__link> <span class=md-ellipsis> Protocol派生类设计 </span> </a> </li> <li class=md-nav__item> <a href=#connection_1 class=md-nav__link> <span class=md-ellipsis> Connection派生类设计 </span> </a> </li> <li class=md-nav__item> <a href=#client_1 class=md-nav__link> <span class=md-ellipsis> Client派生类设计 </span> </a> </li> <li class=md-nav__item> <a href=#server_1 class=md-nav__link> <span class=md-ellipsis> Server派生类设计 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> 消息分发模块设计 </span> </a> <nav class=md-nav aria-label=消息分发模块设计> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_9 class=md-nav__link> <span class=md-ellipsis> 基础版本 </span> </a> </li> <li class=md-nav__item> <a href=#message_2 class=md-nav__link> <span class=md-ellipsis> 优化版本（回调函数的第二个参数支持Message类派生类对象） </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=_1>基础模块设计<a class=headerlink href=#_1 title="Permanent link">&para;</a></h1> <div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;"> <p><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"/></svg></span> 约 8085 个字 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3"/></svg></span> 1492 行代码 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"/></svg></span> 预计阅读时间 46 分钟</p> </div> <h2 id=_2>工具模块设计<a class=headerlink href=#_2 title="Permanent link">&para;</a></h2> <h3 id=_3>日志模块<a class=headerlink href=#_3 title="Permanent link">&para;</a></h3> <p>本次项目中使用到spdlog作为日志信息底层模块，但是直接使用spdlog会比较麻烦，所以考虑对spdlog进行封装，基本思路可以参考前面的<a href=https://www.help-doc.top/Linux/19.%20Linux%E7%BA%BF%E7%A8%8B/6.%20%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/6.%20%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F.html>Linux日志系统</a></p> <p>本次封装后，使用者可以按照如下方式使用：</p> <ol> <li>自主决定日志等级</li> <li>选择文件输出或者控制台输出</li> <li>使用<a href=https://www.help-doc.top/C%2B%2B/36.%20C%2B%2B%E4%B8%AD%E7%9A%84%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/36.%20C%2B%2B%E4%B8%AD%E7%9A%84%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2.html>C++格式化字符串</a>控制日志内容</li> </ol> <p>根据上面的需求，首先需要三个函数：</p> <ol> <li>切换日志等级</li> <li>启用文件输出</li> <li>启用控制台输出</li> </ol> <p>设计如下：</p> <div class="tabbed-set tabbed-alternate" data-tabs=1:3><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><input id=__tabbed_1_2 name=__tabbed_1 type=radio><input id=__tabbed_1_3 name=__tabbed_1 type=radio><div class=tabbed-labels><label for=__tabbed_1_1>切换日志等级</label><label for=__tabbed_1_2>启用文件输出</label><label for=__tabbed_1_3>启用控制台输出</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-1><span class=c1>// 日志等级，与spdlog等级对应</span>
</span><span id=__span-0-2><span class=k>enum</span><span class=w> </span><span class=k>class</span><span class=w> </span><span class=nc>Level</span>
</span><span id=__span-0-3><span class=p>{</span>
</span><span id=__span-0-4><span class=w>    </span><span class=n>Debug</span><span class=p>,</span>
</span><span id=__span-0-5><span class=w>    </span><span class=n>Info</span><span class=p>,</span>
</span><span id=__span-0-6><span class=w>    </span><span class=n>Warning</span><span class=p>,</span>
</span><span id=__span-0-7><span class=w>    </span><span class=n>Error</span><span class=p>,</span>
</span><span id=__span-0-8><span class=w>    </span><span class=n>Critical</span>
</span><span id=__span-0-9><span class=p>};</span>
</span><span id=__span-0-10>
</span><span id=__span-0-11><span class=c1>// ...</span>
</span><span id=__span-0-12>
</span><span id=__span-0-13><span class=c1>// 设置日志等级</span>
</span><span id=__span-0-14><span class=kt>void</span><span class=w> </span><span class=nf>setLevel</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>Level</span><span class=w> </span><span class=n>l</span><span class=p>)</span>
</span><span id=__span-0-15><span class=p>{</span>
</span><span id=__span-0-16><span class=w>    </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>l</span><span class=p>)</span>
</span><span id=__span-0-17><span class=w>    </span><span class=p>{</span>
</span><span id=__span-0-18><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=no>Level</span><span class=o>::</span><span class=no>Debug</span><span class=p>:</span>
</span><span id=__span-0-19><span class=w>        </span><span class=n>spdlog</span><span class=o>::</span><span class=n>set_level</span><span class=p>(</span><span class=n>spdlog</span><span class=o>::</span><span class=n>level</span><span class=o>::</span><span class=n>debug</span><span class=p>);</span>
</span><span id=__span-0-20><span class=w>        </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-0-21><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=no>Level</span><span class=o>::</span><span class=no>Info</span><span class=p>:</span>
</span><span id=__span-0-22><span class=w>        </span><span class=n>spdlog</span><span class=o>::</span><span class=n>set_level</span><span class=p>(</span><span class=n>spdlog</span><span class=o>::</span><span class=n>level</span><span class=o>::</span><span class=n>info</span><span class=p>);</span>
</span><span id=__span-0-23><span class=w>        </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-0-24><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=no>Level</span><span class=o>::</span><span class=no>Warning</span><span class=p>:</span>
</span><span id=__span-0-25><span class=w>        </span><span class=n>spdlog</span><span class=o>::</span><span class=n>set_level</span><span class=p>(</span><span class=n>spdlog</span><span class=o>::</span><span class=n>level</span><span class=o>::</span><span class=n>warn</span><span class=p>);</span>
</span><span id=__span-0-26><span class=w>        </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-0-27><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=no>Level</span><span class=o>::</span><span class=no>Error</span><span class=p>:</span>
</span><span id=__span-0-28><span class=w>        </span><span class=n>spdlog</span><span class=o>::</span><span class=n>set_level</span><span class=p>(</span><span class=n>spdlog</span><span class=o>::</span><span class=n>level</span><span class=o>::</span><span class=n>err</span><span class=p>);</span>
</span><span id=__span-0-29><span class=w>        </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-0-30><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=no>Level</span><span class=o>::</span><span class=no>Critical</span><span class=p>:</span>
</span><span id=__span-0-31><span class=w>        </span><span class=n>spdlog</span><span class=o>::</span><span class=n>set_level</span><span class=p>(</span><span class=n>spdlog</span><span class=o>::</span><span class=n>level</span><span class=o>::</span><span class=n>critical</span><span class=p>);</span>
</span><span id=__span-0-32><span class=w>        </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-0-33><span class=w>    </span><span class=k>default</span><span class=o>:</span>
</span><span id=__span-0-34><span class=w>        </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-0-35><span class=w>    </span><span class=p>}</span>
</span><span id=__span-0-36><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-1-1><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>filepath</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;log/log.txt&quot;</span><span class=p>;</span>
</span><span id=__span-1-2>
</span><span id=__span-1-3><span class=c1>// 启用文件输出</span>
</span><span id=__span-1-4><span class=kt>void</span><span class=w> </span><span class=nf>enableFileLog</span><span class=p>()</span>
</span><span id=__span-1-5><span class=p>{</span>
</span><span id=__span-1-6><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock</span><span class=p>(</span><span class=n>mode_mtx_</span><span class=p>);</span>
</span><span id=__span-1-7><span class=w>    </span><span class=n>spdlog</span><span class=o>::</span><span class=n>drop_all</span><span class=p>();</span><span class=w> </span><span class=c1>// 清除上一次的指针</span>
</span><span id=__span-1-8><span class=w>    </span><span class=n>logger_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>spdlog</span><span class=o>::</span><span class=n>basic_logger_mt</span><span class=p>(</span><span class=s>&quot;file_log&quot;</span><span class=p>,</span><span class=w> </span><span class=n>filepath</span><span class=p>);</span>
</span><span id=__span-1-9><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-2-1><span class=c1>// 启用控制台输出</span>
</span><span id=__span-2-2><span class=kt>void</span><span class=w> </span><span class=nf>enableConsoleLog</span><span class=p>()</span>
</span><span id=__span-2-3><span class=p>{</span>
</span><span id=__span-2-4><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock</span><span class=p>(</span><span class=n>mode_mtx_</span><span class=p>);</span>
</span><span id=__span-2-5><span class=w>    </span><span class=n>spdlog</span><span class=o>::</span><span class=n>drop_all</span><span class=p>();</span><span class=w> </span><span class=c1>// 清除上一次的指针</span>
</span><span id=__span-2-6><span class=w>    </span><span class=n>logger_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>spdlog</span><span class=o>::</span><span class=n>stdout_color_mt</span><span class=p>(</span><span class=s>&quot;console_log&quot;</span><span class=p>);</span>
</span><span id=__span-2-7><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>在日志模块对象创建时，默认启用控制台输出，并且设置日志等级为<code>debug</code>，格式为<code>[年-月-日 时:分:秒] [日志等级] [文件名:行号] 日志内容</code>，所以设计日志模块的构造函数如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-3-1><span class=n>LogSystem</span><span class=p>()</span>
</span><span id=__span-3-2><span class=p>{</span>
</span><span id=__span-3-3><span class=w>    </span><span class=c1>// 默认等级</span>
</span><span id=__span-3-4><span class=w>    </span><span class=n>spdlog</span><span class=o>::</span><span class=n>set_level</span><span class=p>(</span><span class=n>spdlog</span><span class=o>::</span><span class=n>level</span><span class=o>::</span><span class=n>debug</span><span class=p>);</span>
</span><span id=__span-3-5><span class=w>    </span><span class=c1>// 默认格式</span>
</span><span id=__span-3-6><span class=w>    </span><span class=n>spdlog</span><span class=o>::</span><span class=n>set_pattern</span><span class=p>(</span><span class=s>&quot;[%Y-%m-%d %H:%M:%S] [%^%l%$] %v&quot;</span><span class=p>);</span>
</span><span id=__span-3-7><span class=w>    </span><span class=c1>// 默认控制台打印</span>
</span><span id=__span-3-8><span class=w>    </span><span class=n>logger_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>spdlog</span><span class=o>::</span><span class=n>stdout_color_mt</span><span class=p>(</span><span class=s>&quot;console_log&quot;</span><span class=p>);</span>
</span><span id=__span-3-9><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>因为日志输出从程序运行到结束都只需要使用一个对象，所以本次考虑使用单例模式，设计如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-4-1><span class=k>class</span><span class=w> </span><span class=nc>LogSystem</span>
</span><span id=__span-4-2><span class=p>{</span>
</span><span id=__span-4-3><span class=k>private</span><span class=o>:</span>
</span><span id=__span-4-4><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-4-5>
</span><span id=__span-4-6><span class=w>    </span><span class=c1>// 禁用拷贝构造和赋值</span>
</span><span id=__span-4-7><span class=w>    </span><span class=n>LogSystem</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>LogSystem</span><span class=w> </span><span class=o>&amp;</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>delete</span><span class=p>;</span>
</span><span id=__span-4-8><span class=w>    </span><span class=n>LogSystem</span><span class=w> </span><span class=o>&amp;</span><span class=k>operator</span><span class=o>=</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>LogSystem</span><span class=w> </span><span class=o>&amp;</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>delete</span><span class=p>;</span>
</span><span id=__span-4-9>
</span><span id=__span-4-10><span class=k>public</span><span class=o>:</span>
</span><span id=__span-4-11><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>LogSystem</span><span class=o>&gt;</span><span class=w> </span><span class=n>getInstance</span><span class=p>()</span>
</span><span id=__span-4-12><span class=w>    </span><span class=p>{</span>
</span><span id=__span-4-13><span class=w>        </span><span class=k>static</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>once_flag</span><span class=w> </span><span class=n>init_flag</span><span class=p>;</span>
</span><span id=__span-4-14><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>call_once</span><span class=p>(</span><span class=n>init_flag</span><span class=p>,</span><span class=w> </span><span class=p>[]</span>
</span><span id=__span-4-15><span class=w>                        </span><span class=p>{</span><span class=w> </span><span class=n>baseLog_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>LogSystem</span><span class=o>&gt;</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>LogSystem</span><span class=p>());</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-4-16>
</span><span id=__span-4-17><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>baseLog_</span><span class=p>;</span>
</span><span id=__span-4-18><span class=w>    </span><span class=p>}</span>
</span><span id=__span-4-19>
</span><span id=__span-4-20><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-4-21>
</span><span id=__span-4-22><span class=k>private</span><span class=o>:</span>
</span><span id=__span-4-23><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>LogSystem</span><span class=o>&gt;</span><span class=w> </span><span class=n>baseLog_</span><span class=p>;</span>
</span><span id=__span-4-24><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-4-25><span class=p>};</span>
</span><span id=__span-4-26>
</span><span id=__span-4-27><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>LogSystem</span><span class=o>&gt;</span><span class=w> </span><span class=n>LogSystem</span><span class=o>::</span><span class=n>baseLog_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>nullptr</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> <p>接着，提供一个获取到<code>spdlog::logger</code>的函数，便于上层可以调用spdlog的日志输出函数：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-5-1><span class=c1>// 获取日志指针</span>
</span><span id=__span-5-2><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>spdlog</span><span class=o>::</span><span class=n>logger</span><span class=o>&gt;</span><span class=w> </span><span class=n>getLogger</span><span class=p>()</span>
</span><span id=__span-5-3><span class=p>{</span>
</span><span id=__span-5-4><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>logger_</span><span class=p>;</span>
</span><span id=__span-5-5><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>为了便于上层使用，下面提供一些宏定义：</p> <ol> <li>更改输出位置</li> <li>通用日志宏</li> </ol> <p>首先是更改输出位置，只需要创建一个日志模块对象，然后调用对应的函数即可：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-6-1><span class=c1>// 获取日志系统类对象</span>
</span><span id=__span-6-2><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>LogSystem</span><span class=o>&gt;</span><span class=w> </span><span class=n>ls</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LogSystem</span><span class=o>::</span><span class=n>getInstance</span><span class=p>();</span>
</span><span id=__span-6-3>
</span><span id=__span-6-4><span class=cp>#define ENABLE_FILE_LOG() ls-&gt;enableFileLog()</span>
</span><span id=__span-6-5><span class=cp>#define ENABLE_CONSOLE_LOG() ls-&gt;enableConsoleLog()</span>
</span></code></pre></div></td></tr></table></div> <p>对于通用日志宏来说，首先需要针对每一个日志等级提供一个对应的宏：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-7-1><span class=c1>// 日志宏定义，带有文件名和行号</span>
</span><span id=__span-7-2><span class=c1>// ##运算符的主要作用是处理没有提供可变参数时的逗号问题</span>
</span><span id=__span-7-3><span class=cp>#define LOG_DEBUG(format, ...) \</span>
</span><span id=__span-7-4><span class=cp>    ls-&gt;getLogger()-&gt;debug(&quot;[{}:{}] &quot; format, __FILE__, __LINE__, ##__VA_ARGS__)</span>
</span><span id=__span-7-5>
</span><span id=__span-7-6><span class=cp>#define LOG_INFO(format, ...) \</span>
</span><span id=__span-7-7><span class=cp>    ls-&gt;getLogger()-&gt;info(&quot;[{}:{}] &quot; format, __FILE__, __LINE__, ##__VA_ARGS__)</span>
</span><span id=__span-7-8>
</span><span id=__span-7-9><span class=cp>#define LOG_WARN(format, ...) \</span>
</span><span id=__span-7-10><span class=cp>    ls-&gt;getLogger()-&gt;warn(&quot;[{}:{}] &quot; format, __FILE__, __LINE__, ##__VA_ARGS__)</span>
</span><span id=__span-7-11>
</span><span id=__span-7-12><span class=cp>#define LOG_ERROR(format, ...) \</span>
</span><span id=__span-7-13><span class=cp>    ls-&gt;getLogger()-&gt;error(&quot;[{}:{}] &quot; format, __FILE__, __LINE__, ##__VA_ARGS__)</span>
</span><span id=__span-7-14>
</span><span id=__span-7-15><span class=cp>#define LOG_CRITICAL(format, ...) \</span>
</span><span id=__span-7-16><span class=cp>    ls-&gt;getLogger()-&gt;critical(&quot;[{}:{}] &quot; format, __FILE__, __LINE__, ##__VA_ARGS__)</span>
</span></code></pre></div></td></tr></table></div> <p>关于宏中的不定参数，可以参考<a href=https://www.help-doc.top/%E5%85%B6%E5%AE%83/%E5%85%B3%E4%BA%8EC%2B%2B%E6%97%A5%E5%BF%97%E5%BA%93spdlog/%E5%85%B3%E4%BA%8EC%2B%2B%E6%97%A5%E5%BF%97%E5%BA%93spdlog.html#_21>关于C++日志库spdlog</a></p> <p>接着，提供一个通用宏，接收用户传递的日志等级和日志内容，再根据日志等级调用对应的日志宏：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-8-1><span class=c1>// 通用日志宏，可以指定日志级别</span>
</span><span id=__span-8-2><span class=cp>#define LOG(level, format, ...)              \</span>
</span><span id=__span-8-3><span class=cp>    switch (level)                           \</span>
</span><span id=__span-8-4><span class=cp>    {                                        \</span>
</span><span id=__span-8-5><span class=cp>    case log_system::Level::Debug:           \</span>
</span><span id=__span-8-6><span class=cp>        LOG_DEBUG(format, ##__VA_ARGS__);    \</span>
</span><span id=__span-8-7><span class=cp>        break;                               \</span>
</span><span id=__span-8-8><span class=cp>    case log_system::Level::Info:            \</span>
</span><span id=__span-8-9><span class=cp>        LOG_INFO(format, ##__VA_ARGS__);     \</span>
</span><span id=__span-8-10><span class=cp>        break;                               \</span>
</span><span id=__span-8-11><span class=cp>    case log_system::Level::Warning:         \</span>
</span><span id=__span-8-12><span class=cp>        LOG_WARN(format, ##__VA_ARGS__);     \</span>
</span><span id=__span-8-13><span class=cp>        break;                               \</span>
</span><span id=__span-8-14><span class=cp>    case log_system::Level::Error:           \</span>
</span><span id=__span-8-15><span class=cp>        LOG_ERROR(format, ##__VA_ARGS__);    \</span>
</span><span id=__span-8-16><span class=cp>        break;                               \</span>
</span><span id=__span-8-17><span class=cp>    case log_system::Level::Critical:        \</span>
</span><span id=__span-8-18><span class=cp>        LOG_CRITICAL(format, ##__VA_ARGS__); \</span>
</span><span id=__span-8-19><span class=cp>        break;                               \</span>
</span><span id=__span-8-20><span class=cp>    default:                                 \</span>
</span><span id=__span-8-21><span class=cp>        LOG_INFO(format, ##__VA_ARGS__);     \</span>
</span><span id=__span-8-22><span class=cp>        break;                               \</span>
</span><span id=__span-8-23><span class=cp>    }</span>
</span></code></pre></div></td></tr></table></div> <h3 id=json>JSON序列化和反序列化封装<a class=headerlink href=#json title="Permanent link">&para;</a></h3> <p>此处封装只是对JSON的函数操作封装，对应的JSON相关函数使用方式参考<a href=https://www.help-doc.top/%E5%85%B6%E5%AE%83/%E5%85%B3%E4%BA%8EJSONCPP%E5%BA%93/%E5%85%B3%E4%BA%8EJSONCPP%E5%BA%93.html>关于JSONCPP</a></p> <p>JSON工具类提供序列化和反序列化接口，这两个函数使用方式分别如下：</p> <ol> <li>接收一个JSON对象，将对象序列化为JSON字符串通过参数返回给上层（不是通过返回值）</li> <li>接收一个JSON字符串，将JSON字符串反序列化为对象通过参数返回给上层（不是通过返回值）</li> </ol> <div class="tabbed-set tabbed-alternate" data-tabs=2:2><input checked=checked id=__tabbed_2_1 name=__tabbed_2 type=radio><input id=__tabbed_2_2 name=__tabbed_2 type=radio><div class=tabbed-labels><label for=__tabbed_2_1>序列化</label><label for=__tabbed_2_2>反序列化</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-9-1><span class=c1>// JSON字符串转换为普通字符串，外部需要传递JSON字符串</span>
</span><span id=__span-9-2><span class=k>static</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=nf>serialize</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>Json</span><span class=o>::</span><span class=n>Value</span><span class=w> </span><span class=o>&amp;</span><span class=n>json_object</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>json_str</span><span class=p>)</span>
</span><span id=__span-9-3><span class=p>{</span>
</span><span id=__span-9-4><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>stringstream</span><span class=w> </span><span class=n>ss</span><span class=p>;</span><span class=w>          </span><span class=c1>// 先实例化⼀个⼯⼚类对象</span>
</span><span id=__span-9-5><span class=w>    </span><span class=n>Json</span><span class=o>::</span><span class=n>StreamWriterBuilder</span><span class=w> </span><span class=n>swb</span><span class=p>;</span><span class=w> </span><span class=c1>// 通过⼯⼚类对象来⽣产派⽣类对象</span>
</span><span id=__span-9-6><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>Json</span><span class=o>::</span><span class=n>StreamWriter</span><span class=o>&gt;</span><span class=w> </span><span class=n>sw</span><span class=p>(</span><span class=n>swb</span><span class=p>.</span><span class=n>newStreamWriter</span><span class=p>());</span>
</span><span id=__span-9-7><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sw</span><span class=o>-&gt;</span><span class=n>write</span><span class=p>(</span><span class=n>json_object</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>ss</span><span class=p>);</span>
</span><span id=__span-9-8><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-9-9><span class=w>    </span><span class=p>{</span>
</span><span id=__span-9-10><span class=w>        </span><span class=n>LOG</span><span class=p>(</span><span class=n>log_system</span><span class=o>::</span><span class=n>Level</span><span class=o>::</span><span class=n>Error</span><span class=p>,</span><span class=w> </span><span class=s>&quot;JSON序列化失败&quot;</span><span class=p>);</span>
</span><span id=__span-9-11><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-9-12><span class=w>    </span><span class=p>}</span>
</span><span id=__span-9-13><span class=w>    </span><span class=n>json_str</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ss</span><span class=p>.</span><span class=n>str</span><span class=p>();</span>
</span><span id=__span-9-14><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-9-15><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-10-1><span class=c1>// 普通字符串转换为JSON字符串，外部需要对JSON字符串进行处理</span>
</span><span id=__span-10-2><span class=k>static</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=nf>deserialize</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>json_str</span><span class=p>,</span><span class=w> </span><span class=n>Json</span><span class=o>::</span><span class=n>Value</span><span class=w> </span><span class=o>&amp;</span><span class=n>json_object</span><span class=p>)</span>
</span><span id=__span-10-3><span class=p>{</span>
</span><span id=__span-10-4><span class=w>    </span><span class=c1>// 实例化⼯⼚类对象</span>
</span><span id=__span-10-5><span class=w>    </span><span class=n>Json</span><span class=o>::</span><span class=n>CharReaderBuilder</span><span class=w> </span><span class=n>crb</span><span class=p>;</span>
</span><span id=__span-10-6><span class=w>    </span><span class=c1>// ⽣产CharReader对象</span>
</span><span id=__span-10-7><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>errs</span><span class=p>;</span>
</span><span id=__span-10-8><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>Json</span><span class=o>::</span><span class=n>CharReader</span><span class=o>&gt;</span><span class=w> </span><span class=n>cr</span><span class=p>(</span><span class=n>crb</span><span class=p>.</span><span class=n>newCharReader</span><span class=p>());</span>
</span><span id=__span-10-9><span class=w>    </span><span class=kt>bool</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cr</span><span class=o>-&gt;</span><span class=n>parse</span><span class=p>(</span><span class=n>json_str</span><span class=p>.</span><span class=n>c_str</span><span class=p>(),</span><span class=w> </span><span class=n>json_str</span><span class=p>.</span><span class=n>c_str</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>json_str</span><span class=p>.</span><span class=n>size</span><span class=p>(),</span><span class=w> </span><span class=o>&amp;</span><span class=n>json_object</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>errs</span><span class=p>);</span>
</span><span id=__span-10-10><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>false</span><span class=p>)</span>
</span><span id=__span-10-11><span class=w>    </span><span class=p>{</span>
</span><span id=__span-10-12><span class=w>        </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Error</span><span class=p>,</span><span class=w> </span><span class=s>&quot;JSON反序列化失败: {}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>errs</span><span class=p>);</span>
</span><span id=__span-10-13><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-10-14><span class=w>    </span><span class=p>}</span>
</span><span id=__span-10-15><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-10-16><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <h3 id=uuid>UUID生成封装<a class=headerlink href=#uuid title="Permanent link">&para;</a></h3> <p>在前面的应用层协议模块的介绍中提到请求/响应ID为UUID类型，为了在使用时方便，同样对UUID生成过程进行封装，本次考虑使用Boost库中的UUID生成器，封装如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-11-1><span class=k>static</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=nf>generate_uuid</span><span class=p>()</span>
</span><span id=__span-11-2><span class=p>{</span>
</span><span id=__span-11-3><span class=w>    </span><span class=c1>// 使用boost库生成uuid</span>
</span><span id=__span-11-4><span class=w>    </span><span class=c1>// 创建一个随机数生成器</span>
</span><span id=__span-11-5><span class=w>    </span><span class=n>boost</span><span class=o>::</span><span class=n>uuids</span><span class=o>::</span><span class=n>random_generator</span><span class=w> </span><span class=n>generator</span><span class=p>;</span>
</span><span id=__span-11-6>
</span><span id=__span-11-7><span class=w>    </span><span class=c1>// 生成一个随机 UUID</span>
</span><span id=__span-11-8><span class=w>    </span><span class=n>boost</span><span class=o>::</span><span class=n>uuids</span><span class=o>::</span><span class=n>uuid</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>generator</span><span class=p>();</span>
</span><span id=__span-11-9><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>boost</span><span class=o>::</span><span class=n>uuids</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>id</span><span class=p>);</span>
</span><span id=__span-11-10><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h2 id=_4>枚举字段和宏定义<a class=headerlink href=#_4 title="Permanent link">&para;</a></h2> <p>在项目中会经常使用到一些字段，为了简化上层使用和统一，针对下面的字段进行描述：</p> <ol> <li>用于JSON序列化和反序列化的字段</li> <li>应用层协议中的消息类型</li> <li>返回状态码</li> <li>消息发送模式</li> <li>主题操作类型</li> <li>服务操作类型</li> </ol> <p>分别设计如下：</p> <div class="tabbed-set tabbed-alternate" data-tabs=3:6><input checked=checked id=__tabbed_3_1 name=__tabbed_3 type=radio><input id=__tabbed_3_2 name=__tabbed_3 type=radio><input id=__tabbed_3_3 name=__tabbed_3 type=radio><input id=__tabbed_3_4 name=__tabbed_3 type=radio><input id=__tabbed_3_5 name=__tabbed_3 type=radio><input id=__tabbed_3_6 name=__tabbed_3 type=radio><div class=tabbed-labels><label for=__tabbed_3_1>用于JSON序列化和反序列化的字段</label><label for=__tabbed_3_2>应用层协议中的消息类型</label><label for=__tabbed_3_3>返回状态码</label><label for=__tabbed_3_4>消息发送模式</label><label for=__tabbed_3_5>主题操作类型</label><label for=__tabbed_3_6>服务操作类型</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-12-1><span class=c1>// 请求和响应中body需要的字段</span>
</span><span id=__span-12-2><span class=cp>#define KEY_METHOD &quot;method&quot;       </span><span class=c1>// 方法名</span>
</span><span id=__span-12-3><span class=cp>#define KEY_PARAMS &quot;parameters&quot;   </span><span class=c1>// 方法参数</span>
</span><span id=__span-12-4><span class=cp>#define KEY_TOPIC_KEY &quot;topic_key&quot; </span><span class=c1>// 主题名称</span>
</span><span id=__span-12-5><span class=cp>#define KEY_TOPIC_MSG &quot;topic_msg&quot; </span><span class=c1>// 主题信息</span>
</span><span id=__span-12-6><span class=cp>#define KEY_OPTYPE &quot;optype&quot;       </span><span class=c1>// 操作类型</span>
</span><span id=__span-12-7><span class=cp>#define KEY_HOST &quot;host&quot;           </span><span class=c1>// 端口</span>
</span><span id=__span-12-8><span class=cp>#define KEY_HOST_IP &quot;ip&quot;          </span><span class=c1>// IP地址</span>
</span><span id=__span-12-9><span class=cp>#define KEY_HOST_PORT &quot;port&quot;      </span><span class=c1>// 端口号</span>
</span><span id=__span-12-10><span class=cp>#define KEY_RCODE &quot;rcode&quot;         </span><span class=c1>// 返回状态码</span>
</span><span id=__span-12-11><span class=cp>#define KEY_RESULT &quot;result&quot;       </span><span class=c1>// 返回值</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-13-1><span class=c1>// 应用层协议中的消息类型</span>
</span><span id=__span-13-2><span class=k>enum</span><span class=w> </span><span class=k>class</span><span class=w> </span><span class=nc>MType</span>
</span><span id=__span-13-3><span class=p>{</span>
</span><span id=__span-13-4><span class=w>    </span><span class=n>Req_rpc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=c1>// RPC请求</span>
</span><span id=__span-13-5><span class=w>    </span><span class=n>Resp_rpc</span><span class=p>,</span><span class=w>    </span><span class=c1>// RPC响应</span>
</span><span id=__span-13-6><span class=w>    </span><span class=n>Req_topic</span><span class=p>,</span><span class=w>   </span><span class=c1>// 主题请求</span>
</span><span id=__span-13-7><span class=w>    </span><span class=n>Resp_topic</span><span class=p>,</span><span class=w>  </span><span class=c1>// 主题响应</span>
</span><span id=__span-13-8><span class=w>    </span><span class=n>Req_service</span><span class=p>,</span><span class=w> </span><span class=c1>// 服务请求</span>
</span><span id=__span-13-9><span class=w>    </span><span class=n>Resp_service</span><span class=w> </span><span class=c1>// 服务响应</span>
</span><span id=__span-13-10><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-14-1><span class=c1>// 返回状态码</span>
</span><span id=__span-14-2><span class=k>enum</span><span class=w> </span><span class=k>class</span><span class=w> </span><span class=nc>RCode</span>
</span><span id=__span-14-3><span class=p>{</span>
</span><span id=__span-14-4><span class=w>    </span><span class=n>RCode_fine</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w>          </span><span class=c1>// 正常</span>
</span><span id=__span-14-5><span class=w>    </span><span class=n>RCode_parse_failed</span><span class=p>,</span><span class=w>      </span><span class=c1>// 解析失败</span>
</span><span id=__span-14-6><span class=w>    </span><span class=n>RCode_wrong_msgType</span><span class=p>,</span><span class=w>     </span><span class=c1>// 错误的消息类型</span>
</span><span id=__span-14-7><span class=w>    </span><span class=n>RCode_invalid_msg</span><span class=p>,</span><span class=w>       </span><span class=c1>// 无效消息</span>
</span><span id=__span-14-8><span class=w>    </span><span class=n>RCode_disconneted</span><span class=p>,</span><span class=w>       </span><span class=c1>// 连接断开</span>
</span><span id=__span-14-9><span class=w>    </span><span class=n>RCode_invalid_params</span><span class=p>,</span><span class=w>    </span><span class=c1>// 错误参数</span>
</span><span id=__span-14-10><span class=w>    </span><span class=n>RCode_not_found_service</span><span class=p>,</span><span class=w> </span><span class=c1>// 未找到服务</span>
</span><span id=__span-14-11><span class=w>    </span><span class=n>RCode_invalid_opType</span><span class=p>,</span><span class=w>    </span><span class=c1>// 无效操作类型</span>
</span><span id=__span-14-12><span class=w>    </span><span class=n>RCode_not_found_topic</span><span class=p>,</span><span class=w>   </span><span class=c1>// 未找到主题</span>
</span><span id=__span-14-13><span class=w>    </span><span class=n>RCode_internal_error</span><span class=w>     </span><span class=c1>// 内部错误</span>
</span><span id=__span-14-14><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-15-1><span class=c1>// 消息发送模式</span>
</span><span id=__span-15-2><span class=k>enum</span><span class=w> </span><span class=k>class</span><span class=w> </span><span class=nc>RType</span>
</span><span id=__span-15-3><span class=p>{</span>
</span><span id=__span-15-4><span class=w>    </span><span class=n>Req_async</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=c1>// 异步模式</span>
</span><span id=__span-15-5><span class=w>    </span><span class=n>Req_callback</span><span class=w>   </span><span class=c1>// 回调模式</span>
</span><span id=__span-15-6><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-16-1><span class=c1>// 主题操作类型</span>
</span><span id=__span-16-2><span class=k>enum</span><span class=w> </span><span class=k>class</span><span class=w> </span><span class=nc>TopicOptype</span>
</span><span id=__span-16-3><span class=p>{</span>
</span><span id=__span-16-4><span class=w>    </span><span class=n>Topic_create</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=c1>// 主题创建</span>
</span><span id=__span-16-5><span class=w>    </span><span class=n>Topic_remove</span><span class=p>,</span><span class=w>     </span><span class=c1>// 主题移除</span>
</span><span id=__span-16-6><span class=w>    </span><span class=n>Topic_subscribe</span><span class=p>,</span><span class=w>  </span><span class=c1>// 主题订阅</span>
</span><span id=__span-16-7><span class=w>    </span><span class=n>Topic_cancel</span><span class=p>,</span><span class=w>     </span><span class=c1>// 主题取消</span>
</span><span id=__span-16-8><span class=w>    </span><span class=n>Topic_publish</span><span class=w>     </span><span class=c1>// 主题消息发布</span>
</span><span id=__span-16-9><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-17-1><span class=c1>// 服务操作类型</span>
</span><span id=__span-17-2><span class=k>enum</span><span class=w> </span><span class=k>class</span><span class=w> </span><span class=nc>ServiceOptype</span>
</span><span id=__span-17-3><span class=p>{</span>
</span><span id=__span-17-4><span class=w>    </span><span class=n>Service_register</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=c1>// 服务注册</span>
</span><span id=__span-17-5><span class=w>    </span><span class=n>Service_discover</span><span class=p>,</span><span class=w>     </span><span class=c1>// 服务发现</span>
</span><span id=__span-17-6><span class=w>    </span><span class=n>Service_online</span><span class=p>,</span><span class=w>       </span><span class=c1>// 服务上线</span>
</span><span id=__span-17-7><span class=w>    </span><span class=n>Service_offline</span><span class=p>,</span><span class=w>      </span><span class=c1>// 服务下线</span>
</span><span id=__span-17-8><span class=w>    </span><span class=n>Service_wrong_type</span><span class=p>,</span><span class=w>   </span><span class=c1>// 错误服务类型</span>
</span><span id=__span-17-9><span class=w>    </span><span class=n>Service_unknown</span><span class=w>       </span><span class=c1>// 不存在的服务类型</span>
</span><span id=__span-17-10><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>对于错误码，更多的时候需要看到错误码对应的错误信息，所以考虑提供一个错误码转错误信息的函数，设计如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-18-1><span class=c1>// 获取错误原因字符串</span>
</span><span id=__span-18-2><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=nf>errReason</span><span class=p>(</span><span class=n>RCode</span><span class=w> </span><span class=n>code</span><span class=p>)</span>
</span><span id=__span-18-3><span class=p>{</span>
</span><span id=__span-18-4><span class=w>    </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>code</span><span class=p>)</span>
</span><span id=__span-18-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-18-6><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=no>RCode</span><span class=o>::</span><span class=no>RCode_fine</span><span class=p>:</span>
</span><span id=__span-18-7><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&quot;正常&quot;</span><span class=p>;</span>
</span><span id=__span-18-8><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=no>RCode</span><span class=o>::</span><span class=no>RCode_parse_failed</span><span class=p>:</span>
</span><span id=__span-18-9><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&quot;解析失败&quot;</span><span class=p>;</span>
</span><span id=__span-18-10><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=no>RCode</span><span class=o>::</span><span class=no>RCode_wrong_msgType</span><span class=p>:</span>
</span><span id=__span-18-11><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&quot;错误的消息类型&quot;</span><span class=p>;</span>
</span><span id=__span-18-12><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=no>RCode</span><span class=o>::</span><span class=no>RCode_invalid_msg</span><span class=p>:</span>
</span><span id=__span-18-13><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&quot;无效消息&quot;</span><span class=p>;</span>
</span><span id=__span-18-14><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=no>RCode</span><span class=o>::</span><span class=no>RCode_disconneted</span><span class=p>:</span>
</span><span id=__span-18-15><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&quot;连接断开&quot;</span><span class=p>;</span>
</span><span id=__span-18-16><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=no>RCode</span><span class=o>::</span><span class=no>RCode_invalid_params</span><span class=p>:</span>
</span><span id=__span-18-17><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&quot;错误参数&quot;</span><span class=p>;</span>
</span><span id=__span-18-18><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=no>RCode</span><span class=o>::</span><span class=no>RCode_not_found_service</span><span class=p>:</span>
</span><span id=__span-18-19><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&quot;未找到服务&quot;</span><span class=p>;</span>
</span><span id=__span-18-20><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=no>RCode</span><span class=o>::</span><span class=no>RCode_invalid_opType</span><span class=p>:</span>
</span><span id=__span-18-21><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&quot;无效操作类型&quot;</span><span class=p>;</span>
</span><span id=__span-18-22><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=no>RCode</span><span class=o>::</span><span class=no>RCode_not_found_topic</span><span class=p>:</span>
</span><span id=__span-18-23><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&quot;未找到主题&quot;</span><span class=p>;</span>
</span><span id=__span-18-24><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=no>RCode</span><span class=o>::</span><span class=no>RCode_internal_error</span><span class=p>:</span>
</span><span id=__span-18-25><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&quot;内部错误&quot;</span><span class=p>;</span>
</span><span id=__span-18-26><span class=w>    </span><span class=k>default</span><span class=o>:</span>
</span><span id=__span-18-27><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&quot;无指定的错误原因&quot;</span><span class=p>;</span>
</span><span id=__span-18-28><span class=w>    </span><span class=p>}</span>
</span><span id=__span-18-29>
</span><span id=__span-18-30><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=s>&quot;&quot;</span><span class=p>;</span>
</span><span id=__span-18-31><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h2 id=_5>基类设计<a class=headerlink href=#_5 title="Permanent link">&para;</a></h2> <h3 id=_6>设计思想及抽象类介绍<a class=headerlink href=#_6 title="Permanent link">&para;</a></h3> <p>为了保证代码的开闭原则，考虑抽象类和子类的设计，确保在更换部分模块时使用处的代码不需要修改</p> <details class=info> <summary>开闭原则</summary> <p><strong>开闭原则（Open-Closed Principle, OCP）</strong> 是面向对象设计中的一个核心原则，由Bertrand Meyer提出，是SOLID原则之一。它的核心思想是：对扩展开放，对修改关闭（Open for extension, closed for modification）</p> <ul> <li>对扩展开放（Open for extension）：软件实体（类、模块、函数等）应该允许在不修改原有代码的情况下进行功能的扩展</li> <li>对修改关闭（Closed for modification）：当需求变化时，不需要去改动已有的代码逻辑</li> </ul> <p>通过遵循开闭原则，可以提高系统的可维护性、可复用性和稳定性。当系统需要新增功能时，只需添加新代码，而不需要修改已有代码，从而降低了引入错误的风险</p> <p>要实现“对扩展开放，对修改关闭”，通常使用以下技术手段：</p> <ol> <li> <p>抽象（Abstract） + 多态（Polymorphism）：定义接口或抽象类，具体行为由子类实现。新增功能时，只需要增加新的子类，不需要修改调用者代码</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-19-1><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
</span><span id=__span-19-2><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;vector&gt;</span>
</span><span id=__span-19-3>
</span><span id=__span-19-4><span class=c1>// 抽象类：图形接口</span>
</span><span id=__span-19-5><span class=k>class</span><span class=w> </span><span class=nc>Shape</span><span class=w> </span>
</span><span id=__span-19-6><span class=p>{</span>
</span><span id=__span-19-7><span class=k>public</span><span class=o>:</span>
</span><span id=__span-19-8><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>double</span><span class=w> </span><span class=n>area</span><span class=p>()</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=c1>// 纯虚函数</span>
</span><span id=__span-19-9><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=o>~</span><span class=n>Shape</span><span class=p>()</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>default</span><span class=p>;</span>
</span><span id=__span-19-10><span class=p>};</span>
</span><span id=__span-19-11>
</span><span id=__span-19-12><span class=c1>// 扩展：矩形</span>
</span><span id=__span-19-13><span class=k>class</span><span class=w> </span><span class=nc>Rectangle</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>Shape</span><span class=w> </span>
</span><span id=__span-19-14><span class=p>{</span>
</span><span id=__span-19-15><span class=k>private</span><span class=o>:</span>
</span><span id=__span-19-16><span class=w>    </span><span class=kt>double</span><span class=w> </span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=n>height</span><span class=p>;</span>
</span><span id=__span-19-17><span class=k>public</span><span class=o>:</span>
</span><span id=__span-19-18><span class=w>    </span><span class=n>Rectangle</span><span class=p>(</span><span class=kt>double</span><span class=w> </span><span class=n>w</span><span class=p>,</span><span class=w> </span><span class=kt>double</span><span class=w> </span><span class=n>h</span><span class=p>)</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>width</span><span class=p>(</span><span class=n>w</span><span class=p>),</span><span class=w> </span><span class=n>height</span><span class=p>(</span><span class=n>h</span><span class=p>)</span><span class=w> </span><span class=p>{}</span>
</span><span id=__span-19-19><span class=w>    </span><span class=kt>double</span><span class=w> </span><span class=n>area</span><span class=p>()</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=k>override</span><span class=w> </span>
</span><span id=__span-19-20><span class=w>    </span><span class=p>{</span>
</span><span id=__span-19-21><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>width</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>height</span><span class=p>;</span>
</span><span id=__span-19-22><span class=w>    </span><span class=p>}</span>
</span><span id=__span-19-23><span class=p>};</span>
</span><span id=__span-19-24>
</span><span id=__span-19-25><span class=c1>// 扩展：圆形</span>
</span><span id=__span-19-26><span class=k>class</span><span class=w> </span><span class=nc>Circle</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>Shape</span><span class=w> </span>
</span><span id=__span-19-27><span class=p>{</span>
</span><span id=__span-19-28><span class=k>private</span><span class=o>:</span>
</span><span id=__span-19-29><span class=w>    </span><span class=kt>double</span><span class=w> </span><span class=n>radius</span><span class=p>;</span>
</span><span id=__span-19-30><span class=k>public</span><span class=o>:</span>
</span><span id=__span-19-31><span class=w>    </span><span class=n>Circle</span><span class=p>(</span><span class=kt>double</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>radius</span><span class=p>(</span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{}</span>
</span><span id=__span-19-32><span class=w>    </span><span class=kt>double</span><span class=w> </span><span class=n>area</span><span class=p>()</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=k>override</span><span class=w> </span>
</span><span id=__span-19-33><span class=w>    </span><span class=p>{</span>
</span><span id=__span-19-34><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mf>3.14</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>radius</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>radius</span><span class=p>;</span>
</span><span id=__span-19-35><span class=w>    </span><span class=p>}</span>
</span><span id=__span-19-36><span class=p>};</span>
</span><span id=__span-19-37>
</span><span id=__span-19-38><span class=c1>// 面积计算器：对所有图形统一处理</span>
</span><span id=__span-19-39><span class=k>class</span><span class=w> </span><span class=nc>AreaCalculator</span><span class=w> </span>
</span><span id=__span-19-40><span class=p>{</span>
</span><span id=__span-19-41><span class=k>public</span><span class=o>:</span>
</span><span id=__span-19-42><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=kt>double</span><span class=w> </span><span class=n>calculate</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>Shape</span><span class=o>&amp;</span><span class=w> </span><span class=n>shape</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-19-43><span class=w>    </span><span class=p>{</span>
</span><span id=__span-19-44><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>shape</span><span class=p>.</span><span class=n>area</span><span class=p>();</span>
</span><span id=__span-19-45><span class=w>    </span><span class=p>}</span>
</span><span id=__span-19-46><span class=p>};</span>
</span><span id=__span-19-47>
</span><span id=__span-19-48><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-19-49><span class=p>{</span>
</span><span id=__span-19-50><span class=w>    </span><span class=n>Rectangle</span><span class=w> </span><span class=n>rect</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span><span class=w> </span><span class=mi>10</span><span class=p>);</span>
</span><span id=__span-19-51><span class=w>    </span><span class=n>Circle</span><span class=w> </span><span class=n>circle</span><span class=p>(</span><span class=mi>7</span><span class=p>);</span>
</span><span id=__span-19-52>
</span><span id=__span-19-53><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Rectangle Area: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>AreaCalculator</span><span class=o>::</span><span class=n>calculate</span><span class=p>(</span><span class=n>rect</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-19-54><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Circle Area: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>AreaCalculator</span><span class=o>::</span><span class=n>calculate</span><span class=p>(</span><span class=n>circle</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-19-55>
</span><span id=__span-19-56><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-19-57><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <p>策略模式（Strategy Pattern）：将算法封装为独立的类，运行时可以动态切换策略，而不是硬编码逻辑</p> </li> <li>插件机制 / 模块化设计：通过配置文件或反射机制加载外部模块，使得系统具备动态扩展能力</li> </ol> </details> <p>在本次项目中，考虑设计思路为：</p> <ol> <li>连接管理：服务端可能不止收到一个客户端的连接，而一个客户端的连接可能包含很多信息，例如客户端的端口和IP地址，所以为了方便管理，需要设计一个连接类来管理每一个客户端的连接，在这个连接类中，除了提供最基础的连接信息外，还需要提供一个发送接口，这样可以确保发送接口的使用方式是统一的，即只能通过连接类的连接对象发送数据</li> <li>消息处理过程：服务端或者客户端都是从缓冲区读取数据，而不是读取传输过来的数据，所以需要一个缓冲区类，接着需要有一个类用于判断读取到的数据是否完整以及构建一个序列化之后的数据，这个类就是应用层协议类，一旦应用层协议类判断数据已经完整就可以将数据保存起来，而在序列化时需要拿到待序列化的数据，即还需要一个类来保存读取到的数据以及作为构建序列化数据的来源，所以此时还需要设计一个消息类，这个类内部需要提供设置协议中的字段的接口和获取协议中的字段的接口</li> <li>客户端和服务端：封装客户端和服务端，提供对外的接口，供上层使用，简化整体连接操作</li> </ol> <div class="admonition note"> <p class=admonition-title>应用层协议类的数据构建接口和消息类的序列化与反序列化接口的关系</p> <p>应用层协议类的数据构建接口是将正文长度、消息类型、请求/响应ID、请求/响应ID长度和正文5个字段组合构建出一个完整的满足约定协议的消息，而消息类的序列化和反序列化接口只是对消息的正文（例如请求RPC服务，客户端需要发送请求的服务和参数，服务端需要返回的接口）进行序列化和反序列化，而不对其他字段进行操作</p> </div> <p>根据上面的思路，分别设计下面的基类：</p> <ol> <li>Buffer基类：用于处理网络数据的缓冲区，用于存储接收到的数据，向外提供需要的读取接口</li> <li>Message基类：对消息进行封装，提供设置应用层协议相关字段（不包括正文中的字段）的接口，同时提供序列化和反序列化接口用于后续应用层协议模块使用，最后提供一个判断消息是否完整的接口</li> <li>Connection基类：对网络连接进行封装，提供连接的获取、判断连接是否正常和发送接口</li> <li>Protocol基类：应用层协议的基类，提供获取消息字段和构建消息的接口，同时提供判断消息是否完整的接口</li> <li>Client基类：用于客户端的封装，提供连接服务器、断开服务器、获取当前客户端连接对象和判断当前连接是否正常的接口</li> <li>Server基类：用于服务端的封装，提供启动服务器的接口</li> </ol> <h3 id=buffer>Buffer基类设计<a class=headerlink href=#buffer title="Permanent link">&para;</a></h3> <p>根据前面对应用层协议格式的约定，提供下面的接口：</p> <ol> <li>获取缓冲区有效数据大小</li> <li>尝试读取4字节数据，但是不删除该数据</li> <li>删除4字节数据</li> <li>读取并删除4字节数据</li> <li>获取指定长度的数据</li> </ol> <p>设计出Buffer基类如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-20-1><span class=k>class</span><span class=w> </span><span class=nc>BaseBuffer</span>
</span><span id=__span-20-2><span class=p>{</span>
</span><span id=__span-20-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-20-4><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>BaseBuffer</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-20-5><span class=w>    </span><span class=c1>// 可读数据大小</span>
</span><span id=__span-20-6><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>size_t</span><span class=w> </span><span class=nf>readableSize</span><span class=p>()</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-20-7><span class=w>    </span><span class=c1>// 尝试获取4字节数据，但是不从缓冲区删除</span>
</span><span id=__span-20-8><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>int32_t</span><span class=w> </span><span class=nf>peekInt32</span><span class=p>()</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-20-9><span class=w>    </span><span class=c1>// 删除4字节数据</span>
</span><span id=__span-20-10><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>retrieveInt32</span><span class=p>()</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-20-11><span class=w>    </span><span class=c1>// 读取并删除4字节数据</span>
</span><span id=__span-20-12><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>int32_t</span><span class=w> </span><span class=nf>readInt32</span><span class=p>()</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-20-13><span class=w>    </span><span class=c1>// 获取指定长度的数据</span>
</span><span id=__span-20-14><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=nf>retrieveAsString</span><span class=p>(</span><span class=kt>size_t</span><span class=w> </span><span class=n>len</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-20-15><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <h3 id=message>Message基类设计<a class=headerlink href=#message title="Permanent link">&para;</a></h3> <p>根据上面的设计思路，需要在Message基类中提供下面的接口：</p> <ol> <li>设置消息类型</li> <li>获取消息类型</li> <li>设置请求/响应ID</li> <li>获取请求/响应ID</li> <li>序列化</li> <li>反序列化</li> </ol> <p>除了上面的接口以外，还需要提供一个判断正文内容是否有效的接口。因为序列化、反序列化以及判断接口都取决于上层使用的序列化和反序列化的方式，所以在当前父类中不提供具体的实现，而其他四个函数可以直接实现，因为根据应用层协议格式的约定，对应设置的字段都是固定的</p> <p>设计出Message基类如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-21-1><span class=k>class</span><span class=w> </span><span class=nc>BaseMessage</span>
</span><span id=__span-21-2><span class=p>{</span>
</span><span id=__span-21-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-21-4><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>BaseMessage</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-21-5>
</span><span id=__span-21-6><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=o>~</span><span class=n>BaseMessage</span><span class=p>()</span><span class=w> </span><span class=p>{}</span>
</span><span id=__span-21-7><span class=w>    </span><span class=c1>// 设置请求/响应ID</span>
</span><span id=__span-21-8><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=n>setId</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>id</span><span class=p>)</span>
</span><span id=__span-21-9><span class=w>    </span><span class=p>{</span>
</span><span id=__span-21-10><span class=w>        </span><span class=n>req_resp_id_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>id</span><span class=p>;</span>
</span><span id=__span-21-11><span class=w>    </span><span class=p>}</span>
</span><span id=__span-21-12><span class=w>    </span><span class=c1>// 获取请求/响应ID</span>
</span><span id=__span-21-13><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>getReqRespId</span><span class=p>()</span>
</span><span id=__span-21-14><span class=w>    </span><span class=p>{</span>
</span><span id=__span-21-15><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>req_resp_id_</span><span class=p>;</span>
</span><span id=__span-21-16><span class=w>    </span><span class=p>}</span>
</span><span id=__span-21-17><span class=w>    </span><span class=c1>// 设置消息类型</span>
</span><span id=__span-21-18><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=n>setMType</span><span class=p>(</span><span class=n>public_data</span><span class=o>::</span><span class=n>MType</span><span class=w> </span><span class=n>mtype</span><span class=p>)</span>
</span><span id=__span-21-19><span class=w>    </span><span class=p>{</span>
</span><span id=__span-21-20><span class=w>        </span><span class=n>mtype_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mtype</span><span class=p>;</span>
</span><span id=__span-21-21><span class=w>    </span><span class=p>}</span>
</span><span id=__span-21-22><span class=w>    </span><span class=c1>// 获取消息类型</span>
</span><span id=__span-21-23><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=n>public_data</span><span class=o>::</span><span class=n>MType</span><span class=w> </span><span class=n>getMtype</span><span class=p>()</span>
</span><span id=__span-21-24><span class=w>    </span><span class=p>{</span>
</span><span id=__span-21-25><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>mtype_</span><span class=p>;</span>
</span><span id=__span-21-26><span class=w>    </span><span class=p>}</span>
</span><span id=__span-21-27><span class=w>    </span><span class=c1>// 序列化</span>
</span><span id=__span-21-28><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=n>serialize</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-21-29><span class=w>    </span><span class=c1>// 反序列化</span>
</span><span id=__span-21-30><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=nf>deserialize</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-21-31><span class=w>    </span><span class=c1>// 检查消息是否合法</span>
</span><span id=__span-21-32><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=nf>check</span><span class=p>()</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-21-33>
</span><span id=__span-21-34><span class=k>protected</span><span class=o>:</span>
</span><span id=__span-21-35><span class=w>    </span><span class=n>public_data</span><span class=o>::</span><span class=n>MType</span><span class=w> </span><span class=n>mtype_</span><span class=p>;</span>
</span><span id=__span-21-36><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>req_resp_id_</span><span class=p>;</span>
</span><span id=__span-21-37><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <h3 id=connection>Connection基类设计<a class=headerlink href=#connection title="Permanent link">&para;</a></h3> <p>根据上面的设计思路，需要在Connection基类中提供下面的接口：</p> <ol> <li>获取当前连接对象</li> <li>判断当前连接是否正常</li> <li>发送数据</li> </ol> <p>本次项目中，发送的数据为基于<code>BaseMessage</code>的子类对象序列化后的成员变量尼尔和构建出的应用层协议字段组成的完整消息，所以需要在参数部分传递一个<code>BaseMessage</code>对象指针</p> <p>设计出Connection基类如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-22-1><span class=k>class</span><span class=w> </span><span class=nc>BaseConnection</span>
</span><span id=__span-22-2><span class=p>{</span>
</span><span id=__span-22-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-22-4><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>BaseConnection</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-22-5><span class=w>    </span><span class=c1>// 发送</span>
</span><span id=__span-22-6><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>send</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>base_message</span><span class=o>::</span><span class=n>BaseMessage</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=o>&amp;</span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-22-7><span class=w>    </span><span class=c1>// 关闭连接</span>
</span><span id=__span-22-8><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>shutdown</span><span class=p>()</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-22-9><span class=w>    </span><span class=c1>// 判断连接是否正常</span>
</span><span id=__span-22-10><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=nf>connected</span><span class=p>()</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-22-11><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <h3 id=protocol>Protocol基类设计<a class=headerlink href=#protocol title="Permanent link">&para;</a></h3> <p>应用层协议类是最直接和缓冲区类产生联系的类，因为应用层协议类需要从缓冲区类中读取数据。根据前面的思路，需要在Protocol基类中提供下面的接口：</p> <ol> <li>判断数据是否完整</li> <li>构建完整的满足协议格式的内容</li> <li>解析数据存储到消息类中</li> </ol> <p>设计出Protocol基类如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-23-1><span class=c1>// 抽象协议类</span>
</span><span id=__span-23-2><span class=k>class</span><span class=w> </span><span class=nc>BaseProtocol</span>
</span><span id=__span-23-3><span class=p>{</span>
</span><span id=__span-23-4><span class=k>public</span><span class=o>:</span>
</span><span id=__span-23-5><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>BaseProtocol</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-23-6><span class=w>    </span><span class=c1>// 判断是否是有效数据</span>
</span><span id=__span-23-7><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=nf>canProcessed</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>base_buffer</span><span class=o>::</span><span class=n>BaseBuffer</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=o>&amp;</span><span class=n>buf</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-23-8><span class=w>    </span><span class=c1>// 收到消息时的处理，从buffer中读取数据交给Message类处理</span>
</span><span id=__span-23-9><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=nf>getContentFromBuffer</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>base_buffer</span><span class=o>::</span><span class=n>BaseBuffer</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=o>&amp;</span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=n>base_message</span><span class=o>::</span><span class=n>BaseMessage</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=o>&amp;</span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-23-10><span class=w>    </span><span class=c1>// 序列化接口，用于序列化Message类的成员</span>
</span><span id=__span-23-11><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=nf>constructProtocol</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>base_message</span><span class=o>::</span><span class=n>BaseMessage</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=o>&amp;</span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-23-12><span class=w>    </span><span class=c1>// 不提供反序列化</span>
</span><span id=__span-23-13><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <h3 id=client>Client基类设计<a class=headerlink href=#client title="Permanent link">&para;</a></h3> <p>根据上面的设计思路，需要在Client基类中提供下面的接口：</p> <ol> <li>连接服务器</li> <li>断开服务器</li> <li>获取当前客户端连接对象</li> <li>判断当前连接是否正常</li> </ol> <p>除了上面的接口以外，还需要提供三个设置回调函数的接口，确保封装的客户端可以执行的任务是由上层决定的。现在考虑回调函数的参数和返回值类型，在底层客户端部分，只有连接建立成功、收到消息和断开连接三个状态，后面的消息处理都是建立在收到消息基础之上，所以三个回调函数的参数都存在<code>BaseConnection</code>对象指针，返回值为<code>void</code>，而对于收到消息来说，需要对消息进行处理（例如获取消息），所以还需要有<code>BaseMessage</code>对象指针</p> <p>设计出Client基类如下：</p> <div class="tabbed-set tabbed-alternate" data-tabs=4:2><input checked=checked id=__tabbed_4_1 name=__tabbed_4 type=radio><input id=__tabbed_4_2 name=__tabbed_4 type=radio><div class=tabbed-labels><label for=__tabbed_4_1>回调类型</label><label for=__tabbed_4_2>Client基类设计</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-24-1><span class=c1>// 定义在枚举字段和宏定义所在文件中</span>
</span><span id=__span-24-2><span class=c1>// 连接回调函数</span>
</span><span id=__span-24-3><span class=k>using</span><span class=w> </span><span class=n>connectionCallback_t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>function</span><span class=o>&lt;</span><span class=kt>void</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>base_connection</span><span class=o>::</span><span class=n>BaseConnection</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=o>&amp;</span><span class=p>)</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-24-4><span class=c1>// 关闭连接时回调函数</span>
</span><span id=__span-24-5><span class=k>using</span><span class=w> </span><span class=n>closeCallback_t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>function</span><span class=o>&lt;</span><span class=kt>void</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>base_connection</span><span class=o>::</span><span class=n>BaseConnection</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=o>&amp;</span><span class=p>)</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-24-6><span class=c1>// 收到消息时回调函数</span>
</span><span id=__span-24-7><span class=k>using</span><span class=w> </span><span class=n>messageCallback_t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>function</span><span class=o>&lt;</span><span class=kt>void</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>base_connection</span><span class=o>::</span><span class=n>BaseConnection</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=o>&amp;</span><span class=p>,</span><span class=w> </span><span class=n>base_message</span><span class=o>::</span><span class=n>BaseMessage</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=o>&amp;</span><span class=p>)</span><span class=o>&gt;</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-25-1><span class=c1>// 客户端抽象</span>
</span><span id=__span-25-2><span class=k>class</span><span class=w> </span><span class=nc>BaseClient</span>
</span><span id=__span-25-3><span class=p>{</span>
</span><span id=__span-25-4><span class=k>public</span><span class=o>:</span>
</span><span id=__span-25-5><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>BaseClient</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-25-6><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setConnectionCallback</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>public_data</span><span class=o>::</span><span class=n>connectionCallback_t</span><span class=w> </span><span class=o>&amp;</span><span class=n>cb</span><span class=p>)</span>
</span><span id=__span-25-7><span class=w>    </span><span class=p>{</span>
</span><span id=__span-25-8><span class=w>        </span><span class=n>cb_connection_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cb</span><span class=p>;</span>
</span><span id=__span-25-9><span class=w>    </span><span class=p>}</span>
</span><span id=__span-25-10><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setCloseCallback</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>public_data</span><span class=o>::</span><span class=n>closeCallback_t</span><span class=w> </span><span class=o>&amp;</span><span class=n>cb</span><span class=p>)</span>
</span><span id=__span-25-11><span class=w>    </span><span class=p>{</span>
</span><span id=__span-25-12><span class=w>        </span><span class=n>cb_close_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cb</span><span class=p>;</span>
</span><span id=__span-25-13><span class=w>    </span><span class=p>}</span>
</span><span id=__span-25-14><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setMessageCallback</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>public_data</span><span class=o>::</span><span class=n>messageCallback_t</span><span class=w> </span><span class=o>&amp;</span><span class=n>cb</span><span class=p>)</span>
</span><span id=__span-25-15><span class=w>    </span><span class=p>{</span>
</span><span id=__span-25-16><span class=w>        </span><span class=n>cb_message_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cb</span><span class=p>;</span>
</span><span id=__span-25-17><span class=w>    </span><span class=p>}</span>
</span><span id=__span-25-18>
</span><span id=__span-25-19><span class=w>    </span><span class=c1>// 连接服务端</span>
</span><span id=__span-25-20><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>connect</span><span class=p>()</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-25-21><span class=w>    </span><span class=c1>// 关闭连接</span>
</span><span id=__span-25-22><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>shutdown</span><span class=p>()</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-25-23><span class=w>    </span><span class=c1>// 获取连接对象</span>
</span><span id=__span-25-24><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=n>base_connection</span><span class=o>::</span><span class=n>BaseConnection</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=nf>connection</span><span class=p>()</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-25-25><span class=w>    </span><span class=c1>// 判断是否连接</span>
</span><span id=__span-25-26><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=nf>connected</span><span class=p>()</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-25-27>
</span><span id=__span-25-28><span class=k>protected</span><span class=o>:</span>
</span><span id=__span-25-29><span class=w>    </span><span class=n>public_data</span><span class=o>::</span><span class=n>connectionCallback_t</span><span class=w> </span><span class=n>cb_connection_</span><span class=p>;</span>
</span><span id=__span-25-30><span class=w>    </span><span class=n>public_data</span><span class=o>::</span><span class=n>closeCallback_t</span><span class=w> </span><span class=n>cb_close_</span><span class=p>;</span>
</span><span id=__span-25-31><span class=w>    </span><span class=n>public_data</span><span class=o>::</span><span class=n>messageCallback_t</span><span class=w> </span><span class=n>cb_message_</span><span class=p>;</span>
</span><span id=__span-25-32><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <h3 id=server>Server基类设计<a class=headerlink href=#server title="Permanent link">&para;</a></h3> <p>根据前面的思路，服务端只需要有一个启动服务器的接口。接着，与客户端一样需要处理三种情况，所以也需要三个回调函数，类型与客户端部分提到的一致。设计Server基类如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-26-1><span class=c1>// 服务端抽象</span>
</span><span id=__span-26-2><span class=k>class</span><span class=w> </span><span class=nc>BaseServer</span>
</span><span id=__span-26-3><span class=p>{</span>
</span><span id=__span-26-4><span class=k>public</span><span class=o>:</span>
</span><span id=__span-26-5><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>BaseServer</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-26-6><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setConnectionCallback</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>public_data</span><span class=o>::</span><span class=n>connectionCallback_t</span><span class=w> </span><span class=o>&amp;</span><span class=n>cb</span><span class=p>)</span>
</span><span id=__span-26-7><span class=w>    </span><span class=p>{</span>
</span><span id=__span-26-8><span class=w>        </span><span class=n>cb_connection_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cb</span><span class=p>;</span>
</span><span id=__span-26-9><span class=w>    </span><span class=p>}</span>
</span><span id=__span-26-10><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setCloseCallback</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>public_data</span><span class=o>::</span><span class=n>closeCallback_t</span><span class=w> </span><span class=o>&amp;</span><span class=n>cb</span><span class=p>)</span>
</span><span id=__span-26-11><span class=w>    </span><span class=p>{</span>
</span><span id=__span-26-12><span class=w>        </span><span class=n>cb_close_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cb</span><span class=p>;</span>
</span><span id=__span-26-13><span class=w>    </span><span class=p>}</span>
</span><span id=__span-26-14><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setMessageCallback</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>public_data</span><span class=o>::</span><span class=n>messageCallback_t</span><span class=w> </span><span class=o>&amp;</span><span class=n>cb</span><span class=p>)</span>
</span><span id=__span-26-15><span class=w>    </span><span class=p>{</span>
</span><span id=__span-26-16><span class=w>        </span><span class=n>cb_message_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cb</span><span class=p>;</span>
</span><span id=__span-26-17><span class=w>    </span><span class=p>}</span>
</span><span id=__span-26-18>
</span><span id=__span-26-19><span class=w>    </span><span class=c1>// 启动服务器</span>
</span><span id=__span-26-20><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>()</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-26-21>
</span><span id=__span-26-22><span class=k>protected</span><span class=o>:</span>
</span><span id=__span-26-23><span class=w>    </span><span class=n>public_data</span><span class=o>::</span><span class=n>connectionCallback_t</span><span class=w> </span><span class=n>cb_connection_</span><span class=p>;</span>
</span><span id=__span-26-24><span class=w>    </span><span class=n>public_data</span><span class=o>::</span><span class=n>closeCallback_t</span><span class=w> </span><span class=n>cb_close_</span><span class=p>;</span>
</span><span id=__span-26-25><span class=w>    </span><span class=n>public_data</span><span class=o>::</span><span class=n>messageCallback_t</span><span class=w> </span><span class=n>cb_message_</span><span class=p>;</span>
</span><span id=__span-26-26><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <h2 id=_7>派生类设计<a class=headerlink href=#_7 title="Permanent link">&para;</a></h2> <h3 id=buffer_1>Buffer派生类设计<a class=headerlink href=#buffer_1 title="Permanent link">&para;</a></h3> <p>根据前面的抽象类，接下来依次实现对应的派生类，首先是Buffer基类的派生类，本次项目是基于Muduo库实现的，所以本次的Buffer派生类只需要基于Muduo库中的Buffer类实现即可：</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>关于Muduo库中的Buffer类介绍，可以参考<a href=https://www.help-doc.top/%E5%85%B6%E5%AE%83/%E5%85%B3%E4%BA%8EMuduo%E5%BA%93/%E5%85%B3%E4%BA%8EMuduo%E5%BA%93.html#buffer>关于Muduo库</a></p> </div> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-27-1><span class=c1>// 基于Muduo库中的Buffer进行再次封装，满足可扩展性</span>
</span><span id=__span-27-2><span class=c1>// 方法实现底层全部调用Muduo中Buffer类中的方法</span>
</span><span id=__span-27-3><span class=k>class</span><span class=w> </span><span class=nc>MuduoBuffer</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>base_buffer</span><span class=o>::</span><span class=n>BaseBuffer</span>
</span><span id=__span-27-4><span class=p>{</span>
</span><span id=__span-27-5><span class=k>public</span><span class=o>:</span>
</span><span id=__span-27-6><span class=w>    </span><span class=n>MuduoBuffer</span><span class=p>(</span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>Buffer</span><span class=w> </span><span class=o>*</span><span class=n>buf</span><span class=p>)</span>
</span><span id=__span-27-7><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=n>buffer_</span><span class=p>(</span><span class=n>buf</span><span class=p>)</span>
</span><span id=__span-27-8><span class=w>    </span><span class=p>{</span>
</span><span id=__span-27-9><span class=w>    </span><span class=p>}</span>
</span><span id=__span-27-10><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>MuduoBuffer</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-27-11><span class=w>    </span><span class=c1>// 可读数据大小</span>
</span><span id=__span-27-12><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>size_t</span><span class=w> </span><span class=nf>readableSize</span><span class=p>()</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-27-13><span class=w>    </span><span class=p>{</span>
</span><span id=__span-27-14><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>buffer_</span><span class=o>-&gt;</span><span class=n>readableBytes</span><span class=p>();</span>
</span><span id=__span-27-15><span class=w>    </span><span class=p>}</span>
</span><span id=__span-27-16><span class=w>    </span><span class=c1>// 尝试获取4字节数据，但是不从缓冲区删除</span>
</span><span id=__span-27-17><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>int32_t</span><span class=w> </span><span class=nf>peekInt32</span><span class=p>()</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-27-18><span class=w>    </span><span class=p>{</span>
</span><span id=__span-27-19><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>buffer_</span><span class=o>-&gt;</span><span class=n>peekInt32</span><span class=p>();</span><span class=w> </span><span class=c1>// 会进行网络字节序转换</span>
</span><span id=__span-27-20><span class=w>    </span><span class=p>}</span>
</span><span id=__span-27-21><span class=w>    </span><span class=c1>// 删除4字节数据</span>
</span><span id=__span-27-22><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>retrieveInt32</span><span class=p>()</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-27-23><span class=w>    </span><span class=p>{</span>
</span><span id=__span-27-24><span class=w>        </span><span class=n>buffer_</span><span class=o>-&gt;</span><span class=n>retrieveInt32</span><span class=p>();</span>
</span><span id=__span-27-25><span class=w>    </span><span class=p>}</span>
</span><span id=__span-27-26><span class=w>    </span><span class=c1>// 读取并删除4字节数据</span>
</span><span id=__span-27-27><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>int32_t</span><span class=w> </span><span class=nf>readInt32</span><span class=p>()</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-27-28><span class=w>    </span><span class=p>{</span>
</span><span id=__span-27-29><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>buffer_</span><span class=o>-&gt;</span><span class=n>readInt32</span><span class=p>();</span>
</span><span id=__span-27-30><span class=w>    </span><span class=p>}</span>
</span><span id=__span-27-31><span class=w>    </span><span class=c1>// 获取指定长度的数据</span>
</span><span id=__span-27-32><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=nf>retrieveAsString</span><span class=p>(</span><span class=kt>size_t</span><span class=w> </span><span class=n>len</span><span class=p>)</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-27-33><span class=w>    </span><span class=p>{</span>
</span><span id=__span-27-34><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>buffer_</span><span class=o>-&gt;</span><span class=n>retrieveAsString</span><span class=p>(</span><span class=n>len</span><span class=p>);</span>
</span><span id=__span-27-35><span class=w>    </span><span class=p>}</span>
</span><span id=__span-27-36>
</span><span id=__span-27-37><span class=k>private</span><span class=o>:</span>
</span><span id=__span-27-38><span class=w>    </span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>Buffer</span><span class=w> </span><span class=o>*</span><span class=n>buffer_</span><span class=p>;</span><span class=w> </span><span class=c1>// 基于Muduo库的Buffer</span>
</span><span id=__span-27-39><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <h3 id=message_1>Message派生类设计<a class=headerlink href=#message_1 title="Permanent link">&para;</a></h3> <h4 id=basemessagejsonmessage>基于<code>BaseMessage</code>的<code>JsonMessage</code>子类设计<a class=headerlink href=#basemessagejsonmessage title="Permanent link">&para;</a></h4> <p>本次项目中，Message派生类一共有两个，这两个子类都是基于JSON实现的，表示JSON请求消息类和JSON响应消息类，在这两个子类中，主要实现序列化和反序列化函数即可，为了不需要在请求类和响应类中重复实现序列化和反序列化函数，考虑创建一个基于JSON的基类，然后让请求类和响应类继承这个基类，而这个类中主要实现正文字段的序列化和反序列化函数即可，下面考虑该类的设计：</p> <p>既然是正文序列化和反序列化，那么少不了的就是JSON对象，所以需要一个成员<code>body_</code>，用于保存反序列化结果，如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-28-1><span class=k>class</span><span class=w> </span><span class=nc>JsonMessage</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>base_message</span><span class=o>::</span><span class=n>BaseMessage</span>
</span><span id=__span-28-2><span class=p>{</span>
</span><span id=__span-28-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-28-4><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>JsonMessage</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-28-5><span class=k>protected</span><span class=o>:</span>
</span><span id=__span-28-6><span class=w>    </span><span class=n>Json</span><span class=o>::</span><span class=n>Value</span><span class=w> </span><span class=n>body_</span><span class=p>;</span>
</span><span id=__span-28-7><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>接着实现序列化函数，序列化函数内部主要思路需要调用上面实现的JSON序列化工具类，将序列化后的字符串存储到参数中返回给上层，参考代码如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-29-1><span class=k>virtual</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=nf>serialize</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-29-2><span class=p>{</span>
</span><span id=__span-29-3><span class=w>    </span><span class=c1>// 判断Json对象是否为空</span>
</span><span id=__span-29-4><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>body_</span><span class=p>.</span><span class=n>isNull</span><span class=p>())</span>
</span><span id=__span-29-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-29-6><span class=w>        </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;正文字段Body为空，序列化失败&quot;</span><span class=p>);</span>
</span><span id=__span-29-7><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-29-8><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-9>
</span><span id=__span-29-10><span class=w>    </span><span class=c1>// 调用Json工具类方法进行序列化</span>
</span><span id=__span-29-11><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>json_util</span><span class=o>::</span><span class=n>JsonUtil</span><span class=o>::</span><span class=n>serialize</span><span class=p>(</span><span class=n>body_</span><span class=p>,</span><span class=w> </span><span class=n>msg</span><span class=p>))</span>
</span><span id=__span-29-12><span class=w>    </span><span class=p>{</span>
</span><span id=__span-29-13><span class=w>        </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;对Body序列化失败&quot;</span><span class=p>);</span>
</span><span id=__span-29-14><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-29-15><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-16>
</span><span id=__span-29-17><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-29-18><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>对于反序列化函数也是类似，参考代码如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-30-1><span class=k>virtual</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=nf>deserialize</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-30-2><span class=p>{</span>
</span><span id=__span-30-3><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>msg</span><span class=p>.</span><span class=n>empty</span><span class=p>())</span>
</span><span id=__span-30-4><span class=w>    </span><span class=p>{</span>
</span><span id=__span-30-5><span class=w>        </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;反序列化失败，字符串为空&quot;</span><span class=p>);</span>
</span><span id=__span-30-6><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-30-7><span class=w>    </span><span class=p>}</span>
</span><span id=__span-30-8>
</span><span id=__span-30-9><span class=w>    </span><span class=c1>// 调用Json工具类方法进行反序列化</span>
</span><span id=__span-30-10><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>json_util</span><span class=o>::</span><span class=n>JsonUtil</span><span class=o>::</span><span class=n>deserialize</span><span class=p>(</span><span class=n>msg</span><span class=p>,</span><span class=w> </span><span class=n>body_</span><span class=p>))</span>
</span><span id=__span-30-11><span class=w>    </span><span class=p>{</span>
</span><span id=__span-30-12><span class=w>        </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;反序列化失败&quot;</span><span class=p>);</span>
</span><span id=__span-30-13><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-30-14><span class=w>    </span><span class=p>}</span>
</span><span id=__span-30-15>
</span><span id=__span-30-16><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-30-17><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h4 id=jsonmessagejsonrequestjsonresponse>基于<code>JsonMessage</code>的<code>JsonRequest</code>和<code>JsonResponse</code>子类设计<a class=headerlink href=#jsonmessagejsonrequestjsonresponse title="Permanent link">&para;</a></h4> <p>接着，实现两个基于<code>JsonMessage</code>的子类<code>JsonRequest</code>和<code>JsonResponse</code>，其中在<code>JsonRequest</code>中不需要额外实现其他函数，因为正文字段的检查取决于不同的请求类型，在后续的请求子类中再具体实现，在<code>JsonResponse</code>中需要实现<code>check</code>函数用于对返回值状态码类型进行检查，因为不论是否存在结果，在本次项目中都需要返回状态码，所以在<code>JsonResponse</code>中实现最基础的<code>check</code>函数，对应地需要两个函数分别为设置返回状态码和获取返回状态码。参考代码如下：</p> <div class="tabbed-set tabbed-alternate" data-tabs=5:2><input checked=checked id=__tabbed_5_1 name=__tabbed_5 type=radio><input id=__tabbed_5_2 name=__tabbed_5 type=radio><div class=tabbed-labels><label for=__tabbed_5_1><code>JsonRequest</code>子类</label><label for=__tabbed_5_2><code>JsonResponse</code>子类</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-31-1><span class=k>class</span><span class=w> </span><span class=nc>JsonRequest</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>JsonMessage</span>
</span><span id=__span-31-2><span class=p>{</span>
</span><span id=__span-31-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-31-4><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>JsonRequest</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-31-5><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-32-1><span class=k>class</span><span class=w> </span><span class=nc>JsonResponse</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>JsonMessage</span>
</span><span id=__span-32-2><span class=p>{</span>
</span><span id=__span-32-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-32-4><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>JsonResponse</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-32-5><span class=w>    </span><span class=c1>// 检查返回值是否合法</span>
</span><span id=__span-32-6><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=nf>check</span><span class=p>()</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-32-7><span class=w>    </span><span class=p>{</span>
</span><span id=__span-32-8><span class=w>        </span><span class=c1>// 判断返回值字段是否存在或者是否为整数，不是返回false</span>
</span><span id=__span-32-9><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_RCODE</span><span class=p>].</span><span class=n>isNull</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_RCODE</span><span class=p>].</span><span class=n>isInt</span><span class=p>())</span>
</span><span id=__span-32-10><span class=w>        </span><span class=p>{</span>
</span><span id=__span-32-11><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;返回值类型错误&quot;</span><span class=p>);</span>
</span><span id=__span-32-12><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-32-13><span class=w>        </span><span class=p>}</span>
</span><span id=__span-32-14>
</span><span id=__span-32-15><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-32-16><span class=w>    </span><span class=p>}</span>
</span><span id=__span-32-17>
</span><span id=__span-32-18><span class=w>    </span><span class=c1>// 设置和返回状态码</span>
</span><span id=__span-32-19><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setRCode</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>public_data</span><span class=o>::</span><span class=n>RCode</span><span class=w> </span><span class=n>r</span><span class=p>)</span>
</span><span id=__span-32-20><span class=w>    </span><span class=p>{</span>
</span><span id=__span-32-21><span class=w>        </span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_RCODE</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>r</span><span class=p>);</span>
</span><span id=__span-32-22><span class=w>    </span><span class=p>}</span>
</span><span id=__span-32-23>
</span><span id=__span-32-24><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=n>public_data</span><span class=o>::</span><span class=n>RCode</span><span class=w> </span><span class=nf>getRCode</span><span class=p>()</span>
</span><span id=__span-32-25><span class=w>    </span><span class=p>{</span>
</span><span id=__span-32-26><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>static_cast</span><span class=o>&lt;</span><span class=n>public_data</span><span class=o>::</span><span class=n>RCode</span><span class=o>&gt;</span><span class=p>(</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_RCODE</span><span class=p>].</span><span class=n>asInt</span><span class=p>());</span>
</span><span id=__span-32-27><span class=w>    </span><span class=p>}</span>
</span><span id=__span-32-28><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <h4 id=jsonrequestrpcrequest>基于<code>JsonRequest</code>的<code>RpcRequest</code>子类设计<a class=headerlink href=#jsonrequestrpcrequest title="Permanent link">&para;</a></h4> <p>在RPC请求中，根据前面的模块介绍，正文中需要包含请求的服务名和服务需要的参数，所以在<code>RpcRequest</code>中实现设置/获取服务名和参数的函数，其中，服务名是字符串类型，而参数取决于具体的服务，所以只能为JSON对象类型。接着实现对应的<code>check</code>函数，函数内部分别检查服务名是否存在且为字符串以及参数是否存在且为JSON对象类型即可。实现如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-33-1><span class=k>class</span><span class=w> </span><span class=nc>RpcRequest</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>json_message</span><span class=o>::</span><span class=n>JsonRequest</span>
</span><span id=__span-33-2><span class=p>{</span>
</span><span id=__span-33-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-33-4><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>RpcRequest</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-33-5><span class=w>    </span><span class=c1>// 实现检查方法</span>
</span><span id=__span-33-6><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=nf>check</span><span class=p>()</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-33-7><span class=w>    </span><span class=p>{</span>
</span><span id=__span-33-8><span class=w>        </span><span class=c1>// 判断方法名是否存在且为字符串</span>
</span><span id=__span-33-9><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_METHOD</span><span class=p>].</span><span class=n>isNull</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_METHOD</span><span class=p>].</span><span class=n>isString</span><span class=p>())</span>
</span><span id=__span-33-10><span class=w>        </span><span class=p>{</span>
</span><span id=__span-33-11><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;方法名错误&quot;</span><span class=p>);</span>
</span><span id=__span-33-12><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-33-13><span class=w>        </span><span class=p>}</span>
</span><span id=__span-33-14>
</span><span id=__span-33-15><span class=w>        </span><span class=c1>// 判断参数是否存在且为JSON对象</span>
</span><span id=__span-33-16><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_PARAMS</span><span class=p>].</span><span class=n>isNull</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_PARAMS</span><span class=p>].</span><span class=n>isObject</span><span class=p>())</span>
</span><span id=__span-33-17><span class=w>        </span><span class=p>{</span>
</span><span id=__span-33-18><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;参数错误&quot;</span><span class=p>);</span>
</span><span id=__span-33-19><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-33-20><span class=w>        </span><span class=p>}</span>
</span><span id=__span-33-21>
</span><span id=__span-33-22><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-33-23><span class=w>    </span><span class=p>}</span>
</span><span id=__span-33-24>
</span><span id=__span-33-25><span class=w>    </span><span class=c1>// 设置和获取方法</span>
</span><span id=__span-33-26><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>setMethod</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>m</span><span class=p>)</span>
</span><span id=__span-33-27><span class=w>    </span><span class=p>{</span>
</span><span id=__span-33-28><span class=w>        </span><span class=c1>// method_ = m;</span>
</span><span id=__span-33-29><span class=w>        </span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_METHOD</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>m</span><span class=p>;</span>
</span><span id=__span-33-30><span class=w>    </span><span class=p>}</span>
</span><span id=__span-33-31>
</span><span id=__span-33-32><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=nf>getMethod</span><span class=p>()</span>
</span><span id=__span-33-33><span class=w>    </span><span class=p>{</span>
</span><span id=__span-33-34><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_METHOD</span><span class=p>].</span><span class=n>asString</span><span class=p>();</span>
</span><span id=__span-33-35><span class=w>    </span><span class=p>}</span>
</span><span id=__span-33-36>
</span><span id=__span-33-37><span class=w>    </span><span class=c1>// 设置和获取参数</span>
</span><span id=__span-33-38><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>setParams</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>Json</span><span class=o>::</span><span class=n>Value</span><span class=w> </span><span class=o>&amp;</span><span class=n>p</span><span class=p>)</span>
</span><span id=__span-33-39><span class=w>    </span><span class=p>{</span>
</span><span id=__span-33-40><span class=w>        </span><span class=c1>// parameters_ = p;</span>
</span><span id=__span-33-41><span class=w>        </span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_PARAMS</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>;</span>
</span><span id=__span-33-42><span class=w>    </span><span class=p>}</span>
</span><span id=__span-33-43>
</span><span id=__span-33-44><span class=w>    </span><span class=n>Json</span><span class=o>::</span><span class=n>Value</span><span class=w> </span><span class=nf>getParams</span><span class=p>()</span>
</span><span id=__span-33-45><span class=w>    </span><span class=p>{</span>
</span><span id=__span-33-46><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_PARAMS</span><span class=p>];</span>
</span><span id=__span-33-47><span class=w>    </span><span class=p>}</span>
</span><span id=__span-33-48><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>需要注意的是，不要在<code>RpcRequest</code>中再包含服务名成员和服务参数成员，因为二者都是正文的内容，只需要向表示正文的JSON对象<code>body_</code>中插入即可</p> <h4 id=jsonrequesttopicrequest>基于<code>JsonRequest</code>的<code>TopicRequest</code>子类设计<a class=headerlink href=#jsonrequesttopicrequest title="Permanent link">&para;</a></h4> <p>在主题请求中，根据前面的模块介绍，正文中需要包含请求的主题名称（字符串）和请求操作类型（枚举类型，整型），如果请求类型是<code>Topic_publish</code>（主题消息发布），那么还需要携带待转发的消息（字符串），所以需要提供设置/获取主题名称、请求操作类型和待转发消息的函数。接着，实现<code>check</code>函数，分别检查主题名称是否存在且为字符串、请求操作类型是否存在且为整型以及如果请求操作类型为<code>Topic_publish</code>则是否存在待转发的消息且为字符串。实现如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span>
<span class=normal>59</span>
<span class=normal>60</span>
<span class=normal>61</span>
<span class=normal>62</span>
<span class=normal>63</span>
<span class=normal>64</span>
<span class=normal>65</span>
<span class=normal>66</span>
<span class=normal>67</span>
<span class=normal>68</span>
<span class=normal>69</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-34-1><span class=k>class</span><span class=w> </span><span class=nc>TopicRequest</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>json_message</span><span class=o>::</span><span class=n>JsonRequest</span>
</span><span id=__span-34-2><span class=p>{</span>
</span><span id=__span-34-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-34-4><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>TopicRequest</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-34-5><span class=w>    </span><span class=c1>// 检查三个字段</span>
</span><span id=__span-34-6><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=nf>check</span><span class=p>()</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-34-7><span class=w>    </span><span class=p>{</span>
</span><span id=__span-34-8><span class=w>        </span><span class=c1>// 检查主题名称</span>
</span><span id=__span-34-9><span class=w>        </span><span class=c1>// 判断主题是否存在且为字符串</span>
</span><span id=__span-34-10><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_TOPIC_KEY</span><span class=p>].</span><span class=n>isNull</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_TOPIC_KEY</span><span class=p>].</span><span class=n>isString</span><span class=p>())</span>
</span><span id=__span-34-11><span class=w>        </span><span class=p>{</span>
</span><span id=__span-34-12><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;主题名称错误&quot;</span><span class=p>);</span>
</span><span id=__span-34-13><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-34-14><span class=w>        </span><span class=p>}</span>
</span><span id=__span-34-15>
</span><span id=__span-34-16><span class=w>        </span><span class=c1>// 检查主题操作类型</span>
</span><span id=__span-34-17><span class=w>        </span><span class=c1>// 判断是否存在操作类型且为整数</span>
</span><span id=__span-34-18><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_OPTYPE</span><span class=p>].</span><span class=n>isNull</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_OPTYPE</span><span class=p>].</span><span class=n>isInt</span><span class=p>())</span>
</span><span id=__span-34-19><span class=w>        </span><span class=p>{</span>
</span><span id=__span-34-20><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;主题操作类型错误&quot;</span><span class=p>);</span>
</span><span id=__span-34-21><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-34-22><span class=w>        </span><span class=p>}</span>
</span><span id=__span-34-23>
</span><span id=__span-34-24><span class=w>        </span><span class=c1>// 检查消息</span>
</span><span id=__span-34-25><span class=w>        </span><span class=c1>// 判断是否为Topic_publish，如果是再检查是否存在消息且为字符串</span>
</span><span id=__span-34-26><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_OPTYPE</span><span class=p>].</span><span class=n>asInt</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>public_data</span><span class=o>::</span><span class=n>TopicOptype</span><span class=o>::</span><span class=n>Topic_publish</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span>
</span><span id=__span-34-27><span class=w>            </span><span class=p>(</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_TOPIC_MSG</span><span class=p>].</span><span class=n>isNull</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_TOPIC_MSG</span><span class=p>].</span><span class=n>isString</span><span class=p>()))</span>
</span><span id=__span-34-28><span class=w>        </span><span class=p>{</span>
</span><span id=__span-34-29><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;主题消息错误&quot;</span><span class=p>);</span>
</span><span id=__span-34-30><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-34-31><span class=w>        </span><span class=p>}</span>
</span><span id=__span-34-32>
</span><span id=__span-34-33><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-34-34><span class=w>    </span><span class=p>}</span>
</span><span id=__span-34-35>
</span><span id=__span-34-36><span class=w>    </span><span class=c1>// 设置和获取主题名称</span>
</span><span id=__span-34-37><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>setTopicName</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>n</span><span class=p>)</span>
</span><span id=__span-34-38><span class=w>    </span><span class=p>{</span>
</span><span id=__span-34-39><span class=w>        </span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_TOPIC_KEY</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>n</span><span class=p>;</span>
</span><span id=__span-34-40><span class=w>    </span><span class=p>}</span>
</span><span id=__span-34-41>
</span><span id=__span-34-42><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=nf>getTopicName</span><span class=p>()</span>
</span><span id=__span-34-43><span class=w>    </span><span class=p>{</span>
</span><span id=__span-34-44><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_TOPIC_KEY</span><span class=p>].</span><span class=n>asString</span><span class=p>();</span>
</span><span id=__span-34-45><span class=w>    </span><span class=p>}</span>
</span><span id=__span-34-46>
</span><span id=__span-34-47><span class=w>    </span><span class=c1>// 设置和获取主题操作类型</span>
</span><span id=__span-34-48><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>setTopicOptype</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>public_data</span><span class=o>::</span><span class=n>TopicOptype</span><span class=w> </span><span class=o>&amp;</span><span class=n>op</span><span class=p>)</span>
</span><span id=__span-34-49><span class=w>    </span><span class=p>{</span>
</span><span id=__span-34-50><span class=w>        </span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_OPTYPE</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>op</span><span class=p>);</span>
</span><span id=__span-34-51><span class=w>    </span><span class=p>}</span>
</span><span id=__span-34-52>
</span><span id=__span-34-53><span class=w>    </span><span class=n>public_data</span><span class=o>::</span><span class=n>TopicOptype</span><span class=w> </span><span class=nf>getTopicOptype</span><span class=p>()</span>
</span><span id=__span-34-54><span class=w>    </span><span class=p>{</span>
</span><span id=__span-34-55><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>static_cast</span><span class=o>&lt;</span><span class=n>public_data</span><span class=o>::</span><span class=n>TopicOptype</span><span class=o>&gt;</span><span class=p>(</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_OPTYPE</span><span class=p>].</span><span class=n>asInt</span><span class=p>());</span>
</span><span id=__span-34-56><span class=w>    </span><span class=p>}</span>
</span><span id=__span-34-57>
</span><span id=__span-34-58><span class=w>    </span><span class=c1>// 设置和获取主题信息</span>
</span><span id=__span-34-59><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>setMessage</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>m</span><span class=p>)</span>
</span><span id=__span-34-60><span class=w>    </span><span class=p>{</span>
</span><span id=__span-34-61><span class=w>        </span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_TOPIC_MSG</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>m</span><span class=p>;</span>
</span><span id=__span-34-62><span class=w>    </span><span class=p>}</span>
</span><span id=__span-34-63>
</span><span id=__span-34-64><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=nf>getMessage</span><span class=p>()</span>
</span><span id=__span-34-65><span class=w>    </span><span class=p>{</span>
</span><span id=__span-34-66><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_TOPIC_MSG</span><span class=p>].</span><span class=n>asString</span><span class=p>();</span>
</span><span id=__span-34-67><span class=w>    </span><span class=p>}</span>
</span><span id=__span-34-68>
</span><span id=__span-34-69><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <h4 id=jsonrequestservicerequest>基于<code>JsonRequest</code>的<code>ServiceRequest</code>子类设计<a class=headerlink href=#jsonrequestservicerequest title="Permanent link">&para;</a></h4> <p>在服务请求中，根据前面的模块介绍，正文需要包含请求的服务类型（整型）和提供的服务（字符串），如果服务类型是<code>Service_discover</code>就不要求需要携带主机信息（包括IP地址和端口号，类型为JSON对象），其他的服务类型都必须携带主机信息，所以需要提供设置/获取服务类型、提供的服务和主机信息的函数。接着，在<code>check</code>函数中实现检查服务类型是否存在且为整型、提供的服务是否存在且为字符串以及如果服务类型不为<code>Service_discover</code>是否存在主机信息且为JSON对象。实现如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span>
<span class=normal>59</span>
<span class=normal>60</span>
<span class=normal>61</span>
<span class=normal>62</span>
<span class=normal>63</span>
<span class=normal>64</span>
<span class=normal>65</span>
<span class=normal>66</span>
<span class=normal>67</span>
<span class=normal>68</span>
<span class=normal>69</span>
<span class=normal>70</span>
<span class=normal>71</span>
<span class=normal>72</span>
<span class=normal>73</span>
<span class=normal>74</span>
<span class=normal>75</span>
<span class=normal>76</span>
<span class=normal>77</span>
<span class=normal>78</span>
<span class=normal>79</span>
<span class=normal>80</span>
<span class=normal>81</span>
<span class=normal>82</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-35-1><span class=c1>// 主机信息类型</span>
</span><span id=__span-35-2><span class=k>using</span><span class=w> </span><span class=n>host_addr_t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>pair</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=p>,</span><span class=w> </span><span class=kt>uint16_t</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-35-3>
</span><span id=__span-35-4><span class=k>class</span><span class=w> </span><span class=nc>ServiceRequest</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>json_message</span><span class=o>::</span><span class=n>JsonRequest</span>
</span><span id=__span-35-5><span class=p>{</span>
</span><span id=__span-35-6><span class=k>public</span><span class=o>:</span>
</span><span id=__span-35-7><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>ServiceRequest</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-35-8><span class=w>    </span><span class=c1>// 检查字段</span>
</span><span id=__span-35-9><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=nf>check</span><span class=p>()</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-35-10><span class=w>    </span><span class=p>{</span>
</span><span id=__span-35-11><span class=w>        </span><span class=c1>// 检查方法名</span>
</span><span id=__span-35-12><span class=w>        </span><span class=c1>// 判断方法名是否存在且为字符串</span>
</span><span id=__span-35-13><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_METHOD</span><span class=p>].</span><span class=n>isNull</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_METHOD</span><span class=p>].</span><span class=n>isString</span><span class=p>())</span>
</span><span id=__span-35-14><span class=w>        </span><span class=p>{</span>
</span><span id=__span-35-15><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;方法名称错误&quot;</span><span class=p>);</span>
</span><span id=__span-35-16><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-35-17><span class=w>        </span><span class=p>}</span>
</span><span id=__span-35-18>
</span><span id=__span-35-19><span class=w>        </span><span class=c1>// 检查主题操作类型</span>
</span><span id=__span-35-20><span class=w>        </span><span class=c1>// 判断是否存在操作类型且为整数</span>
</span><span id=__span-35-21><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_OPTYPE</span><span class=p>].</span><span class=n>isNull</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_OPTYPE</span><span class=p>].</span><span class=n>isInt</span><span class=p>())</span>
</span><span id=__span-35-22><span class=w>        </span><span class=p>{</span>
</span><span id=__span-35-23><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;服务操作类型错误&quot;</span><span class=p>);</span>
</span><span id=__span-35-24><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-35-25><span class=w>        </span><span class=p>}</span>
</span><span id=__span-35-26>
</span><span id=__span-35-27><span class=w>        </span><span class=c1>// 检查消息</span>
</span><span id=__span-35-28><span class=w>        </span><span class=c1>// 判断是否存在主机信息</span>
</span><span id=__span-35-29><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_OPTYPE</span><span class=p>].</span><span class=n>asInt</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>public_data</span><span class=o>::</span><span class=n>ServiceOptype</span><span class=o>::</span><span class=n>Service_discover</span><span class=p>))</span><span class=w> </span><span class=o>&amp;&amp;</span>
</span><span id=__span-35-30><span class=w>            </span><span class=p>(</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_HOST</span><span class=p>].</span><span class=n>isNull</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_HOST</span><span class=p>].</span><span class=n>isObject</span><span class=p>())</span><span class=w> </span><span class=o>&amp;&amp;</span>
</span><span id=__span-35-31><span class=w>            </span><span class=p>(</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_HOST</span><span class=p>][</span><span class=n>KEY_HOST_IP</span><span class=p>].</span><span class=n>isNull</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_HOST</span><span class=p>][</span><span class=n>KEY_HOST_IP</span><span class=p>].</span><span class=n>isString</span><span class=p>())</span><span class=w> </span><span class=o>&amp;&amp;</span>
</span><span id=__span-35-32><span class=w>            </span><span class=p>(</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_HOST</span><span class=p>][</span><span class=n>KEY_HOST_PORT</span><span class=p>].</span><span class=n>isNull</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_HOST</span><span class=p>][</span><span class=n>KEY_HOST_PORT</span><span class=p>].</span><span class=n>isInt</span><span class=p>()))</span>
</span><span id=__span-35-33><span class=w>        </span><span class=p>{</span>
</span><span id=__span-35-34><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;主机信息错误&quot;</span><span class=p>);</span>
</span><span id=__span-35-35><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-35-36><span class=w>        </span><span class=p>}</span>
</span><span id=__span-35-37>
</span><span id=__span-35-38><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-35-39><span class=w>    </span><span class=p>}</span>
</span><span id=__span-35-40>
</span><span id=__span-35-41><span class=w>    </span><span class=c1>// 设置/获取服务操作类型</span>
</span><span id=__span-35-42><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>setServiceOptype</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>public_data</span><span class=o>::</span><span class=n>ServiceOptype</span><span class=w> </span><span class=n>so</span><span class=p>)</span>
</span><span id=__span-35-43><span class=w>    </span><span class=p>{</span>
</span><span id=__span-35-44><span class=w>        </span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_OPTYPE</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>so</span><span class=p>);</span>
</span><span id=__span-35-45><span class=w>    </span><span class=p>}</span>
</span><span id=__span-35-46>
</span><span id=__span-35-47><span class=w>    </span><span class=n>public_data</span><span class=o>::</span><span class=n>ServiceOptype</span><span class=w> </span><span class=nf>getServiceOptye</span><span class=p>()</span>
</span><span id=__span-35-48><span class=w>    </span><span class=p>{</span>
</span><span id=__span-35-49><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>static_cast</span><span class=o>&lt;</span><span class=n>public_data</span><span class=o>::</span><span class=n>ServiceOptype</span><span class=o>&gt;</span><span class=p>(</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_OPTYPE</span><span class=p>].</span><span class=n>asInt</span><span class=p>());</span>
</span><span id=__span-35-50><span class=w>    </span><span class=p>}</span>
</span><span id=__span-35-51>
</span><span id=__span-35-52><span class=w>    </span><span class=c1>// 设置和获取方法名</span>
</span><span id=__span-35-53><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>setMethod</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>n</span><span class=p>)</span>
</span><span id=__span-35-54><span class=w>    </span><span class=p>{</span>
</span><span id=__span-35-55><span class=w>        </span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_METHOD</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>n</span><span class=p>;</span>
</span><span id=__span-35-56><span class=w>    </span><span class=p>}</span>
</span><span id=__span-35-57>
</span><span id=__span-35-58><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=nf>getMethod</span><span class=p>()</span>
</span><span id=__span-35-59><span class=w>    </span><span class=p>{</span>
</span><span id=__span-35-60><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_METHOD</span><span class=p>].</span><span class=n>asString</span><span class=p>();</span>
</span><span id=__span-35-61><span class=w>    </span><span class=p>}</span>
</span><span id=__span-35-62>
</span><span id=__span-35-63><span class=w>    </span><span class=c1>// 设置和获取服务操作类型</span>
</span><span id=__span-35-64><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>setHost</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>public_data</span><span class=o>::</span><span class=n>host_addr_t</span><span class=w> </span><span class=o>&amp;</span><span class=n>host</span><span class=p>)</span>
</span><span id=__span-35-65><span class=w>    </span><span class=p>{</span>
</span><span id=__span-35-66><span class=w>        </span><span class=c1>// 以一个对象的方式插入到body_中</span>
</span><span id=__span-35-67><span class=w>        </span><span class=n>Json</span><span class=o>::</span><span class=n>Value</span><span class=w> </span><span class=n>val</span><span class=p>;</span>
</span><span id=__span-35-68><span class=w>        </span><span class=n>val</span><span class=p>[</span><span class=n>KEY_HOST_IP</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>host</span><span class=p>.</span><span class=n>first</span><span class=p>;</span>
</span><span id=__span-35-69><span class=w>        </span><span class=n>val</span><span class=p>[</span><span class=n>KEY_HOST_PORT</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>host</span><span class=p>.</span><span class=n>second</span><span class=p>;</span>
</span><span id=__span-35-70><span class=w>        </span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_HOST</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>val</span><span class=p>;</span>
</span><span id=__span-35-71><span class=w>    </span><span class=p>}</span>
</span><span id=__span-35-72>
</span><span id=__span-35-73><span class=w>    </span><span class=n>public_data</span><span class=o>::</span><span class=n>host_addr_t</span><span class=w> </span><span class=nf>getHost</span><span class=p>()</span>
</span><span id=__span-35-74><span class=w>    </span><span class=p>{</span>
</span><span id=__span-35-75><span class=w>        </span><span class=n>public_data</span><span class=o>::</span><span class=n>host_addr_t</span><span class=w> </span><span class=n>host</span><span class=p>;</span>
</span><span id=__span-35-76><span class=w>        </span><span class=n>host</span><span class=p>.</span><span class=n>first</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_HOST</span><span class=p>][</span><span class=n>KEY_HOST_IP</span><span class=p>].</span><span class=n>asString</span><span class=p>();</span>
</span><span id=__span-35-77><span class=w>        </span><span class=n>host</span><span class=p>.</span><span class=n>second</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_HOST</span><span class=p>][</span><span class=n>KEY_HOST_PORT</span><span class=p>].</span><span class=n>asInt</span><span class=p>();</span>
</span><span id=__span-35-78>
</span><span id=__span-35-79><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>host</span><span class=p>;</span>
</span><span id=__span-35-80><span class=w>    </span><span class=p>}</span>
</span><span id=__span-35-81>
</span><span id=__span-35-82><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <h4 id=jsonresponserpcresponse>基于<code>JsonResponse</code>的<code>RpcResponse</code>子类设计<a class=headerlink href=#jsonresponserpcresponse title="Permanent link">&para;</a></h4> <p>在RPC响应中，根据前面的模块介绍，正文中需要包含返回值和返回状态码，所以在<code>RpcResponse</code>中实现设置/获取返回值和返回状态码的函数，但是设置返回值和返回状态码函数已经在父类<code>JsonResponse</code>中存在，所以此处可以不需要再写一遍。其中，返回值类型取决于上层的处理函数，此处无法确定，而返回状态码为整型。接着实现对应的<code>check</code>函数，函数内部分别检查返回值是否存在（但是不判断具体类型）以及返回状态码是否存在且为整型即可。实现如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-36-1><span class=k>class</span><span class=w> </span><span class=nc>RpcResponse</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>json_message</span><span class=o>::</span><span class=n>JsonResponse</span>
</span><span id=__span-36-2><span class=p>{</span>
</span><span id=__span-36-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-36-4><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>RpcResponse</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-36-5>
</span><span id=__span-36-6><span class=w>    </span><span class=c1>// ! 需要重新实现check</span>
</span><span id=__span-36-7><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=nf>check</span><span class=p>()</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-36-8><span class=w>    </span><span class=p>{</span>
</span><span id=__span-36-9><span class=w>        </span><span class=c1>// 判断返回状态码</span>
</span><span id=__span-36-10><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_RCODE</span><span class=p>].</span><span class=n>isNull</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_RCODE</span><span class=p>].</span><span class=n>isInt</span><span class=p>())</span>
</span><span id=__span-36-11><span class=w>        </span><span class=p>{</span>
</span><span id=__span-36-12><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;返回状态码错误&quot;</span><span class=p>);</span>
</span><span id=__span-36-13><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-36-14><span class=w>        </span><span class=p>}</span>
</span><span id=__span-36-15>
</span><span id=__span-36-16><span class=w>        </span><span class=c1>// 判断返回值</span>
</span><span id=__span-36-17><span class=w>        </span><span class=c1>// 因为返回值可能不止一种类型，所以此处不判断返回值的类型是否正确</span>
</span><span id=__span-36-18><span class=w>        </span><span class=c1>// 而是交给上层进行处理</span>
</span><span id=__span-36-19><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_RESULT</span><span class=p>].</span><span class=n>isNull</span><span class=p>())</span>
</span><span id=__span-36-20><span class=w>        </span><span class=p>{</span>
</span><span id=__span-36-21><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;返回值错误&quot;</span><span class=p>);</span>
</span><span id=__span-36-22><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-36-23><span class=w>        </span><span class=p>}</span>
</span><span id=__span-36-24>
</span><span id=__span-36-25><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-36-26><span class=w>    </span><span class=p>}</span>
</span><span id=__span-36-27>
</span><span id=__span-36-28><span class=w>    </span><span class=c1>// 获取和设置返回值</span>
</span><span id=__span-36-29><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>setResult</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>Json</span><span class=o>::</span><span class=n>Value</span><span class=w> </span><span class=o>&amp;</span><span class=n>v</span><span class=p>)</span>
</span><span id=__span-36-30><span class=w>    </span><span class=p>{</span>
</span><span id=__span-36-31><span class=w>        </span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_RESULT</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>v</span><span class=p>;</span>
</span><span id=__span-36-32><span class=w>    </span><span class=p>}</span>
</span><span id=__span-36-33>
</span><span id=__span-36-34><span class=w>    </span><span class=n>Json</span><span class=o>::</span><span class=n>Value</span><span class=w> </span><span class=nf>getResult</span><span class=p>()</span>
</span><span id=__span-36-35><span class=w>    </span><span class=p>{</span>
</span><span id=__span-36-36><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_RESULT</span><span class=p>];</span>
</span><span id=__span-36-37><span class=w>    </span><span class=p>}</span>
</span><span id=__span-36-38><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <h4 id=jsonresponsetopicresponse>基于<code>JsonResponse</code>的<code>TopicResponse</code>子类设计<a class=headerlink href=#jsonresponsetopicresponse title="Permanent link">&para;</a></h4> <p>在主题响应中，根据前面的模块介绍，只存在返回状态码，而返回状态码的设置、获取和检查都在父类<code>JsonResponse</code>中实现，所以对于<code>TopicResponse</code>来说只是一个空的子类：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-37-1><span class=k>class</span><span class=w> </span><span class=nc>TopicResponse</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>json_message</span><span class=o>::</span><span class=n>JsonResponse</span>
</span><span id=__span-37-2><span class=p>{</span>
</span><span id=__span-37-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-37-4><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>TopicResponse</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-37-5><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <h4 id=jsonresponseserviceresponse>基于<code>JsonResponse</code>的<code>ServiceResponse</code>子类设计<a class=headerlink href=#jsonresponseserviceresponse title="Permanent link">&para;</a></h4> <p>在服务响应中，根据前面的模块介绍，正文需要包含服务类型（整型）、返回状态码（整型）和请求的服务名称（字符串），如果服务类型是<code>Service_discover</code>就要求需要携带主机信息集（包括多个主机的IP地址和端口号，类型为JSON数组），其他的服务类型就不必携带主机信息，<strong>此处与服务请求相反</strong>，所以需要提供请求的服务名称、服务类型和主机信息集的函数。接着，在<code>check</code>函数中实现检查返回状态码是否存在且为整型、服务类型是否存在且为整型以及如果服务类型为<code>Service_discover</code>提供的服务是否存在且为字符串是否存在主机信息集且为JSON数组类型。实现如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span>
<span class=normal>59</span>
<span class=normal>60</span>
<span class=normal>61</span>
<span class=normal>62</span>
<span class=normal>63</span>
<span class=normal>64</span>
<span class=normal>65</span>
<span class=normal>66</span>
<span class=normal>67</span>
<span class=normal>68</span>
<span class=normal>69</span>
<span class=normal>70</span>
<span class=normal>71</span>
<span class=normal>72</span>
<span class=normal>73</span>
<span class=normal>74</span>
<span class=normal>75</span>
<span class=normal>76</span>
<span class=normal>77</span>
<span class=normal>78</span>
<span class=normal>79</span>
<span class=normal>80</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-38-1><span class=k>class</span><span class=w> </span><span class=nc>ServiceResponse</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>json_message</span><span class=o>::</span><span class=n>JsonResponse</span>
</span><span id=__span-38-2><span class=p>{</span>
</span><span id=__span-38-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-38-4><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>ServiceResponse</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-38-5>
</span><span id=__span-38-6><span class=w>    </span><span class=c1>// ! 需要实现check</span>
</span><span id=__span-38-7><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=nf>check</span><span class=p>()</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-38-8><span class=w>    </span><span class=p>{</span>
</span><span id=__span-38-9><span class=w>        </span><span class=c1>// 判断返回状态码</span>
</span><span id=__span-38-10><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_RCODE</span><span class=p>].</span><span class=n>isNull</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_RCODE</span><span class=p>].</span><span class=n>isInt</span><span class=p>())</span>
</span><span id=__span-38-11><span class=w>        </span><span class=p>{</span>
</span><span id=__span-38-12><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;返回状态码错误&quot;</span><span class=p>);</span>
</span><span id=__span-38-13><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-38-14><span class=w>        </span><span class=p>}</span>
</span><span id=__span-38-15>
</span><span id=__span-38-16><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_OPTYPE</span><span class=p>].</span><span class=n>isNull</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_OPTYPE</span><span class=p>].</span><span class=n>isInt</span><span class=p>())</span>
</span><span id=__span-38-17><span class=w>        </span><span class=p>{</span>
</span><span id=__span-38-18><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;服务操作类型错误&quot;</span><span class=p>);</span>
</span><span id=__span-38-19><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-38-20><span class=w>        </span><span class=p>}</span>
</span><span id=__span-38-21>
</span><span id=__span-38-22><span class=w>        </span><span class=c1>// 判断操作类型是否存在且为Service_discover</span>
</span><span id=__span-38-23><span class=w>        </span><span class=c1>// 如果存在需要判断是否存在方法名和主机信息数组</span>
</span><span id=__span-38-24><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_OPTYPE</span><span class=p>].</span><span class=n>isInt</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>public_data</span><span class=o>::</span><span class=n>ServiceOptype</span><span class=o>::</span><span class=n>Service_discover</span><span class=p>))</span><span class=w> </span><span class=o>&amp;&amp;</span>
</span><span id=__span-38-25><span class=w>            </span><span class=p>(</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_METHOD</span><span class=p>].</span><span class=n>isNull</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_METHOD</span><span class=p>].</span><span class=n>isString</span><span class=p>())</span><span class=w> </span><span class=o>&amp;&amp;</span>
</span><span id=__span-38-26><span class=w>            </span><span class=p>(</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_HOST</span><span class=p>].</span><span class=n>isNull</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_HOST</span><span class=p>].</span><span class=n>isArray</span><span class=p>()))</span>
</span><span id=__span-38-27><span class=w>        </span><span class=p>{</span>
</span><span id=__span-38-28><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;操作类型为Service_discover，但是返回值错误&quot;</span><span class=p>);</span>
</span><span id=__span-38-29><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-38-30><span class=w>        </span><span class=p>}</span>
</span><span id=__span-38-31>
</span><span id=__span-38-32><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-38-33><span class=w>    </span><span class=p>}</span>
</span><span id=__span-38-34>
</span><span id=__span-38-35><span class=w>    </span><span class=c1>// 设置/获取服务类型</span>
</span><span id=__span-38-36><span class=w>    </span><span class=n>public_data</span><span class=o>::</span><span class=n>ServiceOptype</span><span class=w> </span><span class=nf>getServiceOptype</span><span class=p>()</span>
</span><span id=__span-38-37><span class=w>    </span><span class=p>{</span>
</span><span id=__span-38-38><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>static_cast</span><span class=o>&lt;</span><span class=n>public_data</span><span class=o>::</span><span class=n>ServiceOptype</span><span class=o>&gt;</span><span class=p>(</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_OPTYPE</span><span class=p>].</span><span class=n>asInt</span><span class=p>());</span>
</span><span id=__span-38-39><span class=w>    </span><span class=p>}</span>
</span><span id=__span-38-40>
</span><span id=__span-38-41><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>setServiceOptye</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>public_data</span><span class=o>::</span><span class=n>ServiceOptype</span><span class=o>&amp;</span><span class=w> </span><span class=n>o</span><span class=p>)</span>
</span><span id=__span-38-42><span class=w>    </span><span class=p>{</span>
</span><span id=__span-38-43><span class=w>        </span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_OPTYPE</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>o</span><span class=p>);</span>
</span><span id=__span-38-44><span class=w>    </span><span class=p>}</span>
</span><span id=__span-38-45>
</span><span id=__span-38-46><span class=w>    </span><span class=c1>// 设置/获取方法名和主机信息</span>
</span><span id=__span-38-47><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>setMethod</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>name</span><span class=p>)</span>
</span><span id=__span-38-48><span class=w>    </span><span class=p>{</span>
</span><span id=__span-38-49><span class=w>        </span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_METHOD</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>name</span><span class=p>;</span>
</span><span id=__span-38-50><span class=w>    </span><span class=p>}</span>
</span><span id=__span-38-51>
</span><span id=__span-38-52><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=nf>getMethod</span><span class=p>()</span>
</span><span id=__span-38-53><span class=w>    </span><span class=p>{</span>
</span><span id=__span-38-54><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_METHOD</span><span class=p>].</span><span class=n>asString</span><span class=p>();</span>
</span><span id=__span-38-55><span class=w>    </span><span class=p>}</span>
</span><span id=__span-38-56>
</span><span id=__span-38-57><span class=w>    </span><span class=c1>// ! 注意主机信息是一个数组</span>
</span><span id=__span-38-58><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>setHosts</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>public_data</span><span class=o>::</span><span class=n>host_addr_t</span><span class=o>&gt;</span><span class=w> </span><span class=o>&amp;</span><span class=n>hosts</span><span class=p>)</span>
</span><span id=__span-38-59><span class=w>    </span><span class=p>{</span>
</span><span id=__span-38-60><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>for_each</span><span class=p>(</span><span class=n>hosts</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span><span class=w> </span><span class=n>hosts</span><span class=p>.</span><span class=n>end</span><span class=p>(),</span><span class=w> </span><span class=p>[</span><span class=k>this</span><span class=p>](</span><span class=n>public_data</span><span class=o>::</span><span class=n>host_addr_t</span><span class=w> </span><span class=n>h</span><span class=p>)</span>
</span><span id=__span-38-61><span class=w>        </span><span class=p>{</span>
</span><span id=__span-38-62><span class=w>            </span><span class=n>Json</span><span class=o>::</span><span class=n>Value</span><span class=w> </span><span class=n>host</span><span class=p>;</span>
</span><span id=__span-38-63><span class=w>            </span><span class=n>host</span><span class=p>[</span><span class=n>KEY_HOST_IP</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=n>first</span><span class=p>;</span>
</span><span id=__span-38-64><span class=w>            </span><span class=n>host</span><span class=p>[</span><span class=n>KEY_HOST_PORT</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=n>second</span><span class=p>;</span>
</span><span id=__span-38-65>
</span><span id=__span-38-66><span class=w>            </span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_HOST</span><span class=p>].</span><span class=n>append</span><span class=p>(</span><span class=n>host</span><span class=p>);</span><span class=w> </span>
</span><span id=__span-38-67><span class=w>        </span><span class=p>});</span>
</span><span id=__span-38-68><span class=w>    </span><span class=p>}</span>
</span><span id=__span-38-69>
</span><span id=__span-38-70><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>public_data</span><span class=o>::</span><span class=n>host_addr_t</span><span class=o>&gt;</span><span class=w> </span><span class=n>getHosts</span><span class=p>()</span>
</span><span id=__span-38-71><span class=w>    </span><span class=p>{</span>
</span><span id=__span-38-72><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>public_data</span><span class=o>::</span><span class=n>host_addr_t</span><span class=o>&gt;</span><span class=w> </span><span class=n>hosts</span><span class=p>;</span>
</span><span id=__span-38-73><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_HOST</span><span class=p>].</span><span class=n>size</span><span class=p>();</span>
</span><span id=__span-38-74><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>length</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-38-75><span class=w>            </span><span class=n>hosts</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_HOST</span><span class=p>][</span><span class=n>i</span><span class=p>][</span><span class=n>KEY_HOST_IP</span><span class=p>].</span><span class=n>asString</span><span class=p>(),</span>
</span><span id=__span-38-76><span class=w>                                </span><span class=n>body_</span><span class=p>[</span><span class=n>KEY_HOST</span><span class=p>][</span><span class=n>i</span><span class=p>][</span><span class=n>KEY_HOST_PORT</span><span class=p>].</span><span class=n>asInt</span><span class=p>());</span>
</span><span id=__span-38-77>
</span><span id=__span-38-78><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>hosts</span><span class=p>;</span>
</span><span id=__span-38-79><span class=w>    </span><span class=p>}</span>
</span><span id=__span-38-80><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <h3 id=protocol_1>Protocol派生类设计<a class=headerlink href=#protocol_1 title="Permanent link">&para;</a></h3> <p>根据前面的父类结构，对应的子类需要实现下面三个函数：</p> <ol> <li>缓冲区数据是否可以被处理</li> <li>将消息类中的正文和其他协议格式字段组合构建一个完整的满足协议格式的字符串</li> <li>解析缓冲区中的完整数据</li> </ol> <p>首先考虑「缓冲区数据是否可以被处理」函数，在这个函数中，先<a href=javascript:; class=custom-tooltip data-title=意味着使用不删除数据的读取接口>尝试</a>取出前4个字节的数据，接着，判断读取到的值加上4个字节是否小于等于缓冲区剩余数据大小，如果大于，说明缓冲区的数据不足以处理，否则可以处理。根据这个思路，函数实现如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-39-1><span class=c1>// 有效数据字段长度</span>
</span><span id=__span-39-2><span class=k>const</span><span class=w> </span><span class=kt>int32_t</span><span class=w> </span><span class=n>valid_length_field_length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>4</span><span class=p>;</span>
</span><span id=__span-39-3>
</span><span id=__span-39-4><span class=k>virtual</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=nf>canProcessed</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>base_buffer</span><span class=o>::</span><span class=n>BaseBuffer</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=o>&amp;</span><span class=n>buf</span><span class=p>)</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-39-5><span class=p>{</span>
</span><span id=__span-39-6><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>buf</span><span class=o>-&gt;</span><span class=n>readableSize</span><span class=p>()</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>valid_length_field_length</span><span class=p>)</span>
</span><span id=__span-39-7><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-39-8><span class=w>    </span><span class=c1>// 尝试从获取到缓冲区前4个字节</span>
</span><span id=__span-39-9><span class=w>    </span><span class=kt>int32_t</span><span class=w> </span><span class=n>valid_length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buf</span><span class=o>-&gt;</span><span class=n>peekInt32</span><span class=p>();</span>
</span><span id=__span-39-10><span class=w>    </span><span class=c1>// 计算预期总长度</span>
</span><span id=__span-39-11><span class=w>    </span><span class=kt>int32_t</span><span class=w> </span><span class=n>expect_length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>valid_length</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>valid_length_field_length</span><span class=p>;</span>
</span><span id=__span-39-12><span class=w>    </span><span class=c1>// 获取实际大小</span>
</span><span id=__span-39-13><span class=w>    </span><span class=kt>int32_t</span><span class=w> </span><span class=n>real_length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buf</span><span class=o>-&gt;</span><span class=n>readableSize</span><span class=p>();</span>
</span><span id=__span-39-14>
</span><span id=__span-39-15><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>real_length</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>expect_length</span><span class=p>)</span>
</span><span id=__span-39-16><span class=w>    </span><span class=p>{</span>
</span><span id=__span-39-17><span class=w>        </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;长度不足，无法处理&quot;</span><span class=p>);</span>
</span><span id=__span-39-18><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-39-19><span class=w>    </span><span class=p>}</span>
</span><span id=__span-39-20>
</span><span id=__span-39-21><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-39-22><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>接着考虑构建函数，首先对参数中的消息类成员进行序列化，即调用消息类的序列化接口对<code>body_</code>进行序列化，接着分别设置应用层协议的其他字段，此处需要注意，<strong>凡是涉及到数值类型的都需要转换为网络字节序</strong>，防止在使用<code>peekInt32</code>接口时出现问题。最后，将构建好的数据拼接到结果字符串中，此处也需要注意一点，<strong>凡是涉及到数值类型的不要直接使用<code>to_string</code>转换为字符串</strong>，因为这种转换方式改变了数据的字节表示，在前面的协议约定中，例如请求/响应ID大小，规定为4字节，如果该值的大小为86，则此时转换为字符串即为<code>"86"</code>，大小为2个字节，不符合协议规定。要保证这个问题不会出现，就需要使用<code>append</code>，具体操作为：将待添加的数值转换为<code>const char *</code>类型，将该地址重新解释为<code>char*</code>类型，指定长度为4字节，此时指针就会直接将整型的内存表示（4个字节的二进制数据）原样复制到字符串中，这样在后面获取时就会直接将该二进制表示转换为本机字节序对应的值。根据这个思路，实现如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-40-1><span class=k>virtual</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=nf>constructProtocol</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>base_message</span><span class=o>::</span><span class=n>BaseMessage</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=o>&amp;</span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-40-2><span class=p>{</span>
</span><span id=__span-40-3><span class=w>    </span><span class=c1>// 对每一个字段序列化，需要注意网络字节序的转换，使用htonl</span>
</span><span id=__span-40-4><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>body_str</span><span class=p>;</span>
</span><span id=__span-40-5><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>msg</span><span class=o>-&gt;</span><span class=n>serialize</span><span class=p>(</span><span class=n>body_str</span><span class=p>))</span>
</span><span id=__span-40-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-40-7><span class=w>        </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Error</span><span class=p>,</span><span class=w> </span><span class=s>&quot;序列化失败&quot;</span><span class=p>);</span>
</span><span id=__span-40-8><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&quot;ErrorSerialize&quot;</span><span class=p>;</span>
</span><span id=__span-40-9><span class=w>    </span><span class=p>}</span>
</span><span id=__span-40-10>
</span><span id=__span-40-11><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>msg</span><span class=o>-&gt;</span><span class=n>getReqRespId</span><span class=p>();</span>
</span><span id=__span-40-12><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>mtype</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>htonl</span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int32_t</span><span class=o>&gt;</span><span class=p>(</span><span class=n>msg</span><span class=o>-&gt;</span><span class=n>getMtype</span><span class=p>()));</span>
</span><span id=__span-40-13><span class=w>    </span><span class=kt>int32_t</span><span class=w> </span><span class=n>id_len</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>htonl</span><span class=p>(</span><span class=n>id</span><span class=p>.</span><span class=n>size</span><span class=p>());</span>
</span><span id=__span-40-14><span class=w>    </span><span class=kt>int32_t</span><span class=w> </span><span class=n>h_total_len</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>mtype</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>id_len</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>id</span><span class=p>.</span><span class=n>size</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>body_str</span><span class=p>.</span><span class=n>size</span><span class=p>();</span>
</span><span id=__span-40-15><span class=w>    </span><span class=c1>// 对总长度进行网络字节序转换</span>
</span><span id=__span-40-16><span class=w>    </span><span class=kt>int32_t</span><span class=w> </span><span class=n>n_total_len</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>htonl</span><span class=p>(</span><span class=n>h_total_len</span><span class=p>);</span>
</span><span id=__span-40-17>
</span><span id=__span-40-18><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>result</span><span class=p>;</span>
</span><span id=__span-40-19><span class=w>    </span><span class=n>result</span><span class=p>.</span><span class=n>reserve</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=n>n_total_len</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>h_total_len</span><span class=p>);</span><span class=w> </span><span class=c1>// 提前开辟空间，提高性能</span>
</span><span id=__span-40-20>
</span><span id=__span-40-21><span class=w>    </span><span class=c1>// 构建应用层协议</span>
</span><span id=__span-40-22><span class=w>    </span><span class=n>result</span><span class=p>.</span><span class=n>append</span><span class=p>(</span><span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*&gt;</span><span class=p>(</span><span class=o>&amp;</span><span class=n>n_total_len</span><span class=p>),</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>n_total_len</span><span class=p>));</span>
</span><span id=__span-40-23><span class=w>    </span><span class=n>result</span><span class=p>.</span><span class=n>append</span><span class=p>(</span><span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*&gt;</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mtype</span><span class=p>),</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>mtype</span><span class=p>));</span>
</span><span id=__span-40-24><span class=w>    </span><span class=n>result</span><span class=p>.</span><span class=n>append</span><span class=p>(</span><span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*&gt;</span><span class=p>(</span><span class=o>&amp;</span><span class=n>id_len</span><span class=p>),</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>id_len</span><span class=p>));</span>
</span><span id=__span-40-25><span class=w>    </span><span class=n>result</span><span class=p>.</span><span class=n>append</span><span class=p>(</span><span class=n>id</span><span class=p>);</span>
</span><span id=__span-40-26><span class=w>    </span><span class=n>result</span><span class=p>.</span><span class=n>append</span><span class=p>(</span><span class=n>body_str</span><span class=p>);</span>
</span><span id=__span-40-27>
</span><span id=__span-40-28><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span>
</span><span id=__span-40-29><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>最后考虑解析函数，本次设计的解析函数是<strong>假设用户已经判断数据是可以被处理的，即<code>canProcessed</code>函数返回<code>true</code></strong>，基本思路为从缓冲区依次取出数据，并对正文进行反序列化，将对应的数据存储到消息类对象中。这里涉及到创建消息类对象，在创建消息时可以使用工厂的方式，即提供一个通用的方式创建对象。对于消息类对象来说，其子类非常多，而每一个子类对应着不同的消息类型，所以此处可以根据消息类型来决定创建的子类对象，为了可以保证多态，此处的函数返回值为父类指针类型，实现工厂如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-41-1><span class=c1>// 根据消息类型确定</span>
</span><span id=__span-41-2><span class=k>static</span><span class=w> </span><span class=n>base_message</span><span class=o>::</span><span class=n>BaseMessage</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=nf>messageCreateFactory</span><span class=p>(</span><span class=n>public_data</span><span class=o>::</span><span class=n>MType</span><span class=w> </span><span class=n>mtype</span><span class=p>)</span>
</span><span id=__span-41-3><span class=p>{</span>
</span><span id=__span-41-4><span class=w>    </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>mtype</span><span class=p>)</span>
</span><span id=__span-41-5><span class=w>    </span><span class=p>{</span>
</span><span id=__span-41-6><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=no>public_data</span><span class=o>::</span><span class=no>MType</span><span class=o>::</span><span class=no>Req_rpc</span><span class=p>:</span>
</span><span id=__span-41-7><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>request_message</span><span class=o>::</span><span class=n>RpcRequest</span><span class=o>&gt;</span><span class=p>();</span>
</span><span id=__span-41-8><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=no>public_data</span><span class=o>::</span><span class=no>MType</span><span class=o>::</span><span class=no>Req_topic</span><span class=p>:</span>
</span><span id=__span-41-9><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>request_message</span><span class=o>::</span><span class=n>TopicRequest</span><span class=o>&gt;</span><span class=p>();</span>
</span><span id=__span-41-10><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=no>public_data</span><span class=o>::</span><span class=no>MType</span><span class=o>::</span><span class=no>Req_service</span><span class=p>:</span>
</span><span id=__span-41-11><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>request_message</span><span class=o>::</span><span class=n>ServiceRequest</span><span class=o>&gt;</span><span class=p>();</span>
</span><span id=__span-41-12><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=no>public_data</span><span class=o>::</span><span class=no>MType</span><span class=o>::</span><span class=no>Resp_rpc</span><span class=p>:</span>
</span><span id=__span-41-13><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>response_message</span><span class=o>::</span><span class=n>RpcResponse</span><span class=o>&gt;</span><span class=p>();</span>
</span><span id=__span-41-14><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=no>public_data</span><span class=o>::</span><span class=no>MType</span><span class=o>::</span><span class=no>Resp_topic</span><span class=p>:</span>
</span><span id=__span-41-15><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>response_message</span><span class=o>::</span><span class=n>TopicResponse</span><span class=o>&gt;</span><span class=p>();</span>
</span><span id=__span-41-16><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=no>public_data</span><span class=o>::</span><span class=no>MType</span><span class=o>::</span><span class=no>Resp_service</span><span class=p>:</span>
</span><span id=__span-41-17><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>response_message</span><span class=o>::</span><span class=n>ServiceResponse</span><span class=o>&gt;</span><span class=p>();</span>
</span><span id=__span-41-18><span class=w>    </span><span class=p>}</span>
</span><span id=__span-41-19><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>base_message</span><span class=o>::</span><span class=n>BaseMessage</span><span class=o>::</span><span class=n>ptr</span><span class=p>();</span><span class=w> </span><span class=c1>// 相当于返回nullptr，即shared_ptr&lt;base_message::BaseMessage&gt;();</span>
</span><span id=__span-41-20><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>当然，此处也可以考虑使用可变模板参数，根据指定的子类类型创建消息类对象：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-42-1><span class=k>template</span><span class=o>&lt;</span><span class=k>class</span><span class=w> </span><span class=nc>T</span><span class=p>,</span><span class=w> </span><span class=k>class</span><span class=w> </span><span class=p>...</span><span class=n>Args</span><span class=o>&gt;</span>
</span><span id=__span-42-2><span class=k>static</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>messageCreateFactory</span><span class=p>(</span><span class=n>Args</span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>...</span><span class=n>args</span><span class=p>)</span>
</span><span id=__span-42-3><span class=p>{</span>
</span><span id=__span-42-4><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>forward</span><span class=o>&lt;</span><span class=n>Args</span><span class=o>&gt;</span><span class=p>(</span><span class=n>args</span><span class=p>)...);</span>
</span><span id=__span-42-5><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>有了前面的思路，接下来实现解析函数：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-43-1><span class=k>virtual</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=nf>getContentFromBuffer</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>base_buffer</span><span class=o>::</span><span class=n>BaseBuffer</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=o>&amp;</span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=n>base_message</span><span class=o>::</span><span class=n>BaseMessage</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=o>&amp;</span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-43-2><span class=p>{</span>
</span><span id=__span-43-3><span class=w>    </span><span class=c1>// 从缓冲区中获取每一个字段，默认已经判断数据可以处理</span>
</span><span id=__span-43-4><span class=w>    </span><span class=c1>// 即canProcessed返回true</span>
</span><span id=__span-43-5><span class=w>    </span><span class=kt>int32_t</span><span class=w> </span><span class=n>valid_length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buf</span><span class=o>-&gt;</span><span class=n>readInt32</span><span class=p>();</span>
</span><span id=__span-43-6><span class=w>    </span><span class=kt>int32_t</span><span class=w> </span><span class=n>mtype</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buf</span><span class=o>-&gt;</span><span class=n>readInt32</span><span class=p>();</span>
</span><span id=__span-43-7><span class=w>    </span><span class=kt>int32_t</span><span class=w> </span><span class=n>id_length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buf</span><span class=o>-&gt;</span><span class=n>readInt32</span><span class=p>();</span>
</span><span id=__span-43-8><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buf</span><span class=o>-&gt;</span><span class=n>retrieveAsString</span><span class=p>(</span><span class=n>id_length</span><span class=p>);</span>
</span><span id=__span-43-9><span class=w>    </span><span class=c1>// 正文部分，总长度-有效数据长度字段的长度-消息类型字段的长度-ID字段的长度-ID的长度</span>
</span><span id=__span-43-10><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>body</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buf</span><span class=o>-&gt;</span><span class=n>retrieveAsString</span><span class=p>(</span><span class=n>valid_length</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>mtype</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>id_length</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>id</span><span class=p>.</span><span class=n>size</span><span class=p>());</span>
</span><span id=__span-43-11>
</span><span id=__span-43-12><span class=w>    </span><span class=c1>// 创建消息对象</span>
</span><span id=__span-43-13><span class=w>    </span><span class=c1>// 根据消息类型创建对象</span>
</span><span id=__span-43-14><span class=w>    </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>message_factory</span><span class=o>::</span><span class=n>MessageFactory</span><span class=o>::</span><span class=n>messageCreateFactory</span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=n>public_data</span><span class=o>::</span><span class=n>MType</span><span class=o>&gt;</span><span class=p>(</span><span class=n>mtype</span><span class=p>));</span>
</span><span id=__span-43-15><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>msg</span><span class=p>)</span>
</span><span id=__span-43-16><span class=w>    </span><span class=p>{</span>
</span><span id=__span-43-17><span class=w>        </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Error</span><span class=p>,</span><span class=w> </span><span class=s>&quot;根据消息类型创建消息对象指针失败，指针为空&quot;</span><span class=p>);</span>
</span><span id=__span-43-18><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-43-19><span class=w>    </span><span class=p>}</span>
</span><span id=__span-43-20>
</span><span id=__span-43-21><span class=w>    </span><span class=c1>// 对正文部分进行反序列化，将其中的JSON对象存储到成员body_中</span>
</span><span id=__span-43-22><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>msg</span><span class=o>-&gt;</span><span class=n>deserialize</span><span class=p>(</span><span class=n>body</span><span class=p>))</span>
</span><span id=__span-43-23><span class=w>    </span><span class=p>{</span>
</span><span id=__span-43-24><span class=w>        </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Error</span><span class=p>,</span><span class=w> </span><span class=s>&quot;正文部分反序列化失败&quot;</span><span class=p>);</span>
</span><span id=__span-43-25><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
</span><span id=__span-43-26><span class=w>    </span><span class=p>}</span>
</span><span id=__span-43-27>
</span><span id=__span-43-28><span class=w>    </span><span class=c1>// 设置字段</span>
</span><span id=__span-43-29><span class=w>    </span><span class=n>msg</span><span class=o>-&gt;</span><span class=n>setId</span><span class=p>(</span><span class=n>id</span><span class=p>);</span>
</span><span id=__span-43-30><span class=w>    </span><span class=n>msg</span><span class=o>-&gt;</span><span class=n>setMType</span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=n>public_data</span><span class=o>::</span><span class=n>MType</span><span class=o>&gt;</span><span class=p>(</span><span class=n>mtype</span><span class=p>));</span>
</span><span id=__span-43-31>
</span><span id=__span-43-32><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
</span><span id=__span-43-33><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h3 id=connection_1>Connection派生类设计<a class=headerlink href=#connection_1 title="Permanent link">&para;</a></h3> <p>本次项目中实现的Connection派生类是基于Muduo库实现的，使用到的就是Muduo库中的<code>TcpConnection</code>，需要注意的是，在封装<code>send</code>接口时需要先将参数的消息类对象使用协议类中的构建函数构建出满足协议格式的数据再发送，所以在Connection派生类中除了有<code>TcpConnection</code>成员外，还需要有协议类成员。整体设计如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-44-1><span class=k>class</span><span class=w> </span><span class=nc>MuduoConnection</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>base_connection</span><span class=o>::</span><span class=n>BaseConnection</span>
</span><span id=__span-44-2><span class=p>{</span>
</span><span id=__span-44-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-44-4><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>MuduoConnection</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-44-5>
</span><span id=__span-44-6><span class=w>    </span><span class=n>MuduoConnection</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>base_protocol</span><span class=o>::</span><span class=n>BaseProtocol</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=o>&amp;</span><span class=n>pro</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>TcpConnectionPtr</span><span class=w> </span><span class=o>&amp;</span><span class=n>con</span><span class=p>)</span>
</span><span id=__span-44-7><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=n>pro_</span><span class=p>(</span><span class=n>pro</span><span class=p>),</span><span class=w> </span><span class=n>con_</span><span class=p>(</span><span class=n>con</span><span class=p>)</span>
</span><span id=__span-44-8><span class=w>    </span><span class=p>{</span>
</span><span id=__span-44-9><span class=w>    </span><span class=p>}</span>
</span><span id=__span-44-10>
</span><span id=__span-44-11><span class=w>    </span><span class=c1>// 发送</span>
</span><span id=__span-44-12><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=n>send</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>base_message</span><span class=o>::</span><span class=n>BaseMessage</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=o>&amp;</span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-44-13><span class=w>    </span><span class=p>{</span>
</span><span id=__span-44-14><span class=w>        </span><span class=c1>// 获取待发送的数据</span>
</span><span id=__span-44-15><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>content</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pro_</span><span class=o>-&gt;</span><span class=n>constructProtocol</span><span class=p>(</span><span class=n>msg</span><span class=p>);</span>
</span><span id=__span-44-16><span class=w>        </span><span class=c1>// 调用TcpConnection的发送</span>
</span><span id=__span-44-17><span class=w>        </span><span class=n>con_</span><span class=o>-&gt;</span><span class=n>send</span><span class=p>(</span><span class=n>content</span><span class=p>);</span>
</span><span id=__span-44-18><span class=w>    </span><span class=p>}</span>
</span><span id=__span-44-19><span class=w>    </span><span class=c1>// 关闭连接</span>
</span><span id=__span-44-20><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=n>shutdown</span><span class=p>()</span><span class=w> </span><span class=k>override</span><span class=w> </span>
</span><span id=__span-44-21><span class=w>    </span><span class=p>{</span>
</span><span id=__span-44-22><span class=w>        </span><span class=n>con_</span><span class=o>-&gt;</span><span class=n>shutdown</span><span class=p>();</span>
</span><span id=__span-44-23><span class=w>    </span><span class=p>}</span>
</span><span id=__span-44-24><span class=w>    </span><span class=c1>// 判断连接是否正常</span>
</span><span id=__span-44-25><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=n>connected</span><span class=p>()</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-44-26><span class=w>    </span><span class=p>{</span>
</span><span id=__span-44-27><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>con_</span><span class=o>-&gt;</span><span class=n>connected</span><span class=p>();</span>
</span><span id=__span-44-28><span class=w>    </span><span class=p>}</span>
</span><span id=__span-44-29>
</span><span id=__span-44-30><span class=k>private</span><span class=o>:</span>
</span><span id=__span-44-31><span class=w>    </span><span class=n>base_protocol</span><span class=o>::</span><span class=n>BaseProtocol</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=n>pro_</span><span class=p>;</span><span class=w> </span><span class=c1>// 使用协议中的方法获取到待发送的数据</span>
</span><span id=__span-44-32><span class=w>    </span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>TcpConnectionPtr</span><span class=w> </span><span class=n>con_</span><span class=p>;</span><span class=w>     </span><span class=c1>// 使用Muduo库中的TcpConnection</span>
</span><span id=__span-44-33><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <h3 id=client_1>Client派生类设计<a class=headerlink href=#client_1 title="Permanent link">&para;</a></h3> <p>本次项目中实现的Client派生类是基于Muduo库实现的，所以在Client派生类中少不了需要使用到Muduo库中的<code>TcpClient</code>，而对于创建一个<code>TcpClient</code>需要用到其他相关的组件，此处不具体介绍，详细见<a href=https://www.help-doc.top/%E5%85%B6%E5%AE%83/%E5%85%B3%E4%BA%8EMuduo%E5%BA%93/%E5%85%B3%E4%BA%8EMuduo%E5%BA%93.html>关于Muduo库</a>，除了需要的组件外，还需要创建出协议类成员，在调用连接建立回调函数时需要创建连接对象和收到消息处理时的回调函数时需要对消息进行解析</p> <p>除了回调函数以外，基本的设计思路参考<a href=https://www.help-doc.top/%E5%85%B6%E5%AE%83/%E5%85%B3%E4%BA%8EMuduo%E5%BA%93/%E5%85%B3%E4%BA%8EMuduo%E5%BA%93.html>关于Muduo库</a>设计客户端的思想，基本实现如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span>
<span class=normal>59</span>
<span class=normal>60</span>
<span class=normal>61</span>
<span class=normal>62</span>
<span class=normal>63</span>
<span class=normal>64</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-45-1><span class=k>class</span><span class=w> </span><span class=nc>MuduoClient</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>base_client</span><span class=o>::</span><span class=n>BaseClient</span>
</span><span id=__span-45-2><span class=p>{</span>
</span><span id=__span-45-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-45-4><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>MuduoClient</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-45-5><span class=w>    </span><span class=n>MuduoClient</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=o>&amp;</span><span class=n>ip</span><span class=p>,</span><span class=w> </span><span class=kt>uint16_t</span><span class=w> </span><span class=n>port</span><span class=p>)</span>
</span><span id=__span-45-6><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=n>loop_</span><span class=p>(</span><span class=n>loopThread_</span><span class=p>.</span><span class=n>startLoop</span><span class=p>()),</span><span class=w> </span><span class=n>client_</span><span class=p>(</span><span class=n>loop_</span><span class=p>,</span><span class=w> </span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>InetAddress</span><span class=p>(</span><span class=n>ip</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>),</span><span class=w> </span><span class=s>&quot;MuduoClient&quot;</span><span class=p>),</span>
</span><span id=__span-45-7><span class=w>            </span><span class=n>pro_</span><span class=p>(</span><span class=n>protocol_factory</span><span class=o>::</span><span class=n>ProtocolFactory</span><span class=o>::</span><span class=n>createProtocolFactory</span><span class=p>()),</span>
</span><span id=__span-45-8><span class=w>            </span><span class=n>count_</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=c1>// 确保客户端在连接建立成功后发送消息</span>
</span><span id=__span-45-9><span class=w>    </span><span class=p>{</span>
</span><span id=__span-45-10><span class=w>        </span><span class=c1>// 设置回调函数</span>
</span><span id=__span-45-11><span class=w>        </span><span class=c1>// 1. 连接回调</span>
</span><span id=__span-45-12><span class=w>        </span><span class=n>client_</span><span class=p>.</span><span class=n>setConnectionCallback</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>bind</span><span class=p>(</span><span class=o>&amp;</span><span class=n>MuduoClient</span><span class=o>::</span><span class=n>connectionCallback</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>placeholders</span><span class=o>::</span><span class=n>_1</span><span class=p>));</span>
</span><span id=__span-45-13><span class=w>        </span><span class=c1>// 2. 消息回调</span>
</span><span id=__span-45-14><span class=w>        </span><span class=n>client_</span><span class=p>.</span><span class=n>setMessageCallback</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>bind</span><span class=p>(</span><span class=o>&amp;</span><span class=n>MuduoClient</span><span class=o>::</span><span class=n>messgaeCallback</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>placeholders</span><span class=o>::</span><span class=n>_1</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>placeholders</span><span class=o>::</span><span class=n>_2</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>placeholders</span><span class=o>::</span><span class=n>_3</span><span class=p>));</span>
</span><span id=__span-45-15><span class=w>    </span><span class=p>}</span>
</span><span id=__span-45-16>
</span><span id=__span-45-17><span class=w>    </span><span class=c1>// 连接服务端</span>
</span><span id=__span-45-18><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=n>connect</span><span class=p>()</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-45-19><span class=w>    </span><span class=p>{</span>
</span><span id=__span-45-20><span class=w>        </span><span class=n>client_</span><span class=p>.</span><span class=n>connect</span><span class=p>();</span>
</span><span id=__span-45-21><span class=w>        </span><span class=c1>// 客户端开始在同步计数器等待，防止未连接时发送信息</span>
</span><span id=__span-45-22><span class=w>        </span><span class=n>count_</span><span class=p>.</span><span class=n>wait</span><span class=p>();</span>
</span><span id=__span-45-23><span class=w>    </span><span class=p>}</span>
</span><span id=__span-45-24>
</span><span id=__span-45-25><span class=w>    </span><span class=c1>// 关闭连接</span>
</span><span id=__span-45-26><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=n>shutdown</span><span class=p>()</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-45-27><span class=w>    </span><span class=p>{</span>
</span><span id=__span-45-28><span class=w>        </span><span class=c1>// 调用TcpClient的断开接口</span>
</span><span id=__span-45-29><span class=w>        </span><span class=n>client_</span><span class=p>.</span><span class=n>disconnect</span><span class=p>();</span>
</span><span id=__span-45-30><span class=w>    </span><span class=p>}</span>
</span><span id=__span-45-31>
</span><span id=__span-45-32><span class=w>    </span><span class=c1>// 获取连接对象</span>
</span><span id=__span-45-33><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=n>base_connection</span><span class=o>::</span><span class=n>BaseConnection</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=n>connection</span><span class=p>()</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-45-34><span class=w>    </span><span class=p>{</span>
</span><span id=__span-45-35><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>con_</span><span class=p>;</span>
</span><span id=__span-45-36><span class=w>    </span><span class=p>}</span>
</span><span id=__span-45-37>
</span><span id=__span-45-38><span class=w>    </span><span class=c1>// 判断是否连接</span>
</span><span id=__span-45-39><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=n>connected</span><span class=p>()</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-45-40><span class=w>    </span><span class=p>{</span>
</span><span id=__span-45-41><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>con_</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>con_</span><span class=o>-&gt;</span><span class=n>connected</span><span class=p>();</span>
</span><span id=__span-45-42><span class=w>    </span><span class=p>}</span>
</span><span id=__span-45-43>
</span><span id=__span-45-44><span class=k>private</span><span class=o>:</span>
</span><span id=__span-45-45><span class=w>    </span><span class=c1>// 连接回调函数</span>
</span><span id=__span-45-46><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>connectionCallback</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>TcpConnectionPtr</span><span class=w> </span><span class=o>&amp;</span><span class=n>con</span><span class=p>)</span>
</span><span id=__span-45-47><span class=w>    </span><span class=p>{</span>
</span><span id=__span-45-48>
</span><span id=__span-45-49><span class=w>    </span><span class=p>}</span>
</span><span id=__span-45-50>
</span><span id=__span-45-51><span class=w>    </span><span class=c1>// 收到消息时的回调</span>
</span><span id=__span-45-52><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>messgaeCallback</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>TcpConnectionPtr</span><span class=w> </span><span class=o>&amp;</span><span class=n>con</span><span class=p>,</span><span class=w> </span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>Buffer</span><span class=w> </span><span class=o>*</span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=n>muduo</span><span class=o>::</span><span class=n>Timestamp</span><span class=w> </span><span class=n>t</span><span class=p>)</span>
</span><span id=__span-45-53><span class=w>    </span><span class=p>{</span>
</span><span id=__span-45-54>
</span><span id=__span-45-55><span class=w>    </span><span class=p>}</span>
</span><span id=__span-45-56>
</span><span id=__span-45-57><span class=k>private</span><span class=o>:</span>
</span><span id=__span-45-58><span class=w>    </span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>EventLoopThread</span><span class=w> </span><span class=n>loopThread_</span><span class=p>;</span>
</span><span id=__span-45-59><span class=w>    </span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>EventLoop</span><span class=w> </span><span class=o>*</span><span class=n>loop_</span><span class=p>;</span>
</span><span id=__span-45-60><span class=w>    </span><span class=n>base_connection</span><span class=o>::</span><span class=n>BaseConnection</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=n>con_</span><span class=p>;</span>
</span><span id=__span-45-61><span class=w>    </span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>TcpClient</span><span class=w> </span><span class=n>client_</span><span class=p>;</span>
</span><span id=__span-45-62><span class=w>    </span><span class=n>muduo</span><span class=o>::</span><span class=n>CountDownLatch</span><span class=w> </span><span class=n>count_</span><span class=p>;</span>
</span><span id=__span-45-63><span class=w>    </span><span class=n>base_protocol</span><span class=o>::</span><span class=n>BaseProtocol</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=n>pro_</span><span class=p>;</span>
</span><span id=__span-45-64><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>这里需要注意两个问题：</p> <ol> <li>管理<code>EventLoop</code>对象时不要使用智能指针，因为这个对象的销毁和创建并不是由当前类管理的，属于「借用」资源，而不是「拥有」资源，对于这种借用资源直接使用普通指针即可</li> <li><strong>一定要保证<code>BaseConnection</code>指针声明在<code>TcpClient</code>对象之前，这样可以确保先析构<code>TcpClient</code>对象，再析构<code>BaseConnection</code></strong>，因为<code>TcpClient</code>对象析构时会调用连接断开的回调函数，该函数内部会访问连接对象，一旦这个连接对象先被析构了就是野指针访问了，如果<code>reset</code>函数内部不进行对解引用操作，那么就算空指针调用函数也不会因为有问题，但是<code>reset</code>内部会进行<code>*this</code>，而此时<code>this</code>为<code>nullptr</code>，所以如果<code>BaseConnection</code>指针声明在<code>TcpClient</code>对象之后就会出现野指针错误</li> </ol> <p>下面重点介绍两个回调函数的设计：</p> <ol> <li>连接回调函数：当连接建立时，需要创建一个Connection派生类对象，这个对象依赖于两个成员：<code>Protocol</code>派生类成员和<code>TcpConnection</code>成员，当连接断开时需要释放Connection派生类对象</li> <li>消息处理回调函数：当客户端收到消息时，需要调用Protocol派生类的解析函数从Buffer派生类中获取到有效数据存储到消息类对象中，整个过程是一个死循环，直到缓冲区的数据不足以被处理为止，处理完消息后，就可以调用消息回调函数处理拿到的消息</li> </ol> <p>为了更方便创建出对象并且在后续修改构造函数时不需要多个文件之间来回改变，根据上面的两个函数的设计思路可以设计出三个工厂：创建Protocol派生类成员工厂、创建出Connection派生类工厂以及创建出Buffer派生类工厂。三者创建方式基本一致，为了保证可以实现多态，此处函数的返回值应为派生类对应的基类而非固定的派生类，实现如下：</p> <div class="tabbed-set tabbed-alternate" data-tabs=6:3><input checked=checked id=__tabbed_6_1 name=__tabbed_6 type=radio><input id=__tabbed_6_2 name=__tabbed_6 type=radio><input id=__tabbed_6_3 name=__tabbed_6 type=radio><div class=tabbed-labels><label for=__tabbed_6_1>Protocol派生类工厂</label><label for=__tabbed_6_2>Connection派生类工厂</label><label for=__tabbed_6_3>Buffer派生类工厂</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-46-1><span class=k>class</span><span class=w> </span><span class=nc>ProtocolFactory</span>
</span><span id=__span-46-2><span class=p>{</span>
</span><span id=__span-46-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-46-4><span class=w>    </span><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>class</span><span class=w> </span><span class=p>...</span><span class=n>Args</span><span class=o>&gt;</span>
</span><span id=__span-46-5><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=n>base_protocol</span><span class=o>::</span><span class=n>BaseProtocol</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=n>createProtocolFactory</span><span class=p>(</span><span class=n>Args</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=p>...</span><span class=n>args</span><span class=p>)</span>
</span><span id=__span-46-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-46-7><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>length_value_protocol</span><span class=o>::</span><span class=n>LengthValueProtocol</span><span class=o>&gt;</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>forward</span><span class=o>&lt;</span><span class=n>Args</span><span class=o>&gt;</span><span class=p>(</span><span class=n>args</span><span class=p>)...);</span>
</span><span id=__span-46-8><span class=w>    </span><span class=p>}</span>
</span><span id=__span-46-9><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-47-1><span class=k>class</span><span class=w> </span><span class=nc>ConnectionFactory</span>
</span><span id=__span-47-2><span class=p>{</span>
</span><span id=__span-47-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-47-4><span class=w>    </span><span class=k>template</span><span class=o>&lt;</span><span class=k>class</span><span class=w> </span><span class=p>...</span><span class=n>Args</span><span class=o>&gt;</span>
</span><span id=__span-47-5><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=n>base_connection</span><span class=o>::</span><span class=n>BaseConnection</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=n>createConnectionFactory</span><span class=p>(</span><span class=n>Args</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>...</span><span class=n>args</span><span class=p>)</span>
</span><span id=__span-47-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-47-7><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>muduo_connection</span><span class=o>::</span><span class=n>MuduoConnection</span><span class=o>&gt;</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>forward</span><span class=o>&lt;</span><span class=n>Args</span><span class=o>&gt;</span><span class=p>(</span><span class=n>args</span><span class=p>)...);</span>
</span><span id=__span-47-8><span class=w>    </span><span class=p>}</span>
</span><span id=__span-47-9><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-48-1><span class=c1>// 缓冲区工厂</span>
</span><span id=__span-48-2><span class=k>class</span><span class=w> </span><span class=nc>BufferFactory</span>
</span><span id=__span-48-3><span class=p>{</span>
</span><span id=__span-48-4><span class=k>public</span><span class=o>:</span>
</span><span id=__span-48-5><span class=w>    </span><span class=k>template</span><span class=o>&lt;</span><span class=k>class</span><span class=w> </span><span class=p>...</span><span class=n>Args</span><span class=o>&gt;</span>
</span><span id=__span-48-6><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=n>base_buffer</span><span class=o>::</span><span class=n>BaseBuffer</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=n>bufferCreateFactory</span><span class=p>(</span><span class=n>Args</span><span class=o>&amp;&amp;</span><span class=p>...</span><span class=w> </span><span class=n>args</span><span class=p>)</span>
</span><span id=__span-48-7><span class=w>    </span><span class=p>{</span>
</span><span id=__span-48-8><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>muduo_buffer</span><span class=o>::</span><span class=n>MuduoBuffer</span><span class=o>&gt;</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>forward</span><span class=o>&lt;</span><span class=n>Args</span><span class=o>&gt;</span><span class=p>(</span><span class=n>args</span><span class=p>)...);</span>
</span><span id=__span-48-9><span class=w>    </span><span class=p>}</span>
</span><span id=__span-48-10><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>有了上面的工厂和思路后，接下来设计连接回调和消息回调：</p> <div class="tabbed-set tabbed-alternate" data-tabs=7:2><input checked=checked id=__tabbed_7_1 name=__tabbed_7 type=radio><input id=__tabbed_7_2 name=__tabbed_7 type=radio><div class=tabbed-labels><label for=__tabbed_7_1>连接回调</label><label for=__tabbed_7_2>消息回调</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-49-1><span class=kt>void</span><span class=w> </span><span class=nf>connectionCallback</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>TcpConnectionPtr</span><span class=w> </span><span class=o>&amp;</span><span class=n>con</span><span class=p>)</span>
</span><span id=__span-49-2><span class=p>{</span>
</span><span id=__span-49-3><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>con</span><span class=o>-&gt;</span><span class=n>connected</span><span class=p>())</span>
</span><span id=__span-49-4><span class=w>    </span><span class=p>{</span>
</span><span id=__span-49-5><span class=w>        </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Info</span><span class=p>,</span><span class=w> </span><span class=s>&quot;客户端连接成功&quot;</span><span class=p>);</span>
</span><span id=__span-49-6><span class=w>        </span><span class=c1>// 设置连接对象指针，便于接下来调用send</span>
</span><span id=__span-49-7><span class=w>        </span><span class=n>con_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connection_factory</span><span class=o>::</span><span class=n>ConnectionFactory</span><span class=o>::</span><span class=n>createConnectionFactory</span><span class=p>(</span><span class=n>pro_</span><span class=p>,</span><span class=w> </span><span class=n>con</span><span class=p>);</span>
</span><span id=__span-49-8><span class=w>        </span><span class=c1>// 更改同步计数器，减到0表示成功连接，唤醒客户端，可以进行消息发送</span>
</span><span id=__span-49-9><span class=w>        </span><span class=n>count_</span><span class=p>.</span><span class=n>countDown</span><span class=p>();</span>
</span><span id=__span-49-10><span class=w>    </span><span class=p>}</span>
</span><span id=__span-49-11><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>con</span><span class=o>-&gt;</span><span class=n>disconnected</span><span class=p>())</span>
</span><span id=__span-49-12><span class=w>    </span><span class=p>{</span>
</span><span id=__span-49-13><span class=w>        </span><span class=n>con_</span><span class=p>.</span><span class=n>reset</span><span class=p>();</span><span class=w> </span><span class=c1>// 重置连接指针</span>
</span><span id=__span-49-14><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;客户端断开连接&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span><span id=__span-49-15><span class=w>    </span><span class=p>}</span>
</span><span id=__span-49-16><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-50-1><span class=kt>void</span><span class=w> </span><span class=nf>messgaeCallback</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>TcpConnectionPtr</span><span class=w> </span><span class=o>&amp;</span><span class=n>con</span><span class=p>,</span><span class=w> </span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>Buffer</span><span class=w> </span><span class=o>*</span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=n>muduo</span><span class=o>::</span><span class=n>Timestamp</span><span class=w> </span><span class=n>t</span><span class=p>)</span>
</span><span id=__span-50-2><span class=p>{</span>
</span><span id=__span-50-3><span class=w>    </span><span class=c1>// 创建出BaseBuffer对象</span>
</span><span id=__span-50-4><span class=w>    </span><span class=n>base_buffer</span><span class=o>::</span><span class=n>BaseBuffer</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=n>b_buffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buffer_factory</span><span class=o>::</span><span class=n>BufferFactory</span><span class=o>::</span><span class=n>bufferCreateFactory</span><span class=p>(</span><span class=n>buffer</span><span class=p>);</span>
</span><span id=__span-50-5>
</span><span id=__span-50-6><span class=w>    </span><span class=c1>// 判断缓冲区中的数据是否可以处理（数据不会过小，也不会过大）</span>
</span><span id=__span-50-7><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-50-8><span class=w>    </span><span class=p>{</span>
</span><span id=__span-50-9><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>pro_</span><span class=o>-&gt;</span><span class=n>canProcessed</span><span class=p>(</span><span class=n>b_buffer</span><span class=p>))</span>
</span><span id=__span-50-10><span class=w>        </span><span class=p>{</span>
</span><span id=__span-50-11><span class=w>            </span><span class=c1>// 无法处理时也有可能是数据过大</span>
</span><span id=__span-50-12><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>b_buffer</span><span class=o>-&gt;</span><span class=n>readableSize</span><span class=p>()</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>public_data</span><span class=o>::</span><span class=n>max_data_size</span><span class=p>)</span>
</span><span id=__span-50-13><span class=w>            </span><span class=p>{</span>
</span><span id=__span-50-14><span class=w>                </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;数据过大，无法处理&quot;</span><span class=p>);</span>
</span><span id=__span-50-15><span class=w>                </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-50-16><span class=w>            </span><span class=p>}</span>
</span><span id=__span-50-17>
</span><span id=__span-50-18><span class=w>            </span><span class=c1>// 否则就是数据过小（无法满足LV协议格式的处理规则）</span>
</span><span id=__span-50-19><span class=w>            </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-50-20><span class=w>        </span><span class=p>}</span>
</span><span id=__span-50-21>
</span><span id=__span-50-22><span class=w>        </span><span class=c1>// 创建BaseMessage对象指针，交给BaseProtocol中的反序列化接口创建对象</span>
</span><span id=__span-50-23><span class=w>        </span><span class=n>base_message</span><span class=o>::</span><span class=n>BaseMessage</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=n>b_msg</span><span class=p>;</span>
</span><span id=__span-50-24><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>pro_</span><span class=o>-&gt;</span><span class=n>getContentFromBuffer</span><span class=p>(</span><span class=n>b_buffer</span><span class=p>,</span><span class=w> </span><span class=n>b_msg</span><span class=p>))</span>
</span><span id=__span-50-25><span class=w>        </span><span class=p>{</span>
</span><span id=__span-50-26><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;反序列化处理失败&quot;</span><span class=p>);</span>
</span><span id=__span-50-27><span class=w>            </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-50-28><span class=w>        </span><span class=p>}</span>
</span><span id=__span-50-29>
</span><span id=__span-50-30><span class=w>        </span><span class=c1>// 如果设置了回调函数就处理</span>
</span><span id=__span-50-31><span class=w>        </span><span class=c1>// 处理收到的消息</span>
</span><span id=__span-50-32><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cb_message_</span><span class=p>)</span>
</span><span id=__span-50-33><span class=w>            </span><span class=n>cb_message_</span><span class=p>(</span><span class=n>con_</span><span class=p>,</span><span class=w> </span><span class=n>b_msg</span><span class=p>);</span>
</span><span id=__span-50-34><span class=w>    </span><span class=p>}</span>
</span><span id=__span-50-35><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>同样，为了便于创建客户端对象，提供对应的工厂：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-51-1><span class=k>class</span><span class=w> </span><span class=nc>ClientFactory</span>
</span><span id=__span-51-2><span class=p>{</span>
</span><span id=__span-51-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-51-4><span class=w>    </span><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>class</span><span class=p>...</span><span class=w> </span><span class=n>Args</span><span class=o>&gt;</span>
</span><span id=__span-51-5><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=n>base_client</span><span class=o>::</span><span class=n>BaseClient</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=n>clientCreateFactory</span><span class=p>(</span><span class=n>Args</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=p>...</span><span class=n>args</span><span class=p>)</span>
</span><span id=__span-51-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-51-7><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>muduo_client</span><span class=o>::</span><span class=n>MuduoClient</span><span class=o>&gt;</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>forward</span><span class=o>&lt;</span><span class=n>Args</span><span class=o>&gt;</span><span class=p>(</span><span class=n>args</span><span class=p>)...);</span>
</span><span id=__span-51-8><span class=w>    </span><span class=p>}</span>
</span><span id=__span-51-9><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <h3 id=server_1>Server派生类设计<a class=headerlink href=#server_1 title="Permanent link">&para;</a></h3> <p>本次项目中实现的Server派生类是基于Muduo库实现的，所以在Server派生类中少不了需要使用到Muduo库中的<code>TcpServer</code>，而对于创建一个<code>TcpServer</code>需要用到其他相关的组件，此处不具体介绍，详细见<a href=https://www.help-doc.top/%E5%85%B6%E5%AE%83/%E5%85%B3%E4%BA%8EMuduo%E5%BA%93/%E5%85%B3%E4%BA%8EMuduo%E5%BA%93.html>关于Muduo库</a>，除了需要的组件外，还需要创建出协议类成员，在调用连接建立回调函数时需要创建连接对象和收到消息处理时的回调函数时需要对消息进行解析</p> <p>除了上面提到的内容，服务端与客户端还有一个不同之处，客户端只需要管理自己的连接，但是服务端需要管理多个客户端连接，所以此处还需要一张哈希表，用于建立TcpConnection类对象和BaseConnection派生类对象的联系</p> <p>除了回调函数以外，基本的设计思路参考<a href=https://www.help-doc.top/%E5%85%B6%E5%AE%83/%E5%85%B3%E4%BA%8EMuduo%E5%BA%93/%E5%85%B3%E4%BA%8EMuduo%E5%BA%93.html>关于Muduo库</a>设计服务端思想，基本结构如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-52-1><span class=k>class</span><span class=w> </span><span class=nc>MuduoServer</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>base_server</span><span class=o>::</span><span class=n>BaseServer</span>
</span><span id=__span-52-2><span class=p>{</span>
</span><span id=__span-52-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-52-4><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>MuduoServer</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-52-5>
</span><span id=__span-52-6><span class=w>    </span><span class=n>MuduoServer</span><span class=p>(</span><span class=kt>uint16_t</span><span class=w> </span><span class=n>port</span><span class=p>)</span>
</span><span id=__span-52-7><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=n>server_</span><span class=p>(</span><span class=n>loop_</span><span class=p>.</span><span class=n>get</span><span class=p>(),</span>
</span><span id=__span-52-8><span class=w>                    </span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>InetAddress</span><span class=p>(</span><span class=s>&quot;0.0.0.0&quot;</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>),</span>
</span><span id=__span-52-9><span class=w>                    </span><span class=s>&quot;dict_server&quot;</span><span class=p>,</span>
</span><span id=__span-52-10><span class=w>                    </span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>TcpServer</span><span class=o>::</span><span class=n>kReusePort</span><span class=p>),</span>
</span><span id=__span-52-11><span class=w>            </span><span class=n>loop_</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>EventLoop</span><span class=o>&gt;</span><span class=p>()),</span>
</span><span id=__span-52-12><span class=w>            </span><span class=n>pro_</span><span class=p>(</span><span class=n>protocol_factory</span><span class=o>::</span><span class=n>ProtocolFactory</span><span class=o>::</span><span class=n>createProtocolFactory</span><span class=p>())</span>
</span><span id=__span-52-13><span class=w>    </span><span class=p>{</span>
</span><span id=__span-52-14><span class=w>        </span><span class=c1>// 设置回调</span>
</span><span id=__span-52-15><span class=w>        </span><span class=c1>// 1. 连接回调</span>
</span><span id=__span-52-16><span class=w>        </span><span class=n>server_</span><span class=p>.</span><span class=n>setConnectionCallback</span><span class=p>([</span><span class=k>this</span><span class=p>](</span><span class=k>const</span><span class=w> </span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>TcpConnectionPtr</span><span class=w> </span><span class=o>&amp;</span><span class=n>con</span><span class=p>)</span>
</span><span id=__span-52-17><span class=w>                                        </span><span class=p>{</span><span class=w> </span><span class=k>this</span><span class=o>-&gt;</span><span class=n>connectionCallback</span><span class=p>(</span><span class=n>con</span><span class=p>);</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-52-18><span class=w>        </span><span class=c1>// 2. 消息回调</span>
</span><span id=__span-52-19><span class=w>        </span><span class=n>server_</span><span class=p>.</span><span class=n>setMessageCallback</span><span class=p>([</span><span class=k>this</span><span class=p>](</span><span class=k>const</span><span class=w> </span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>TcpConnectionPtr</span><span class=w> </span><span class=o>&amp;</span><span class=n>con</span><span class=p>,</span><span class=w> </span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>Buffer</span><span class=w> </span><span class=o>*</span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=n>muduo</span><span class=o>::</span><span class=n>Timestamp</span><span class=w> </span><span class=n>t</span><span class=p>)</span>
</span><span id=__span-52-20><span class=w>                                    </span><span class=p>{</span><span class=w> </span><span class=k>this</span><span class=o>-&gt;</span><span class=n>messageCallback</span><span class=p>(</span><span class=n>con</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>);</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-52-21><span class=w>    </span><span class=p>}</span>
</span><span id=__span-52-22>
</span><span id=__span-52-23><span class=w>    </span><span class=c1>// 启动服务器</span>
</span><span id=__span-52-24><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=n>start</span><span class=p>()</span><span class=w> </span><span class=k>override</span>
</span><span id=__span-52-25><span class=w>    </span><span class=p>{</span>
</span><span id=__span-52-26><span class=w>        </span><span class=n>server_</span><span class=p>.</span><span class=n>start</span><span class=p>();</span>
</span><span id=__span-52-27><span class=w>        </span><span class=n>loop_</span><span class=o>-&gt;</span><span class=n>loop</span><span class=p>();</span>
</span><span id=__span-52-28><span class=w>    </span><span class=p>}</span>
</span><span id=__span-52-29>
</span><span id=__span-52-30><span class=k>private</span><span class=o>:</span>
</span><span id=__span-52-31><span class=w>    </span><span class=c1>// 连接回调函数，用于管理TcpConnection和BaseConnection</span>
</span><span id=__span-52-32><span class=w>    </span><span class=c1>// 连接建立成功，则创建BaseConnection对象并将对应地{TcpConnection, BaseConnection}插入到哈希表中，再根据是否设置连接回调函数选择是否执行该函数</span>
</span><span id=__span-52-33><span class=w>    </span><span class=c1>// 连接断开时，需要将BaseConnection对象从哈希表中移除，并根据是否设置连接关闭回调函数选择是否执行该函数</span>
</span><span id=__span-52-34><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>connectionCallback</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>TcpConnectionPtr</span><span class=w> </span><span class=o>&amp;</span><span class=n>con</span><span class=p>)</span>
</span><span id=__span-52-35><span class=w>    </span><span class=p>{</span>
</span><span id=__span-52-36>
</span><span id=__span-52-37><span class=w>    </span><span class=p>}</span>
</span><span id=__span-52-38>
</span><span id=__span-52-39><span class=w>    </span><span class=c1>// 客户端发送消息时的处理</span>
</span><span id=__span-52-40><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>messageCallback</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>TcpConnectionPtr</span><span class=w> </span><span class=o>&amp;</span><span class=n>con</span><span class=p>,</span><span class=w> </span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>Buffer</span><span class=w> </span><span class=o>*</span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=n>muduo</span><span class=o>::</span><span class=n>Timestamp</span><span class=w> </span><span class=n>t</span><span class=p>)</span>
</span><span id=__span-52-41><span class=w>    </span><span class=p>{</span>
</span><span id=__span-52-42>
</span><span id=__span-52-43><span class=w>    </span><span class=p>}</span>
</span><span id=__span-52-44>
</span><span id=__span-52-45><span class=k>private</span><span class=o>:</span>
</span><span id=__span-52-46><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>EventLoop</span><span class=o>&gt;</span><span class=w> </span><span class=n>loop_</span><span class=p>;</span><span class=w> </span><span class=c1>// 事件模型，先初始化</span>
</span><span id=__span-52-47><span class=w>    </span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>TcpServer</span><span class=w> </span><span class=n>server_</span><span class=p>;</span><span class=w>                </span><span class=c1>// 服务器</span>
</span><span id=__span-52-48><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unordered_map</span><span class=o>&lt;</span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>TcpConnectionPtr</span><span class=p>,</span><span class=w> </span><span class=n>base_connection</span><span class=o>::</span><span class=n>BaseConnection</span><span class=o>::</span><span class=n>ptr</span><span class=o>&gt;</span><span class=w> </span><span class=n>tcp_cons_</span><span class=p>;</span><span class=w> </span><span class=c1>// Muduo链接和封装连接进行映射，用于管理连接结构</span>
</span><span id=__span-52-49><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>manage_map_mtx_</span><span class=p>;</span><span class=w> </span><span class=c1>// 管理哈希表保证线程安全</span>
</span><span id=__span-52-50><span class=w>    </span><span class=n>base_protocol</span><span class=o>::</span><span class=n>BaseProtocol</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=n>pro_</span><span class=p>;</span><span class=w> </span><span class=c1>// 创建MuduoConnection时需要</span>
</span><span id=__span-52-51><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>接着，考虑回调函数的设计，对于服务端来说，一旦检测到客户端成功建立连接，就需要创建对应的Connection派生类对象并将其添加到哈希表中，如果设置了连接成功处理回调就调用该函数处理，而连接断开时，就需要将该连接从哈希表中移除，如果设置了断开连接处理回调函数就调用该函数处理，而消息处理回调与客户端基本一致，额外需要注意的是，在调用消息处理回调时，需要从哈希表中获取到Connection派生类对象，如果此时没有获取到，说明不存在该连接或者连接异常，此时需要断开连接以免后续出现其他问题。根据这个思路，两个回调函数设计如下：</p> <div class="tabbed-set tabbed-alternate" data-tabs=8:2><input checked=checked id=__tabbed_8_1 name=__tabbed_8 type=radio><input id=__tabbed_8_2 name=__tabbed_8 type=radio><div class=tabbed-labels><label for=__tabbed_8_1>连接处理回调</label><label for=__tabbed_8_2>消息处理回调</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-53-1><span class=kt>void</span><span class=w> </span><span class=nf>connectionCallback</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>TcpConnectionPtr</span><span class=w> </span><span class=o>&amp;</span><span class=n>con</span><span class=p>)</span>
</span><span id=__span-53-2><span class=p>{</span>
</span><span id=__span-53-3><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>con</span><span class=o>-&gt;</span><span class=n>connected</span><span class=p>())</span>
</span><span id=__span-53-4><span class=w>    </span><span class=p>{</span>
</span><span id=__span-53-5><span class=w>        </span><span class=c1>// 创建BaseConnection对象</span>
</span><span id=__span-53-6><span class=w>        </span><span class=n>base_connection</span><span class=o>::</span><span class=n>BaseConnection</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=n>b_con</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connection_factory</span><span class=o>::</span><span class=n>ConnectionFactory</span><span class=o>::</span><span class=n>createConnectionFactory</span><span class=p>(</span><span class=n>pro_</span><span class=p>,</span><span class=w> </span><span class=n>con</span><span class=p>);</span>
</span><span id=__span-53-7><span class=w>        </span><span class=p>{</span>
</span><span id=__span-53-8><span class=w>            </span><span class=c1>// 插入到哈希表</span>
</span><span id=__span-53-9><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock</span><span class=p>(</span><span class=n>manage_map_mtx_</span><span class=p>);</span>
</span><span id=__span-53-10><span class=w>            </span><span class=n>tcp_cons_</span><span class=p>.</span><span class=n>insert</span><span class=p>({</span><span class=n>con</span><span class=p>,</span><span class=w> </span><span class=n>b_con</span><span class=p>});</span>
</span><span id=__span-53-11><span class=w>        </span><span class=p>}</span>
</span><span id=__span-53-12>
</span><span id=__span-53-13><span class=w>        </span><span class=c1>// 如果设置了回调就调用</span>
</span><span id=__span-53-14><span class=w>        </span><span class=c1>// 处理连接</span>
</span><span id=__span-53-15><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>cb_connection_</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-53-16><span class=w>            </span><span class=n>cb_connection_</span><span class=p>(</span><span class=n>b_con</span><span class=p>);</span>
</span><span id=__span-53-17><span class=w>    </span><span class=p>}</span>
</span><span id=__span-53-18><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>con</span><span class=o>-&gt;</span><span class=n>disconnected</span><span class=p>())</span>
</span><span id=__span-53-19><span class=w>    </span><span class=p>{</span>
</span><span id=__span-53-20><span class=w>        </span><span class=c1>// 查找是否存在对应的BaseConnection对象</span>
</span><span id=__span-53-21><span class=w>        </span><span class=n>base_connection</span><span class=o>::</span><span class=n>BaseConnection</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=n>b_con</span><span class=p>;</span>
</span><span id=__span-53-22><span class=w>        </span><span class=p>{</span>
</span><span id=__span-53-23><span class=w>            </span><span class=k>auto</span><span class=w> </span><span class=n>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tcp_cons_</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>con</span><span class=p>);</span>
</span><span id=__span-53-24><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>pos</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>tcp_cons_</span><span class=p>.</span><span class=n>end</span><span class=p>())</span>
</span><span id=__span-53-25><span class=w>            </span><span class=p>{</span>
</span><span id=__span-53-26><span class=w>                </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;不存在指定的连接&quot;</span><span class=p>);</span>
</span><span id=__span-53-27><span class=w>                </span><span class=n>con</span><span class=o>-&gt;</span><span class=n>shutdown</span><span class=p>();</span>
</span><span id=__span-53-28><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=p>;</span>
</span><span id=__span-53-29><span class=w>            </span><span class=p>}</span>
</span><span id=__span-53-30><span class=w>            </span><span class=c1>// 找到了就获取</span>
</span><span id=__span-53-31><span class=w>            </span><span class=n>b_con</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pos</span><span class=o>-&gt;</span><span class=n>second</span><span class=p>;</span>
</span><span id=__span-53-32><span class=w>            </span><span class=c1>// 移除键值对</span>
</span><span id=__span-53-33><span class=w>            </span><span class=n>tcp_cons_</span><span class=p>.</span><span class=n>erase</span><span class=p>(</span><span class=n>con</span><span class=p>);</span>
</span><span id=__span-53-34><span class=w>        </span><span class=p>}</span>
</span><span id=__span-53-35>
</span><span id=__span-53-36><span class=w>        </span><span class=c1>// 如果设置了回调就调用</span>
</span><span id=__span-53-37><span class=w>        </span><span class=c1>// 关闭BaseConnection</span>
</span><span id=__span-53-38><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>cb_close_</span><span class=p>)</span>
</span><span id=__span-53-39><span class=w>            </span><span class=n>cb_close_</span><span class=p>(</span><span class=n>b_con</span><span class=p>);</span>
</span><span id=__span-53-40><span class=w>    </span><span class=p>}</span>
</span><span id=__span-53-41><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-54-1><span class=kt>void</span><span class=w> </span><span class=nf>messageCallback</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>TcpConnectionPtr</span><span class=w> </span><span class=o>&amp;</span><span class=n>con</span><span class=p>,</span><span class=w> </span><span class=n>muduo</span><span class=o>::</span><span class=n>net</span><span class=o>::</span><span class=n>Buffer</span><span class=w> </span><span class=o>*</span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=n>muduo</span><span class=o>::</span><span class=n>Timestamp</span><span class=w> </span><span class=n>t</span><span class=p>)</span>
</span><span id=__span-54-2><span class=p>{</span>
</span><span id=__span-54-3><span class=w>    </span><span class=c1>// 创建出BaseBuffer对象</span>
</span><span id=__span-54-4><span class=w>    </span><span class=n>base_buffer</span><span class=o>::</span><span class=n>BaseBuffer</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=n>b_buffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buffer_factory</span><span class=o>::</span><span class=n>BufferFactory</span><span class=o>::</span><span class=n>bufferCreateFactory</span><span class=p>(</span><span class=n>buffer</span><span class=p>);</span>
</span><span id=__span-54-5>
</span><span id=__span-54-6><span class=w>    </span><span class=c1>// 判断缓冲区中的数据是否可以处理（数据不会过小，也不会过大）</span>
</span><span id=__span-54-7><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span><span id=__span-54-8><span class=w>    </span><span class=p>{</span>
</span><span id=__span-54-9><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>pro_</span><span class=o>-&gt;</span><span class=n>canProcessed</span><span class=p>(</span><span class=n>b_buffer</span><span class=p>))</span>
</span><span id=__span-54-10><span class=w>        </span><span class=p>{</span>
</span><span id=__span-54-11><span class=w>            </span><span class=c1>// 无法处理时也有可能是数据过大</span>
</span><span id=__span-54-12><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>b_buffer</span><span class=o>-&gt;</span><span class=n>readableSize</span><span class=p>()</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>public_data</span><span class=o>::</span><span class=n>max_data_size</span><span class=p>)</span>
</span><span id=__span-54-13><span class=w>            </span><span class=p>{</span>
</span><span id=__span-54-14><span class=w>                </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;数据过大，无法处理&quot;</span><span class=p>);</span>
</span><span id=__span-54-15><span class=w>                </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-54-16><span class=w>            </span><span class=p>}</span>
</span><span id=__span-54-17>
</span><span id=__span-54-18><span class=w>            </span><span class=c1>// 否则就是数据过小（无法满足LV协议格式的处理规则）</span>
</span><span id=__span-54-19><span class=w>            </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-54-20><span class=w>        </span><span class=p>}</span>
</span><span id=__span-54-21>
</span><span id=__span-54-22><span class=w>        </span><span class=c1>// 创建BaseMessage对象指针，交给BaseProtocol中的反序列化接口创建对象</span>
</span><span id=__span-54-23><span class=w>        </span><span class=n>base_message</span><span class=o>::</span><span class=n>BaseMessage</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=n>b_msg</span><span class=p>;</span>
</span><span id=__span-54-24><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>pro_</span><span class=o>-&gt;</span><span class=n>getContentFromBuffer</span><span class=p>(</span><span class=n>b_buffer</span><span class=p>,</span><span class=w> </span><span class=n>b_msg</span><span class=p>))</span>
</span><span id=__span-54-25><span class=w>        </span><span class=p>{</span>
</span><span id=__span-54-26><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;反序列化处理失败&quot;</span><span class=p>);</span>
</span><span id=__span-54-27><span class=w>            </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-54-28><span class=w>        </span><span class=p>}</span>
</span><span id=__span-54-29>
</span><span id=__span-54-30><span class=w>        </span><span class=c1>// 如果设置了回调函数就处理</span>
</span><span id=__span-54-31><span class=w>        </span><span class=c1>// 处理收到的消息</span>
</span><span id=__span-54-32><span class=w>        </span><span class=n>base_connection</span><span class=o>::</span><span class=n>BaseConnection</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=n>b_con</span><span class=p>;</span>
</span><span id=__span-54-33><span class=w>        </span><span class=p>{</span>
</span><span id=__span-54-34><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock</span><span class=p>(</span><span class=n>manage_map_mtx_</span><span class=p>);</span>
</span><span id=__span-54-35><span class=w>            </span><span class=k>auto</span><span class=w> </span><span class=n>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tcp_cons_</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>con</span><span class=p>);</span>
</span><span id=__span-54-36><span class=w>            </span><span class=c1>// 不存在连接时直接断开，防止之后的处理也出现异常</span>
</span><span id=__span-54-37><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>pos</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>tcp_cons_</span><span class=p>.</span><span class=n>end</span><span class=p>())</span>
</span><span id=__span-54-38><span class=w>            </span><span class=p>{</span>
</span><span id=__span-54-39><span class=w>                </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;不存在指定的连接&quot;</span><span class=p>);</span>
</span><span id=__span-54-40><span class=w>                </span><span class=n>con</span><span class=o>-&gt;</span><span class=n>shutdown</span><span class=p>();</span>
</span><span id=__span-54-41><span class=w>                </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-54-42><span class=w>            </span><span class=p>}</span>
</span><span id=__span-54-43>
</span><span id=__span-54-44><span class=w>            </span><span class=n>b_con</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pos</span><span class=o>-&gt;</span><span class=n>second</span><span class=p>;</span>
</span><span id=__span-54-45><span class=w>        </span><span class=p>}</span>
</span><span id=__span-54-46>
</span><span id=__span-54-47><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>cb_message_</span><span class=p>)</span>
</span><span id=__span-54-48><span class=w>            </span><span class=n>cb_message_</span><span class=p>(</span><span class=n>b_con</span><span class=p>,</span><span class=w> </span><span class=n>b_msg</span><span class=p>);</span>
</span><span id=__span-54-49><span class=w>    </span><span class=p>}</span>
</span><span id=__span-54-50>
</span><span id=__span-54-51><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </div> </div> </div> <p>同样，为了便于创建服务端对象，提供对应的工厂：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-55-1><span class=k>class</span><span class=w> </span><span class=nc>ServerFactory</span>
</span><span id=__span-55-2><span class=p>{</span>
</span><span id=__span-55-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-55-4><span class=w>    </span><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>class</span><span class=p>...</span><span class=w> </span><span class=n>Args</span><span class=o>&gt;</span>
</span><span id=__span-55-5><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=n>base_server</span><span class=o>::</span><span class=n>BaseServer</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=n>serverCreateFactory</span><span class=p>(</span><span class=n>Args</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=p>...</span><span class=n>args</span><span class=p>)</span>
</span><span id=__span-55-6><span class=w>    </span><span class=p>{</span>
</span><span id=__span-55-7><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>muduo_server</span><span class=o>::</span><span class=n>MuduoServer</span><span class=o>&gt;</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>forward</span><span class=o>&lt;</span><span class=n>Args</span><span class=o>&gt;</span><span class=p>(</span><span class=n>args</span><span class=p>)...);</span>
</span><span id=__span-55-8><span class=w>    </span><span class=p>}</span>
</span><span id=__span-55-9><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <h2 id=_8>消息分发模块设计<a class=headerlink href=#_8 title="Permanent link">&para;</a></h2> <h3 id=_9>基础版本<a class=headerlink href=#_9 title="Permanent link">&para;</a></h3> <p>消息分发模块的基本思路很简单，只需要根据具体的类型调用对应的回调函数，所以在消息分发模块中需要提供注册回调的函数和执行回调的函数。在注册回调的函数中，需要让上层传递注册类型以及回调函数，而执行回调的函数是将来注册到客户端以及服务端中，用于消息到来时执行的函数，即前面设计客户端和服务端时提到的收到消息时的回调函数<code>messageCallback</code>，具体的逻辑就是从消息类中获取当前消息对应的类型，找到对应的回调函数进行执行即可</p> <p>从上面的思路来看，在消息分发模块中需要有一张消息类型和消息处理回调函数的映射表，而所谓的注册就是将消息类型和对应的消息处理回调映射关系，而所谓的执行回调，就是根据消息类型取出回调函数传递参数并执行。需要注意的是，在执行回调中如果没有找到指定消息类型对应的回调函数，那么说明这种消息类型存在问题，此时为了防止后续出现问题，依旧直接断开客户端的连接</p> <p>所以，整个类的基本设计如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-56-1><span class=k>class</span><span class=w> </span><span class=nc>Dispatcher</span>
</span><span id=__span-56-2><span class=p>{</span>
</span><span id=__span-56-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-56-4><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>Dispatcher</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-56-5>
</span><span id=__span-56-6><span class=w>    </span><span class=c1>// 注册服务</span>
</span><span id=__span-56-7><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>registerService</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>public_data</span><span class=o>::</span><span class=n>MType</span><span class=o>&amp;</span><span class=w> </span><span class=n>m</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>public_data</span><span class=o>::</span><span class=n>messageCallback_t</span><span class=o>&amp;</span><span class=w> </span><span class=n>cb</span><span class=p>)</span>
</span><span id=__span-56-8><span class=w>    </span><span class=p>{</span><span class=w>  </span>
</span><span id=__span-56-9><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock</span><span class=p>(</span><span class=n>mtx_</span><span class=p>);</span>
</span><span id=__span-56-10><span class=w>        </span><span class=k>auto</span><span class=w> </span><span class=n>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>type_calls</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>m</span><span class=p>);</span>
</span><span id=__span-56-11><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>pos</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>type_calls</span><span class=p>.</span><span class=n>end</span><span class=p>())</span>
</span><span id=__span-56-12><span class=w>        </span><span class=p>{</span>
</span><span id=__span-56-13><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;已经存在指定的消息类型，插入失败&quot;</span><span class=p>);</span>
</span><span id=__span-56-14><span class=w>            </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-56-15><span class=w>        </span><span class=p>}</span>
</span><span id=__span-56-16><span class=w>        </span><span class=n>type_calls</span><span class=p>.</span><span class=n>insert</span><span class=p>({</span><span class=n>m</span><span class=p>,</span><span class=w> </span><span class=n>cb</span><span class=p>});</span>
</span><span id=__span-56-17><span class=w>    </span><span class=p>}</span>
</span><span id=__span-56-18>
</span><span id=__span-56-19><span class=w>    </span><span class=c1>// 根据操作类型执行回调</span>
</span><span id=__span-56-20><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>executeService</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>base_connection</span><span class=o>::</span><span class=n>BaseConnection</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=o>&amp;</span><span class=n>con</span><span class=p>,</span><span class=w> </span><span class=n>base_message</span><span class=o>::</span><span class=n>BaseMessage</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>msg</span><span class=p>)</span>
</span><span id=__span-56-21><span class=w>    </span><span class=p>{</span>
</span><span id=__span-56-22><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock</span><span class=p>(</span><span class=n>mtx_</span><span class=p>);</span>
</span><span id=__span-56-23><span class=w>        </span><span class=k>auto</span><span class=w> </span><span class=n>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>type_calls</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>msg</span><span class=o>-&gt;</span><span class=n>getMtype</span><span class=p>());</span>
</span><span id=__span-56-24><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pos</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>type_calls</span><span class=p>.</span><span class=n>end</span><span class=p>())</span>
</span><span id=__span-56-25><span class=w>        </span><span class=p>{</span>
</span><span id=__span-56-26><span class=w>            </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;不存在指定的消息类型，分发失败&quot;</span><span class=p>);</span>
</span><span id=__span-56-27><span class=w>            </span><span class=n>con</span><span class=o>-&gt;</span><span class=n>shutdown</span><span class=p>();</span>
</span><span id=__span-56-28><span class=w>            </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-56-29><span class=w>        </span><span class=p>}</span>
</span><span id=__span-56-30>
</span><span id=__span-56-31><span class=w>        </span><span class=p>(</span><span class=n>pos</span><span class=o>-&gt;</span><span class=n>second</span><span class=p>)(</span><span class=n>con</span><span class=p>,</span><span class=w> </span><span class=n>msg</span><span class=p>);</span>
</span><span id=__span-56-32><span class=w>    </span><span class=p>}</span>
</span><span id=__span-56-33>
</span><span id=__span-56-34><span class=k>private</span><span class=o>:</span>
</span><span id=__span-56-35><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unordered_map</span><span class=o>&lt;</span><span class=n>public_data</span><span class=o>::</span><span class=n>MType</span><span class=p>,</span><span class=w> </span><span class=n>public_data</span><span class=o>::</span><span class=n>messageCallback_t</span><span class=o>&gt;</span><span class=w> </span><span class=n>type_calls</span><span class=p>;</span><span class=w> </span><span class=c1>// 消息类型和回调函数的映射</span>
</span><span id=__span-56-36><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=w> </span><span class=n>mtx_</span><span class=p>;</span><span class=w>                                                                   </span><span class=c1>// 管理哈希表的互斥锁</span>
</span><span id=__span-56-37><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <h3 id=message_2>优化版本（回调函数的第二个参数支持Message类派生类对象）<a class=headerlink href=#message_2 title="Permanent link">&para;</a></h3> <p>虽然上面的实现已经可以满足需要的功能，但是此时对于上层来说，可以设置的回调类型必须是<code>messageCallback_t</code>，而且必须是完全一样的类型，不允许出现父类指针接受子类对象指针的情况，这就对上层使用造成了一种使用上的困扰，如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-57-1><span class=kt>void</span><span class=w> </span><span class=nf>func</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>base_connection</span><span class=o>::</span><span class=n>BaseConnection</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=o>&amp;</span><span class=n>con</span><span class=p>,</span><span class=w> </span><span class=n>base_message</span><span class=o>::</span><span class=n>BaseMessage</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=o>&amp;</span><span class=n>msg</span><span class=p>)</span>
</span><span id=__span-57-2><span class=p>{</span>
</span><span id=__span-57-3><span class=w>    </span><span class=c1>// 可以直接调用BaseMessage中的函数</span>
</span><span id=__span-57-4><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>req_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>msg</span><span class=o>-&gt;</span><span class=n>getReqRespId</span><span class=p>();</span>
</span><span id=__span-57-5><span class=w>    </span><span class=c1>// 但是如果要调用其子类的函数，例如</span>
</span><span id=__span-57-6><span class=w>    </span><span class=c1>// std::string method = msg-&gt;getMethod();</span>
</span><span id=__span-57-7><span class=w>    </span><span class=c1>// 就会出现无法访问到getMethod</span>
</span><span id=__span-57-8><span class=w>    </span><span class=c1>// 对应的处理方式就是动态转换父类对象指针为子类对象指针</span>
</span><span id=__span-57-9><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>request_message</span><span class=o>::</span><span class=n>RpcRequest</span><span class=o>&gt;</span><span class=w> </span><span class=n>rpc_req</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>dynamic_pointer_cast</span><span class=o>&lt;</span><span class=n>request_message</span><span class=o>::</span><span class=n>RpcRequest</span><span class=o>&gt;</span><span class=p>(</span><span class=n>msg</span><span class=p>);</span>
</span><span id=__span-57-10><span class=w>    </span><span class=c1>// 此时才可以调用getMethod</span>
</span><span id=__span-57-11><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rpc_req</span><span class=o>-&gt;</span><span class=n>getMethod</span><span class=p>();</span>
</span><span id=__span-57-12><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>最直接解决这个问题的想法就是将<code>registerService</code>设置为模板函数，如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-58-1><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>class</span><span class=w> </span><span class=nc>T</span><span class=o>&gt;</span>
</span><span id=__span-58-2><span class=kt>void</span><span class=w> </span><span class=n>registerService</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>public_data</span><span class=o>::</span><span class=n>MType</span><span class=w> </span><span class=o>&amp;</span><span class=n>m</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=o>&amp;</span><span class=n>cb</span><span class=p>)</span>
</span><span id=__span-58-3><span class=p>{</span>
</span><span id=__span-58-4><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock</span><span class=p>(</span><span class=n>mtx_</span><span class=p>);</span>
</span><span id=__span-58-5><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>type_calls</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>m</span><span class=p>);</span>
</span><span id=__span-58-6><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pos</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>type_calls</span><span class=p>.</span><span class=n>end</span><span class=p>())</span>
</span><span id=__span-58-7><span class=w>    </span><span class=p>{</span>
</span><span id=__span-58-8><span class=w>        </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;已经存在指定的消息类型，插入失败&quot;</span><span class=p>);</span>
</span><span id=__span-58-9><span class=w>        </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-58-10><span class=w>    </span><span class=p>}</span>
</span><span id=__span-58-11>
</span><span id=__span-58-12><span class=w>    </span><span class=n>type_calls</span><span class=p>.</span><span class=n>insert</span><span class=p>({</span><span class=n>m</span><span class=p>,</span><span class=w> </span><span class=n>T</span><span class=p>});</span>
</span><span id=__span-58-13><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>但是这种写法会产生一个问题，那就是消息类型和回调映射的容器无法接收不同类型，既然无法接收不同的类型，那么就考虑创建出一个具体的类型，这个类型内部就保存任意类型的回调函数以及提供一个执行函数，函数内部对Message基类指针转换为子类指针再传递给任意类型的回调函数执行上层设计的逻辑（也就是回到可以满足基础功能的<code>Dispatcher</code>类中，上层调用<code>executeService</code>时根据消息类型获取到回调函数传递参数并执行的函数逻辑），但是为了这一点，该类依旧需要使用模板，这就造成了这个类是个模板类，对于容器来说依旧是不同类型：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-59-1><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>class</span><span class=w> </span><span class=nc>T</span><span class=o>&gt;</span>
</span><span id=__span-59-2><span class=k>class</span><span class=w> </span><span class=nc>Callback</span>
</span><span id=__span-59-3><span class=p>{</span>
</span><span id=__span-59-4><span class=k>public</span><span class=o>:</span>
</span><span id=__span-59-5><span class=w>    </span><span class=n>Callback</span><span class=p>(</span><span class=n>cconst</span><span class=w> </span><span class=n>T</span><span class=o>&amp;</span><span class=w> </span><span class=n>handler</span><span class=p>)</span>
</span><span id=__span-59-6><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=n>handler_</span><span class=p>(</span><span class=n>handler</span><span class=p>)</span>
</span><span id=__span-59-7><span class=w>    </span><span class=p>{</span>
</span><span id=__span-59-8><span class=w>    </span><span class=p>}</span>
</span><span id=__span-59-9><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>excuteService</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>BaseConnection</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=o>&amp;</span><span class=n>conn</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>base_message</span><span class=o>::</span><span class=n>BaseMessage</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=o>&amp;</span><span class=n>msg</span><span class=p>)</span>
</span><span id=__span-59-10><span class=w>    </span><span class=p>{</span>
</span><span id=__span-59-11><span class=w>        </span><span class=k>auto</span><span class=w> </span><span class=n>type_msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>dynamic_pointer_cast</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>(</span><span class=n>msg</span><span class=p>);</span>
</span><span id=__span-59-12><span class=w>        </span><span class=n>handler_</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span><span class=w> </span><span class=n>type_msg</span><span class=p>);</span>
</span><span id=__span-59-13><span class=w>    </span><span class=p>}</span>
</span><span id=__span-59-14><span class=k>private</span><span class=o>:</span>
</span><span id=__span-59-15><span class=w>    </span><span class=n>T</span><span class=w> </span><span class=n>handler_</span><span class=p>;</span>
</span><span id=__span-59-16><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>即在<code>registerService</code>变为如下方式：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-60-1><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>class</span><span class=w> </span><span class=nc>T</span><span class=o>&gt;</span>
</span><span id=__span-60-2><span class=kt>void</span><span class=w> </span><span class=n>registerService</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>public_data</span><span class=o>::</span><span class=n>MType</span><span class=w> </span><span class=o>&amp;</span><span class=n>m</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=o>&amp;</span><span class=n>cb</span><span class=p>)</span>
</span><span id=__span-60-3><span class=p>{</span>
</span><span id=__span-60-4><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span><span class=w> </span><span class=n>lock</span><span class=p>(</span><span class=n>mtx_</span><span class=p>);</span>
</span><span id=__span-60-5><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>type_calls</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>m</span><span class=p>);</span>
</span><span id=__span-60-6><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pos</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>type_calls</span><span class=p>.</span><span class=n>end</span><span class=p>())</span>
</span><span id=__span-60-7><span class=w>    </span><span class=p>{</span>
</span><span id=__span-60-8><span class=w>        </span><span class=n>LOG</span><span class=p>(</span><span class=n>Level</span><span class=o>::</span><span class=n>Warning</span><span class=p>,</span><span class=w> </span><span class=s>&quot;已经存在指定的消息类型，插入失败&quot;</span><span class=p>);</span>
</span><span id=__span-60-9><span class=w>        </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-60-10><span class=w>    </span><span class=p>}</span>
</span><span id=__span-60-11>
</span><span id=__span-60-12><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>Callback</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>type_msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>Callback</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span><span class=p>(</span><span class=n>cb</span><span class=p>);</span>
</span><span id=__span-60-13>
</span><span id=__span-60-14><span class=w>    </span><span class=n>type_calls</span><span class=p>.</span><span class=n>insert</span><span class=p>({</span><span class=n>m</span><span class=p>,</span><span class=w> </span><span class=n>type_msg</span><span class=p>});</span>
</span><span id=__span-60-15><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>但是此时对应的容器就需要修改为：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-61-1><span class=n>std</span><span class=o>::</span><span class=n>unordered_map</span><span class=o>&lt;</span><span class=n>public_data</span><span class=o>::</span><span class=n>MType</span><span class=p>,</span><span class=w> </span><span class=n>Callback</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>type_calls</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> <p>修改后会发现依旧不被允许。但是此时解决方式会变得比较容易，因为既然是不同类类型，那可以考虑使用<strong>多态</strong>，让容器存储父类即可，在这个父类中不保存任何内容，只需要有对应的执行回调的纯虚函数即可：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-62-1><span class=k>class</span><span class=w> </span><span class=nc>BaseCallback</span>
</span><span id=__span-62-2><span class=p>{</span>
</span><span id=__span-62-3><span class=k>public</span><span class=o>:</span>
</span><span id=__span-62-4><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>BaseCallback</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-62-5><span class=w>    </span><span class=k>virtual</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>excuteService</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>base_connection</span><span class=o>::</span><span class=n>BaseConnection</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=o>&amp;</span><span class=n>conn</span><span class=p>,</span><span class=w> </span><span class=n>base_message</span><span class=o>::</span><span class=n>BaseMessage</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=o>&amp;</span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-62-6><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>再让<code>Callback</code>类继承<code>BaseCallback</code>即可，内部逻辑不变：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-63-1><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>class</span><span class=w> </span><span class=nc>T</span><span class=o>&gt;</span>
</span><span id=__span-63-2><span class=k>class</span><span class=w> </span><span class=nc>Callback</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>BaseCallback</span>
</span><span id=__span-63-3><span class=p>{</span>
</span><span id=__span-63-4><span class=k>public</span><span class=o>:</span>
</span><span id=__span-63-5><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-63-6>
</span><span id=__span-63-7><span class=k>private</span><span class=o>:</span>
</span><span id=__span-63-8><span class=w>    </span><span class=n>T</span><span class=w> </span><span class=n>handler_</span><span class=p>;</span>
</span><span id=__span-63-9><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>对应的<code>registerService</code>就修改为：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-64-1><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>class</span><span class=w> </span><span class=nc>T</span><span class=o>&gt;</span>
</span><span id=__span-64-2><span class=kt>void</span><span class=w> </span><span class=n>registerService</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>public_data</span><span class=o>::</span><span class=n>MType</span><span class=w> </span><span class=o>&amp;</span><span class=n>m</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=o>&amp;</span><span class=n>cb</span><span class=p>)</span>
</span><span id=__span-64-3><span class=p>{</span>
</span><span id=__span-64-4><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-64-5>
</span><span id=__span-64-6><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>BaseCallback</span><span class=o>&gt;</span><span class=w> </span><span class=n>type_msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>Callback</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span><span class=p>(</span><span class=n>cb</span><span class=p>);</span>
</span><span id=__span-64-7>
</span><span id=__span-64-8><span class=w>    </span><span class=n>type_calls</span><span class=p>.</span><span class=n>insert</span><span class=p>({</span><span class=n>m</span><span class=p>,</span><span class=w> </span><span class=n>type_msg</span><span class=p>});</span>
</span><span id=__span-64-9><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>但是现在还存在一个问题，这个模板类型<code>T</code>代表的是回调函数类型，而不是具体的类类型，上层在使用这个函数还需要创建一个回调函数类型，这个过程依旧比较繁琐，甚至不亚于最开始的转换过程，那么此时就需要修改<code>Callback</code>类中关于<code>T</code>的定义，当前<code>T</code>表示任意回调函数类型，而实际上本次修改的目的是为了让上层可以直接使用具体Message派生类类型作为回调函数第二个参数的类型，所以只需要写死回调函数的类型，让<code>T</code>表示第二个参数中智能指针的类型即可，即提供一个回调函数类型<code>callback_t</code>，并修改回调函数成员的类型为<code>callback_t</code>：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-65-1><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>class</span><span class=w> </span><span class=nc>T</span><span class=o>&gt;</span>
</span><span id=__span-65-2><span class=k>class</span><span class=w> </span><span class=nc>Callback</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>BaseCallback</span>
</span><span id=__span-65-3><span class=p>{</span>
</span><span id=__span-65-4><span class=k>public</span><span class=o>:</span>
</span><span id=__span-65-5><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>Callback</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-65-6><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>callback_t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>function</span><span class=o>&lt;</span><span class=kt>void</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>base_connection</span><span class=o>::</span><span class=n>BaseConnection</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=o>&amp;</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=o>&amp;</span><span class=p>)</span><span class=o>&gt;</span><span class=p>;</span>
</span><span id=__span-65-7><span class=w>    </span><span class=n>Callback</span><span class=p>(</span><span class=n>callback_t</span><span class=w> </span><span class=n>handler</span><span class=p>)</span>
</span><span id=__span-65-8><span class=w>        </span><span class=o>:</span><span class=w> </span><span class=n>handler_</span><span class=p>(</span><span class=n>handler</span><span class=p>)</span>
</span><span id=__span-65-9><span class=w>    </span><span class=p>{</span>
</span><span id=__span-65-10><span class=w>    </span><span class=p>}</span>
</span><span id=__span-65-11><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-65-12>
</span><span id=__span-65-13><span class=k>private</span><span class=o>:</span>
</span><span id=__span-65-14><span class=w>    </span><span class=n>callback_t</span><span class=w> </span><span class=n>handler_</span><span class=p>;</span>
</span><span id=__span-65-15><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>此时因为<code>T</code>不再表示回调函数类型，对于<code>registerService</code>中<code>T</code>的定义也需要修改，此时修改<code>registerService</code>函数的第二个参数为：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-66-1><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>class</span><span class=w> </span><span class=nc>T</span><span class=o>&gt;</span>
</span><span id=__span-66-2><span class=kt>void</span><span class=w> </span><span class=n>registerService</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>public_data</span><span class=o>::</span><span class=n>MType</span><span class=w> </span><span class=o>&amp;</span><span class=n>m</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>Callback</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;::</span><span class=n>callback_t</span><span class=w> </span><span class=o>&amp;</span><span class=n>cb</span><span class=p>)</span>
</span></code></pre></div></td></tr></table></div> <p>这样，<code>T</code>就表示为类类型，而不再是回调函数类型。但是，此时会出现一个报错：</p> <div class="language-text highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-67-1>use the &#39;typename&#39; keyword to treat nontype &quot;dispatcher_rpc_framework::Callback&lt;T&gt;::callback_t [with T=T]&quot; as a type in a dependent context
</span></code></pre></div></td></tr></table></div> <p>这个报错表示编译器无法确定<code>callback_t</code>是一个类型，为了解决这个问题，需要使用到<code>typename</code>关键字修饰，如下：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-68-1><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>class</span><span class=w> </span><span class=nc>T</span><span class=o>&gt;</span>
</span><span id=__span-68-2><span class=kt>void</span><span class=w> </span><span class=n>registerService</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>public_data</span><span class=o>::</span><span class=n>MType</span><span class=w> </span><span class=o>&amp;</span><span class=n>m</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=k>typename</span><span class=w> </span><span class=nc>Callback</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;::</span><span class=n>callback_t</span><span class=w> </span><span class=o>&amp;</span><span class=n>cb</span><span class=p>)</span>
</span></code></pre></div></td></tr></table></div> <p>此时就可以实现上面的功能，使用方式变为：</p> <div class="language-cpp highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>C++</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-69-1><span class=kt>void</span><span class=w> </span><span class=nf>func</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>base_connection</span><span class=o>::</span><span class=n>BaseConnection</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=o>&amp;</span><span class=n>con</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>request_message</span><span class=o>::</span><span class=n>RpcRequest</span><span class=o>::</span><span class=n>ptr</span><span class=w> </span><span class=o>&amp;</span><span class=n>msg</span><span class=p>)</span>
</span><span id=__span-69-2><span class=p>{</span>
</span><span id=__span-69-3><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>msg</span><span class=o>-&gt;</span><span class=n>getMethod</span><span class=p>();</span>
</span><span id=__span-69-4><span class=p>}</span>
</span><span id=__span-69-5>
</span><span id=__span-69-6><span class=n>dispatcher_</span><span class=o>-&gt;</span><span class=n>registerService</span><span class=o>&lt;</span><span class=n>request_message</span><span class=o>::</span><span class=n>RpcRequest</span><span class=o>&gt;</span><span class=p>(</span><span class=n>public_data</span><span class=o>::</span><span class=n>MType</span><span class=o>::</span><span class=n>Req_rpc</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>bind</span><span class=p>(</span><span class=o>&amp;</span><span class=n>func</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>placeholders</span><span class=o>::</span><span class=n>_1</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>placeholders</span><span class=o>::</span><span class=n>_2</span><span class=p>));</span>
</span></code></pre></div></td></tr></table></div> <p>至此，消息分发模块设计完毕</p> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title=最后更新> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2025年5月27日</span> </span> <span class=md-source-file__fact> <span class=md-icon title=创建日期> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2025年5月24日</span> </span> </aside> <form class=md-feedback name=feedback hidden> <fieldset> <legend class=md-feedback__title> 页面有帮助吗？ </legend> <div class=md-feedback__inner> <div class=md-feedback__list> <button class="md-feedback__icon md-icon" type=submit title=页面对我有帮助 data-md-value=1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 9v12H1V9zm4 12a2 2 0 0 1-2-2V9c0-.55.22-1.05.59-1.41L14.17 1l1.06 1.06c.27.27.44.64.44 1.05l-.03.32L14.69 8H21a2 2 0 0 1 2 2v2c0 .26-.05.5-.14.73l-3.02 7.05C19.54 20.5 18.83 21 18 21zm0-2h9.03L21 12v-2h-8.79l1.13-5.32L9 9.03z"/></svg> </button> <button class="md-feedback__icon md-icon" type=submit title=页面没有帮助到我 data-md-value=0> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 15V3h4v12zM15 3a2 2 0 0 1 2 2v10c0 .55-.22 1.05-.59 1.41L9.83 23l-1.06-1.06c-.27-.27-.44-.64-.44-1.06l.03-.31.95-4.57H3a2 2 0 0 1-2-2v-2c0-.26.05-.5.14-.73l3.02-7.05C4.46 3.5 5.17 3 6 3zm0 2H5.97L3 12v2h8.78l-1.13 5.32L15 14.97z"/></svg> </button> </div> <div class=md-feedback__note> <div data-md-value=1 hidden> 谢谢你的反馈！ </div> <div data-md-value=0 hidden> 谢谢你的反馈！联系<a href=https://www.help-doc.top/%E4%BD%9C%E8%80%85/%E4%BD%9C%E8%80%85.html>作者</a>提供更详细的信息 </div> </div> </div> </fieldset> </form> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> 回到页面顶部 </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2024-2025 柯懒不是柯南 </div> </div> <div class=md-social> <a href=https://github.com/H0308 target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://www.help-doc.top/%E4%BD%9C%E8%80%85/%E4%BD%9C%E8%80%85.html target=_blank rel=noopener title=www.help-doc.top class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M433.754 420.445c-11.526 1.393-44.86-52.741-44.86-52.741 0 31.345-16.136 72.247-51.051 101.786 16.842 5.192 54.843 19.167 45.803 34.421-7.316 12.343-125.51 7.881-159.632 4.037-34.122 3.844-152.316 8.306-159.632-4.037-9.045-15.25 28.918-29.214 45.783-34.415-34.92-29.539-51.059-70.445-51.059-101.792 0 0-33.334 54.134-44.859 52.741-5.37-.65-12.424-29.644 9.347-99.704 10.261-33.024 21.995-60.478 40.144-105.779C60.683 98.063 108.982.006 224 0c113.737.006 163.156 96.133 160.264 214.963 18.118 45.223 29.912 72.85 40.144 105.778 21.768 70.06 14.716 99.053 9.346 99.704"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["navigation.indexes", "navigation.prune", "navigation.tabs", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script> <script src=../../../assets/javascripts/bundle.c8b220af.min.js></script> <script src=../../../javascripts/katex.min.js></script> <script src=../../../javascripts/other.min.js></script> <script src=../../../javascripts/copyright.min.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/contrib/auto-render.min.js></script> <script src=../../../assets/javascripts/toggle-sidebar.js async></script> <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body> </html>